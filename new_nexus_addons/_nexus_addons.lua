-- 0.0.2 アシスターオートセット修正、クイックスロットオペレート修正、フレームをalwaysVisible="true"に
-- リバイバルタイマーバグ修正、always_statusバグ修正、separate_buff_custom追加
-- 0.0.3 vakarine_equipのボタンクリックで設定開かなかったの修正、always_statusがどっかに行ってたの修正、old_funcの処理間違ってたの修正
-- 0.0.4 skill_gem_tooltip作り直して移植、save_quest移植、off時のバグ修正、
-- sub_mapミニマップモードを作成、status_point_checkとsilent_velnice_ranking移植
-- 0.0.5 always_statusバグ修正、another_warehouse追加、色々バグ修正
-- 0.0.6 GAMEEXIT_TIMER_ENDを取るのやめた、load_settingsの時に、新しいデフォルトを設定。
-- info.GetBuff(my_handle, 70002)これでトークン有る無し判断する様にこっちの方が早い
-- 0.0.7 instantCCがOFFの場合に、バラックに戻れなかったの修正、オリジナルアドオンの関数名と干渉する問題を頭文字大文字で解消
-- 全部のアドオンを再チェック。バグ修正、初回起動時重すぎたの修正
-- 0.0.8 cchとawhとsslotとipとmutekiとilvとocsl移植、起動最適化。まだ重いけど。。。ラストテストバージョン
-- 1.0.0 公開予定
-- 1.0.1 ANOTHER_WAREHOUSEアドオンと喧嘩してたの修正、other_character_skill_listのロードのタイミング修正、旧CC_HELPERとの競合修正
-- 1.0.2 AlwaysStatus修正。セーブファイルのバージョン管理。quickslot_operate修正、持ってない場合アイコン赤表示に変更
-- 1.0.3 MKC、PITフレームちらつき修正、AW自動設定修正、SSSドロップ挙動修正。
-- 1.0.3.1 エラー時にlogを吐く様に設定。
-- 1.0.3.2 インベントリのボタンが消える怪現象を明示的に修正。なんでや？
-- 1.0.4 NCのゴミ箱バグ修正、SQ SSSのクエスト表示バグ修正、IP ILV OCSL ESCキーで消える様に。IP掃討ボタンバグ修正。
-- 1.0.4.1 読み込み時の負荷を分散、ocslがクソ重たかったの修正
-- 1.0.5 チーム倉庫のバニラ挙動修正、AWHのjsonをluaに変更
-- 1.0.6 ILVのloadにバージョン管理追加。AWH使ってない場合のインベントリの挙動修正。IP激動の核の掃討部分修正
-- 1.0.7 IPの表示読込優先。CCH自動着脱を見直し。ILV最初回のロード処理変更。SSSスキルフレーム表示時の挙動変更。競合アドオン有効時の排他処理を厳格化。
-- 1.0.8 CCH自動着脱更に見直し、フレーム作成修正、AWHのセッティング時の挙動見直し、VEのバグ修正。ICC掃討バフ12時間以下で表示。ARフレーム非表示に変更。IPフレーム挙動修正、NCのフレームボタン修正。
-- 1.0.9 Mutekiゲージ位置修正、ESCの挙動修正。IPベリオラアイコン修正。AR再修正。CCHロード修正。ILV掃討バフ12時間以下で表示。
-- 1.1.0 Battle_ritualフレームスクロール。AWH fixinventorysort使える様に。DRPC200未満ですぐ補充に。
-- 1.1.1 CCH装備外すロジック見直し。GIM追加。ILV掃討の残り時間のロジック修正。NCゴッデスアクセバグ修正。AWH CC後最速読込。
-- 1.1.2 不安定なバラックへ移動の挙動を見直し。CCH装備装着時のロジック見直し、倉庫入庫のロジック修正。BRバグ修正。SM修正。
-- 1.1.3 AWH1個取り出す挙動修正、同一clsidの処理見直し。PIT初期化処理見直し。CRプレミアム補助材バグ修正。EBバフ部分修正。TOS追加。AOH追加
-- 1.1.4 AS表示名をカスタマイズ可能に
-- 1.1.5 CCHロード処理見直し、AS位置固定修正、TOSモンスター検索修正、CCHレベル判定修正、IP掃討ボタンの挙動修正、NCアイテム連続使用ロジック修正
-- 1.1.6 AS%表示追加、IPフィールド表示修正、TOS表示位置修正、SGT無効処理追加
-- 1.1.7 "Added Zmei"
-- 1.1.8 “ILV convenience improvements”
-- 1.1.9 "Automatically replace the slotted potion with a Wild Potion when matching in Zmei Dungeon"
-- 1.1.10 "short cut"
------------------------------------------
----- new nexus addons -----
-- 1.0.0 "new nexus addon + added Zmei hard"


local addon_name = "_NEXUS_ADDONS"
local addon_name_lower = string.lower(addon_name)
local author = "yomae"
local ver = "1.0.0"

_G["ADDONS"] = _G["ADDONS"] or {}
_G["ADDONS"][author] = _G["ADDONS"][author] or {}
_G["ADDONS"][author][addon_name] = _G["ADDONS"][author][addon_name] or {}
local g = _G["ADDONS"][author][addon_name]
local json = require("json")

local function ts(...)
    local num_args = select('#', ...)
    if num_args == 0 then
        print("ts() -- 引数がありません")
        return
    end
    local string_parts = {}
    for i = 1, num_args do
        local arg = select(i, ...)
        local arg_type = type(arg)
        local is_success, value_str = pcall(tostring, arg)
        if not is_success then
            value_str = "[tostringでエラー発生]"
        end
        table.insert(string_parts, string.format("(%s) %s", arg_type, value_str))
    end
    print(table.concat(string_parts, "   |   "))
end

local function print_all_child(ctrl, prefix)
    prefix = prefix or ""
    local count = ctrl:GetChildCount()
    for i = 0, count - 1 do
        local child = ctrl:GetChildByIndex(i)
        local name = child:GetName()
        local class_name = child:GetClassName()
        local w = child:GetWidth()
        local h = child:GetHeight()
        print(string.format("%sName: %s | Class: %s | Size: %dx%d", prefix, name, class_name, w, h))
        if child:GetChildCount() > 0 then
            print_all_child(child, prefix .. "  ")
        end
    end
end

function g.mkdir_new_folder()
    local function create_folder(folder_path, file_path)
        local file = io.open(file_path, "r")
        if not file then
            os.execute('mkdir "' .. folder_path .. '"')
            file = io.open(file_path, "w")
            if file then
                file:write("A new file has been created")
                file:close()
            end
        else
            file:close()
        end
    end
    local folder = string.format("../addons/%s", addon_name_lower)
    local file_path = string.format("../addons/%s/mkdir.txt", addon_name_lower)
    create_folder(folder, file_path)
    local user_folder = string.format("../addons/%s/%s", addon_name_lower, g.active_id)
    local user_file_path = string.format("../addons/%s/%s/mkdir.txt", addon_name_lower, g.active_id)
    create_folder(user_folder, user_file_path)
end

function g.setup_hook_and_event(my_addon, origin_func_name, my_func_name, bool)
    g.FUNCS = g.FUNCS or {}
    if not g.FUNCS[origin_func_name] then
        g.FUNCS[origin_func_name] = _G[origin_func_name]
    end
    local origin_func = g.FUNCS[origin_func_name]
    local function hooked_function(...)
        local original_results
        if bool == true then
            original_results = {origin_func(...)}
        end
        g.ARGS = g.ARGS or {}
        g.ARGS[origin_func_name] = {...}
        imcAddOn.BroadMsg(origin_func_name)
        if original_results then
            return table.unpack(original_results)
        else
            return
        end
    end
    _G[origin_func_name] = hooked_function
    if not g.REGISTER[origin_func_name .. my_func_name] then -- g.REGISTERはON_INIT内で都度初期化
        g.REGISTER[origin_func_name .. my_func_name] = true
        my_addon:RegisterMsg(origin_func_name, my_func_name)
    end
end

function g.get_event_args(origin_func_name)
    local args = g.ARGS[origin_func_name]
    if args then
        return table.unpack(args)
    end
    return nil
end

function g.setup_hook(my_func, origin_func_name)
    local addon_upper = string.upper(addon_name)
    local replace_name = addon_upper .. "_REPLACE_" .. origin_func_name
    g.FUNCS = g.FUNCS or {}
    if not _G[replace_name] then
        _G[replace_name] = _G[origin_func_name]
    end
    _G[origin_func_name] = my_func
    g.FUNCS[origin_func_name] = _G[replace_name]
end

function g.save_lua(path, tbl)
    local function serialize(o)
        if type(o) == "number" then
            return tostring(o)
        elseif type(o) == "string" then
            return string.format("%q", o)
        elseif type(o) == "boolean" then
            return tostring(o)
        elseif type(o) == "table" then
            local parts = {"{\n"}
            for k, v in pairs(o) do
                parts[#parts + 1] = "[" .. serialize(k) .. "]=" .. serialize(v) .. ",\n"
            end
            parts[#parts + 1] = "}"
            return table.concat(parts)
        else
            return "nil"
        end
    end
    local ok_s, content = pcall(function() return "return " .. serialize(tbl) end)
    if not ok_s or not content then
        if ts then ts("Save Lua Serialize Error:", tostring(content)) end
        return
    end
    local tmp_path = path .. ".tmp"
    local file, err = io.open(tmp_path, "w")
    if file then
        local ok_w, w_err = file:write(content)
        file:close()
        if ok_w then
            os.remove(path)
            os.rename(tmp_path, path)
        else
            if ts then ts("Save Lua Write Error:", tostring(w_err)) end
        end
    else
        if ts then ts("Save Lua Error:", err) end
    end
end

function g.load_lua(path)
    local chunk, err = loadfile(path)
    if chunk then
        local status, result = pcall(chunk)
        if status then
            return result
        end
    end
    local tmp_path = path .. ".tmp"
    local tmp_chunk = loadfile(tmp_path)
    if tmp_chunk then
        local status, result = pcall(tmp_chunk)
        if status then
            os.remove(path)
            os.rename(tmp_path, path)
            return result
        end
    end
    return nil
end

function g.load_json(path)
    local file = io.open(path, "r")
    if not file then
        local tmp_file = io.open(path .. ".tmp", "r")
        if tmp_file then
            local tmp_content = tmp_file:read("*all")
            tmp_file:close()
            if tmp_content and tmp_content ~= "" then
                os.remove(path)
                os.rename(path .. ".tmp", path)
                local s, r = pcall(json.decode, tmp_content)
                if s then return r, nil end
            end
        end
        return nil, "Error opening file: " .. path
    end
    local content = file:read("*all")
    file:close()
    if not content or content == "" then
        local tmp_file = io.open(path .. ".tmp", "r")
        if tmp_file then
            local tmp_content = tmp_file:read("*all")
            tmp_file:close()
            if tmp_content and tmp_content ~= "" then
                os.remove(path)
                os.rename(path .. ".tmp", path)
                local s, r = pcall(json.decode, tmp_content)
                if s then return r, nil end
            end
        end
        return nil, "File content is empty or could not be read: " .. path
    end
    if string.sub(content, 1, 3) == "\239\187\191" then
        content = string.sub(content, 4)
    end
    local success, result = pcall(json.decode, content)
    if success then
        return result, nil
    else
        return nil, result
    end
end

function g.save_json(path, tbl)
    local success, str = pcall(json.encode, tbl)
    if not success then
        print(string.format("[g.save_json] JSON Encode Error in '%s': %s", tostring(path), tostring(str)))
        return false
    end
    local tmp_path = path .. ".tmp"
    local file, err = io.open(tmp_path, "w")
    if not file then
        print(string.format("[g.save_json] Error opening file for write: %s (Error: %s)", tostring(tmp_path), tostring(err)))
        return false
    end
    local ok_w, w_err = file:write(str)
    file:close()
    if ok_w then
        os.remove(path)
        os.rename(tmp_path, path)
        return true
    else
        print(string.format("[g.save_json] Write Error in '%s': %s", tostring(path), tostring(w_err)))
        return false
    end
end

function g.get_map_type()
    local map_name = session.GetMapName()
    local map_cls = GetClass("Map", map_name)
    local map_type = map_cls.MapType
    return map_type
end

function g.debug_print_table(tbl, indent)
    indent = indent or ""
    for key, value in pairs(tbl) do
        local key_str = indent .. "[" .. tostring(key) .. "] ="
        if type(value) == "table" then
            print(key_str .. "{")
            g.debug_print_table(value, indent .. "  ")
            print(indent .. "}")
        else
            print(key_str .. tostring(value))
        end
    end
end

function g.log_to_file(message)
    local log_file_path = string.format('../addons/%s/debug_log.txt', addon_name_lower)
    local file, err = io.open(log_file_path, "a")
    if file then
        local timestamp = os.date("[%Y-%m-%d %H:%M:%S] ")
        file:write(timestamp .. tostring(message) .. "\n")
        file:close()
    end
end

g._nexus_addons = {{
    key = "aethergem_manager",
    data = {
        use = 0,
        name = "Aethergem Manager",
        frame_use = false,
        config_func = "",
        old_init_func = "AETHERGEM_MGR_ON_INIT"
    }
}, {
    key = "acquire_relic_reward",
    data = {
        use = 0,
        name = "Acquire Relic Reward",
        frame_use = false,
        config_func = "",
        old_init_func = "ACQUIRERELICREWARD_ON_INIT"
    }
}, {
    key = "ancient_auto_set",
    data = {
        use = 0,
        name = "Ancient Auto Set",
        frame_use = false,
        config_func = "",
        old_init_func = "ANCIENT_AUTOSET_ON_INIT"
    }
}, --[[{
    key = "ancient_monster_bookshelf",
    data = {
        use = 0,
        name = "Ancient Monster Bookshelf",
        frame_use = false,
        config_func = "",
        old_init_func = "ANCIENTMONSTERBOOKSHELF_ON_INIT"
    }
},]] {
    key = "another_warehouse",
    data = {
        use = 0,
        name = "Another Warehouse",
        frame_use = true,
        config_func = "Another_warehouse_setting_frame_init",
        old_init_func = "ANOTHER_WAREHOUSE_ON_INIT"
    }
}, {
    key = "always_status",
    data = {
        use = 0,
        name = "Always Status",
        frame_use = true,
        config_func = "Always_status_info_setting",
        old_init_func = "ALWAYS_STATUS_ON_INIT"
    }
}, {
    key = "archeology_helper",
    data = {
        use = 0,
        name = "Archeology Helper",
        frame_use = true,
        config_func = "Archeology_helper_setting_frame",
        old_init_func = "ARCHEOLOGY_HELPER_ON_INIT"
    }
}, {
    key = "auto_map_change", --
    data = {
        use = 0,
        name = "Auto Map Change",
        frame_use = false,
        config_func = "",
        old_init_func = "AUTOMAPCHANGE_ON_INIT"
    }
}, {
    key = "auto_pet_summon",
    data = {
        use = 0,
        name = "Auto Pet Summon",
        frame_use = false,
        config_func = "",
        old_init_func = "AUTO_PET_SUMMON_ON_INIT"
    }
}, {
    key = "auto_repair",
    data = {
        use = 0,
        name = "Auto Repair",
        frame_use = true,
        config_func = "Auto_repair_settings_frame_init",
        old_init_func = "AUTO_REPAIR_ON_INIT"
    }
}, {
    key = "battle_ritual",
    data = {
        use = 0,
        name = "Battle Ritual",
        frame_use = true,
        config_func = "Battle_ritual_settings_frame",
        old_init_func = ""
    }
}, {
    key = "boss_direction",
    data = {
        use = 0,
        name = "Boss Direction",
        frame_use = true,
        config_func = "Boss_direction_settings_frame_init",
        old_init_func = "BOSS_DIRECTION_ON_INIT"
    }
}, {
    key = "boss_gauge",
    data = {
        use = 0,
        name = "Boss Gauge",
        frame_use = false,
        config_func = "",
        old_init_func = "BOSS_GAUGE_ON_INIT"
    }
}, {
    key = "bulk_sales",
    data = {
        use = 0,
        name = "Bulk Sales",
        frame_use = false,
        config_func = "",
        old_init_func = "BULK_SALES_ON_INIT"
    }
}, {
    key = "cc_helper",
    data = {
        use = 0,
        name = "Character Change Helper",
        frame_use = false,
        config_func = "",
        old_init_func = "CC_HELPER_ON_INIT" -- CC_HELPER_ON_INIT
    }
}, {
    key = "characters_item_serch",
    data = {
        use = 0,
        name = "Characters Item Serch",
        frame_use = true,
        config_func = "Characters_item_serch_toggle_frame",
        old_init_func = "CHARACTERS_ITEM_SERCH_ON_INIT"
    }
}, {
    key = "continue_reinforce",
    data = {
        use = 0,
        name = "Continue Reinforce",
        frame_use = false,
        config_func = "",
        old_init_func = "CONTINUERF_ON_INIT"
    }
}, {
    key = "debuff_notice",
    data = {
        use = 0,
        name = "Debuff Notice",
        frame_use = false,
        config_func = "",
        old_init_func = "DEBUFF_NOTICE_ON_INIT"
    }
}, {
    key = "dungeon_rp_charger",
    data = {
        use = 0,
        name = "Dungeon RP Charger",
        frame_use = false,
        config_func = "",
        old_init_func = "DUNGEONRPCHARGER_ON_INIT"
    }
}, {
    key = "easy_buff",
    data = {
        use = 0,
        name = "Easy Buff",
        frame_use = true,
        config_func = "Easy_buff_config_frame",
        old_init_func = "EASYBUFF_ON_INIT"
    }
}, {
    key = "goddess_icor_manager",
    data = {
        use = 0,
        name = "Goddess Icor Manager",
        frame_use = false,
        config_func = "",
        old_init_func = "GODDESS_ICOR_MANAGER_ON_INIT"
    }
}, {
    key = "guild_event_warp",
    data = {
        use = 0,
        name = "Guild Event Warp",
        frame_use = false,
        config_func = "",
        old_init_func = "GUILDEVENTWARP_ON_INIT"
    }
}, {
    key = "indun_list_viewer",
    data = {
        use = 0,
        name = "Indun List Viewer",
        frame_use = true,
        config_func = "Indun_list_viewer_title_frame_open",
        old_init_func = "INDUN_LIST_VIEWER_ON_INIT"
    } --
}, {
    key = "indun_panel",
    data = {
        use = 0,
        name = "Indun Panel",
        frame_use = false,
        config_func = "",
        old_init_func = "INDUN_PANEL_ON_INIT"
    }
}, {
    key = "instant_cc",
    data = {
        use = 0,
        name = "Instant CC",
        frame_use = true,
        config_func = "Instant_cc_settings_frame_init",
        old_init_func = "INSTANTCC_ON_INIT"
    }
}, {
    key = "job_change_helper",
    data = {
        use = 0,
        name = "Job Change Helper",
        frame_use = false,
        config_func = "",
        old_init_func = "JOB_CHANGE_HELPER_ON_INIT"
    }
}, {
    key = "lets_go_home",
    data = {
        use = 0,
        name = "Lets Go Home",
        frame_use = true,
        config_func = "Lets_go_home_settings_frame",
        old_init_func = "LETS_GO_HOME_ON_INIT"
    }
}, {
    key = "market_voucher",
    data = {
        use = 0,
        name = "Market Voucher",
        frame_use = false,
        config_func = "",
        old_init_func = "MARKET_VOUCHER_ON_INIT"
    }
}, {
    key = "monster_card_changer",
    data = {
        use = 0,
        name = "Monster Card Changer",
        frame_use = false,
        config_func = "",
        old_init_func = "MONSTERCARD_CHANGE_ON_INIT"
    }
}, {
    key = "monster_kill_count",
    data = {
        use = 0,
        name = "Monster Kill Count",
        frame_use = true,
        config_func = "Monster_kill_count_information_context",
        old_init_func = "KLCOUNT_ON_INIT"
    }
}, {
    key = "muteki",
    data = {
        use = 0,
        name = "Muteki",
        frame_use = true,
        config_func = "Muteki_setting_frame_init",
        old_init_func = "MUTEKI2EX_ON_INIT"
    }
}, {
    key = "my_buffs_control",
    data = {
        use = 0,
        name = "My Buffs Control",
        frame_use = true,
        config_func = "My_buffs_control_setting_menu",
        old_init_func = "MY_BUFFS_ON_INIT"
    }
}, {
    key = "no_check",
    data = {
        use = 0,
        name = "No Check",
        frame_use = false,
        config_func = "",
        old_init_func = "NOCHECK_ON_INIT"
    }
}, {
    key = "other_character_skill_list",
    data = {
        use = 0,
        name = "Other Character Skill List",
        frame_use = true,
        config_func = "Other_character_skill_list_frame_open",
        old_init_func = "OTHER_CHARACTER_SKILL_LIST_ON_INIT"
    }
}, {
    key = "party_marker",
    data = {
        use = 0,
        name = "Party Marker",
        frame_use = false,
        config_func = "",
        old_init_func = "PARTYMARKER_ON_INIT"
    }
}, {
    key = "pick_item_tracker",
    data = {
        use = 0,
        name = "Pick Item Tracker",
        frame_use = false,
        config_func = "",
        old_init_func = "PICK_ITEM_TRACKER_ON_INIT"
    }
}, {
    key = "quick_launcher",
    data = {
        use = 0,
        name = "Quick Launcher",
        frame_use = false,
        config_func = "",
        old_init_func = ""
    }
}, {
    key = "quickslot_operate",
    data = {
        use = 0,
        name = "Quickslot Operate",
        frame_use = false,
        config_func = "",
        old_init_func = "QUICKSLOT_OPERATE_ON_INIT"
    }
}, {
    key = "relic_change",
    data = {
        use = 0,
        name = "Relic Change",
        frame_use = false,
        config_func = "",
        old_init_func = "RELIC_CHANGE_ON_INIT"
    }
}, {
    key = "revival_timer",
    data = {
        use = 0,
        name = "Revival Timer",
        frame_use = true,
        config_func = "Revival_timer_setting",
        old_init_func = "REVIVAL_TIMER_ON_INIT"
    }
}, {
    key = "save_quest",
    data = {
        use = 0,
        name = "Save Quest",
        frame_use = true,
        config_func = "Save_quest_settings",
        old_init_func = "SAVEQUEST_ON_INIT"
    }
}, {
    key = "separate_buff_custom",
    data = {
        use = 0,
        name = "Separate Buff Custom",
        frame_use = true,
        config_func = "Separate_buff_custom_settings",
        old_init_func = ""
    }
}, {
    key = "silent_velnice_ranking",
    data = {
        use = 0,
        name = "Silent Velnice Ranking",
        frame_use = false,
        config_func = "",
        old_init_func = "SILENTVELNICERANKING_ON_INIT"
    }
}, {
    key = "skill_gem_tooltip",
    data = {
        use = 0,
        name = "Skill Gem Tooltip",
        frame_use = false,
        config_func = "",
        old_init_func = "SKILLGEMTOOLTIP_ON_INIT"
    }
}, {
    key = "status_point_check",
    data = {
        use = 0,
        name = "Status Point Check",
        frame_use = true,
        config_func = "Status_point_check_frame",
        old_init_func = "STATUSPOINTCHECK_ON_INIT"
    }
}, {
    key = "sub_map",
    data = {
        use = 0,
        name = "Sub Map",
        frame_use = true,
        config_func = "Sub_map_settings",
        old_init_func = "SUB_MAP_ON_INIT"
    }
}, {
    key = "sub_slotset",
    data = {
        use = 0,
        name = "Sub Slotset",
        frame_use = true,
        config_func = "Sub_slotset_setting",
        old_init_func = "SUB_SLOTSET_ON_INIT"
    }
}, {
    key = "tavern_of_soul",
    data = {
        use = 0,
        name = "Tavern of Soul",
        frame_use = true,
        config_func = "Tavern_of_soul_main_frame_init",
        old_init_func = ""
    } --
}, {
    key = "vakarine_equip",
    data = {
        use = 0,
        name = "Vakarine Equip",
        frame_use = true,
        config_func = "Vakarine_equip_config_frame_open",
        old_init_func = "VAKARINE_EQUIP_ON_INIT"
    } --
}}

g._nexus_addons_trans = {
    ["bulk_sales"] = {
        ja = "{ol}雑貨屋で大量販売出来るスロットセットを提供",
        etc = "{ol}Provide slots for bulk selling at a grocery store",
        kr = "{ol}잡화점에서 대량으로 판매 가능한 슬롯 세트 제공"
    },
    ["auto_map_change"] = {
        ja = "{ol}マップ移動時のダイアログ選択を自動化",
        etc = "{ol}Automate Dialogue Selection during Map Movement",
        kr = "{ol}맵 이동 시 다이얼로그 선택 자동화"
    },
    ["ancient_auto_set"] = {
        ja = "{ol}アシスターセットをキャラ毎に自動で付け替えます{nl}事前にアシスター保管箱で設定必要",
        etc = "{ol}Automatically swap Ancient Sets per character{nl}Requires prior setup in the Ancient Storage",
        kr = "{ol}어시스터 세트를 캐릭터별로 자동으로 교체{nl}미리 어시스터 보관함에서 설정 필요"
    },
    ["auto_pet_summon"] = {
        ja = "{ol}キャラ毎に最後に連れていたペットを自動で召喚します",
        etc = "{ol}Automatically summon the last-used pet for each character",
        kr = "{ol}캐릭터별로 마지막에 데리고 있던 펫을 자동으로 소환"
    },
    ["acquire_relic_reward"] = {
        ja = "{ol}ebisukeさん作成{nl}自動でレリッククエスト報酬を受け取ります{nl}マップ切替時などにゲームがクラッシュするバグ修正済",
        etc = "{ol}Created by ebisuke{nl}Automatically accepts Relic Quest rewards{nl}Fixed a bug causing the game to crash during map transitions",
        kr = "{ol}ebisuke님 제작{nl}레릭 퀘스트 보상을 자동으로 수령{nl}맵 전환 시 게임이 충돌하는 버그 수정 완료"
    },
    ["auto_repair"] = {
        ja = "{ol}装備の耐久を監視して30%未満になると緊急修理キットを使用して自動で修理します{nl}女神の証商店からの自動補充機能付き",
        etc = "{ol}Monitors equipment durability and automatically repairs{nl}it using an Emergency Repair Kit when durability drops below 30%{nl}Includes automatic resupply from the Goddess's Token Shop",
        kr = "{ol}장비 내구도를 감시하여 30% 미만 시 긴급 수리 키트로 자동 수리{nl}여신의 증표 상점 자동 보충 기능 포함"
    },
    ["boss_direction"] = {
        ja = "{ol}ボスが向いている方向を矢印でお知らせ",
        etc = "{ol}Arrow indicates the direction the boss is facing",
        kr = "{ol}보스가 향하는 방향을 화살표로 표시"
    },
    ["dungeon_rp_charger"] = {
        ja = "{ol}meldavyさん作成{nl}聖域で自動でレリックポイントを補充します",
        etc = "{ol}Created by meldavy{nl}Automatically replenishes Relic Points in Sanctuary",
        kr = "{ol}meldavy님 제작{nl}성역에서 레릭 포인트를 자동으로 보충"
    },
    ["guild_event_warp"] = {
        ja = "{ol}画面右上の小さいボタンから封鎖戦マップの1チャンネルにワープ",
        etc = "{ol}Warp to Channel 1 of the Blockade Battle Map{nl}from the button in the upper right corner of the screen",
        kr = "{ol}화면 오른쪽 상단의 작은 버튼으로 봉쇄전 맵의 1채널로 워프"
    },
    ["instant_cc"] = {
        ja = "{ol}ebisukeさん作成{nl}キャラクターチェンジを簡易にします",
        etc = "{ol}Created by ebisuke{nl}Simplifies character switching",
        kr = "{ol}ebisuke님 제작{nl}캐릭터 변경을 간소화"
    },
    ["job_change_helper"] = {
        ja = "{ol}装備解除など、転職を簡易にします",
        etc = "{ol}Simplifies job change, such as unequipping gear",
        kr = "{ol}장비 해제 등, 전직을 간소화"
    },
    ["aethergem_manager"] = {
        ja = "{ol}エーテルジェムの付け替えを自動化{nl}キャラ毎の設定が必要です",
        etc = "{ol}Automate Aethergem equipping/swapping{nl}Settings are required for each character",
        kr = "{ol}에테르 젬 교체 자동화{nl}캐릭터별 설정이 필요합니다"
    },
    ["party_marker"] = {
        ja = "{ol}Charbonさん作成{nl}パーティーメンバーの頭上にアイコンを付けます",
        etc = "{ol}Created by Charbon{nl}Add an icon above the party members' heads",
        kr = "{ol}Charbon님 제작{nl}파티 멤버의 머리 위에 아이콘을 표시"
    },
    ["boss_gauge"] = {
        ja = "{ol}ボスゲージにスタン値とシールド値を表示します",
        etc = "{ol}Display Stun value and Shield value on the boss gauge",
        kr = "{ol}보스 게이지에 스턴 수치와 쉴드 수치 표시"
    },
    ["always_status"] = {
        ja = "{ol}ステータスを常に表示します",
        etc = "{ol}Always display status",
        kr = "{ol}스테이터스를 항상 표시"
    },
    ["characters_item_serch"] = {
        ja = "{ol}各キャラクターのアイテム検索{nl}インベントリボタン右クリックでも作動",
        etc = "{ol}Item search for each character{nl}Also activates by right-clicking the Inventory button",
        kr = "{ol}각 캐릭터의 아이템 검색{nl}인벤토리 버튼 오른쪽 클릭으로도 작동"
    },
    ["continue_reinforce"] = {
        ja = "{ol}ゴッデス装備連続強化",
        etc = "{ol}Goddes equipment continuous reinforcement",
        kr = "{ol}갓데스 장비 연속 강화"
    },
    ["debuff_notice"] = {
        ja = "{ol}自分が与えたデバフを見やすく表示",
        etc = "{ol}Clearly display the debuffs inflicted by oneself",
        kr = "{ol}자신이 부여한 디버프를 보기 쉽게 표시"
    },
    ["easy_buff"] = {
        ja = "{ol}Kiicchanさん作成{nl}各種商店でバフ自動付与",
        etc = "{ol}Created by Kiicchan{nl}Automatic buff application at various shops",
        kr = "{ol}Kiicchan님 제작{nl}각종 상점에서 버프 자동 부여"
    },
    ["monster_kill_count"] = {
        ja = "{ol}フィールド狩りで倒したモンスターをカウント{nl}アイテムドロップ情報取得",
        etc = "{ol}Count monsters defeated in field hunting{nl}Acquire item drop information",
        kr = "{ol}필드 사냥으로 처치한 몬스터 카운트{nl}아이템 드롭 정보 획득"
    },
    ["pick_item_tracker"] = {
        ja = "{ol}アイテム取得情報表示",
        etc = "{ol}Display item acquisition information",
        kr = "{ol}아이템 획득 정보 표시"
    },
    ["lets_go_home"] = {
        ja = "{ol}ホームタウンのホームチャンネルにワープします",
        etc = "{ol}Warp to the hometown's home channel",
        kr = "{ol}홈타운의 홈 채널로 워프"
    },
    ["market_voucher"] = {
        ja = "{ol}マーケットでの取引履歴表示",
        etc = "{ol}Show market trade history",
        kr = "{ol}마켓에서의 거래 내역 표시"
    },
    ["monster_card_changer"] = {
        ja = "{ol}モンスターカードプリセットを使いやすくします{nl}カード自動着脱、自動搬出入",
        etc = "{ol}Improve usability of monster card presets{nl}Automatic card equipping/unequipping, automatic transfer in/out",
        kr = "{ol}몬스터 카드 프리셋을 사용하기 쉽게 개선{nl}카드 자동 장착/해제, 자동 반출입"
    },
    ["my_buffs_control"] = {
        ja = "{ol}バフ欄を移動可能にして、選択したバフを非表示にします{nl}街では動作しません",
        etc = "{ol}Make the buff panel movable and hide selected buffs{nl}Does not operate in city",
        kr = "{ol}버프 목록을 이동 가능하게 하고, 선택한 버프를 숨깁니다{nl}마을에서는 동작하지 않습니다"
    },
    ["quickslot_operate"] = {
        ja = "{ol}クイックスロットの女神ポーションをレイド毎に付け替えます{nl}ストレートモード、保存、読込機能もあります",
        etc = "{ol}Change the Goddess Potion in the quick slot for each raid{nl}Straight mode, save, and load functions are also available",
        kr = "{ol}퀵슬롯의 여신 포션을 레이드마다 교체{nl}스트레이트 모드, 저장, 불러오기 기능도 제공"
    },
    ["relic_change"] = {
        ja = "{ol}レリックシアンジェム付替えを簡易に",
        etc = "{ol}Simplify relic Cyan Gem swapping",
        kr = "{ol}레릭 시안 젬 교체를 간소화"
    },
    ["revival_timer"] = {
        ja = "{ol}普通のタイマー{nl}チャットコマンド'/rtimer'で作動",
        etc = "{ol}Normal timer{nl}Operates with the chat command '/rtimer'",
        kr = "{ol}일반 타이머{nl}채팅 명령어 '/rtimer'로 작동"
    },
    ["vakarine_equip"] = {
        ja = "{ol}ヴァカリネの恩恵を5箇所装着している場合{nl}レイドなどで装備を脱着します",
        etc = "{ol}When 5 Vakarine's Blessings are equipped{nl}this automatically equips/unequips gear during raids, etc",
        kr = "{ol}바카리네의 은총 5부위 장착 시{nl}레이드 등에서 장비를 장착/해제"
    },
    ["no_check"] = {
        ja = "{ol}各種確認を消します{nl}インベントリ検索窓横にボタンあります",
        etc = "{ol}Disable various confirmations{nl}Button is next to the inventory search window",
        kr = "{ol}각종 확인 창을 끕니다{nl}인벤토리 검색창 옆에 버튼 위치"
    },
    ["sub_map"] = {
        ja = "{ol}小さなマップを表示します",
        etc = "{ol}Show small map",
        kr = "{ol}미니맵을 표시"
    },
    ["separate_buff_custom"] = {
        ja = "{ol}セパレートバフフレームを改造します",
        etc = "{ol}Customize the separated buff frame",
        kr = "{ol}분리된 버프 프레임을 개조합니다"
    },
    ["skill_gem_tooltip"] = {
        ja = "{ol}ebisukeさん作成{nl}スキルジェムにツールチップを表示",
        etc = "{ol}Created by ebisuke{nl}Display tooltip on skill gems",
        kr = "{ol}ebisuke님 제작{nl}스킬 젬에 툴팁 표시"
    },
    ["save_quest"] = {
        ja = "{ol}weizlogyさん作成{nl}ワープ用のクエスト誤完了防止",
        etc = "{ol}Created by weizlogy{nl}Prevent accidental completion of warp quests",
        kr = "{ol}weizlogy님 제작{nl}워프용 퀘스트 오완료 방지"
    },
    ["silent_velnice_ranking"] = {
        ja = "{ol}ebisukeさん作成{nl}ヴェルニケのランキングを非表示にします{nl}TABキー押下でランキング表示",
        etc = "{ol}Created by ebisuke{nl}Hides the Velnice Ranking{nl}Press TAB key to show rankings",
        kr = "{ol}ebisuke님 제작{nl}벨니스 랭킹을 숨깁니다{nl}TAB 키를 누르면 랭킹 표시"
    },
    ["status_point_check"] = {
        ja = "{ol}torahamuさん作成{nl}ステータスポイントがもらえるクエストのクリア状況表示",
        etc = "{ol}Created by torahamu{nl}Display the clear status of quests that grant status points",
        kr = "{ol}torahamu님 제작{nl}스탯 포인트 획득 퀘스트의 클리어 상황 표시"
    },
    ["another_warehouse"] = {
        ja = "{ol}ebisukeさん作成{nl}チーム倉庫改造アドオンの保守改造版",
        etc = "{ol}Created by ebisuke{nl}Maintenance and modification version of the Team Storage Modification addon",
        kr = "{ol}ebisuke님 제작{nl}팀 창고 개조 애드온의 유지보수 및 개량 버전"
    },
    ["cc_helper"] = {
        ja = "{ol}各種装備をインベントリのボタンで倉庫から出し入れして着脱をします",
        etc = "{ol}Various equipment is deposited/withdrawn from storage{nl}and equipped/unequipped via a button in the inventory",
        kr = "{ol}각종 장비를 인벤토리 버튼으로 창고에서 꺼내거나 넣으며 장착 및 해제합니다"
    },
    ["sub_slotset"] = {
        ja = "{ol}weizlogyさん作成{nl}クイックスロットを追加します",
        etc = "{ol}Created by weizlogy{nl}Adds Quick Slots",
        kr = "{ol}weizlogy님 제작{nl}퀵 슬롯을 추가합니다" --
    },
    ["indun_panel"] = {
        ja = "{ol}チャレンジやレイドに入る支援パネルを表示します",
        etc = "{ol}Displays the support panel for entering Challenges and Raids",
        kr = "{ol}챌린지나 레이드에 진입할 때 지원 패널을 표시합니다"
    },
    ["muteki"] = {
        ja = "{ol}writ312さん作成{nl}バフ表示をわかりやすく",
        etc = "{ol}Created by writ312{nl}Improve the clarity of the buff display",
        kr = "{ol}writ312님 제작{nl}버프 표시를 이해하기 쉽게 만드세요"
    },
    ["indun_list_viewer"] = {
        ja = "{ol}レイドのクリア状況を一覧表示{nl}Indun Panelの戻るボタン左クリックでも表示",
        etc = "{ol}Display a list of raid clear status{nl}Also displays the Indun Panel when left-clicking the Back button",
        kr = "{ol}레이드 완료 상황을 목록으로 표시{nl}'Indun Panel'의 '뒤로가기' 버튼을 왼쪽 클릭해도 표시"
    },
    ["other_character_skill_list"] = { --
        ja = "{ol}各キャラクターの錬成スキルや強化値を一覧表示{nl}Indun Panelの戻るボタン右クリックでも表示",
        etc = "{ol}Display a list of each character's alchemic skills and enhancement values{nl}Also displays the Indun Panel when right-clicking the Back button",
        kr = "{ol}각 캐릭터의 연성 스킬 및 강화 수치를 목록으로 표시{nl}'Indun Panel'의 '뒤로가기' 버튼을 오른쪽 클릭해도 표시"
    },
    ["battle_ritual"] = {
        ja = "{ol}レイド前の儀式を自動化します{nl}ソロの時しか動きません{nl}ミニマップの左上のアイコンで切替",
        etc = "{ol}Automates the pre-raid ritual{nl}Only works when playing solo{nl}Switch using the icon in the upper left corner of the mini-map",
        kr = "{ol}레이드 전의 의식을 자동화합니다{nl}솔로 플레이 시에만 작동합니다{nl}미니맵의 왼쪽 상단 아이콘으로 전환"
    },
    ["goddess_icor_manager"] = { -- 
        ja = "{ol}インベントリにボタンが出来ます{nl}イコルのオプション付与を一覧表示して簡易化します",
        etc = "{ol}A button will be added to the inventory{nl}It simplifies Icor option{nl}granting by displaying them in a list",
        kr = "{ol}인벤토리에 버튼이 생깁니다{nl}이코르의 옵션 부여를 일람 표시하여 간소화합니다"
    },
    ["tavern_of_soul"] = { -- "archeology_helper"
        ja = "{ol}簡易検索用データベース",
        etc = "{ol}Simplified search database",
        kr = "{ol}간이 검색용 데이터베이스"
    },
    ["archeology_helper"] = { -- "archeology_helper"--"ancient_monster_bookshelf"
        ja = "{ol}アーキオロジー用アドオン",
        etc = "{ol}Addon for Archaeology",
        kr = "{ol}아키올로지용 애드온"
    },
    ["quick_launcher"] = {
        ja = "{ol}Ctrl+`でクイックランチャーを表示{nl}インダンパネルやギルドアジトへの移動など",
        etc = "{ol}Show Quick Launcher with Ctrl+`{nl}Open Indun Panel, move to Guild Agit, etc.",
        kr = "{ol}Ctrl+`로 퀵 런처 표시{nl}인던 패널 열기, 길드 아지트 이동 등"
    } --[[,
    ["ancient_monster_bookshelf"] = { -- "archeology_helper"--"ancient_monster_bookshelf"
        ja = "{ol}ebisukeさん作成{nl}アシスターカード整理アドオン",
        etc = "{ol}Created by ebisuke{nl}Addon for Organizing Assister Cards",
        kr = "{ol}ebisuke님 제작{nl}어시스터 카드 정리 애드온"
    }]]
}
function _nexus_addons_save_settings()
    g.save_json(g.settings_path, g.settings)
end

function _nexus_addons_load_settings()
    local settings = g.load_json(g.settings_path)
    if not settings then
        settings = {}
    end
    local changed = false
    local valid_keys = {}
    for _, entry in ipairs(g._nexus_addons) do
        valid_keys[entry.key] = true
    end
    for key, _ in pairs(settings) do
        if not valid_keys[key] then
            settings[key] = nil
            changed = true
        end
    end
    local force_update_keys = {
        name = true,
        config_func = true,
        frame_use = true,
        old_init_func = true
    }
    for _, entry in ipairs(g._nexus_addons) do
        local key = entry.key
        local default_data = entry.data
        if not settings[key] then
            settings[key] = {}
            for k, v in pairs(default_data) do
                settings[key][k] = v
            end
            changed = true
        elseif type(settings[key]) == "table" then
            for k, v in pairs(default_data) do
                if settings[key][k] == nil then
                    settings[key][k] = v
                    changed = true
                elseif force_update_keys[k] and settings[key][k] ~= v then
                    settings[key][k] = v
                    changed = true
                end
            end
            for k, v in pairs(settings[key]) do
                if default_data[k] == nil then
                    settings[key][k] = nil
                    changed = true
                end
            end
        end
    end
    g.settings = settings
    if changed then
        _nexus_addons_save_settings()
    end
end

function _NEXUS_ADDONS_ON_INIT(addon, frame)
    g.addon = addon
    g.frame = frame
    g.lang = option.GetCurrentCountry()
    g.cid = session.GetMySession():GetCID()
    g.active_id = session.loginInfo.GetAID()
    g.settings_path = string.format("../addons/%s/%s/settings.json", addon_name_lower, g.active_id)
    if not g.folders_created then
        g.mkdir_new_folder()
        g.folders_created = true
    end
    g.login_name = session.GetMySession():GetPCApc():GetName()
    g.map_name = session.GetMapName()
    g.map_id = session.GetMapID()
    g.current_channel = session.loginInfo.GetChannel() -- 0が1ch
    g.pc = GetMyPCObject()
    g.REGISTER = {}
    addon:RegisterMsg('GAME_START', '_nexus_addons_GAME_START')
    addon:RegisterMsg('GAME_START_3SEC', '_nexus_addons_GAME_START_3SEC')
    g.setup_hook(_nexus_addons_CHAT_SYSTEM, "CHAT_SYSTEM")
end

function _nexus_addons_CHAT_SYSTEM(msg, color)
    if msg == "None" then
        return
    end
    g.FUNCS["CHAT_SYSTEM"](msg, color)
end

function _nexus_addons_init_addons(is_toggle, toggled_addon_name, _nexus_addons)
    g.error_count = 0
    local function safe_call(func, name)
        if type(func) == "function" then
            local func_start = imcTime.GetAppTimeMS()
            local success, err = pcall(func)
            local func_end = imcTime.GetAppTimeMS()
            local duration = func_end - func_start
            if not success then
                g.error_count = g.error_count + 1
                local err_msg = string.format("Error during on_init of '%s': %s", name, tostring(err))
                ts(err_msg)
                g.log_to_file(err_msg)
            end
        end
    end
    if not g.loaded then
        g.pending_messages = {}
        for _, entry in ipairs(g._nexus_addons) do
            local key = entry.key
            local old_init_func_name = entry.data.old_init_func
            if old_init_func_name and old_init_func_name ~= "" and _G[old_init_func_name] then
                local message
                old_init_func_name = string.lower(string.gsub(old_init_func_name, "_ON_INIT", ""))
                old_init_func_name = string.gsub(old_init_func_name, "_", " ")
                if g.lang == "Japanese" then
                    message = string.format(
                        "{ol}{#FF6347}[Nexus Addons] 競合する古いアドオン '%s' が検出されました{nl}'%s' を無効化しました{nl}dataフォルダから、古いアドオンのipfファイルを削除してください",
                        old_init_func_name, key)
                else
                    message = string.format(
                        "{ol}{#FF6347}[Nexus Addons] Conflicting old addon '%s' detected{nl}Disabled '%s'{nl}Please remove the old addon's ipf file from your data folders",
                        old_init_func_name, key)
                end
                table.insert(g.pending_messages, message)
                if g.settings[key] then
                    if g.settings[key].use == 1 then
                        g.settings[key].use = 0
                        _nexus_addons_save_settings()
                    end
                else
                    ts(string.format("[Nexus Addons] Error: Settings for '%s' not found.", key))
                end
            end
        end
    end
    if not g.loaded then
        _nexus_addons:SetUserValue("FUNC_INDEX", 1)
        _nexus_addons:RunUpdateScript("_nexus_addons_async_safe_call", 0.1)
        return
    else
        for _, entry in ipairs(g._nexus_addons) do
            local key = entry.key
            local on_init_func = _G[key .. "_on_init"]
            if is_toggle then
                if key == toggled_addon_name then
                    safe_call(on_init_func, key)
                end
            else
                safe_call(on_init_func, key)
            end
        end
    end
    if not is_toggle then
        if g.error_count == 0 then
            ts("All add-ons initialized successfully.")
        else
            ts(string.format("%d add-on(s) failed to initialize...", g.error_count))
        end
    end
end

function _nexus_addons_async_safe_call(_nexus_addons)
    local start_time = imcTime.GetAppTimeMS()
    local time_limit = 6
    local process_count = 0
    local max_process_per_frame = 2
    while true do
        local func_index = _nexus_addons:GetUserIValue("FUNC_INDEX")
        local entry = g._nexus_addons[func_index]
        if not entry then
            if #g.pending_messages > 0 and not g.loaded then
                _nexus_addons:RunUpdateScript("_nexus_addons_chat_system", 0.5)
            end
            g.loaded = true
            if g.error_count == 0 then
                ts("All add-ons initialized successfully.")
            else
                ts(string.format("%d add-on(s) failed to initialize...", g.error_count))
            end
            return 0
        end
        local func_name = entry.key
        local on_init_func = _G[func_name .. "_on_init"]
        if type(on_init_func) == "function" then
            local func_start = imcTime.GetAppTimeMS()
            local success, err = pcall(on_init_func)
            local func_end = imcTime.GetAppTimeMS()
            local duration = func_end - func_start
            ts(string.format("init ADDON: %s (%d ms)", func_name, duration))
            if not success then
                g.error_count = g.error_count + 1
                local err_msg = string.format("Error during on_init of '%s': %s", func_name, tostring(err))
                ts(err_msg)
                g.log_to_file(err_msg)
            end
        end
        _nexus_addons:SetUserValue("FUNC_INDEX", func_index + 1)
        process_count = process_count + 1
        if (imcTime.GetAppTimeMS() - start_time) >= time_limit or process_count >= max_process_per_frame then
            return 1
        end
    end
end

function _nexus_addons_chat_system(_nexus_addons)
    if #g.pending_messages > 0 then
        local msg = table.remove(g.pending_messages, 1)
        CHAT_SYSTEM(msg)
        return 1
    end
    return 0
end

function _nexus_addons_frame_init()
    local list_frame_name = addon_name_lower .. "list_frame"
    local list_frame = ui.CreateNewFrame("notice_on_pc", list_frame_name, 0, 0, 10, 10)
    AUTO_CAST(list_frame)
    list_frame:RemoveAllChild()
    list_frame:SetSkinName("test_frame_low")
    list_frame:EnableHittestFrame(1)
    list_frame:SetTitleBarSkin("None")
    list_frame:SetLayerLevel(92)
    local title = list_frame:CreateOrGetControl('richtext', 'title', 20, 10, 10, 30)
    AUTO_CAST(title)
    title:SetText("{#000000}{s25}New Nexus Addons" .. " {s15}ver " .. ver)
    local close_button = list_frame:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
    AUTO_CAST(close_button)
    close_button:SetImage("testclose_button")
    close_button:SetGravity(ui.RIGHT, ui.TOP)
    close_button:SetEventScript(ui.LBUTTONUP, "_nexus_addons_list_close")
    local list_gb = list_frame:CreateOrGetControl("groupbox", "list_gb", 10, 40, 0, 0)
    AUTO_CAST(list_gb)
    list_gb:SetSkinName("bg")
    list_gb:RemoveAllChild()
    list_gb:EnableHitTest(1)
    list_frame:ShowWindow(1)
    local base_num = 25
    local col1_x = 20
    local row_height = 35
    local max_width1 = 0
    local max_width2 = 0
    for i, entry in ipairs(g._nexus_addons) do
        local name = entry.data.name
        local current_y = (i <= base_num) and (i - 1) * row_height or (i - (base_num + 1)) * row_height
        local name_text = list_gb:CreateOrGetControl('richtext', 'name_text' .. i, col1_x, current_y + 10, 10, 30)
        AUTO_CAST(name_text)
        name_text:SetText("{ol}{s20}" .. name)
        if i <= base_num then
            max_width1 = math.max(max_width1, name_text:GetWidth())
        else
            max_width2 = math.max(max_width2, name_text:GetWidth())
        end
    end
    local col2_x = col1_x + max_width1 + 180
    for i, entry in ipairs(g._nexus_addons) do
        local child_addon_name = entry.key
        local data = entry.data
        local use = g.settings[child_addon_name].use
        local buttons_x, current_y
        if i <= base_num then
            buttons_x = col1_x + max_width1 + 25
            current_y = (i - 1) * row_height
        else
            local name_text = GET_CHILD(list_gb, 'name_text' .. i)
            name_text:SetPos(col2_x, name_text:GetY())
            buttons_x = col2_x + max_width2 + 25
            current_y = (i - (base_num + 1)) * row_height
        end
        local use_toggle = list_gb:CreateOrGetControl('picture', "use_toggle" .. i, buttons_x, current_y + 10, 60, 25)
        AUTO_CAST(use_toggle)
        use_toggle:SetImage(use == 1 and "test_com_ability_on" or "test_com_ability_off")
        use_toggle:SetEnableStretch(1)
        use_toggle:EnableHitTest(1)
        use_toggle:SetTextTooltip("{ol}ON/OFF")
        use_toggle:SetEventScript(ui.LBUTTONUP, "_nexus_addons_toggle_addons")
        use_toggle:SetEventScriptArgString(ui.LBUTTONUP, child_addon_name)
        if data.frame_use then
            local config_btn = list_gb:CreateOrGetControl('button', 'config_btn' .. i, buttons_x + 65, current_y + 10,
                25, 25)
            AUTO_CAST(config_btn)
            config_btn:SetSkinName("None")
            config_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}設定フレーム呼出し" or
                                          "Call Settings Frame")
            config_btn:SetText("{img config_button_normal 25 25}")
            if data.config_func and data.config_func ~= "" then
                config_btn:SetEventScript(ui.LBUTTONUP, data.config_func)
            end
        end
        local help_btn = list_gb:CreateOrGetControl('button', 'help_btn' .. i, buttons_x + 100, current_y + 5, 40, 30)
        AUTO_CAST(help_btn)
        help_btn:SetText("{ol}{img question_mark 20 15}")
        local tooltip_text
        if g.lang == "Japanese" then
            tooltip_text = g._nexus_addons_trans[child_addon_name].ja
        elseif g.lang == "kr" then
            tooltip_text = g._nexus_addons_trans[child_addon_name].kr
        else
            tooltip_text = g._nexus_addons_trans[child_addon_name].etc
        end
        help_btn:SetTextTooltip(tooltip_text)
        help_btn:SetSkinName("test_pvp_btn")
    end
    local total_width = col2_x + max_width2 + 200
    local total_height = base_num * row_height + 70
    list_frame:Resize(total_width, total_height)
    list_gb:Resize(list_frame:GetWidth() - 20, list_frame:GetHeight() - 50)
    list_frame:SetPos(310, 100)
    return list_frame
end

function _nexus_addons_list_close(frame)
    local frame_to_close = {"boss_direction_settings", "auto_repair_settings", "instant_cc_settings",
                            "my_buffs_control_setting", "revival_timer_setting", "vakarine_equip_config_frame",
                            "easy_buff", "always_status_settings", "lets_go_home_setting", "characters_item_serch",
                            "sub_map_setting_frame", "separate_buff_custom_buff_list", "save_quest_setting",
                            "sub_slotset_setting", "Battle_ritual_setting", "Battle_ritual_skill_list",
                            "Battle_ritual_buff_list", "get_event_msg_setting", "archeology_helper_setting"}
    for _, suffix in ipairs(frame_to_close) do
        local frame_name = addon_name_lower .. suffix
        local frame_to_close = ui.GetFrame(frame_name)
        if frame_to_close then
            ui.DestroyFrame(frame_name)
        end
    end
    ui.DestroyFrame(frame:GetName())
end

function _nexus_addons_toggle_addons(list_gb, use_toggle, child_addon_name, num)
    local old_init_func_name = nil
    for _, entry in ipairs(g._nexus_addons) do
        if entry.key == child_addon_name then
            old_init_func_name = entry.data.old_init_func
            break
        end
    end
    if old_init_func_name and old_init_func_name ~= "" and _G[old_init_func_name] and
        not (old_init_func_name == "INSTANTCC_ON_INIT" and _G["instant_cc_on_init"]) then
        local message = nil
        old_init_func_name = string.lower(string.gsub(old_init_func_name, "_ON_INIT", ""))
        old_init_func_name = string.gsub(old_init_func_name, "_", " ")
        if g.lang == "Japanese" then
            message = string.format(
                "[Nexus Addons] 競合する古いアドオン '%s' が検出されました '%s' を有効化できません{nl}dataフォルダから、古いアドオンのipfファイルを削除してください",
                old_init_func_name, child_addon_name)
        else
            message = string.format(
                "[Nexus Addons] Conflicting old addon '%s' detected Cannot enable '%s'{nl}Please remove the old addon's ipf file from your data folders",
                old_init_func_name, child_addon_name)
        end
        if message then
            imcAddOn.BroadMsg("NOTICE_Dm_!", message, 5.0)
        end
        return
    end
    if g.settings[child_addon_name].use == 1 then
        g.settings[child_addon_name].use = 0
        local msg = g.lang == "Japanese" and g.settings[child_addon_name].name .. " 無効にしました" or
                        g.settings[child_addon_name].name .. " Disabled"
        imcAddOn.BroadMsg("NOTICE_Dm_!", msg, 5.0)
    else
        g.settings[child_addon_name].use = 1
        local msg = g.lang == "Japanese" and g.settings[child_addon_name].name .. " 有効にしました" or
                        g.settings[child_addon_name].name .. " Enabled"
        imcAddOn.BroadMsg("NOTICE_Dm_Bell", msg, 5.0)
    end
    _nexus_addons_init_addons(true, child_addon_name)
    _nexus_addons_save_settings()
    _nexus_addons_frame_init()
end

function _nexus_addons_GAME_START(_nexus_addons, msg)
    -- if not g.settings then
    _nexus_addons_load_settings()
    -- end
    _G["norisan"] = _G["norisan"] or {}
    _G["norisan"]["MENU"] = _G["norisan"]["MENU"] or {}
    local menu_data = {
        name = "Nexus Addons",
        icon = "sysmenu_coll",
        func = "_nexus_addons_frame_init",
        image = ""
    }
    _G["norisan"]["MENU"][addon_name] = menu_data
    local frame_name = _G["norisan"]["MENU"].frame_name
    local menu_frame = ui.GetFrame(frame_name)
    if menu_frame and frame_name ~= "norisan_menu_frame" then
        ui.DestroyFrame(frame_name)
    end
    frame_name = "norisan_menu_frame"
    menu_frame = ui.GetFrame(frame_name)
    if not menu_frame then
        _G["norisan"]["MENU"].frame_name = frame_name
        g.norisan_menu_create_frame()
    elseif menu_frame:IsVisible() == 0 then
        menu_frame:ShowWindow(1)
    end
    g.setup_hook(_nexus_addons_APPS_TRY_MOVE_BARRACK, "APPS_TRY_MOVE_BARRACK")
    _nexus_addons_fast_func()
end

function _nexus_addons_GAME_START_3SEC(_nexus_addons, msg)
    _nexus_addons_init_addons(false, nil, _nexus_addons)
    g.addon:RegisterMsg('FPS_UPDATE', '_nexus_addons_update_frames')
end

function _nexus_addons_fast_func(_nexus_addons)
    if g.separate_buff_custom_settings and g.settings.separate_buff_custom.use == 1 and
        g.separate_buff_custom_settings.tracking == 1 then
        Separate_buff_custom_frame_move()
    end
    if g.quickslot_operate_settings and g.quickslot_operate_settings.straight then
        Quickslot_operate_redraw_slots()
    end --
    if g.indun_panel_settings and g.settings.indun_panel.use == 1 then
        Indun_panel_frame_init()
    end
    if g.awh_settings then
        another_warehouse_on_init()
    end
end

function _nexus_addons_update_frames(_nexus_addons)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    if _nexus_addons and _nexus_addons:IsVisible() == 0 then
        _nexus_addons:ShowWindow(1)
    end
    local frames_to_check = {"always_status", "pick_item_tracker", "monster_kill_count", "debuff_notice",
                             "guild_event_warp", "lets_go_home", "relic_change", "vakarine_equip", "sub_map",
                             "save_quest", "indun_panel", "Battle_ritual", "muteki", "au_map", "tos_btn"}
    for _, frame_key in ipairs(frames_to_check) do
        local frame_name = addon_name_lower .. frame_key
        local frame = ui.GetFrame(frame_name)
        if frame and frame:IsVisible() == 0 then
            if frame_key == "pick_item_tracker" then
                if g.get_map_type() ~= "City" and g.get_map_type() ~= "Instance" then
                    AUTO_CAST(frame)
                    frame:ShowWindow(1)
                end
            else
                AUTO_CAST(frame)
                frame:ShowWindow(1)
            end
        end
    end
end

function _nexus_addons_APPS_TRY_MOVE_BARRACK()
    Other_character_skill_list_save_enchant()
    Indun_list_viewer_save_current_char_counts()
    if g.settings.instant_cc and g.settings.instant_cc.use == 1 then
        if Instant_cc_APPS_TRY_LEAVE_ then
            Instant_cc_APPS_TRY_LEAVE_("Barrack")
            return
        end
    end
    if g.settings.indun_list_viewer and g.settings.indun_list_viewer.use == 1 then
        if Indun_list_viewer_CHECK_ALERT and Indun_list_viewer_CHECK_ALERT("Barrack") then
            return
        end
    end
    APPS_TRY_LEAVE("Barrack")
end
-- always_status ここから
local always_status_group_colors = {
    base = "{#00FF00}",
    atk1 = "{#FF6600}",
    atk2 = "{#FF4040}",
    def = "{#66B3FF}"
}
local always_status_master_list =
    { -- { key = "プログラム上の名前", group = "色グループ", on = デフォルト表示(1=ON), jp = "日本語短縮名" }
    -- 基本ステータス
    {
        key = "STR",
        group = "base",
        on = 1
    }, {
        key = "INT",
        group = "base",
        on = 1
    }, {
        key = "CON",
        group = "base",
        on = 0
    }, {
        key = "MNA",
        group = "base",
        on = 0
    }, {
        key = "DEX",
        group = "base",
        on = 0
    }, {
        key = "gear_score",
        group = "base",
        on = 1
    }, {
        key = "ability_point_score",
        group = "base",
        on = 1
    }, {
        key = "RHP",
        group = "atk1",
        on = 1
    }, {
        key = "RSP",
        group = "atk1",
        on = 0
    }, {
        key = "PATK",
        group = "atk1",
        on = 1
    }, {
        key = "MATK",
        group = "atk1",
        on = 1
    }, {
        key = "HEAL_PWR",
        group = "atk1",
        on = 0
    }, {
        key = "SR",
        group = "atk1",
        on = 0
    }, {
        key = "HR",
        group = "atk1",
        on = 1
    }, {
        key = "BLK_BREAK",
        group = "atk1",
        on = 1
    }, {
        key = "CRTATK",
        group = "atk1",
        on = 1,
        jp = "物理クリ攻撃"
    }, {
        key = "CRTMATK",
        group = "atk1",
        on = 1,
        jp = "魔法クリ攻撃"
    }, {
        key = "CRTHR",
        group = "atk1",
        on = 1,
        jp = "クリ発生"
    }, {
        key = "DEF",
        group = "def",
        on = 0
    }, {
        key = "MDEF",
        group = "def",
        on = 0
    }, {
        key = "SDR",
        group = "def",
        on = 0
    }, {
        key = "DR",
        group = "def",
        on = 1
    }, {
        key = "BLK",
        group = "def",
        on = 0
    }, {
        key = "CRTDR",
        group = "def",
        on = 1,
        jp = "クリ抵抗"
    }, {
        key = "MSPD",
        group = "atk1",
        on = 1
    }, {
        key = "CastingSpeed",
        group = "atk1",
        on = 1,
        jp = "キャス時間比率"
    }, {
        key = "Add_Damage_Atk",
        group = "atk2",
        on = 0
    }, {
        key = "ResAdd_Damage",
        group = "def",
        on = 0,
        jp = "追加ダメ抵抗"
    }, {
        key = "Aries_Atk",
        group = "atk2",
        on = 0,
        jp = "突アップ"
    }, {
        key = "Slash_Atk",
        group = "atk2",
        on = 0,
        jp = "斬アップ"
    }, {
        key = "Strike_Atk",
        group = "atk2",
        on = 0,
        jp = "打アップ"
    }, {
        key = "Arrow_Atk",
        group = "atk2",
        on = 0,
        jp = "弓アップ"
    }, {
        key = "Cannon_Atk",
        group = "atk2",
        on = 0,
        jp = "キャノンアップ"
    }, {
        key = "Gun_Atk",
        group = "atk2",
        on = 0,
        jp = "銃器アップ"
    }, {
        key = "Magic_Melee_Atk",
        group = "atk2",
        on = 0,
        jp = "無属性アップ"
    }, {
        key = "Magic_Fire_Atk",
        group = "atk2",
        on = 0,
        jp = "炎属性アップ"
    }, {
        key = "Magic_Ice_Atk",
        group = "atk2",
        on = 0,
        jp = "氷属性アップ"
    }, {
        key = "Magic_Lightning_Atk",
        group = "atk2",
        on = 0,
        jp = "雷属性アップ"
    }, {
        key = "Magic_Earth_Atk",
        group = "atk2",
        on = 0,
        jp = "地属性アップ"
    }, {
        key = "Magic_Poison_Atk",
        group = "atk2",
        on = 0,
        jp = "毒属性アップ"
    }, {
        key = "Magic_Dark_Atk",
        group = "atk2",
        on = 0,
        jp = "闇属性アップ"
    }, {
        key = "Magic_Holy_Atk",
        group = "atk2",
        on = 0,
        jp = "聖属性アップ"
    }, {
        key = "Magic_Soul_Atk",
        group = "atk2",
        on = 0,
        jp = "念属性アップ"
    }, {
        key = "BOSS_ATK",
        group = "atk2",
        on = 1,
        jp = "ボス対象攻撃力"
    }, {
        key = "Cloth_Atk",
        group = "atk2",
        on = 0,
        jp = "クロース対象"
    }, {
        key = "Leather_Atk",
        group = "atk2",
        on = 0,
        jp = "レザー対象"
    }, {
        key = "Iron_Atk",
        group = "atk2",
        on = 0,
        jp = "プレート対象"
    }, {
        key = "Ghost_Atk",
        group = "atk2",
        on = 0,
        jp = "アストラル対象"
    }, {
        key = "MiddleSize_Def",
        group = "def",
        on = 1,
        jp = "中型相殺"
    }, {
        key = "Cloth_Def",
        group = "def",
        on = 0,
        jp = "クロース相殺"
    }, {
        key = "Leather_Def",
        group = "def",
        on = 1,
        jp = "レザー相殺"
    }, {
        key = "Iron_Def",
        group = "def",
        on = 0,
        jp = "プレート相殺"
    }, {
        key = "stun_res",
        group = "def",
        on = 0
    }, {
        key = "high_fire_res",
        group = "def",
        on = 0
    }, {
        key = "high_freezing_res",
        group = "def",
        on = 0
    }, {
        key = "high_lighting_res",
        group = "def",
        on = 0
    }, {
        key = "high_poison_res",
        group = "def",
        on = 0,
        jp = "極：猛毒抵抗"
    }, {
        key = "high_laceration_res",
        group = "def",
        on = 0
    }, {
        key = "portion_expansion",
        group = "def",
        on = 0,
        jp = "エリクサー広域"
    }, {
        key = "Forester_Atk",
        group = "atk2",
        on = 0,
        jp = "植物対象攻撃力"
    }, {
        key = "Widling_Atk",
        group = "atk2",
        on = 0,
        jp = "野獣対象攻撃力"
    }, {
        key = "Klaida_Atk",
        group = "atk2",
        on = 0,
        jp = "昆虫対象攻撃力"
    }, {
        key = "Paramune_Atk",
        group = "atk2",
        on = 0,
        jp = "変異対象攻撃力"
    }, {
        key = "Velnias_Atk",
        group = "atk2",
        on = 0,
        jp = "悪魔対象攻撃力"
    }, {
        key = "perfection",
        group = "atk2",
        on = 1,
        jp = "パーフェクト"
    }, {
        key = "revenge",
        group = "atk2",
        on = 0,
        jp = "復讐"
    }}

function Always_status_save_settings()
    g.save_lua(g.always_status_path, g.always_status_settings)
end

function Always_status_load_settings()
    g.always_status_path = string.format("../addons/%s/%s/always_status.lua", addon_name_lower, g.active_id)
    local json_path = string.format("../addons/%s/%s/always_status.json", addon_name_lower, g.active_id)
    g.always_status_old_path = string.format("../addons/%s/settings.json", "always_status")
    local settings = g.load_lua(g.always_status_path)
    if not settings then
        settings = g.load_json(json_path)
    end
    if not settings then
        settings = g.load_json(g.always_status_old_path)
    end
    local ver = 1.2
    if not settings then
        settings = {
            ver = ver,
            base = {
                frame_X = 0,
                frame_Y = 0,
                enable = 1,
                color = {},
                abbr = {}
            },
            chars = {}
        }
        for _, status_info in ipairs(always_status_master_list) do
            settings.base.color[status_info.key] = always_status_group_colors[status_info.group] or "{#FFFFFF}"
            settings.base.abbr[status_info.key] = status_info.key
        end
        for i = 1, 10 do
            local set_num = tostring(i)
            settings[set_num] = {
                memo = "free memo " .. i
            }
            for _, status_info in ipairs(always_status_master_list) do
                settings[set_num][status_info.key] = status_info.on or 0
            end
        end
    else
        if not settings.base or not settings.ver or settings.ver < ver then
            if not settings.base then
                local new_settings = {
                    ver = ver,
                    base = {
                        frame_X = 0,
                        frame_Y = 0,
                        enable = settings.enable or 0,
                        color = settings.color or {},
                        abbr = {}
                    },
                    chars = {}
                }
                for k, v in pairs(settings) do
                    local num = tonumber(k)
                    if num then
                        if num >= 1 and num <= 10 then
                            local set_key = tostring(k)
                            new_settings[set_key] = v
                        elseif num > 100 then
                            new_settings.chars[tostring(k)] = {
                                on = v.use or 1,
                                use_set = v.key or 1
                            }
                        end
                    end
                end
                settings = new_settings
            end
            settings.ver = ver
        end
    end
    if not settings.base then
        settings.base = {}
    end
    if not settings.base.color then
        settings.base.color = {}
    end
    if not settings.base.abbr then
        settings.base.abbr = {}
    end
    for _, status_info in ipairs(always_status_master_list) do
        if not settings.base.color[status_info.key] then
            settings.base.color[status_info.key] = always_status_group_colors[status_info.group] or "{#FFFFFF}"
        end
        if not settings.base.abbr[status_info.key] then
            settings.base.abbr[status_info.key] = status_info.key
        end
    end
    for i = 1, 10 do
        local set_num = tostring(i)
        if not settings[set_num] then
            settings[set_num] = {
                memo = "free memo " .. i
            }
        end
        for _, status_info in ipairs(always_status_master_list) do
            if settings[set_num][status_info.key] == nil then
                settings[set_num][status_info.key] = status_info.on or 0
            end
        end
    end
    g.always_status_settings = settings
    local cid_str = tostring(g.cid)
    if not g.always_status_settings.chars[cid_str] then
        g.always_status_settings.chars[cid_str] = {
            use_set = 1,
            on = 1
        }
    end
    Always_status_save_settings()
end

function Always_status_char_load_settings()
    g.always_status_settings.chars[g.cid] = {
        use_set = 1,
        on = 1
    }
    Always_status_save_settings()
end

function always_status_on_init()
    if not g.always_status_settings then
        Always_status_load_settings()
    end
    if g.settings.always_status.use == 0 then
        local always_status = ui.GetFrame(addon_name_lower .. "always_status")
        if always_status then
            ui.DestroyFrame(always_status:GetName())
        end
        local settings_frame = ui.GetFrame(addon_name_lower .. "always_status_settings")
        if settings_frame then
            ui.DestroyFrame(settings_frame:GetName())
        end
        return
    end
    if not g.always_status_settings.chars[g.cid] then
        Always_status_char_load_settings()
    end
    local old_func = g.settings.always_status.old_init_func
    if _G[old_func] then
        return
    end
    Always_status_frame_init()
end

function Always_status_lazy_start(frame)
    if not g.always_status_settings then
        Always_status_load_settings()
    end
    local old_func = g.settings.always_status.old_init_func
    if _G[old_func] then
        return
    end
    if g.always_status_settings and g.settings.always_status.use == 1 then
        Always_status_frame_init()
    end
    return 0
end

--[[function Always_status_calc_all_atk_status(pc, attribute_name, value)
    if attribute_name == 'SmallSize_Atk' or attribute_name == 'MiddleSize_Atk' or attribute_name == 'LargeSize_Atk' then
        value = value + TryGetProp(pc, 'AllSize_Atk', 0)
    elseif attribute_name == 'Cloth_Atk' or attribute_name == 'Leather_Atk' or attribute_name == 'Iron_Atk' or
        attribute_name == 'Ghost_Atk' then
        value = value + TryGetProp(pc, 'AllMaterialType_Atk', 0)
    elseif attribute_name == 'Cloth_Def' or attribute_name == 'Leather_Def' or attribute_name == 'Iron_Def' then
        value = value + TryGetProp(pc, 'AllMaterialType_Def', 0)
    elseif attribute_name == 'Forester_Atk' or attribute_name == 'Widling_Atk' or attribute_name == 'Klaida_Atk' or
        attribute_name == 'Paramune_Atk' or attribute_name == 'Velnias_Atk' then
        value = value + TryGetProp(pc, 'AllRace_Atk', 0)
    end
    return value
end]]

function Always_status_calc_all_atk_status(pc, attribute_name, value)
    local is_target = false -- 計算対象かどうかのフラグ
    if attribute_name == 'SmallSize_Atk' or attribute_name == 'MiddleSize_Atk' or attribute_name == 'LargeSize_Atk' then
        value = value + TryGetProp(pc, 'AllSize_Atk', 0)
        is_target = true
    elseif attribute_name == 'Cloth_Atk' or attribute_name == 'Leather_Atk' or attribute_name == 'Iron_Atk' or
        attribute_name == 'Ghost_Atk' then
        value = value + TryGetProp(pc, 'AllMaterialType_Atk', 0)
        is_target = true
    elseif attribute_name == 'Cloth_Def' or attribute_name == 'Leather_Def' or attribute_name == 'Iron_Def' or
        attribute_name == "MiddleSize_Def" then -- "MiddleSize_Def"
        value = value + TryGetProp(pc, 'AllMaterialType_Def', 0)
        is_target = true
    elseif attribute_name == 'Forester_Atk' or attribute_name == 'Widling_Atk' or attribute_name == 'Klaida_Atk' or
        attribute_name == 'Paramune_Atk' or attribute_name == 'Velnias_Atk' then
        value = value + TryGetProp(pc, 'AllRace_Atk', 0)
        is_target = true
    end
    if not is_target then
        return value
    end
    local level = info.GetLevel(session.GetMyHandle())
    local max_cap = level * 30
    local percent = 0
    if max_cap > 0 then
        percent = (value / max_cap) * 100
    end
    return string.format("%d (%.0f%%)", value, percent)
end

function Always_status_calc_special_opt(pc, name)
    local value = 0
    local equip_item_list = session.GetEquipItemList();
    local equip_guid_list = equip_item_list:GetGuidList();
    local count = equip_guid_list:Count()
    for i = 0, count - 1 do
        local guid = equip_guid_list:Get(i)
        if guid ~= '0' then
            local equip_item = equip_item_list:GetItemByGuid(guid);
            if equip_item ~= nil and equip_item:GetObject() ~= nil then
                local item = GetIES(equip_item:GetObject())
                for j = 1, 6 do
                    local _name = 'RandomOption_' .. j
                    local _value = 'RandomOptionValue_' .. j
                    if TryGetProp(item, _name, 'None') == name then
                        value = value + TryGetProp(item, _value, 0)
                    end
                end
            end
        end
    end
    value = value + GetExProp(pc, name .. '_BM')
    return value
end

function Always_status_get_status_text(pc, status)
    local special_opts = {
        perfection = 1,
        revenge = 1,
        stun_res = 1,
        high_fire_res = 1,
        high_freezing_res = 1,
        high_lighting_res = 1,
        high_poison_res = 1,
        high_laceration_res = 1,
        portion_expansion = 1
    }
    if special_opts[status] then
        local val = Always_status_calc_special_opt(pc, status)
        return tostring(val)
    end
    if status == "STR" or status == "INT" or status == "CON" or status == "MNA" or status == "DEX" then
        local total_value = pc[status] + session.GetUserConfig(status .. "_UP")
        return tostring(total_value)
    end
    if status == "gear_score" then
        return tostring(GET_PLAYER_GEAR_SCORE(pc))
    end
    if status == "ability_point_score" then
        return tostring(GET_PLAYER_ABILITY_SCORE(pc)) .. "%"
    end
    if status == "PATK" or status == "MATK" then
        local min = pc["MIN" .. status]
        local max = pc["MAX" .. status]
        if GetExProp(pc, 'event_atk') > 0 then
            local event_atk = GetExProp(pc, 'event_atk')
            min = event_atk
            max = event_atk
        end
        return string.format("%d~%d", min, max)
    end
    if status == "HEAL_PWR" then
        return tostring(GET_SHOW_HEAL_PWR(pc, pc.HEAL_PWR))
    end
    if status == "CastingSpeed" then
        local val = TryGetProp(pc, status, 0)
        return tostring(val) .. "%"
    end
    local value = TryGetProp(pc, status, 0)
    value = Always_status_calc_all_atk_status(pc, status, value)
    return tostring(value)
end

function Always_status_frame_init()
    local function _logic()
        local always_status = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "always_status", 0, 0, 70, 30)
        AUTO_CAST(always_status)
        local base = g.always_status_settings["base"]
        always_status:RemoveAllChild()
        always_status:EnableHittestFrame(base.enable)
        always_status:EnableMove(base.enable)
        always_status:SetGravity(ui.RIGHT, ui.TOP)
        local rect = always_status:GetMargin()
        always_status:SetMargin(rect.left - rect.left, rect.top - rect.top + 500,
            rect.right == 0 and rect.right + 400 or rect.right, rect.bottom)
        always_status:SetTitleBarSkin("None")
        always_status:SetSkinName("None")
        always_status:SetLayerLevel(11)
        always_status:SetEventScript(ui.LBUTTONUP, "Always_status_frame_move")
        always_status:SetEventScript(ui.RBUTTONDOWN, "Always_status_info_setting")
        local as_text = always_status:CreateOrGetControl("richtext", "as_text", 20, 5)
        AUTO_CAST(as_text)
        as_text:SetText("{ol}{S10}Always Status")
        as_text:SetEventScript(ui.RBUTTONDOWN, "Always_status_info_setting")
        local tooltip = g.lang == "Japanese" and "{ol}右クリックで表示設定" or
                            "{ol}Right-click to set display"
        as_text:SetTextTooltip(tooltip)
        local char = g.always_status_settings["chars"][g.cid]
        tooltip = g.lang == "Japanese" and "{ol}キャラクター毎に表示非表示を切り替えます" or
                      "{ol}Display and hide for each character"
        if char.on ~= 1 then
            local plus_pic = always_status:CreateOrGetControl("picture", "plus_pic", 0, 3, 15, 15)
            AUTO_CAST(plus_pic)
            plus_pic:SetEventScript(ui.LBUTTONUP, "Always_status_frame_toggle")
            plus_pic:SetImage("btn_plus")
            plus_pic:SetTextTooltip(tooltip)
            plus_pic:SetEnableStretch(1)
            always_status:Resize(150, 20)
            always_status:ShowWindow(1)
            return
        else
            local minus_pic = always_status:CreateOrGetControl("picture", "minus_pic", 0, 3, 15, 15)
            AUTO_CAST(minus_pic)
            minus_pic:SetEventScript(ui.LBUTTONUP, "Always_status_frame_toggle")
            minus_pic:SetImage("btn_minus")
            minus_pic:SetTextTooltip(tooltip)
            minus_pic:SetEnableStretch(1)
            local y = 20
            local pc = GetMyPCObject()
            local use_set_str = tostring(char.use_set)
            for _, data in ipairs(always_status_master_list) do
                local status = data.key
                local display = g.always_status_settings[use_set_str]
                if display and display[status] == 1 then
                    local color = g.always_status_settings["base"]["color"][status]
                    local title = always_status:CreateOrGetControl("richtext", "title" .. status, 10, y)
                    AUTO_CAST(title)
                    local stat = always_status:CreateOrGetControl("richtext", "stat" .. status, 165, y)
                    AUTO_CAST(stat)
                    local title_text = ""
                    local abbr_text = g.always_status_settings.base.abbr and g.always_status_settings.base.abbr[status]
                    if abbr_text and abbr_text ~= "" and abbr_text ~= status then
                        title_text = abbr_text
                    else
                        local message_id = ""
                        if status == "gear_score" then
                            message_id = "EquipedItemGearScore"
                            title_text = ScpArgMsg(message_id)
                        elseif status == "ability_point_score" then
                            message_id = "AbilityPointScore"
                            title_text = ScpArgMsg(message_id)
                        elseif status == "STR" or status == "INT" or status == "CON" or status == "MNA" or status ==
                            "DEX" then
                            title_text = ClMsg(status)
                        else
                            message_id = status
                            title_text = ScpArgMsg(message_id)
                        end
                        local match_result = string.match(title_text, "!@#%$([^#]+)")
                        if match_result then
                            title_text = dic.getTranslatedStr(ClMsg(match_result))
                        end
                        if g.lang == "Japanese" and data.jp then
                            title_text = data.jp
                        end
                    end
                    title:SetText("{ol}{s16}" .. color .. title_text)
                    local text = Always_status_get_status_text(pc, status)
                    if string.find(text, "~") == nil and string.find(text, "%%") == nil then
                        local pure_number_str = text:gsub("[^0-9]", "")
                        if #pure_number_str > 0 then
                            text = pure_number_str
                        else
                            text = "0"
                        end
                    end
                    stat:SetText(color .. "{ol}{s16}: " .. text)
                    if g.lang == "Japanese" then
                        stat:SetPos(125, y)
                    end
                    title:AdjustFontSizeByWidth(150)
                    if g.lang ~= "Japanese" then
                        stat:AdjustFontSizeByWidth(135)
                    end
                    y = y + 20
                end
            end
            if g.lang == "Japanese" then
                always_status:Resize(260, y + 10)
            else
                always_status:Resize(310, y + 10)
            end
            always_status:ShowWindow(1)
            always_status:RunUpdateScript("Always_status_update", 0.1)
        end
    end
    local result, err = pcall(_logic)
    if not result then
        local always_status = ui.GetFrame(addon_name_lower .. "always_status")
        always_status:RunUpdateScript("Always_status_frame_init", 0.5)
    end
end

function Always_status_update(always_status)
    local pc = GetMyPCObject()
    if pc == nil then
        return 1
    end
    for _, data in ipairs(always_status_master_list) do
        local status = data.key
        local always_status_stat = GET_CHILD_RECURSIVELY(always_status, "stat" .. status)
        if always_status_stat then
            local text = Always_status_get_status_text(pc, status)
            if string.find(text, "~") == nil and string.find(text, "%%") == nil then
                local pure_number_str = text:gsub("[^0-9]", "")
                if #pure_number_str > 0 then
                    text = pure_number_str
                else
                    text = "0"
                end
            end
            local color = g.always_status_settings["base"]["color"][status]
            always_status_stat:SetText(color .. "{ol}{s16}: " .. text)
        end
    end
    local base = g.always_status_settings["base"]
    if base.frame_X ~= 0 and base.frame_Y ~= 0 then
        always_status:SetPos(base.frame_X, base.frame_Y)
    end
    return 1
end

function Always_status_frame_move(always_status)
    g.always_status_settings["base"].frame_X = always_status:GetX()
    g.always_status_settings["base"].frame_Y = always_status:GetY()
    Always_status_save_settings()
end

function Always_status_info_setting()
    local settings_frame = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "always_status_settings", 0, 0, 70, 30)
    AUTO_CAST(settings_frame)
    settings_frame:EnableHittestFrame(1)
    settings_frame:EnableHitTest(1)
    settings_frame:Resize(555, 900)
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    if list_frame then
        settings_frame:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    else
        settings_frame:SetPos(1220, 100)
    end
    settings_frame:SetLayerLevel(999)
    settings_frame:RemoveAllChild()
    local gb = settings_frame:CreateOrGetControl("groupbox", "gb", 10, 10, settings_frame:GetWidth() - 10,
        settings_frame:GetHeight() - 10)
    AUTO_CAST(gb)
    gb:SetSkinName("test_frame_low")
    local title = gb:CreateOrGetControl("richtext", "title", 30, 40)
    AUTO_CAST(title)
    local text = g.lang == "Japanese" and "{ol}表示設定" or "{ol}Display Setting"
    title:SetText("{s18}{ol}{#FFFFFF}" .. text)
    local close = gb:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Always_status_frame_close")
    local drop_list = gb:CreateOrGetControl('droplist', 'setting_DropList', 100, 10, 200, 20)
    AUTO_CAST(drop_list)
    drop_list:SetSkinName('droplist_normal')
    drop_list:EnableHitTest(1)
    drop_list:SetTextAlign("center", "center")
    for i = 1, 10 do
        local display = g.always_status_settings[tostring(i)]
        local scp = "Always_status_info_setting_load(" .. i .. ")"
        if display.memo == "free memo " .. i then
            drop_list:AddItem(i - 1, tostring("Data ") .. i, 0, scp)
        else
            drop_list:AddItem(i - 1, display.memo, 0, scp)
        end
    end
    local use_set = tonumber(g.always_status_settings["chars"][g.cid].use_set)
    drop_list:SelectItem(use_set - 1)
    local base_pos = gb:CreateOrGetControl('button', 'base_pos', 350, 5, 120, 30)
    AUTO_CAST(base_pos)
    base_pos:SetText(g.lang == "Japanese" and "{ol}フレーム初期位置" or "{ol}Init frame pos")
    base_pos:SetEventScript(ui.LBUTTONUP, "Always_status_init_pos")
    local reset_abbr_btn = gb:CreateOrGetControl('button', 'reset_abbr_btn', 350, 35, 120, 30)
    AUTO_CAST(reset_abbr_btn)
    reset_abbr_btn:SetText(g.lang == "Japanese" and "{ol}表示名リセット" or "{ol}Reset Names")
    reset_abbr_btn:SetEventScript(ui.LBUTTONUP, "Always_status_reset_all_abbr")
    reset_abbr_btn:SetTextTooltip(g.lang == "Japanese" and
                                      "{ol}全ての項目の表示名カスタマイズを初期化します" or
                                      "{ol}Reset all custom display names")
    local memo = gb:CreateOrGetControl('edit', 'memo', 215, 35, 130, 30) -- 幅を少し調整
    AUTO_CAST(memo)
    memo:SetEventScript(ui.ENTERKEY, "Always_status_memo_save")
    memo:SetEventScriptArgNumber(ui.ENTERKEY, use_set)
    memo:SetFontName("white_16_ol")
    memo:SetTextAlign("center", "center")
    local enable_check = gb:CreateOrGetControl("checkbox", "enablecheck", 510, 40, 20, 20)
    AUTO_CAST(enable_check)
    enable_check:SetEventScript(ui.LBUTTONUP, "Always_status_checkbox")
    text = g.lang == "Japanese" and "{ol}チェックするとフレームが固定されます" or
               "{ol}If checked, the frame is fixed"
    enable_check:SetTextTooltip(text)
    local base = g.always_status_settings["base"]
    if base.enable == 0 then
        enable_check:SetCheck(1)
    else
        enable_check:SetCheck(0)
    end
    settings_frame:ShowWindow(1)
    Always_status_info_setting_load(use_set)
end

function Always_status_init_pos()
    g.always_status_settings["base"].frame_X = 0
    g.always_status_settings["base"].frame_Y = 0
    Always_status_save_settings()
    ui.DestroyFrame(addon_name_lower .. "always_status")
    ReserveScript("Always_status_frame_init()", 0.1)
end

function Always_status_info_setting_load(use_set)
    local settings_frame = ui.GetFrame(addon_name_lower .. "always_status_settings")
    local gb = GET_CHILD_RECURSIVELY(settings_frame, "gb")
    AUTO_CAST(gb)
    local old_setting_gb = GET_CHILD(gb, "setting_gb")
    if old_setting_gb then
        gb:RemoveChild("setting_gb")
    end
    local setting_gb = gb:CreateOrGetControl("groupbox", "setting_gb", 10, 70, gb:GetWidth() - 20, gb:GetHeight() - 80)
    AUTO_CAST(setting_gb)
    setting_gb:SetSkinName("test_frame_midle_light")
    local display = g.always_status_settings[tostring(use_set)]
    local memo = GET_CHILD_RECURSIVELY(settings_frame, "memo")
    if memo then
        AUTO_CAST(memo)
        memo:SetText(display.memo)
        memo:SetEventScriptArgNumber(ui.ENTERKEY, use_set) -- メモ保存先のセット番号も更新
    end
    settings_frame:SetLayerLevel(999)
    local y = 10
    for _, data in ipairs(always_status_master_list) do
        local status = data.key
        local check = setting_gb:CreateOrGetControl("checkbox", "check" .. status, 475, y, 20, 20)
        AUTO_CAST(check)
        check:SetEventScript(ui.LBUTTONUP, "Always_status_checkbox")
        check:SetEventScriptArgString(ui.LBUTTONUP, status)
        check:SetEventScriptArgNumber(ui.LBUTTONUP, use_set)
        check:SetCheck(display[status])
        local color_box = setting_gb:CreateOrGetControl('groupbox', "colorbox" .. status, 250, y, 220, 20)
        AUTO_CAST(color_box)
        local color_table = {"FFFFFF", "FF6600", "FF4040", '66B3FF', "00FFFF", '00FF00', 'FF0000', 'FF00FF', "A566FF",
                             'FFFF00', "ADFF2F"}
        for j = 1, 11 do
            local color_str = color_table[j]
            local color_pic = color_box:CreateOrGetControl("picture", "color" .. j, 20 * (j - 1), 0, 20, 20)
            AUTO_CAST(color_pic)
            color_pic:SetImage("chat_color")
            color_pic:SetColorTone("FF" .. color_str)
            color_pic:SetEventScript(ui.LBUTTONUP, "Always_status_color_select")
            color_pic:SetEventScriptArgString(ui.LBUTTONUP, color_str)
        end
        local control = setting_gb:CreateOrGetControl("richtext", status, 20, y)
        AUTO_CAST(control)
        control:SetEventScript(ui.LBUTTONUP, "Always_status_open_abbr_input")
        control:SetEventScriptArgString(ui.LBUTTONUP, status)
        control:SetTextTooltip(g.lang == "Japanese" and "{ol}左クリックで表示名変更" or "{ol}L-Click: rename")
        local color = g.always_status_settings["base"]["color"][status]
        local display_text = ""
        local saved_abbr = g.always_status_settings.base.abbr and g.always_status_settings.base.abbr[status]
        if saved_abbr and saved_abbr ~= "" and saved_abbr ~= status then
            display_text = saved_abbr
        else
            if status == "STR" or status == "INT" or status == "CON" or status == "MNA" or status == "DEX" then
                display_text = ClMsg(status)
            elseif status == "gear_score" then
                display_text = ScpArgMsg("EquipedItemGearScore")
            elseif status == "ability_point_score" then
                display_text = ScpArgMsg("AbilityPointScore")
            else
                display_text = ScpArgMsg(status)
            end
        end
        control:SetText(color .. "{s16}{ol}" .. display_text)
        control:AdjustFontSizeByWidth(250)
        y = y + 25
    end
    g.always_status_settings["chars"][g.cid].use_set = use_set
    Always_status_save_settings()
    Always_status_frame_init()
end

function Always_status_reset_all_abbr(frame, ctrl)
    local yes_scp = "Always_status_reset_all_abbr_exec()"
    local msg = g.lang == "Japanese" and "全ての表示名を初期化しますか？" or "Reset all display names?"
    ui.MsgBox(msg, yes_scp, "None")
end

function Always_status_reset_all_abbr_exec()
    g.always_status_settings.base.abbr = {}
    Always_status_save_settings()
    local use_set = g.always_status_settings["chars"][g.cid].use_set
    Always_status_info_setting_load(use_set)
    ui.SysMsg(g.lang == "Japanese" and "表示名をリセットしました" or "Display names reset")
end

function Always_status_open_abbr_input(frame, ctrl, status, num)
    local settings_frame = ui.GetFrame(addon_name_lower .. "always_status_settings")
    settings_frame:SetUserValue("TARGET_STATUS", status)
    settings_frame:SetLayerLevel(97)
    local current_abbr = g.always_status_settings.base.abbr[status] or ""
    Always_status_INPUT_STRING_BOX(frame, ctrl, current_abbr, num)
    -- INPUT_STRING_BOX(title, "Always_status_save_abbr", current_abbr, 0, 0)
end

function Always_status_INPUT_STRING_BOX(frame, ctrl, current_abbr, num)
    local inputstring = ui.GetFrame("inputstring")
    inputstring:Resize(500, 220)
    inputstring:SetLayerLevel(999)
    local edit = GET_CHILD(inputstring, 'input', "ui::CEditControl")
    edit:SetNumberMode(0)
    edit:SetMaxLen(999)
    edit:SetText("")
    inputstring:ShowWindow(1)
    inputstring:SetEnable(1)
    local title = inputstring:GetChild("title")
    AUTO_CAST(title)
    local text = g.lang == "Japanese" and "{ol}{#FFFFFF}表示名を入力してください" or
                     "{ol}{#FFFFFF}Enter display name"
    title:SetText(text)
    local confirm = inputstring:GetChild("confirm")
    confirm:SetEventScript(ui.LBUTTONUP, "Always_status_save_abbr")
    -- confirm:SetEventScriptArgString(ui.LBUTTONUP, ctrl_name)
    edit:SetEventScript(ui.ENTERKEY, "Always_status_save_abbr")
    -- edit:SetEventScriptArgString(ui.ENTERKEY, ctrl_name)
    edit:AcquireFocus()
end

function Always_status_save_abbr(frame, ctrl)
    if frame:GetName() == "inputstring" then
        local input_text = GET_INPUT_STRING_TXT(frame)
        local settings_frame = ui.GetFrame(addon_name_lower .. "always_status_settings")
        local status = settings_frame:GetUserValue("TARGET_STATUS")
        if status and status ~= "None" then
            if not g.always_status_settings.base.abbr then
                g.always_status_settings.base.abbr = {}
            end
            g.always_status_settings.base.abbr[status] = input_text
            Always_status_save_settings()
            local use_set = g.always_status_settings["chars"][g.cid].use_set
            Always_status_info_setting_load(use_set)
            frame:ShowWindow(0)
        end
    end
end

function Always_status_frame_toggle(frame, ctrl)
    if g.always_status_settings["chars"][g.cid].on == 1 then
        g.always_status_settings["chars"][g.cid].on = 0
    else
        g.always_status_settings["chars"][g.cid].on = 1
    end
    Always_status_save_settings()
    Always_status_frame_init()
end

function Always_status_frame_close()
    local settings_frame = ui.GetFrame(addon_name_lower .. "always_status_settings")
    if settings_frame then
        ui.DestroyFrame(settings_frame:GetName())
    end
end

function Always_status_memo_save(frame, ctrl, str, use_set)
    local text = ctrl:GetText()
    g.always_status_settings[tostring(use_set)].memo = text
    ui.SysMsg(g.lang == "Japanese" and "タイトルを変更しました" or "The title has been changed")
    Always_status_save_settings()
    Always_status_info_setting()
end

function Always_status_checkbox(frame, ctrl, status, use_set)
    local is_check = ctrl:IsChecked()
    local name = ctrl:GetName()
    if name == "enablecheck" then
        local always_status = ui.GetFrame(addon_name_lower .. "always_status")
        if is_check == 1 then
            g.always_status_settings["base"].enable = 0
            always_status:EnableMove(0)
        else
            g.always_status_settings["base"].enable = 1
            always_status:EnableMove(1)
        end
    else
        g.always_status_settings[tostring(use_set)][status] = is_check
    end
    Always_status_save_settings()
    Always_status_frame_init()
    -- always_status_info_setting_load(use_set)
end

function Always_status_color_select(parent, ctrl, color_str, num)
    local status_name = string.gsub(parent:GetName(), "colorbox", "")
    g.always_status_settings["base"]["color"][status_name] = "{#" .. color_str .. "}"
    Always_status_save_settings()
    Always_status_info_setting()
    Always_status_frame_init()
end
-- always_status ここまで

-- indun_panel ここから
local induns = {{
    challenge = {
        solo_520 = 1001,
        solo_540 = 1004,
        pt_540 = 1005,
        jp = "チャレンジ",
        icon = {"Item", 490363}
    }
}, {
    singularity = {
        singularity_520 = 2000,
        singularity_540 = 2001,
        jp = "分裂特異点",
        icon = {"Item", 11030017}
    }
}, {
    zmei = {
        h = 731,
        s = 730,
        a = 729,
        ac = 80047,
        jp = "Zmei",
        icon = {"Monster", 71076}
    }
}, {
    belliora = {
        h = 727,
        s = 726,
        a = 725,
        ac = 80045,
        jp = "ベリオラ",
        icon = {"Monster", 71043}
    }
}, {
    laimara = {
        h = 724,
        s = 723,
        a = 722,
        ac = 80043,
        jp = "ライマラ",
        icon = {"Monster", 71040}
    }
}, {
    ledania = {
        h = 718,
        s = 717,
        a = 716,
        ac = 80039,
        jp = "レダニア",
        icon = {"Monster", 59864}
    }
}, {
    neringa = {
        h = 709,
        s = 708,
        a = 707,
        ac = 80035,
        jp = "ネリンガ",
        icon = {"Monster", 59856}
    }
}, {
    golem = {
        h = 712,
        s = 711,
        a = 710,
        ac = 80037,
        jp = "ゴーレム",
        icon = {"Monster", 59859}
    }
}, {
    merregina = {
        s = 696,
        a = 695,
        h = 697,
        ac = 80032,
        jp = "メレジナ",
        icon = {"Monster", 59824}
    }
}, {
    slogutis = {
        s = 689,
        a = 688,
        h = 690,
        ac = 80031,
        jp = "スローガティス",
        icon = {"Monster", 59798}
    }
}, {
    upinis = {
        s = 686,
        a = 685,
        h = 687,
        ac = 80030,
        jp = "ウピニス",
        icon = {"Monster", 59795}
    }
}, {
    roze = {
        s = 680,
        a = 679,
        h = 681,
        ac = 80015,
        jp = "ロゼ",
        icon = {"Monster", 59773}
    }
}, {
    falouros = {
        s = 677,
        a = 676,
        h = 678,
        ac = 80017,
        jp = "ファロウロス",
        icon = {"Monster", 59760}
    }
}, {
    reservoir = {
        s = 674,
        a = 673,
        h = 675,
        ac = 80016,
        jp = "プロパゲーター",
        icon = {"Monster", 59752}
    }
}, {
    jellyzele = {
        s = 672,
        a = 671,
        h = 670,
        jp = "ジェリージェル",
        icon = {"Monster", 59730}
    }
}, {
    delmore = {
        s = 667,
        a = 666,
        h = 665,
        jp = "デルムーア",
        icon = {"Monster", 59690}
    }
}, {
    giltine = {
        s = 669,
        a = 635,
        h = 628,
        jp = "ギルティネ",
        icon = {"Monster", 59549}
    }
}, {
    memory = {
        s = 661,
        a = 662,
        h = 663,
        jp = "焔の記憶",
        icon = {"Item", 11100001}
    }
}, {
    telharsha = {
        id = 623,
        jp = "テルハルシャ",
        icon = {"Monster", 59477}
    }
}, {
    bernice = {
        id = 201,
        jp = "ヴェルニケ",
        icon = {"Item", 11030257}
    }
}, {
    wailing = {
        id = 684,
        jp = "嘆きの墓地",
        icon = {"Item", 960213}
    }
}, {
    ashaq = {
        id = 728,
        jp = "アシャーク",
        icon = {"Item", 11200484}
    }
}, {
    jsr = {
        id = 0,
        jp = "ボス協同戦",
        icon = {}
    }
}}

function Indun_panel_save_settings()
    g.save_json(g.indun_panel_path, g.indun_panel_settings)
end

function Indun_panel_load_settings()
    g.indun_panel_path = string.format("../addons/%s/%s/indun_panel.json", addon_name_lower, g.active_id)
    g.indun_panel_old_path = string.format("../addons/%s/%s/settings.json", "indun_panel", g.active_id)
    local settings = g.load_json(g.indun_panel_path)
    local indun_keys = {"challenge", "singularity", "zmei", "belliora", "laimara", "ledania", "neringa", "golem", "merregina",
                        "slogutis", "upinis", "roze", "falouros", "reservoir", "jellyzele", "delmore", "telharsha",
                        "bernice", "giltine", "memory", "wailing", "ashaq", "jsr"}
    local json_to_indun_map = {
        veliora = "belliora",
        limara = "laimara",
        redania = "ledania",
        spreader = "reservoir",
        velnice = "bernice",
        cemetery = "wailing",
        demonlair = "ashaq",
        earring = "memory"
    }
    if not settings then
        local function create_default_set()
            local set = {}
            for _, name in ipairs(indun_keys) do
                set[name] = 1
            end
            return set
        end
        settings = {
            etc = {
                challenge_ticket = "month",
                always_open = 0,
                singularity_check = 0,
                skin_name = "chat_window_2",
                en_ver = 0,
                x = 665,
                y = 30,
                move = 0,
                use_set = "set_a",
                challenge_map = 0,
                base_date = "",
                shading = 0,
                field_mode = 0,
                toscoin = 0
            },
            cols = {
                tos = 1,
                gabija = 1,
                vakarine = 1,
                rada = 1,
                jurate = 1,
                austeja = 1,
                pvp_mine = 1,
                market = 1,
                craft = 1,
                leticia = 1
            },
            set_names = {{
                set_a = "SET A"
            }, {
                set_b = "SET B"
            }, {
                set_c = "SET C"
            }},
            set_a = create_default_set(),
            set_b = create_default_set(),
            set_c = create_default_set()
        }
        local old_settings = g.load_json(g.indun_panel_old_path)
        if old_settings then
            for k, v in pairs(old_settings) do
                if type(v) == "table" then
                    if k == "set_a" or k == "set_b" or k == "set_c" then
                        for k2, v2 in pairs(v) do
                            if string.find(k2, "_checkbox") then
                                local json_key = string.gsub(k2, "_checkbox", "")
                                local correct_key = json_to_indun_map[json_key] or json_key
                                if settings[k] and settings[k][correct_key] ~= nil then
                                    settings[k][correct_key] = v2
                                end
                            end
                        end
                    elseif k == "cols" then
                        settings.cols = v
                    end
                else
                    if k ~= "auto_challenge" then
                        if k == "checkbox" then
                            settings.etc.always_open = v
                        elseif settings.etc[k] ~= nil then
                            settings.etc[k] = v
                        end
                    end
                end
            end
        end
    end
    if settings.set_names then
        for _, item in ipairs(settings.set_names) do
            for set_key, _ in pairs(item) do
                if settings[set_key] and type(settings[set_key]) == "table" then
                    for _, name in ipairs(indun_keys) do
                        if settings[set_key][name] == nil then
                            settings[set_key][name] = 1
                        end
                    end
                end
            end
        end
    end
    g.indun_panel_settings = settings
    Indun_panel_save_settings()
end

function indun_panel_on_init()
    if not g.indun_panel_settings then
        local earthtowershop = ui.GetFrame('earthtowershop')
        earthtowershop:Resize(0, 0)
        pc.ReqExecuteTx_NumArgs("SCR_PVP_MINE_SHOP_OPEN", 0)
        earthtowershop:RunUpdateScript("Indun_panel_earthtowershop_close", 0.1)
        Indun_panel_load_settings()
        Indun_panel_frame_init()
    end
    g.setup_hook_and_event(g.addon, "CHAT_SYSTEM", "Indun_panel_CHAT_SYSTEM", true)
    g.addon:RegisterMsg("ESCAPE_PRESSED", "Indun_panel_frame_init")
    if g.settings.indun_panel.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "indun_panel")
        ui.DestroyFrame(addon_name_lower .. "indun_panel_map")
        return
    end
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    if not indun_panel then
        Indun_panel_frame_init()
    end
    g.setup_hook_and_event(g.addon, "INDUN_ALREADY_PLAYING", "Indun_panel_INDUN_ALREADY_PLAYING", false)
end

function Indun_panel_earthtowershop_close(earthtowershop)
    if earthtowershop:IsVisible() == 1 then
        earthtowershop:Resize(580, 1920)
        ui.CloseFrame("earthtowershop")
        return 1
    else
        return 0
    end
end

function Indun_panel_CHAT_SYSTEM(my_frame, my_msg)
    local msg, color = g.get_event_args(my_msg)
    if msg then
        local pattern = "EVENT_TOS_WHOLE_GET_SUCCESS_MSG"
        if string.find(msg, pattern) then
            local daily_value_str = msg:match("%$%*%$DAILY%$%*%$(%d+)%$%*%$")
            g.indun_panel_settings.etc.toscoin = tonumber(daily_value_str)
            Indun_panel_save_settings()
        end
    end
end

function Indun_panel_INDUN_ALREADY_PLAYING(my_frame, my_msg)
    if g.settings.indun_panel.use == 0 then
        g.FUNCS["INDUN_ALREADY_PLAYING"]()
        return
    end
    ReserveScript("Indun_panel_INDUN_ALREADY_PLAYING_dilay()", 0.3)
end

function Indun_panel_INDUN_ALREADY_PLAYING_dilay()
    local indunenter = ui.GetFrame("indunenter")
    local indun_type = indunenter:GetUserIValue('INDUN_TYPE')
    if indun_type == 1005 or indun_type == 2000 or indun_type == 2001 then -- 1005＝540チャレPT 2001＝540分裂
        AnsGiveUpPrevPlayingIndun(1)
        ui.CloseFrame("indunenter")
        ReserveScript(string.format("Indun_panel_enter_singularity(nil,nil,'', %d)", indun_type), 0.5)
        return
    else
        local yes_scp = string.format("AnsGiveUpPrevPlayingIndun(%d)", 1)
        local no_scp = string.format("AnsGiveUpPrevPlayingIndun(%d)", 0)
        ui.MsgBox(ClMsg("IndunAlreadyPlaying_AreYouGiveUp"), yes_scp, no_scp)
    end
end

function Indun_panel_challenge(_nexus_addons)
    if not g.indun_panel_challenge_start_time then
        _nexus_addons:StopUpdateScript("Indun_panel_challenge")
        return 0
    end
    local now = imcTime.GetAppTimeMS()
    if (now - g.indun_panel_challenge_start_time) >= 3000 then
        _nexus_addons:StopUpdateScript("indun_panel_challenge")
        g.indun_panel_challenge_start_time = nil
        return 0
    end
    local is_auto_challenge_map = session.IsAutoChallengeMap()
    local is_solo_challenge_map = session.IsSoloChallengeMap()
    if is_auto_challenge_map == true or is_solo_challenge_map == true then
        ui.DestroyFrame(addon_name_lower .. "indun_panel")
        _nexus_addons:StopUpdateScript("Indun_panel_challenge")
        g.indun_panel_challenge_start_time = nil
        if g.indun_panel_settings.etc.base_date ~= "" then
            return 0
        end
        local cnt = 0
        local found_clsid = nil
        local challenge_map_list, count = GetClassList('challenge_mode_auto_map')
        for i = 0, count - 1 do
            local map_cls = GetClassByIndexFromList(challenge_map_list, i)
            if map_cls then
                local map_name = map_cls.MapName
                if g.map_name == map_name then
                    cnt = cnt + 1
                    if found_clsid == nil then
                        found_clsid = map_cls.ClassID
                    end
                end
            end
        end
        if cnt == 1 and found_clsid then
            g.indun_panel_settings.etc.challenge_map = found_clsid
            local server_time_str = date_time.get_lua_now_datetime_str()
            if server_time_str then
                local y, m, d, H, M, S = server_time_str:match("(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)")
                if y then
                    local time_table = {
                        year = tonumber(y),
                        month = tonumber(m),
                        day = tonumber(d),
                        hour = 12,
                        min = 0,
                        sec = 0
                    }
                    g.indun_panel_settings.etc.base_date = os.time(time_table)
                    Indun_panel_save_settings()
                end
            end
        end
        return 0
    end
    return 1
end

-- test_code
--[[local challenge_map_list, count = GetClassList('challenge_mode_auto_map')
for i = 0, count - 1 do
    local map_cls = GetClassByIndexFromList(challenge_map_list, i)
    if map_cls then
        local map_name = map_cls.Name
        local map_clsname = map_cls.MapName
        local map_cls_ = GetClass("Map", map_clsname)
        local map_level = map_cls_.QuestLevel
        ts(i, dic.getTranslatedStr(map_name), map_level)
    end
end]]

local function indun_panel_get_server_elapsed_days(base_date)
    if not base_date or base_date == "" or base_date == 0 then
        return 0
    end
    local server_time_str = date_time.get_lua_now_datetime_str()
    if not server_time_str then
        return 0
    end
    local y, m, d = server_time_str:match("(%d+)-(%d+)-(%d+)")
    if not y then
        return 0
    end
    local server_now = os.time({
        year = tonumber(y),
        month = tonumber(m),
        day = tonumber(d),
        hour = 12
    })
    local base_tbl = os.date("*t", base_date)
    base_tbl.hour = 12
    local server_base = os.time(base_tbl)
    return math.floor((server_now - server_base) / 86400)
end

function Indun_panel_challenge_map_context(indun_panel, ctrl)
    local base_date = g.indun_panel_settings.etc.base_date
    if not base_date or base_date == "" or base_date == 0 then
        return
    end
    local weekdays = {"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"}
    local elapsed_days = indun_panel_get_server_elapsed_days(base_date)
    local context = ui.CreateContextMenu("challenge_map_schedule", "{ol}Challenge Map Schedule", 0, 100, 0, 0)
    local challenge_map_list, count = GetClassList('challenge_mode_auto_map')
    local start_index = g.indun_panel_settings.etc.challenge_map
    for i = 0, 6 do
        local map_index = (start_index + elapsed_days + i) % count
        local map_cls = GetClassByIndexFromList(challenge_map_list, map_index)
        if map_cls then
            local map_name = map_cls.Name
            local map_clsname = map_cls.MapName
            local server_time_str = date_time.get_lua_now_datetime_str()
            local y, m, d = server_time_str:match("(%d+)-(%d+)-(%d+)")
            local base_time = os.time({
                year = tonumber(y),
                month = tonumber(m),
                day = tonumber(d),
                hour = 12
            })
            local display_time = base_time + (i * 86400)
            local month_day = os.date("%m-%d", display_time)
            local day_of_week_num = tonumber(os.date("%w", display_time))
            local day_of_week_str = weekdays[day_of_week_num + 1]
            local date_str = string.format("%s (%s)", month_day, day_of_week_str)
            local scp = string.format("Indun_panel_challenge_map_display('%s','%s')", map_clsname, date_str)
            ui.AddContextMenuItem(context, date_str .. " " .. map_name, scp)
        end
    end
    ui.OpenContextMenu(context)
end

function Indun_panel_challenge_map_display(map_clsname, date_str)
    local indun_panel_map = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "indun_panel_map", 0, 0, 0, 0)
    AUTO_CAST(indun_panel_map)
    indun_panel_map:RemoveAllChild()
    indun_panel_map:SetSkinName("bg")
    indun_panel_map:SetLayerLevel(100)
    indun_panel_map:Resize(300, 320)
    local gb = indun_panel_map:CreateOrGetControl("picture", "gb", 0, 20, indun_panel_map:GetWidth(),
        indun_panel_map:GetHeight() - 20)
    AUTO_CAST(gb)
    gb:Resize(300, 300)
    gb:EnableHitTest(0)
    local close = indun_panel_map:CreateOrGetControl('button', 'close', 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_map_close")
    local map_width = gb:GetWidth()
    local map_height = gb:GetHeight()
    local map_cls = GetClass("Map", map_clsname)
    if not map_cls then
        return
    end
    local map_title = indun_panel_map:CreateOrGetControl("richtext", "map_title", 0, 0)
    map_title:SetGravity(ui.LEFT, ui.TOP)
    map_title:SetText("{ol}" .. map_cls.Name .. " " .. date_str)
    local pic = gb:CreateOrGetControl('picture', "picture_" .. map_clsname, ui.CENTER_HORZ, ui.CENTER_VERT, map_width,
        map_height)
    AUTO_CAST(pic)
    pic:SetEnableStretch(1)
    local is_valid = ui.IsImageExist(map_clsname .. "_fog")
    if is_valid == false then
        world.PreloadMinimap(map_clsname)
    end
    pic:SetImage(map_clsname .. "_fog")
    local icon_group = gb:CreateOrGetControl("picture", "icon_group", ui.CENTER_HORZ, ui.CENTER_VERT, gb:GetWidth(),
        gb:GetHeight())
    AUTO_CAST(icon_group)
    icon_group:SetSkinName("None")
    local name_group = gb:CreateOrGetControl("picture", "name_group", ui.CENTER_HORZ, ui.CENTER_VERT, gb:GetWidth(),
        gb:GetHeight())
    AUTO_CAST(name_group)
    name_group:SetSkinName("None")
    UPDATE_MAP_BY_NAME(icon_group, map_clsname, pic, map_width, map_height, 0, 0)
    MAKE_MAP_AREA_INFO(name_group, map_clsname, "{s15}", map_width, map_height, -100, -30)
    local map_frame = ui.GetFrame("map")
    local width = map_frame:GetWidth()
    local height = map_frame:GetHeight()
    indun_panel_map:SetPos(width / 2 - 620, height / 2 - 300)
    indun_panel_map:ShowWindow(1)
end

function Indun_panel_challenge_map_close(frame)
    ui.DestroyFrame(frame:GetName())
end

function Indun_panel_frame_init(is_toggle, msg)
    if msg == "ESCAPE_PRESSED" then
        if g.indun_panel_settings.etc.always_open == 1 then
            return
        end
    end
    if g.get_map_type() ~= "City" then
        if g.get_map_type() == "Instance" or g.map_id == 8022 then
            return
        end
        if g.indun_panel_settings.etc.field_mode ~= 1 then
            ui.DestroyFrame(addon_name_lower .. "indun_panel")
            return
        end
    end
    --[[if g.get_map_type() ~= "City" and
        (g.indun_panel_settings.etc.field_mode ~= 1 and g.get_map_type() == "Instance" and g.map_id == 8022) then
        return
    end]]
    Indun_list_viewer_save_current_char_counts()
    ui.DestroyFrame(addon_name_lower .. "indun_panel_map")
    local indun_panel = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "indun_panel", 0, 0, 0, 0)
    AUTO_CAST(indun_panel)
    indun_panel:SetSkinName('None')
    indun_panel:SetLayerLevel(30)
    indun_panel:RemoveAllChild()
    Indun_panel_setup_frame(indun_panel)
    local btn = indun_panel:CreateOrGetControl("button", "btn", 5, 5, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}{s10}INDUNPANEL")
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_toggle")
    btn:SetEventScript(ui.RBUTTONUP, "Indun_panel_always_init")
    btn:SetEventScriptArgString(ui.RBUTTONUP, "OPEN")
    btn:SetTextTooltip(g.lang == "Japanese" and "{ol}右クリック: 常時展開で開く" or
                           "{ol}Right click: Open in Always Expand")
    local x = Indun_panel_create_common_buttons(indun_panel)
    local button_keys = {"tos", "gabija", "vakarine", "rada", "jurate", "austeja", "pvp_mine", "market", "craft",
                         "leticia"}
    for _, key_name in ipairs(button_keys) do
        local value = g.indun_panel_settings.cols[key_name]
        if value == 1 then
            if Indun_panel_create_shortcut_button(indun_panel, key_name, x) then
                x = x + 30
            end
        end
    end
    indun_panel:Resize(x, 40)
    indun_panel:ShowWindow(1)
    if not is_toggle then
        if g.indun_panel_settings.etc.always_open == 1 then
            Indun_panel_frame_open(indun_panel)
        end
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    g.indun_panel_challenge_start_time = imcTime.GetAppTimeMS()
    _nexus_addons:RunUpdateScript("Indun_panel_challenge", 0.1)
    return indun_panel
end

function Indun_panel_setup_frame(indun_panel)
    local map = ui.GetFrame("map")
    local width = map:GetWidth()
    local x = g.indun_panel_settings.etc.x
    if width <= 1920 and x > 1920 then
        x = x / 21 * 16
    end
    indun_panel:SetPos(x, g.indun_panel_settings.etc.y)
    indun_panel:SetTitleBarSkin("None")
    local enable = g.indun_panel_settings.etc.move == 0 and 1 or 0
    indun_panel:EnableMove(enable)
    indun_panel:EnableHittestFrame(enable)
    if g.indun_panel_settings.etc.move == 1 then
        indun_panel:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_drag")
    else
        indun_panel:SetEventScript(ui.LBUTTONUP, "None")
    end
end

function Indun_panel_frame_drag(indun_panel)
    g.indun_panel_settings.etc.x = indun_panel:GetX()
    g.indun_panel_settings.etc.y = indun_panel:GetY()
    Indun_panel_save_settings()
    Indun_panel_frame_init()
end

function Indun_panel_create_common_buttons(indun_panel)
    local ccbtn = indun_panel:CreateOrGetControl('button', 'ccbtn', 85, 5, 30, 30)
    AUTO_CAST(ccbtn)
    ccbtn:SetSkinName("None")
    ccbtn:SetText("{img barrack_button_normal 30 30}")
    local lbtn_action = "APPS_TRY_MOVE_BARRACK"
    local rbtn_action = nil
    local tooltip_parts = {}
    local lbtn_tooltip = nil
    if type(_G["INSTANTCC_APPS_TRY_MOVE_BARRACK"]) == "function" and g.settings.instant_cc.use == 1 then
        lbtn_action = "INSTANTCC_APPS_TRY_MOVE_BARRACK"
        lbtn_tooltip = "[InstantCC] Open"
    end
    if type(_G["indun_list_viewer_title_frame_open"]) == "function" and g.settings.indun_list_viewer.use == 1 then
        lbtn_action = "indun_list_viewer_title_frame_open"
        lbtn_tooltip = "Left-Click: [ILV] Open"
    end
    if lbtn_tooltip then
        table.insert(tooltip_parts, lbtn_tooltip)
    end
    if type(_G["other_character_skill_list_frame_open"]) == "function" and g.settings.other_character_skill_list.use ==
        1 then
        rbtn_action = "other_character_skill_list_frame_open"
        table.insert(tooltip_parts, "Right-Click: [OCSL] Open")
    end
    ccbtn:SetEventScript(ui.LBUTTONUP, lbtn_action)
    if rbtn_action then
        ccbtn:SetEventScript(ui.RBUTTONUP, rbtn_action)
    end
    local default_tooltip = g.lang == "Japanese" and "{ol}バラックに戻ります" or "{ol}Return to Barracks"
    ccbtn:SetTextTooltip(#tooltip_parts > 0 and "{ol}" .. table.concat(tooltip_parts, "{nl}") or default_tooltip)
    return 115 -- 次のボタンを開始するX座標を返す
end

function Indun_panel_create_shortcut_button(indun_panel, key_name, x)
    local account_obj = GetMyAccountObj()
    local coin_count = 0
    local tooltip_msg = ""
    local btn = nil
    if key_name == "tos" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "tos", x + 2, 8, 25, 25)
        btn:SetText("{img icon_item_Tos_Event_Coin 25 25}")
        tooltip_msg = g.lang == "Japanese" and "{ol}TOSイベントショップ" or "{ol}TOS Event Shop"
        btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_event_tos_whole_shop_open")
    elseif key_name == "gabija" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "gabija", x, 7, 29, 29)
        btn:SetText("{img goddess_shop_btn 29 29}")
        coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "GabijaCertificate", "0"))
        tooltip_msg =
            (g.lang == "Japanese" and "{ol}ガビヤショップ{nl}" or "{ol}Gabija Shop{nl}") .. "{#FFFF00}" ..
                coin_count
        btn:SetEventScript(ui.LBUTTONUP, "REQ_GabijaCertificate_SHOP_OPEN")
    elseif key_name == "vakarine" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "vakarine", x, 7, 29, 29)
        btn:SetText("{img goddess2_shop_btn 29 29}")
        coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "VakarineCertificate", "0"))
        tooltip_msg = (g.lang == "Japanese" and "{ol}ヴァカリネショップ{nl}" or "{ol}Vakarine Shop{nl}") ..
                          "{#FFFF00}" .. coin_count
        btn:SetEventScript(ui.LBUTTONUP, "REQ_VakarineCertificate_SHOP_OPEN")
    elseif key_name == "rada" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "rada", x, 8, 29, 29)
        btn:SetText("{img goddess3_shop_btn 29 29}")
        coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "RadaCertificate", "0"))
        tooltip_msg = (g.lang == "Japanese" and "{ol}ラダショップ{nl}" or "{ol}Rada Shop{nl}") .. "{#FFFF00}" ..
                          coin_count
        btn:SetEventScript(ui.LBUTTONUP, "REQ_RadaCertificate_SHOP_OPEN")
    elseif key_name == "jurate" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "jurate", x, 7, 29, 29)
        btn:SetText("{img goddess4_shop_btn 29 29}")
        coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "JurateCertificate", "0"))
        tooltip_msg =
            (g.lang == "Japanese" and "{ol}ユラテショップ{nl}" or "{ol}Jurate Shop{nl}") .. "{#FFFF00}" ..
                coin_count
        btn:SetEventScript(ui.LBUTTONUP, "REQ_JurateCertificate_SHOP_OPEN")
    elseif key_name == "austeja" then
        btn = indun_panel:CreateOrGetControl("button", "austeja", x, 7, 29, 29)
        btn:SetText("{img goddess5_shop_btn 29 29}")
        coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "AustejaCertificate", "0"))
        tooltip_msg = (g.lang == "Japanese" and "{ol}アウステヤショップ{nl}" or "{ol}Austeja Shop{nl}") ..
                          "{#FFFF00}" .. coin_count
        btn:SetEventScript(ui.LBUTTONUP, "REQ_AustejaCertificate_SHOP_OPEN")
    elseif key_name == "pvp_mine" then
        btn = indun_panel:CreateOrGetControl("button", "pvp_mine", x, 7, 29, 29)
        btn:SetText("{img pvpmine_shop_btn_total 29 29}")
        tooltip_msg = g.lang == "Japanese" and "{ol}傭兵団ショップ" or "{ol}Mercenary Shop"
        btn:SetEventScript(ui.LBUTTONUP, "MINIMIZED_PVPMINE_SHOP_BUTTON_CLICK")
    elseif key_name == "market" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "market", x, 6, 29, 29)
        btn:SetText("{img market_shortcut_btn02 29 29}")
        tooltip_msg = g.lang == "Japanese" and "{ol}マーケット" or "{ol}Market"
        btn:SetEventScript(ui.LBUTTONUP, "MINIMIZED_MARKET_BUTTON_CLICK")
    elseif key_name == "craft" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "craft", x, 5, 29, 29)
        btn:SetText("{img icon_fullscreen_menu_equipment_processing 28 28}")
        tooltip_msg = g.lang == "Japanese" and "{ol}装備加工" or "{ol}Equipment Processing"
        btn:SetEventScript(ui.LBUTTONUP, "FULLSCREEN_NAVIGATION_MENU_DEATIL_EQUIPMENT_PROCESSING_NPC")
    elseif key_name == "leticia" and g.get_map_type() == "City" then
        btn = indun_panel:CreateOrGetControl("button", "leticia", x, 5, 29, 29)
        btn:SetText("{img icon_fullscreen_menu_letica 28 28}")
        tooltip_msg = g.lang == "Japanese" and "{ol}レティーシャへ移動" or "{ol}Leticia Move"
        btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_FULLSCREEN_NAVIGATION_MENU_DETAIL_MOVE_NPC")
        btn:SetEventScriptArgNumber(ui.LBUTTONUP, 309)
    end
    if btn then
        AUTO_CAST(btn)
        btn:SetSkinName("None")
        btn:SetTextTooltip(tooltip_msg)
        btn:SetEventScript(ui.LBUTTONDOWN, "Indun_panel_earthtowershop_close_restart")
        return true -- ボタンが作成された
    end
    return false -- ボタンが作成されなかった
end

function Indun_panel_event_tos_whole_shop_open()
    local earthtowershop = ui.GetFrame("earthtowershop")
    earthtowershop:SetUserValue("SHOP_TYPE", 'EVENT_TOS_WHOLE_SHOP')
    ui.OpenFrame('earthtowershop')
end

function Indun_panel_FULLSCREEN_NAVIGATION_MENU_DETAIL_MOVE_NPC(frame, ctrl, str, guid)
    if g.get_map_type() ~= "City" then
        return
    end
    local cls = GetClassByType("full_screen_navigation_menu", guid)
    if cls then
        local name = TryGetProp(cls, "Name", "None")
        local move_zone_select = TryGetProp(cls, "MoveZoneSelect", "NO")
        local move_zone = TryGetProp(cls, "MoveZone", "None")
        local move_npc_dialog = TryGetProp(cls, "MoveNpcDialog", "None")
        local move_zone_select_msg = TryGetProp(cls, "MoveZoneSelectMsg", "None")
        local move_only_in_town = TryGetProp(cls, "MoveOnlyInTown", "None")
        if move_zone ~= "None" and move_npc_dialog ~= "None" then
            local pc = GetMyPCObject()
            if session.world.IsIntegrateServer() == true or IsPVPField(pc) == 1 or IsPVPServer(pc) == 1 then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            if world.GetLayer() ~= 0 then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            if g.get_map_type() == "Dungeon" then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            local cur_map = GetClass("Map", session.GetMapName())
            if cur_map then
                local zone_keyword = TryGetProp(cur_map, 'Keyword', 'None')
                local keyword_table = StringSplit(zone_keyword, '')
                if table.find(keyword_table, 'IsRaidField') > 0 or table.find(keyword_table, 'WeeklyBossMap') > 0 then
                    ui.SysMsg(ScpArgMsg('ThisLocalUseNot'))
                    return
                end
                FullScreenMenuMoveNpc(name, move_zone_select, move_zone, move_npc_dialog, move_zone_select_msg,
                    move_only_in_town)
                ui.CloseFrame("fullscreen_navigation_menu")
            end
        end
    end
end

function Indun_panel_earthtowershop_close_restart()
    local earthtowershop = ui.GetFrame('earthtowershop')
    if earthtowershop:IsVisible() == 1 then
        earthtowershop:Resize(580, 1920)
        ui.CloseFrame("earthtowershop")
        return 0
    else
        earthtowershop:Resize(580, 1920)
        return 1
    end
end

function Indun_panel_always_init(indun_panel, ctrl, str)
    if str == "OPEN" then
        g.indun_panel_settings.etc.always_open = 1
        Indun_panel_frame_open(indun_panel)
    else
        g.indun_panel_settings.etc.always_open = 0
        Indun_panel_frame_init()
    end
    Indun_panel_save_settings()
end

function Indun_panel_frame_toggle(indun_panel)
    if indun_panel:GetHeight() > 40 then
        Indun_panel_frame_init(true)
    else
        Indun_panel_frame_open(indun_panel)
    end
end

function Indun_panel_frame_open(indun_panel)
    indun_panel:RemoveAllChild()
    Indun_panel_setup_frame(indun_panel)
    local btn = indun_panel:CreateOrGetControl("button", "btn", 5, 5, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}{s10}INDUNPANEL")
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_toggle")
    btn:SetEventScript(ui.RBUTTONUP, "Indun_panel_always_init")
    btn:SetTextTooltip(g.lang == "Japanese" and "{ol}右クリック: 常時展開解除で閉じる" or
                           "{ol}Right click: Close with permanent unexpand")
    local x = Indun_panel_create_common_buttons(indun_panel)
    local configbtn = indun_panel:CreateOrGetControl('button', 'configbtn', x, 5, 30, 30)
    AUTO_CAST(configbtn)
    configbtn:SetSkinName("None")
    configbtn:SetText("{img config_button_normal 30 30}")
    configbtn:SetEventScript(ui.LBUTTONUP, "Indun_panel_setting_frame_open")
    configbtn:SetTextTooltip(g.lang == "Japanese" and "{ol}Indun Panel 設定" or "{ol}Indun Panel Config")
    x = x + 30
    local button_keys = {"tos", "gabija", "vakarine", "rada", "jurate", "austeja", "pvp_mine", "market", "craft",
                         "leticia"}
    for _, key_name in ipairs(button_keys) do
        local value = g.indun_panel_settings.cols[key_name]
        if value == 1 then
            if Indun_panel_create_shortcut_button(indun_panel, key_name, x) then
                x = x + 30
            end
        end
    end
    local current_x = x + 10 -- SET A の開始位置
    for _, item in ipairs(g.indun_panel_settings.set_names) do
        for key, name in pairs(item) do
            local btn = indun_panel:CreateOrGetControl("button", key, current_x, 5, 80, 30)
            AUTO_CAST(btn)
            btn:Resize(80, 30)
            btn:SetText("{ol}" .. name)
            btn:Resize(80, 30)
            btn:AdjustFontSizeByWidth(80)
            btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_set_toggle")
            btn:SetEventScriptArgString(ui.LBUTTONUP, key) -- "set_a" を渡す
            btn:SetEventScriptArgNumber(ui.LBUTTONUP, 0) -- 0 を渡す (ArgNumberにする)
            if g.indun_panel_settings.etc.use_set == key then
                btn:SetSkinName("test_red_button")
            end
            current_x = current_x + 85
        end
    end
    local always_open = indun_panel:CreateOrGetControl('checkbox', 'always_open', 710, 5, 30, 30)
    AUTO_CAST(always_open)
    always_open:SetCheck(g.indun_panel_settings.etc.always_open)
    always_open:SetEventScript(ui.LBUTTONUP, "Indun_panel_ischecked")
    always_open:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると常時展開" or
                                   "{ol}IsCheck AlwaysOpen")
    local function indun_panel_FIELD_BOSS_TIME_TAB_SETTING()
        local induninfo = ui.GetFrame("induninfo")
        local field_boss_ranking_control = GET_CHILD_RECURSIVELY(induninfo, "field_boss_ranking_control")
        local sub_tab = GET_CHILD_RECURSIVELY(field_boss_ranking_control, "sub_tab")
        local server_time_str = date_time.get_lua_now_datetime_str()
        local _, _, _, hour_str, min_str, _ = server_time_str:match("(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)")
        local server_hour = tonumber(hour_str)
        local server_min = tonumber(min_str)
        if (server_hour < 12) or (server_hour == 12 and server_min < 5) then
            sub_tab:SelectTab(0)
        else
            sub_tab:SelectTab(1)
        end
    end
    local current_set = g.indun_panel_settings.etc.use_set
    if g.indun_panel_settings[current_set] and g.indun_panel_settings[current_set].jsr == 1 then
        indun_panel_FIELD_BOSS_TIME_TAB_SETTING()
    end
    local final_x = current_x + 30
    indun_panel:Resize(final_x, 40)
    indun_panel:ShowWindow(1)
    Indun_panel_frame_contents(configbtn)
    configbtn:RunUpdateScript("Indun_panel_frame_contents", 1.0)
end

function Indun_panel_set_toggle(indun_panel, ctrl, set_key, num)
    g.indun_panel_settings.etc.use_set = set_key
    Indun_panel_save_settings()
    if num == 1 then
        Indun_panel_setting_frame_open()
    else
        Indun_panel_frame_open(indun_panel)
    end
end

function Indun_panel_ischecked(indun_panel, ctrl)
    local ischeck = ctrl:IsChecked()
    local ctrlname = ctrl:GetName()
    local current_set = g.indun_panel_settings.etc.use_set
    local use_tbl = g.indun_panel_settings[current_set]
    if use_tbl and use_tbl[ctrlname] then
        use_tbl[ctrlname] = ischeck
    elseif g.indun_panel_settings.cols then
        if g.indun_panel_settings.cols[ctrlname] then
            g.indun_panel_settings.cols[ctrlname] = ischeck
        end
    end
    if g.indun_panel_settings.etc[ctrlname] then
        g.indun_panel_settings.etc[ctrlname] = ischeck
    end
    if ctrlname == "move" then
        local enable = g.indun_panel_settings.etc.move == 0 and 1 or 0
        indun_panel:EnableMove(enable)
        indun_panel:EnableHittestFrame(enable)
    end
    Indun_panel_save_settings()
end

function Indun_panel_setting_frame_open() -- Indun_list_viewer_save_current_char_counts()
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    indun_panel:SetSkinName("test_frame_low")
    indun_panel:SetLayerLevel(90)
    indun_panel:EnableHittestFrame(1)
    indun_panel:SetAlpha(100)
    indun_panel:RemoveAllChild()
    indun_panel:ShowWindow(1)
    local close = indun_panel:CreateOrGetControl('button', 'close', 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_init")
    local btn = indun_panel:CreateOrGetControl("button", "btn", 5, 5, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}{s10}INDUNPANEL")
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_init")
    local position = indun_panel:CreateOrGetControl("button", "position", 90, 5, 60, 30)
    AUTO_CAST(position)
    position:SetText("{ol}{s10}BASE POS")
    position:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_base_position")
    position:SetTextTooltip(g.lang == "Japanese" and "{ol}ボタンを元の位置に戻す" or "Reset button position")
    local x = 200
    for _, item in ipairs(g.indun_panel_settings.set_names) do
        for key, name in pairs(item) do
            local btn = indun_panel:CreateOrGetControl("button", name .. key, x, 5, 80, 30)
            AUTO_CAST(btn)
            btn:Resize(80, 30)
            btn:SetText("{ol}" .. name)
            btn:Resize(80, 30)
            btn:AdjustFontSizeByWidth(80)
            btn:SetTextTooltip(g.lang == "Japanese" and
                                   "{ol}左クリック: セット選択{nl}右クリック: セット名変更" or
                                   "{ol}Left Click: Select Set{nl}Right Click: Change Set Name")
            btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_set_toggle")
            btn:SetEventScriptArgString(ui.LBUTTONUP, key)
            btn:SetEventScriptArgNumber(ui.LBUTTONUP, 1)
            btn:SetEventScript(ui.RBUTTONUP, "Indun_panel_INPUT_STRING_BOX")
            btn:SetEventScriptArgString(ui.RBUTTONUP, key)
            if g.indun_panel_settings.etc.use_set == key then
                btn:SetSkinName("test_red_button")
            end
            x = x + 85
        end
    end
    local skin_change = indun_panel:CreateOrGetControl("button", "skin_change", 470, 5, 80, 30)
    AUTO_CAST(skin_change)
    local skin_text = g.lang == "Japanese" and "{ol}フレームスキン選択" or "{ol}Select Frame Skin"
    skin_change:SetEventScript(ui.LBUTTONUP, "Indun_panel_frame_skin_select")
    skin_change:SetText("{ol}SKIN SELECT")
    skin_change:SetTextTooltip(skin_text)
    local shortcut_icons = {{ -- ショートカットアイコンのチェックボックス作成をループ処理に
        name = "tos",
        img = "icon_item_Tos_Event_Coin",
        size = 25
    }, {
        name = "gabija",
        img = "goddess_shop_btn",
        size = 29
    }, {
        name = "vakarine",
        img = "goddess2_shop_btn",
        size = 29
    }, {
        name = "rada",
        img = "goddess3_shop_btn",
        size = 29
    }, {
        name = "jurate",
        img = "goddess4_shop_btn",
        size = 29
    }, {
        name = "austeja",
        img = "goddess5_shop_btn",
        size = 29
    }, {
        name = "pvp_mine",
        img = "pvpmine_shop_btn_total",
        size = 29
    }, {
        name = "market",
        img = "market_shortcut_btn02",
        size = 29
    }, {
        name = "craft",
        img = "icon_fullscreen_menu_equipment_processing",
        size = 28
    }, {
        name = "leticia",
        img = "icon_fullscreen_menu_letica",
        size = 28
    }}
    local config_x = 15
    local tooltip_always_show = g.lang == "Japanese" and "{ol}チェックすると常に表示" or
                                    "{ol}Always visible when checked"
    for _, icon_info in ipairs(shortcut_icons) do
        local checkbox = indun_panel:CreateOrGetControl("checkbox", icon_info.name, config_x, 47, icon_info.size,
            icon_info.size)
        AUTO_CAST(checkbox)
        checkbox:SetText(string.format("{img %s %d %d}", icon_info.img, icon_info.size, icon_info.size))
        checkbox:SetEventScript(ui.LBUTTONUP, "Indun_panel_ischecked")
        checkbox:SetEventScriptArgString(ui.LBUTTONUP, "config")
        checkbox:SetTextTooltip(tooltip_always_show)
        local is_checked = 0
        for k, v in pairs(g.indun_panel_settings.cols) do
            if k == icon_info.name then
                is_checked = v
                break
            end
        end
        checkbox:SetCheck(is_checked)
        config_x = config_x + checkbox:GetWidth() + 5
    end
    local label_line2 = indun_panel:CreateControl('labelline', 'label_line2', 10, 77, config_x, 5)
    AUTO_CAST(label_line2)
    label_line2:SetSkinName("labelline2")
    local other_settings = {{ -- その他の設定チェックボックス作成をループ処理に
        name = "en_ver",
        y = 85,
        jp = "チェックすると英語表示に変更します",
        en = "Check to display to English"
    }, {
        name = "move",
        y = 120,
        jp = "チェックするとフレームを固定",
        en = "Check to fixes the frame"
    }, {
        name = "field_mode",
        y = 155,
        jp = "チェックするとフィールドで表示",
        en = "Check to display in field"
    }, {
        name = "shading",
        y = 190,
        jp = "チェックすると網掛け表示",
        en = "Check to display shading"
    }}
    for _, setting_info in ipairs(other_settings) do
        local checkbox = indun_panel:CreateOrGetControl('checkbox', setting_info.name, 25, setting_info.y, 25, 25)
        AUTO_CAST(checkbox)
        checkbox:SetCheck(g.indun_panel_settings.etc[setting_info.name])
        checkbox:SetEventScript(ui.LBUTTONUP, "Indun_panel_ischecked")
        checkbox:SetText(g.lang == "Japanese" and "{ol}" .. setting_info.jp or "{ol}" .. setting_info.en)
    end
    local label_line = indun_panel:CreateControl('labelline', 'label_line', 10, 215, config_x, 5)
    AUTO_CAST(label_line)
    label_line:SetSkinName("labelline2")
    local posy_left = 220
    local posy_right = 220
    local count = #induns
    local half_count = math.ceil(count / 2)
    local current_set = g.indun_panel_settings.etc.use_set
    local use_tbl = g.indun_panel_settings[current_set]
    for i = 1, count do
        local entry = induns[i]
        for key, value in pairs(entry) do
            local checkbox
            if i <= half_count then
                checkbox = indun_panel:CreateOrGetControl('checkbox', key, 15, posy_left, 25, 25)
                AUTO_CAST(checkbox)
                posy_left = posy_left + 35
            else
                checkbox = indun_panel:CreateOrGetControl('checkbox', key, 325, posy_right, 25, 25)
                AUTO_CAST(checkbox)
                posy_right = posy_right + 35
            end
            local is_checked = use_tbl[key]
            if is_checked == nil then
                is_checked = 0
            end
            checkbox:SetCheck(is_checked)
            checkbox:SetEventScript(ui.LBUTTONUP, "Indun_panel_ischecked")
            local bool = g.indun_panel_settings.etc.en_ver == 0 and g.lang == "Japanese"
            local display_name = key
            if bool and value.jp then
                display_name = value.jp
            end
            checkbox:SetText(bool and "{ol}{#FFFFFF}{s16}" .. display_name or "{ol}{#FFFFFF}{s20}" .. key)
            checkbox:SetTextTooltip(g.lang == "Japanese" and "チェックすると表示" or "Check to show")
        end
    end
    local final_height = math.max(posy_left, posy_right)
    indun_panel:Resize(660, final_height + 5)
end

function Indun_panel_frame_base_position(indun_panel)
    indun_panel:SetPos(665, 30)
    g.indun_panel_settings.etc.x = 665
    g.indun_panel_settings.etc.y = 30
    Indun_panel_save_settings()
end

function Indun_panel_INPUT_STRING_BOX(frame, ctrl, set_key, num)
    local inputstring = ui.GetFrame("inputstring")
    inputstring:Resize(500, 220)
    inputstring:SetLayerLevel(999)
    local edit = GET_CHILD(inputstring, 'input', "ui::CEditControl")
    edit:SetNumberMode(0)
    edit:SetMaxLen(999)
    edit:SetText("")
    inputstring:ShowWindow(1)
    inputstring:SetEnable(1)
    local title = inputstring:GetChild("title")
    AUTO_CAST(title)
    local text = g.lang == "Japanese" and "{ol}{#FFFFFF}セット名を入力" or "{ol}{#FFFFFF}Enter set name"
    title:SetText(text)
    local confirm = inputstring:GetChild("confirm")
    confirm:SetEventScript(ui.LBUTTONUP, "Indun_panel_save_setname")
    confirm:SetEventScriptArgString(ui.LBUTTONUP, set_key)
    edit:SetEventScript(ui.ENTERKEY, "Indun_panel_save_setname")
    edit:SetEventScriptArgString(ui.ENTERKEY, set_key)
    edit:AcquireFocus()
end

function Indun_panel_save_setname(inputstring, ctrl, set_key, num)
    inputstring:ShowWindow(0)
    local edit = GET_CHILD(inputstring, 'input')
    local get_text = edit:GetText()
    if get_text == "" then
        local text = g.lang == "Japanese" and "{ol}文字を入力してください" or "{ol}Please enter text"
        ui.SysMsg(text)
        Indun_panel_INPUT_STRING_BOX(nil, nil, set_key, 0)
        return
    end
    local text = g.lang == "Japanese" and "{ol}セット名を登録しました" or "{ol}Set name registered"
    ui.SysMsg(text)
    for _, item in ipairs(g.indun_panel_settings.set_names) do
        if item[set_key] then
            item[set_key] = get_text
            break
        end
    end
    Indun_panel_save_settings()
    Indun_panel_setting_frame_open()
end

function Indun_panel_frame_skin_select()
    local context = ui.CreateContextMenu("indun_panel_skin_select", "{ol}Skin Select", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, " ")
    local skin_tbl = {"chat_window_2", "bg", "bg2"}
    for _, skin_name in ipairs(skin_tbl) do
        local str_scp
        str_scp = string.format("Indun_panel_frame_skin_select_('%s')", skin_name)
        local text
        if skin_name == "chat_window_2" then
            text = g.lang == "Japanese" and "{ol}いつもの" or "The usual"
        elseif skin_name == "bg" then
            text = g.lang == "Japanese" and "{ol}黒" or "Solid black"
        elseif skin_name == "bg2" then
            text = g.lang == "Japanese" and "{ol}透明度高め" or "High transparency"
        end
        ui.AddContextMenuItem(context, text, str_scp)
    end
    ui.OpenContextMenu(context)
end

function Indun_panel_frame_skin_select_(skin_name)
    g.indun_panel_settings.etc.skin_name = skin_name
    Indun_panel_save_settings()
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    Indun_panel_frame_open(indun_panel)
end

function Indun_panel_frame_contents(configbtn)
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    local shop_buttons = {"gabija", "vakarine", "rada", "jurate", "austeja"}
    local shop_props = {"GabijaCertificate", "VakarineCertificate", "RadaCertificate", "JurateCertificate",
                        "AustejaCertificate"}
    local shop_names_jp = {"ガビヤショップ", "ヴァカリネショップ", "ラダショップ",
                           "ユラテショップ", "アウステヤショップ"}
    local shop_names_en = {"Gabija Shop", "Vakarine Shop", "Rada Shop", "Jurate Shop", "Austeja Shop"}
    local account_obj = GetMyAccountObj()
    for i, btn_name in ipairs(shop_buttons) do
        local btn = GET_CHILD_RECURSIVELY(indun_panel, btn_name)
        if btn then
            AUTO_CAST(btn)
            local count = GET_COMMAED_STRING(TryGetProp(account_obj, shop_props[i], "0"))
            local name = g.lang == "Japanese" and shop_names_jp[i] or shop_names_en[i]
            local tooltip = string.format("{ol}%s{nl}{#FFFF00}%s", name, count)
            btn:SetTextTooltip(tooltip)
        end
    end
    local prefix = "DD"
    if g.indun_panel_settings.etc.skin_name and g.indun_panel_settings.etc.skin_name == "bg" then
        prefix = "FF"
    end
    local x = 150
    local current_set = g.indun_panel_settings.etc.use_set
    local use_tbl = g.indun_panel_settings[current_set]
    if not use_tbl then
        return 1
    end
    local y = 40
    local index = 1
    local index_remainder = 0
    local lasy_y = 0
    for i, entry in ipairs(induns) do
        local key, value = next(entry)
        if use_tbl[key] == 1 then
            if g.indun_panel_settings.etc.shading == 1 then
                local line = indun_panel:CreateOrGetControl("picture", "line" .. key, 5, y - 2, 740, 33)
                AUTO_CAST(line)
                line:SetImage("fullwhite")
                line:SetEnableStretch(1)
                line:EnableHitTest(0)
                local tone = (index % 2 == 1) and "696969" or "A9A9A9"
                line:SetColorTone(prefix .. tone)
            end
            if key == "jsr" or value.icon then
                local img_icon = indun_panel:CreateOrGetControl("picture", "img_icon" .. key, x - 140, y + 5, 20, 20)
                AUTO_CAST(img_icon)
                local icon_cls = nil
                if key == "jsr" then
                    local fieldbossPattern = session.fieldboss.GetPatternInfo()
                    local icon_cls_name = fieldbossPattern.MonsterClassName
                    icon_cls = GetClass("Monster", icon_cls_name)
                elseif value.icon then
                    icon_cls = GetClassByType(value.icon[1], value.icon[2])
                end
                if icon_cls then
                    img_icon:SetImage(icon_cls.Icon)
                    img_icon:SetEnableStretch(1)
                    img_icon:EnableHitTest(0)
                end
                local text = indun_panel:CreateOrGetControl("richtext", key, x - 120, y + 5)
                local is_jp_mode = (g.indun_panel_settings.etc.en_ver == 0 and g.lang == "Japanese")
                local display_name = key
                if is_jp_mode and value.jp then
                    display_name = value.jp
                end
                local font_tag = is_jp_mode and "{s16}" or "{s20}"
                text:SetText(string.format("{ol}{#FFFFFF}%s%s", font_tag, display_name))
                index = index + 1
                if key == "challenge" then
                    local tooltip = g.lang == "Japanese" and
                                        "{ol}左クリック: チャレンジマップの1週間分のスケジュール表示" or
                                        "{ol}Left Click: Display the schedule for one week of the Challenge Map"
                    img_icon:EnableHitTest(1)
                    img_icon:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_map_context")
                    img_icon:SetTextTooltip(tooltip)
                    text:EnableHitTest(1)
                    text:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_map_context")
                    text:SetTextTooltip(tooltip)
                end
                text:AdjustFontSizeByWidth(120)
            end
            if type(value) == "table" then
                if key == "challenge" then
                    for sub_key, sub_value in pairs(value) do
                        if sub_key ~= "jp" and sub_key ~= "icon" then
                            Indun_panel_challenge_frame(indun_panel, key, sub_key, sub_value, y, x)
                        end
                    end
                elseif key == "singularity" then
                    for sub_key, sub_value in pairs(value) do
                        if sub_key ~= "jp" and sub_key ~= "icon" then
                            Indun_panel_singularity_frame(indun_panel, key, sub_key, sub_value, y, x)
                        end
                    end
                elseif key == "zmei" or key == "belliora" or key == "laimara" or key == "ledania" or key == "neringa" or key == "golem" or
                    key == "merregina" or key == "slogutis" or key == "upinis" or key == "roze" or key == "falouros" or
                    key == "reservoir" then -- レイド系 (onsweep)
                    for sub_key, sub_value in pairs(value) do
                        if sub_key ~= "jp" and sub_key ~= "icon" then
                            Indun_panel_create_frame_onsweep(indun_panel, key, sub_key, sub_value, y, x)
                        end
                    end
                elseif key == "jellyzele" or key == "delmore" or key == "giltine" or key == "memory" then -- 通常ダンジョン系 (create_frame)
                    for sub_key, sub_value in pairs(value) do
                        if sub_key ~= "jp" and sub_key ~= "icon" then
                            Indun_panel_create_frame(indun_panel, key, sub_key, sub_value, y, x)
                        end
                    end
                elseif key == "telharsha" then
                    Indun_panel_telharsha_frame(indun_panel, key, value.id, y, x)
                elseif key == "bernice" then
                    Indun_panel_velnice_frame(indun_panel, key, value.id, y, x)
                elseif key == "wailing" then
                    Indun_panel_cemetery_frame(indun_panel, key, value.id, y, x)
                elseif key == "ashaq" then
                    Indun_panel_demonlair_frame(indun_panel, key, value.id, y, x)
                elseif key == "jsr" then
                    Indun_panel_jsr_frame(indun_panel, y, x)
                end
            end
            y = y + 33
        end
        index_remainder = index % 2
        lasy_y = y
    end
    local y = lasy_y or 40
    local status, err = pcall(Indun_panel_create_currency_display, indun_panel, y)
    if not status then
        print("[IndunPanel] Currency Display Error: " .. tostring(err))
    end
    y = y + 40
    if g.indun_panel_settings.etc.shading == 1 then
        local line = indun_panel:CreateOrGetControl("picture", "last_line", 5, y - 2, 740, 33)
        AUTO_CAST(line)
        line:SetImage("fullwhite")
        line:SetEnableStretch(1)
        line:EnableHitTest(0)
        line:SetColorTone(prefix .. (index_remainder == 1 and "696969" or "A9A9A9"))
    end
    indun_panel:SetLayerLevel(80)
    indun_panel:Resize(x + 600, y)
    indun_panel:SetSkinName(g.indun_panel_settings.etc.skin_name or "chat_window_2")
    indun_panel:EnableHitTest(1)
    indun_panel:SetAlpha(100)
    return 1
end

function Indun_panel_create_currency_display(indun_panel, y)
    local account_obj = GetMyAccountObj()
    local bonusTP_pic = indun_panel:CreateOrGetControl("richtext", "bonusTP_pic", 320, y + 5)
    AUTO_CAST(bonusTP_pic)
    bonusTP_pic:SetText("{img bonusTP_pic 22 22}")
    local bonusTP_count = indun_panel:CreateOrGetControl("richtext", "bonusTP_count", 350, y + 5)
    AUTO_CAST(bonusTP_count)
    bonusTP_count:SetText("{ol}{#FFD900}{s18}" .. account_obj.Medal)
    bonusTP_count:SetTextTooltip("{ol}Free TP")
    local housing_btn = indun_panel:CreateOrGetControl("richtext", "housing_btn", 370, y + 5)
    AUTO_CAST(housing_btn)
    housing_btn:SetText("{img btn_housing_editmode_small_resize 23 23}")
    local housing_count = indun_panel:CreateOrGetControl("richtext", "housing_count", 400, y + 5)
    AUTO_CAST(housing_count)
    -- housing_count:SetText("{ol}{#FFD900}{s18}...")
    housing_count:SetTextTooltip("{ol}Housing Point")
    local current_time = imcTime.GetAppTime()
    if not g.indun_panel_housing_call_time or (current_time - g.indun_panel_housing_call_time) > 5 then
        g.indun_panel_housing_call_time = current_time
        Indun_panel_get_my_housing_point_callback_ready()
    elseif g.indun_panel_housing_point then
        housing_count:SetText("{ol}{#FFD900}{s18}" .. g.indun_panel_housing_point)
    end
    local tos_coin = indun_panel:CreateOrGetControl("richtext", "tos_coin", 450, y + 5)
    tos_coin:SetText("{img icon_item_Tos_Event_Coin 21 21}")
    local tos_coin_count = indun_panel:CreateOrGetControl("richtext", "tos_coin_count", 475, y + 5)
    local coin_count = GET_COMMAED_STRING(TryGetProp(account_obj, "EVENT_TOS_WHOLE_TOTAL_COIN", "0"))
    local target_coin = GET_COMMAED_STRING(g.indun_panel_settings.etc.toscoin or 0)
    tos_coin_count:SetText(string.format("{ol}{#FFD900}{s18}%s/{#FFD900}%s", coin_count, target_coin))
    local pvpmine = indun_panel:CreateOrGetControl("richtext", "pvpmine", 605, y + 5)
    pvpmine:SetText("{img pvpmine_shop_btn_total 25 25}")
    local pvpminecount = indun_panel:CreateOrGetControl("richtext", "pvpminecount", 630, y + 5)
    local mine_count = GET_COMMAED_STRING(TryGetProp(account_obj, "MISC_PVP_MINE2", "0"))
    pvpminecount:SetText(string.format("{ol}{#FFD900}{s18}%s", mine_count))
end

function Indun_panel_get_my_housing_point_callback_ready()
    local aidx = session.loginInfo.GetAID()
    GetMyHousingPageInfo("Indun_panel_get_my_housing_point_callback", aidx)
end

function Indun_panel_get_my_housing_point_callback(code, ret_json)
    if code ~= 200 or not ret_json or ret_json == "" then
        return
    end
    local status, parsed = pcall(json.decode, ret_json)
    if not (status and parsed) then
        return
    end
    if not parsed or type(parsed) ~= "table" then
        return
    end
    local housing_point = 0
    if parsed["pointInfo"] and parsed["pointInfo"]["personalHousing_Point1"] then
        housing_point = tonumber(parsed["pointInfo"]["personalHousing_Point1"]) or 0
    end
    g.indun_panel_housing_point = housing_point
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    if indun_panel and indun_panel:IsVisible() == 1 then
        local housing_count = GET_CHILD_RECURSIVELY(indun_panel, "housing_count")
        if housing_count then
            housing_count:SetText("{ol}{#FFD900}{s18}" .. housing_point)
        end
    end
end

function Indun_panel_item_buy_use(recipe_name)
    local recipe_cls = GetClass("ItemTradeShop", recipe_name)
    if not recipe_cls then
        return
    end
    session.ResetItemList()
    session.AddItemID(tostring(0), 1)
    local itemlist = session.GetItemIDList()
    local cnt_text = string.format("%s %s", recipe_cls.ClassID, 1)
    if string.find(recipe_name, "EVENT_TOS", 1, true) then
        item.DialogTransaction("EVENT_TOS_WHOLE_SHOP", itemlist, cnt_text)
    else
        item.DialogTransaction("PVP_MINE_SHOP", itemlist, cnt_text)
    end
    local item_name = recipe_cls.TargetItem
    ReserveScript(string.format("Indun_panel_inv_item_use('%s')", item_name), 1.0)
end

function Indun_panel_inv_item_use(item_name)
    local item_cls = GetClass("Item", item_name)
    if item_cls then
        local inv_item = session.GetInvItemByType(item_cls.ClassID)
        if inv_item then
            INV_ICON_USE(inv_item)
        end
    end
end

function Indun_panel_get_entrance_count(indun_type, index)
    local indun_cls = GetClassByType("Indun", indun_type)
    if not indun_cls then
        return 0
    end
    local reset_type = indun_cls.PlayPerResetType
    local current_count = GET_CURRENT_ENTERANCE_COUNT(reset_type) or 0
    local max_count = GET_INDUN_MAX_ENTERANCE_COUNT(reset_type) or 0
    if index == 1 then
        return string.format("{ol}{#FFFFFF}{s16}(%s)", current_count)
    elseif index == 2 then
        return string.format("{ol}{#FFFFFF}{s16}(%s/%s)", current_count, max_count)
    elseif index == 3 then
        local count = 1
        local class_name = TryGetProp(indun_cls, 'ClassName', 'None')
        if string.find(class_name, 'Challenge_') then
            local ticket_type = TryGetProp(indun_cls, 'TicketingType', 'None')
            if ticket_type == 'Entrance_Ticket' then
                local check_name = TryGetProp(indun_cls, 'CheckCountName', 'None')
                local etc = GetMyEtcObject()
                if TryGetProp(etc, check_name, 0) == 1 then
                    count = 0
                end
            end
        end
        return string.format("{ol}{#FFFFFF}{s16}(%s/%s)", count, max_count)
    elseif index == 4 then
        if indun_type == 1001 then
            return current_count
        elseif indun_type == 1004 or indun_type == 1005 or indun_type == 2000 or indun_type == 2001 then
            local class_name = TryGetProp(indun_cls, 'ClassName', 'None')
            if string.find(class_name, 'Challenge_') then
                local unit_per_reset = TryGetProp(indun_cls, 'UnitPerReset', 'None')
                local check_name = TryGetProp(indun_cls, 'CheckCountName', 'None')
                if unit_per_reset ~= 'None' and check_name ~= 'None' then
                    if unit_per_reset == 'ACCOUNT' then
                        return TryGetProp(GetMyAccountObj(), check_name, 0) or 0
                    elseif unit_per_reset == 'PC' then
                        return TryGetProp(GetMyEtcObject(), check_name, 0) or 0
                    end
                end
            end
        end
        return 0
    end
    return 0
end

function Indun_panel_get_recipe_trade_count(recipe_name)
    local recipe_cls = GetClass("ItemTradeShop", recipe_name)
    if not recipe_cls then
        return 0
    end
    if recipe_cls.NeedProperty ~= "None" and recipe_cls.NeedProperty ~= "" then
        return TryGetProp(GetSessionObject(GetMyPCObject(), "ssn_shop"), recipe_cls.NeedProperty, 0)
    end
    if recipe_cls.AccountNeedProperty ~= "None" and recipe_cls.AccountNeedProperty ~= "" then
        return TryGetProp(GetMyAccountObj(), recipe_cls.AccountNeedProperty, 0)
    end
    return 0
end

function Indun_panel_overbuy_count(recipe_name)
    local account_obj = GetMyAccountObj()
    local recipe_cls = GetClass('ItemTradeShop', recipe_name)
    if not recipe_cls then
        return 0
    end
    local max_count = TryGetProp(recipe_cls, 'MaxOverBuyCount', 0)
    local prop_name = TryGetProp(recipe_cls, 'OverBuyProperty', 'None')
    local current_count = TryGetProp(account_obj, prop_name, 0)
    return tonumber(max_count) - tonumber(current_count)
end

function Indun_panel_overbuy_amount(recipe_name)
    local account_obj = GetMyAccountObj()
    local recipe_cls = GetClass('ItemTradeShop', recipe_name)
    if not recipe_cls then
        return 0
    end
    local trade_count = Indun_panel_get_recipe_trade_count(recipe_name)
    if trade_count > 0 then
        return 1000
    end
    local prop_name = TryGetProp(recipe_cls, 'OverBuyProperty', 'None')
    local current_overbuy_count = TryGetProp(account_obj, prop_name, 0)
    return 1050 + (current_overbuy_count * 50)
end

function Indun_panel_get_invitem_count(tbl)
    local count = 0
    local inv_item_list = session.GetInvItemList()
    local guid_list = inv_item_list:GetGuidList()
    local cnt = guid_list:Count()
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        if inv_item then
            local obj = GetIES(inv_item:GetObject())
            local item_id = obj.ClassID
            for _, class_id in ipairs(tbl) do
                if item_id == class_id then
                    count = count + inv_item.count
                    break
                end
            end
        end
    end
    return count
end

local CHALLENGE_CONFIG = {
    LOW = {
        expiring = {10820019, 11030080, 641954, 641955, 641969},
        non_expiring = {10000073, 10820028, 490363, 641953, 641963, 641987}
    },
    HIGH = {
        expiring = {11201299, 11201300, 10820052},
        non_expiring = {11201298, 11201297}
    }
}
function Indun_panel_challenge_frame(indun_panel, key, sub_key, indun_type, y, x)
    local low_indun_type = 1001
    local btn_low = indun_panel:CreateOrGetControl('button', "btn_low", x + 0, y, 50, 30)
    AUTO_CAST(btn_low)
    btn_low:SetText("{ol}520")
    btn_low:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_challenge")
    btn_low:SetEventScriptArgString(ui.LBUTTONUP, "1")
    btn_low:SetEventScriptArgNumber(ui.LBUTTONUP, low_indun_type)
    local txt_low = indun_panel:CreateOrGetControl("richtext", "txt_low", x + 50, y + 5, 40, 30)
    txt_low:SetText(Indun_panel_get_entrance_count(low_indun_type, 2))
    local buyuse_low = indun_panel:CreateOrGetControl('button', "buyuse_low", x + 90, y, 100, 30)
    AUTO_CAST(buyuse_low)
    local text_low = string.format("{ol}{#EE7800}USEor{s16}{img %s 15 15}{#FFFFFF}%s", "icon_item_Tos_Event_Coin",
        Indun_panel_get_recipe_trade_count("EVENT_TOS_WHOLE_SHOP_315") or 0)
    local count = Indun_panel_get_invitem_count(CHALLENGE_CONFIG.LOW.expiring)
    count = count + Indun_panel_get_invitem_count(CHALLENGE_CONFIG.LOW.non_expiring)
    local icon_text = ""
    local item_cls = GetClassByType('Item', CHALLENGE_CONFIG.LOW.expiring[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています{nl} {nl}" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d{nl} {nl}"
        icon_text = string.format(fmt, item_cls.Icon, count)
    end
    local tooltip_low = g.lang == "Japanese" and
                            "{ol}優先順位{nl}1.期限付き{nl}2.期限なし{nl}3.{img icon_item_Tos_Event_Coin 20 20}チケット(買って使います)" or
                            "{ol}Priority{nl}1.Expiring{nl}2.Non-expiring{nl}3.{img icon_item_Tos_Event_Coin 20 20}tickets(buy and use)"
    buyuse_low:SetTextTooltip(icon_text .. tooltip_low)
    buyuse_low:SetText(text_low)
    buyuse_low:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_item_use")
    buyuse_low:SetEventScriptArgNumber(ui.LBUTTONUP, low_indun_type)
    local high_indun_type = 1004
    local high_pt_indun_type = 1005
    local btn_high = indun_panel:CreateOrGetControl('button', "btn_high", x + 195, y, 50, 30)
    AUTO_CAST(btn_high)
    btn_high:SetText("{ol}540")
    btn_high:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_challenge")
    btn_high:SetEventScriptArgString(ui.LBUTTONUP, "1")
    btn_high:SetEventScriptArgNumber(ui.LBUTTONUP, high_indun_type)
    local btn_high_pt = indun_panel:CreateOrGetControl('button', "btn_high_pt", x + 250, y, 50, 30)
    AUTO_CAST(btn_high_pt)
    btn_high_pt:SetText("{ol}{#FFD900}PT")
    btn_high_pt:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_challenge")
    btn_high_pt:SetEventScriptArgString(ui.LBUTTONUP, "2")
    btn_high_pt:SetEventScriptArgNumber(ui.LBUTTONUP, high_pt_indun_type)
    local txt_high = indun_panel:CreateOrGetControl("richtext", "txt_high", x + 300, y + 5, 40, 30)
    txt_high:SetText(Indun_panel_get_entrance_count(high_indun_type, 3))
    local buyuse_high_tos = indun_panel:CreateOrGetControl('button', "buyuse_high_tos", x + 340, y, 100, 30)
    AUTO_CAST(buyuse_high_tos)
    local count = Indun_panel_get_invitem_count(CHALLENGE_CONFIG.HIGH.expiring)
    count = count + Indun_panel_get_invitem_count(CHALLENGE_CONFIG.HIGH.non_expiring)
    local icon_text_high = ""
    local item_cls = GetClassByType('Item', CHALLENGE_CONFIG.HIGH.expiring[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています{nl} {nl}" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d{nl} {nl}"
        icon_text_high = string.format(fmt, item_cls.Icon, count)
    end
    local text_high_tos = string.format("{ol}{#EE7800}USEor{s16}{img %s 15 15}{#FFFFFF}%s", "icon_item_Tos_Event_Coin",
        Indun_panel_get_recipe_trade_count("EVENT_TOS_WHOLE_SHOP_320") or 0)
    local tooltip_high_tos = g.lang == "Japanese" and
                                 "{ol}左クリック: PT入場{nl}右クリック: ソロ入場{nl}優先順位{nl}1.期限付き{nl}2.{img icon_item_Tos_Event_Coin 20 20}チケット(買って使います){nl}3.期限なし" or
                                 "{ol}Left Click: PT Entry{nl}Right Click: Solo Entry{nl}Priority{nl}1.Expiring{nl}2.{img pvpmine_shop_btn_total 20 20}tickets(buy and use){nl}3.Non-expiring"
    buyuse_high_tos:SetText(text_high_tos)
    buyuse_high_tos:SetTextTooltip(icon_text_high .. tooltip_high_tos)
    buyuse_high_tos:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_item_use")
    buyuse_high_tos:SetEventScriptArgString(ui.LBUTTONUP, "tos")
    buyuse_high_tos:SetEventScriptArgNumber(ui.LBUTTONUP, high_pt_indun_type)
    buyuse_high_tos:SetEventScript(ui.RBUTTONUP, "Indun_panel_challenge_item_use")
    buyuse_high_tos:SetEventScriptArgString(ui.RBUTTONUP, "tos")
    buyuse_high_tos:SetEventScriptArgNumber(ui.RBUTTONUP, high_indun_type)
    local buyuse_high_pvp = indun_panel:CreateOrGetControl('button', "buyuse_high_pvp", x + 450, y, 100, 30)
    AUTO_CAST(buyuse_high_pvp)
    local text_high_pvp = string.format("{ol}{#FFFFFF}USEor{s16}{img pvpmine_shop_btn_total 18 18}{#FFFFFF}%s",
        Indun_panel_get_recipe_trade_count("PVP_MINE_40") or 0)
    local tooltip_high_pvp = g.lang == "Japanese" and
                                 "{ol}左クリック: PT入場{nl}右クリック: ソロ入場{nl}優先順位{nl}1.期限付き{nl}2.{img pvpmine_shop_btn_total 20 20}チケット(買って使います){nl}3.期限なし" or
                                 "{ol}Left Click: PT Entry{nl}Right Click: Solo Entry{nl}Priority{nl}1.Expiring{nl}2.{img pvpmine_shop_btn_total 20 20}tickets(buy and use){nl}3.Non-expiring"
    buyuse_high_pvp:SetText(text_high_pvp)
    buyuse_high_pvp:SetTextTooltip(icon_text_high .. tooltip_high_pvp)
    buyuse_high_pvp:SetEventScript(ui.LBUTTONUP, "Indun_panel_challenge_item_use")
    buyuse_high_pvp:SetEventScriptArgString(ui.LBUTTONUP, "pvp")
    buyuse_high_pvp:SetEventScriptArgNumber(ui.LBUTTONUP, high_pt_indun_type)
    buyuse_high_pvp:SetEventScript(ui.RBUTTONUP, "Indun_panel_challenge_item_use")
    buyuse_high_pvp:SetEventScriptArgString(ui.RBUTTONUP, "pvp")
    buyuse_high_pvp:SetEventScriptArgNumber(ui.RBUTTONUP, high_indun_type)
end

function Indun_panel_challenge_item_use(indun_panel, ctrl, mode, indun_type)
    local entrance_count = Indun_panel_get_entrance_count(indun_type, 4)
    if indun_type == 1001 and entrance_count > 0 then -- 520は行ける場合0行けない場合1
        Indun_panel_process_ticket(indun_type, mode, CHALLENGE_CONFIG.LOW)
    elseif indun_type ~= 1001 and entrance_count == 0 then -- 540は行ける場合1行けない場合0
        Indun_panel_process_ticket(indun_type, mode, CHALLENGE_CONFIG.HIGH)
    end
end

function Indun_panel_process_ticket(indun_type, mode, config)
    local enter_mode = indun_type == 1005 and 2 or 1
    if Indun_panel_use_prioritized_ticket(config.expiring, enter_mode, indun_type) then
        return
    end
    local recipe_name = ""
    if indun_type == 1001 then
        recipe_name = "EVENT_TOS_WHOLE_SHOP_315"
    elseif mode == "tos" then
        recipe_name = "EVENT_TOS_WHOLE_SHOP_320"
    elseif mode == "pvp" then
        recipe_name = "PVP_MINE_40"
    end
    if Indun_panel_get_recipe_trade_count(recipe_name) >= 1 then
        Indun_panel_item_buy_use(recipe_name)
        Indun_panel_enter_reserve(enter_mode, indun_type)
        return
    end
    if Indun_panel_use_prioritized_ticket(config.non_expiring, enter_mode, indun_type) then
        return
    end
    if recipe_name == "PVP_MINE_40" then
        local account_obj = GetMyAccountObj()
        local recipe_cls = GetClass('ItemTradeShop', recipe_name)
        if recipe_cls then
            local over_max = TryGetProp(recipe_cls, 'MaxOverBuyCount', 0)
            local over_prop = TryGetProp(recipe_cls, 'OverBuyProperty', 'None')
            local over_count = TryGetProp(account_obj, over_prop, 0)
            if (tonumber(over_max) - tonumber(over_count)) > 0 then
                Indun_panel_item_buy_use(recipe_name)
                Indun_panel_enter_reserve(enter_mode, indun_type)
                return
            end
        end
    end
end

function Indun_panel_use_prioritized_ticket(ticket_ids, enter_mode, indun_type)
    local candidate_tickets = {}
    local use_item = nil
    for _, classid in ipairs(ticket_ids) do
        local inv_item = session.GetInvItemByType(classid)
        if inv_item then
            if not inv_item.isLockState then
                local item_obj = GetIES(inv_item:GetObject())
                local life_time = tonumber(GET_REMAIN_ITEM_LIFE_TIME(item_obj)) or 0
                if life_time > 0 then
                    table.insert(candidate_tickets, {
                        use_item = inv_item,
                        priority = (life_time and life_time > 0 and life_time < 86400) and 1 or 2
                    })
                else
                    if indun_type == 1001 then
                        use_item = inv_item
                    else
                        if Indun_panel_get_recipe_trade_count("EVENT_TOS_WHOLE_SHOP_320") < 1 and
                            Indun_panel_get_recipe_trade_count("PVP_MINE_40") < 1 then
                            use_item = inv_item
                        end
                    end
                end
            else
                ui.SysMsg(ClMsg("MaterialItemIsLock") .. " (" .. use_item.Name .. ")")
            end
        end
    end
    if #candidate_tickets > 0 then
        table.sort(candidate_tickets, function(a, b)
            return a.priority < b.priority
        end)
        use_item = candidate_tickets[1].use_item
    end
    if use_item then
        INV_ICON_USE(use_item)
        Indun_panel_enter_reserve(enter_mode, indun_type)
        return true
    end
    return false
end

function Indun_panel_enter_reserve(index, indun_type)
    AnsGiveUpPrevPlayingIndun(1)
    ReserveScript(string.format("Indun_panel_enter_challenge(nil,nil,'%d', %d)", index, indun_type), 1.5)
end

function Indun_panel_enter_challenge(indun_panel, ctrl, index, indun_type)
    index = tonumber(index)
    if not indun_type then
        return
    end
    local pcparty = session.party.GetPartyInfo()
    if not pcparty then
        CREATE_PARTY_BTN()
    end
    ReqChallengeAutoUIOpen(indun_type)
    ReserveScript(string.format("ReqMoveToIndun(%d,%d)", index, 0), 0.3)
end

local SINGULARITY_CONFIG = {
    [2000] = { -- 520
        expiring = {10820018, 11030067},
        non_expiring = {10000470, 11030021, 11030017}
    },
    [2001] = { -- 540
        expiring = {11201303, 11201304, 10820051},
        non_expiring = {11201302, 11201301}
    }
}
function Indun_panel_singularity_frame(indun_panel, key, sub_key, indun_type, y, x)
    local low_indun_type = 2000
    local btn_low = indun_panel:CreateOrGetControl('button', "btn_low" .. indun_type, x, y, 50, 30)
    AUTO_CAST(btn_low)
    btn_low:SetText("{ol}520")
    btn_low:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_singularity")
    btn_low:SetEventScriptArgNumber(ui.LBUTTONUP, low_indun_type)
    local count_low = indun_panel:CreateOrGetControl("richtext", "count_low" .. indun_type, x + 55, y + 5, 30, 30)
    count_low:SetText("{ol}(" .. Indun_panel_get_entrance_count(low_indun_type, 4) .. ")")
    local ticket_low = indun_panel:CreateOrGetControl('button', 'ticket_low' .. indun_type, x + 85, y, 100, 30)
    AUTO_CAST(ticket_low)
    local text_low = string.format("{ol}{#EE7800}USEor{s16}{img %s 15 15}{#FFFFFF}%s", "icon_item_Tos_Event_Coin",
        Indun_panel_get_recipe_trade_count("EVENT_TOS_WHOLE_SHOP_314") or 0)
    local count = Indun_panel_get_invitem_count(SINGULARITY_CONFIG[2000].expiring)
    count = count + Indun_panel_get_invitem_count(SINGULARITY_CONFIG[2000].non_expiring)
    local icon_text = ""
    local item_cls = GetClassByType('Item', SINGULARITY_CONFIG[2000].expiring[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています{nl} {nl}" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d{nl} {nl}"
        icon_text = string.format(fmt, item_cls.Icon, count)
    end
    local tooltip_low = g.lang == "Japanese" and
                            "{ol}優先順位{nl}1.期限付き{nl}2.期限なし{nl}3.{img icon_item_Tos_Event_Coin 20 20}チケット(買って使います)" or
                            "{ol}Priority{nl}1.Expiring{nl}2.Non-expiring{nl}3.{img icon_item_Tos_Event_Coin 20 20}tickets(buy and use)"
    ticket_low:SetText(text_low)
    ticket_low:SetTextTooltip(icon_text .. tooltip_low)
    ticket_low:SetEventScript(ui.LBUTTONUP, "Indun_panel_item_use_sin")
    ticket_low:SetEventScriptArgNumber(ui.LBUTTONUP, low_indun_type)
    local high_indun_type = 2001
    local btn_high = indun_panel:CreateOrGetControl('button', "btn_high" .. indun_type, x + 195, y, 50, 30)
    AUTO_CAST(btn_high)
    btn_high:SetText("{ol}540")
    btn_high:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_singularity")
    btn_high:SetEventScriptArgNumber(ui.LBUTTONUP, high_indun_type)
    local count_high = indun_panel:CreateOrGetControl("richtext", "count_high" .. indun_type, x + 250, y + 5, 30, 30)
    count_high:SetText("{ol}(" .. Indun_panel_get_entrance_count(high_indun_type, 4) .. ")")
    local ticket_high_tos = indun_panel:CreateOrGetControl('button', 'ticket_high_tos' .. indun_type, x + 280, y, 100,
        30)
    AUTO_CAST(ticket_high_tos)
    local text_high_tos = string.format("{ol}{#EE7800}USEor{s16}{img %s 15 15}{#FFFFFF}%s", "icon_item_Tos_Event_Coin",
        Indun_panel_get_recipe_trade_count("EVENT_TOS_WHOLE_SHOP_319") or 0)
    local count = Indun_panel_get_invitem_count(SINGULARITY_CONFIG[2001].expiring)
    count = count + Indun_panel_get_invitem_count(SINGULARITY_CONFIG[2001].non_expiring)
    local icon_text_high = ""
    local item_cls = GetClassByType('Item', SINGULARITY_CONFIG[2001].expiring[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています{nl} {nl}" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d{nl} {nl}"
        icon_text_high = string.format(fmt, item_cls.Icon, count)
    end
    local tooltip_high_tos = g.lang == "Japanese" and
                                 "{ol}優先順位{nl}1.24時間以内の期限付きチケット{nl}2.期限付きチケット{nl}3.{img icon_item_Tos_Event_Coin 20 20}チケット(買って使います){nl}4.期限の無いチケット" or
                                 "{ol}Priority{nl}1.Limited-time tickets (under 24 hours){nl}2.Limited-time tickets{nl}3.{img icon_item_Tos_Event_Coin 20 20}tickets(buy and use){nl}4.Tickets without an expiration date"
    ticket_high_tos:SetText(text_high_tos)
    ticket_high_tos:SetTextTooltip(icon_text_high .. tooltip_high_tos)
    ticket_high_tos:SetEventScript(ui.LBUTTONUP, "Indun_panel_item_use_sin")
    ticket_high_tos:SetEventScriptArgString(ui.LBUTTONUP, "tos")
    ticket_high_tos:SetEventScriptArgNumber(ui.LBUTTONUP, high_indun_type)
    local ticket_high_pvp = indun_panel:CreateOrGetControl('button', 'ticket_high_pvp' .. indun_type, x + 390, y, 140,
        30)
    AUTO_CAST(ticket_high_pvp)
    local text_high_pvp = string.format("{ol}{#FFFFFF}{s16}USEor{img %s 18 18}d:%s w:%s", "pvpmine_shop_btn_total",
        Indun_panel_get_recipe_trade_count("PVP_MINE_41") or 0, Indun_panel_get_recipe_trade_count("PVP_MINE_42") or 0)
    local tooltip_high_pvp = g.lang == "Japanese" and
                                 "{ol}優先順位{nl}1.24時間以内の期限付きチケット{nl}2.期限付きチケット{nl}3.{img pvpmine_shop_btn_total 20 20}チケット(買って使います){nl}4.期限の無いチケット" or
                                 "{ol}Priority{nl}1.Limited-time tickets (under 24 hours){nl}2.Limited-time tickets{nl}3.{img pvpmine_shop_btn_total 20 20}tickets(buy and use){nl}4.Tickets without an expiration date"
    ticket_high_pvp:SetText(text_high_pvp)
    ticket_high_pvp:SetTextTooltip(icon_text_high .. tooltip_high_pvp)
    ticket_high_pvp:SetEventScript(ui.LBUTTONUP, "Indun_panel_item_use_sin")
    ticket_high_pvp:SetEventScriptArgString(ui.LBUTTONUP, "pvp")
    ticket_high_pvp:SetEventScriptArgNumber(ui.LBUTTONUP, high_indun_type)
    local singularity_check = indun_panel:CreateOrGetControl("checkbox", "singularity_check", x + 545, y, 25, 25)
    AUTO_CAST(singularity_check)
    singularity_check:SetEventScript(ui.LBUTTONUP, "Indun_panel_ischecked")
    singularity_check:SetTextTooltip(g.lang == "Japanese" and
                                         "{ol}チェックをすると自動マッチングボタンを押しません" or
                                         "{ol}If checked, the automatic matching button will not be pressed")
    singularity_check:SetCheck(g.indun_panel_settings.etc.singularity_check)
end

function Indun_panel_item_use_sin(frame, ctrl, mode, indun_type)
    local ent_count = Indun_panel_get_entrance_count(indun_type, 4)
    if tonumber(ent_count) > 0 then
        return
    end
    local config = SINGULARITY_CONFIG[indun_type]
    if not config then
        return
    end
    if Indun_panel_try_use_ticket_list(config.expiring, indun_type) then
        return
    end
    if mode == "tos" or indun_type == 2000 then
        local recipe = (indun_type == 2000) and "EVENT_TOS_WHOLE_SHOP_314" or "EVENT_TOS_WHOLE_SHOP_319"
        if Indun_panel_get_recipe_trade_count(recipe) >= 1 then
            Indun_panel_item_buy_use(recipe)
            ReserveScript(string.format("Indun_panel_enter_singularity(nil,nil,'', %d)", indun_type), 1.5)
            return
        end
    elseif mode == "pvp" then
        if Indun_panel_get_recipe_trade_count("PVP_MINE_41") >= 1 then
            Indun_panel_item_buy_use("PVP_MINE_41")
            ReserveScript(string.format("Indun_panel_enter_singularity(nil,nil,'', %d)", indun_type), 1.5)
            return
        end
        if Indun_panel_get_recipe_trade_count("PVP_MINE_42") >= 1 then
            Indun_panel_item_buy_use("PVP_MINE_42")
            ReserveScript(string.format("Indun_panel_enter_singularity(nil,nil,'', %d)", indun_type), 1.5)
            return
        end
    end
    if Indun_panel_try_use_ticket_list(config.non_expiring, indun_type) then
        return
    end
end

function Indun_panel_try_use_ticket_list(ticket_ids, indun_type)
    local candidate_tickets = {}
    for _, classid in ipairs(ticket_ids) do
        local inv_item = session.GetInvItemByType(classid)
        if inv_item then
            if not inv_item.isLockState then
                local item_obj = GetIES(inv_item:GetObject())
                local life_time = tonumber(GET_REMAIN_ITEM_LIFE_TIME(item_obj)) or 0
                local priority = (life_time > 0 and life_time < 86400) and 1 or 2
                table.insert(candidate_tickets, {
                    use_item = inv_item,
                    priority = priority
                })
            else
                ui.SysMsg(ClMsg("MaterialItemIsLock") .. " (" .. inv_item.Name .. ")")
            end
        end
    end
    if #candidate_tickets > 0 then
        table.sort(candidate_tickets, function(a, b)
            return a.priority < b.priority
        end)
        local best_ticket = candidate_tickets[1].use_item
        Indun_panel_item_use_and_run(best_ticket, indun_type)
        return true
    end
    return false
end

function Indun_panel_item_use_and_run(use_item, indun_type)
    AnsGiveUpPrevPlayingIndun(1)
    if use_item and indun_type then
        INV_ICON_USE(use_item)
        ReserveScript(string.format("Indun_panel_enter_singularity(nil,nil,'', %d)", indun_type), 0.5)
        return
    end
end

function Indun_panel_enter_singularity(frame, ctrl, str, indun_type)
    ReqChallengeAutoUIOpen(indun_type)
    local indun_cls = GetClassByType('Indun', indun_type)
    if indun_cls then
        local indun_min_rank = TryGetProp(indun_cls, 'PCRank')
        local totaljobcount = session.GetPcTotalJobGrade()
        if indun_min_rank then
            if indun_min_rank > totaljobcount and indun_min_rank ~= totaljobcount then
                ui.SysMsg(ScpArgMsg('IndunEnterNeedPCRank', 'NEED_RANK', indun_min_rank))
                return
            end
        end
        if g.indun_panel_settings.etc.singularity_check == 0 then
            ReserveScript(string.format("ReqMoveToIndun(%d,%d)", 2, 0), 0.3)
        end
    end
end

local raid_tbl = {
    [729] = {11210061, 11210062, 11210063},
    [725] = {11210057, 11210056, 11210055},
    [722] = {11210053, 11210052, 11210051},
    [716] = {11210044, 10820040, 11210043, 11210042},
    [707] = {11210024, 11210023, 11210022},
    [710] = {11210028, 11210027, 11210026},
    [695] = {11200356, 11200355, 11200354},
    [688] = {11200290, 10820036, 11200289, 11200288},
    [685] = {11200281, 10820035, 11200280, 11200279},
    [679] = {108020026, 11200222, 11200221, 11200220}
}
local buff_ids = {
    [729] = 80047, -- ズメイ
    [725] = 80045, -- ベリオラ
    [722] = 80043, -- ライマラ
    [716] = 80039, -- レダニア
    [707] = 80035, -- ネリンガ
    [710] = 80037, -- ゴーレム
    [673] = 80016, -- スプレッダー
    [676] = 80017, -- ファロウス
    [679] = 80015, -- ロゼ
    [685] = 80030, -- 蝶々
    [688] = 80031, -- スロガ
    [695] = 80032 -- メレジ
}

function Indun_panel_create_frame_onsweep(indun_panel, key, sub_key, sub_value, y, x)
    if raid_tbl[sub_value] then
        local use_btn = indun_panel:CreateOrGetControl('button', key .. "use", x + 470, y, 80, 30)
        AUTO_CAST(use_btn)
        use_btn:SetText("{ol}{#EE7800}USE")
        local count = Indun_panel_get_invitem_count(raid_tbl[sub_value])
        local item_cls = GetClassByType('Item', raid_tbl[sub_value][2])
        if item_cls then
            local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています" or
                            "{ol}{img %s 25 25 } Quantity in Inventory: %d"
            use_btn:SetTextTooltip(string.format(fmt, item_cls.Icon, count))
        end
        use_btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_raid_itemuse")
        use_btn:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
    end
    local btn_solo = indun_panel:CreateOrGetControl('button', key .. "solo", x, y, 80, 30)
    local btn_auto = indun_panel:CreateOrGetControl('button', key .. "auto", x + 85, y, 80, 30)
    local btn_hard = indun_panel:CreateOrGetControl('button', key .. "hard", x + 215, y, 80, 30)
    local btn_sweep = indun_panel:CreateOrGetControl('button', key .. "sweep", x + 350, y, 80, 30)
    local txt_count = indun_panel:CreateOrGetControl("richtext", key .. "count", x + 170, y + 5, 50, 30)
    local txt_hard_count = indun_panel:CreateOrGetControl("richtext", key .. "counthard", x + 300, y + 5, 50, 30)
    local txt_sweep_count = indun_panel:CreateOrGetControl("richtext", key .. "sweepcount", x + 435, y + 5, 50, 30)
    btn_solo:SetText("{ol}SOLO")
    btn_auto:SetText("{ol}{#FFD900}AUTO")
    btn_hard:SetText("{ol}{#FF0000}HARD")
    btn_sweep:SetText("{ol}{#00FF00}ACLEAR")
    if sub_key == "s" then -- Solo
        txt_count:SetText(Indun_panel_get_entrance_count(sub_value, 2))
        btn_solo:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_solo")
        btn_solo:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
    elseif sub_key == "a" then -- Auto
        btn_auto:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_auto")
        btn_auto:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
        btn_sweep:SetEventScript(ui.LBUTTONUP, "Indun_panel_raid_itemuse")
        btn_sweep:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
        btn_sweep:SetEventScriptArgString(ui.LBUTTONUP, "SWEEP")
    elseif sub_key == "h" then -- Hard
        local ent_count = Indun_panel_get_entrance_count(sub_value, 2)
        if ent_count then
            txt_hard_count:SetText(ent_count)
            btn_hard:SetEventScript(ui.LBUTTONDOWN, "Indun_panel_enter_hard")
            btn_hard:SetEventScriptArgNumber(ui.LBUTTONDOWN, sub_value)
            btn_hard:SetEventScriptArgString(ui.LBUTTONDOWN, "false")
        end
    elseif sub_key == "ac" then -- Auto Clear (Sweep) Count
        local count_str = Indun_panel_sweep_count(sub_value)
        txt_sweep_count:SetText(string.format("{ol}{#FFFFFF}{s16}(%s)", count_str))
    end
end

function Indun_panel_raid_itemuse(indun_panel, ctrl, str, indun_type)
    local target_items = raid_tbl[indun_type]
    local buff_id = buff_ids[indun_type]
    if not buff_id then
        return
    end
    local indun_cls = GetClassByType("Indun", indun_type)
    local enter_count = 0
    if indun_cls then
        enter_count = GET_CURRENT_ENTERANCE_COUNT(indun_cls.PlayPerResetType) or 0
    end
    local limit_count = 2
    if indun_type == 673 or indun_type == 676 then
        limit_count = 4
    end
    local is_limit_reached = (enter_count >= limit_count)
    local sweep_count = Indun_panel_sweep_count(buff_id)
    if sweep_count == 0 and str == "SWEEP" then
        ui.SysMsg(g.lang == "Japanese" and "掃討バフがありません" or "There is no auto clear buff")
        return
    end
    local ticket_item = nil
    if target_items then
        for _, class_id in ipairs(target_items) do
            local inv_item = session.GetInvItemByType(class_id)
            if inv_item then
                ticket_item = inv_item
                break
            end
        end
    end
    if sweep_count > 0 then
        if not is_limit_reached then
            ReqUseRaidAutoSweep(indun_type)
        else
            if ticket_item then
                INV_ICON_USE(ticket_item)
                ReserveScript(string.format("ReqUseRaidAutoSweep(%d)", indun_type), 0.5)
            else
                ui.SysMsg(g.lang == "Japanese" and "入場回数不足（チケットなし）" or
                              "Not enough entry count (No tickets).")
            end
        end
    else
        if ticket_item then
            INV_ICON_USE(ticket_item)
        else
            if string.find(ctrl:GetName(), "use") then
                ui.SysMsg(g.lang == "Japanese" and "(自動マッチング/1人)入場券を持っていません" or
                              "There are no ticket items in inventory")
            else
                ui.SysMsg(g.lang == "Japanese" and "掃討バフがありません" or "There is no auto clear buff")
            end
        end
    end
end

function Indun_panel_sweep_count(buff_id)
    local my_handle = session.GetMyHandle()
    local buff = info.GetBuff(my_handle, buff_id)
    if buff then
        return buff.over or 0
    end
    return 0
end

function Indun_panel_enter_solo(indun_panel, ctrl, str, indun_type)
    local pcparty = session.party.GetPartyInfo()
    if not pcparty then
        CREATE_PARTY_BTN()
    end
    ReqRaidAutoUIOpen(indun_type)
    ReserveScript(string.format("ReqMoveToIndun(%d,%d)", 1, 0), 0.3)
end

function Indun_panel_enter_auto(indun_panel, ctrl, str, indun_type)
    ReqRaidAutoUIOpen(indun_type)
    local indun_cls = GetClassByType('Indun', indun_type)
    if indun_cls then
        local indun_min_rank = TryGetProp(indun_cls, 'PCRank')
        local totaljobcount = session.GetPcTotalJobGrade()
        if indun_min_rank ~= nil then
            if indun_min_rank > totaljobcount and indun_min_rank ~= totaljobcount then
                ui.SysMsg(ScpArgMsg('IndunEnterNeedPCRank', 'NEED_RANK', indun_min_rank))
                return
            end
        end
        ReserveScript(string.format("ReqMoveToIndun(%d,%d)", 2, 0), 0.3)
    end
end

local function Indun_panel_induninfo_set_buttons(indun_type, ctrl)
    local indun_cls = GetClassByType('Indun', indun_type)
    if indun_cls then
        local dungeon_type = TryGetProp(indun_cls, "DungeonType", "None")
        local btn_info_cls = GetClassByStrProp("IndunInfoButton", "DungeonType", dungeon_type)
        if dungeon_type == "Raid" then
            btn_info_cls = INDUNINFO_SET_BUTTONS_FIND_CLASS(indun_cls)
        end
        local red_button_scp = TryGetProp(btn_info_cls, "RedButtonScp")
        ctrl:SetUserValue('MOVE_INDUN_CLASSID', indun_cls.ClassID)
        ctrl:SetEventScript(ui.LBUTTONUP, red_button_scp)
    end
end

function Indun_panel_enter_hard(indun_panel, ctrl, str, indun_type)
    local indun_cls = GetClassByType("Indun", indun_type)
    if str == "false" then
        Indun_panel_induninfo_set_buttons(indun_type, ctrl)
        str = "true"
        if indun_type then
            ReserveScript(string.format("Indun_panel_enter_hard(nil,nil,'%s',%d)", str, indun_type), 0.5)
            return
        end
    else
        SHOW_INDUNENTER_DIALOG(indun_type)
        return
    end
end

function Indun_panel_create_frame(indun_panel, key, sub_key, sub_value, y, x)
    local btn_solo = indun_panel:CreateOrGetControl('button', key .. "solo", x, y, 80, 30)
    local btn_auto = indun_panel:CreateOrGetControl('button', key .. "auto", x + 85, y, 80, 30)
    local btn_hard = indun_panel:CreateOrGetControl('button', key .. "hard", x + 215, y, 80, 30)
    local txt_count = indun_panel:CreateOrGetControl("richtext", key .. "count", x + 170, y + 5, 50, 30)
    local txt_hard_count = indun_panel:CreateOrGetControl("richtext", key .. "counthard", x + 300, y + 5, 50, 30)
    btn_solo:SetText("{ol}SOLO")
    btn_auto:SetText(key == "memory" and "{ol}{#FFD900}NORMAL" or "{ol}{#FFD900}AUTO")
    btn_hard:SetText("{ol}{#FF0000}HARD")
    if sub_key == "s" then
        local count_idx = (key == "memory") and 1 or 2
        txt_count:SetText(Indun_panel_get_entrance_count(sub_value, count_idx))
        btn_solo:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_solo")
        btn_solo:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
    elseif sub_key == "a" then
        btn_auto:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_auto")
        btn_auto:SetEventScriptArgNumber(ui.LBUTTONUP, sub_value)
    elseif sub_key == "h" then
        local count_idx
        if key == "memory" then
            count_idx = 1
        elseif key == "giltine" then
            count_idx = 1
        else
            count_idx = 2
        end
        txt_hard_count:SetText(Indun_panel_get_entrance_count(sub_value, count_idx))
        btn_hard:SetEventScript(ui.LBUTTONDOWN, "Indun_panel_enter_hard")
        btn_hard:SetEventScriptArgNumber(ui.LBUTTONDOWN, sub_value)
        btn_hard:SetEventScriptArgString(ui.LBUTTONDOWN, "false")
    end
end

local TELHARSHA_CONFIG = {
    recipe = "EVENT_TOS_WHOLE_SHOP_306",
    ticket_id = 108020009,
    max_count = 3
}
function Indun_panel_telharsha_frame(indun_panel, key, value, y, x)
    local btn = indun_panel:CreateOrGetControl('button', key .. 'btn', x, y, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}IN")
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_solo")
    btn:SetEventScriptArgNumber(ui.LBUTTONUP, value)
    local count = indun_panel:CreateOrGetControl("richtext", key .. "count", x + 85, y + 5, 50, 30)
    count:SetText(Indun_panel_get_entrance_count(value, 2))
    local ticket_btn = indun_panel:CreateOrGetControl('button', key .. 'ticket_btn', x + 130, y, 80, 30)
    AUTO_CAST(ticket_btn)
    local tickets = {10820009, 11035056}
    local count = Indun_panel_get_invitem_count(tickets)
    local icon_text = ""
    local item_cls = GetClassByType('Item', tickets[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d"
        icon_text = string.format(fmt, item_cls.Icon, count)
    end
    ticket_btn:SetTextTooltip(icon_text)
    ticket_btn:SetText("{ol}{#EE7800}{s14}BUYUSE")
    ticket_btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_buyuse_telharsha")
    ticket_btn:SetEventScriptArgString(ui.LBUTTONUP, TELHARSHA_CONFIG.recipe)
    ticket_btn:SetEventScriptArgNumber(ui.LBUTTONUP, value)
    local change_count = Indun_panel_get_recipe_trade_count(TELHARSHA_CONFIG.recipe)
    local tos_shop_count = indun_panel:CreateOrGetControl("richtext", key .. "tos_shop_count", x + 215, y + 5, 40, 30)
    tos_shop_count:SetText(string.format("{ol}{s16}({img icon_item_Tos_Event_Coin 15 15}%s)", change_count))
end

function Indun_panel_buyuse_telharsha(indun_panel, ctrl, recipe_name, indun_type)
    if not indun_type then
        return
    end
    local indun_cls = GetClassByType("Indun", indun_type)
    if not indun_cls then
        return
    end
    local current_count = 0
    if indun_cls then
        current_count = GET_CURRENT_ENTERANCE_COUNT(indun_cls.PlayPerResetType) or 0
    end
    if tonumber(current_count) < TELHARSHA_CONFIG.max_count then
        ReserveScript(string.format("Indun_panel_enter_solo(nil, nil, '', %d)", indun_type), 0.2)
        return
    end
    local use_item = session.GetInvItemByType(TELHARSHA_CONFIG.ticket_id)
    if use_item then
        INV_ICON_USE(use_item)
        ReserveScript(string.format("Indun_panel_enter_solo(nil, nil, '', %d)", indun_type), 0.5)
        return
    end
    local change_count = Indun_panel_get_recipe_trade_count(recipe_name)
    if change_count >= 1 then
        Indun_panel_item_buy_use(recipe_name)
        ReserveScript(string.format("Indun_panel_enter_solo(nil, nil, '', %d)", indun_type), 1.5)
        return
    end
    local msg = g.lang == "Japanese" and "トレード回数が足りません。" or "No trade count."
    ui.SysMsg(msg)
end

local VELNICE_CONFIG = {
    recipe = "PVP_MINE_52",
    tickets = {11030169, 11030257}, -- 優先順: 1日期限 -> 通常
    max_count = 1
}
function Indun_panel_velnice_frame(indun_panel, key, value, y, x)
    local btn = indun_panel:CreateOrGetControl('button', key .. 'btn', x, y, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}IN")
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_velnice_solo")
    btn:SetEventScriptArgNumber(ui.LBUTTONUP, value)
    local count = indun_panel:CreateOrGetControl("richtext", key .. "count", x + 85, y + 5, 50, 30)
    count:SetText(Indun_panel_get_entrance_count(value, 2))
    local ticket_btn = indun_panel:CreateOrGetControl('button', key .. 'ticket_btn', x + 130, y, 80, 30)
    AUTO_CAST(ticket_btn)
    local count = Indun_panel_get_invitem_count(VELNICE_CONFIG.tickets)
    local icon_text = ""
    local item_cls = GetClassByType('Item', VELNICE_CONFIG.tickets[1])
    if item_cls then
        local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています" or
                        "{ol}{img %s 25 25 } Quantity in Inventory: %d"
        icon_text = string.format(fmt, item_cls.Icon, count)
    end
    ticket_btn:SetTextTooltip(icon_text)
    ticket_btn:SetText("{ol}{#EE7800}{s14}BUYUSE")
    ticket_btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_buyuse_vel")
    ticket_btn:SetEventScriptArgString(ui.LBUTTONUP, VELNICE_CONFIG.recipe)
    ticket_btn:SetEventScriptArgNumber(ui.LBUTTONUP, value)
    local trade_count = Indun_panel_get_recipe_trade_count(VELNICE_CONFIG.recipe)
    trade_count = math.max(0, trade_count)
    local overbuy_limit = Indun_panel_overbuy_count(VELNICE_CONFIG.recipe)
    local change_text = indun_panel:CreateOrGetControl("richtext", key .. "change_text", x + 215, y + 5, 60, 30)
    change_text:SetText(string.format("{ol}{#FFFFFF}(%d/%d)", trade_count, overbuy_limit))
    local amount = indun_panel:CreateOrGetControl("richtext", key .. "amount", x + 280, y + 5, 50, 30)
    local cost = Indun_panel_overbuy_amount(VELNICE_CONFIG.recipe)
    local color = (trade_count > 0) and "{#FFFFFF}" or "{#FF0000}"
    local amount_str = string.format("{ol}{#FFFFFF}({img pvpmine_shop_btn_total 20 20}%s%s{ol}{#FFFFFF})", color,
        GET_COMMAED_STRING(cost))
    amount:SetText(amount_str)
end

function Indun_panel_buyuse_vel(indun_panel, ctrl, recipe_name, indun_type)
    if not indun_type then
        return
    end
    local indun_cls = GetClassByType("Indun", indun_type)
    if not indun_cls then
        return
    end
    local current_count = 0
    if indun_cls then
        current_count = GET_CURRENT_ENTERANCE_COUNT(indun_cls.PlayPerResetType) or 0
    end
    local reserve_script = string.format("Indun_panel_enter_velnice_solo(nil, nil, '', %d)", indun_type)
    if tonumber(current_count) < VELNICE_CONFIG.max_count then
        ReserveScript(reserve_script, 0.2)
        return
    end
    for _, ticket_id in ipairs(VELNICE_CONFIG.tickets) do
        local use_item = session.GetInvItemByType(ticket_id)
        if use_item then
            INV_ICON_USE(use_item)
            ReserveScript(reserve_script, 1.0)
            return
        end
    end
    local trade_count = Indun_panel_get_recipe_trade_count(recipe_name)
    local overbuy_limit = Indun_panel_overbuy_count(recipe_name)
    if trade_count >= 1 or overbuy_limit > 0 then
        Indun_panel_item_buy_use(recipe_name)
        ReserveScript(reserve_script, 1.5)
        return
    else
        ui.SysMsg(g.lang == "Japanese" and "トレード回数が足りません。" or "No trade count.")
        return
    end
end

function Indun_panel_enter_velnice_solo(indun_panel, ctrl, str, indun_type)
    local indun_cls = GetClassByType("Indun", indun_type)
    if not indun_cls then
        return
    end
    local account_obj = GetMyAccountObj()
    if account_obj then
        local stage = TryGetProp(account_obj, "SOLO_DUNGEON_MINI_CLEAR_STAGE", 0)
        local yes_scp = "INDUNINFO_MOVE_TO_SOLO_DUNGEON_PRECHECK"
        local title = ScpArgMsg("Select_Stage_SoloDungeon", "Stage", stage + 5)
        INDUN_EDITMSGBOX_FRAME_OPEN(indun_type, title, "", yes_scp, "", 1, stage + 5, 1)
    end
end

local DUNGEON_TICKET_CONFIG = {
    [684] = { -- (嘆きの墓地)
        label = "490",
        tickets = {11200276, 11200275, 11200274}
    },
    [728] = { --  (アシャーク)
        label = "540",
        tickets = {11200486, 11200485, 11200484}
    }
}
function Indun_panel_create_common_ticket_frame(indun_panel, key, indun_type, y, x)
    local config = DUNGEON_TICKET_CONFIG[indun_type]
    if not config then
        return
    end
    local btn = indun_panel:CreateOrGetControl('button', key .. 'btn', x, y, 80, 30)
    AUTO_CAST(btn)
    btn:SetText("{ol}" .. config.label)
    btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_enter_solo")
    btn:SetEventScriptArgNumber(ui.LBUTTONUP, indun_type)
    local count_text = indun_panel:CreateOrGetControl("richtext", key .. "count", x + 85, y + 5, 50, 30)
    count_text:SetText(Indun_panel_get_entrance_count(indun_type, 1))
    local ticket_btn = indun_panel:CreateOrGetControl('button', key .. 'ticket_btn', x + 115, y, 80, 30)
    AUTO_CAST(ticket_btn)
    ticket_btn:SetText("{ol}{#EE7800}{s14}USE")
    local inv_count = 0
    for _, id in ipairs(config.tickets) do
        local inv_item = session.GetInvItemByType(id)
        if inv_item then
            inv_count = inv_count + inv_item.count
        end
    end
    if #config.tickets > 0 then
        local item_cls = GetClassByType('Item', config.tickets[1])
        if item_cls then
            local fmt = g.lang == "Japanese" and "{ol}{img %s 25 25 } %d枚持っています" or
                            "{ol}{img %s 25 25 } Quantity in Inventory: %d"
            ticket_btn:SetTextTooltip(string.format(fmt, item_cls.Icon, inv_count))
        end
    end
    ticket_btn:SetEventScript(ui.LBUTTONUP, "Indun_panel_item_use")
    ticket_btn:SetEventScriptArgNumber(ui.LBUTTONUP, indun_type)
end

function Indun_panel_cemetery_frame(indun_panel, key, indun_type, y, x)
    Indun_panel_create_common_ticket_frame(indun_panel, key, indun_type, y, x)
end

function Indun_panel_demonlair_frame(indun_panel, key, indun_type, y, x)
    Indun_panel_create_common_ticket_frame(indun_panel, key, indun_type, y, x)
end

function Indun_panel_item_use(indun_panel, ctrl, str, indun_type)
    local config = DUNGEON_TICKET_CONFIG[indun_type]
    if not config then
        return
    end
    for _, classid in ipairs(config.tickets) do
        local use_item = session.GetInvItemByType(classid)
        if use_item then
            INV_ICON_USE(use_item)
            return
        end
    end
end

function Indun_panel_jsr_frame(indun_panel, y, x)
    local jsrbtn = indun_panel:CreateOrGetControl('button', 'jsrbtn', x, y, 80, 30)
    AUTO_CAST(jsrbtn)
    jsrbtn:SetText("{ol}JSR")
    jsrbtn:SetEventScript(ui.LBUTTONUP, "FIELD_BOSS_JOIN_ENTER_CLICK")
    jsrbtn:SetUserValue("BASE_X", x)
    jsrbtn:SetUserValue("BASE_Y", y)
    Indun_panel_field_boss_enter_timer_setting(jsrbtn)
    jsrbtn:RunUpdateScript("Indun_panel_field_boss_enter_timer_setting", 1.0)
end

local function format_jsr_time(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local seconds_rem = seconds % 60

    local jp = string.format("%d時間%d分%d秒", hours, minutes, seconds_rem)
    local en = string.format("%02d:%02d:%02d", hours, minutes, seconds_rem)
    return jp, en
end

function Indun_panel_field_boss_enter_timer_setting(ctrl)
    local frame = ctrl:GetTopParentFrame()
    if not frame then
        return 0
    end
    local server_time_str = date_time.get_lua_now_datetime_str()
    if not server_time_str then
        return 1
    end
    local _, _, _, hour_str, min_str, sec_str = server_time_str:match("(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)")
    if not hour_str then
        return 1
    end
    local today_sec = tonumber(hour_str) * 3600 + tonumber(min_str) * 60 + tonumber(sec_str)
    local sec12 = 12 * 3600
    local sec22 = 22 * 3600
    local diff12 = sec12 - today_sec
    local diff22 = sec22 - today_sec
    local text_str = ""
    local is_en = (g.indun_panel_settings.etc.en_ver == 1) -- 設定参照先を修正
    if diff12 >= 0 then
        local jp, en = format_jsr_time(diff12)
        text_str = is_en and (en .. " After Start") or (jp .. ClMsg("After_Start"))
    elseif diff12 >= -300 then
        local jp, en = format_jsr_time(300 + diff12)
        text_str = is_en and (en .. " After Exit") or (jp .. ClMsg("After_Exit"))
    elseif diff22 >= 0 then
        local jp, en = format_jsr_time(diff22)
        text_str = is_en and (en .. " After Start") or (jp .. ClMsg("After_Start"))
    elseif diff22 >= -300 then
        local jp, en = format_jsr_time(300 + diff22)
        text_str = is_en and (en .. " After Exit") or (jp .. ClMsg("After_Exit"))
    else
        text_str = is_en and "Already Exit" or ClMsg("Already_Exit")
    end
    local x = ctrl:GetUserIValue("BASE_X")
    local y = ctrl:GetUserIValue("BASE_Y")
    local jsrtime = frame:CreateOrGetControl("richtext", "jsrtime", x + 85, y + 5, 10, 10)
    jsrtime:SetText("{ol}" .. text_str)
    if x == 0 then
        jsrtime:ShowWindow(0)
    else
        jsrtime:ShowWindow(1)
    end
    return 1
end
-- indun_panel ここまで

-- cc_helper ここから
g.cc_helper_item_keys = {"seal", "ark", "leg", "god", "hair1", "hair2", "hair3", "gem1", "gem2", "gem3", "gem4", "pet",
                         "core", "relic"}
function Cc_helper_save_settings()
    g.save_lua(g.cc_helper_path, g.cc_helper_settings)
end

function Cc_helper_missing_char_data(char_data)
    if not char_data.items then
        char_data.items = {}
    end
    char_data.agm = char_data.agm or 0
    char_data.agm_check = char_data.agm_check or 0
    char_data.mcc = char_data.mcc or 0
    if not char_data.name then
        char_data.name = "Unknown"
    end
    for _, key in ipairs(g.cc_helper_item_keys) do
        if not char_data.items[key] then
            char_data.items[key] = {
                iesid = "",
                clsid = 0,
                option = "",
                rank = "",
                image = ""
            }
        end
    end
end

function Cc_helper_load_settings()
    g.cc_helper_path = string.format("../addons/%s/%s/cc_helper.lua", addon_name_lower, g.active_id)
    local json_path = string.format("../addons/%s/%s/cc_helper.json", addon_name_lower, g.active_id)
    local settings = g.load_lua(g.cc_helper_path)
    local need_save = false
    local ver = 1.2
    if not settings then
        settings = g.load_json(json_path)
        if settings then
            need_save = true -- JSONから移行したので保存が必要
        end
    end
    if not settings then
        settings = {
            etc = {
                eco = 0,
                agm_stop = 0,
                wh_close = 0,
                copys = {}
            },
            ver = ver
        }
        local old_copy_path = string.format("../addons/%s/%s/%s_copy.json", "cc_helper", g.active_id, g.active_id)
        local copy_settings = g.load_json(old_copy_path)
        if copy_settings then
            local item_key_map = {}
            for _, key in ipairs(g.cc_helper_item_keys) do
                item_key_map[key] = true
            end
            for cid, char_data in pairs(copy_settings) do
                if type(char_data) == "table" and next(char_data) then
                    if not settings.etc.copys[cid] then
                        settings.etc.copys[cid] = {
                            items = {}
                        }
                    end
                    for key, value in pairs(char_data) do
                        if type(value) == "table" then
                            if item_key_map[key] then
                                settings.etc.copys[cid].items[key] = {}
                                for k, v in pairs(value) do
                                    if k == "memo" then
                                        local result = StringSplit(v, ":::")
                                        if #result > 0 then
                                            if string.find(key, "hair") then
                                                settings.etc.copys[cid].items[key].rank = result[#result]
                                                table.remove(result, #result)
                                                settings.etc.copys[cid].items[key].option = table.concat(result, ":::")
                                            elseif key == "pet" then
                                                settings.etc.copys[cid].items[key].option = result[#result]
                                            end
                                        end
                                    elseif k ~= "skin" then
                                        settings.etc.copys[cid].items[key][k] = v
                                    end
                                end
                            end
                        else
                            settings.etc.copys[cid][key] = value
                        end
                    end
                    Cc_helper_missing_char_data(settings.etc.copys[cid])
                end
            end
        end
        need_save = true
    end
    if not settings.ver or settings.ver < ver then
        settings.ver = ver
        need_save = true
    end
    if not settings.etc then
        settings.etc = {}
    end
    if settings.etc.eco == nil then
        settings.etc.eco = 0
    end
    if settings.etc.agm_stop == nil then
        settings.etc.agm_stop = 0
    end
    if settings.etc.wh_close == nil then
        settings.etc.wh_close = 0
    end
    if not settings.etc.copys then
        settings.etc.copys = {}
    end
    for key, val in pairs(settings) do
        if tonumber(key) and type(val) == "table" then
            Cc_helper_missing_char_data(val)
        end
    end
    for _, val in pairs(settings.etc.copys) do
        if type(val) == "table" then
            Cc_helper_missing_char_data(val)
        end
    end
    g.cc_helper_settings = settings
    if need_save then
        Cc_helper_save_settings()
    end
end

function Cc_helper_char_load_settings()
    local settings = g.cc_helper_settings
    if not settings[g.cid] then
        settings[g.cid] = {
            agm = 0,
            agm_check = 0,
            mcc = 0,
            items = {},
            name = g.login_name
        }
    end
    Cc_helper_missing_char_data(settings[g.cid])
    Cc_helper_save_settings()
end

function Cc_helper_ensure_settings_loaded()
    if not g.cc_helper_settings then
        Cc_helper_load_settings()
    end
    if not g.cc_helper_settings[g.cid] then
        Cc_helper_char_load_settings()
    end
end

function cc_helper_on_init()
    Cc_helper_ensure_settings_loaded()
    g.setup_hook_and_event(g.addon, "INVENTORY_OPEN", "Cc_helper_INVENTORY_OPEN", true)
    g.setup_hook_and_event(g.addon, "ACCOUNTWAREHOUSE_CLOSE", "Cc_helper_ACCOUNTWAREHOUSE_CLOSE", true)
    g.setup_hook_and_event(g.addon, "INVENTORY_CLOSE", "Cc_helper_INVENTORY_CLOSE", true)
    if g.get_map_type() == "City" then
        Cc_helper_frame_init()
        g.addon:RegisterMsg("OPEN_DLG_ACCOUNTWAREHOUSE", "Cc_helper_frame_init")
    end
    if g.settings.cc_helper.use == 0 then
        Cc_helper_ACCOUNTWAREHOUSE_CLOSE(nil, nil)
        return
    end
end

function Cc_helper_ACCOUNTWAREHOUSE_CLOSE(my_frame, my_msg)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    accountwarehouse:RemoveChild("cch_in_btn")
    accountwarehouse:RemoveChild("cch_out_btn")
    accountwarehouse:RemoveChild("cch_auto_close")
    local inventory = ui.GetFrame("inventory")
    inventory:RemoveChild("cch_in_btn") -- "setting"
    inventory:RemoveChild("cch_out_btn")
    inventory:RemoveChild("cch_setting")
    local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
    if cch_setting then
        Cc_helper_setting_frame_close(cch_setting)
    end
end

function Cc_helper_INVENTORY_OPEN(my_frame, my_msg)
    if g.settings.cc_helper.use == 0 then
        return
    end
    local inventory = ui.GetFrame("inventory")
    inventory:SetUserValue("CCH_BTN_RETRY", 0)
    inventory:RunUpdateScript("Cc_helper_inventory_btn_init_delayed", 0.1)
end

function Cc_helper_inventory_btn_init_delayed(inventory)
    local in_btn = GET_CHILD(inventory, "cch_in_btn")
    if in_btn then
        return 0
    end
    if inventory:IsVisible() == 1 then
        Cc_helper_frame_init()
        return 0
    end
    local retry = inventory:GetUserIValue("CCH_BTN_RETRY")
    if retry > 10 then
        return 0
    end
    inventory:SetUserValue("CCH_BTN_RETRY", retry + 1)
    return 1
end

function Cc_helper_INVENTORY_CLOSE()
    local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
    if cch_setting then
        Cc_helper_setting_frame_close(cch_setting)
    end
end

function Cc_helper_frame_init()
    if g.settings.cc_helper.use == 0 then
        return
    end
    Cc_helper_accountwarehouse_btn_init()
    Cc_helper_inventory_btn_init()
end

function Cc_helper_accountwarehouse_btn_init()
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local in_btn = accountwarehouse:CreateOrGetControl("button", "cch_in_btn", 565, 120, 30, 30)
    AUTO_CAST(in_btn)
    in_btn:SetText("{img in_arrow 20 20}")
    in_btn:SetEventScript(ui.LBUTTONUP, "Cc_helper_putitem")
    in_btn:SetSkinName("test_pvp_btn")
    in_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}[CCH]{nl}装備を外して倉庫へ搬入します" or
                              "{ol}[CCH]{nl}The equipment is removed{nl}and brought into the warehouse")
    in_btn:ShowWindow(1)
    local out_btn = accountwarehouse:CreateOrGetControl("button", "cch_out_btn", 595, 120, 30, 30)
    AUTO_CAST(out_btn)
    out_btn:SetText("{@st66b}{img chul_arrow 20 20}")
    out_btn:SetEventScript(ui.LBUTTONUP, "Cc_helper_take_item")
    out_btn:SetSkinName("test_pvp_btn")
    out_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}[CCH]{nl}倉庫から搬出して装備します" or
                               "{ol}[CCH]{nl}It is carried out from the warehouse and equipped")
    out_btn:ShowWindow(1)
    local auto_close = accountwarehouse:CreateOrGetControl("checkbox", "cch_auto_close", 540, 120, 30, 30)
    AUTO_CAST(auto_close)
    auto_close:ShowWindow(1)
    auto_close:SetTextTooltip(g.lang == "Japanese" and
                                  "{ol}[CCH]{nl}動作終了後倉庫とインベントリーを閉じます" or
                                  "{ol}[CCH]{nl}Closes storage and inventory after the operation is complete")
    auto_close:SetEventScript(ui.LBUTTONUP, "Cc_helper_check_settings")
    auto_close:SetCheck(g.cc_helper_settings.etc.wh_close)
    auto_close:ShowWindow(1)
end

function Cc_helper_inventory_btn_init()
    local inventory = ui.GetFrame("inventory")
    local inventory_btns = {"moncard_btn", "helper_btn", "cabinet_btn", "goddess_mgr_btn"}
    if inventory then
        for _, btn_name in ipairs(inventory_btns) do
            local btn = GET_CHILD_RECURSIVELY(inventory, btn_name)
            if btn and btn:IsVisible() == 0 then
                btn:ShowWindow(1)
            end
        end
    end
    local setting = inventory:CreateOrGetControl("button", "cch_setting", 205, 345, 30, 30)
    AUTO_CAST(setting)
    setting:SetSkinName("None")
    setting:SetText("{img config_button_normal 30 30}")
    setting:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_frame_init")
    setting:SetEventScript(ui.RBUTTONUP, "Cc_helper_toggle_settings")
    setting:SetTextTooltip(g.lang == "Japanese" and
                               "{ol}[CCH]{nl}左クリック: 設定{nl}右クリック: エコモード切替" or
                               "{ol}[CCH]{nl}Left Click: Settings{nl}Right Click: Eco Mode Toggle")
    setting:ShowWindow(1)
    local eco = setting:CreateOrGetControl("richtext", "eco", 7, 7, 30, 30)
    AUTO_CAST(eco)
    eco:SetText(g.cc_helper_settings.etc.eco == 1 and "{ol}{s10}{#FF0000}eco" or "")
    eco:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_frame_init")
    eco:SetEventScript(ui.RBUTTONUP, "Cc_helper_toggle_settings")
    eco:SetTextTooltip(g.lang == "Japanese" and
                           "{ol}[CCH]{nl}左クリック: 設定{nl}右クリック: エコモード切替" or
                           "{ol}[CCH]{nl}Left Click: Settings{nl}Right Click: Eco Mode Toggle")
    eco:ShowWindow(1)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if accountwarehouse:IsVisible() == 1 then
        local in_btn = inventory:CreateOrGetControl("button", "cch_in_btn", 235, 345, 30, 30)
        AUTO_CAST(in_btn)
        in_btn:SetText("{img in_arrow 20 20}")
        in_btn:SetEventScript(ui.LBUTTONUP, "Cc_helper_putitem")
        in_btn:SetSkinName("test_pvp_btn")
        in_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}[CCH]{nl}装備を外して倉庫へ搬入します" or
                                  "{ol}[CCH]{nl}The equipment is removed{nl}and brought into the warehouse")
        in_btn:ShowWindow(1)
        local out_btn = inventory:CreateOrGetControl("button", "cch_out_btn", 265, 345, 30, 30)
        AUTO_CAST(out_btn)
        out_btn:SetText("{@st66b}{img chul_arrow 20 20}")
        out_btn:SetEventScript(ui.LBUTTONUP, "Cc_helper_take_item")
        out_btn:SetSkinName("test_pvp_btn")
        out_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}[CCH]{nl}倉庫から搬出して装備します" or
                                   "{ol}[CCH]{nl}It is carried out from the warehouse and equipped")
        out_btn:ShowWindow(1)
    end
end

function Cc_helper_setting_frame_init(frame)
    local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
    if frame and cch_setting and cch_setting:IsVisible() == 1 then
        Cc_helper_setting_frame_close(cch_setting)
        return
    end
    Cc_helper_update_hair_stats()
    INVENTORY_SET_CUSTOM_RBTNDOWN("Cc_helper_inv_rbtn")
    cch_setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "cch_setting", 0, 0, 0, 0)
    AUTO_CAST(cch_setting)
    cch_setting:RemoveAllChild()
    cch_setting:SetSkinName("test_frame_low")
    cch_setting:SetLayerLevel(93)
    cch_setting:SetGravity(ui.RIGHT, ui.TOP)
    local rect = cch_setting:GetMargin()
    cch_setting:SetMargin(rect.left - rect.left, rect.top - rect.top + 370,
        rect.right == 0 and rect.right + 510 or rect.right, rect.bottom)
    cch_setting:Resize(310, 520)
    cch_setting:SetTitleBarSkin("None")
    cch_setting:EnableHittestFrame(1)
    local title_text = cch_setting:CreateOrGetControl("richtext", "title_text", 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}CC Helper Config")
    local close = cch_setting:CreateOrGetControl("button", "close", 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_frame_close")
    local gbox = cch_setting:CreateOrGetControl("groupbox", "gbox", 10, 40, 0, 0)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local copy = gbox:CreateOrGetControl("button", "copy", 200, 10, 70, 30)
    AUTO_CAST(copy)
    copy:SetText("{ol}copy")
    copy:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_copy")
    copy:SetTextTooltip(g.lang == "Japanese" and "{ol}コピー用の設定を適用します" or
                            "{ol}Applies the settings for copying")
    local save = gbox:CreateOrGetControl("button", "save", 130, 10, 70, 30)
    AUTO_CAST(save)
    save:SetText("{ol}save")
    save:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_save")
    save:SetTextTooltip(g.lang == "Japanese" and "{ol}このキャラの設定をコピー用に保存します" or
                            "{ol}Save this character settings for copying")
    local save_delete = gbox:CreateOrGetControl("button", "save_delete", 60, 10, 70, 30)
    AUTO_CAST(save_delete)
    save_delete:SetText("{ol}delete")
    save_delete:SetEventScript(ui.LBUTTONUP, "Cc_helper_setting_delete")
    save_delete:SetTextTooltip(g.lang == "Japanese" and "{ol}コピー用の設定を削除します" or
                                   "{ol}Delete settings for copying")
    if g.settings.monster_card_changer.use == 1 then
        local mccuse = gbox:CreateOrGetControl("checkbox", "mccuse", 10, 375, 25, 25)
        AUTO_CAST(mccuse)
        mccuse:SetText(g.lang == "Japanese" and "{ol}MCC 連携" or "{ol}MCC Linkage")
        mccuse:SetTextTooltip(g.lang == "Japanese" and
                                  "{ol}チェックを入れると[Monster Card Changer]と連携します{nl}各キャラクター個別設定" or
                                  "{ol}If checked, it will work with [Monster Card Changer]{nl}Individual Character Settings")
        mccuse:SetCheck(g.cc_helper_settings[g.cid].mcc)
        mccuse:SetEventScript(ui.LBUTTONUP, "Cc_helper_check_settings")
    else
        g.cc_helper_settings[g.cid].mcc = 0
    end
    local agmuse = gbox:CreateOrGetControl("checkbox", "agmuse", 10, 405, 25, 25)
    AUTO_CAST(agmuse)
    agmuse:SetText(g.lang == "Japanese" and "{ol}エーテルジェム" or "{ol}Aether Gem")
    agmuse:SetTextTooltip(g.lang == "Japanese" and
                              "{ol}チェックを入れるとエーテルジェムも着脱します{nl}各キャラクター個別設定" or
                              "{ol}If checked, Aethergems will also be equipped/unequipped{nl}Individual Character Settings")
    agmuse:SetEventScript(ui.LBUTTONUP, "Cc_helper_check_settings")
    agmuse:SetCheck(g.cc_helper_settings[g.cid].agm)
    local agm_on_off = gbox:CreateOrGetControl("picture", "use_toggle", agmuse:GetWidth() + 10, 405, 60, 25)
    AUTO_CAST(agm_on_off)
    agm_on_off:SetImage(g.cc_helper_settings[g.cid].agm_check == 1 and "test_com_ability_on" or "test_com_ability_off")
    agm_on_off:SetEnableStretch(1)
    agm_on_off:EnableHitTest(1)
    local tooltip_text =
        g.lang == "Japanese" and "{ol}ONにするとエーテルジェム着脱時に確認します" or
            "{ol}If ON, confirmation will be required{nl}when equipping/unequipping Aethergems"
    agm_on_off:SetTextTooltip(tooltip_text)
    agm_on_off:SetEventScript(ui.LBUTTONUP, "Cc_helper_toggle_settings")
    local all_agm = gbox:CreateOrGetControl("checkbox", "all_agm", 10, 435, 25, 25)
    AUTO_CAST(all_agm)
    all_agm:SetText(g.lang == "Japanese" and "{ol}エーテルジェム 全体停止" or "{ol}Aether Gem All Stop")
    all_agm:SetTextTooltip(g.lang == "Japanese" and
                               "{ol}チェックを入れると、全てのキャラの{nl}エーテルジェム関係の動作をストップします" or
                               "{ol}If checked, stops all ether gem-related actions for all characters")
    all_agm:SetEventScript(ui.LBUTTONUP, "Cc_helper_check_settings")
    all_agm:SetCheck(g.cc_helper_settings.etc.agm_stop) --
    local pet_select = gbox:CreateOrGetControl("button", "pet_select", 180, 375, 100, 30)
    AUTO_CAST(pet_select)
    pet_select:SetText("{ol}pet select")
    pet_select:SetEventScript(ui.LBUTTONUP, "Cc_helper_context_pet")
    gbox:Resize(cch_setting:GetWidth() - 20, cch_setting:GetHeight() - 50)
    cch_setting:ShowWindow(1)
    Cc_helper_slot_create_reserve(cch_setting, gbox)
end

function Cc_helper_slot_create_reserve(cch_setting, gbox)
    local slot_info = {
        ["seal"] = {
            x = 35,
            y = 210,
            text = "{ol}{s14}SEAL"
        },
        ["ark"] = {
            x = 90,
            y = 210,
            text = "{ol}{s14}ARK"
        },
        ["core"] = {
            x = 145,
            y = 210,
            text = "{ol}{s14}CORE"
        },
        ["relic"] = {
            x = 200,
            y = 210,
            text = "{ol}{s14}RELIC"
        },
        ["gem1"] = {
            x = 35,
            y = 320,
            text = "{ol}{s12}AETHER{nl}GEM1"
        },
        ["gem2"] = {
            x = 90,
            y = 320,
            text = "{ol}{s12}AETHER{nl}GEM2"
        },
        ["gem3"] = {
            x = 145,
            y = 320,
            text = "{ol}{s12}AETHER{nl}GEM3"
        },
        ["gem4"] = {
            x = 200,
            y = 320,
            text = "{ol}{s12}AETHER{nl}GEM4"
        },
        ["leg"] = {
            x = 30,
            y = 45,
            text = "{ol}{s14}LEGEND{nl}CARD"
        },
        ["god"] = {
            x = 140,
            y = 45,
            text = "{ol}{s14}GODDESS{nl}CARD"
        },
        ["hair1"] = {
            x = 35,
            y = 265,
            text = "{ol}{s14}HAIR1"
        },
        ["hair2"] = {
            x = 90,
            y = 265,
            text = "{ol}{s14}HAIR2"
        },
        ["hair3"] = {
            x = 145,
            y = 265,
            text = "{ol}{s14}HAIR3"
        },
        ["pet"] = {
            x = 220,
            y = 410,
            text = "{ol}{s14}PET"
        }
    }
    for key, value in pairs(slot_info) do
        for k, v in pairs(g.cc_helper_settings[g.cid].items) do
            if key == k then
                local width = 50
                local height = 50
                if key == "leg" then
                    width = 105 -- 9:13
                    height = 160
                end
                if key == "god" then
                    width = 120 -- 3:4
                    height = 160
                end
                local skin = "invenslot2"
                if key == "leg" then
                    skin = "legendopen_cardslot"
                elseif key == "god" then
                    skin = "goddess_card__activation"
                end
                Cc_helper_slot_create(gbox, key, value.x, value.y, width, height, skin, value.text, v.clsid, v.iesid,
                    v.option, v.rank, v.image)
                break
            end
        end
    end
end

function Cc_helper_slot_create(gbox, name, x, y, width, height, skin, text, clsid, iesid, option, rank, image)
    local slot = GET_CHILD(gbox, name)
    if not slot then
        slot = gbox:CreateOrGetControl("slot", name, x, y, width, height)
        AUTO_CAST(slot)
        slot:SetSkinName(skin)
        slot:SetText(text)
        slot:EnablePop(1)
        slot:EnableDrag(1)
        slot:EnableDrop(1)
    end
    AUTO_CAST(slot)
    slot:SetEventScript(ui.DROP, "Cc_helper_frame_drop")
    slot:SetEventScript(ui.RBUTTONDOWN, "Cc_helper_cancel")
    local item_cls = GetClassByType("Item", clsid)
    if not item_cls then
        item_cls = GetClassByType("Monster", clsid)
        if not item_cls then
            return
        end
        image = item_cls.Icon
    end
    if not string.find(name, "gem") then
        SET_SLOT_ITEM_CLS(slot, item_cls)
        SET_SLOT_IMG(slot, image)
        SET_SLOT_IESID(slot, iesid)
        if name ~= "leg" and name ~= "god" then
            SET_SLOT_BG_BY_ITEMGRADE(slot, item_cls)
        end
        if string.find(name, "hair") then
            if rank == "A" then
                slot:SetSkinName("invenslot_pic_goddess")
            elseif rank == "B" then
                slot:SetSkinName("invenslot_legend")
            elseif rank == "C" then
                slot:SetSkinName("invenslot_unique")
            end
        end
        local icon = slot:GetIcon()
        if not icon and item_cls then
            icon = CreateIcon(slot)
        end
        if clsid ~= 0 then
            if string.find(name, "hair") then
                if string.find(option, ":::") then
                    local text = "{ol}Rank: " .. rank .. "{nl}"
                    local result = StringSplit(option, ":::")
                    if not string.find(option, "#@!") then
                        for i = 1, 3 do
                            local op_tbl = StringSplit(result[i], "/")
                            local op_name = op_tbl[1]
                            op_name = ScpArgMsg(op_name)
                            local op_value = op_tbl[2]
                            text = text .. op_name .. ScpArgMsg("PropUp") .. GET_COMMAED_STRING(op_value) .. "{nl}"
                        end
                    else
                        text = text .. table.concat(result, "{nl}")

                    end
                    icon:SetTextTooltip(text)
                end
            elseif name == "pet" then
                icon:SetTextTooltip(option)
            else
                icon:SetTooltipType("wholeitem")
                icon:SetTooltipArg("None", clsid, iesid)
            end
        end
    end
    if string.find(name, "gem") then
        if g.cc_helper_settings[g.cid].agm == 0 then
            slot:ShowWindow(0)
        elseif g.cc_helper_settings[g.cid].agm == 1 then
            local gem_name = item_cls.ClassName
            local icon = slot:GetIcon()
            if not icon then
                icon = CreateIcon(slot)
            end
            SET_SLOT_ITEM_CLS(slot, item_cls)
            local lv_text = slot:CreateOrGetControl("richtext", "lv_text", 0, 30, 25, 25)
            AUTO_CAST(lv_text)
            if string.find(gem_name, "480") then
                lv_text:SetText("{ol}{s14}LV480")
                slot:SetSkinName("invenslot_rare")
            elseif string.find(gem_name, "500") then
                lv_text:SetText("{ol}{s14}LV500")
                slot:SetSkinName("invenslot_unique")
            elseif string.find(gem_name, "520") then
                lv_text:SetText("{ol}{s14}LV520")
                slot:SetSkinName("invenslot_legend")
            elseif string.find(gem_name, "540") then
                lv_text:SetText("{ol}{s14}LV540")
                slot:SetSkinName("invenslot_pic_goddess")
            else
                lv_text:SetText("{ol}{s14}LV460")
            end
        end
    end
end

function Cc_helper_check_settings(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "cch_auto_close" then
        g.cc_helper_settings.etc.wh_close = ctrl:IsChecked()
    elseif ctrl_name == "mccuse" then
        g.cc_helper_settings[g.cid].mcc = ctrl:IsChecked()
    elseif ctrl_name == "agmuse" then
        g.cc_helper_settings[g.cid].agm = ctrl:IsChecked()
        Cc_helper_setting_frame_init()
    elseif ctrl_name == "all_agm" then
        g.cc_helper_settings.etc.agm_stop = 1 - g.cc_helper_settings.etc.agm_stop
    end
    Cc_helper_save_settings()
end

function Cc_helper_toggle_settings(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "eco" or ctrl_name == "cch_setting" then
        local eco = GET_CHILD_RECURSIVELY(frame, "eco")
        if g.cc_helper_settings.etc.eco == 0 then
            g.cc_helper_settings.etc.eco = 1
            eco:SetText("{ol}{s10}{#FF0000}eco")
        else
            g.cc_helper_settings.etc.eco = 0
            eco:SetText("")
        end
    elseif ctrl_name == "use_toggle" then
        g.cc_helper_settings[g.cid].agm_check = 1 - g.cc_helper_settings[g.cid].agm_check
        Cc_helper_setting_frame_init()
    end
    Cc_helper_save_settings()
end

function Cc_helper_setting_frame_close(cch_setting)
    INVENTORY_SET_CUSTOM_RBTNDOWN("None")
    ui.DestroyFrame(cch_setting:GetName())
    if g.settings.another_warehouse.use == 1 then
        local awh = ui.GetFrame(addon_name_lower .. "awh")
        if awh and awh:IsVisible() == 1 then
            INVENTORY_SET_CUSTOM_RBTNDOWN("Another_warehouse_inv_rbtn")
            return
        end
    else
        local accountwarehouse = ui.GetFrame("accountwarehouse")
        if accountwarehouse:IsVisible() == 1 then
            INVENTORY_SET_CUSTOM_RBTNDOWN("ACCOUNT_WAREHOUSE_INV_RBTN")
        else
            INVENTORY_SET_CUSTOM_RBTNDOWN("None")
        end
    end
end

function Cc_helper_setting_copy()
    local title = g.lang == "Japanese" and "{ol}コピー元選択" or "{ol}Select Copy Source"
    local context = ui.CreateContextMenu("cc_helper_copy_context", title, 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "{ol}" .. "-----", "")
    for cid, char_data in pairs(g.cc_helper_settings.etc.copys) do
        local job_cls = GetClassByType("Job", char_data.jobid)
        local job_name = GET_JOB_NAME(job_cls, char_data.gender)
        local name = char_data.name
        local text = name .. " (" .. job_name .. ")"
        local scp = ui.AddContextMenuItem(context, text, string.format("Cc_helper_load_copy('%s')", cid))
    end
    ui.OpenContextMenu(context)
end

function Cc_helper_load_copy(cid)
    for key, value in pairs(g.cc_helper_settings.etc.copys[cid]) do
        if type(value) == "table" then
            g.cc_helper_settings[g.cid].items = value
        elseif key == "mcc" or key == "agm" or key == "agm_check" then
            if key == "mcc" then
                g.cc_helper_settings[g.cid].mcc = value
            elseif key == "agm" then
                g.cc_helper_settings[g.cid].agm = value
            elseif key == "agm_check" then
                g.cc_helper_settings[g.cid].agm_check = value
            end
        end
    end
    g.cc_helper_settings[g.cid].name = g.login_name
    Cc_helper_save_settings()
    ui.SysMsg(g.lang == "Japanese" and "設定をコピーしました" or "Settings copied")
    Cc_helper_setting_frame_init()
end

function Cc_helper_setting_delete(frame, ctrl)
    local title = g.lang == "Japanese" and "削除データ選択" or "Select Data to Delete"
    local context = ui.CreateContextMenu("cc_helper_delete_context", "{ol}{#FF0000}" .. title, 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "{ol}{#FF0000}" .. "-----", "")
    for cid, char_data in pairs(g.cc_helper_settings.etc.copys) do
        local job_cls = GetClassByType("Job", char_data.jobid)
        local job_name = GET_JOB_NAME(job_cls, char_data.gender)
        local name = char_data.name
        local text = "{ol}{#FF0000}" .. name .. " (" .. job_name .. ")"
        local scp = ui.AddContextMenuItem(context, text, string.format("Cc_helper_setting_delete_('%s')", cid))
    end
    ui.OpenContextMenu(context)
end

function Cc_helper_setting_delete_(cid)
    g.cc_helper_settings.etc.copys[cid] = nil
    ui.SysMsg(g.lang == "Japanese" and "設定を削除しました" or "Settings deleted")
    Cc_helper_save_settings()
end

function Cc_helper_setting_save(frame, ctrl)
    local current_char_data_str = json.encode(g.cc_helper_settings[g.cid])
    local new_copy_data = json.decode(current_char_data_str)
    g.cc_helper_settings.etc.copys[g.cid] = new_copy_data
    local pc_info = session.barrack.GetMyAccount():GetByStrCID(g.cid)
    local pc_apc = pc_info:GetApc()
    local jobid = pc_info:GetRepID() or pc_apc:GetJob()
    local gender = pc_apc:GetGender()
    g.cc_helper_settings.etc.copys[g.cid].jobid = jobid
    g.cc_helper_settings.etc.copys[g.cid].gender = gender
    ui.SysMsg(g.lang == "Japanese" and "設定を保存しました" or "Settings saved")
    Cc_helper_save_settings()
end

function Cc_helper_context_pet()
    local pet_list = session.pet.GetPetInfoVec()
    local context = ui.CreateContextMenu("PET_SELECT", "{ol}Pet Select", 400, 0, -400, 0)
    for i = 0, pet_list:size() - 1 do
        local info = pet_list:at(i)
        local obj = GetIES(info:GetObject())
        local name = info:GetName()
        local pet_iesid = info:GetStrGuid()
        local cls_name = obj.ClassName
        local cls_id = obj.ClassID
        local sin_name = obj.Name
        local cls_list, list_cnt = GetClassList("Companion")
        for index = 0, list_cnt - 1 do
            local companion_ies = GetClassByIndexFromList(cls_list, index)
            local ies_cls_name = companion_ies.ClassName
            if cls_name == ies_cls_name then
                local job_id = tonumber(companion_ies.JobID)
                if job_id ~= 3014 then
                    local option = "{ol}[LV:" .. obj.Lv .. "] " .. name .. " ( " .. dic.getTranslatedStr(obj.Name) ..
                                       " ) "
                    local companion_cls = GetClass("Companion", TryGetProp(obj, "ClassName", "None"))
                    local pet_buff = TryGetProp(companion_cls, "PetBuff", "None")
                    local buff_cls = GetClass("Buff", pet_buff)
                    if buff_cls then
                        local tool_tip = TryGetProp(buff_cls, "ToolTip", "None")
                        if tool_tip ~= "None" then
                            option = option .. "{nl}" .. dic.getTranslatedStr(tool_tip)
                        end
                    end
                    local scp = string.format("Cc_helper_context_pet_set(%d,'%s','%s')", cls_id, pet_iesid, option)
                    ui.AddContextMenuItem(context,
                        "{img " .. obj.Icon .. " 20 20}" .. "{ol} [LV:" .. obj.Lv .. "] " .. name .. " ( " ..
                            dic.getTranslatedStr(obj.Name) .. " ) ", scp)
                    break
                end
            end
        end
    end
    ui.OpenContextMenu(context)
end

function Cc_helper_context_pet_set(cls_id, pet_iesid, option)
    local mon_cls = GetClassByType("Monster", cls_id)
    local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
    local slot = GET_CHILD_RECURSIVELY(cch_setting, "pet")
    AUTO_CAST(slot)
    local image = mon_cls.Icon
    SET_SLOT_ITEM_CLS(slot, mon_cls)
    SET_SLOT_IMG(slot, image)
    SET_SLOT_IESID(slot, pet_iesid)
    g.cc_helper_settings[g.cid].items.pet.iesid = pet_iesid
    g.cc_helper_settings[g.cid].items.pet.clsid = cls_id
    g.cc_helper_settings[g.cid].items.pet.image = image
    g.cc_helper_settings[g.cid].items.pet.option = option
    Cc_helper_save_settings()
end

function Cc_helper_cancel(frame, slot)
    slot:ClearIcon()
    slot:RemoveAllChild()
    for key, value in pairs(g.cc_helper_settings[g.cid].items) do
        if slot:GetName() == key then
            value.image = ""
            value.iesid = ""
            value.clsid = 0
            value.option = ""
            if not string.find(key, "god") and not string.find(key, "leg") then
                slot:SetSkinName("invenslot2")
            end
            break
        end
    end
    Cc_helper_save_settings()
end

function Cc_helper_frame_drop(frame, ctrl)
    local lift_icon = ui.GetLiftIcon()
    local slot = lift_icon:GetParent()
    local icon_info = lift_icon:GetInfo()
    local iesid = icon_info:GetIESID()
    local inv_item = session.GetInvItemByGuid(iesid)
    local item_obj = GetIES(inv_item:GetObject())
    Cc_helper_inv_rbtn(item_obj, slot, iesid)
end

function Cc_helper_inv_rbtn(item_obj, slot, iesid, awh_item)
    local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
    if not cch_setting or cch_setting:IsVisible() == 0 then
        return
    end
    if not g.cc_helper_settings or not g.cc_helper_settings[g.cid] or not g.cc_helper_settings[g.cid].items then
        return
    end
    local gbox = GET_CHILD(cch_setting, "gbox")
    if not iesid then
        local icon = slot:GetIcon()
        local icon_info = icon:GetInfo()
        iesid = icon_info:GetIESID()
    end
    local inv_item = awh_item or session.GetInvItemByGuid(iesid)
    if not inv_item then
        return
    end
    local image = TryGetProp(item_obj, "TooltipImage", "None")
    local clsid = item_obj.ClassID
    local type = item_obj.ClassType
    local gem_type = GET_EQUIP_GEM_TYPE(item_obj)
    local parent_name = slot:GetParent():GetName()
    local char_belonging = TryGetProp(item_obj, "CharacterBelonging", 0)
    local temp_tbl = {
        ["Seal"] = "seal",
        ["Ark"] = "ark",
        ["LEG"] = "leg",
        ["GODDESS"] = "god",
        ["sset_HairAcc_Acc1"] = "hair1",
        ["sset_HairAcc_Acc2"] = "hair2",
        ["sset_HairAcc_Acc3"] = "hair3",
        ["CORE"] = "core",
        ["Relic"] = "relic",
        ["aether"] = "gem"
    }
    for key, value in pairs(temp_tbl) do
        local target_item_setting = g.cc_helper_settings[g.cid].items[value]
        if target_item_setting then
            if key == "Seal" and key == type and clsid ~= 614001 then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "Ark" and key == type and char_belonging ~= 1 then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "CORE" and key == type then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "Relic" and key == type then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "LEG" and key == item_obj.CardGroupName then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "GODDESS" and key == item_obj.CardGroupName then
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil, image)
                break
            elseif key == "sset_HairAcc_Acc1" and key == parent_name then
                local option, rank = Cc_helper_hair_option(item_obj)
                target_item_setting.rank = rank
                target_item_setting.option = option
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, option, rank, image)
                break
            elseif key == "sset_HairAcc_Acc2" and key == parent_name then
                local option, rank = Cc_helper_hair_option(item_obj)
                target_item_setting.rank = rank
                target_item_setting.option = option
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, option, rank, image)
                break
            elseif key == "sset_HairAcc_Acc3" and key == parent_name then
                local option, rank = Cc_helper_hair_option(item_obj)
                target_item_setting.rank = rank
                target_item_setting.option = option
                target_item_setting.clsid = clsid
                target_item_setting.iesid = iesid
                target_item_setting.image = image
                Cc_helper_slot_create(gbox, value, nil, nil, nil, nil, nil, nil, clsid, iesid, option, rank, image)
                break
            end
        end
        if gem_type == "aether" and key == "aether" then
            if g.cc_helper_settings[g.cid].agm == 0 then
                return
            end
            for i = 1, 4 do
                local slot_name = "gem" .. i
                local slot = GET_CHILD(gbox, slot_name)
                if slot then
                    local icon = slot:GetIcon()
                    if not icon then
                        if g.cc_helper_settings[g.cid].items[slot_name] then
                            g.cc_helper_settings[g.cid].items[slot_name].clsid = clsid
                            Cc_helper_slot_create(gbox, slot_name, nil, nil, nil, nil, nil, nil, clsid, iesid, nil, nil,
                                image)
                        end
                        break
                    end
                end
            end
        end
    end
    Cc_helper_save_settings()
end
-- putitem
function Cc_helper_putitem(frame, in_btn, str, step)
    if g.another_warehouse_func == true then
        ui.SysMsg(g.lang == "Japanese" and "[AWH]が作動中です" or "[AWH]is currently operating")
        return
    end
    if step == 0 then
        in_btn:SetUserValue("STEP", 0)
        local monstercardslot = ui.GetFrame("monstercardslot")
        if monstercardslot:IsVisible() == 0 then
            MONSTERCARDSLOT_FRAME_OPEN()
            in_btn:RunUpdateScript("Cc_helper_unequip_card_god", 0.1)
            return
        end
    elseif step == 1 then
        g.cc_helper_unequip_queue = nil
        in_btn:SetUserValue("STEP", step)
        in_btn:RunUpdateScript("Cc_helper_in_btn_start", 0.1)
        return
    elseif step == 2 then
        local eco = g.cc_helper_settings.etc.eco or 0
        in_btn:SetUserValue("STEP", step)
        if eco == 0 then
            in_btn:RunUpdateScript("Cc_helper_unequip_card_leg", 0.1)
        else
            Cc_helper_putitem(nil, in_btn, nil, 3)
        end
        return
    elseif step == 3 then
        in_btn:SetUserValue("STEP", step)
        Cc_helper_inv_to_warehouse(in_btn)
        in_btn:RunUpdateScript("Cc_helper_inv_to_warehouse", 0.2)
        return
    elseif step == 4 then
        in_btn:SetUserValue("STEP", 4)
        Cc_helper_in_btn_aethergem_mgr(in_btn)
    elseif step == 5 then
        in_btn:SetUserValue("STEP", 5)
        in_btn:RunUpdateScript("Cc_helper_gem_inv_to_warehouse", 0.1)
        return
    elseif step == 6 then
        in_btn:SetUserValue("STEP", 6)
        if g.cc_helper_settings[g.cid].mcc == 1 then
            Monster_card_changer_monstercardpreset_open(1)
            in_btn:RunUpdateScript("Cc_helper_mcc_operation", 0.1)
        else
            Cc_helper_putitem(nil, in_btn, nil, 7)
        end
    elseif step == 7 then
        in_btn:SetUserValue("STEP", 7)
        Cc_helper_end_of_operation(in_btn)
    end
end

function Cc_helper_unequip_card_god(in_btn)
    local try = in_btn:GetUserIValue("TRY")
    local target_key = "god"
    local slot_index = 14
    local setting_item = g.cc_helper_settings[g.cid].items["god"]
    local save_clsid = setting_item.clsid
    local save_iesid = setting_item.iesid
    if save_clsid ~= 0 then
        local card_info = equipcard.GetCardInfo(slot_index)
        local is_equipped = (card_info and card_info:GetCardID() == save_clsid)
        if is_equipped then
            local arg_str = string.format("%d 1", slot_index - 1)
            pc.ReqExecuteTx_NumArgs("SCR_TX_UNEQUIP_CARD_SLOT", arg_str)
            return 1
        end
        if try < 2 then
            local inv_item = session.GetInvItemByGuid(save_iesid)
            if inv_item == nil then
                in_btn:SetUserValue("TRY", try + 1)
                return 1
            end
        end
    end
    in_btn:SetUserValue("TRY", 0)
    in_btn:StopUpdateScript("Cc_helper_unequip_card_god")
    Cc_helper_putitem(nil, in_btn, nil, 1)
end

function Cc_helper_in_btn_start(in_btn)
    local inventory = ui.GetFrame("inventory")
    if true == BEING_TRADING_STATE() then
        return 0
    end
    local is_empty_slot = false
    if session.GetInvItemList():Count() < MAX_INV_COUNT then
        is_empty_slot = true
    end
    if is_empty_slot == true then
        in_btn:StopUpdateScript("Cc_helper_in_btn_start")
        in_btn:RunUpdateScript("Cc_helper_unequip", 0.1)
        return 0
    else
        ui.SysMsg(ScpArgMsg("Auto_inBenToLie_Bin_SeulLosi_PilyoHapNiDa."))
        return 0
    end
end

function Cc_helper_unequip(in_btn)
    local inventory = ui.GetFrame("inventory")
    local eqp_tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
    eqp_tab:SelectTab(1)
    if not g.cc_helper_unequip_queue then
        g.cc_helper_unequip_queue = {}
        local equip_tbl = {0, 20, 1, 25, 27, 29, 35}
        local temp_tbl = {"hair1", "hair2", "hair3", "seal", "ark", "relic", "core"}
        local equip_item_list = session.GetEquipItemList()
        for i, equip_index in ipairs(equip_tbl) do
            local equip_item = equip_item_list:GetEquipItemByIndex(equip_index)
            if equip_item then
                local iesid = equip_item:GetIESID()
                local key = temp_tbl[i]
                local setting_data = g.cc_helper_settings[g.cid].items[key]
                if iesid ~= "0" and setting_data and setting_data.iesid == iesid then
                    table.insert(g.cc_helper_unequip_queue, {
                        slot_index = equip_index,
                        iesid = iesid,
                        req_time = 0
                    })
                end
            end
        end
        if #g.cc_helper_unequip_queue == 0 then
            g.cc_helper_unequip_queue = nil
            in_btn:StopUpdateScript("Cc_helper_unequip")
            Cc_helper_putitem(nil, in_btn, nil, 2)
            return 0
        end
        return 1
    end
    local target = g.cc_helper_unequip_queue[1]
    if not target then
        g.cc_helper_unequip_queue = nil
        in_btn:StopUpdateScript("Cc_helper_unequip")
        Cc_helper_putitem(nil, in_btn, nil, 2)
        return 0
    end
    local inv_item = session.GetInvItemByGuid(target.iesid)
    if inv_item then
        table.remove(g.cc_helper_unequip_queue, 1)
        return 1
    end
    local equip_item = session.GetEquipItemByGuid(target.iesid)
    if equip_item then
        local now = imcTime.GetAppTime()
        if target.req_time == 0 or (now - target.req_time > 3.0) then
            item.UnEquip(target.slot_index)
            target.req_time = now
        end
        return 1 -- 待機
    else
        if target.req_time > 0 and (imcTime.GetAppTime() - target.req_time > 5.0) then
            ui.SysMsg("{#FF0000}Unequip timeout or item missing.")
            table.remove(g.cc_helper_unequip_queue, 1)
        end
        return 1
    end
end

function Cc_helper_unequip_card_leg(in_btn)
    local try = in_btn:GetUserIValue("TRY")
    local target_key = "leg"
    local slot_index = 13
    local setting_item = g.cc_helper_settings[g.cid].items["leg"]
    local save_clsid = setting_item.clsid
    local save_iesid = setting_item.iesid
    if save_clsid ~= 0 then
        local card_info = equipcard.GetCardInfo(slot_index)
        local is_equipped = (card_info and card_info:GetCardID() == save_clsid)
        if is_equipped then
            local arg_str = string.format("%d 1", slot_index - 1)
            pc.ReqExecuteTx_NumArgs("SCR_TX_UNEQUIP_CARD_SLOT", arg_str)
            return 1
        end
        if try < 2 then
            local inv_item = session.GetInvItemByGuid(save_iesid)
            if inv_item == nil then
                in_btn:SetUserValue("TRY", try + 1)
                return 1
            end
        end
    end
    in_btn:StopUpdateScript("Cc_helper_unequip_card_leg")
    in_btn:SetUserValue("TRY", 0)
    Cc_helper_putitem(nil, in_btn, nil, 3)
    return 0
end

function Cc_helper_inv_to_warehouse(in_btn)
    local temp_tbl = {{
        key = "seal",
        value = "sset_Accessory_Seal"
    }, {
        key = "ark",
        value = "sset_Accessory_Ark"
    }, {
        key = "core",
        value = "sset_Accessory_Core"
    }, {
        key = "relic",
        value = "sset_Relic"
    }, {
        key = "hair1",
        value = "sset_HairAcc_Acc1"
    }, {
        key = "hair2",
        value = "sset_HairAcc_Acc2"
    }, {
        key = "hair3",
        value = "sset_HairAcc_Acc3"
    }, {
        key = "leg",
        value = "sset_Card_CardLeg"
    }, {
        key = "god",
        value = "sset_Card_CardGoddess"
    }}
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if accountwarehouse:IsVisible() == 1 then
        local handle = accountwarehouse:GetUserIValue("HANDLE")
        local inventory = ui.GetFrame("inventory")
        local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
        for i, data in ipairs(temp_tbl) do
            local key = data.key
            local value = data.value
            local iesid = g.cc_helper_settings[g.cid].items[key].iesid
            local inv_item = session.GetInvItemByGuid(iesid)
            if inv_item then
                if i <= 5 then
                    inventype_Tab:SelectTab(1)
                    local inventree_Equip = GET_CHILD_RECURSIVELY(inventory, "inventree_Equip")
                    local child_count = inventree_Equip:GetChildCount()
                    for j = 0, child_count - 1 do
                        local child = inventree_Equip:GetChildByIndex(j)
                        local child_name = child:GetName()
                        if child_name == value then
                            local child_y = child:GetY()
                            local treeGbox_Equip = GET_CHILD_RECURSIVELY(inventory, "treeGbox_Equip")
                            treeGbox_Equip:SetScrollPos(tonumber(child_y))
                            break
                        end
                    end
                else
                    inventype_Tab:SelectTab(4)
                    local inventree_Card = GET_CHILD_RECURSIVELY(inventory, "inventree_Card")
                    local child_count = inventree_Card:GetChildCount()
                    for j = 0, child_count - 1 do
                        local child = inventree_Card:GetChildByIndex(j)
                        local child_name = child:GetName()
                        if child_name == value then
                            local child_y = child:GetY()
                            local treeGbox_Card = GET_CHILD_RECURSIVELY(inventory, "treeGbox_Card")
                            treeGbox_Card:SetScrollPos(tonumber(child_y))
                            break
                        end
                    end
                end
                if Cc_helper_checkvalid(inv_item) then
                    local goal_index = Cc_helper_get_goal_index()
                    local item_cls = GetClassByType("Item", g.cc_helper_settings[g.cid].items[key].clsid)
                    local item_name = item_cls.Name
                    local log = g.lang == "Japanese" and "倉庫に格納しました" .. "：[" .. "{#EE82EE}" ..
                                    item_name .. "{#FFFF00}]×" .. "{#EE82EE}1" or "Item to warehousing" .. "：[" ..
                                    "{#EE82EE}" .. item_name .. "{#FFFF00}]×" .. "{#EE82EE}1"
                    CHAT_SYSTEM(log)
                    item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, iesid, 1, handle, goal_index)
                    imcSound.PlaySoundEvent("sys_jam_slot_equip")
                    return 1
                end
            end
        end
        in_btn:StopUpdateScript("Cc_helper_inv_to_warehouse")
        Cc_helper_putitem(nil, in_btn, nil, 4)
        return 0
    end
    in_btn:StopUpdateScript("Cc_helper_inv_to_warehouse")
    return 0
end

function Cc_helper_in_btn_aethergem_mgr(in_btn)
    local inventory = ui.GetFrame("inventory")
    local equip_slots = {"RH", "LH", "RH_SUB", "LH_SUB"}
    local eco = g.cc_helper_settings.etc.eco or 0
    local agm_stop = g.cc_helper_settings.etc.agm_stop or 0
    local agm = g.cc_helper_settings[g.cid].agm
    if eco == 0 and agm_stop == 0 and agm == 1 then
        local eq_count = 0
        local has_target_gem = false
        g.cc_helper_guids = {}
        for _, slot_name in ipairs(equip_slots) do
            local equip_slot = GET_CHILD_RECURSIVELY(inventory, slot_name)
            local icon = equip_slot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local iesid = icon_info:GetIESID()
                g.cc_helper_guids[slot_name] = iesid
                eq_count = eq_count + 1
                if not has_target_gem then
                    local equip_item = session.GetEquipItemByGuid(iesid)
                    if equip_item then
                        local gem_id = equip_item:GetEquipGemID(2) -- 2 = Aether Gem
                        for i = 1, 4 do
                            local gem_key = "gem" .. i
                            if gem_id == g.cc_helper_settings[g.cid].items[gem_key].clsid then
                                has_target_gem = true
                                break
                            end
                        end
                    end
                end
            end
        end
        if has_target_gem then
            if eq_count == 4 then
                Cc_helper_msgbox_frame(in_btn)
                return
            else
                local msg = g.lang == "Japanese" and "{ol}武器4ヶ所着けてください" or
                                "{ol}Please equip weapons in 4 slots"
                ui.SysMsg(msg)
                Cc_helper_putitem(nil, in_btn, nil, 6)
                return
            end
        else
            Cc_helper_putitem(nil, in_btn, nil, 6)
            return
        end
    end
    Cc_helper_putitem(nil, in_btn, nil, 6)
end

function Cc_helper_msgbox_frame(in_btn)
    if g.cc_helper_settings[g.cid].agm_check == 1 then
        local top_frame = in_btn:GetTopParentFrame()
        local msg = g.lang == "Japanese" and "{ol}{#FFFFFF}エーテルジェムを付替えますか？" or
                        "{ol}{#FFFFFF}Would you like to swap Aether Gems?"
        local yes_scp = string.format("Cc_helper_start_agm_reserve('%s')", top_frame:GetName())
        local no_scp = string.format("Cc_helper_start_agm_reserve('%s',%d)", top_frame:GetName(), 1)
        ui.MsgBox(msg, yes_scp, no_scp)
    else
        Cc_helper_start_agm(in_btn)
    end
end

function Cc_helper_start_agm_reserve(frame_name, no_scp)
    local top_frame = ui.GetFrame(frame_name)
    local in_btn = GET_CHILD_RECURSIVELY(top_frame, "cch_in_btn")
    if not no_scp then
        Cc_helper_start_agm(in_btn)
    else
        Cc_helper_putitem(nil, in_btn, nil, 6)
    end
end

function Cc_helper_start_agm(btn)
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager") -- layerlevel="92"
    if goddess_equip_manager:IsVisible() == 0 then
        help.RequestAddHelp("TUTO_GODDESSEQUIP_1")
        goddess_equip_manager:ShowWindow(1)
        goddess_equip_manager:SetLayerLevel(100)
        local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, "main_tab")
        main_tab:SelectTab(2)
        GODDESS_MGR_SOCKET_OPEN(goddess_equip_manager)
        GODDESS_EQUIP_UI_TUTORIAL_CHECK(goddess_equip_manager)
        if btn:GetName() == "cch_in_btn" then
            btn:SetUserValue("AG_STEP", 1)
            btn:RunUpdateScript("Cc_helper_in_btn_agm", 0.1)
        else
            btn:SetUserValue("AG_STEP", 1)
            btn:RunUpdateScript("Cc_helper_out_btn_agm", 0.1)
        end
    end
end

function Cc_helper_in_btn_agm(in_btn)
    local inventory = ui.GetFrame("inventory")
    if inventory:IsVisible() == 0 then
        in_btn:StopUpdateScript("Cc_helper_in_btn_agm")
        return 0
    end
    local ag_step = in_btn:GetUserIValue("AG_STEP")
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    local spot_nums = {8, 9, 30}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    if ag_step <= 3 then
        local guid = g.cc_helper_guids[equips[ag_step]]
        local equip_item = session.GetEquipItemByGuid(guid)
        if ag_step == 3 then
            DO_WEAPON_SLOT_CHANGE(inventory, 2)
        end
        if not equip_item then
            in_btn:SetUserValue("AG_STEP", ag_step + 1)
        else
            item.UnEquip(spot_nums[ag_step])
        end
        return 1
    end
    if ag_step >= 4 and ag_step <= 7 then
        local gem_index = 2 -- エーテルジェムは2
        local guid = g.cc_helper_guids[equips[ag_step - 3]]
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            GODDESS_MGR_SOCKET_REG_ITEM(goddess_equip_manager, inv_item, item_obj)
            local gem_id = inv_item:GetEquipGemID(gem_index)
            if not gem_id or gem_id ~= 0 then
                _GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(gem_index)
            else
                local spot_name = equips[ag_step - 3]
                if ag_step == 4 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 1)
                elseif ag_step == 6 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 2)
                end
                ITEM_EQUIP(inv_item.invIndex, spot_name)
            end
            return 1
        else
            in_btn:SetUserValue("AG_STEP", ag_step + 1)
        end
        return 1
    end
    g.cc_helper_guids = nil
    goddess_equip_manager:SetLayerLevel(92)
    Cc_helper_putitem(nil, in_btn, nil, 5)
end

function Cc_helper_gem_inv_to_warehouse(in_btn)
    local inventory = ui.GetFrame("inventory")
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if inventory:IsVisible() == 0 or accountwarehouse:IsVisible() == 0 then
        in_btn:StopUpdateScript("Cc_helper_gem_inv_to_warehouse")
        return 0
    end
    if not g.cc_helper_gem_queue then
        local gem_tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
        gem_tab:SelectTab(6)
        local required_counts = {}
        for i = 1, 4 do
            local item_data = g.cc_helper_settings[g.cid].items["gem" .. i]
            if item_data and item_data.clsid ~= 0 then
                local id = item_data.clsid
                required_counts[id] = (required_counts[id] or 0) + 1
            end
        end
        local candidates = {}
        local inv_list = session.GetInvItemList()
        local guid_list = inv_list:GetGuidList()
        local cnt = guid_list:Count()
        for i = 0, cnt - 1 do
            local guid = guid_list:Get(i)
            local inv_item = inv_list:GetItemByGuid(guid)
            local obj = GetIES(inv_item:GetObject())
            local id = obj.ClassID
            if required_counts[id] and Cc_helper_checkvalid(inv_item) then
                local level = get_current_aether_gem_level(obj)
                table.insert(candidates, {
                    level = tonumber(level) or 0,
                    iesid = guid,
                    clsid = id,
                    name = obj.Name,
                    inv_item = inv_item
                })
            end
        end
        table.sort(candidates, function(a, b)
            return a.level > b.level
        end)
        local queue = {}
        local added_counts = {}
        for _, gem in ipairs(candidates) do
            local id = gem.clsid
            local limit = required_counts[id] or 0
            local current = added_counts[id] or 0
            if current < limit then
                table.insert(queue, gem)
                added_counts[id] = current + 1
            end
        end
        g.cc_helper_gem_queue = queue
    end
    if #g.cc_helper_gem_queue > 0 then
        local gem_data = g.cc_helper_gem_queue[1]
        local handle = accountwarehouse:GetUserIValue("HANDLE")
        local inv_item = session.GetInvItemByGuid(gem_data.iesid)
        if inv_item then
            local goal_index = Cc_helper_get_goal_index()
            local log = g.lang == "Japanese" and "倉庫に格納しました：[{#EE82EE}" .. gem_data.name ..
                            "{#FFFF00}]×{#EE82EE}1" or "Item to warehousing：[{#EE82EE}" .. gem_data.name ..
                            "{#FFFF00}]×{#EE82EE}1"
            CHAT_SYSTEM(log)
            session.ResetItemList()
            session.AddItemID(gem_data.iesid, 1)
            item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, gem_data.iesid, 1, handle, goal_index)
            return 1
        else
            table.remove(g.cc_helper_gem_queue, 1)
            return 1
        end
    end
    g.cc_helper_gem_queue = nil
    in_btn:StopUpdateScript("Cc_helper_gem_inv_to_warehouse")
    Cc_helper_putitem(nil, in_btn, nil, 6)
    return 0
end

function Cc_helper_mcc_operation(in_btn)
    local monstercardpreset = ui.GetFrame("monstercardpreset")
    if not g.monster_card_changer_ready then
        return 1
    elseif g.monster_card_changer_ready == 1 then
        g.monster_card_changer_ready = 2
        Monster_card_changer_remove(monstercardpreset)
    elseif g.monster_card_changer_ready == 2 then
        return 1
    elseif g.monster_card_changer_ready == 3 then
        g.monster_card_changer_ready = nil
        in_btn:StopUpdateScript("Cc_helper_mcc_operation")
        Cc_helper_putitem(nil, in_btn, nil, 7)
        return 0
    end
    return 1
end
-- takeitem
function Cc_helper_take_item(frame, out_btn, str, step)
    if g.another_warehouse_func == true then
        ui.SysMsg(g.lang == "Japanese" and "[AWH]が作動中です" or "[AWH] is currently operating")
        return
    end
    if step == 0 then
        out_btn:SetUserValue("STEP", 0)
        out_btn:RunUpdateScript("Cc_helper_equip_take_warehouse_item", 0.1)
    elseif step == 1 then
        out_btn:SetUserValue("TRY", 0)
        out_btn:SetUserValue("STEP", 1)
        out_btn:RunUpdateScript("Cc_helper_equip_card", 0.1)
    elseif step == 2 then
        out_btn:SetUserValue("STEP", 2)
        Cc_helper_equips_reserve(out_btn)
    elseif step == 3 then
        out_btn:SetUserValue("TRY", 0)
        out_btn:SetUserValue("STEP", 3)
        out_btn:RunUpdateScript("Cc_helper_equip_card", 0.1)
    elseif step == 4 then
        out_btn:SetUserValue("STEP", 4)
        out_btn:RunUpdateScript("Cc_helper_take_agm_reserve", 0.1)
    elseif step == 5 then
        out_btn:SetUserValue("STEP", 5)
        out_btn:RunUpdateScript("Cc_helper_out_btn_agm_reserve", 0.1)
    elseif step == 6 then
        out_btn:SetUserValue("STEP", 6)
        if g.cc_helper_settings[g.cid].mcc == 1 then
            Cc_helper_end_of_operation(out_btn, 1)
            return
        else
            Cc_helper_take_item(nil, out_btn, nil, 7)
        end
    elseif step == 7 then
        out_btn:SetUserValue("STEP", 7)
        Cc_helper_end_of_operation(out_btn)
    end
end

function Cc_helper_equip_take_warehouse_item(out_btn)
    local req_time = out_btn:GetUserIValue("REQ_TIME")
    if req_time == 0 then
        g.cc_helper_take_guids = {} -- 必ず初期化
        local equip_keys = {"seal", "ark", "relic", "core", "leg", "god", "hair1", "hair2", "hair3"}
        local is_eco = (g.cc_helper_settings.etc.eco == 1)
        local wh_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
        session.ResetItemList()
        for _, key in ipairs(equip_keys) do
            if not (is_eco and key == "leg") then
                local item_data = g.cc_helper_settings[g.cid].items[key]
                local iesid = item_data and item_data.iesid or ""
                if iesid ~= "" then
                    if wh_list:GetItemByGuid(iesid) and not session.GetInvItemByGuid(iesid) then
                        session.AddItemID(iesid, 1)
                        table.insert(g.cc_helper_take_guids, iesid)
                    end
                end
            end
        end
        if #g.cc_helper_take_guids == 0 then
            return Cc_helper_equip_take_finish(out_btn)
        end
        local handle = ui.GetFrame("accountwarehouse"):GetUserIValue("HANDLE")
        item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
        out_btn:SetUserValue("REQ_TIME", imcTime.GetAppTime())
        return 1
    end
    if not g.cc_helper_take_guids or #g.cc_helper_take_guids == 0 then
        ui.SysMsg("{#FF0000}Data Error: Item list lost.")
        return Cc_helper_equip_take_finish(out_btn)
    end
    for _, guid in ipairs(g.cc_helper_take_guids) do
        if not session.GetInvItemByGuid(guid) then
            local elapsed = imcTime.GetAppTime() - req_time
            if elapsed > 3.0 then
                ui.SysMsg(g.lang == "Japanese" and "{#FF0000}倉庫取り出しタイムアウト" or
                              "{#FF0000}Warehouse take timeout")
                return Cc_helper_equip_take_finish(out_btn) -- タイムアウト強制終了
            end
            return 1
        end
    end
    return Cc_helper_equip_take_finish(out_btn)
end

function Cc_helper_equip_take_finish(out_btn)
    out_btn:StopUpdateScript("Cc_helper_equip_take_warehouse_item")
    out_btn:SetUserValue("REQ_TIME", 0)
    g.cc_helper_take_guids = nil
    Cc_helper_update_hair_stats()
    Cc_helper_take_item(nil, out_btn, nil, 1) -- 次のステップへ
    return 0
end

function Cc_helper_equip_card(out_btn)
    local inventory = ui.GetFrame("inventory")
    local monstercardslot = ui.GetFrame("monstercardslot")
    local step = out_btn:GetUserIValue("STEP")
    local try = out_btn:GetUserIValue("TRY")
    local key, card_index, next_step, is_eco_check
    if step == 1 then
        key = "god"
        card_index = 13
        next_step = 2
        is_eco_check = false
    elseif step == 3 then
        key = "leg"
        card_index = 12
        next_step = 4
        is_eco_check = true
    end
    if is_eco_check and g.cc_helper_settings.etc.eco == 1 then
        out_btn:StopUpdateScript("Cc_helper_equip_card")
        Cc_helper_take_item(nil, out_btn, nil, next_step)
        return 0
    end
    local card_id = GETMYCARD_INFO(card_index)
    if card_id == 0 then
        local iesid = g.cc_helper_settings[g.cid].items[key].iesid
        if iesid ~= "" then
            local inv_item = session.GetInvItemByGuid(iesid)
            if inv_item then
                local inv_tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
                inv_tab:SelectTab(4)
                MONSTERCARDSLOT_FRAME_OPEN()
                local arg_str = string.format("%d#%s", card_index, tostring(iesid))
                pc.ReqExecuteTx("SCR_TX_EQUIP_CARD_SLOT", arg_str)
                return 1
            elseif not inv_item and try <= 4 then
                out_btn:SetUserValue("TRY", try + 1)
                return 1
            end
        end
    end
    out_btn:StopUpdateScript("cc_helper_equip_card")
    Cc_helper_take_item(nil, out_btn, nil, next_step)
    return 0
end

function Cc_helper_equips_reserve(out_btn)
    g.cc_helper_tbl = {{
        ["HAT"] = "hair1"
    }, {
        ["HAT_T"] = "hair2"
    }, {
        ["HAT_L"] = "hair3"
    }, {
        ["SEAL"] = "seal"
    }, {
        ["ARK"] = "ark"
    }, {
        ["RELIC"] = "relic"
    }, {
        ["CORE"] = "core"
    }}
    out_btn:RunUpdateScript("Cc_helper_equips", 0.1)
end

function Cc_helper_equips(out_btn)
    local inventory = ui.GetFrame("inventory")
    local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
    inventype_Tab:SelectTab(1)
    local function IsEquipable(cls_id)
        local lv = GETMYPCLEVEL()
        local job = GETMYPCJOB()
        local gender = GETMYPCGENDER()
        local prop = geItemTable.GetProp(cls_id)
        if not prop then
            return false
        end
        return prop:CheckEquip(lv, job, gender) == 'OK' and true or false
    end
    for i, data in ipairs(g.cc_helper_tbl) do
        for spot, equip_key in pairs(data) do
            local item_data = g.cc_helper_settings[g.cid].items[equip_key]
            local guid = item_data and item_data.iesid
            if guid and guid ~= "" and guid ~= "0" then
                local is_equipped = session.GetEquipItemByGuid(guid)
                if not is_equipped then
                    local inv_item = session.GetInvItemByGuid(guid)
                    if inv_item then
                        local item_obj = GetIES(inv_item:GetObject())
                        local cls_id = item_obj.ClassID
                        if IsEquipable(cls_id) then
                            ITEM_EQUIP(inv_item.invIndex, spot)
                            return 1
                        end
                    end
                end
            end
        end
    end
    out_btn:StopUpdateScript("Cc_helper_equips")
    Cc_helper_take_item(nil, out_btn, nil, 3)
end

function Cc_helper_take_agm_reserve(out_btn)
    local inventory = ui.GetFrame("inventory")
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    for _, slot_name in ipairs(equips) do
        local equip_slot = GET_CHILD_RECURSIVELY(inventory, slot_name)
        local icon = equip_slot:GetIcon()
        if icon then
            local icon_info = icon:GetInfo()
            local guid = icon_info:GetIESID()
            local equip_item = session.GetEquipItemByGuid(guid)
            local available = equip_item:IsAvailableSocket(2)
            if not available then
                out_btn:StopUpdateScript("Cc_helper_take_agm_reserve")
                Cc_helper_take_item(nil, out_btn, nil, 6)
                return 0
            end
        end
    end
    local eco = g.cc_helper_settings.etc.eco or 0
    local agm_stop = g.cc_helper_settings.etc.agm_stop or 0
    local agm = g.cc_helper_settings[g.cid].agm
    if eco == 0 and agm_stop == 0 and agm == 1 then
        local equipSlots = {"RH", "LH", "RH_SUB", "LH_SUB"}
        local found_count = 0
        local inventory = ui.GetFrame("inventory")
        for _, slot_name in ipairs(equipSlots) do
            local equipSlot = GET_CHILD_RECURSIVELY(inventory, slot_name)
            local icon = equipSlot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local guid = icon_info:GetIESID()
                local equip_item = session.GetEquipItemByGuid(guid)
                local gem_id = equip_item:GetEquipGemID(2)
                if gem_id == 0 then
                    found_count = found_count + 1
                end
            end
        end
        if found_count == 4 then
            if g.cc_helper_settings[g.cid].agm_check == 1 then
                local top_frame = out_btn:GetTopParentFrame()
                local msg = g.lang == "Japanese" and "{ol}{#FFFFFF}エーテルジェムを付替えますか？" or
                                "{ol}{#FFFFFF}Would you like to swap Aether Gems?"
                local yes_scp = string.format("Cc_helper_take_msg_func('%s','%s')", top_frame:GetName(),
                    out_btn:GetName())
                local no_scp = string.format("Cc_helper_take_msg_func('%s','%s',%d)", top_frame:GetName(),
                    out_btn:GetName(), 1)
                ui.MsgBox(msg, yes_scp, no_scp)
                return
            else
                out_btn:StopUpdateScript("Cc_helper_take_agm_reserve")
                Cc_helper_take_agm(out_btn)
                return 0
            end
        end
    end
    out_btn:StopUpdateScript("Cc_helper_take_agm_reserve")
    Cc_helper_take_item(nil, out_btn, nil, 6)
    return 0
end

function Cc_helper_take_msg_func(top_frame_name, out_btn_name, is_no_scp)
    local top_frame = ui.GetFrame(top_frame_name)
    local out_btn = GET_CHILD(top_frame, "cch_out_btn")
    if not is_no_scp then
        Cc_helper_take_agm(out_btn)
    else
        Cc_helper_take_item(nil, out_btn, nil, 6)
    end
end

function Cc_helper_take_agm(out_btn)
    local inventory = ui.GetFrame("inventory")
    local inv_tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
    inv_tab:SelectTab(6)
    local gems = {}
    for i = 1, 4 do
        local clsid = g.cc_helper_settings[g.cid].items["gem" .. i].clsid
        if clsid ~= 0 then
            gems[clsid] = true
        end
    end
    g.cc_helper_take_gems = {}
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local sorted_guid_list = item_list:GetSortedGuidList()
    local sorted_cnt = sorted_guid_list:Count()
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local handle = accountwarehouse:GetUserIValue("HANDLE")
    for i = 0, sorted_cnt - 1 do
        local iesid = sorted_guid_list:Get(i)
        local awh_item = item_list:GetItemByGuid(iesid)
        local type = awh_item.type
        local obj = GetIES(awh_item:GetObject())
        if gems[type] then
            local level = get_current_aether_gem_level(obj)
            table.insert(g.cc_helper_take_gems, {
                level = tonumber(level) or 0,
                iesid = iesid,
                clsid = type,
                loc = "warehouse"
            })
        end
    end
    local inv_item_list = session.GetInvItemList()
    local guid_list = inv_item_list:GetGuidList()
    local cnt = guid_list:Count()
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        local item_obj = GetIES(inv_item:GetObject())
        local cls_id = item_obj.ClassID
        if gems[cls_id] then
            local level = get_current_aether_gem_level(item_obj)
            table.insert(g.cc_helper_take_gems, {
                level = tonumber(level) or 0,
                iesid = guid,
                clsid = cls_id,
                loc = "inventory"
            })
        end
    end
    table.sort(g.cc_helper_take_gems, function(a, b)
        return a.level > b.level
    end)
    if #g.cc_helper_take_gems < 4 then
        local msg = g.lang == "Japanese" and "{ol}指定のエーテルジェムが4個ありません" or
                        "{ol}You don't have 4 of the Aether Gems"
        ui.SysMsg(msg)
        Cc_helper_take_item(nil, out_btn, nil, 6)
        return
    end
    session.ResetItemList()
    local take_count = 0
    for i = 1, 4 do
        if g.cc_helper_take_gems[i].loc == "warehouse" then
            session.AddItemID(g.cc_helper_take_gems[i].iesid, 1)
            take_count = take_count + 1
        end
    end
    if take_count > 0 then
        item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
    end
    Cc_helper_take_item(nil, out_btn, nil, 5)
end

function Cc_helper_out_btn_agm_reserve(out_btn)
    g.Cc_helper_gem_guids = {}
    local eq_count = 0
    local equips = {"RH_SUB", "LH_SUB", "RH", "LH"}
    local inventory = ui.GetFrame("inventory")
    for _, slot_name in ipairs(equips) do
        local equip_slot = GET_CHILD_RECURSIVELY(inventory, slot_name)
        local icon = equip_slot:GetIcon()
        if icon then
            local icon_info = icon:GetInfo()
            local iesid = icon_info:GetIESID()
            if not g.Cc_helper_gem_guids[slot_name] then
                g.Cc_helper_gem_guids[slot_name] = iesid
                eq_count = eq_count + 1
            end
        end
    end
    if eq_count == 4 then
        out_btn:StopUpdateScript("Cc_helper_out_btn_agm_reserve")
        Cc_helper_start_agm(out_btn)
        return 0
    end
    local msg = g.lang == "Japanese" and "{ol}武器4ヶ所着けてください" or
                    "{ol}Please equip weapons in 4 slots"
    ui.SysMsg(msg)
    out_btn:StopUpdateScript("Cc_helper_out_btn_agm_reserve")
    cc_helper_take_item(nil, out_btn, nil, 6)
    return 0
end

function Cc_helper_out_btn_agm(out_btn)
    local inventory = ui.GetFrame("inventory")
    if inventory:IsVisible() == 0 then
        out_btn:StopUpdateScript("Cc_helper_out_btn_agm")
        return 0
    end
    local ag_step = out_btn:GetUserIValue("AG_STEP")
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    local spot_nums = {8, 9, 30}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    if ag_step <= 3 then
        local guid = g.Cc_helper_gem_guids[equips[ag_step]]
        local equip_item = session.GetEquipItemByGuid(guid)
        if ag_step == 3 then
            DO_WEAPON_SLOT_CHANGE(inventory, 2)
        end
        if not equip_item then
            out_btn:SetUserValue("AG_STEP", ag_step + 1)
        else
            item.UnEquip(spot_nums[ag_step])
        end
        return 1
    end
    local msg = g.lang == "Japanese" and "エーテルジェムソケットが空いていません" or
                    "The Aether Gem socket is unavailable"
    if ag_step >= 4 and ag_step <= 7 then
        local guid = g.Cc_helper_gem_guids[equips[ag_step - 3]]
        local inv_item = session.GetInvItemByGuid(guid)
        local gem_guid = g.cc_helper_take_gems[ag_step - 3].iesid
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            GODDESS_MGR_SOCKET_REG_ITEM(goddess_equip_manager, inv_item, item_obj)
            local gem_item = session.GetInvItemByGuid(gem_guid)
            if gem_item then
                local gem_obj = GetIES(gem_item:GetObject())
                local ctrl_set = GET_CHILD_RECURSIVELY(goddess_equip_manager, "AETHER_CSET_0")
                local gem_id = ctrl_set:GetUserIValue("GEM_ID")
                if gem_id == 0 then
                    local gem_slot = GET_CHILD(ctrl_set, "gem_slot")
                    GODDESS_MGR_SOCKET_AETHER_GEM_EQUIP(ctrl_set, gem_slot, gem_item, gem_obj)
                end
                return 1
            else
                local spot_name = equips[ag_step - 3]
                if ag_step == 4 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 1)
                elseif ag_step == 6 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 2)
                end
                ITEM_EQUIP(inv_item.invIndex, spot_name)
                return 1
            end
        else
            out_btn:SetUserValue("AG_STEP", ag_step + 1)
            return 1
        end
    end
    out_btn:StopUpdateScript("Cc_helper_out_btn_agm")
    Cc_helper_take_item(nil, out_btn, nil, 6)
    return 0
end

function Cc_helper_change_summoned_pet(companionlist)
    local save_iesid = g.cc_helper_settings[g.cid].items["pet"].iesid
    local save_clsid = g.cc_helper_settings[g.cid].items["pet"].clsid
    local state = companionlist:GetUserValue("FUNCTION_")
    local pet_list = session.pet.GetPetInfoVec()
    for i = 0, pet_list:size() - 1 do
        local info = pet_list:at(i)
        local obj = GetIES(info:GetObject())
        local id = obj.ClassID
        local set_name = "_CTRLSET_" .. i
        local ctrlset = GET_CHILD_RECURSIVELY(companionlist, set_name)
        if ctrlset then
            local slot = GET_CHILD_RECURSIVELY(ctrlset, "slot")
            local icon = slot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local pet_guid = icon_info:GetIESID()
                if state == "not" then
                    if pet_guid == save_iesid then
                        ICON_USE(icon)
                        break
                    end
                elseif state == "different" then
                    local summoned_pet = session.pet.GetSummonedPet()
                    local summoned_iesid = summoned_pet:GetStrGuid()
                    if pet_guid == summoned_iesid then
                        companionlist:SetUserValue("FUNCTION_", "not")
                        control.SummonPet(0, 0, 0)
                        return 1
                    end
                end
            end
        end
    end
    local function USE_COMPANION_ICON_AFTER_ACTION()
        local can_close = false
        local pet_info = ui.GetFrame("pet_info")
        if pet_info then
            if pet_info:IsVisible() == 0 then
                can_close = true
            end
        else
            can_close = true
        end
        if can_close == true then
            CLOSE_COMPANIONLIST()
            CLOSE_PETLIST()
        end
    end
    USE_COMPANION_ICON_AFTER_ACTION()
    companionlist:Resize(305, 335)
    return 0
end

function Cc_helper_end_of_operation(btn, is_mcc)
    local inventory = ui.GetFrame("inventory")
    local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
    if inventype_Tab then
        inventype_Tab:SelectTab(0)
    end
    ui.SysMsg("{ol}[CCH]End of Operation")
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    goddess_equip_manager:ShowWindow(0)
    local monstercardslot = ui.GetFrame("monstercardslot")
    if monstercardslot:IsVisible() == 1 and not is_mcc then
        monstercardslot:RunUpdateScript("MONSTERCARDSLOT_CLOSE", 0.5)
    end
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if g.cc_helper_settings.etc.wh_close == 1 and not is_mcc then
        ACCOUNTWAREHOUSE_CLOSE()
    elseif is_mcc == 1 then
        Monster_card_changer_monstercardpreset_open(1)
    end
    local btn_name = btn:GetName()
    if btn_name == "cch_out_btn" then
        local save_clsid = g.cc_helper_settings[g.cid].items["pet"].clsid
        if save_clsid ~= 0 then
            local companionlist = ui.GetFrame("companionlist")
            companionlist:Resize(0, 0)
            local summoned_pet = session.pet.GetSummonedPet()
            if not summoned_pet then
                ON_OPEN_COMPANIONLIST()
                companionlist:SetUserValue("FUNCTION_", "not")
                companionlist:RunUpdateScript("Cc_helper_change_summoned_pet", 0.5)
            else -- Different
                local summoned_iesid = summoned_pet:GetStrGuid()
                local save_iesid = g.cc_helper_settings[g.cid].items["pet"].iesid
                if summoned_iesid ~= save_iesid then
                    ON_OPEN_COMPANIONLIST()
                    companionlist:SetUserValue("FUNCTION_", "different")
                    companionlist:RunUpdateScript("Cc_helper_change_summoned_pet", 0.5)
                end
            end
        end
    end
    return 0
end

function Cc_helper_hair_option(item_obj)
    local str = ""
    local rank = shared_enchant_special_option.get_item_rank(item_obj)
    for i = 1, 3 do
        local prop_name = "HatPropName_" .. i
        local prop_value = "HatPropValue_" .. i
        if item_obj[prop_value] ~= 0 and item_obj[prop_name] ~= "None" then
            if not string.find(item_obj[prop_name], "ALLSKILL_") then
                str = str .. item_obj[prop_name] .. "/" .. item_obj[prop_value]
            else
                local job = StringSplit(item_obj[prop_name], "_")[2]
                if job == "ShadowMancer" then
                    job = "Shadowmancer"
                end
                str = str .. job
            end
            str = str .. ":::"
        end
    end
    str = str:gsub(" - ", "")
    str = str:gsub("-", "")
    return str, rank
end

function Cc_helper_update_hair_stats()
    local hairs = {"hair1", "hair2", "hair3"}
    local is_updated = false
    local copys = g.cc_helper_settings.etc and g.cc_helper_settings.etc.copys
    for _, key in ipairs(hairs) do
        local item_data = g.cc_helper_settings[g.cid].items[key]
        if item_data and item_data.iesid ~= "" then
            local guid = item_data.iesid
            local inv_item = session.GetInvItemByGuid(item_data.iesid)
            if not inv_item then
                inv_item = session.GetEquipItemByGuid(guid)
            end
            if not inv_item then
                local accountwarehouse = ui.GetFrame("accountwarehouse")
                if accountwarehouse and accountwarehouse:IsVisible() == 1 then
                    inv_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, guid)
                end
            end
            if inv_item then
                local obj = GetIES(inv_item:GetObject())
                local option, rank = Cc_helper_hair_option(obj)
                if item_data.option ~= option or item_data.rank ~= rank then
                    item_data.option = option
                    item_data.rank = rank
                    is_updated = true
                end
                if copys then
                    for cid, char_data in pairs(copys) do
                        if char_data.items then
                            for copy_key, copy_item_data in pairs(char_data.items) do
                                if copy_item_data.iesid == guid then
                                    if copy_item_data.option ~= option or copy_item_data.rank ~= rank then
                                        copy_item_data.option = option
                                        copy_item_data.rank = rank
                                        is_updated = true
                                    end
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if is_updated then
        Cc_helper_save_settings()
    end
end

function Cc_helper_checkvalid(inv_item)
    local acc_obj = GetMyAccountObj()
    local max_count = acc_obj.BasicAccountWarehouseSlotCount + acc_obj.MaxAccountWarehouseCount +
                          acc_obj.AccountWareHouseExtend + acc_obj.AccountWareHouseExtendByItem
    if session.loginInfo.IsPremiumState(ITEM_TOKEN) then
        max_count = max_count + ADDITIONAL_SLOT_COUNT_BY_TOKEN + 280
    end
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local item_count = item_list:GetSortedGuidList():Count()
    if max_count <= item_count then
        ui.SysMsg(ClMsg("CannotPutBecauseMaxSlot"))
        return false
    end
    if true == inv_item.isLockState then
        ui.SysMsg(ClMsg("MaterialItemIsLock"))
        return false
    end
    local obj = GetIES(inv_item:GetObject())
    local item_cls = GetClassByType("Item", obj.ClassID)
    if item_cls.ItemType == "Quest" then
        ui.MsgBox(ScpArgMsg("IT_ISNT_REINFORCEABLE_ITEM"))
        return false
    end
    local enable_team_trade = TryGetProp(item_cls, "TeamTrade")
    if not enable_team_trade and enable_team_trade == "NO" then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return false
    end
    if TryGetProp(obj, "CharacterBelonging", 0) == 1 then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return false
    end
    return true
end

function Cc_helper_get_goal_index()
    local acc_obj = GetMyAccountObj()
    local base_count = acc_obj.BasicAccountWarehouseSlotCount + acc_obj.MaxAccountWarehouseCount +
                           acc_obj.AccountWareHouseExtend + acc_obj.AccountWareHouseExtendByItem
    local tab_index = {4, 3, 2, 1, 0}
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local tab = GET_CHILD(accountwarehouse, "accountwarehouse_tab")
    local slotset = GET_CHILD_RECURSIVELY(accountwarehouse, "slotset")
    for index = 1, #tab_index do
        local i = tab_index[index]
        tab:SelectTab(i)
        if i > 0 and session.loginInfo.IsPremiumState(ITEM_TOKEN) then
            local itemcnt = GET_CHILD_RECURSIVELY(accountwarehouse, "itemcnt")
            local num_str = string.match(itemcnt:GetText(), "{@st42}(%d+)/")
            local left = tonumber(num_str)
            if left < 70 then
                return ((i - 1) * 70) + base_count + ADDITIONAL_SLOT_COUNT_BY_TOKEN + left + 1
            end
        else
            for j = 1, base_count do
                local slot = slotset:GetSlotByIndex(j)
                AUTO_CAST(slot)
                if slot:GetIcon() == nil then
                    return j
                end
            end
        end
    end
end
-- cc_helper ここまで

-- tavern_of_soul ここから
function tavern_of_soul_on_init()
    if g.settings.tavern_of_soul.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "tos_btn")
        return
    end
    Tavern_of_soul_frame_init()
end

function Tavern_of_soul_frame_init()
    local tos_btn = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "tos_btn", 0, 0, 0, 0)
    AUTO_CAST(tos_btn)
    tos_btn:SetSkinName("None")
    tos_btn:Resize(30, 30)
    tos_btn:SetLayerLevel(30)
    tos_btn:SetGravity(ui.RIGHT, ui.TOP)
    local rect = tos_btn:GetMargin()
    tos_btn:SetMargin(rect.left, rect.top - 60, rect.right + 277, rect.bottom)
    tos_btn:SetTitleBarSkin("None")
    local open_btn = tos_btn:CreateOrGetControl('button', 'open_btn', 0, 0, 30, 30)
    AUTO_CAST(open_btn)
    open_btn:SetText("{ol}{s20}D")
    open_btn:SetTextTooltip("{ol}Tavern of Soul")
    open_btn:SetEventScript(ui.LBUTTONUP, "Tavern_of_soul_main_frame_init")
    tos_btn:ShowWindow(1)
end

function Tavern_of_soul_main_frame_init()
    if g.settings.tavern_of_soul.use == 0 then
        return
    end
    local tos_main = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "tos_main", 0, 0, 0, 0)
    AUTO_CAST(tos_main)
    tos_main:RemoveAllChild()
    local map_frame = ui.GetFrame("map")
    local width = map_frame:GetWidth()
    local height = map_frame:GetHeight()
    tos_main:SetSkinName("test_frame_low")
    tos_main:Resize(300, 120)
    tos_main:SetLayerLevel(999)
    tos_main:SetPos(500, 100)
    g.tos_mode = g.tos_mode or "Item"
    local title = tos_main:CreateOrGetControl('richtext', 'title', 10, 10, 100, 30)
    title:SetText("{ol}Tavern of Soul")
    local close_btn = tos_main:CreateOrGetControl('button', 'close_btn', 0, 0, 30, 30)
    AUTO_CAST(close_btn)
    close_btn:SetImage("testclose_button")
    close_btn:SetGravity(ui.RIGHT, ui.TOP)
    close_btn:SetEventScript(ui.LBUTTONUP, "Tavern_of_soul_frame_close")
    local search_edit = tos_main:CreateOrGetControl("edit", "search_edit", 10, 35, 280, 40)
    AUTO_CAST(search_edit)
    search_edit:SetFontName("white_18_ol")
    search_edit:SetTextAlign("left", "center")
    search_edit:SetSkinName("inventory_serch")
    search_edit:SetEventScript(ui.ENTERKEY, "Tavern_of_soul_search_enter")
    search_edit:Focus()
    local modes = {"Item", "Buff", "Skill", "Monster"}
    local btn_w = 65
    local btn_x = 10
    for i, mode in ipairs(modes) do
        local btn = tos_main:CreateOrGetControl("button", "btn_" .. mode, btn_x, 80, btn_w, 30)
        AUTO_CAST(btn)
        btn:SetText("{ol}{s14}" .. mode)
        if mode == g.tos_mode then
            btn:SetSkinName("test_red_button")
        else
            btn:SetSkinName("test_gray_button")
        end
        btn:SetEventScript(ui.LBUTTONUP, "Tavern_of_soul_mode_click")
        btn:SetEventScriptArgString(ui.LBUTTONUP, mode)
        btn_x = btn_x + btn_w + 5
    end
    local gbox = tos_main:CreateOrGetControl("groupbox", "gbox", 10, 120, 280, 30)
    AUTO_CAST(gbox)
    gbox:SetSkinName("bg")
    gbox:ShowWindow(0)
    tos_main:ShowWindow(1)
end

function Tavern_of_soul_search_enter(parent, ctrl)
    local tos_main = parent:GetTopParentFrame()
    local mode = g.tos_mode or "Item"
    Tavern_of_soul_get_data(tos_main, ctrl, mode)
end

function Tavern_of_soul_mode_click(parent, ctrl, mode, num)
    local tos_main = parent:GetTopParentFrame()
    local search_edit = GET_CHILD(tos_main, "search_edit")
    g.tos_mode = mode
    local modes = {"Item", "Buff", "Skill", "Monster"}
    for _, m in ipairs(modes) do
        local btn = GET_CHILD(tos_main, "btn_" .. m)
        if btn then
            if m == mode then
                btn:SetSkinName("test_red_button")
            else
                btn:SetSkinName("test_gray_button")
            end
        end
    end
    search_edit:SetText("")
    local gbox = GET_CHILD(tos_main, "gbox")
    gbox:RemoveAllChild()
    gbox:ShowWindow(0)
    tos_main:Resize(300, 120)
    local map_frame = ui.GetFrame("map")
    local width = map_frame:GetWidth()
    tos_main:SetPos(500, 100)
    search_edit:Focus()
end

function Tavern_of_soul_get_data(tos_main, search_edit, mode)
    if not mode or mode == "" then
        mode = "Item"
    end
    local clslist, cnt = GetClassList(mode)
    local edit_text = search_edit:GetText()
    if tos_main:GetChild("gbox") then
        tos_main:RemoveChild("gbox")
    end
    local gbox = tos_main:CreateOrGetControl("groupbox", "gbox", 10, 120, 280, 30)
    AUTO_CAST(gbox)
    gbox:SetSkinName("bg")
    gbox:ShowWindow(1)
    local min_width = 300
    local x = min_width
    local index = 0
    for i = 0, cnt - 1 do
        local cls = GetClassByIndexFromList(clslist, i)
        local raw_name = TryGetProp(cls, "Name", "None")
        if raw_name ~= "None" then
            local name = dictionary.ReplaceDicIDInCompStr(raw_name)
            if string.find(name, edit_text, 1, true) then
                local icon_name = "None"
                if mode == "Buff" then
                    icon_name = GET_BUFF_ICON_NAME(cls)
                else
                    icon_name = TryGetProp(cls, "Icon", "None")
                end
                if icon_name ~= "None" and icon_name ~= "ui_CreateMonster" then
                    --[[if icon_name ~= "None" and icon_name ~= "" and icon_name ~= "ui_CreateMonster" and icon_name ~=
                    "icon_item_nothing" then]]
                    local icon_picture = gbox:CreateOrGetControl('picture', "icon_picture" .. index, 10, index * 30, 25,
                        25)
                    AUTO_CAST(icon_picture)
                    local status, err = pcall(function()
                        if mode == "Skill" then
                            if not string.find(icon_name, "icon_") then
                                icon_name = "icon_" .. icon_name
                            end
                        end
                        icon_picture:SetImage(icon_name)
                    end)
                    if not status then
                        icon_picture:SetImage("question_mark")
                    end
                    icon_picture:SetEnableStretch(1)
                    local cls_id = cls.ClassID
                    local cls_name = cls.ClassName
                    local text = gbox:CreateOrGetControl('richtext', 'text' .. index, 40, index * 30 + 5, 20, 20)
                    text:SetText("{ol}( " .. cls_id .. " ) {#FF0000}" .. name .. "{/}{/}{ol} ( " .. cls_name .. " )")
                    if x < text:GetWidth() + 80 then
                        x = text:GetWidth() + 80
                    end
                    index = index + 1
                end
            end
        end
    end
    if index == 0 then
        tos_main:Resize(min_width, 120)
        gbox:ShowWindow(0)
    else
        local content_height = index * 30
        local map_frame = ui.GetFrame("map")
        local max_height = map_frame:GetHeight() - 150
        if max_height > 900 then
            max_height = 900
        end
        local frame_height = 120 + content_height + 20
        if frame_height > max_height then
            frame_height = max_height
        end
        if frame_height < 160 then
            frame_height = 160
        end
        tos_main:Resize(x, frame_height)
        gbox:Resize(x - 20, frame_height - 130)
        gbox:ShowWindow(1)
        gbox:SetScrollPos(0)
    end
end

function Tavern_of_soul_frame_close(frame, ctrl)
    ui.DestroyFrame(frame:GetName())
end
-- tavern_of_soul ここまで

-- archeology_helper ここから
function Archeology_helper_save_settings()
    g.save_json(g.aoh_settings_path, g.aoh_settings)
end

function Archeology_helper_load_settings()
    g.aoh_settings_path = string.format("../addons/%s/%s/archeology_helper.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.aoh_settings_path)
    if not settings then
        settings = {
            count = 0,
            is_archeology = false,
            map_info = {},
            x = 670,
            y = 70
        }
    end
    g.aoh_settings = settings
    Archeology_helper_save_settings()
end

function archeology_helper_on_init()
    if not g.aoh_settings then
        Archeology_helper_load_settings()
    end
    if not g.aoh_settings[g.cid] then
        g.aoh_settings[g.cid] = {
            sta_check = 0
        }
        Archeology_helper_save_settings()
    end
    local old_func = g.settings.archeology_helper.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.archeology_helper.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "au_map")
        return
    end
    Archeology_helper_start()
    g.setup_hook_and_event(g.addon, "_ARCHEOLOGY_MISSION_EXECUTE", "Archeology_helper_ARCHEOLOGY_MISSION_EXECUTE", true)
    g.setup_hook_and_event(g.addon, "TARGETSPACE_PRECHECK", "Archeology_helper_TARGETSPACE_PRECHECK", true)
end

function Archeology_helper_start()
    if g.get_map_type() == "City" and g.aoh_settings[g.cid].sta_check == 1 then
        local inv_item = session.GetInvItemByType(640009)
        if inv_item then
            if inv_item.count <= 10 then
                local msg = g.lang == "Japanese" and "スタミナ錠が残り少ないです" or
                                "Stamina pills are running low"
                imcAddOn.BroadMsg("NOTICE_Dm_!", msg, 10)
            end
        end
    end
    g.addon:RegisterMsg("MAP_CHARACTER_UPDATE", "Archeology_helper_MAP_CHARACTER_UPDATE")
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("Archeology_helper_run_update", 1.0)
    _nexus_addons:RunUpdateScript("Archeology_helper_stamina_update", 2.0)
    Archeology_helper_frame_init()
end

function Archeology_helper_stamina_update(_nexus_addons)
    local my_handle = session.GetMyHandle()
    if g.aoh_settings[g.cid].sta_check == 1 then
        local sta_item = 640009
        local stat = info.GetStat(my_handle)
        local sta_num = math.floor(stat.Stamina / 1000)
        if sta_num <= 1 then
            local now = imcTime.GetAppTime()
            if not g.ah_last_sta_time or (now - g.ah_last_sta_time >= 10.0) then
                local inv_item = session.GetInvItemByType(sta_item)
                if inv_item then
                    INV_ICON_USE(inv_item)
                    g.ah_last_sta_time = now
                end
            end
        end
    end
    return 1
end

function Archeology_helper_run_update(_nexus_addons)
    g.setup_hook_and_event(g.addon, "DRAW_CHAT_MSG", "Archeology_helper_DRAW_CHAT_MSG", true)
end

function Archeology_helper_DRAW_CHAT_MSG(my_frame, my_msg)
    if not g.aoh_settings then
        return
    end
    local groupboxname, startindex = g.get_event_args(my_msg)
    if not groupboxname or type(groupboxname) ~= "string" then
        return
    end
    local size = session.ui.GetMsgInfoSize(groupboxname)
    if size == 0 then
        return
    end
    local chat = session.ui.GetChatMsgInfo(groupboxname, size - 1)
    if not chat then
        return
    end
    local msg = chat:GetMsg()
    local config = nil
    if g.lang == "Japanese" then
        local jp_configs = {
            ["@dicID_^*$ETC_20220210_065695$*^"] = {
                size = 50,
                color = "FFFF0000"
            }, -- かなり遠い
            ["@dicID_^*$ETC_20220210_065696$*^"] = {
                size = 50,
                color = "FFFFA500"
            }, -- 遠い
            ["@dicID_^*$ETC_20220210_065697$*^"] = {
                size = 25,
                color = "FFFFFF00"
            }, -- 近い
            ["@dicID_^*$ETC_20220210_065699$*^"] = {
                size = 25,
                color = "FFFFFFFF"
            }, -- かなり近い
            ["@dicID_^*$ETC_20220210_065693$*^"] = {
                is_exit = true
            } -- 終了
        }
        config = jp_configs[msg]
    elseif g.lang == "kr" then
        if string.find(msg, "유물이") and string.find(msg, "것 같습니다") then -- 考古学メッセージ特有の単語（遺物が/ようです）で絞り込み
            if string.find(msg, "매우") and string.find(msg, "멀리") then
                config = {
                    size = 50,
                    color = "FFFF0000"
                } -- かなり遠い
            elseif string.find(msg, "매우") and string.find(msg, "가까이") then
                config = {
                    size = 25,
                    color = "FFFFFFFF"
                } -- かなり近い
            elseif string.find(msg, "멀리") then
                config = {
                    size = 50,
                    color = "FFFFA500"
                } -- 遠い
            elseif string.find(msg, "가까이") then
                config = {
                    size = 25,
                    color = "FFFFFF00"
                } -- 近い
            end
        elseif string.find(msg, "발굴 시도") and string.find(msg, "다시 임무") then
            config = {
                is_exit = true
            } -- 終了
        end
    else
        local en_configs = {
            ["@dicID_^*$ETC_20220204_066856$*^"] = {
                size = 50,
                color = "FFFF0000"
            }, -- かなり遠い
            ["@dicID_^*$ETC_20220204_066857$*^"] = {
                size = 50,
                color = "FFFFA500"
            }, -- 遠い
            ["@dicID_^*$ETC_20220204_066858$*^"] = {
                size = 25,
                color = "FFFFFF00"
            }, -- 近い
            ["@dicID_^*$ETC_20220204_066860$*^"] = {
                size = 25,
                color = "FFFFFFFF"
            }, -- かなり近い
            ["@dicID_^*$ETC_20220204_066854$*^"] = {
                is_exit = true
            } -- 終了
        }
        config = en_configs[msg]
    end
    if not config then
        return
    end
    local now = imcTime.GetAppTime()
    if g.ah_last_chat_time and (now - g.ah_last_chat_time < 1.0) then
        return
    end
    g.ah_last_chat_time = now
    local au_map = ui.GetFrame(addon_name_lower .. "au_map")
    if not au_map then
        return
    end
    if config.is_exit then
        g.aoh_display = 1
        g.aoh_settings.is_archeology = false
        g.aoh_settings.count = 0
        g.aoh_settings.map_info = {}
        Archeology_helper_frame_init()
    else
        local cur_map = session.GetMapName()
        local gbox = GET_CHILD(au_map, "gbox" .. cur_map)
        local map_pic = GET_CHILD(gbox, "map_pic" .. cur_map)
        if not map_pic then
            return
        end
        local my_handle = session.GetMyHandle()
        local pos = info.GetPositionInMap(my_handle, map_pic:GetWidth(), map_pic:GetHeight())
        Archeology_helper_create_marker(map_pic, pos, config.size, config.color)
        local count_text = GET_CHILD(au_map, "count_text")
        if count_text then
            count_text:SetText("{ol}" .. g.aoh_settings.count .. "/50")
        end
    end
    Archeology_helper_save_settings()
end

function Archeology_helper_TARGETSPACE_PRECHECK(my_frame, my_msg)
    local handle = g.get_event_args(my_msg)
    local actor = world.GetActor(handle)
    if not actor then
        return
    end
    if actor:GetType() == 155003 then
        g.aoh_settings.count = g.aoh_settings.count + 1
        local map_name = session.GetMapName()
        if not g.aoh_settings.map_info[map_name] then
            g.aoh_settings.map_info[map_name] = {}
        end
        g.aoh_settings.map_info[map_name].markers = {}
        g.aoh_settings.map_info[map_name].get_count = (g.aoh_settings.map_info[map_name].get_count or 0) + 1
        local is_all_complete = true
        local acc_obj = GetMyAccountObj()
        for i = 1, (max_archeology_map_count or 3) do
            local m_name = TryGetProp(acc_obj, "archeology_map_" .. i, "None")
            if m_name ~= "None" then
                local info = g.aoh_settings.map_info[m_name]
                if not info or (info.get_count or 0) < 3 then
                    is_all_complete = false
                    break
                end
            end
        end
        if is_all_complete then
            g.aoh_settings.is_archeology = false
            g.aoh_settings.count = 0
            g.aoh_settings.map_info = {}
            g.aoh_display = 1
            ui.SysMsg(g.lang == "Japanese" and "全てのMAPの発掘が完了しました" or
                          "Archeology completed for all maps")
        end
        Archeology_helper_save_settings()
        Archeology_helper_frame_init()
    end
end

function Archeology_helper_MAP_CHARACTER_UPDATE()
    local my_handle = session.GetMyHandle()
    local au_map = ui.GetFrame(addon_name_lower .. "au_map")
    if not au_map then
        return
    end
    AUTO_CAST(au_map)
    local map_pic = GET_CHILD_RECURSIVELY(au_map, "map_pic" .. g.map_name)
    AUTO_CAST(map_pic)
    local pos = info.GetPositionInMap(my_handle, map_pic:GetWidth(), map_pic:GetHeight())
    local my = GET_CHILD_RECURSIVELY(au_map, "my")
    if not my then
        return
    end
    AUTO_CAST(my)
    my:ShowWindow(0)
    my:SetOffset(pos.x - my:GetWidth() / 2, pos.y - my:GetHeight() / 2)
    local mapprop = session.GetCurrentMapProp()
    local angle = info.GetAngle(my_handle) - mapprop.RotateAngle
    my:SetAngle(angle)
    my:ShowWindow(1)
    map_pic:Invalidate()
end

function Archeology_helper_ARCHEOLOGY_MISSION_EXECUTE(my_frame, my_msg)
    g.aoh_settings.count = 0
    g.aoh_settings.is_archeology = true
    g.aoh_settings.map_info = {}
    Archeology_helper_save_settings()
    g.aoh_display = 0
    ui.DestroyFrame(addon_name_lower .. "au_map")
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("Archeology_helper_frame_init", 1.0)
end

function Archeology_helper_frame_init(_nexus_addons)
    g.map_name = session.GetMapName()
    if not g.aoh_settings.is_archeology then
        g.aoh_display = 1
    end
    local au_map = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "au_map", 0, 0, 0, 0)
    AUTO_CAST(au_map)
    au_map:SetSkinName("None")
    au_map:SetLayerLevel(94)
    au_map:EnableHittestFrame(1)
    au_map:EnableMove(1)
    au_map:ShowTitleBar(0)
    au_map:RemoveAllChild()
    au_map:SetPos(g.aoh_settings.x or 670, g.aoh_settings.y or 70)
    au_map:SetEventScript(ui.LBUTTONUP, "Archeology_helper_frame_save")
    local acc_obj = GetMyAccountObj()
    local disp_count = 0 -- ★追加: 表示位置計算用のカウンター
    for i = 1, (max_archeology_map_count or 3) do
        local map_name = TryGetProp(acc_obj, "archeology_map_" .. i, "None")
        if not g.aoh_settings.map_info[map_name] then
            g.aoh_settings.map_info[map_name] = {
                get_count = 0
            }
        end
        local map_cls = GetClass("Map", map_name)
        local is_complete = TryGetProp(acc_obj, 'archeology_map_' .. i .. '_complete', 0)
        if map_cls then
            local gbox = au_map:CreateOrGetControl("picture", "gbox" .. map_name, disp_count * 200, 20, 198, 220)
            AUTO_CAST(gbox)
            gbox:SetImage("fullwhite")
            gbox:SetEnableStretch(1)
            gbox:SetColorTone("AA696969")
            gbox:SetAlpha(50)
            -- gbox:SetSkinName("bg2")
            local title = gbox:CreateOrGetControl("richtext", "title", 5, 5)
            AUTO_CAST(title)
            title:SetText("{ol}{s13}" .. map_cls.Name)
            for j = 0, 2 do
                local mark = gbox:CreateOrGetControl("richtext", "mark" .. j, j * 15 + 10, 20)
                AUTO_CAST(mark)
                if (g.aoh_settings.map_info[map_name].get_count or 0) > j then
                    mark:SetText("{#00FF00}●")
                else
                    mark:SetText("{#808080}●")
                end
            end
            local map_pic = gbox:CreateOrGetControl("picture", "map_pic" .. map_name, 0, 20, 198, 200)
            AUTO_CAST(map_pic)
            map_pic:SetEnableStretch(1)
            map_pic:EnableHitTest(1)
            if g.map_name == map_name then
                local my = map_pic:CreateOrGetControl("picture", "my", 0, 0, 15, 15)
                AUTO_CAST(my)
                my:ShowWindow(0)
                my:SetImage("minimap_leader")
                my:SetEnableStretch(1)
                Archeology_helper_char_update(my, map_pic)
            end
            Archeology_helper_draw_markers(map_pic, map_name)
            local is_valid = ui.IsImageExist(map_name .. "_fog")
            if is_valid == false then
                world.PreloadMinimap(map_name)
            end
            map_pic:SetImage(map_name .. "_fog")
            local icon_group = map_pic:CreateOrGetControl("picture", "icon_group", ui.CENTER_HORZ, ui.CENTER_VERT,
                map_pic:GetWidth(), map_pic:GetHeight())
            AUTO_CAST(icon_group)
            icon_group:SetSkinName("None")
            local name_group = map_pic:CreateOrGetControl("picture", "name_group", ui.CENTER_HORZ, ui.CENTER_VERT,
                map_pic:GetWidth(), map_pic:GetHeight())
            AUTO_CAST(name_group)
            name_group:SetSkinName("None")
            -- UPDATE_MAP_BY_NAME(icon_group, map_name, map_pic, map_pic:GetWidth(), map_pic:GetHeight(), 0, 0)
            -- MAKE_MAP_AREA_INFO(name_group, map_name, "{s10}", map_pic:GetWidth(), map_pic:GetHeight(), -100, -30)
            local my_handle = session.GetMyHandle()
            local buff_info = info.GetBuff(my_handle, 70002)
            -- local is_token_state = session.loginInfo.IsPremiumState(ITEM_TOKEN)
            local image_name = ""
            if buff_info and GET_TOKEN_WARP_COOLDOWN() == 0 then
                image_name = "{img worldmap2_token_gold 30 30} {@st101lightbrown_16}"
            else
                image_name = "{img worldmap2_token_gray 30 30} {@st101lightbrown_16}"
            end
            local token = gbox:CreateOrGetControl("button", "token" .. i, 0, 0, 30, 30)
            AUTO_CAST(token)
            token:SetGravity(ui.RIGHT, ui.TOP)
            token:SetSkinName("None")
            token:SetText(image_name)
            token:SetUserValue("MAP_NAME", map_name)
            token:SetEventScript(ui.LBUTTONUP, "Archeology_helper_tokenwarp")
            disp_count = disp_count + 1 -- ★追加: 表示したらカウントアップ
        end
    end
    local display = au_map:CreateOrGetControl("picture", "display", 0, 0, 20, 20)
    AUTO_CAST(display)
    display:SetEnableStretch(1)
    display:EnableHitTest(1)
    local image = ""
    if not g.aoh_display or g.aoh_display == 0 then
        g.aoh_display = 0
        au_map:Resize(620, 240)
        au_map:SetLayerLevel(94)
        image = "btn_minus"
    elseif g.aoh_display == 1 then
        image = "btn_plus"
        au_map:Resize(20, 20)
        au_map:SetLayerLevel(11)
    end
    display:SetImage(image)
    display:SetEventScript(ui.LBUTTONUP, "Archeology_helper_frame_toggle")
    display:SetEventScript(ui.RBUTTONUP, "Archeology_helper_setting_frame")
    display:SetTextTooltip("{ol}left-click: Display / hide{nl}right-click: settings")
    local cool_down = au_map:CreateOrGetControl("richtext", "cool_down", 20, 0)
    AUTO_CAST(cool_down)
    local cd = GET_TOKEN_WARP_COOLDOWN()
    local minutes = math.floor(cd / 60)
    local seconds = cd % 60
    local timer = string.format("%d:%02d", minutes, seconds)
    cool_down:SetText("{ol}{#FFFFFF}TokenWarp CD: " .. timer)
    cool_down:RunUpdateScript("Archeology_helper_tokenwarp_cd", 1.0)
    local count_text = au_map:CreateOrGetControl("richtext", "count_text", cool_down:GetWidth() + 40, 0)
    AUTO_CAST(count_text)
    count_text:SetText("{ol}" .. g.aoh_settings.count .. "/50")
    local x = cool_down:GetWidth() + 40 + count_text:GetWidth()
    local slot = au_map:CreateOrGetControl('slot', 'slot', x + 10, 0, 20, 20)
    AUTO_CAST(slot)
    local item_cls = GetClassByType('Item', 11030018)
    SET_SLOT_ITEM_CLS(slot, item_cls)
    local item_count = au_map:CreateOrGetControl("richtext", "item_count", x + 35, 0)
    AUTO_CAST(item_count)
    local arc_text = au_map:CreateOrGetControl("richtext", "arc_text", x + 100, 0)
    AUTO_CAST(arc_text)
    local msg = ""
    if g.aoh_settings.is_archeology == true then
        msg = g.lang == "Japanese" and "{ol}{#FF0000}※進行中" or "{ol}{#FF0000}In Progress"
    else
        msg = g.lang == "Japanese" and "{ol}{#FF0000}※終了" or "{ol}{#FF0000}Ended"
        count_text:SetText("{ol}50/50")
    end
    arc_text:SetText(msg)
    local base_btn = au_map:CreateOrGetControl("button", "base_btn", 550, 0, 50, 20)
    AUTO_CAST(base_btn)
    base_btn:SetText("{ol}{s12}Base")
    base_btn:SetEventScript(ui.LBUTTONUP, "Archeology_helper_frame_base_pos")
    Archeology_helper_save_settings()
    au_map:ShowWindow(1)
    return 0
end

function Archeology_helper_setting_frame(au_map, display)
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "archeology_helper_setting", 0, 0, 0, 0)
    setting:SetPos(1220, 100)
    setting:SetSkinName("test_frame_low")
    setting:EnableHittestFrame(1)
    setting:EnableHitTest(1)
    setting:SetLayerLevel(999)
    setting:RemoveAllChild()
    local title_text = setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Archeology Helper Config")
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Archeology_helper_setting_frame_close")
    local gbox = setting:CreateOrGetControl("groupbox", "gbox", 10, 40, setting:GetWidth() - 20,
        setting:GetHeight() - 50) -- 945
    AUTO_CAST(gbox)
    gbox:EnableScrollBar(0)
    gbox:SetSkinName("test_frame_midle_light")
    local sta_check = gbox:CreateOrGetControl('checkbox', "sta_check", 10, 10, 30, 30)
    AUTO_CAST(sta_check)
    if not g.aoh_settings[g.cid] then
        g.aoh_settings[g.cid] = {
            sta_check = 0
        }
        Archeology_helper_save_settings()
    end
    sta_check:SetCheck(g.aoh_settings[g.cid].sta_check)
    sta_check:SetText(g.lang == "Japanese" and
                          "{ol}チェックするとスタミナ錠自動使用{nl}設定はキャラ毎です" or
                          "{ol}If checked, it will automatically use stamina pills{nl}Settings are per character")
    sta_check:SetEventScript(ui.LBUTTONUP, "Archeology_helper_setting_change")
    setting:Resize(sta_check:GetWidth() + 40, 120)
    gbox:Resize(setting:GetWidth() - 20, 70)
    setting:ShowWindow(1)
end

function Archeology_helper_setting_change()
    g.aoh_settings[g.cid].sta_check = 1 - g.aoh_settings[g.cid].sta_check
    Archeology_helper_save_settings()
end

function Archeology_helper_setting_frame_close(setting)
    ui.DestroyFrame(setting:GetName())
end

function Archeology_helper_frame_toggle(au_map, display)
    if not g.aoh_display or g.aoh_display == 1 then
        display:SetImage("btn_minus")
        g.aoh_display = 0
        au_map:Resize(620, 240)
    else
        display:SetImage("btn_plus")
        g.aoh_display = 1
        au_map:Resize(20, 20)
    end
end

function Archeology_helper_frame_save(au_map)
    g.aoh_settings.x = au_map:GetX()
    g.aoh_settings.y = au_map:GetY()
    Archeology_helper_save_settings()
end

function Archeology_helper_frame_base_pos(au_map, base_btn)
    g.aoh_settings.x = 670
    g.aoh_settings.y = 70
    Archeology_helper_save_settings()
    Archeology_helper_frame_init()
end

function Archeology_helper_draw_markers(map_pic, map_name)
    local markers = g.aoh_settings.map_info[map_name] and g.aoh_settings.map_info[map_name].markers or {}
    for _, m in ipairs(markers) do
        local circle = map_pic:CreateOrGetControl('picture', "circle" .. m.count, m.x - (m.size / 2),
            m.y - (m.size / 2), m.size, m.size)
        AUTO_CAST(circle)
        circle:SetImage("questmap")
        circle:SetColorTone(m.color)
        circle:SetEnableStretch(1)
        circle:SetEnable(0)
        local text_color = string.sub(m.color, 3)
        local marker_text = map_pic:CreateOrGetControl('richtext', "text" .. m.count, 0, 0)
        AUTO_CAST(marker_text)
        marker_text:SetText("{ol}{#" .. text_color .. "}{s14}" .. m.count)
        marker_text:SetOffset(m.x - (marker_text:GetWidth() / 2), m.y - (marker_text:GetHeight() / 2))
        circle:ShowWindow(1)
    end
end

function Archeology_helper_tokenwarp_cd(cool_down)
    local cd = GET_TOKEN_WARP_COOLDOWN()
    local minutes = math.floor(cd / 60)
    local seconds = cd % 60
    local timer = string.format("%d:%02d", minutes, seconds)
    cool_down:SetText("{ol}{#FFFFFF}TokenWarp CD: " .. timer)
    local my_handle = session.GetMyHandle()
    local au_map = cool_down:GetTopParentFrame()
    for i = 1, (max_archeology_map_count or 3) do
        local buff_info = info.GetBuff(my_handle, 70002)
        local image_name = ""
        if buff_info and GET_TOKEN_WARP_COOLDOWN() == 0 then
            image_name = "{img worldmap2_token_gold 30 30} {@st101lightbrown_16}"
        else
            image_name = "{img worldmap2_token_gray 30 30} {@st101lightbrown_16}"
        end
        local token = GET_CHILD_RECURSIVELY(au_map, "token" .. i)
        if token then
            AUTO_CAST(token)
            token:SetText(image_name)
        end
    end
    local slot = GET_CHILD(au_map, "slot")
    local icon = slot:GetIcon()
    if not icon then
        icon = CreateIcon(slot)
    end
    local item_count = GET_CHILD(au_map, "item_count")
    local inv_item = session.GetInvItemByType(11030018)
    if inv_item then
        icon:SetColorTone('FFFFFFFF')
        item_count:SetText("{ol}(" .. inv_item.count .. ")")
    else
        icon:SetColorTone('FFFF0000')
        item_count:SetText("{ol}(0)")
    end
    return 1
end

function Archeology_helper_create_marker(map_pic, pos, size, color)
    g.aoh_settings.count = (g.aoh_settings.count or 0) + 1
    local map_name = session.GetMapName()
    if not g.aoh_settings.map_info[map_name].markers then
        g.aoh_settings.map_info[map_name].markers = {}
    end
    table.insert(g.aoh_settings.map_info[map_name].markers, {
        x = pos.x,
        y = pos.y,
        size = size,
        color = color,
        count = g.aoh_settings.count
    })
    Archeology_helper_save_settings()
    local circle = map_pic:CreateOrGetControl('picture', "circle" .. g.aoh_settings.count, pos.x - (size / 2),
        pos.y - (size / 2), size, size)
    AUTO_CAST(circle)
    circle:SetImage("questmap")
    circle:SetColorTone(color)
    circle:SetEnableStretch(1)
    circle:SetEnable(0)
    local text_color = string.sub(color, 3)
    local marker_text = map_pic:CreateOrGetControl('richtext', "text" .. g.aoh_settings.count, 0, 0)
    AUTO_CAST(marker_text)
    marker_text:SetText("{ol}{#" .. text_color .. "}{s14}" .. g.aoh_settings.count)
    local offsetX = pos.x - (marker_text:GetWidth() / 2)
    local offsetY = pos.y - (marker_text:GetHeight() / 2)
    marker_text:SetOffset(offsetX, offsetY)
    circle:ShowWindow(1)
end

function Archeology_helper_char_update(my, map_pic)
    local my_handle = session.GetMyHandle()
    local pos = info.GetPositionInMap(my_handle, map_pic:GetWidth(), map_pic:GetHeight())
    my:SetOffset(pos.x - my:GetWidth() / 2, pos.y - my:GetHeight() / 2)
    local map_prop = session.GetCurrentMapProp()
    local angle = info.GetAngle(my_handle) - map_prop.RotateAngle
    my:SetAngle(angle)
    my:ShowWindow(1)
    map_pic:Invalidate()
end

function Archeology_helper_tokenwarp(frame, ctrl)
    local map_name = ctrl:GetUserValue("MAP_NAME")
    if map_name ~= "None" then
        WORLDMAP2_TOKEN_WARP(map_name)
    end
end
-- archeology_helper ここまで

-- easy_buff ここから
function Easy_buff_save_settings()
    g.save_json(g.easy_buff_path, g.easy_buff_settings)
end

function Easy_buff_load_settings()
    g.easy_buff_path = string.format("../addons/%s/%s/easy_buff.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.easy_buff_path)
    if not settings then
        settings = {}
    end
    local defaults = {
        food_presets_name = {},
        food_presets_check = {},
        food_check = 1,
        confirm_check = 0,
        repair_check = 0
    }
    for k, v in pairs(defaults) do
        if settings[k] == nil then
            settings[k] = v
        end
    end
    local changed = false
    for i = 1, 4 do
        local str_i = tostring(i)
        if not settings.food_presets_name[str_i] then
            settings.food_presets_name[str_i] = "preset " .. i
            changed = true
        end
        if not settings.food_presets_check[str_i] then
            settings.food_presets_check[str_i] = {}
            changed = true
        end
        for check_index = 1, 6 do
            local str_index = tostring(check_index)
            if not settings.food_presets_check[str_i][str_index] then
                settings.food_presets_check[str_i][str_index] = 1
                changed = true
            end
        end
    end
    g.easy_buff_settings = settings
    if changed then
        Easy_buff_save_settings()
    end
end

function easy_buff_on_init()
    if not g.easy_buff_settings then
        Easy_buff_load_settings()
    end
    local old_func = g.settings.easy_buff.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, "OPEN_FOOD_TABLE_UI", "Easy_buff_OPEN_FOOD_TABLE_UI", true)
    g.setup_hook_and_event(g.addon, "ITEMBUFF_REPAIR_UI_COMMON", "Easy_buff_ITEMBUFF_REPAIR_UI_COMMON", true)
    g.setup_hook_and_event(g.addon, "SQUIRE_BUFF_EQUIP_CTRL", "Easy_buff_SQUIRE_BUFF_EQUIP_CTRL", true)
    g.setup_hook_and_event(g.addon, "TARGET_BUFF_AUTOSELL_LIST", "Easy_buff_TARGET_BUFF_AUTOSELL_LIST", true)
    g.easy_buff_first = true
end
-- 設定フレーム
function Easy_buff_config_frame()
    local frame_name = addon_name_lower .. "easy_buff"
    local easy_buff = ui.CreateNewFrame("notice_on_pc", frame_name, 0, 0, 0, 0)
    easy_buff:RemoveAllChild()
    easy_buff:SetSkinName("test_frame_low")
    easy_buff:SetLayerLevel(999)
    easy_buff:Resize(490, 410)
    local list_frame_name = addon_name_lower .. "list_frame"
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    -- ts(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    easy_buff:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    easy_buff:SetTitleBarSkin("None")
    easy_buff:EnableHittestFrame(1)
    easy_buff:EnableHitTest(1)
    easy_buff:ShowWindow(1)
    local title_text = easy_buff:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Easy Buff Config")
    local close = easy_buff:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Easy_buff_config_frame_close")
    local gbox = easy_buff:CreateOrGetControl("groupbox", "gbox", 10, 40, easy_buff:GetWidth() - 20,
        easy_buff:GetHeight() - 50)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local icons = {"icon_item_sandwich", "icon_item_soup", "icon_item_yogurt", "icon_item_salad", "icon_item_BBQ",
                   "icon_item_champagne"}
    local x_offsets = {5, 75, 145, 215, 285, 355}
    local y = 0
    for i = 1, 4 do
        local str_i = tostring(i)
        local title_edit = gbox:CreateOrGetControl('edit', "preset_title_" .. i, 10, y + 5, 80, 20)
        AUTO_CAST(title_edit)
        title_edit:SetFontName('white_14_ol')
        title_edit:SetSkinName('test_weight_skin')
        title_edit:SetTextAlign('center', 'center')
        title_edit:SetText("{ol}" .. g.easy_buff_settings.food_presets_name[str_i])
        if str_i == "1" then
            title_edit:Focus()
        end
        title_edit:SetEventScript(ui.ENTERKEY, "Easy_buff_config_presetname_change")
        local food_check = gbox:CreateOrGetControl('checkbox', "food_check" .. i, 10, y + 35, 30, 30)
        AUTO_CAST(food_check)
        food_check:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると食事バフ自動化" or
                                      "{ol}Checked: Automate food buff")
        food_check:SetEventScript(ui.LBUTTONUP, "Easy_buff_config_check_toggle")
        food_check:SetEventScriptArgNumber(ui.LBUTTONUP, i)
        food_check:SetCheck(i == g.easy_buff_settings.food_check and 1 or 0)
        local preset_gbox = gbox:CreateOrGetControl("groupbox", "preset_gbox_" .. i, 40, y + 30, gbox:GetWidth() - 50,
            40)
        AUTO_CAST(preset_gbox)
        preset_gbox:SetSkinName("test_frame_midle_light")
        for check_index = 1, #icons do
            local str_index = tostring(check_index)
            local icon_name = icons[check_index]
            local checkbox_x = x_offsets[check_index]
            local checkbox_name = "check_" .. i .. "_" .. check_index
            local checkbox_ctrl = preset_gbox:CreateOrGetControl('checkbox', checkbox_name, checkbox_x, 5, 30, 30)
            AUTO_CAST(checkbox_ctrl)
            checkbox_ctrl:SetText("{img " .. icon_name .. " 30 30}")
            checkbox_ctrl:SetCheck(g.easy_buff_settings.food_presets_check[str_i][str_index])
            checkbox_ctrl:SetEventScript(ui.LBUTTONUP, "Easy_buff_config_check_toggle")
        end
        y = y + 70
    end
    local confirm_check = gbox:CreateOrGetControl('checkbox', "confirm_check", 10, y + 10, 30, 30)
    AUTO_CAST(confirm_check)
    confirm_check:SetText(g.lang == "Japanese" and
                              "{ol}チェックするとバフ掛け直し確認(残り1時間以上)" or
                              "{ol}Check to Confirm Re-buffing (remaining over 1h)")
    confirm_check:SetEventScript(ui.LBUTTONUP, "Easy_buff_config_check_toggle")
    confirm_check:SetCheck(g.easy_buff_settings.confirm_check)
    -- repair_check
    local repair_check = gbox:CreateOrGetControl('checkbox', "repair_check", 10, y + 45, 30, 30)
    AUTO_CAST(repair_check)
    repair_check:SetText(g.lang == "Japanese" and
                             "{ol}チェックすると修理屋フレームを自動で閉じます" or
                             "{ol}Check to Auto-close Repair Shop Frame")
    repair_check:SetEventScript(ui.LBUTTONUP, "Easy_buff_config_check_toggle")
    repair_check:SetCheck(g.easy_buff_settings.repair_check)
end

function Easy_buff_config_frame_close(frame)
    ui.DestroyFrame(frame:GetName())
end

function Easy_buff_config_presetname_change(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    local last_char = string.sub(ctrl_name, -1)
    local text = ctrl:GetText()
    local msg = g.lang == "Japanese" and text .. "{ol} 設定しました" or "{ol} Set up"
    ui.SysMsg(msg)
    g.easy_buff_settings.food_presets_name[last_char] = text
    Easy_buff_save_settings()
    Easy_buff_config_frame()
end

function Easy_buff_config_check_toggle(parent, ctrl, str, num)
    local ctrl_name = ctrl:GetName()
    local is_check = ctrl:IsChecked()
    if string.find(ctrl_name, "food_check") then
        if is_check == 1 then
            g.easy_buff_settings.food_check = num
        else
            g.easy_buff_settings.food_check = 0
        end
    elseif ctrl_name == "confirm_check" then
        g.easy_buff_settings.confirm_check = is_check
    elseif ctrl_name == "repair_check" then
        g.easy_buff_settings.repair_check = is_check
    else
        local preset_str, check_str = string.match(ctrl_name, "^check_(%d)_(%d)$")
        g.easy_buff_settings.food_presets_check[preset_str][check_str] = is_check
    end
    Easy_buff_save_settings()
    Easy_buff_config_frame()
end
-- メシ屋
function Easy_buff_OPEN_FOOD_TABLE_UI(my_frame, my_msg)
    if g.settings.easy_buff.use == 0 then
        return
    end
    local group_name, sell_type, handle, seller_cid, shared = g.get_event_args(my_msg)
    local foodtable_ui = ui.GetFrame("foodtable_ui")
    local actor = world.GetActor(handle)
    local apc = actor:GetPCApc()
    local aid = apc:GetAID()
    local info = session.party.GetPartyMemberInfoByAID(PARTY_GUILD, aid)
    if not info and shared == 1 then
        local msg = g.lang == "Japanese" and "ギルドメンバーのみに食事提供のお店です" or
                        "This shop provides food exclusively to guild members"
        ui.SysMsg(msg)
        foodtable_ui:ShowWindow(0)
        return
    end
    local x = 300
    local y = 60
    local btn
    for i = 1, 4 do
        local str_i = tostring(i)
        btn = foodtable_ui:CreateOrGetControl("button", "btn" .. i, x, y, 85, 30)
        AUTO_CAST(btn)
        btn:SetSkinName(i == g.easy_buff_settings.food_check and "test_red_button" or "test_gray_button")
        local text = g.easy_buff_settings.food_presets_name[str_i] or "{ol}preset " .. i
        btn:SetText("{ol}" .. text)
        btn:SetEventScript(ui.LBUTTONUP, "Easy_buff_clear_food_buff_timer")
        if btn:GetWidth() >= 85 then
            btn:Resize(85, 30)
        end
        if i == 1 then
            x = x + 80
        elseif i == 2 then
            x = 300
            y = 90
        elseif i == 3 then
            x = x + 80
        end
    end
    if g.easy_buff_settings.food_check ~= 0 and g.easy_buff_first then
        Easy_buff_clear_food_buff_timer(nil, btn)
        g.easy_buff_first = false
    end
end

function Easy_buff_clear_food_buff_timer(frame, btn)
    btn:RunUpdateScript("Easy_buff_clear_food_buff", 0.1)
end

function Easy_buff_clear_food_buff(btn)
    local food_buffs = {4021, 4022, 4023, 4024, 4087, 4136}
    local my_handle = session.GetMyHandle()
    for _, buff_id in ipairs(food_buffs) do
        local buff = info.GetBuff(my_handle, buff_id)
        if buff then
            packet.ReqRemoveBuff(buff_id)
            return 1
        end
    end
    btn:StopUpdateScript("Easy_buff_clear_food_buff")
    Easy_buff_set_food_buff(btn)
    return 0
end

function Easy_buff_set_food_buff(btn)
    local preset_index_str
    if g.easy_buff_settings.food_check ~= 0 then
        preset_index_str = tostring(g.easy_buff_settings.food_check)
    elseif btn then
        preset_index_str = string.sub(btn:GetName(), -1)
    else
        return
    end
    g.easy_buff_temp_food = {}
    for key, value in pairs(g.easy_buff_settings.food_presets_check[preset_index_str]) do
        if value == 1 then
            local num_key = tonumber(key)
            if num_key then
                table.insert(g.easy_buff_temp_food, num_key - 1)
            end
        end
    end
    table.sort(g.easy_buff_temp_food, function(a, b)
        return a > b
    end)
    if #g.easy_buff_temp_food > 0 then
        Easy_buff_eat_food(btn)
        btn:RunUpdateScript("Easy_buff_eat_food", 0.6)
    end
end

function Easy_buff_eat_food(btn)
    local foodtable_ui = ui.GetFrame("foodtable_ui")
    if foodtable_ui:IsVisible() == 0 then
        g.easy_buff_first = true
        return 0
    end
    local handle = foodtable_ui:GetUserIValue("HANDLE")
    local sell_type = foodtable_ui:GetUserIValue("SELLTYPE")
    if #g.easy_buff_temp_food > 0 then
        session.autoSeller.Buy(handle, g.easy_buff_temp_food[#g.easy_buff_temp_food], 1, sell_type)
        table.remove(g.easy_buff_temp_food, #g.easy_buff_temp_food)
        imcSound.PlaySoundEvent('system_craft_potion_succes')
        return 1
    else
        g.easy_buff_first = true
        foodtable_ui:ShowWindow(0)
        return 0
    end
end
-- バフ屋
function Easy_buff_TARGET_BUFF_AUTOSELL_LIST(my_frame, my_msg)
    if g.settings.easy_buff.use == 0 then
        return
    end
    local group_name, sell_type, handle = g.get_event_args(my_msg)
    if sell_type ~= 0 then
        return
    end
    local buffseller_target = ui.GetFrame("buffseller_target")
    if buffseller_target:HaveUpdateScript("Easy_buff_buy_buffs_update") == true or
        buffseller_target:HaveUpdateScript("Easy_buff_end_process") == true then
        return
    end
    local item_count = session.autoSeller.GetCount(group_name)
    for i = 0, item_count - 1 do
        local item_info = session.autoSeller.GetByIndex(group_name, i)
        if not item_info then
            ui.SysMsg(g.lang == "Japanese" and "お店のバフアイテムが足りません" or
                          "Insufficient buff items at the shop")
            return
        end
    end
    local my_handle = session.GetMyHandle()
    local buff_ids_to_check = {358, 359, 360, 370}
    local needs_rebuff = false
    for _, buff_id in ipairs(buff_ids_to_check) do
        local buff = info.GetBuff(my_handle, buff_id)
        -- バフが無い、または残り時間が60分以下なら購入対象
        if not buff then
            needs_rebuff = true
            break
        end
        if buff.time <= 3600000 then -- 60分 (ms)
            needs_rebuff = true
            break
        end
    end
    if needs_rebuff then
        Easy_buff_buy_buffs(handle)
        return
    else
        if g.easy_buff_settings.confirm_check == 1 then
            local msg_text = g.lang == "Japanese" and "{#FFFFFF}{ol}バフをかけ直しますか？" or
                                 "{#FFFFFF}{ol}Do you want to reapply the buff?"
            local yes_script = string.format("Easy_buff_buy_buffs(%d)", handle)
            local no_script = "Easy_buff_end_process()"
            ui.MsgBox(msg_text, yes_script, no_script)
        else
            Easy_buff_buy_buffs(handle)
            return
        end
    end
end

function Easy_buff_buy_buffs(handle)
    local buffseller_target = ui.GetFrame("buffseller_target")
    buffseller_target:SetUserValue("HANDLE", handle)
    buffseller_target:SetUserValue("BUFF_INDEX", 0)
    buffseller_target:SetUserValue("RETRY_COUNT", 0)
    buffseller_target:RunUpdateScript("Easy_buff_buy_buffs_update", 0.6)
end

function Easy_buff_buy_buffs_update(buffseller_target)
    local buff_index = buffseller_target:GetUserIValue("BUFF_INDEX")
    if buff_index <= 3 then
        local handle = buffseller_target:GetUserIValue("HANDLE")
        session.autoSeller.Buy(handle, buff_index, 1, 0)
        buffseller_target:SetUserValue("BUFF_INDEX", buff_index + 1)
        return 1
    else
        buffseller_target:RunUpdateScript("Easy_buff_end_process", 0.6)
        return 0
    end
end

function Easy_buff_end_process(buffseller_target)
    if not buffseller_target then
        buffseller_target = ui.GetFrame("buffseller_target")
    end
    local my_handle = session.GetMyHandle()
    local buff_check = {358, 359, 360, 370}
    local retry_count = buffseller_target:GetUserIValue("RETRY_COUNT")
    for i, buff_id in ipairs(buff_check) do
        local buff = info.GetBuff(my_handle, buff_id)
        if not buff or buff.time <= 3540000 then
            if retry_count < 3 then
                local handle = buffseller_target:GetUserIValue("HANDLE")
                session.autoSeller.Buy(handle, i - 1, 1, 0)
                buffseller_target:SetUserValue("RETRY_COUNT", retry_count + 1)
                return 1 -- 再チェックへ
            else
                ui.SysMsg(g.lang == "Japanese" and "バフの購入に失敗しました" or "Failed to purchase buff")
                break
            end
        end
    end
    buffseller_target:ShowWindow(0)
    return 0
end
-- 修理
function Easy_buff_ITEMBUFF_REPAIR_UI_COMMON(my_frame, my_msg)
    if g.settings.easy_buff.use == 0 then
        return
    end
    local itembuffrepair = ui.GetFrame("itembuffrepair")
    session.ResetItemList()
    local handle = itembuffrepair:GetUserValue("HANDLE")
    local skill_name = itembuffrepair:GetUserValue("SKILLNAME")
    local slot_set = GET_CHILD_RECURSIVELY(itembuffrepair, "slotlist", "ui::CSlotSet")
    local slot_count = slot_set:GetSlotCount()
    local cheapest = nil
    local price = 0
    local iesid = ""
    for i = 0, slot_count - 1 do
        local slot = slot_set:GetSlotByIndex(i)
        if slot:GetIcon() then
            local icon = slot:GetIcon()
            local icon_info = icon:GetInfo()
            local inv_item = GET_ITEM_BY_GUID(icon_info:GetIESID())
            if inv_item then
                local item_obj = GetIES(inv_item:GetObject())
                local need_item, need_count = ITEMBUFF_NEEDITEM_Squire_Repair(GetMyPCObject(), item_obj)
                if need_count < price or price == 0 then
                    cheapest = slot
                    price = need_count
                    iesid = icon_info:GetIESID()
                end
            end
        end
    end
    if cheapest then
        session.AddItemID(iesid)
        local auto_sell_index = 2 -- 元コードのAUTO_SELL_SQUIRE_BUFFが2
        session.autoSeller.BuyItems(handle, auto_sell_index, session.GetItemIDList(), skill_name)
        imcSound.PlaySoundEvent('system_craft_potion_succes')
    end
    itembuffrepair:RunUpdateScript("Easy_buff_repair_msg", 1.5)
end

function Easy_buff_repair_msg(itembuffrepair)
    local repair_buffs = {3127, 3128, 3129} -- 3127魔法 3128機敏 3129防御
    local my_handle = session.GetMyHandle()
    for _, buff_id in ipairs(repair_buffs) do
        local buff = info.GetBuff(my_handle, buff_id)
        if buff then
            local format_string
            if g.lang == "Japanese" then
                format_string = "%s バフを有効化"
            else
                format_string = "%s Activate Buff"
            end
            local buff_cls = GetClassByType("Buff", buff_id)
            local msg = string.format(format_string, buff_cls.Name)
            imcAddOn.BroadMsg("NOTICE_Dm_Bell", msg, 2.5)
            CHAT_SYSTEM(msg)
        end
    end
    if g.easy_buff_settings.repair_check == 1 then
        itembuffrepair:ShowWindow(0)
        local inventory = ui.GetFrame("inventory")
        if inventory:IsVisible() == 1 then
            ui.ToggleFrame('inventory')
        end
    end
end
-- メンテ処理
function Easy_buff_SQUIRE_BUFF_EQUIP_CTRL(my_frame, my_msg)
    if g.settings.easy_buff.use == 0 then
        return
    end
    local itembuffopen = ui.GetFrame("itembuffopen")
    itembuffopen:StopUpdateScript("Easy_buff_squire_frame_close")
    itembuffopen:RunUpdateScript("Easy_buff_squire_buff_equip_ctrl_update", 0.5)
    return
end

function Easy_buff_squire_buff_equip_ctrl_update(itembuffopen)
    if session.GetMyHandle() == itembuffopen:GetUserIValue("HANDLE") then
        return
    end
    local close = GET_CHILD_RECURSIVELY(itembuffopen, 'close')
    AUTO_CAST(close)
    close:SetEventScript(ui.LBUTTONUP, "Easy_buff_squire_timestop_frame_close")
    local checkall = GET_CHILD_RECURSIVELY(itembuffopen, 'checkall')
    AUTO_CAST(checkall)
    checkall:SetCheck(1)
    SQUIRE_BUFF_EQUIP_SELECT_ALL(itembuffopen, checkall)
    local btn_excute = GET_CHILD_RECURSIVELY(itembuffopen, "btn_excute")
    SQUIRE_BUFF_EXCUTE(itembuffopen, btn_excute)
    local str = g.lang == "Japanese" and
                    "{ol}装備メンテナンス自動付与中{nl}フレームを閉じればキャンセルします" or
                    "{ol}Equipment maintenance automatic grant is in progress{nl}Canceled when frame is closed"
    ui.SysMsg(str)
    itembuffopen:StopUpdateScript("Easy_buff_squire_buff_equip_ctrl_update")
    itembuffopen:RunUpdateScript("Easy_buff_squire_frame_close", 5.5)
end

function Easy_buff_squire_timestop_frame_close()
    packet.StopTimeAction(1)
    ui.CloseFrame("itembuffopen")
end

function Easy_buff_squire_frame_close(itembuffopen)
    itembuffopen:ShowWindow(0)
    return 0
end
-- easy_buff ここまで

-- continue_reinforce ここから
g.continue_reinforce = {
    use = true,
    rf_count = 0,
    limit_clear = false,
    is_first = false,
    delay = 0.1,
    count = 0,
    premium_mat = false,
    normal_mat = false,
    inv_tbl = {}
}
function continue_reinforce_on_init()
    if g.settings.continue_reinforce.use == 0 then
        return
    end
    g.setup_hook_and_event(g.addon, "GODDESS_MGR_TAB_CHANGE", "Continue_reinforce_GODDESS_MGR_TAB_CHANGE", true)
    g.setup_hook_and_event(g.addon, "GODDESS_EQUIP_MANAGER_OPEN", "Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN", true)
    g.setup_hook_and_event(g.addon, "GODDESS_MGR_REFORGE_REG_ITEM", "Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM",
        true)
    g.setup_hook_and_event(g.addon, "_END_REFORGE_REINFORCE_EXEC", "Continue_reinforce__END_REFORGE_REINFORCE_EXEC",
        true)
    g.setup_hook_and_event(g.addon, "GODDESS_MGR_REFORGE_ITEM_REMOVE",
        "Continue_reinforce_GODDESS_MGR_REFORGE_ITEM_REMOVE", true)
    g.setup_hook_and_event(g.addon, "GODDESS_MGR_REFORGE_TAB_CHANGE",
        "Continue_reinforce_GODDESS_MGR_REFORGE_TAB_CHANGE", true)
end

function Continue_reinforce_GODDESS_MGR_TAB_CHANGE()
    local goddess_equip_manager = ui.GetFrame('goddess_equip_manager')
    local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'main_tab')
    local tab_index = main_tab:GetSelectItemIndex()
    if tab_index == 0 then
        Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
    else
        goddess_equip_manager:RemoveChild("gbox")
    end
end

function Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
    local goddess_equip_manager = ui.GetFrame('goddess_equip_manager')
    local reinf_left_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'reinf_left_bg')
    local reinf_no_msgbox = GET_CHILD_RECURSIVELY(reinf_left_bg, 'reinf_no_msgbox')
    AUTO_CAST(reinf_no_msgbox)
    if g.continue_reinforce.use and g.settings.continue_reinforce.use == 1 then
        reinf_no_msgbox:SetCheck(1)
        reinf_no_msgbox:SetMargin(-30, 0, 0, 110)
    else
        reinf_no_msgbox:SetCheck(0)
        reinf_no_msgbox:SetMargin(0, 0, 0, 110)
    end
    local ref_ok_reinforce = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_ok_reinforce')
    AUTO_CAST(ref_ok_reinforce)
    ref_ok_reinforce:SetSkinName("baseyellow_btn")
    if g.continue_reinforce.use and g.settings.continue_reinforce.use == 1 then
        ref_ok_reinforce:Resize(100, 70)
        local ref_ok_text = ref_ok_reinforce:GetTextByKey("value")
        ref_ok_reinforce:SetText(ref_ok_text)
        local rect = ref_ok_reinforce:GetMargin()
        ref_ok_reinforce:SetPos(-30, rect.bottom)
    else
        ref_ok_reinforce:Resize(160, 70)
        local ref_do_text = ref_ok_reinforce:GetTextByKey("value")
        ref_ok_reinforce:SetText(ref_do_text)
        local rect = ref_ok_reinforce:GetMargin()
        ref_ok_reinforce:SetPos(0, rect.bottom)
    end
    local ref_do_reinforce = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_do_reinforce')
    AUTO_CAST(ref_do_reinforce)
    if g.continue_reinforce.use and g.settings.continue_reinforce.use == 1 then
        ref_do_reinforce:Resize(100, 70)
        local ref_do_text = ref_do_reinforce:GetTextByKey("value")
        ref_do_reinforce:SetText(ref_do_text)
        local rect = ref_do_reinforce:GetMargin()
        ref_do_reinforce:SetPos(-30, rect.bottom)
    else
        ref_do_reinforce:Resize(160, 70)
        local ref_do_text = ref_do_reinforce:GetTextByKey("value")
        ref_do_reinforce:SetText(ref_do_text)
        local rect = ref_do_reinforce:GetMargin()
        ref_do_reinforce:SetPos(0, rect.bottom)
    end
    reinf_left_bg:RemoveChild("cancel")
    if g.continue_reinforce.use and g.settings.continue_reinforce.use == 1 then
        local cancel = reinf_left_bg:CreateOrGetControl("button", "cancel", 0, 647, 100, 70)
        AUTO_CAST(cancel)
        cancel:SetEventScript(ui.LBUTTONDOWN, "Continue_reinforce_stop_script")
        cancel:SetSkinName("test_red_button")
        cancel:SetText("{@st41b}{s18}Cancel")
    end
    local use_toggle =
        reinf_left_bg:CreateOrGetControl('picture', "use_toggle", 315, reinf_no_msgbox:GetY() - 5, 60, 30)
    AUTO_CAST(use_toggle)
    local icon_name = "test_com_ability_on"
    if g.continue_reinforce.use == false then
        icon_name = "test_com_ability_off"
    end
    use_toggle:SetImage(icon_name)
    use_toggle:SetEnableStretch(1)
    use_toggle:EnableHitTest(1)
    use_toggle:SetTextTooltip(g.lang == "Japanese" and "{ol}ON/Continue Reinfoceを使用" or
                                  "{ol}ON/Use Continue Reinforce")
    use_toggle:SetEventScript(ui.LBUTTONUP, "Continue_reinforce_setting_change")
    goddess_equip_manager:RemoveChild("gbox")
    if g.continue_reinforce.use and g.settings.continue_reinforce.use == 1 then
        local gbox = goddess_equip_manager:CreateOrGetControl("groupbox", "gbox", 1035, 755, 180, 110)
        AUTO_CAST(gbox)
        gbox:SetSkinName("None")
        gbox:RunUpdateScript("Continue_reinforce_run_update_script", 0.5)
        g.continue_reinforce.inv_tbl = {}
        gbox:SetUserValue("IESID", "None")
        local clear = gbox:CreateOrGetControl("button", "clear", 0, 0, 60, 30)
        AUTO_CAST(clear)
        clear:SetText("{ol}clear")
        clear:SetSkinName("test_red_button")
        clear:SetTextTooltip(g.lang == "Japanese" and "{ol}強化回数制限をクリアーします" or
                                 "{ol}Clear the reinforcement count limit")
        clear:SetEventScript(ui.LBUTTONUP, "Continue_reinforce_setting_change")
        local normal = gbox:CreateOrGetControl("button", "normal", 60, 0, 60, 30)
        AUTO_CAST(normal)
        normal:SetText("{ol}{s13}normal") -- relic_btn_purple
        normal:SetSkinName("relic_btn_purple")
        normal:SetTextTooltip(g.lang == "Japanese" and "{ol}強化補助剤をセットします" or
                                  "{ol}Set the reinforcement aid")
        normal:SetEventScript(ui.LBUTTONUP, "Continue_reinforce_mat_select")
        local premium = gbox:CreateOrGetControl("button", "premium", 120, -4, 60, 36)
        AUTO_CAST(premium)
        premium:SetText("{ol}{s10}Premium")
        premium:SetSkinName("baseyellow_btn")
        premium:SetTextTooltip(g.lang == "Japanese" and "{ol}プレミアム強化補助剤をセットします" or
                                   "{ol}Set the Premium Reinforcement Aid")
        premium:SetEventScript(ui.LBUTTONUP, "Continue_reinforce_mat_select")
        local x = 30
        local y = 30
        local text = 1
        for i = 0, 9 do
            local number = gbox:CreateOrGetControl("button", "number" .. i, x + 30 * i, y, 30, 25)
            AUTO_CAST(number)
            number:SetEventScript(ui.LBUTTONDOWN, "Continue_reinforce_count_input")
            number:SetEventScriptArgNumber(ui.LBUTTONDOWN, text)
            number:SetText("{ol}" .. text)
            if i == 4 then
                x = 30 - 5 * 30
                y = 55
                text = text + 5
            elseif i >= 5 then
                text = text + 5
            else
                text = text + 1
            end
        end
        local clear_toggle = gbox:CreateOrGetControl('picture', "clear_toggle", 30, 80, 60, 30)
        AUTO_CAST(clear_toggle)
        local icon_name = "test_com_ability_on"
        if g.continue_reinforce.limit_clear == false then
            icon_name = "test_com_ability_off"
        end
        clear_toggle:SetImage(icon_name)
        clear_toggle:SetEnableStretch(1)
        clear_toggle:EnableHitTest(1)
        clear_toggle:SetTextTooltip(g.lang == "Japanese" and
                                        "{ol}ON/回数制限到達時に制限をクリアーします" or
                                        "{ol}upon reaching the limit")
        clear_toggle:SetEventScript(ui.LBUTTONUP, "Continue_reinforce_setting_change")
        local count_edit = gbox:CreateOrGetControl('edit', 'count_edit', 95, 80, 55, 30)
        AUTO_CAST(count_edit)
        count_edit:SetFontName("white_16_ol")
        count_edit:SetTextAlign("center", "center")
        count_edit:SetText(g.continue_reinforce.rf_count ~= 0 and "{ol}" .. g.continue_reinforce.rf_count or "")
        count_edit:SetNumberMode(0)
        count_edit:SetMaxLen(2)
        count_edit:SetTypingScp("Continue_reinforce_count_input")
        count_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}強化回数制限" or
                                      "{ol}Continuous Reinforcement Limit")
    end
end

function Continue_reinforce_setting_change(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "use_toggle" then
        if g.continue_reinforce.use == true then
            g.continue_reinforce.use = false
            ctrl:SetImage("test_com_ability_off")
        else
            g.continue_reinforce.use = true
            ctrl:SetImage("test_com_ability_on")
        end
    elseif ctrl_name == "clear" then
        g.continue_reinforce.rf_count = 0
        local format_string
        local limit_text
        if g.lang == "Japanese" then
            format_string = "強化制限回数を %s に設定しました"
            limit_text = "無制限"
        else
            format_string = "Continuous Reinforcement Limit set to %s"
            limit_text = "Unlimited"
        end
        local msg = string.format(format_string, limit_text)
        imcAddOn.BroadMsg("NOTICE_Dm_Bell", msg, 2.5)
    elseif ctrl_name == "clear_toggle" then
        if g.continue_reinforce.limit_clear == true then
            g.continue_reinforce.limit_clear = false
            ctrl:SetImage("test_com_ability_off")
        else
            g.continue_reinforce.limit_clear = true
            ctrl:SetImage("test_com_ability_on")
        end
    end
    Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
end

function Continue_reinforce_count_input(parent, ctrl, str, num)
    if ctrl:GetName() ~= "count_edit" then
        local count_edit = GET_CHILD(parent, "count_edit")
        count_edit:SetText("{ol}" .. num)
        g.continue_reinforce.rf_count = num
    else
        local number_text = string.gsub(ctrl:GetText(), "%D", "")
        number_text = tonumber(number_text)
        if number_text then
            g.continue_reinforce.rf_count = number_text
        else
            g.continue_reinforce.rf_count = 0
        end
    end
    g.continue_reinforce.is_first = false
    ctrl:StopUpdateScript("Continue_reinforce_save_settings_reserve")
    ctrl:RunUpdateScript("Continue_reinforce_save_settings_reserve", 0.5)
end

function Continue_reinforce_save_settings_reserve(ctrl)
    Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
    local count_text
    if g.continue_reinforce.rf_count == 0 then
        count_text = g.lang == "Japanese" and "無制限" or "Unlimited"
    else
        count_text = g.continue_reinforce.rf_count
    end
    local format_string
    if g.lang == "Japanese" then
        format_string = "強化制限回数を %s に設定しました"
    else
        format_string = "Continuous Reinforcement Limit set to %s"
    end
    local msg = string.format(format_string, count_text)
    imcAddOn.BroadMsg("NOTICE_Dm_Bell", msg, 2.5)
end

function Continue_reinforce_stop_process(goddess_equip_manager)
    goddess_equip_manager:StopUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REINFORCE_EXEC")
    g.continue_reinforce.is_first = false
    Continue_reinforce_next_mat_set(goddess_equip_manager, false)
    if g.continue_reinforce.limit_clear then
        g.continue_reinforce.rf_count = 0
        Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
        return true
    end
    return false
end

function Continue_reinforce__END_REFORGE_REINFORCE_EXEC()
    if not g.continue_reinforce.use or g.settings.continue_reinforce.use == 0 then
        return
    end
    local goddess_equip_manager = ui.GetFrame('goddess_equip_manager')
    local reinf_left_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, "reinf_left_bg")
    local ref_ok_reinforce = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_ok_reinforce')
    ref_ok_reinforce:ShowWindow(0)
    local ref_do_reinforce = GET_CHILD_RECURSIVELY(goddess_equip_manager, "ref_do_reinforce")
    AUTO_CAST(ref_do_reinforce)
    ref_do_reinforce:ShowWindow(1)
    ref_do_reinforce:SetEnable(1)
    if not g.continue_reinforce.is_first then
        g.continue_reinforce.is_first = true
        g.continue_reinforce.count = g.continue_reinforce.rf_count
    end
    local result_str = goddess_equip_manager:GetUserValue('REINFORCE_RESULT')
    if result_str == 'SUCCESS' then
        goddess_equip_manager:SetUserValue('REINFORCE_RESULT', "None")
        GODDESS_MGR_REFORGE_REINFORCE_CLEAR(goddess_equip_manager, true)
        if not Continue_reinforce_stop_process(goddess_equip_manager) then
            goddess_equip_manager:RunUpdateScript("Continue_reinforce_next_mat_set", 0.2)
        end
        local ref_item_reinf_text = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_item_reinf_text')
        local ref_slot = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_slot')
        local ref_slot_guid = ref_slot:GetUserValue('ITEM_GUID')
        local inv_item = session.GetInvItemByGuid(ref_slot_guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            if item_obj then
                ref_item_reinf_text:SetTextByKey('value', TryGetProp(item_obj, 'Reinforce_2', 0))
            end
        end
        return
    end
    local is_material_shortage = false
    local mat_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'reinf_main_mat_bg')
    for i = 0, mat_bg:GetChildCount() - 1 do
        local ctrlset = GET_CHILD(mat_bg, 'GODDESS_REINF_MAT_' .. i)
        if ctrlset then
            local slot = GET_CHILD(ctrlset, 'slot')
            local mat_name = ctrlset:GetUserValue('ITEM_NAME')
            local cur_count_str = '0'
            if IS_ACCOUNT_COIN(mat_name) then
                cur_count_str = TryGetProp(GetMyAccountObj(), mat_name, '0')
            else
                local mat_item = session.GetInvItemByName(mat_name)
                if mat_item then
                    cur_count_str = tostring(mat_item.count)
                end
            end
            local need_count_str = slot:GetEventScriptArgString(ui.DROP)
            local inv_count = GET_CHILD_RECURSIVELY(ctrlset, 'invcount')
            inv_count:SetTextByKey('have', cur_count_str)
            inv_count:SetTextByKey('need', need_count_str)
            if tonumber(cur_count_str) < tonumber(need_count_str) then
                is_material_shortage = true
                break
            end
        end
    end
    if is_material_shortage or (g.continue_reinforce.rf_count > 0 and g.continue_reinforce.count <= 1) then
        if not Continue_reinforce_stop_process(goddess_equip_manager) then
            goddess_equip_manager:RunUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM", 0.2)
            GODDESS_MGR_REINFORCE_CLEAR_BTN(reinf_left_bg, ref_ok_reinforce)
        end
        return
    end
    if g.continue_reinforce.rf_count > 0 then
        g.continue_reinforce.count = g.continue_reinforce.count - 1
    end
    goddess_equip_manager:RunUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REINFORCE_EXEC",
        g.continue_reinforce.delay)
end

function Continue_reinforce_GODDESS_MGR_REFORGE_REINFORCE_EXEC(goddess_equip_manager)
    local reinf_left_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, "reinf_left_bg")
    local ref_do_reinforce = GET_CHILD(reinf_left_bg, "ref_do_reinforce")
    GODDESS_MGR_REFORGE_REINFORCE_EXEC(reinf_left_bg, ref_do_reinforce)
    local ref_ok_reinforce = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_ok_reinforce')
    GODDESS_MGR_REINFORCE_CLEAR_BTN(reinf_left_bg, ref_ok_reinforce)
    return 0
end

function Continue_reinforce_stop_script()
    local goddess_equip_manager = ui.GetFrame('goddess_equip_manager')
    goddess_equip_manager:StopUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REINFORCE_EXEC")
    goddess_equip_manager:SetUserValue('REINFORCE_RESULT', "SUCCESS")
    GODDESS_MGR_REFORGE_REINFORCE_CLEAR(goddess_equip_manager, true)
    g.continue_reinforce.is_first = false
    g.continue_reinforce.count = 0
    Continue_reinforce_next_mat_set(goddess_equip_manager, false)
    ui.SysMsg("{ol}Continuous Reinforcement Cancelled")
end

function Continue_reinforce_mat_select(parent, ctrl)
    local goddess_equip_manager = ctrl:GetTopParentFrame()
    ui.EnableSlotMultiSelect(1)
    local ref_slot = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'ref_slot')
    local use_lv = ref_slot:GetUserIValue('ITEM_USE_LEVEL')
    if use_lv == 0 then
        return
    end
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "normal" then
        local normal_max = GET_MAX_SUB_REVISION_COUNT(use_lv)
        Continue_reinforce_mat_select_(goddess_equip_manager, use_lv, "normal", normal_max)
    elseif ctrl_name == "premium" then
        local premium_max = GET_MAX_PREMIUM_SUB_REVISION_COUNT(use_lv)
        Continue_reinforce_mat_select_(goddess_equip_manager, use_lv, "premium", premium_max)
    end
end

function Continue_reinforce_mat_select_(goddess_equip_manager, use_lv, mat_type, need_count)
    local reinf_extra_mat_list = GET_CHILD_RECURSIVELY(goddess_equip_manager, "reinf_extra_mat_list")
    if mat_type == "premium" then
        for i = 0, reinf_extra_mat_list:GetSlotCount() - 1 do
            local slot = reinf_extra_mat_list:GetSlotByIndex(i)
            if slot:GetUserValue('MAT_TYPE') == mat_type then
                local icon = slot:GetIcon()
                if icon then
                    if slot:GetSelectCount() > 0 then
                        slot:SetSelectCount(0)
                        slot:Select(0)
                        g.continue_reinforce.premium_mat = false
                    else
                        local inv_item = session.GetInvItemByType(slot:GetIcon():GetInfo().type)
                        local select_count = math.min(inv_item.count, need_count)
                        slot:SetSelectCount(select_count)
                        slot:Select(1)
                        g.continue_reinforce.premium_mat = true
                    end
                    SCR_LBTNDOWN_GODDESS_REINFORCE_EXTRA_MAT(reinf_extra_mat_list, slot)
                    return
                end
            end
        end
        return
    end
    local available_mats = {}
    local release = false
    for i = 0, reinf_extra_mat_list:GetSlotCount() - 1 do
        local slot = reinf_extra_mat_list:GetSlotByIndex(i)
        if slot:GetUserValue('MAT_TYPE') == "normal" then
            local icon = slot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local item_cls = GetClassByType('Item', icon_info.type)
                local inv_item = session.GetInvItemByType(icon_info.type)
                if slot:GetSelectCount() > 0 then
                    release = true
                    g.continue_reinforce.normal_mat = false
                end
                local item_lv_str = item_cls.ClassName:match("_([%d]+)_")
                local item_lv = tonumber(item_lv_str)
                if inv_item and item_lv then
                    table.insert(available_mats, {
                        level = item_lv,
                        count = inv_item.count,
                        slot = slot
                    })
                end
            end
        end
    end
    if release == true then
        for _, mat_info in ipairs(available_mats) do
            if mat_info.slot:GetSelectCount() > 0 then
                mat_info.slot:SetSelectCount(0)
                mat_info.slot:Select(0)
            end
        end
        SCR_LBTNDOWN_GODDESS_REINFORCE_EXTRA_MAT(reinf_extra_mat_list, nil)
        return
    end
    table.sort(available_mats, function(a, b)
        return a.level < b.level
    end)
    local selected_count = 0
    local selection_plan = {}
    for _, mat_info in ipairs(available_mats) do
        if selected_count >= need_count then
            break
        end
        local amount_to_select = math.min(mat_info.count, need_count - selected_count)
        if amount_to_select > 0 then
            table.insert(selection_plan, {
                slot = mat_info.slot,
                count = amount_to_select,
                level = mat_info.level
            })
            selected_count = selected_count + amount_to_select
        end
    end
    local used_higher_level = false
    for _, plan in ipairs(selection_plan) do
        plan.slot:SetSelectCount(plan.count)
        plan.slot:Select(1)
        local item_level = plan.level
        if item_level and item_level > use_lv then
            used_higher_level = true
        end
        g.continue_reinforce.normal_mat = true
        SCR_LBTNDOWN_GODDESS_REINFORCE_EXTRA_MAT(reinf_extra_mat_list, plan.slot)
    end
    if used_higher_level then
        local msg = g.lang == "Japanese" and
                        "同レベルの補助材がありません{nl}上位レベルの補助剤を使用します" or
                        "No same-level aid available{nl}Using a higher-level aid"
        imcAddOn.BroadMsg("NOTICE_Dm_!", msg, 2.5)
    end
end

function Continue_reinforce_next_mat_set(goddess_equip_manager, do_set)
    local gbox = GET_CHILD_RECURSIVELY(goddess_equip_manager, "gbox")
    if g.continue_reinforce.normal_mat then
        local normal_btn = GET_CHILD(gbox, "normal")
        if do_set == false then
            g.continue_reinforce.normal_mat = false
        end
        Continue_reinforce_mat_select(gbox, normal_btn)
    end
    if g.continue_reinforce.premium_mat then
        local premium_btn = GET_CHILD(gbox, "premium")
        if do_set == false then
            g.continue_reinforce.premium_mat = false
        end
        Continue_reinforce_mat_select(gbox, premium_btn)
    end
end

function Continue_reinforce_run_update_script(gbox)
    if g.continue_reinforce.inv_tbl["first"] == nil then
        g.continue_reinforce.inv_tbl["first"] = true
    end
    if g.continue_reinforce.inv_tbl["first"] then
        local inv_item_list = session.GetInvItemList()
        local inv_guid_list = inv_item_list:GetGuidList()
        local count = inv_guid_list:Count()
        for i = 0, count - 1 do
            local guid = inv_guid_list:Get(i)
            local inv_item = inv_item_list:GetItemByGuid(guid)
            local inv_obj = GetIES(inv_item:GetObject())
            local inv_clsname = inv_obj.ClassName
            if (string.find(inv_clsname, "misc_reinforce_percentUp_") and
                (not string.find(inv_clsname, "_NoTrade") or string.find(inv_clsname, "ea_"))) or
                (string.find(inv_clsname, "misc_Premium_reinforce_percentUp_") and string.find(inv_clsname, "plus")) then
                local inv_item_count = inv_item.count
                g.continue_reinforce.inv_tbl[inv_clsname] = inv_item_count
                g.continue_reinforce.inv_tbl["first"] = false
            end
        end
    end
    for cls_name, count in pairs(g.continue_reinforce.inv_tbl) do
        local inv_item = nil
        local item_count = 0
        if cls_name ~= "first" and cls_name ~= "remove" then
            inv_item = session.GetInvItemByName(cls_name)
            if inv_item then
                item_count = inv_item.count
            end
            if count ~= item_count then
                local frame = gbox:GetTopParentFrame()
                if not g.continue_reinforce.inv_tbl["remove"] then
                    local ref_slot_bg = GET_CHILD_RECURSIVELY(frame, "ref_slot_bg")
                    local ref_slot = GET_CHILD(ref_slot_bg, "ref_slot")
                    GODDESS_MGR_REFORGE_ITEM_REMOVE(ref_slot_bg, ref_slot)
                    g.continue_reinforce.inv_tbl["remove"] = true
                    return 1
                else
                    local iesid = gbox:GetUserValue("IESID")
                    local inv_item_ = session.GetInvItemByGuid(iesid)
                    if inv_item_ then
                        local item_obj = GetIES(inv_item_:GetObject())
                        GODDESS_MGR_REFORGE_REG_ITEM(frame, inv_item_, item_obj)
                    end
                    g.continue_reinforce.inv_tbl["remove"] = false
                    g.continue_reinforce.inv_tbl["first"] = true
                    return 1
                end
            end
        end
    end
    return 1
end

function Continue_reinforce_GODDESS_MGR_REFORGE_INV_RBTN(item_obj, slot, guid)
    local frame = ui.GetFrame('goddess_equip_manager')
    local inv_item = session.GetInvItemByGuid(guid)
    if inv_item then
        local item_cls = GetClassByType("Item", inv_item.type)
        if string.find(item_cls.MarketCategory, "Weapon_") or string.find(item_cls.MarketCategory, "Armor_") or
            string.find(item_cls.MarketCategory, "Accessory_") then
            GODDESS_MGR_REFORGE_REG_ITEM(frame, inv_item, item_obj)
        else
            INV_ICON_USE(inv_item)
            Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM()
            frame:RunUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM_reserve", 0.2)
        end
    end
end

function Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM_reserve(frame)
    local warningmsgbox = ui.GetFrame("warningmsgbox")
    if warningmsgbox:IsVisible() == 1 then
        return 1
    end
    local inputstring = ui.GetFrame("inputstring")
    if inputstring:IsVisible() == 1 then
        return 1
    end
    Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM()
    return 0
end

function Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM()
    if not g.continue_reinforce.use or g.settings.continue_reinforce.use == 0 then
        return
    end
    INVENTORY_SET_CUSTOM_RBTNDOWN('GODDESS_MGR_REFORGE_INV_RBTN')
    local frame = ui.GetFrame('goddess_equip_manager')
    local main_tab = GET_CHILD_RECURSIVELY(frame, 'main_tab')
    if main_tab:GetSelectItemIndex() ~= 0 then
        return
    end
    local reforge_tab = GET_CHILD_RECURSIVELY(frame, 'reforge_tab')
    if reforge_tab:GetSelectItemIndex() ~= 0 then
        return
    end
    INVENTORY_SET_CUSTOM_RBTNDOWN('Continue_reinforce_GODDESS_MGR_REFORGE_INV_RBTN')
    local ref_slot = GET_CHILD_RECURSIVELY(frame, 'ref_slot')
    local iesid = ref_slot:GetUserValue("ITEM_GUID")
    local gbox = GET_CHILD_RECURSIVELY(frame, 'gbox')
    gbox:SetUserValue("IESID", iesid)
    g.continue_reinforce.is_first = false
    local reinf_main_mat_bg = GET_CHILD_RECURSIVELY(frame, 'reinf_main_mat_bg')
    local child_count = reinf_main_mat_bg:GetChildCount()
    local stop = false
    for i = 0, child_count - 1 do
        local child = reinf_main_mat_bg:GetChildByIndex(i)
        if child and string.find(child:GetName(), "GODDESS_REINF_MAT_") then
            local btn = GET_CHILD_RECURSIVELY(child, "btn")
            GODDESS_MGR_REFORGE_REINFORCE_REG_MAT(child, btn)
            local slot = GET_CHILD(child, 'slot')
            local mat_name = child:GetUserValue('ITEM_NAME')
            local cur_count = '0'
            if IS_ACCOUNT_COIN(mat_name) == true then
                local acc = GetMyAccountObj()
                cur_count = TryGetProp(acc, mat_name, '0')
                if cur_count == 'None' then
                    cur_count = '0'
                end
            else
                local mat_item = session.GetInvItemByName(mat_name)
                if mat_item == nil then
                    cur_count = '0'
                else
                    cur_count = tostring(mat_item.count)
                end
            end
            local need_count = slot:GetEventScriptArgString(ui.DROP)
            local inv_count = GET_CHILD_RECURSIVELY(child, 'invcount')
            inv_count:SetTextByKey('have', cur_count)
            inv_count:SetTextByKey('need', need_count)
            if tonumber(need_count) > tonumber(cur_count) then
                stop = true
            end
        end
    end
    if stop then
        frame:StopUpdateScript("Continue_reinforce_GODDESS_MGR_REFORGE_REG_ITEM_reserve")
    end
end

function Continue_reinforce_GODDESS_MGR_REFORGE_ITEM_REMOVE()
    INVENTORY_SET_CUSTOM_RBTNDOWN('GODDESS_MGR_REFORGE_INV_RBTN')
end

function Continue_reinforce_GODDESS_MGR_REFORGE_TAB_CHANGE()
    INVENTORY_SET_CUSTOM_RBTNDOWN('GODDESS_MGR_REFORGE_INV_RBTN')
    local goddess_equip_manager = ui.GetFrame('goddess_equip_manager')
    local reforge_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'reforge_tab')
    local tab_index = reforge_tab:GetSelectItemIndex()
    if tab_index == 0 then
        Continue_reinforce_GODDESS_EQUIP_MANAGER_OPEN()
    else
        goddess_equip_manager:RemoveChild("gbox")
    end
end
-- continue_reinforce ここまで

-- pick_item_tracker ここから
g.pick_item_tracker_grade_colors = {
    [0] = "#FFBF33", -- Unique
    [1] = "#FFFFFF", -- Normal
    [2] = "#108CFF", -- Magic
    [3] = "#9F30FF", -- Rare
    [4] = "#FF4F00", -- Legend
    [5] = "#FFFF53" -- Goddess
}
function Pick_item_tracker_save_settings()
    g.save_json(g.pick_item_tracker_path, g.pick_item_tracker_settings)
end

function Pick_item_tracker_load_settings()
    g.pick_item_tracker_path = string.format("../addons/%s/%s/pick_item_tracker.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.pick_item_tracker_path)
    if not settings then
        settings = {
            move = 1,
            x = 330,
            y = 330
        }
    end
    g.pick_item_tracker_settings = settings
    Pick_item_tracker_save_settings()
end

function pick_item_tracker_on_init()
    if not g.pick_item_tracker_settings then
        Pick_item_tracker_load_settings()
    end
    local old_func = g.settings.pick_item_tracker.old_init_func
    if _G[old_func] then
        return
    end
    if g.get_map_type() ~= "City" and g.get_map_type() ~= "Instance" then
        if not g.pick_item_tracker_map_id or g.map_id ~= g.pick_item_tracker_map_id then
            g.pick_item_tracker_map_id = g.map_id
            g.pick_item_tracker_start_time = imcTime.GetAppTimeMS() - 3000
            g.pick_item_tracker_items = {}
            g.pick_item_tracker_y = 45
            g.pick_item_tracker_x = 120
        end
        g.addon:RegisterMsg('ITEM_PICK', 'Pick_item_tracker_ITEMMSG_ITEM_COUNT')
        Pick_item_tracker_frame_init()
    else
        g.pick_item_tracker_map_id = nil
        g.pick_item_tracker_items = {}
        g.pick_item_tracker_y = 45
        g.pick_item_tracker_x = 120
        Pick_item_tracker_frame_init("is_city")
    end
end

function Pick_item_tracker_frame_init(msg)
    local pick_item_tracker = ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "pick_item_tracker", 0, 0, 0, 0)
    AUTO_CAST(pick_item_tracker)
    pick_item_tracker:EnableHitTest(1)
    pick_item_tracker:EnableHittestFrame(1)
    pick_item_tracker:EnableMove(g.pick_item_tracker_settings.move)
    pick_item_tracker:SetPos(g.pick_item_tracker_settings.x, g.pick_item_tracker_settings.y)
    pick_item_tracker:SetTitleBarSkin("None")
    pick_item_tracker:SetSkinName("None")
    pick_item_tracker:SetLayerLevel(61)
    pick_item_tracker:SetEventScript(ui.LBUTTONUP, "Pick_item_tracker_frame_move")
    pick_item_tracker:SetEventScript(ui.RBUTTONUP, "Pick_item_tracker_frame_lock")
    local title_text = pick_item_tracker:CreateOrGetControl("richtext", "title_text", 20, 10)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}{S10}Pick Item Tracker")
    title_text:SetTextTooltip("{ol}Right click to position lock")
    title_text:SetEventScript(ui.LBUTTONUP, "Pick_item_tracker_frame_move")
    title_text:SetEventScript(ui.RBUTTONUP, "Pick_item_tracker_frame_lock")
    local itemlock = pick_item_tracker:CreateOrGetControlSet('inv_itemlock', "itemlock", 0, 0)
    AUTO_CAST(itemlock)
    itemlock:SetGravity(ui.LEFT, ui.TOP)
    if g.pick_item_tracker_settings.move == 1 then
        itemlock:SetGrayStyle(1)
    else
        itemlock:SetGrayStyle(0)
    end
    pick_item_tracker:Resize(120, g.pick_item_tracker_y or 25)
    local gb = pick_item_tracker:CreateOrGetControl("groupbox", "gb", 0, 45, 90, pick_item_tracker:GetHeight() - 45)
    gb:SetSkinName("None")
    AUTO_CAST(gb)
    Pick_item_tracker_redraw_item_list(pick_item_tracker)
    local time_text = pick_item_tracker:CreateOrGetControl("richtext", "time_text", 25, 25)
    AUTO_CAST(time_text)
    if msg == "is_city" then
        pick_item_tracker:ShowWindow(0)
    else
        local pick_item_tracker_timer = pick_item_tracker:CreateOrGetControl("timer", "pick_item_tracker_timer", 0, 0)
        AUTO_CAST(pick_item_tracker_timer)
        pick_item_tracker_timer:SetUpdateScript("Pick_item_tracker_timer_update")
        pick_item_tracker_timer:Start(1.0)
        pick_item_tracker:ShowWindow(1)
    end
end

function Pick_item_tracker_frame_move(pick_item_tracker)
    g.pick_item_tracker_settings.x = pick_item_tracker:GetX()
    g.pick_item_tracker_settings.y = pick_item_tracker:GetY()
    Pick_item_tracker_save_settings()
end

function Pick_item_tracker_frame_lock(pick_item_tracker)
    local itemlock = GET_CHILD(pick_item_tracker, "itemlock")
    if g.pick_item_tracker_settings.move == 1 then
        g.pick_item_tracker_settings.move = 0
        itemlock:SetGrayStyle(0)
    else
        g.pick_item_tracker_settings.move = 1
        itemlock:SetGrayStyle(1)
    end
    pick_item_tracker:EnableMove(g.pick_item_tracker_settings.move)
    Pick_item_tracker_save_settings()
end

function Pick_item_tracker_redraw_item_list(pick_item_tracker)
    local gb = GET_CHILD(pick_item_tracker, "gb")
    gb:RemoveAllChild()
    local count = 0
    local keys = {}
    for k in pairs(g.pick_item_tracker_items) do
        table.insert(keys, k)
    end
    table.sort(keys)
    for i, k in ipairs(keys) do
        local v = g.pick_item_tracker_items[k]
        local item_text = gb:CreateOrGetControl("richtext", "item_text" .. k, 5, count * 25)
        AUTO_CAST(item_text)
        count = count + 1
        local item_cls = GetClassByType("Item", v.cls_id)
        local color = g.pick_item_tracker_grade_colors[item_cls.ItemGrade] or "#FFFFFF"
        item_text:SetText("{img " .. item_cls.Icon .. " 20 20}" .. "{ol}{s15}{" .. color .. "}" ..
                              dictionary.ReplaceDicIDInCompStr(k) .. "{/}{ol}{s14}{#00FF00}( + " .. v.item_count .. " )")
        if g.pick_item_tracker_x < item_text:GetWidth() then
            g.pick_item_tracker_x = item_text:GetWidth()
        end
    end
    g.pick_item_tracker_y = count * 25 + 50
    pick_item_tracker:Resize(g.pick_item_tracker_x + 15, g.pick_item_tracker_y)
    gb:Resize(pick_item_tracker:GetWidth(), pick_item_tracker:GetHeight() - 45)
end

function Pick_item_tracker_timer_update(pick_item_tracker, timer)
    g.pick_item_tracker_diff_time = imcTime.GetAppTimeMS() - g.pick_item_tracker_start_time
    local h = math.floor(g.pick_item_tracker_diff_time / (60 * 60 * 1000))
    local m = math.floor((g.pick_item_tracker_diff_time / (60 * 1000)) % 60)
    local s = math.floor((g.pick_item_tracker_diff_time / 1000) % 60)
    local time_text = GET_CHILD(pick_item_tracker, "time_text")
    time_text:SetText(string.format("{ol}{s14}%02d:%02d:%02d{/}", h, m, s))
    if g.settings.pick_item_tracker.use == 1 then
        pick_item_tracker:ShowWindow(1)
    else
        ui.DestroyFrame(pick_item_tracker:GetName())
    end
end

function Pick_item_tracker_ITEMMSG_ITEM_COUNT(frame, msg, cls_id, item_count)
    local num = tonumber(cls_id)
    if num then
        cls_id = math.floor(num)
    end
    local item_cls = GetClassByType("Item", cls_id)
    local item_name = item_cls.Name
    local items = g.pick_item_tracker_items
    if not items[item_name] then
        items[item_name] = {
            cls_id = cls_id,
            item_count = item_count
        }
        Pick_item_tracker_frame_update(item_name, item_count, cls_id, "new")
    else
        items[item_name].cls_id = cls_id
        items[item_name].item_count = items[item_name].item_count + item_count
        Pick_item_tracker_frame_update(item_name, items[item_name].item_count, items[item_name].cls_id)
    end
end

function Pick_item_tracker_frame_update(item_name, item_count, cls_id, new)
    local pick_item_tracker = ui.GetFrame(addon_name_lower .. "pick_item_tracker")
    if new == "new" then
        Pick_item_tracker_redraw_item_list(pick_item_tracker)
    else
        local gb = GET_CHILD(pick_item_tracker, "gb")
        local item_text = GET_CHILD(gb, "item_text" .. item_name)
        local item_cls = GetClassByType("Item", cls_id)
        local color = g.pick_item_tracker_grade_colors[item_cls.ItemGrade] or "#FFFFFF"
        item_text:SetText("{img " .. item_cls.Icon .. " 20 20}" .. "{ol}{s15}{" .. color .. "}" ..
                              dictionary.ReplaceDicIDInCompStr(item_name) .. "{/}{ol}{s14}{#00FF00}( + " .. item_count ..
                              " )")
        pick_item_tracker:Resize(g.pick_item_tracker_x + 15, g.pick_item_tracker_y)
        gb:Resize(pick_item_tracker:GetWidth(), pick_item_tracker:GetHeight() - 45)
    end
end
-- pick_item_tracker ここまで

-- another_warehouse ここから
function Another_warehouse_save_settings()
    g.save_lua(g.another_warehouse_path, g.awh_settings)
end

function Another_warehouse_load_settings()
    g.another_warehouse_path = string.format("../addons/%s/%s/another_warehouse.lua", addon_name_lower, g.active_id)
    local json_path = string.format("../addons/%s/%s/another_warehouse.json", addon_name_lower, g.active_id)
    g.another_warehouse_old_path = string.format("../addons/%s/%s/settings.json", "another_warehouse", g.active_id)
    local settings = g.load_lua(g.another_warehouse_path)
    local need_save = false
    local ver = 1.1 -- ■ バージョン定義
    if not settings then
        settings = g.load_json(json_path)
        if settings then
            need_save = true
        end
    end
    if not settings then
        local old_settings = g.load_json(g.another_warehouse_old_path)
        if old_settings then
            local new_take_set = {}
            local old_items_map = old_settings.setitems or {}
            local old_names_list = old_settings.handlelist or {}
            for i, name in ipairs(old_names_list) do
                local index_str = tostring(i)
                local items = old_items_map[index_str]
                if items then
                    table.insert(new_take_set, {
                        name = name,
                        items = items
                    })
                end
            end
            settings = {
                chars = {},
                etc = {
                    display_change = 0,
                    leave_item = 0,
                    auto_silver = 0
                },
                take_list = new_take_set,
                items = old_settings.items or {},
                ver = ver
            }
        else
            local new_take_set = {}
            for i = 1, 10 do
                table.insert(new_take_set, {
                    name = "Take Items " .. i,
                    items = {}
                })
            end
            settings = {
                chars = {},
                etc = {
                    display_change = 0,
                    leave_item = 0,
                    auto_silver = 0
                },
                take_list = new_take_set,
                items = {},
                ver = ver
            }
        end
        need_save = true
    end
    if not settings.ver or settings.ver < ver then
        if not settings.take_list then
            settings.take_list = {}
        end
        while #settings.take_list < 10 do
            local next_num = #settings.take_list + 1
            table.insert(settings.take_list, {
                name = "Take Items " .. next_num,
                items = {}
            })
        end
        settings.ver = ver
        need_save = true
    end
    g.awh_settings = settings
    if need_save then
        Another_warehouse_save_settings()
    end
end

function Another_warehouse_load_cid_settings()
    local json_path = string.format("../addons/%s/%s/another_warehouse.json", addon_name_lower, g.active_id)
    local json_settings = g.load_json(json_path)
    if json_settings and json_settings.chars and json_settings.chars[g.cid] then
        g.awh_settings.chars[g.cid] = json_settings.chars[g.cid]
    else
        local old_settings = g.load_json(g.another_warehouse_old_path)
        if old_settings and old_settings[g.cid] then
            g.awh_settings.chars[g.cid] = old_settings[g.cid]
            local char_data = g.awh_settings.chars[g.cid]
            if char_data.transfer then
                char_data.transfer = nil
            end
            if char_data.maney_check then
                char_data.money_check = char_data.maney_check
                char_data.maney_check = nil
            end
        else
            g.awh_settings.chars[g.cid] = {
                money_check = 0,
                name = g.login_name,
                item_check = 0,
                items = {}
            }
        end
    end
    Another_warehouse_save_settings()
end

function another_warehouse_on_init()
    if not g.awh_settings then
        Another_warehouse_load_settings()
    end
    if not g.awh_settings.chars[g.cid] then
        Another_warehouse_load_cid_settings()
    end
    local old_func = g.settings.another_warehouse.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, 'ACCOUNT_WAREHOUSE_UPDATE_VIS_LOG',
        "Another_warehouse_ACCOUNT_WAREHOUSE_UPDATE_VIS_LOG", true)
    g.setup_hook_and_event(g.addon, 'ACCOUNTWAREHOUSE_CLOSE', "Another_warehouse_ACCOUNTWAREHOUSE_CLOSE", true)
    g.addon:RegisterMsg("OPEN_DLG_ACCOUNTWAREHOUSE", "Another_warehouse_OPEN_DLG_ACCOUNTWAREHOUSE")
    if g.settings.another_warehouse.use == 0 then
        Another_warehouse_frame_close()
        return
    end
    if g.get_map_type() == "City" then
        Another_warehouse_accountwarehouse_init()
    end
end

function Another_warehouse_accountwarehouse_init()
    g.another_warehouse_func = false
    if g.settings.another_warehouse.use == 0 then
        Another_warehouse_frame_close()
        return
    end
    g.addon:RegisterMsg("ACCOUNT_WAREHOUSE_ITEM_LIST", "Another_warehouse_on_msg")
    g.addon:RegisterMsg("ACCOUNT_WAREHOUSE_ITEM_ADD", "Another_warehouse_on_msg")
    g.addon:RegisterMsg("ACCOUNT_WAREHOUSE_ITEM_REMOVE", "Another_warehouse_on_msg")
    g.addon:RegisterMsg("ACCOUNT_WAREHOUSE_ITEM_CHANGE_COUNT", "Another_warehouse_on_msg")
    g.addon:RegisterMsg("ACCOUNT_WAREHOUSE_ITEM_IN", "Another_warehouse_on_msg")
    if type(_G["YAACCOUNTINVENTORY_ON_INIT"]) == "function" then
        _G["YAACCOUNTINVENTORY_ON_INIT"] = nil
    end
    local functionName = "WAREHOUSEMANAGER_ON_INIT"
    if type(_G["WAREHOUSEMANAGER_ON_INIT"]) == "function" then
        _G["WAREHOUSEMANAGER_ON_INIT"] = nil
    end
    g.awh_new_stack_add_item = {}
end

function Another_warehouse_on_msg(frame, msg, str, num)
    if g.settings.another_warehouse.use == 0 then
        return
    end
    local awh = ui.GetFrame(addon_name_lower .. "awh")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local cur_pos = gb:GetScrollCurPos()
    awh:SetUserValue("SCROLL_POS", cur_pos)
    if msg == 'ACCOUNT_WAREHOUSE_ITEM_REMOVE' then
        Another_warehouse_remove_recurse_guid(awh, str)
        awh:RunUpdateScript("Another_warehouse_frame_update_remove", 3.0)
        return
    end
    local index = awh:GetUserIValue("TAB_INDEX")
    Another_warehouse_frame_update(awh, gb, "", index)
end

function Another_warehouse_frame_update_remove(awh)
    awh:StopUpdateScript("Another_warehouse_frame_update_remove")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local index = awh:GetUserIValue("TAB_INDEX")
    Another_warehouse_frame_update(awh, gb, "", index)
    return 0
end

function Another_warehouse_remove_recurse_guid(awh, guid)
    local slot = ui.GetFocusObject()
    if not slot then
        return
    end
    local icon = slot:GetIcon()
    if icon then
        local icon_info = icon:GetInfo()
        if icon_info:GetIESID() == guid then
            slot:ClearIcon()
            slot:SetSkinName("invenslot2")
            slot:SetText("")
            slot:RemoveAllChild()
        end
    end
end

function Another_warehouse_ACCOUNT_WAREHOUSE_UPDATE_VIS_LOG(my_frame, my_msg)
    if g.settings.another_warehouse.use == 0 then
        Another_warehouse_frame_close()
        return
    end
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local visgBox = GET_CHILD_RECURSIVELY(accountwarehouse, 'visgBox')
    local cnt = session.AccountWarehouse.GetCount()
    for i = cnt - 1, 0, -1 do
        local log = session.AccountWarehouse.GetByIndex(i)
        local ctrl_set = GET_CHILD(visgBox, "CTRLSET_" .. i)
        local inputVis = ctrl_set:GetChild('inputVis')
        inputVis:ShowWindow(0)
        local new_input = ctrl_set:CreateOrGetControl("richtext", " new_input", 220, i, 50, 24)
        AUTO_CAST(new_input)
        new_input:SetGravity(ui.RIGHT, ui.CENTER_VERT)
        new_input:SetMargin(0, 0, 330, 0)
        new_input:SetTextAlign("right", "center")
        if not string.find(inputVis:GetText(), "ZZZZZ") then
            new_input:SetText(inputVis:GetText())
        end
    end
end

function Another_warehouse_ACCOUNTWAREHOUSE_CLOSE()
    local inventory = ui.GetFrame("inventory")
    SET_INV_LBTN_FUNC(inventory, "None")
    INVENTORY_SET_CUSTOM_RBTNDOWN("None")
    local monstercardslot = ui.GetFrame("monstercardslot")
    monstercardslot:SetLayerLevel(96)
    ui.DestroyFrame(addon_name_lower .. "awh")
    ui.DestroyFrame(addon_name_lower .. "awh_setting")
    if g.settings.another_warehouse.use == 0 then
        return
    end
    Another_warehouse_set_item_close()
end

function Another_warehouse_frame_close(parent, ctrl)
    Another_warehouse_ACCOUNTWAREHOUSE_CLOSE()
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    if accountwarehouse:IsVisible() == 1 then
        INVENTORY_SET_CUSTOM_RBTNDOWN("ACCOUNT_WAREHOUSE_INV_RBTN")
    else
        INVENTORY_SET_CUSTOM_RBTNDOWN("None")
    end
    ui.DestroyFrame(addon_name_lower .. "awh")
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local accountwarehousefilter = GET_CHILD_RECURSIVELY(accountwarehouse, "accountwarehousefilter")
    accountwarehousefilter:ShowWindow(1)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local accountwarehouse_tab = GET_CHILD_RECURSIVELY(accountwarehouse, "accountwarehouse_tab")
    accountwarehouse_tab:ShowWindow(1)
    local richtext_1 = GET_CHILD_RECURSIVELY(accountwarehouse, "richtext_1")
    richtext_1:ShowWindow(1)
    local itemcnt = GET_CHILD_RECURSIVELY(accountwarehouse, "itemcnt")
    itemcnt:ShowWindow(1)
    local slotgbox = GET_CHILD_RECURSIVELY(accountwarehouse, "slotgbox")
    slotgbox:ShowWindow(1)
    local richtext_3 = GET_CHILD_RECURSIVELY(accountwarehouse, "richtext_3")
    richtext_3:ShowWindow(1)
    local DepositSkin = accountwarehouse:GetChildRecursively("DepositSkin")
    AUTO_CAST(DepositSkin)
    DepositSkin:Resize(DepositSkin:GetWidth(), 35)
    local buttons = {"cancel", "m1", "m5", "m10", "m50", "m100", "allout", "allin"}
    for _, name in ipairs(buttons) do
        DepositSkin:RemoveChild(name)
    end
    local gbox = GET_CHILD_RECURSIVELY(accountwarehouse, "gbox")
    DESTROY_CHILD_BYNAME(gbox, "awh_search_edit")
    DESTROY_CHILD_BYNAME(gbox, "awh_setting")
    DESTROY_CHILD_BYNAME(gbox, "awh_help")
    DESTROY_CHILD_BYNAME(gbox, "awh_leave")
    DESTROY_CHILD_BYNAME(gbox, "awh_display_change")
    DESTROY_CHILD_BYNAME(gbox, "awh_take")
    DESTROY_CHILD_BYNAME(gbox, "awh_count_text")
    DESTROY_CHILD_BYNAME(gbox, "awh_close")
    DESTROY_CHILD_BYNAME(gbox, "awh_name_text")
end

function Another_warehouse_OPEN_DLG_ACCOUNTWAREHOUSE()
    if g.settings.another_warehouse.use == 0 then
        local accountwarehouse = ui.GetFrame('accountwarehouse')
        if accountwarehouse:IsVisible() == 1 then
            INVENTORY_SET_CUSTOM_RBTNDOWN("ACCOUNT_WAREHOUSE_INV_RBTN")
        else
            INVENTORY_SET_CUSTOM_RBTNDOWN("None")
        end
        return
    end
    local monstercardslot = ui.GetFrame("monstercardslot")
    monstercardslot:SetLayerLevel(98)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local accountwarehousefilter = GET_CHILD_RECURSIVELY(accountwarehouse, "accountwarehousefilter")
    accountwarehousefilter:ShowWindow(0)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local accountwarehouse_tab = GET_CHILD_RECURSIVELY(accountwarehouse, "accountwarehouse_tab")
    accountwarehouse_tab:ShowWindow(0)
    local richtext_1 = GET_CHILD_RECURSIVELY(accountwarehouse, "richtext_1")
    richtext_1:ShowWindow(0)
    local itemcnt = GET_CHILD_RECURSIVELY(accountwarehouse, "itemcnt")
    itemcnt:ShowWindow(0)
    local slotgbox = GET_CHILD_RECURSIVELY(accountwarehouse, "slotgbox")
    slotgbox:ShowWindow(0)
    local richtext_3 = GET_CHILD_RECURSIVELY(accountwarehouse, "richtext_3")
    richtext_3:ShowWindow(0)
    local gbox = GET_CHILD_RECURSIVELY(accountwarehouse, "gbox")
    gbox:RemoveChild("awh_search_edit")
    local search_edit = gbox:CreateOrGetControl("edit", "awh_search_edit", 0, 0, 295, 35)
    AUTO_CAST(search_edit)
    search_edit:SetFontName("white_18_ol")
    search_edit:SetTextAlign("left", "center")
    search_edit:SetSkinName("inventory_serch")
    local margin = search_edit:GetMargin()
    search_edit:SetMargin(margin.left + 115, margin.top + 20, margin.right, margin.bottom)
    search_edit:SetEventScript(ui.ENTERKEY, "Another_warehouse_search")
    local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 60, 38)
    AUTO_CAST(search_btn)
    search_btn:SetImage("inven_s")
    search_btn:SetGravity(ui.RIGHT, ui.TOP)
    search_btn:SetEventScript(ui.LBUTTONUP, "Another_warehouse_search")
    local awsetting = gbox:CreateOrGetControl("button", "awh_setting", 0, 0, 30, 43)
    AUTO_CAST(awsetting)
    awsetting:SetText("{img config_button_normal 27 27}")
    awsetting:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_frame_init")
    awsetting:SetMargin(145, 60, 0, 0)
    awsetting:SetSkinName("None")
    awsetting:SetTextTooltip(g.lang == "Japanese" and "{ol}[AWH]{nl}自動倉庫設定" or
                                 "{ol}[AWH]{nl}Automatic warehousing setup")
    local help = gbox:CreateOrGetControl('button', "awh_help", 0, 0, 30, 30)
    AUTO_CAST(help);
    help:SetText("{ol}{img question_mark 20 20}")
    help:SetMargin(115, 67, 0, 0)
    help:SetTextTooltip("{ol}[AWH] HELP")
    help:SetSkinName("test_pvp_btn")
    help:SetEventScript(ui.LBUTTONUP, "Another_warehouse_help")
    local leave = gbox:CreateOrGetControl('checkbox', "awh_leave", 0, 0, 30, 30)
    AUTO_CAST(leave);
    leave:SetCheck(g.awh_settings.etc.leave_item)
    leave:SetMargin(180, 67, 0, 0)
    leave:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_check")
    local tooltip_text = g.lang == "Japanese" and "{ol}チェックすると倉庫に1個残します" or
                             "{ol}Check leaves one in the warehouse"
    leave:SetTextTooltip(tooltip_text)
    local display_change = gbox:CreateOrGetControl('checkbox', "awh_display_change", 0, 0, 30, 30)
    AUTO_CAST(display_change);
    display_change:SetCheck(g.awh_settings.etc.display_change or 0)
    display_change:SetMargin(215, 67, 0, 0)
    display_change:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_check")
    local tooltip_text = g.lang == "Japanese" and "{ol}チェックすると表示切替" or
                             "{ol}Check to switch display"
    display_change:SetTextTooltip(tooltip_text)
    display_change:ShowWindow(1)
    local take = gbox:CreateOrGetControl("button", "awh_take", 10, 0, 100, 43)
    AUTO_CAST(take)
    take:SetText("{@st66b}TAKE SET")
    take:SetEventScript(ui.LBUTTONUP, "Another_warehouse_take_context")
    take:SetEventScript(ui.RBUTTONUP, "Another_warehouse_setting_context")
    take:SetMargin(310, 60, 0, 0)
    take:SetSkinName("test_pvp_btn")
    take:SetTextTooltip(g.lang == "Japanese" and
                            "{ol}左クリック: 倉庫からセットで搬出します{nl}右クリック: セット設定を呼び出します" or
                            "{ol}left-click: Move set from warehouse{nl}Right-click: Call up set settings")
    local max_count = Another_warehouse_get_maxcount()
    local item_count = Another_warehouse_item_count()
    local count_text = gbox:CreateOrGetControl("richtext", "awh_count_text", 0, 0, 200, 24)
    AUTO_CAST(count_text)
    count_text:SetMargin(420, 73, 0, 0)
    count_text:SetText("{@st42}" .. item_count .. "/" .. max_count .. "{/}")
    count_text:SetFontName("white_16_ol")
    local awclose = gbox:CreateOrGetControl("button", "awh_close", 10, 0, 100, 43)
    AUTO_CAST(awclose)
    awclose:SetText("{@st66b}AW CLOSE")
    awclose:SetEventScript(ui.LBUTTONUP, "Another_warehouse_frame_close")
    awclose:SetMargin(10, 60, 0, 0)
    awclose:SetSkinName("test_pvp_btn")
    local name_text = gbox:CreateOrGetControl("richtext", "awh_name_text", 15, 0, 200, 24)
    AUTO_CAST(name_text)
    name_text:SetMargin(10, 10, 0, 0)
    name_text:SetText("{#000000}{s18}" .. g.login_name .. "{/}")
    Another_warehouse_frame_over_lap()
    Another_warehouse_money_input_btn(accountwarehouse)
end

function Another_warehouse_money_input_btn(accountwarehouse)
    local DepositSkin = accountwarehouse:GetChildRecursively("DepositSkin")
    AUTO_CAST(DepositSkin)
    DepositSkin:Resize(DepositSkin:GetWidth(), 45)
    local moneyInput = accountwarehouse:GetChildRecursively("moneyInput")
    AUTO_CAST(moneyInput)
    moneyInput:SetText("0")
    local buttons = {{
        name = "cancel",
        text = "C",
        val = 0
    }, {
        name = "m1",
        text = "1M",
        val = 1000000
    }, {
        name = "m5",
        text = "5M",
        val = 5000000
    }, {
        name = "m10",
        text = "10M",
        val = 10000000
    }, {
        name = "m50",
        text = "50M",
        val = 50000000
    }, {
        name = "m100",
        text = "100M",
        val = 100000000
    }, {
        name = "allout",
        text = "{img chul_arrow 10 10}ALL",
        val = nil
    }, {
        name = "allin",
        text = "{img in_arrow 10 10}ALL",
        val = nil
    }}
    local text_style = "{@st66b}{s12}"
    for i, data in ipairs(buttons) do
        local x_offset = i * 50
        local btn = DepositSkin:CreateOrGetControl("button", data.name, DepositSkin:GetWidth() - x_offset,
            DepositSkin:GetHeight() - 23, 50, 25)
        AUTO_CAST(btn)
        btn:SetText(text_style .. data.text)
        btn:SetSkinName("test_pvp_btn")
        btn:SetEventScript(ui.LBUTTONUP, "Another_warehouse_money_input_lbtn")
        if data.val ~= nil then
            btn:SetEventScriptArgNumber(ui.LBUTTONUP, data.val)
            btn:SetEventScript(ui.RBUTTONUP, "Another_warehouse_money_input_rbtn")
            btn:SetEventScriptArgNumber(ui.RBUTTONUP, data.val)
        end
    end
end

function Another_warehouse_money_input_lbtn(parent, ctrl, str, num)
    local accountwarehouse = ctrl:GetTopParentFrame()
    local moneyInput = accountwarehouse:GetChildRecursively("moneyInput")
    AUTO_CAST(moneyInput)
    local handle = accountwarehouse:GetUserIValue('HANDLE')
    if ctrl:GetName() == "allout" then
        local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
        local guid_list = item_list:GetGuidList()
        local sorted_guid_list = item_list:GetSortedGuidList()
        local sorted_cnt = sorted_guid_list:Count()
        local iesid
        for i = 0, sorted_cnt - 1 do
            local guid = sorted_guid_list:Get(i)
            local inv_item = item_list:GetItemByGuid(guid)
            local obj = GetIES(inv_item:GetObject());
            if obj.ClassName == MONEY_NAME then
                moneyInput:SetText(GET_COMMAED_STRING(inv_item:GetAmountStr()))
                return
            end
        end
        moneyInput:SetText("0")
    elseif ctrl:GetName() == "allin" then
        local silver = session.GetInvItemByName(MONEY_NAME)
        if silver then
            moneyInput:SetText(GET_COMMAED_STRING(silver:GetAmountStr()))
        else
            moneyInput:SetText("0")
        end
    elseif ctrl:GetName() == "cancel" then
        moneyInput:SetText("0")
    else
        local current_val_str = string.gsub(moneyInput:GetText(), ",", "")
        local current_val = tonumber(current_val_str) or 0
        moneyInput:SetText(GET_COMMAED_STRING(SumForBigNumberInt64(current_val, "+" .. num)))
    end
end

function Another_warehouse_money_input_rbtn(parent, ctrl, str, num)
    local accountwarehouse = ctrl:GetTopParentFrame()
    local moneyInput = accountwarehouse:GetChildRecursively("moneyInput")
    AUTO_CAST(moneyInput)
    if ctrl:GetName() == "cancel" then
        moneyInput:SetText("0")
        return
    end
    local current_val_str = string.gsub(moneyInput:GetText(), ",", "")
    local current_val = tonumber(current_val_str) or 0
    if (current_val - num) > 0 then
        moneyInput:SetText(GET_COMMAED_STRING(SumForBigNumberInt64(current_val, "-" .. num)))
    else
        moneyInput:SetText("0")
    end
end

function Another_warehouse_frame_over_lap()
    local awh = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "awh", 0, 0, 670, 570)
    AUTO_CAST(awh)
    awh:SetGravity(ui.LEFT, ui.TOP)
    awh:MoveFrame(0, 0)
    awh:SetOffset(0, 205)
    awh:SetSkinName("None")
    awh:EnableMove(0)
    awh:EnableHittestFrame(1)
    awh:SetLayerLevel(97)
    awh:RemoveAllChild()
    local gb = awh:CreateOrGetControl("groupbox", "gb", 45, 0, 0, 0)
    AUTO_CAST(gb)
    gb:EnableScrollBar(1)
    gb:SetSkinName("test_frame_midle")
    awh:Resize(670, 570)
    gb:Resize(613, 560)
    awh:ShowWindow(1)
    local inventory = ui.GetFrame("inventory")
    INVENTORY_SET_CUSTOM_RBTNDOWN("Another_warehouse_inv_rbtn")
    SET_INV_LBTN_FUNC(inventory, "Another_warehouse_inv_lbtn")
    Another_warehouse_tab_change(awh, gb, "", 0)
    Another_warehouse_auto_func_start(awh)
end

function Another_warehouse_tab_change(awh, ctrl, search_text, index)
    local tab_index = awh:GetUserIValue("TAB_INDEX")
    if tab_index ~= index then
        local accountwarehouse = ui.GetFrame("accountwarehouse")
        local search_edit = GET_CHILD_RECURSIVELY(accountwarehouse, "awh_search_edit")
        search_edit:SetText("")
    end
    local tab_tbl = {"inventory_main", "inventory_equip", "inventory_supplies", "inventory_recipe", "inventory_card",
                     "inventory_material", "inventory_gem", "inventory_premium", "inventory_housing", "alchemy_item_tab"}
    for i, image in ipairs(tab_tbl) do
        local tab = awh:CreateOrGetControl("picture", "tab" .. image, 5, (i - 1) * 55, 40, 60)
        AUTO_CAST(tab)
        tab:SetClickSound("inven_arrange")
        tab:SetEventScript(ui.LBUTTONDOWN, "Another_warehouse_tab_change")
        tab:SetEventScriptArgNumber(ui.LBUTTONDOWN, i)
        if i == index then
            tab:SetImage(image .. "_clicked")
            awh:SetUserValue("TAB_INDEX", index)
        else
            tab:SetImage(image)
        end
        tab:SetEnableStretch(1)
    end
    if index == 0 then
        local tab = GET_CHILD(awh, "tab" .. tab_tbl[1])
        tab:SetImage(tab_tbl[1] .. "_clicked")
        awh:SetUserValue("TAB_INDEX", 1)
    end
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    gb:RemoveAllChild()
    Another_warehouse_frame_update(awh, gb, search_text, index)
end

function Another_warehouse_frame_update(awh, gb, search_text, index)
    local tree = gb:CreateOrGetControl("tree", "inventory_tree", 5, 10, 0, 0)
    AUTO_CAST(tree)
    tree:Clear()
    tree:InvalidateTree()
    tree:EnableDrawFrame(false)
    tree:EnableDrawTreeLine(false)
    tree:SetFitToChild(true, 20) -- 下の余白
    tree:SetFontName("white_20_ol")
    tree:SetTabWidth("15")
    tree:Resize(600, 0)
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local sorted_guid_list = item_list:GetSortedGuidList()
    local warehouse_item_list = {}
    local group_counts = {}
    local slotset_counts = {}
    local tab_filter_map = {nil, {
        ["EquipGroup"] = true
    }, {
        ["NonEquipGroup"] = true,
        ["Cube"] = true
    }, {
        ["Recipe"] = true
    }, {
        ["Card"] = true
    }, {
        ["Material"] = true
    }, {
        ["Gem"] = true
    }, {
        ["Premium"] = true
    }, {
        ["Housing"] = true
    }, {
        ["Ancient"] = true,
        ["HiiddenAbility"] = true
    }}
    local current_filter = tab_filter_map[index]
    for i = 0, sorted_guid_list:Count() - 1 do
        local warehouse_item = item_list:GetItemByGuid(sorted_guid_list:Get(i))
        if warehouse_item then
            local item_cls = GetIES(warehouse_item:GetObject())
            local baseid_cls = INV_GET_INVEN_BASEIDCLS_BY_ITEMGUID(warehouse_item:GetIESID())
            if baseid_cls then
                local type_str = GET_INVENTORY_TREEGROUP(baseid_cls)
                if type_str ~= 'Quest' and baseid_cls.ClassName ~= 'Unused' then
                    local make_slot = Another_warehouse_check_search_and_filter(warehouse_item, item_cls, search_text)
                    if make_slot and warehouse_item.count > 0 then
                        local group_name = baseid_cls.TreeGroup
                        local is_visible = (current_filter == nil) or (current_filter[group_name] == true)
                        if is_visible then
                            table.insert(warehouse_item_list, warehouse_item)
                            local group_name = baseid_cls.TreeGroup
                            group_counts[group_name] = (group_counts[group_name] or 0) + 1
                            local className = baseid_cls.ClassName
                            if baseid_cls.MergedTreeTitle ~= "NO" then
                                className = baseid_cls.MergedTreeTitle
                            end
                            local slotset_name = 'sset_' .. className
                            slotset_counts[slotset_name] = (slotset_counts[slotset_name] or 0) + 1
                        end
                    end
                end
            end
        end
    end
    --[[local fix_sort_addon = _G["ADDONS"]["weizlogy"]["fixinventorysort"]

    if fix_sort_addon and type(fix_sort_addon) == "function" then
        local sort_worker = fix_sort_addon()
        if sort_worker and type(sort_worker.Sort) == "function" then
            warehouse_item_list = sort_worker:Sort(warehouse_item_list, false)
        end
    else]]
    table.sort(warehouse_item_list, Another_warehouse_INVENTORY_SORT_BY_NAME)
    local created_groups = {}
    local created_slotsets = {}
    local group_order = {"Premium", "EquipGroup", "NonEquipGroup", "Cube", "Gem", "Card", "Recipe", "Material",
                         "HiiddenAbility", "Ancient"}
    local group_caption_map = {}
    local baseid_list, cnt = GetClassList("inven_baseid")
    for i = 0, cnt - 1 do
        local cls = GetClassByIndexFromList(baseid_list, i)
        if cls.TreeGroup ~= "None" then
            group_caption_map[cls.TreeGroup] = cls.TreeGroupCaption
        end
    end
    for _, group_name in ipairs(group_order) do
        local count = group_counts[group_name]
        local is_visible = (current_filter == nil) or (current_filter[group_name] == true)
        if is_visible and count and count > 0 then
            local caption = group_caption_map[group_name]
            if caption then
                local title_with_count = string.format("%s (%d)", caption, count)
                local tree_group = tree:Add(title_with_count, group_name)
                created_groups[group_name] = tree_group
            end
        end
    end
    for i = 0, cnt - 1 do
        local baseid_cls = GetClassByIndexFromList(baseid_list, i)
        local className = baseid_cls.ClassName
        if baseid_cls.MergedTreeTitle ~= "NO" then
            className = baseid_cls.MergedTreeTitle
        end
        local slotset_name = 'sset_' .. className
        local count = slotset_counts[slotset_name]
        local tree_group_name = baseid_cls.TreeGroup
        local is_visible = (current_filter == nil) or (current_filter[tree_group_name] == true)
        if is_visible and count and count > 0 and not created_slotsets[slotset_name] then
            local tree_group = created_groups[tree_group_name]
            if not tree_group then
                local caption = baseid_cls.TreeGroupCaption
                local group_count = group_counts[tree_group_name] or 0
                local title_with_count = string.format("%s (%d)", caption, group_count)
                tree_group = tree:Add(title_with_count, tree_group_name)
                created_groups[tree_group_name] = tree_group
            end
            local margin_height = 5
            local margin_name = "margin_top_" .. slotset_name
            local margin = tree:CreateOrGetControl('richtext', margin_name, 0, 0, 400, margin_height)
            AUTO_CAST(margin)
            margin:EnableResizeByText(0)
            margin:SetText("")
            tree:Add(tree_group, margin, margin_name)
            local slotset_title_value = slotset_name .. "_title"
            local title_with_count = string.format("{s18}%s (%d)", baseid_cls.TreeSSetTitle, count)
            local slotset_node = tree:Add(tree_group, title_with_count, slotset_title_value)
            local new_slot_set = Another_warehouse_make_inven_slotset(tree, slotset_name)
            tree:Add(slotset_node, new_slot_set, slotset_name)
            created_slotsets[slotset_name] = new_slot_set
        end
    end
    for _, inv_item in ipairs(warehouse_item_list) do
        local item_cls = GetIES(inv_item:GetObject())
        local baseid_cls = INV_GET_INVEN_BASEIDCLS_BY_ITEMGUID(inv_item:GetIESID())
        local className = baseid_cls.ClassName
        if baseid_cls.MergedTreeTitle ~= "NO" then
            className = baseid_cls.MergedTreeTitle
        end
        local slotset_name = 'sset_' .. className
        local new_slot_set = created_slotsets[slotset_name]
        if new_slot_set then
            AUTO_CAST(new_slot_set)
            local slot_count = new_slot_set:GetSlotCount()
            local count = new_slot_set:GetUserIValue("SLOT_ITEM_COUNT")
            while slot_count <= count do
                new_slot_set:ExpandRow()
                slot_count = new_slot_set:GetSlotCount()
            end
            local slot = new_slot_set:GetSlotByIndex(count)
            count = count + 1
            new_slot_set:SetUserValue("SLOT_ITEM_COUNT", count)
            slot:ShowWindow(1)
            Another_warehouse_insert_item_to_tree(gb, tree, slot, inv_item, item_cls, slotset_name, baseid_cls)
        end
    end
    for _, slotset in pairs(created_slotsets) do
        local row = math.ceil(slotset:GetSlotCount() / slotset:GetCol())
        local height = row * 54
        slotset:Resize(slotset:GetWidth(), height)
    end
    local bottom_margin = 10 -- 隙間の高
    for _, group_name in ipairs(group_order) do
        local tree_group = created_groups[group_name]
        if tree_group and tree:GetChildCount(tree_group) > 0 then
            local margin_name = 'margin_' .. group_name
            local margin = tree:CreateOrGetControl('richtext', margin_name, 0, 0, 400, bottom_margin)
            AUTO_CAST(margin)
            margin:EnableResizeByText(0)
            margin:SetText("")
            tree:Add(tree_group, margin, margin_name)
        end
    end
    tree:OpenNodeAll()
    local max_count = Another_warehouse_get_maxcount()
    local item_count = Another_warehouse_item_count()
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local count_text = GET_CHILD_RECURSIVELY(accountwarehouse, "awh_count_text")
    AUTO_CAST(count_text)
    count_text:SetText("{@st42}" .. item_count .. "/" .. max_count .. "{/}")
    count_text:SetFontName("white_16_ol")
    awh:RunUpdateScript("Another_warehouse_set_scroll_pos")
end

function Another_warehouse_INVENTORY_SORT_BY_NAME(a, b)
    local item_cls_a = GetIES(a:GetObject())
    local item_cls_b = GetIES(b:GetObject())
    local item_name_a = dic.getTranslatedStr(item_cls_a.Name)
    local item_name_b = dic.getTranslatedStr(item_cls_b.Name)
    return item_name_a < item_name_b
end

function Another_warehouse_set_scroll_pos(awh)
    awh:StopUpdateScript("Another_warehouse_set_scroll_pos")
    local saved_pos = awh:GetUserIValue("SCROLL_POS")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    gb:SetScrollPos(saved_pos)
    gb:InvalidateScrollBar()
    return 0
end

function Another_warehouse_make_inven_slotset(tree, name)
    local slotset = tree:CreateOrGetControl('slotset', name, 0, 0, 0, 0)
    AUTO_CAST(slotset)
    slotset:EnablePop(0)
    slotset:EnableDrag(0)
    slotset:EnableDrop(0)
    slotset:SetMaxSelectionCount(999)
    slotset:SetSlotSize(54, 54)
    slotset:SetColRow(10, 1)
    slotset:SetSpc(0, 0)
    slotset:SetSkinName('invenslot')
    slotset:EnableSelection(0)
    slotset:CreateSlots()
    return slotset
end

function Another_warehouse_insert_item_to_tree(gb, tree, slot, inv_item, item_cls, slotset_name, baseid_cls)
    local slot_set = GET_CHILD_RECURSIVELY(gb, slotset_name)
    UPDATE_INVENTORY_SLOT(slot, inv_item, item_cls)
    slot:SetSkinName('invenslot2')
    local item_cls = GetIES(inv_item:GetObject())
    local iconImg = GET_ITEM_ICON_IMAGE(item_cls)
    if geItemTable.IsStack(item_cls.ClassID) == 1 and Another_warehouse_is_stack_new_item(item_cls.ClassID) then
        slot:SetHeaderImage('new_inventory_icon')
    elseif geItemTable.IsStack(item_cls.ClassID) == 0 and
        Another_warehouse_is_stack_new_item(item_cls.ClassID .. "_" .. inv_item:GetIESID()) then
        slot:SetHeaderImage('new_inventory_icon')
    else
        slot:SetHeaderImage('None')
    end
    SET_SLOT_IMG(slot, iconImg)
    SET_SLOT_COUNT(slot, inv_item.count)
    SET_SLOT_STYLESET(slot, item_cls)
    SET_SLOT_IESID(slot, inv_item:GetIESID())
    SET_SLOT_ITEM_TEXT_USE_INVCOUNT(slot, inv_item, item_cls, nil)
    slot:SetMaxSelectCount(inv_item.count);
    local icon = slot:GetIcon()
    icon:SetTooltipArg("accountwarehouse", inv_item.type, inv_item:GetIESID())
    SET_ITEM_TOOLTIP_TYPE(icon, item_cls.ClassID, item_cls, "accountwarehouse")
    SET_SLOT_ICOR_CATEGORY(slot, item_cls)
    if inv_item.hasLifeTime == true or TryGetProp(item_cls, 'ExpireDateTime', 'None') ~= 'None' then
        ICON_SET_ITEM_REMAIN_LIFETIME(icon, IT_ACCOUNT_WAREHOUSE)
        slot:SetFrontImage('clock_inven')
    else
        CLEAR_ICON_REMAIN_LIFETIME(slot, icon)
    end
    if string.find(item_cls.ClassName, "GoddessIcor") and string.find(item_cls.ClassName, "high") then
        local item_obj = GetIES(inv_item:GetObject())
        SET_SLOT_STAR_TEXT(slot, item_obj)
    end
    slot:SetEventScript(ui.LBUTTONUP, "Another_warehouse_on_lbutton") -- inv_item:GetIESID()
    slot:SetEventScriptArgString(ui.LBUTTONUP, inv_item:GetIESID())
    slot:SetEventScript(ui.RBUTTONUP, "Another_warehouse_on_rbutton")
    slot:SetEventScriptArgString(ui.RBUTTONUP, inv_item:GetIESID())
    if g.awh_settings.etc.display_change == 1 then
        if baseid_cls.TreeGroup == "Material" and slotset_name == "sset_Misc_Special" then
            if string.find(item_cls.ClassName, "GoddessIcor") and not string.find(item_cls.ClassName, "EP17") then
                slot:SetSkinName("invenslot_rare")
            end
        end
        if baseid_cls.TreeGroup == "Recipe" then -- Material
            local recipe_cls = GetClass('Recipe', item_cls.ClassName);
            if recipe_cls ~= nil then
                local taget_item = GetClass("Item", recipe_cls.TargetItem);
                if taget_item then
                    local image = GET_ITEM_ICON_IMAGE(taget_item)
                    local recipe_pic = slot:CreateOrGetControl('picture', 'recipe_pic' .. inv_item:GetIESID(), 0, 0, 25,
                        25)
                    AUTO_CAST(recipe_pic)
                    recipe_pic:SetEnableStretch(1)
                    recipe_pic:SetGravity(ui.LEFT, ui.TOP)
                    recipe_pic:SetImage(image)
                    recipe_pic:SetTooltipArg("accountwarehouse", inv_item.type, inv_item:GetIESID())
                    SET_ITEM_TOOLTIP_TYPE(recipe_pic, taget_item.ClassID, taget_item, "accountwarehouse")
                end
            end
        end
        if string.find(baseid_cls.ClassName, "Card") and not string.find(baseid_cls.ClassName, "Summon") and
            not string.find(baseid_cls.ClassName, "CardAddExp") then
            local image = TryGetProp(item_cls, "TooltipImage", "None")
            if image ~= "None" then
                icon:Set(image, 'Item', inv_item.type, inv_item.invIndex, inv_item:GetIESID(), inv_item.count)
            end
        end
        if baseid_cls.ClassName == "Gem_GemSkill" then
            for i = 1, 4 do
                if TryGetProp(item_cls, 'RandomOption_' .. i, 'None') ~= 'None' and
                    TryGetProp(item_cls, 'RandomOptionValue_' .. i, 0) > 0 then
                    local star_pic =
                        slot:CreateOrGetControl('richtext', 'star_pic' .. inv_item:GetIESID(), 0, 0, 18, 18)
                    star_pic:SetText("{img star_mark 18 18}")
                    star_pic:SetGravity(ui.RIGHT, ui.TOP)
                end
            end
            local skill_cls = GetClass("Skill", TryGetProp(item_cls, 'SkillName', 'None'))
            if skill_cls then
                local image = "icon_" .. GET_ITEM_ICON_IMAGE(skill_cls)
                icon:Set(image, 'Item', inv_item.type, inv_item.invIndex, inv_item:GetIESID(), inv_item.count)
                local skill_pic = slot:CreateOrGetControl('picture', 'skill_pic' .. inv_item:GetIESID(), 0, 0, 25, 25)
                AUTO_CAST(skill_pic)
                local image = GET_ITEM_ICON_IMAGE(item_cls)
                skill_pic:SetEnableStretch(1)
                skill_pic:SetGravity(ui.LEFT, ui.TOP)
                skill_pic:SetImage(image)
                SET_ITEM_TOOLTIP_TYPE(skill_pic, item_cls.ClassID, item_cls, "accountwarehouse")
            end
        elseif baseid_cls.ClassName == "Gem_High_Color" then
            local cls_name = item_cls.ClassName
            if string.find(cls_name, "540") then
                slot:SetSkinName("invenslot_pic_goddess")
            elseif string.find(cls_name, "520") then
                slot:SetSkinName("invenslot_legend")
            elseif string.find(cls_name, "500") then
                slot:SetSkinName("invenslot_unique")
            elseif string.find(cls_name, "480") then
                slot:SetSkinName("invenslot_rare")
            else
                slot:SetSkinName("invenslot_nomal")
            end
        end
        if string.find(baseid_cls.ClassName, "OPTMisc_GoddessIcor") then
            local cls_name = item_cls.ClassName
            local is_special = string.find(cls_name, "EP17") or string.find(cls_name, "Weapon2") or
                                   string.find(cls_name, "Armor2")
            if not is_special then
                slot:SetSkinName("invenslot_rare")
            end
        elseif string.find(baseid_cls.ClassName, "Armor") then
            local cls_name = item_cls.ClassName
            local is_special = string.find(cls_name, "EP17") or
                                   (string.find(cls_name, "EP16") and string.find(cls_name, "high")) or
                                   (string.find(cls_name, "EP13") and string.find(cls_name, "high2"))
            if not is_special and (string.find(cls_name, "belt") or string.find(cls_name, "shoulder")) then
                slot:SetSkinName("invenslot_rare")
            end
        end
    end
end

function Another_warehouse_is_stack_new_item(class_id)
    for k, v in pairs(g.awh_new_stack_add_item) do
        if v == class_id then
            return true
        end
    end
    return false
end

function Another_warehouse_check_search_and_filter(inv_item, item_cls, search_text)
    if search_text == "" then
        return true
    end
    local temp_cap = string.lower(search_text)
    local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(item_cls.Name))
    if string.find(item_name, temp_cap) then
        return true
    end
    local prefix_class_name = TryGetProp(item_cls, "LegendPrefix")
    if prefix_class_name and prefix_class_name ~= "None" then
        local prefix_cls = GetClass('LegendSetItem', prefix_class_name)
        if prefix_cls then
            local prefix_name = string.lower(dictionary.ReplaceDicIDInCompStr(prefix_cls.Name))
            if string.find(prefix_name .. " " .. item_name, temp_cap) then
                return true
            end
        end
    end
    if TryGetProp(item_cls, 'GroupName', 'None') == 'Earring' then
        local max_option_count = shared_item_earring.get_max_special_option_count(TryGetProp(item_cls, 'UseLv', 1))
        for i = 1, max_option_count do
            local option_name = 'EarringSpecialOption_' .. i
            local job_id = TryGetProp(item_cls, option_name, 'None')
            if job_id ~= 'None' then
                local job_cls = GetClass('Job', job_id)
                if job_cls and string.find(string.lower(dictionary.ReplaceDicIDInCompStr(job_cls.Name)), temp_cap) then
                    return true
                end
            end
        end
    end
    if TryGetProp(item_cls, 'GroupName', 'None') == 'Icor' then
        local item = GetIES(inv_item:GetObject())
        for i = 1, 5 do
            local option = TryGetProp(item, 'RandomOption_' .. i, 'None')
            if option and option ~= "None" and
                string.find(string.lower(dictionary.ReplaceDicIDInCompStr(ClMsg(option))), temp_cap) then
                return true
            end
        end
    end
    return false
end

function Another_warehouse_get_maxcount()
    local acc_obj = GetMyAccountObj()
    local token_bonus = 0
    local my_handle = session.GetMyHandle()
    local buff = info.GetBuff(my_handle, 70002)
    if buff then
        token_bonus = ADDITIONAL_SLOT_COUNT_BY_TOKEN + 280
    end
    local max_cnt = acc_obj.BasicAccountWarehouseSlotCount + acc_obj.MaxAccountWarehouseCount +
                        acc_obj.AccountWareHouseExtend + acc_obj.AccountWareHouseExtendByItem + token_bonus
    return max_cnt
end
-- 900011
function Another_warehouse_item_count()
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local guid_list = item_list:GetSortedGuidList()
    local cnt = item_list:Count()
    local return_cnt = 0
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i);
        local inv_item = item_list:GetItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            if item_obj.ClassID ~= 900011 then -- 900011 Vis シルバー
                return_cnt = return_cnt + 1
            end
        end
    end
    return return_cnt
end

function Another_warehouse_get_goal_index()
    local acc_obj = GetMyAccountObj()
    local base_count = acc_obj.BasicAccountWarehouseSlotCount + acc_obj.MaxAccountWarehouseCount +
                           acc_obj.AccountWareHouseExtend + acc_obj.AccountWareHouseExtendByItem
    local tab_index = {4, 3, 2, 1, 0}
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    local tab = GET_CHILD(accountwarehouse, "accountwarehouse_tab")
    local slotset = GET_CHILD_RECURSIVELY(accountwarehouse, "slotset")
    for index = 1, #tab_index do
        local i = tab_index[index]
        tab:SelectTab(i)
        if i > 0 and session.loginInfo.IsPremiumState(ITEM_TOKEN) then
            local itemcnt = GET_CHILD_RECURSIVELY(accountwarehouse, "itemcnt")
            local num_str = string.match(itemcnt:GetText(), "{@st42}(%d+)/")
            local left = tonumber(num_str)
            if left < 70 then
                return ((i - 1) * 70) + base_count + left + 1
            end
        else
            for j = 1, base_count do
                local slot = slotset:GetSlotByIndex(j)
                AUTO_CAST(slot)
                if slot:GetIcon() == nil then
                    return j
                end
            end
        end
    end
end

function Another_warehouse_check_valid(inv_item)
    local item_count = Another_warehouse_item_count()
    local max_count = Another_warehouse_get_maxcount()
    if max_count <= item_count then
        ui.SysMsg(ClMsg('CannotPutBecauseMaxSlot'))
        return false
    end
    if true == inv_item.isLockState then
        ui.SysMsg(ClMsg("MaterialItemIsLock"))
        return false
    end
    local obj = GetIES(inv_item:GetObject())
    local item_cls = GetClassByType("Item", obj.ClassID)
    if item_cls.ItemType == 'Quest' then
        ui.MsgBox(ScpArgMsg("IT_ISNT_REINFORCEABLE_ITEM"))
        return false
    end
    local enable_team_trade = TryGetProp(item_cls, "TeamTrade")
    if enable_team_trade and enable_team_trade == "NO" then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return false
    end
    if TryGetProp(obj, 'CharacterBelonging', 0) == 1 then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return false
    end
    return true
end

function Another_warehouse_search(frame, ctrl, str, num)
    local awh = ui.GetFrame(addon_name_lower .. "awh")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local search_text = ctrl:GetText()
    local tab = GET_CHILD(awh, "tab" .. "inventory_main")
    Another_warehouse_tab_change(awh, tab, search_text, 1)
end

function Another_warehouse_inv_lbtn(frame, inv_item, dumm)
    if not Another_warehouse_check_valid(inv_item) then
        return
    end
    local iesid = inv_item:GetIESID()
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        local count = math.min(10, inv_item.count)
        Another_warehouse_putitem(inv_item, iesid, count)
    else
        Another_warehouse_putitem(inv_item, iesid, 1)
    end
end

function Another_warehouse_inv_rbtn(item_obj, slot)
    if g.settings.cc_helper.use == 1 then
        local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
        if cch_setting and cch_setting:IsVisible() == 1 then
            INVENTORY_SET_CUSTOM_RBTNDOWN("Cc_helper_inv_rbtn")
            return
        end
    end
    local icon = slot:GetIcon()
    local icon_info = icon:GetInfo()
    local iesid = icon_info:GetIESID()
    local inv_item = GET_PC_ITEM_BY_GUID(iesid)
    if not inv_item then
        return
    end
    -- ui.AlarmMsg(TryGetProp(GetIES(inv_item:GetObject()), 'BelongingCount', 0))
    if not Another_warehouse_check_valid(inv_item) then
        return
    end
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        local accountwarehouse = ui.GetFrame("accountwarehouse")
        local obj = GetIES(inv_item:GetObject())
        local max_cnt = inv_item.count
        local belonging_count = TryGetProp(obj, 'BelongingCount', 0)
        if belonging_count > 0 then
            max_cnt = inv_item.count - obj.BelongingCount
            if max_cnt <= 0 then
                max_cnt = 0
            end
        end
        if inv_item.count > 1 or geItemTable.IsStack(obj.ClassID) == 1 then
            INPUT_NUMBER_BOX(accountwarehouse, ScpArgMsg("InputCount"), "EXEC_PUT_ITEM_TO_ACCOUNT_WAREHOUSE", max_cnt,
                1, max_cnt, nil, iesid)
        else
            Another_warehouse_putitem(inv_item, iesid, inv_item.count)
        end
    else
        Another_warehouse_putitem(inv_item, iesid, inv_item.count)
    end
end

function Another_warehouse_on_lbutton(parent, slot, iesid, num)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local inv_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, iesid)
    local obj = GetIES(inv_item:GetObject())
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        local count = math.min(10, inv_item.count)
        Another_warehouse_takeitem(accountwarehouse, iesid, count)
    else
        Another_warehouse_takeitem(accountwarehouse, iesid, 1)
    end
end

function Another_warehouse_on_rbutton(frame, slot, iesid, argnum)
    if g.settings.cc_helper.use == 1 then
        local cch_setting = ui.GetFrame(addon_name_lower .. "cch_setting")
        if cch_setting and cch_setting:IsVisible() == 1 then
            local slot = ui.GetFocusObject()
            if not slot then
                return
            end
            local icon = slot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local iesid = icon_info:GetIESID()
                local awh_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, iesid)
                if not awh_item then
                    return
                end
                local item_obj = GetIES(awh_item:GetObject())
                Cc_helper_inv_rbtn(item_obj, slot, iesid, awh_item)
            end
            return
        end
    end
    local awh_setting = ui.GetFrame(addon_name_lower .. "awh_setting")
    if awh_setting and awh_setting:IsVisible() == 1 then
        AUTO_CAST(awh_setting)
        local inv_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, iesid)
        if not inv_item then
            return
        end
        local obj = GetIES(inv_item:GetObject())
        local cls_id = obj.ClassID
        local item_cls = GetClassByType("Item", cls_id)
        if inv_item.isLockState then
            ui.SysMsg(ClMsg("MaterialItemIsLock"))
            return
        end
        if item_cls.ItemType == 'Quest' then
            ui.MsgBox(ScpArgMsg("IT_ISNT_REINFORCEABLE_ITEM"));
            return
        end
        local enable_team_trade = TryGetProp(item_cls, "TeamTrade")
        if enable_team_trade and enable_team_trade == "NO" then
            ui.SysMsg(ClMsg("ItemIsNotTradable"))
            return
        end
        local belonging_count = TryGetProp(obj, 'BelongingCount', 0)
        if belonging_count > 0 and belonging_count >= inv_item.count then
            ui.SysMsg(ClMsg("ItemIsNotTradable"))
            return
        end
        if TryGetProp(obj, 'CharacterBelonging', 0) == 1 then
            ui.SysMsg(ClMsg("ItemIsNotTradable"))
            return
        end
        local items = {}
        local slotset_name = ""
        if keyboard.IsKeyPressed("LSHIFT") == 1 then
            items = g.awh_settings.chars[g.cid].items
            slotset_name = "char_slotset"
        else
            items = g.awh_settings.items
            slotset_name = "team_slotset"
        end
        for key, value in pairs(items) do
            if value.clsid == cls_id then
                ui.SysMsg(g.lang == "Japanese" and "既に登録済です" or "Already registered")
                return
            end
        end
        local awh_setting = ui.GetFrame(addon_name_lower .. "awh_setting")
        local target_slotset = GET_CHILD_RECURSIVELY(awh_setting, slotset_name)
        local slotcount = target_slotset:GetSlotCount()
        local index = 1
        for i = 1, slotcount do
            local awslot = GET_CHILD_RECURSIVELY(target_slotset, "slot" .. i)
            local slot_icon = awslot:GetIcon()
            if slot_icon == nil then
                index = i
                break
            end
        end
        local ctrl = GET_CHILD_RECURSIVELY(target_slotset, "slot" .. index)
        if tonumber(item_cls.MaxStack) > 1 then
            awh_setting:SetUserValue("SLOT_NAME", ctrl:GetParent():GetName())
            local msg = g.lang == "Japanese" and "インベントリに残す数を入力" or
                            "Enter the number to be left in the inventory"
            INPUT_NUMBER_BOX(awh_setting, msg, "Another_warehouse_setting_item_count", 0, 0,
                tonumber(item_cls.MaxStack), cls_id, tostring(index), nil)
        else
            items[tostring(index)] = {
                clsid = cls_id,
                count = 0
            }
            SET_SLOT_ITEM_CLS(ctrl, item_cls)
            Another_warehouse_save_settings()
        end
        return
    end
    local awh_set_items = ui.GetFrame(addon_name_lower .. "awh_set_items")
    if awh_set_items and awh_set_items:IsVisible() == 1 then
        AUTO_CAST(awh_set_items)
        local name_edit = GET_CHILD(awh_set_items, "name_edit")
        local name_text = string.gsub(name_edit:GetText(), "{ol}", "")
        local index = 0
        for i, data in ipairs(g.awh_settings.take_list) do
            local name = data.name
            if name == name_text then
                index = i
            end
        end
        local set_slotset = GET_CHILD_RECURSIVELY(awh_set_items, 'set_slotset')
        AUTO_CAST(set_slotset)
        local slotcount = set_slotset:GetSlotCount()
        for i = 1, slotcount do
            local slot = GET_CHILD(set_slotset, "slot" .. i)
            AUTO_CAST(slot)
            local slot_index = string.gsub(slot:GetName(), "slot", "")
            local icon = slot:GetIcon()
            if not icon then
                local inv_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, iesid)
                local obj = GetIES(inv_item:GetObject())
                g.awh_settings.take_list[index].items[slot_index] = obj.ClassID
                break
            end
        end
        Another_warehouse_save_settings()
        Another_warehouse_set_items_setting(index, name_text)
        return
    end
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local inv_item = session.GetEtcItemByGuid(IT_ACCOUNT_WAREHOUSE, iesid)
    local obj = GetIES(inv_item:GetObject())
    local count = inv_item.count
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        local belonging_count = TryGetProp(obj, 'BelongingCount', 0)
        local max_cnt = inv_item.count
        if belonging_count > 0 then
            max_cnt = count - obj.BelongingCount
            if max_cnt <= 0 then
                max_cnt = 0
            end
        end
        if count > 1 or geItemTable.IsStack(obj.ClassID) == 1 then
            INPUT_NUMBER_BOX(accountwarehouse, ScpArgMsg("InputCount"), "Another_warehouse_take_item_from_warehouse",
                max_cnt, 1, max_cnt, nil, iesid)
        else
            Another_warehouse_takeitem(accountwarehouse, iesid, 1)
        end
    else
        if count > 1 or geItemTable.IsStack(obj.ClassID) == 1 then
            if g.awh_settings.etc.leave_item == 1 then
                count = count - 1
            end
            Another_warehouse_takeitem(accountwarehouse, iesid, count)
        else
            Another_warehouse_takeitem(accountwarehouse, iesid, 1)
        end
    end
end

function Another_warehouse_take_item_from_warehouse(accountwarehouse, count, input_frame)
    input_frame:ShowWindow(0)
    local iesid = input_frame:GetUserValue("ArgString")
    session.ResetItemList()
    session.AddItemID(iesid, count)
    local handle = accountwarehouse:GetUserIValue("HANDLE")
    item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
end

function Another_warehouse_putitem(inv_item, iesid, count)
    local item_obj = GetIES(inv_item:GetObject())
    local goal_index = Another_warehouse_get_goal_index()
    if Another_warehouse_check_valid(inv_item) then
        local accountwarehouse = ui.GetFrame("accountwarehouse")
        local handle = accountwarehouse:GetUserIValue("HANDLE")
        item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, iesid, tostring(count), handle, goal_index)
        local awh = ui.GetFrame(addon_name_lower .. "awh")
        AUTO_CAST(awh)
        awh:SetUserValue("TOOLTIP_COUNT", 0)
        Another_warehouse_item_put_to(awh, iesid, count, item_obj.ClassID)
        if geItemTable.IsStack(item_obj.ClassID) == 1 then
            table.insert(g.awh_new_stack_add_item, item_obj.ClassID)
        elseif geItemTable.IsStack(item_obj.ClassID) == 0 then
            table.insert(g.awh_new_stack_add_item, item_obj.ClassID .. "_" .. iesid)
        end
        local gbox_warehouse = GET_CHILD_RECURSIVELY(accountwarehouse, "gbox_warehouse")
        if gbox_warehouse then
            gbox_warehouse:UpdateData()
            accountwarehouse:Invalidate()
        end
    end
end

function Another_warehouse_takeitem(accountwarehouse, iesid, count)
    session.ResetItemList()
    session.AddItemID(iesid, count)
    local handle = accountwarehouse:GetUserIValue("HANDLE")
    item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
end

function Another_warehouse_auto_func_start(awh)
    local auto_money = g.awh_settings.chars[g.cid].money_check
    local my_handle = session.GetMyHandle()
    local buff = info.GetBuff(my_handle, 70002)
    if not buff then
        if auto_money == 1 then
            Another_warehouse_silver(awh)
        end
        ui.SysMsg(g.lang == "Japanese" and "[AWH]トークンがないため自動処理を停止します" or
                      "[AWH]Auto function stopped due to no token")
        return
    end
    local auto_item = g.awh_settings.chars[g.cid].item_check
    if auto_item == 0 and auto_money == 0 then
        return
    end
    g.another_warehouse_func = true
    if auto_item == 1 then
        Another_warehouse_auto_item_start(awh)
        return
    end
    if auto_money == 1 then
        Another_warehouse_silver(awh)
        return
    end
    Another_warehouse_end(awh)
end

function Another_warehouse_retry(frame)
    Another_warehouse_auto_item_start(frame, true)
    return 0
end

function Another_warehouse_auto_item_start(awh, is_retry)
    local status, err = pcall(Another_warehouse_auto_item_start_logic, awh, is_retry)
    if not status then
        local msg = "{#FF0000}[AWH Error] " .. tostring(err)
        ui.SysMsg(msg)
    end
end

function Another_warehouse_auto_item_start_logic(awh, is_retry)
    if not is_retry then
        g.awh_retry_count = 0
    end
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local sorted_guid_list = item_list:GetSortedGuidList()
    local sorted_cnt = sorted_guid_list:Count()

    if sorted_cnt == 0 then
        if accountwarehouse:IsVisible() == 1 then
            if g.awh_retry_count < 5 then
                g.awh_retry_count = g.awh_retry_count + 1
                accountwarehouse:StopUpdateScript("Another_warehouse_retry")
                accountwarehouse:RunUpdateScript("Another_warehouse_retry", 0.1)
                return
            else
                local msg = g.lang == "Japanese" and
                                "倉庫情報の取得に失敗しました{nl}アイテム自動取得をスキップします" or
                                "Failed to retrieve warehouse info{nl}Auto-take skipped"
                ui.SysMsg(msg)
            end
        end
    end
    g.awh_take_items = {}
    g.awh_put_items = {}
    local function get_target_count(cls_id)
        local target_count = 0
        local is_target = false
        if g.awh_settings.chars[g.cid] and g.awh_settings.chars[g.cid].items then
            for _, item in pairs(g.awh_settings.chars[g.cid].items) do
                if item.clsid == cls_id then
                    target_count = item.count
                    is_target = true
                    break
                end
            end
        end
        if not is_target and g.awh_settings.items then
            for _, item in pairs(g.awh_settings.items) do
                if item.clsid == cls_id then
                    target_count = item.count
                    is_target = true
                    break
                end
            end
        end
        return target_count, is_target
    end
    local current_inv_counts = {}
    local inv_item_list = session.GetInvItemList()
    local inv_guid_list = inv_item_list:GetGuidList()
    local inv_cnt = inv_guid_list:Count()
    for i = 0, inv_cnt - 1 do
        local guid = inv_guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        if inv_item then
            local inv_obj = GetIES(inv_item:GetObject())
            local cls_id = inv_obj.ClassID
            if cls_id ~= 900011 then
                current_inv_counts[cls_id] = (current_inv_counts[cls_id] or 0) + inv_item.count
            end
        end
    end
    for i = 0, sorted_cnt - 1 do
        local guid = sorted_guid_list:Get(i)
        local wh_item = item_list:GetItemByGuid(guid)
        local cls_id = wh_item.type
        if cls_id ~= 900011 then
            local target_count, is_target = get_target_count(cls_id)
            if is_target then
                local wh_available = g.awh_settings.etc.leave_item == 1 and wh_item.count - 1 or wh_item.count
                if wh_available > 0 then
                    local current_count = current_inv_counts[cls_id] or 0
                    local need_count = target_count - current_count
                    if need_count > 0 then
                        local take_amount = math.min(wh_available, need_count)
                        g.awh_take_items[guid] = {
                            iesid = guid,
                            count = take_amount,
                            clsid = cls_id
                        }
                        current_inv_counts[cls_id] = current_count + take_amount
                    end
                end
            end
        end
    end
    current_inv_counts = {}
    for i = 0, inv_cnt - 1 do
        local guid = inv_guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        if inv_item then
            local inv_obj = GetIES(inv_item:GetObject())
            local cls_id = inv_obj.ClassID
            if cls_id ~= 900011 then
                current_inv_counts[cls_id] = (current_inv_counts[cls_id] or 0) + inv_item.count
            end
        end
    end
    for i = 0, inv_cnt - 1 do
        local guid = inv_guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        if inv_item then
            local inv_obj = GetIES(inv_item:GetObject())
            local cls_id = inv_obj.ClassID
            if cls_id ~= 900011 then
                local target_count, is_target = get_target_count(cls_id)
                if is_target then
                    local current_total = current_inv_counts[cls_id] or 0
                    local surplus = current_total - target_count -- 過剰分
                    if surplus > 0 then
                        local put_amount = math.min(inv_item.count, surplus)
                        g.awh_put_items[guid] = {
                            iesid = guid,
                            count = put_amount,
                            clsid = cls_id,
                            invcount = inv_item.count,
                            initial_count = inv_item.count
                        }
                        current_inv_counts[cls_id] = current_total - put_amount
                    end
                end
            end
        end
    end
    local take_clsids = {}
    for _, data in pairs(g.awh_take_items) do
        take_clsids[data.clsid] = true
    end
    for guid, data in pairs(g.awh_put_items) do
        if take_clsids[data.clsid] then
            g.awh_put_items[guid] = nil
        end
    end
    Another_warehouse_item_take(awh)
end

function Another_warehouse_item_take(awh)
    if awh:GetUserIValue("IS_TAKING") == 0 then
        local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
        session.ResetItemList()
        local take_count_total = 0
        for guid, items in pairs(g.awh_take_items) do
            local wh_item = item_list:GetItemByGuid(guid)
            if wh_item then
                local count = math.min(items.count, wh_item.count)
                if count > 0 then
                    session.AddItemID(guid, count)
                    take_count_total = take_count_total + 1
                end
            end
        end
        if take_count_total == 0 then
            awh:RunUpdateScript("Another_warehouse_item_put", 0.1)
            return 0
        end
        local accountwarehouse = ui.GetFrame('accountwarehouse')
        local handle = accountwarehouse:GetUserIValue('HANDLE')
        item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
        awh:SetUserValue("IS_TAKING", 1)
        awh:SetUserValue("TAKE_START_TIME", imcTime.GetAppTimeMS())
        awh:StopUpdateScript("Another_warehouse_item_take")
        awh:RunUpdateScript("Another_warehouse_item_take", 0.1)
        return 1
    end
    local all_arrived = true
    for guid, items in pairs(g.awh_take_items) do
        local inv_item = session.GetInvItemByGuid(guid)
        if not inv_item then
            all_arrived = false
            break
        end
    end
    local start_time = awh:GetUserIValue("TAKE_START_TIME")
    local now = imcTime.GetAppTimeMS()
    if all_arrived or (now - start_time > 1000) then
        awh:SetUserValue("IS_TAKING", 0)
        awh:SetUserValue("TOOLTIP_COUNT", 0)
        awh:RunUpdateScript("Another_warehouse_item_put", 0.1)
        return 0
    end
    return 1
end

function Another_warehouse_item_put(awh)
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    if accountwarehouse:IsVisible() == 0 then
        awh:StopUpdateScript("Another_warehouse_item_put")
        return 0
    end
    local next_guid, item_data = next(g.awh_put_items)
    if not next_guid then
        if g.awh_settings.chars[g.cid].money_check == 1 then
            Another_warehouse_silver(awh)
        else
            Another_warehouse_end(awh)
        end
        return 0
    end
    local is_finished = false
    local inv_item = session.GetInvItemByGuid(item_data.iesid)
    if not inv_item then
        is_finished = true
    elseif item_data.is_putting then
        if inv_item.count < item_data.initial_count then
            is_finished = true
        else
            return 1 -- まだ処理中
        end
    end
    if is_finished then
        local count = item_data.real_put_count or item_data.count
        Another_warehouse_item_put_to(awh, item_data.iesid, count, item_data.clsid)
        if geItemTable.IsStack(item_data.clsid) == 1 then
            table.insert(g.awh_new_stack_add_item, item_data.clsid)
        elseif geItemTable.IsStack(item_data.clsid) == 0 then
            table.insert(g.awh_new_stack_add_item, item_data.clsid .. "_" .. item_data.iesid)
        end
        g.awh_put_items[next_guid] = nil
        if not next(g.awh_put_items) then
            if g.awh_settings.chars[g.cid].money_check == 1 then
                Another_warehouse_silver(awh)
            else
                Another_warehouse_end(awh)
            end
            return 0
        end
        return 1
    end
    if not Another_warehouse_check_valid(inv_item) then
        awh:StopUpdateScript("Another_warehouse_item_put")
        return 0
    end
    local handle = accountwarehouse:GetUserIValue("HANDLE")
    local goal_index = Another_warehouse_get_goal_index()
    local put_count = item_data.count
    if put_count > inv_item.count then
        put_count = inv_item.count
    end
    item_data.initial_count = inv_item.count
    item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, item_data.iesid, tostring(put_count), handle, goal_index)
    item_data.is_putting = true
    item_data.real_put_count = put_count
    return 1
end

function Another_warehouse_item_put_to(awh, guid, count, cls_id)
    local item_cls = GetClassByType('Item', cls_id)
    local icon_name = GET_ITEM_ICON_IMAGE(item_cls)
    local item_name = item_cls.Name
    local tooltip_count = awh:GetUserIValue("TOOLTIP_COUNT")
    if tooltip_count >= 4 then
        awh:SetUserValue("TOOLTIP_COUNT", 0)
    else
        awh:SetUserValue("TOOLTIP_COUNT", tooltip_count + 1)
    end
    Another_warehouse_item_tooltip(item_name, icon_name, count, tooltip_count)
    local msg = g.lang == "Japanese" and "倉庫に格納しました" .. "：[" .. "{#EE82EE}" .. item_name ..
                    "{#FFFF00}]×" .. "{#EE82EE}" .. count or "Item to warehousing" .. "：[" .. "{#EE82EE}" ..
                    item_name .. "{#FFFF00}]×" .. "{#EE82EE}" .. count
    CHAT_SYSTEM(msg)
end

function Another_warehouse_item_tooltip(item_name, icon_name, count, tooltip_count)
    local awh_tooltip =
        ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "awh_tooltip" .. tooltip_count, 0, 0, 0, 0)
    AUTO_CAST(awh_tooltip)
    awh_tooltip:SetSkinName("None")
    awh_tooltip:SetPos(680, 300 + tooltip_count * 55)
    awh_tooltip:SetLayerLevel(100)
    awh_tooltip:Resize(350, 64)
    local tooltip_gb = awh_tooltip:CreateOrGetControl("groupbox", "tooltip_gb", 0, 0, 350, 64)
    AUTO_CAST(tooltip_gb)
    tooltip_gb:SetSkinName("item_show_tootip")
    tooltip_gb:Resize(350, 64)
    local tooltip_slot = tooltip_gb:CreateOrGetControl("slot", "tooltip_slot", 20, 10, 45, 45)
    AUTO_CAST(tooltip_slot)
    local tooltip_text = tooltip_gb:CreateOrGetControl("richtext", "tooltip_text", 75, 15, 265, 22)
    AUTO_CAST(tooltip_text)
    tooltip_text:Resize(265, 22)
    tooltip_text:SetText("{ol}" .. item_name)
    local tooltip_count = tooltip_gb:CreateOrGetControl("richtext", "tooltip_count", 75, 37, 265, 22)
    AUTO_CAST(tooltip_count)
    tooltip_count:Resize(265, 22)
    local msg = g.lang == "Japanese" and count .. " 個搬入しました" or count .. " Pieces in warehouse"
    tooltip_count:SetText("{ol}" .. msg)
    SET_SLOT_ICON(tooltip_slot, icon_name)
    awh_tooltip:ShowWindow(1)
    awh_tooltip:RunUpdateScript("Another_warehouse_item_tooltip_close", 2.0)
end

function Another_warehouse_item_tooltip_close(awh_tooltip)
    ui.DestroyFrame(awh_tooltip:GetName())
end

function Another_warehouse_silver(awh)
    local silver = session.GetInvItemByType(900011)
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    local handle = accountwarehouse:GetUserIValue('HANDLE')
    local char_silver = 0
    if silver then
        char_silver = tonumber(silver:GetAmountStr())
    end
    char_silver = char_silver - g.awh_settings.etc.auto_silver
    if char_silver > 0 then
        item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, silver:GetIESID(), tostring(char_silver), handle)
    elseif char_silver <= 0 then
        session.ResetItemList()
        session.AddItemIDWithAmount("0", tostring(-char_silver))
        item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
    end
    Another_warehouse_end(awh)
end

function Another_warehouse_end(awh)
    g.another_warehouse_func = false
    ui.SysMsg("[AWH]End of Operation")
    imcSound.PlaySoundEvent('sys_cube_open_normal')
    local awh = ui.GetFrame(addon_name_lower .. "awh")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local index = awh:GetUserIValue("TAB_INDEX")
    Another_warehouse_frame_update(awh, gb, "", index)
end

function Another_warehouse_setting_frame_init(frame, ctrl, str, num)
    local inventory = ui.GetFrame('inventory')
    inventory:ShowWindow(1)
    INVENTORY_SET_CUSTOM_RBTNDOWN("None")
    INVENTORY_SET_CUSTOM_RBTNDOWN("Another_warehouse_setting_rbtn")
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "awh_setting", 0, 0, 0, 0)
    AUTO_CAST(setting)
    setting:RemoveAllChild()
    setting:SetPos(670, 10)
    setting:Resize(740, 1060)
    setting:SetLayerLevel(96)
    setting:SetSkinName("test_frame_low")
    local title_gb = setting:CreateOrGetControl("groupbox", "title_gb", 0, 0, setting:GetWidth(), 55)
    title_gb:SetSkinName("test_frame_top")
    AUTO_CAST(title_gb)
    local title_text = title_gb:CreateOrGetControl("richtext", "title_text", 0, 0, ui.CENTER_HORZ, ui.TOP, 0, 15, 0, 0)
    AUTO_CAST(title_text)
    title_text:SetText('{ol}{s26}Another Warehouse Setting')
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetOffset(680, 15)
    close:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_close")
    local money_check = setting:CreateOrGetControl('checkbox', 'money_check', 25, 65, 25, 25)
    AUTO_CAST(money_check)
    money_check:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_check")
    money_check:SetCheck(g.awh_settings.chars[g.cid].money_check)
    money_check:SetText(g.lang == "Japanese" and "{ol}自動入出金" or "{ol}automatic deposit and withdrawal")
    money_check:SetTextTooltip(g.lang == "Japanese" and
                                   "{ol}チェックをすると、自動入出金有効化 各キャラクター毎に設定" or
                                   "{ol}If checked, activate silver auto-deposit/withdrawal{nl}configured per character")
    local item_check = setting:CreateOrGetControl('checkbox', 'item_check', 25, 95, 25, 25)
    AUTO_CAST(item_check)
    item_check:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_check")
    item_check:SetCheck(g.awh_settings.chars[g.cid].item_check)
    item_check:SetText(g.lang == "Japanese" and "{ol}自動搬出入" or "{ol}Automatic item receipt and dispatch")
    item_check:SetTextTooltip(g.lang == "Japanese" and
                                  "{ol}チェックをすると、自動搬出入有効化 各キャラクター毎に設定" or
                                  "{ol}If checked, activate item auto-deposit/withdrawal{nl}configured per character")
    local help = setting:CreateOrGetControl('button', "awh_help", 695, 65, 25, 25)
    AUTO_CAST(help)
    help:SetText("{img question_mark 15 15}")
    help:SetTextTooltip("HELP")
    help:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setting_help")
    local amount_text = setting:CreateOrGetControl("richtext", "amount_text", 400, 65, 0, 30)
    AUTO_CAST(amount_text)
    amount_text:SetText(g.lang == "Japanese" and "{ol}自動入出金 金額設定" or "{ol}Auto Transfer Amount Config")
    local amount_edit = setting:CreateOrGetControl('edit', 'amount_edit', 400, 90, 150, 35)
    AUTO_CAST(amount_edit)
    amount_edit:SetFontName("white_18_ol")
    amount_edit:SetTextAlign("center", "center")
    amount_edit:SetText(GET_COMMAED_STRING(g.awh_settings.etc.auto_silver or 0))
    amount_edit:SetNumberMode(1)
    amount_edit:SetEventScript(ui.ENTERKEY, 'Another_warehouse_setting_edit')
    local team_text = setting:CreateOrGetControl("richtext", "team_text", 25, 125, 0, 0)
    AUTO_CAST(team_text);
    team_text:SetText(g.lang == "Japanese" and "{ol}チーム倉庫の共通設定" or
                          "{ol}Team Storage Common Settings")
    local char_text = setting:CreateOrGetControl("richtext", "char_text", 25, 695, 0, 0)
    AUTO_CAST(char_text)
    char_text:SetText(g.lang == "Japanese" and "{ol}チーム倉庫のキャラクター個別設定" or
                          "{ol}Team Storage Character Settings")
    local team_gb = setting:CreateOrGetControl("groupbox", "team_gb", 20, 145, setting:GetWidth() - 25, 540)
    team_gb:SetSkinName("test_frame_low")
    AUTO_CAST(team_gb)
    Another_warehouse_setting_slot_set(team_gb, 'team_slotset')
    local char_gb = setting:CreateOrGetControl("groupbox", "char_gb", 20, 715, setting:GetWidth() - 25, 330)
    char_gb:SetSkinName("test_frame_low")
    AUTO_CAST(char_gb)
    Another_warehouse_setting_slot_set(char_gb, 'char_slotset')
    setting:ShowWindow(1)
end

function Another_warehouse_setting_close(setting)
    ui.DestroyFrame(setting:GetName())
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    ACCOUNTWAREHOUSE_CLOSE(accountwarehouse)
end

function Another_warehouse_setting_check(frame, ctrl)
    local ischeck = ctrl:IsChecked()
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "awh_leave" then -- 
        g.awh_settings.etc.leave_item = ischeck
    elseif ctrl_name == "awh_display_change" then
        g.awh_settings.etc.display_change = ischeck
    elseif ctrl_name == "money_check" then
        g.awh_settings.chars[g.cid].money_check = ischeck
    elseif ctrl_name == "item_check" then
        g.awh_settings.chars[g.cid].item_check = ischeck
    end
    Another_warehouse_save_settings()
    local awh = ui.GetFrame(addon_name_lower .. "awh")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local tab_index = awh:GetUserIValue("TAB_INDEX")
    Another_warehouse_frame_update(awh, gb, "", tab_index)
end

function Another_warehouse_setting_edit(frame, ctrl)
    local text = ctrl:GetText()
    local clean_text = string.gsub(text, ",", "") -- カンマを空文字に置換
    local ctrl_num = tonumber(clean_text) or 0
    if ctrl:GetName() == "amount_edit" then
        g.awh_settings.etc.auto_silver = ctrl_num
        ctrl:SetText(GET_COMMAED_STRING(g.awh_settings.etc.auto_silver))
    end
    Another_warehouse_save_settings()
end

function Another_warehouse_setting_help()
    local context = ui.CreateContextMenu("awh_setting_help_context", "{ol}[AWH] HELP", 30, 0, 100, 100)
    local msg =
        g.lang == "Japanese" and "インベントリ:マウス右クリックでチームのアイテム設定" or
            "Inventory: right mouse click to set team items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and
              "インベントリ:左SHIFT+マウス右クリックで各キャラのアイテム設定" or
              "Inventory: left SHIFT+mouse right click to set items for each character"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "設定スロット:左SHIFT+マウス右クリックで設定個数変更" or
              "Setting slot: left SHIFT+right mouse click to change the number of setting pieces"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "設定スロット:マウス右クリックで設定消去" or
              "Setting slot: right mouse click to clear settings"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    ui.OpenContextMenu(context)
end

function Another_warehouse_setting_slot_set(parent, slot_set_name)
    local slotset = parent:CreateOrGetControl('slotset', slot_set_name, 10, 10, 0, 0)
    AUTO_CAST(slotset)
    slotset:SetSlotSize(40, 40)
    slotset:EnablePop(1)
    slotset:EnableDrag(1)
    slotset:EnableDrop(1)
    slotset:SetColRow(17, 58)
    slotset:SetSpc(0, 0)
    slotset:SetSkinName('slot')
    slotset:SetEventScript(ui.DROP, "Another_warehouse_setting_swap_item")
    slotset:SetEventScript(ui.RBUTTONUP, "Another_warehouse_setting_icon_clear")
    slotset:CreateSlots()
    local slotcount = slotset:GetSlotCount()
    local items = {}
    if slot_set_name == 'team_slotset' then
        items = g.awh_settings.items
    elseif slot_set_name == 'char_slotset' then
        items = g.awh_settings.chars[g.cid].items
    end
    for i = 1, slotcount do
        local slot = GET_CHILD(slotset, "slot" .. i)
        local str_index = tostring(i)
        for key, value in pairs(items) do
            if key == str_index then
                local clsid = value.clsid
                local count = value.count
                local itemcls = GetClassByType("Item", clsid)
                slot:SetUserValue("ITEM_CLSID", clsid)
                SET_SLOT_ITEM_CLS(slot, itemcls)
                if count ~= 0 then
                    SET_SLOT_COUNT_TEXT(slot, count)
                end
            end
        end
    end
end

function Another_warehouse_setting_swap_item(parent, slot, str, num)
    local frame = parent:GetTopParentFrame()
    if frame:GetName() ~= addon_name_lower .. "awh_setting" then
        return
    end
    local items = {}
    local slot_set_name = parent:GetName()
    if slot_set_name == 'team_slotset' then
        items = g.awh_settings.items
    elseif slot_set_name == 'char_slotset' then
        items = g.awh_settings.chars[g.cid].items
    end
    local lift_icon = ui.GetLiftIcon()
    local from_slot = lift_icon:GetParent()
    local from_items = {}
    local from_slot_set_name = from_slot:GetParent():GetName()
    if from_slot_set_name == 'team_slotset' then
        from_items = g.awh_settings.items
    elseif from_slot_set_name == 'char_slotset' then
        from_items = g.awh_settings.chars[g.cid].items
    end
    local from_index = string.gsub(from_slot:GetName(), "slot", "")
    local from_data = from_items[from_index] -- データテーブルそのものを取得
    local to_index = string.gsub(slot:GetName(), "slot", "")
    local to_icon = slot:GetIcon()
    if not to_icon then
        from_items[from_index] = nil
        items[to_index] = from_data
    else
        local to_data = items[to_index]
        from_items[from_index] = to_data
        items[to_index] = from_data
    end
    Another_warehouse_save_settings()
    Another_warehouse_setting_frame_init(nil, nil, str, num)
end

function Another_warehouse_setting_icon_clear(parent, ctrl, str, num)
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        Another_warehouse_setting_count_change(parent, ctrl, str, num)
        return
    end
    local items = {}
    if parent:GetName() == 'team_slotset' then
        items = g.awh_settings.items
    elseif parent:GetName() == 'char_slotset' then
        items = g.awh_settings.chars[g.cid].items
    end
    local str_index = string.gsub(ctrl:GetName(), "slot", "")
    for key, value in pairs(items) do
        if key == str_index then
            ctrl:ClearIcon()
            ctrl:ClearText()
            items[str_index] = nil
            Another_warehouse_save_settings()
            break
        end
    end
end

function Another_warehouse_setting_count_change(frame, ctrl, strr, num)
    local slot_index = tonumber(string.gsub(ctrl:GetName(), "slot", ""))
    if slot_index then
        local cls_id = ctrl:GetUserIValue("ITEM_CLSID")
        local itemcls = GetClassByType("Item", cls_id)
        local awh_setting = ui.GetFrame(addon_name_lower .. "awh_setting")
        awh_setting:SetUserValue("SLOT_NAME", ctrl:GetParent():GetName())
        local msg = g.lang == "Japanese" and "インベントリに残す数を入力" or
                        "Enter the number to be left in the inventory"
        INPUT_NUMBER_BOX(awh_setting, msg, "Another_warehouse_setting_item_count", 0, 0, tonumber(itemcls.MaxStack),
            cls_id, tostring(slot_index), nil)
    end
end

function Another_warehouse_setting_item_count(awh_setting, count, input_frame)
    local clsid = input_frame:GetValue()
    local index = input_frame:GetUserValue("ArgString")
    local item_cls = GetClassByType("Item", clsid)
    local user_value = awh_setting:GetUserValue("SLOT_NAME")
    local items = {}
    if user_value == "char_slotset" then
        items = g.awh_settings.chars[g.cid].items
    else
        items = g.awh_settings.items
    end
    local slotset = GET_CHILD_RECURSIVELY(awh_setting, user_value)
    local slot = GET_CHILD_RECURSIVELY(slotset, "slot" .. index)
    items[tostring(index)] = {
        clsid = clsid,
        count = tonumber(count)
    }
    SET_SLOT_ITEM_CLS(slot, item_cls)
    if tonumber(count) ~= 0 then
        SET_SLOT_COUNT_TEXT(slot, tonumber(count))
    end
    Another_warehouse_save_settings()
    input_frame:ShowWindow(0)
end

function Another_warehouse_setting_rbtn(item_obj, slot)
    local icon = slot:GetIcon()
    local icon_info = icon:GetInfo()
    local iesid = icon_info:GetIESID()
    local inv_item = GET_PC_ITEM_BY_GUID(iesid)
    if not inv_item then
        return
    end
    local cls_id = icon_info.type
    local item_cls = GetClassByType("Item", cls_id)
    local obj = GetIES(inv_item:GetObject())
    if inv_item.isLockState then
        ui.SysMsg(ClMsg("MaterialItemIsLock"))
        return
    end
    if item_cls.ItemType == 'Quest' then
        ui.MsgBox(ScpArgMsg("IT_ISNT_REINFORCEABLE_ITEM"));
        return
    end
    local enable_team_trade = TryGetProp(item_cls, "TeamTrade")
    if enable_team_trade and enable_team_trade == "NO" then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return
    end
    local belonging_count = TryGetProp(obj, 'BelongingCount', 0)
    if belonging_count > 0 and belonging_count >= inv_item.count then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return
    end
    if TryGetProp(obj, 'CharacterBelonging', 0) == 1 then
        ui.SysMsg(ClMsg("ItemIsNotTradable"))
        return
    end
    local items = {}
    local slotset_name = ""
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        items = g.awh_settings.chars[g.cid].items
        slotset_name = "char_slotset"
    else
        items = g.awh_settings.items
        slotset_name = 'team_slotset'
    end
    for key, value in pairs(items) do
        if value.clsid == cls_id then
            ui.SysMsg(g.lang == "Japanese" and "既に登録済です" or "Already registered")
            return
        end
    end
    local awh_setting = ui.GetFrame(addon_name_lower .. "awh_setting")
    local slotset = GET_CHILD_RECURSIVELY(awh_setting, slotset_name)
    local slotcount = slotset:GetSlotCount()
    local index = 1
    for i = 1, slotcount do
        local awslot = GET_CHILD_RECURSIVELY(slotset, "slot" .. i)
        local slot_icon = awslot:GetIcon()
        if slot_icon == nil then
            index = i
            break
        end
    end
    local ctrl = GET_CHILD_RECURSIVELY(slotset, "slot" .. index)
    if tonumber(item_cls.MaxStack) > 1 then
        awh_setting:SetUserValue("SLOT_NAME", ctrl:GetParent():GetName())
        local msg = g.lang == "Japanese" and "インベントリに残す数を入力" or
                        "Enter the number to be left in the inventory"
        INPUT_NUMBER_BOX(awh_setting, msg, "Another_warehouse_setting_item_count", 0, 0, tonumber(item_cls.MaxStack),
            cls_id, tostring(index), nil)
    else
        items[tostring(index)] = {
            clsid = cls_id,
            count = 0
        }
        SET_SLOT_ITEM_CLS(ctrl, item_cls)
        Another_warehouse_save_settings()
    end
end

function Another_warehouse_setting_context(frame, ctrl, str, num)
    local context = ui.CreateContextMenu("awh_TAKE_SETTING", "{ol}{#FF0000}Slot Setting", 0, 20, 100, 100)
    for i, data in ipairs(g.awh_settings.take_list) do
        local name = data.name
        local scp = string.format("Another_warehouse_set_items_setting(%d,'%s')", i, name)
        ui.AddContextMenuItem(context, "{ol}{#FF0000}" .. name, scp)
    end
    ui.OpenContextMenu(context)
end

function Another_warehouse_set_items_setting(index, name)
    local awh_set_items = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "awh_set_items", 0, 0, 0, 0)
    AUTO_CAST(awh_set_items)
    awh_set_items:SetSkinName("test_frame_low")
    awh_set_items:SetPos(680, 170)
    awh_set_items:SetLayerLevel(100)
    awh_set_items:Resize(320, 608)
    awh_set_items:RemoveAllChild()
    local close = awh_set_items:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Another_warehouse_set_item_close")
    local set_gb = awh_set_items:CreateOrGetControl("groupbox", "set_gb", 10, 50, 380, 380)
    AUTO_CAST(set_gb)
    set_gb:SetSkinName("test_frame_midle_light")
    set_gb:Resize(300, 500)
    awh_set_items:ShowWindow(1)
    local name_edit = awh_set_items:CreateOrGetControl("edit", "name_edit", 10, 13, 210, 30)
    AUTO_CAST(name_edit)
    name_edit:SetFontName("white_16_ol")
    name_edit:SetTextAlign("center", "center")
    name_edit:SetText("{ol}" .. name)
    name_edit:SetEventScript(ui.ENTERKEY, "Another_warehouse_set_name_edit")
    name_edit:SetEventScriptArgString(ui.ENTERKEY, name)
    name_edit:SetEventScriptArgNumber(ui.ENTERKEY, index)
    local set_slotset = set_gb:CreateOrGetControl('slotset', 'set_slotset', 0, 0, 0, 0)
    AUTO_CAST(set_slotset)
    set_slotset:SetSlotSize(50, 50)
    set_slotset:EnablePop(1)
    set_slotset:EnableDrag(1)
    set_slotset:EnableDrop(1)
    set_slotset:SetEventScript(ui.DROP, "Another_warehouse_set_swap_item")
    set_slotset:SetEventScriptArgString(ui.DROP, name)
    set_slotset:SetEventScriptArgNumber(ui.DROP, index)
    set_slotset:SetColRow(6, 10)
    set_slotset:SetSpc(0, 0)
    set_slotset:SetSkinName('slot')
    set_slotset:CreateSlots()
    local target_set = g.awh_settings.take_list[index]
    local items_map = target_set.items
    local slotcount = set_slotset:GetSlotCount()
    for i = 1, slotcount do
        local slot = GET_CHILD(set_slotset, "slot" .. i)
        AUTO_CAST(slot)
        local icon = slot:GetIcon()
        if not icon then
            slot:SetTextTooltip(g.lang == "Japanese" and "{ol}倉庫アイテム右クリックで設定" or
                                    "{ol}Warehouse items right-click to setting")
        end
        local saved_clsid = items_map[tostring(i)]
        if saved_clsid then
            local item_cls = GetClassByType("Item", saved_clsid)
            if item_cls then
                SET_SLOT_ITEM_CLS(slot, item_cls)
                slot:SetEventScript(ui.RBUTTONUP, "Another_warehouse_set_clear_item")
                slot:SetEventScriptArgNumber(ui.RBUTTONUP, index)
                slot:SetEventScriptArgString(ui.RBUTTONUP, name)
            end
        end
    end
    local init = awh_set_items:CreateOrGetControl("button", "init", 0, 0, 100, 43)
    AUTO_CAST(init)
    init:SetText(g.lang == "Japanese" and "{@st66b}初期化" or "{@st66b}Initialize")
    init:SetMargin(210, 555, 0, 0)
    init:SetSkinName("test_pvp_btn")
    init:SetEventScript(ui.LBUTTONUP, "Another_warehouse_setslot_init")
    init:SetEventScriptArgString(ui.LBUTTONUP, name)
    init:SetEventScriptArgNumber(ui.LBUTTONUP, index)
    local take = awh_set_items:CreateOrGetControl("button", "awh_take", 0, 0, 100, 43)
    AUTO_CAST(take)
    take:SetText(g.lang == "Japanese" and "{@st66b}取出し" or "{@st66b}Withdrawal")
    take:SetMargin(10, 555, 0, 0)
    take:SetSkinName("test_pvp_btn")
    take:SetEventScript(ui.LBUTTONUP, "Another_warehouse_set_item_take_reserve")
    take:SetEventScriptArgString(ui.LBUTTONUP, name)
end

function Another_warehouse_set_item_take_reserve(frame, ctrl, name)
    Another_warehouse_set_item_take(name)
end

function Another_warehouse_set_clear_item(frame, ctrl, name, index)
    local slot_index = string.gsub(ctrl:GetName(), "slot", "")
    g.awh_settings.take_list[index].items[slot_index] = nil
    Another_warehouse_save_settings()
    Another_warehouse_set_items_setting(index, name)
end

function Another_warehouse_set_swap_item(parent, slot, name, index)
    if parent:GetTopParentFrame():GetName() ~= addon_name_lower .. "awh_set_items" then
        return
    end
    local lift_icon = ui.GetLiftIcon()
    local from_slot = lift_icon:GetParent()
    local from_index = string.gsub(from_slot:GetName(), "slot", "")
    local from_clsid = g.awh_settings.take_list[index].items[from_index]
    local to_index = string.gsub(slot:GetName(), "slot", "")
    local to_icon = slot:GetIcon()
    if not to_icon then
        g.awh_settings.take_list[index].items[from_index] = nil
        g.awh_settings.take_list[index].items[to_index] = from_clsid
    else
        local to_clsid = g.awh_settings.take_list[index].items[to_index]
        g.awh_settings.take_list[index].items[from_index] = to_clsid
        g.awh_settings.take_list[index].items[to_index] = from_clsid
    end
    Another_warehouse_save_settings()
    Another_warehouse_set_items_setting(index, name)
end

function Another_warehouse_set_name_edit(frame, ctrl, name, index)
    local new_name = string.gsub(ctrl:GetText(), "{ol}", "")
    if new_name == "" then
        ui.SysMsg(g.lang == "Japanese" and "文字を入れてください" or "Please enter the text")
        return
    end
    for i, data in ipairs(g.awh_settings.take_list) do
        if new_name == data.name then
            ui.SysMsg(g.lang == "Japanese" and "既に登録済の名前です" or "Name already registered")
            return
        end
    end
    g.awh_settings.take_list[index].name = new_name
    Another_warehouse_save_settings()
    Another_warehouse_set_items_setting(index, new_name)
end

function Another_warehouse_set_item_close(frame)
    ui.DestroyFrame(addon_name_lower .. "awh_set_items")
end

function Another_warehouse_setslot_init(frame, init, name, index)
    local yes_scp = string.format("Another_warehouse_setslot_init_ok('%s',%d)", name, index)
    local msg = g.lang == "Japanese" and "{ol}{#FFFFFF}セット初期化しますか？" or
                    "{ol}{#FFFFFF}Initialize this set?"
    local msgbox = ui.MsgBox(msg, yes_scp, 'None')
end

function Another_warehouse_setslot_init_ok(name, index)
    g.awh_settings.take_list[index] = {
        name = "Take Items " .. index,
        items = {}
    }
    ui.SysMsg(g.lang == "Japanese" and "{ol}初期化しました" or "{ol}Initialized")
    Another_warehouse_save_settings()
    local new_name = "Take Items " .. index
    Another_warehouse_set_items_setting(index, new_name)
end

function Another_warehouse_take_context(frame, ctrl, str, num)
    local context = ui.CreateContextMenu("TAKE_SETTING", "{ol}Take items", 0, 20, 100, 100)
    for i, data in ipairs(g.awh_settings.take_list) do
        local name = data.name
        local scp = string.format("Another_warehouse_set_item_take('%s')", name)
        ui.AddContextMenuItem(context, name, scp)
    end
    ui.OpenContextMenu(context)
end

function Another_warehouse_set_item_take(name)
    local accountwarehouse = ui.GetFrame('accountwarehouse')
    local handle = accountwarehouse:GetUserIValue("HANDLE")
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    session.ResetItemList()
    local sorted_guid_list = item_list:GetSortedGuidList()
    local sorted_cnt = sorted_guid_list:Count()
    local take_count = 0
    local target_items_map = {}
    if g.awh_settings.take_list then
        for i, set_data in ipairs(g.awh_settings.take_list) do
            if set_data.name == name then
                for key, item_id in pairs(set_data.items) do
                    target_items_map[tonumber(item_id)] = true
                end
                break
            end
        end
    end
    for j = 0, sorted_cnt - 1 do
        local guid = sorted_guid_list:Get(j)
        local inv_item = item_list:GetItemByGuid(guid)
        local cls_id = inv_item.type
        if target_items_map[cls_id] then
            local count = inv_item.count
            if g.awh_settings.etc.leave_item == 1 then
                count = count - 1
            end
            if count > 0 then
                session.AddItemID(guid, count)
                take_count = take_count + 1
            end
        end
    end
    if take_count > 0 then
        item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(), handle)
    end
    local awh = ui.GetFrame(addon_name_lower .. "awh")
    local gb = GET_CHILD(awh, "gb")
    AUTO_CAST(gb)
    local index = awh:GetUserIValue("TAB_INDEX")
    Another_warehouse_frame_update(awh, gb, "", index)
end

function Another_warehouse_help()
    local context = ui.CreateContextMenu("awh_help_context", "{ol}[AWH] HELP", 30, 0, 100, 100)
    local msg = g.lang == "Japanese" and "インベントリ:アイコン右クリックで全数搬入" or
                    "Inventory: right mouse click to Carry in all items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "インベントリ:アイコン左クリックで1個搬入" or
              "Inventory: left mouse click to Carry in 1 items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "インベントリ:左SHIFT+アイコン右クリックで入力数量搬入" or
              "Inventory: left SHIFT+mouse right click to Carry in Input quantity items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "インベントリ:左SHIFT+アイコン左クリックで10個搬入" or
              "Inventory: left SHIFT+mouse left click to Carry in 10 items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    ui.AddContextMenuItem(context, "----------", "None")
    msg = g.lang == "Japanese" and "チーム倉庫:アイコン右クリックで全数搬出" or
              "Warehouse: right mouse click to Carry out all items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "チーム倉庫:アイコン左クリックで1個搬出" or
              "Warehouse: left mouse click to Carry out 1 items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "チーム倉庫:左SHIFT+アイコン右クリックで入力数量搬出" or
              "Warehouse: left SHIFT+mouse right click to Carry out Input quantity items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    msg = g.lang == "Japanese" and "チーム倉庫:左SHIFT+アイコン左クリックで10個搬出" or
              "Warehouse: left SHIFT+mouse left click to Carry out 10 items"
    ui.AddContextMenuItem(context, "{ol}" .. msg, "None")
    ui.OpenContextMenu(context)
end
-- another_warehouse ここまで

-- sub_map ここから
function Sub_map_save_settings()
    g.save_json(g.sub_map_path, g.sub_map_settings)
end

function Sub_map_load_settings()
    g.sub_map_path = string.format("../addons/%s/%s/sub_map.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.sub_map_path)
    local ver = 1.1
    if not settings or not settings.ver then
        settings = {
            visible = 1,
            x = 0,
            y = 0,
            skin_name = "None",
            move = 1,
            size = 200,
            minimap = 0,
            challenge_minimap = 0,
            challenge_only = 0,
            loc_name = 0,
            mob_display = 0,
            ver = ver
        }
    end
    g.sub_map_settings = settings
    Sub_map_save_settings()
end

function sub_map_on_init()
    if not g.sub_map_settings then
        Sub_map_load_settings()
    end
    local old_func = g.settings.sub_map.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.sub_map.use == 0 or g.get_map_type() == "Instance" then
        if g.settings.sub_map.use == 0 then
            ui.DestroyFrame(addon_name_lower .. "sub_map")
        end
        return
    end
    if g.get_map_type() == "Instance" then
        return
    end
    g.sub_map_handles = {}
    g.addon:RegisterMsg("MAP_CHARACTER_UPDATE", "Sub_map_MAP_CHARACTER_UPDATE")
    g.addon:RegisterMsg("MON_MINIMAP", "Sub_map_MAP_MON_MINIMAP")
    g.addon:RegisterMsg("MON_MINIMAP_END", "Sub_map_ON_MON_MINIMAP_END")
    g.addon:RegisterMsg("PARTY_INST_UPDATE", "Sub_map_MAP_UPDATE_PARTY_INST")
    g.addon:RegisterMsg("PARTY_UPDATE", "Sub_map_update_party_or_guild")
    g.addon:RegisterMsg("GUILD_INFO_UPDATE", "Sub_map_update_party_or_guild")
    g.addon:RegisterMsg("UI_CHALLENGE_MODE_TOTAL_KILL_COUNT", "Sub_map_ON_CHALLENGE_MODE_TOTAL_KILL_COUNT")
    g.sub_map_challenge_first = true
    g.sub_map_challenge = 0
    if g.get_map_type() == "City" then
        Sub_map_frame_init()
        return
    end
    if string.find(g.map_name, "GuildColony_") then
        g.sub_map_challenge = 1
    else
        local my_info = session.party.GetMyPartyObj(PARTY_NORMAL)
        if not my_info then
            return
        end
        if my_info:GetChannel() + 1 > 10 then
            g.sub_map_challenge = 1
        end
    end
    Sub_map_frame_init()
end

function Sub_map_ON_CHALLENGE_MODE_TOTAL_KILL_COUNT(frame, msg)
    if g.sub_map_challenge_first == true and g.sub_map_challenge == 0 then
        g.sub_map_challenge = 1
        Sub_map_frame_init()
        g.sub_map_challenge_first = false
    end
end

function Sub_map_settings()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local config = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "sub_map_setting_frame", 0, 0, 0, 0)
    AUTO_CAST(config)
    config:RemoveAllChild()
    config:SetLayerLevel(999)
    config:SetSkinName("test_frame_low")
    local title_text = config:CreateOrGetControl("richtext", "title_text", 10, 10)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Sub Map")
    local config_gb = config:CreateOrGetControl("groupbox", "config_gb", 10, 40, 0, 0)
    AUTO_CAST(config_gb)
    config_gb:SetSkinName("bg")
    config:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    local close = config:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_close")
    local y = 10
    local info_text = config_gb:CreateOrGetControl("richtext", "info_text", 10, y + 5, 0, 30)
    AUTO_CAST(info_text)
    info_text:SetText(g.lang == "Japanese" and "{ol}サイズ設定" or "{ol}Size setting")
    local size_edit = config_gb:CreateOrGetControl("edit", "size_edit", info_text:GetWidth() + 20, y, 100, 30)
    AUTO_CAST(size_edit)
    size_edit:SetFontName("white_16_ol")
    size_edit:SetTextAlign("center", "center")
    size_edit:SetNumberMode(1)
    size_edit:SetText("{ol}" .. g.sub_map_settings.size)
    size_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}150~350の間で設定" or "{ol}Setting range: 150 to 350")
    size_edit:SetEventScript(ui.ENTERKEY, "Sub_map_setting_change")
    y = y + 40
    local move_check = config_gb:CreateOrGetControl("checkbox", "move_check", 10, y, 30, 30)
    AUTO_CAST(move_check)
    move_check:SetCheck(g.sub_map_settings.move == 1 and 0 or 1)
    move_check:SetText(g.lang == "Japanese" and "{ol}チェックするとフレーム固定" or
                           "{ol}If checked, the frame is fixed")
    move_check:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local challenge_minimap = config_gb:CreateOrGetControl("checkbox", "challenge_minimap", 10, y, 30, 30)
    AUTO_CAST(challenge_minimap)
    challenge_minimap:SetCheck(g.sub_map_settings.challenge_minimap or 0)
    challenge_minimap:SetText(g.lang == "Japanese" and
                                  "{ol}チェックするとチャレンジでミニマップモード" or
                                  "{ol}If checked, mini-map mode is enabled during the Challenge")
    challenge_minimap:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local challenge_only = config_gb:CreateOrGetControl("checkbox", "challenge_only", 10, y, 30, 30)
    AUTO_CAST(challenge_only)
    challenge_only:SetCheck(g.sub_map_settings.challenge_only or 0)
    challenge_only:SetText(g.lang == "Japanese" and "{ol}チェックするとチャレンジでのみ表示" or
                               "{ol}If checked, display only during Challenges")
    challenge_only:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local loc_name = config_gb:CreateOrGetControl("checkbox", "loc_name", 10, y, 30, 30)
    AUTO_CAST(loc_name)
    loc_name:SetCheck(g.sub_map_settings.loc_name or 0)
    loc_name:SetText(g.lang == "Japanese" and "{ol}チェックすると地域名表示" or
                         "{ol}If checked, display the region name")
    loc_name:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local mob_display = config_gb:CreateOrGetControl("checkbox", "mob_display", 10, y, 30, 30)
    AUTO_CAST(mob_display)
    mob_display:SetCheck(g.sub_map_settings.mob_display or 0)
    mob_display:SetText(g.lang == "Japanese" and "{ol}チェックするとチャレンジで雑魚を表示" or
                            "{ol}If checked, display mobs only during Challenges")
    mob_display:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local default_btn = config_gb:CreateOrGetControl("button", "default_btn", 20, y, 120, 30)
    AUTO_CAST(default_btn)
    default_btn:SetText(g.lang == "Japanese" and "{ol}フレーム初期位置" or "{ol}Init frame pos")
    default_btn:SetEventScript(ui.LBUTTONUP, "Sub_map_setting_change")
    y = y + 40
    local skin_change = config_gb:CreateOrGetControl("button", "skin_change", 20, y, 120, 30)
    AUTO_CAST(skin_change)
    skin_change:SetText(g.lang == "Japanese" and "{ol}フレームスキン変更" or "{ol}Change frame skin")
    skin_change:SetEventScript(ui.LBUTTONUP, "Sub_map_skin_change_context")
    y = y + 30
    config:Resize(challenge_minimap:GetWidth() + 40, y + 60)
    config_gb:Resize(config:GetWidth() - 20, y + 10)
    config:ShowWindow(1)
end

function Sub_map_setting_close(config)
    ui.DestroyFrame(config:GetName())
end

function Sub_map_setting_change(parent, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "size_edit" then
        local size = tonumber(ctrl:GetText())
        if size and size >= 150 and size <= 350 then
            g.sub_map_settings.size = size
        else
            ui.SysMsg(g.lang == "Japanese" and "{ol}範囲外です" or "{ol}Out of range")
            Sub_map_settings()
            return
        end
    elseif ctrl_name == "move_check" then
        local is_check = ctrl:IsChecked()
        g.sub_map_settings.move = is_check == 1 and 0 or 1
    elseif ctrl_name == "default_btn" then
        g.sub_map_settings.x = 0
        g.sub_map_settings.y = 0
    else
        g.sub_map_settings[ctrl_name] = ctrl:IsChecked()
        if ctrl_name == "challenge_only" then
            g.sub_map_settings.visible = ctrl:IsChecked() == 1 and 0 or 1
        end
    end
    Sub_map_save_settings()
    Sub_map_frame_init()
end

function Sub_map_skin_change_context(frame, ctrl)
    local context = ui.CreateContextMenu("sub_map_context", "{ol}Sub Map Change Skin", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "-----", "None")
    ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}無し" or "{ol}None",
        string.format("Sub_map_skin_change('%s')", "None"))
    ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}薄め" or "{ol}Faint",
        string.format("Sub_map_skin_change('%s')", "bg2"))
    ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}濃いめ" or "{ol}Darker",
        string.format("Sub_map_skin_change('%s')", "bg"))
    ui.OpenContextMenu(context)
end

function Sub_map_skin_change(skin_name)
    g.sub_map_settings.skin_name = skin_name
    Sub_map_save_settings()
    Sub_map_frame_init()
end

function Sub_map_frame_init()
    local sub_map = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "sub_map", 0, 0, 0, 0)
    AUTO_CAST(sub_map)
    sub_map:ShowWindow(0)
    local challenge = g.sub_map_challenge
    sub_map:SetUserValue("CHALLENGE", challenge)
    sub_map:RemoveAllChild()
    sub_map:EnableMove(g.sub_map_settings.move)
    sub_map:EnableHittestFrame(1)
    sub_map:SetTitleBarSkin("None")
    sub_map:SetGravity(ui.RIGHT, ui.TOP)
    sub_map:SetMargin(0, 0, 0, 0)
    local use_minimap = (challenge == 1 and g.sub_map_settings.challenge_minimap == 1) or
                            (challenge == 0 and g.sub_map_settings.minimap ~= 0)

    local size = g.sub_map_settings.size
    if use_minimap then
        size = 310
        sub_map:SetSkinName("bg")
        local rect = sub_map:GetMargin()
        sub_map:SetMargin(rect.left - rect.left, rect.top - rect.top + 70,
            rect.right == 0 and rect.right + 35 or rect.right, rect.bottom)
        sub_map:Resize(310, 350)
    else
        sub_map:SetLayerLevel(12)
        local rect = sub_map:GetMargin()
        sub_map:SetMargin(rect.left - rect.left, rect.top - rect.top + 50,
            rect.right == 0 and rect.right + 550 or rect.right, rect.bottom)
        if g.sub_map_settings.x ~= 0 and g.sub_map_settings.y ~= 0 then
            sub_map:SetPos(g.sub_map_settings.x, g.sub_map_settings.y)
        end
    end
    sub_map:SetEventScript(ui.LBUTTONUP, "Sub_map_frame_end_drag")
    local title = sub_map:CreateOrGetControl("richtext", "title", 25, 2)
    AUTO_CAST(title)
    local map_real_name = GetClassByType("Map", g.map_id).Name
    title:SetText("{ol}{S12}" .. map_real_name)
    if challenge == 0 and g.sub_map_settings.challenge_only == 1 then
        g.sub_map_settings.visible = 0
    end
    local display = sub_map:CreateOrGetControl("picture", "display", 5, 3, 15, 15)
    AUTO_CAST(display)
    display:SetEnableStretch(1)
    display:EnableHitTest(1)
    display:SetEventScript(ui.LBUTTONUP, "Sub_map_frame_toggle")
    display:SetTextTooltip("{ol}Display / hide")
    display:ShowWindow(1)
    local gbox_visible = 1
    if not use_minimap then
        if g.sub_map_settings.visible == 1 then
            display:SetImage("btn_minus")
            sub_map:Resize(size + 10, size + 40)
            sub_map:SetSkinName(g.sub_map_settings.skin_name)
            gbox_visible = 1
        else
            display:SetImage("btn_plus")
            sub_map:Resize(size + 10, 40)
            sub_map:SetSkinName("None")
            gbox_visible = 0
        end
    else
        -- display:SetImage("btn_minus") -- ミニマップモードではボタン画像はどうするか要検討
        display:ShowWindow(0)
        gbox_visible = 1
    end
    local gbox = sub_map:CreateOrGetControl("picture", "gbox", size + 10, size + 10, ui.LEFT, ui.BOTTOM, 0, 30, 0, 0)
    AUTO_CAST(gbox)
    gbox:ShowWindow(gbox_visible) -- ★ここで制御
    if not use_minimap then
        gbox:SetEventScript(ui.MOUSEON, "Sub_map_frame_layer_change")
        gbox:SetEventScriptArgString(ui.MOUSEON, "mouse_on")
        gbox:SetEventScript(ui.MOUSEOFF, "Sub_map_frame_layer_change")
        gbox:SetEventScriptArgString(ui.MOUSEOFF, "mouse_off")
    end
    gbox:SetEventScript(ui.LBUTTONDOWN, "Sub_map_frame_map_link")
    gbox:SetEventScript(ui.RBUTTONDOWN, "Sub_map_mini_map")
    gbox:SetTextTooltip(g.lang == "Japanese" and
                            "{ol}LCTRL+右クリック: ミニマップモード 切替{nl}LCTRL+左クリック: マップリンク" or
                            "{ol}LCTRL+Right click: Minimap Mode Toggle{nl}LCTRL+Left click: Map Link")
    local map_pic = gbox:CreateOrGetControl("picture", "map_pic", size, size, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(map_pic)
    map_pic:SetEnableStretch(1)
    map_pic:EnableHitTest(0)
    if g.sub_map_settings.loc_name == 1 then
        local name_group = map_pic:CreateOrGetControl("picture", "name_group", ui.CENTER_HORZ, ui.CENTER_VERT,
            map_pic:GetWidth(), map_pic:GetHeight())
        MAKE_MAP_AREA_INFO(name_group, GetClassByType("Map", g.map_id).ClassName, "{s12}", map_pic:GetWidth(),
            map_pic:GetHeight(), -100, -30)
        AUTO_CAST(name_group)
        name_group:SetSkinName("None")
    end
    local icon_size = use_minimap and g.sub_map_settings.size * 0.08 or size * 0.08
    sub_map:SetUserValue("ICON_SIZE", icon_size)
    local my = gbox:CreateOrGetControl("picture", "my", icon_size * 2, icon_size * 2, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(my)
    my:ShowWindow(0)
    my:SetImage("minimap_leader")
    my:SetEnableStretch(1)
    map_pic:SetImage(g.map_name)
    Sub_map_char_update(sub_map, my, map_pic)
    if challenge == 0 then
        Sub_map_set_warp_point(sub_map, gbox, map_pic, g.map_name, icon_size, map_real_name)
        Sub_map_mapicon_update(sub_map, map_pic)
    end
    if challenge == 0 and g.sub_map_settings.challenge_only == 1 then
        sub_map:ShowWindow(0)
    else
        sub_map:ShowWindow(1)
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local sub_map_timer = _nexus_addons:CreateOrGetControl("timer", "sub_map_timer", 0, 0)
    AUTO_CAST(sub_map_timer)
    sub_map_timer:SetUpdateScript("Sub_map_timer_update")
    sub_map_timer:Start(0.5)
end

--[[function Sub_map_frame_init()
    local sub_map = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "sub_map", 0, 0, 0, 0)
    AUTO_CAST(sub_map)
    sub_map:ShowWindow(0)
    local challenge = g.sub_map_challenge
    sub_map:SetUserValue("CHALLENGE", challenge)
    sub_map:RemoveAllChild()
    sub_map:EnableMove(g.sub_map_settings.move)
    sub_map:EnableHittestFrame(1)
    sub_map:SetTitleBarSkin("None")
    sub_map:SetGravity(ui.RIGHT, ui.TOP)
    sub_map:SetMargin(0, 0, 0, 0)
    local use_minimap = (challenge == 1 and g.sub_map_settings.challenge_minimap == 1) or
                            (challenge == 0 and g.sub_map_settings.minimap ~= 0)
    if use_minimap then
        sub_map:SetSkinName("bg")
        local rect = sub_map:GetMargin()
        sub_map:SetMargin(rect.left - rect.left, rect.top - rect.top + 70,
            rect.right == 0 and rect.right + 35 or rect.right, rect.bottom)
        sub_map:Resize(310, 350)
    else
        sub_map:SetSkinName(g.sub_map_settings.skin_name)
        sub_map:SetLayerLevel(12)
        local rect = sub_map:GetMargin()
        sub_map:SetMargin(rect.left - rect.left, rect.top - rect.top + 50,
            rect.right == 0 and rect.right + 550 or rect.right, rect.bottom)
        if g.sub_map_settings.x ~= 0 and g.sub_map_settings.y ~= 0 then
            sub_map:SetPos(g.sub_map_settings.x, g.sub_map_settings.y)
        end
    end
    sub_map:SetEventScript(ui.LBUTTONUP, "Sub_map_frame_end_drag")
    local title = sub_map:CreateOrGetControl("richtext", "title", 25, 2)
    AUTO_CAST(title)
    local map_real_name = GetClassByType("Map", g.map_id).Name
    title:SetText("{ol}{S12}" .. map_real_name)
    if challenge == 0 and g.sub_map_settings.challenge_only == 1 then
        g.sub_map_settings.visible = 0
    else
        g.sub_map_settings.visible = 1
    end
    local display = sub_map:CreateOrGetControl("picture", "display", 5, 3, 15, 15)
    AUTO_CAST(display)
    display:SetEnableStretch(1)
    display:EnableHitTest(1)
    display:SetEventScript(ui.LBUTTONUP, "Sub_map_frame_toggle")
    display:SetTextTooltip("{ol}Display / hide")
    display:ShowWindow(1)
    if g.sub_map_settings.visible == 1 then
        display:SetImage("btn_minus")
    else
        display:SetImage("btn_plus")
    end
    local size = g.sub_map_settings.size
    local gbox_visible = 1
    if not use_minimap then
        if g.sub_map_settings.visible == 1 then
            sub_map:Resize(size + 10, size + 40)
            sub_map:SetSkinName(g.sub_map_settings.skin_name)
            gbox_visible = 1
        else
            sub_map:Resize(size + 10, 40)
            sub_map:SetSkinName("None")
            gbox_visible = 0
        end
    else
        size = 310
        gbox_visible = 1
    end
    local gbox = sub_map:CreateOrGetControl("picture", "gbox", size + 10, size + 10, ui.LEFT, ui.BOTTOM, 0, 30, 0, 0)
    AUTO_CAST(gbox)
    gbox:ShowWindow(gbox_visible)
    if not use_minimap then
        gbox:SetEventScript(ui.MOUSEON, "Sub_map_frame_layer_change")
        gbox:SetEventScriptArgString(ui.MOUSEON, "mouse_on")
        gbox:SetEventScript(ui.MOUSEOFF, "Sub_map_frame_layer_change")
        gbox:SetEventScriptArgString(ui.MOUSEOFF, "mouse_off")
    end
    gbox:SetEventScript(ui.LBUTTONDOWN, "Sub_map_frame_map_link")
    gbox:SetEventScript(ui.RBUTTONDOWN, "Sub_map_mini_map")
    gbox:SetTextTooltip(g.lang == "Japanese" and
                            "{ol}LCTRL+右クリック: ミニマップモード 切替{nl}LCTRL+左クリック: マップリンク" or
                            "{ol}LCTRL+Right click: Minimap Mode Toggle{nl}LCTRL+Left click: Map Link")
    local map_pic = gbox:CreateOrGetControl("picture", "map_pic", size, size, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(map_pic)
    map_pic:SetEnableStretch(1)
    map_pic:EnableHitTest(0)
    if g.sub_map_settings.loc_name == 1 then
        local name_group = map_pic:CreateOrGetControl("picture", "name_group", ui.CENTER_HORZ, ui.CENTER_VERT,
            map_pic:GetWidth(), map_pic:GetHeight())
        MAKE_MAP_AREA_INFO(name_group, GetClassByType("Map", g.map_id).ClassName, "{s12}", map_pic:GetWidth(),
            map_pic:GetHeight(), -100, -30)
        AUTO_CAST(name_group)
        name_group:SetSkinName("None")
    end
    local icon_size = use_minimap and g.sub_map_settings.size * 0.08 or size * 0.08
    sub_map:SetUserValue("ICON_SIZE", icon_size)
    local my = gbox:CreateOrGetControl("picture", "my", icon_size * 2, icon_size * 2, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(my)
    my:ShowWindow(0)
    my:SetImage("minimap_leader")
    my:SetEnableStretch(1)
    map_pic:SetImage(g.map_name)
    Sub_map_char_update(sub_map, my, map_pic)
    if challenge == 0 then
        Sub_map_set_warp_point(sub_map, gbox, map_pic, g.map_name, icon_size, map_real_name)
        Sub_map_mapicon_update(sub_map, map_pic)
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local sub_map_timer = _nexus_addons:CreateOrGetControl("timer", "sub_map_timer", 0, 0)
    AUTO_CAST(sub_map_timer)
    sub_map_timer:SetUpdateScript("Sub_map_timer_update")
    sub_map_timer:Start(0.5)
end]]

function Sub_map_frame_end_drag(sub_map)
    g.sub_map_settings.x = sub_map:GetX()
    g.sub_map_settings.y = sub_map:GetY()
    Sub_map_save_settings()
end

function Sub_map_frame_toggle(frame, ctrl)
    if g.sub_map_settings.visible == 1 then
        g.sub_map_settings.visible = 0
    else
        g.sub_map_settings.visible = 1
    end
    Sub_map_save_settings()
    Sub_map_frame_init()
end

function Sub_map_frame_map_link(sub_map, gbox)
    if keyboard.IsKeyPressed("LCTRL") ~= 1 then
        return
    end
    local x, y = GET_LOCAL_MOUSE_POS(gbox)
    local map_prop = geMapTable.GetMapProp(g.map_name)
    local world_pos = map_prop:MinimapPosToWorldPos(x, y, gbox:GetWidth(), gbox:GetHeight())
    LINK_MAP_POS(g.map_name, world_pos.x, world_pos.y)
end

function Sub_map_mini_map(sub_map, gbox)
    if keyboard.IsKeyPressed("LCTRL") ~= 1 then
        return
    end
    if g.sub_map_settings.minimap == 0 then
        g.sub_map_settings.minimap = 1
    else
        g.sub_map_settings.minimap = 0
    end
    Sub_map_save_settings()
    ui.DestroyFrame(addon_name_lower .. "sub_map")
    ReserveScript("Sub_map_frame_init()", 0.1)
end

function Sub_map_frame_layer_change(sub_map, gbox, str)
    if str == "mouse_on" then
        sub_map:SetLayerLevel(999)
    elseif str == "mouse_off" then
        sub_map:SetLayerLevel(12)
    end
end

function Sub_map_char_update(sub_map, my, map_pic)
    local my_handle = session.GetMyHandle()
    local pos = info.GetPositionInMap(my_handle, map_pic:GetWidth(), map_pic:GetHeight())
    my:SetOffset(pos.x - my:GetWidth() / 2, pos.y - my:GetHeight() / 2)
    local map_prop = session.GetCurrentMapProp()
    local angle = info.GetAngle(my_handle) - map_prop.RotateAngle
    my:SetAngle(angle)
    my:ShowWindow(1)
    map_pic:Invalidate()
end

function Sub_map_set_warp_point(sub_map, gbox, map_pic, map_name, icon_size, map_real_name)
    local map_prop = geMapTable.GetMapProp(map_name)
    local mongens = map_prop.mongens
    local count = mongens:Count()
    for i = 0, count - 1 do
        local mon_prop = mongens:Element(i)
        local icon_name = mon_prop:GetMinimapIcon()
        if icon_name == "minimap_portal" or icon_name == "minimap_erosion" then
            local gen_list = mon_prop.GenList
            local gen_count = gen_list:Count()
            for j = 0, gen_count - 1 do
                local dialog = mon_prop:GetDialog()
                local warp_cls = GetClass("Warp", mon_prop:GetDialog())
                if not warp_cls then
                    for match in dialog:gmatch("[a-zA-Z]+_(.*)") do
                        warp_cls = GetClass("Warp", match)
                    end
                end
                if warp_cls then
                    local pos = gen_list:Element(j)
                    local map_pos = map_prop:WorldPosToMinimapPos(pos.x, pos.z, map_pic:GetWidth(), map_pic:GetHeight())
                    local icon = gbox:CreateOrGetControl("picture", "icon_" .. i, icon_size, icon_size, ui.LEFT, ui.TOP,
                        0, 0, 0, 0)
                    AUTO_CAST(icon)
                    icon:SetTextTooltip("{ol}{s10}" .. map_real_name)
                    icon:SetImage(mon_prop:GetMinimapIcon())
                    icon:SetOffset(map_pos.x - icon:GetWidth() / 2, map_pos.y - icon:GetHeight() / 2)
                    icon:SetEnableStretch(1)
                end
            end
        end
    end
    gbox:Invalidate()
end

function Sub_map_timer_update(_nexus_addons, sub_map_timer)
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    AUTO_CAST(sub_map)
    local challenge = sub_map:GetUserIValue("CHALLENGE")
    local use_minimap = (challenge == 1 and g.sub_map_settings.challenge_minimap == 1) or
                            (challenge == 0 and g.sub_map_settings.minimap == 1)
    if use_minimap then
        Sub_map_time_update_(sub_map, sub_map_timer)
        if ui.GetFrame("buffseller_target"):IsVisible() == 1 then
            sub_map:SetLayerLevel(79)
        elseif sub_map:GetLayerLevel() ~= 94 then
            sub_map:SetLayerLevel(94)
        end
    end
    if MAP_USE_FOG(g.map_name) ~= 0 then
        Sub_map_draw_fog(sub_map)
    end
    local challenge = sub_map:GetUserIValue("CHALLENGE")
    if challenge == 1 then
        Sub_map_callenge_pcicon_update(sub_map)
    end
    Sub_map_update_remove_member(sub_map)
end

function Sub_map_time_update_(sub_map, sub_map_timer)
    local server_time = geTime.GetServerSystemTime()
    local hour = server_time.wHour
    local min = server_time.wMinute
    local ampm = "AM"
    local display_hour = hour
    if hour == 0 then
        display_hour = 12
        ampm = "AM"
    elseif hour == 12 then
        display_hour = 12
        ampm = "PM"
    elseif hour > 12 then
        display_hour = hour - 12
        ampm = "PM"
    end
    local display_min = string.format("%02d", min)
    local clock_text = string.format("{ol}{s18}%s %d:%s", ampm, display_hour, display_min)
    local clock = GET_CHILD(sub_map, "clock")
    if not clock then
        clock = sub_map:CreateOrGetControl("richtext", "clock", 0, 0)
        AUTO_CAST(clock)
    end
    clock:SetGravity(ui.RIGHT, ui.BOTTOM)
    clock:SetMargin(0, 0, 10, 5)
    clock:SetText(clock_text)
    local colony_battle_info = ui.GetFrame("colony_battle_info")
    if colony_battle_info:IsVisible() == 1 and g.sub_map_settings.minimap == 1 then
        local colony_clock = GET_CHILD(sub_map, "colony_clock")
        if not colony_clock then
            colony_clock = sub_map:CreateOrGetControl("richtext", "colony_clock", 0, 0)
            AUTO_CAST(clock)
        end
        colony_clock:SetGravity(ui.LEFT, ui.BOTTOM)
        colony_clock:SetMargin(0, 0, 0, 5)
        local colony_end_time = session.colonywar.GetEndTime()
        local remain_time = -1 * imcTime.GetDiffSecFromNow(colony_end_time.wHour, colony_end_time.wMinute, 0)
        if remain_time <= 0 then
            sub_map:RemoveChild("colony_clock")
            return
        end
        local remain_min = math.floor(remain_time / 60)
        local remain_sec = remain_time % 60
        local remain_time_str = string.format("{ol}{s18}" .. ClMsg("RemainTime") .. " %d:%02d", remain_min, remain_sec)
        colony_clock:SetText(remain_time_str)
    end
end

function Sub_map_draw_fog(sub_map)
    local map_pic = GET_CHILD_RECURSIVELY(sub_map, "map_pic")
    AUTO_CAST(map_pic)
    HIDE_CHILD_BYNAME(map_pic, "sub_map_fog_")
    local map_frame = ui.GetFrame("map")
    local map = GET_CHILD(map_frame, "map")
    AUTO_CAST(map)
    local map_zoom = math.abs(tonumber(map_pic:GetWidth()) / tonumber(map:GetWidth()))
    local list = session.GetMapFogList(g.map_name)
    local cnt = list:Count()
    for i = 0, cnt - 1 do
        local tile = list:PtrAt(i)
        if tile.revealed == 0 then
            local name = string.format("sub_map_fog_%d", i)
            local tile_X = (tile.x * map_zoom)
            local tile_Y = (tile.y * map_zoom)
            local tile_width = math.ceil(tile.w * map_zoom)
            local tile_height = math.ceil(tile.h * map_zoom)
            local pic = map_pic:CreateOrGetControl("picture", name, tile_X, tile_Y, tile_width, tile_height)
            AUTO_CAST(pic)
            pic:SetImage("fullred")
            pic:SetEnableStretch(1)
            pic:SetAlpha(40)
            pic:EnableHitTest(0)
            pic:ShowWindow(1)
        end
    end
    sub_map:Invalidate()
end

function Sub_map_callenge_pcicon_update(sub_map)
    local gbox = GET_CHILD(sub_map, "gbox")
    local names = {}
    for i = 0, gbox:GetChildCount() - 1 do
        local child = gbox:GetChildByIndex(i)
        if child and child:GetName() ~= "map_pic" and child:GetName() ~= "my" then
            local aid = tonumber(child:GetName())
            if aid then
                gbox:RemoveChild(child:GetName())
            end
            names[child:GetName()] = true
        end
    end
    local map_pic = GET_CHILD(gbox, "map_pic")
    local mapprop = session.GetCurrentMapProp()
    local party_list = session.party.GetPartyMemberList(PARTY_NORMAL)
    local party_count = party_list:Count()
    local my_info = session.party.GetMyPartyObj(PARTY_NORMAL)
    local my_handle = session.GetMyHandle()
    local icon_size = sub_map:GetUserIValue("ICON_SIZE")
    local selected_objects, selected_objects_count = SelectObject(GetMyPCObject(), 5000, "ALL")
    local icon_img_160063 = GetClassByType("Item", 870004).Icon
    local icon_img_160055 = GetClassByType("Item", 664039).Icon
    for i = 1, selected_objects_count do
        local handle = GetHandle(selected_objects[i])
        if not g.sub_map_handles[tostring(handle)] then
            local actor = world.GetActor(handle)
            if handle and actor then
                local clsid = actor:GetType()
                local mon_cls = GetClassByType("Monster", clsid)
                if clsid == 160063 or clsid == 160055 then
                    local icon_name = "mon_" .. handle
                    names[icon_name] = false
                    local world_pos = actor:GetPos()
                    local pos = mapprop:WorldPosToMinimapPos(world_pos, map_pic:GetWidth(), map_pic:GetHeight())
                    local x = (pos.x - icon_size / 4)
                    local y = (pos.y - icon_size / 4)
                    local icon = gbox:CreateOrGetControl("picture", icon_name, icon_size * 0.5, icon_size * 0.5,
                        ui.LEFT, ui.TOP, 0, 0, 0, 0)
                    AUTO_CAST(icon)
                    icon:SetPos(x, y)
                    if clsid == 160063 then
                        icon:SetImage(icon_img_160063)
                    elseif clsid == 160055 then
                        icon:SetImage(icon_img_160055)
                    end
                    icon:SetEnableStretch(1)
                    icon:ShowWindow(1)
                end
                if my_handle ~= handle and info.IsPC(handle) == 1 then
                    for j = 0, party_count - 1 do
                        local pc_info = party_list:Element(j)
                        local name = pc_info:GetName()
                        local apc = actor:GetPCApc()
                        if apc then
                            local actor_name = apc:GetFamilyName()
                            if my_info ~= pc_info and name == actor_name then
                                names[name] = false -- 削除対象から除外
                                local inst_info = pc_info:GetInst()
                                local world_pos = actor:GetPos()
                                local hp = inst_info.hp
                                local pc_icon = GET_CHILD(gbox, name)
                                if not pc_icon then
                                    pc_icon = gbox:CreateOrGetControl("picture", name, 0, 0, icon_size * 1.25,
                                        icon_size * 1.25)
                                end
                                AUTO_CAST(pc_icon)
                                pc_icon:SetTextTooltip("{ol}{s10}" .. name)
                                pc_icon:SetEnableStretch(1)
                                local pos = mapprop:WorldPosToMinimapPos(world_pos, map_pic:GetWidth(),
                                    map_pic:GetHeight())
                                local x = (pos.x - icon_size * 1.25 / 2)
                                local y = (pos.y - icon_size * 1.25 / 2)
                                pc_icon:SetPos(x, y)
                                pc_icon:ShowWindow(1)
                                local image_name = "Archer_party"
                                if hp <= 0 then
                                    image_name = "die_party"
                                end
                                pc_icon:SetImage(image_name)
                                break
                            end
                        end
                    end
                end
            end
        end
    end
    for check_name, bool in pairs(names) do
        if bool == true and not string.find(check_name, "_MONPOS_") and not string.find(check_name, "SCR") then
            local icon = GET_CHILD(gbox, check_name)
            if icon then
                gbox:RemoveChild(check_name)
            end
        end
    end
end

function Sub_map_update_remove_member(sub_map)
    local gbox = GET_CHILD(sub_map, "gbox")
    local icons = {}
    for i = 0, gbox:GetChildCount() - 1 do
        local child = gbox:GetChildByIndex(i)
        if child then
            local aid = tonumber(child:GetName())
            if aid then
                icons[aid] = true
            end
        end
    end
    local function process_member_list(party_type)
        local list = session.party.GetPartyMemberList(party_type)
        local my_handle = session.GetMyHandle()
        local my_info = session.party.GetMyPartyObj(party_type)
        if my_info then
            for i = 0, list:Count() - 1 do
                local pc_info = list:Element(i)
                local aid = tonumber(pc_info:GetAID())
                local handle = pc_info:GetHandle()
                if handle ~= my_handle and pc_info:GetMapID() == my_info:GetMapID() and pc_info:GetChannel() ==
                    my_info:GetChannel() then
                    icons[aid] = false
                end
            end
        end
    end
    process_member_list(PARTY_NORMAL)
    process_member_list(PARTY_GUILD)
    for aid, remove in pairs(icons) do
        if remove == true then
            gbox:RemoveChild(tostring(aid))
        end
    end
end

function Sub_map_MAP_CHARACTER_UPDATE()
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    if not sub_map then
        return
    end
    AUTO_CAST(sub_map)
    local my_handle = session.GetMyHandle()
    local map_pic = GET_CHILD_RECURSIVELY(sub_map, "map_pic")
    AUTO_CAST(map_pic)
    local pos = info.GetPositionInMap(my_handle, map_pic:GetWidth(), map_pic:GetHeight())
    local my = GET_CHILD_RECURSIVELY(sub_map, "my")
    AUTO_CAST(my)
    my:ShowWindow(0)
    my:SetOffset(pos.x - my:GetWidth() / 2, pos.y - my:GetHeight() / 2)
    local mapprop = session.GetCurrentMapProp()
    local angle = info.GetAngle(my_handle) - mapprop.RotateAngle
    my:SetAngle(angle)
    my:ShowWindow(1)
    map_pic:Invalidate()
    local challenge = sub_map:GetUserIValue("CHALLENGE")
    if challenge == 0 then
        Sub_map_mapicon_update(sub_map, map_pic)
    end
end

function Sub_map_mapicon_update(sub_map, map_pic)
    local now = imcTime.GetAppTimeMS()
    if g.sub_map_last_update_time then
        if now - g.sub_map_last_update_time < 1000 then
            return
        end
    end
    g.sub_map_last_update_time = now
    local map_tbl = Sub_map_get_mapinfo(sub_map, map_pic)
    local gbox = GET_CHILD(sub_map, "gbox")
    local function split(str, delim)
        local return_data = {}
        for match in string.gmatch(str, "[^" .. delim .. "]+") do
            table.insert(return_data, match)
        end
        return return_data
    end
    local icon_size = sub_map:GetUserIValue("ICON_SIZE")
    for i, data in ipairs(map_tbl) do
        if string.find(data.class_type, "treasure_box") then
            local item_split = split(data.argstr2, ":")
            local item_name = GetClass("Item", item_split[2]).Name
            local icon = GET_CHILD(gbox, "icon_" .. i)
            if not icon then
                icon = gbox:CreateOrGetControl("picture", "icon_" .. i, 0, 0, icon_size, icon_size)
                AUTO_CAST(icon)
                icon:SetOffset(data.map_pos.x - icon:GetWidth() / 2, data.map_pos.y - icon:GetHeight() / 2)
                icon:SetEnableStretch(1)
            end
            icon:SetTextTooltip("{ol}{s10}" .. data.argstr1 .. "{nl}" .. item_name)
            if data.state then
                icon:SetImage("icon_item_box")
            else
                icon:SetText("{ol}{s10}" .. data.argstr1)
                icon:SetImage("compen_btn")
            end
        end
        if string.find(data.class_type, "statue_vakarine") or string.find(data.class_type, "klaipeda_square_statue") or
            string.find(data.class_type, "npc_orsha_goddess") or string.find(data.class_type, "statue_zemina") then
            local icon = GET_CHILD(gbox, "icon_" .. i)
            if not icon then
                icon = gbox:CreateOrGetControl("picture", "icon_" .. i, 0, 0, icon_size, icon_size)
                AUTO_CAST(icon)
                icon:SetOffset(data.map_pos.x - icon:GetWidth() / 2, data.map_pos.y - icon:GetHeight() / 2)
                icon:SetEnableStretch(1)
                icon:SetTextTooltip("{ol}{s10}" .. data.name)
                icon:SetImage(data.icon_name)
            end
            if data.state then
                icon:SetColorTone("FFFFFFFF")
            else
                icon:SetColorTone("FF555555")
            end
        end
    end
    gbox:Invalidate()
end

function Sub_map_get_mapinfo(sub_map, map_pic)
    if not g.map_name or g.map_name == "" or g.map_name == "None" then
        return
    end
    local property = geMapTable.GetMapProp(g.map_name)
    local class_list, class_count = GetClassList("GenType_" .. g.map_name)
    local mongens = property.mongens
    local map_tbl = {}
    local count = mongens:Count()
    for i = 0, count - 1 do
        local mon_prop = mongens:Element(i)
        local ies_data = GetClassByIndexFromList(class_list, i)
        local class_type = ies_data.ClassType
        local state = GetNPCState(g.map_name, ies_data.GenType)
        if not state then
            state = false
        end
        local gen_list = mon_prop.GenList
        local map_pos
        if gen_list:Count() > 0 then
            map_pos = property:WorldPosToMinimapPos(gen_list:Element(0), map_pic:GetWidth(), map_pic:GetHeight())
        end
        local icon_name = mon_prop:GetMinimapIcon()
        if string.find(class_type, "treasure_box") then
            if ies_data.ArgStr1 ~= "None" then
                local data = {
                    class_type = class_type,
                    state = state,
                    map_pos = map_pos,
                    icon_name = icon_name,
                    argstr1 = ies_data.ArgStr1,
                    argstr2 = ies_data.ArgStr2,
                    argstr3 = ies_data.ArgStr3,
                    name = ies_data.Name
                }
                table.insert(map_tbl, data)
            end
        elseif string.find(class_type, "statue_zemina") or string.find(class_type, "statue_vakarine") or
            string.find(class_type, "klaipeda_square_statue") or string.find(class_type, "npc_orsha_goddess") then
            local data = {
                class_type = class_type,
                state = state,
                map_pos = map_pos,
                icon_name = icon_name,
                argstr1 = ies_data.ArgStr1,
                argstr2 = ies_data.ArgStr2,
                argstr3 = ies_data.ArgStr3,
                name = ies_data.Name
            }
            table.insert(map_tbl, data)
        end
    end
    return map_tbl
end

function Sub_map_MAP_MON_MINIMAP(frame, msg, str, num, info)
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    if not sub_map then
        return
    end
    AUTO_CAST(sub_map)
    local gbox = GET_CHILD(sub_map, "gbox")
    local handle = info.handle
    g.sub_map_handles = g.sub_map_handles or {}
    if g.sub_map_handles[tostring(handle)] then
        return
    end
    local mon_cls = GetClassByType("Monster", info.type)
    if not mon_cls then
        return
    end
    local mon_rank = TryGetProp(mon_cls, "MonRank", "None")
    local is_boss = (mon_rank == "Boss")
    local is_mob_display = (g.sub_map_settings.mob_display == 1)
    if not is_boss and not is_mob_display then
        return
    end
    local base_size = sub_map:GetUserIValue("ICON_SIZE")
    local icon_w, icon_h
    if is_boss then
        if is_mob_display then
            icon_w, icon_h = base_size * 1.5, base_size * 1.5
        else
            icon_w, icon_h = base_size, base_size
        end
    else
        icon_w, icon_h = base_size / 3, base_size / 3
    end
    g.sub_map_handles[tostring(handle)] = true
    local mon_pic = gbox:CreateOrGetControl("picture", "_MONPOS_" .. handle, 0, 0, icon_w, icon_h)
    AUTO_CAST(mon_pic)
    mon_pic:SetUserValue("HANDLE", handle)
    if mon_cls.MinimapIcon ~= "None" then
        mon_pic:SetImage(mon_cls.MinimapIcon)
    else
        mon_pic:SetImage("fullwhite")
        mon_pic:SetColorTone("FFFF4500")
    end
    mon_pic:SetEnableStretch(1)
    local map_pic = GET_CHILD_RECURSIVELY(sub_map, "map_pic")
    AUTO_CAST(map_pic)
    if map_pic then
        local map_prop = session.GetCurrentMapProp()
        local pos = map_prop:WorldPosToMinimapPos(info.x, info.z, map_pic:GetWidth(), map_pic:GetHeight())
        mon_pic:SetOffset(pos.x - icon_w / 2, pos.y - icon_h / 2)
    end
    mon_pic:ShowWindow(1)
    if not mon_pic:HaveUpdateScript("Sub_map_monpic_auto_update") then
        mon_pic:RunUpdateScript("Sub_map_monpic_auto_update", 0.5)
    end
end

function Sub_map_monpic_auto_update(mon_pic)
    local sub_map = mon_pic:GetTopParentFrame()
    local gbox = GET_CHILD(sub_map, "gbox")
    local handle = mon_pic:GetUserIValue("HANDLE")
    local actor = world.GetActor(handle)
    if actor then
        local map_prop = session.GetCurrentMapProp()
        local map_pic = GET_CHILD_RECURSIVELY(sub_map, "map_pic")
        AUTO_CAST(map_pic)
        local actor_pos = actor:GetPos()
        local mon_cls = GetClassByType("Monster", actor:GetType())
        if mon_cls then
            local pos = map_prop:WorldPosToMinimapPos(actor_pos, map_pic:GetWidth(), map_pic:GetHeight())
            local x = pos.x - mon_pic:GetWidth() / 2
            local y = pos.y - mon_pic:GetHeight() / 2
            mon_pic:SetOffset(x, y)
        end
    end
    return 1
end

function Sub_map_ON_MON_MINIMAP_END(frame, msg, str, handle)
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    if not sub_map then
        return
    end
    AUTO_CAST(sub_map)
    local gbox = GET_CHILD(sub_map, "gbox")
    local mon_pic = GET_CHILD(gbox, "_MONPOS_" .. handle)
    if mon_pic then
        if g.sub_map_handles then
            g.sub_map_handles[tostring(handle)] = nil
        end
        gbox:RemoveChild("_MONPOS_" .. handle)
        gbox:Invalidate()
    end
end

function Sub_map_MAP_UPDATE_PARTY_INST(frame, msg, str, party_type)
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    if not sub_map then
        return
    end
    AUTO_CAST(sub_map)
    local gbox = GET_CHILD(sub_map, "gbox")
    local map_prop = session.GetCurrentMapProp()
    local my_info = session.party.GetMyPartyObj(party_type)
    local list = session.party.GetPartyMemberList(party_type)
    local count = list:Count()
    for i = 0, count - 1 do
        local pc_info = list:Element(i)
        if my_info ~= pc_info then
            local aid = pc_info:GetAID()
            local pc_icon = GET_CHILD(gbox, aid)
            if pc_icon then
                local inst_info = pc_info:GetInst()
                Sub_map_SET_MINIMAP_ICON(pc_icon, inst_info.hp, aid)
                Sub_map_SET_MAPPOS(sub_map, pc_icon, inst_info, map_prop)
            end
        end
    end
end

function Sub_map_SET_MINIMAP_ICON(pc_icon, hp, aid)
    local image_name = "die_party"
    if hp > 0 then
        if session.party.GetPartyMemberInfoByAID(PARTY_NORMAL, aid) then
            image_name = "Archer_party"
        elseif session.party.GetPartyMemberInfoByAID(PARTY_GUILD, aid) then
            image_name = "Wizard_party"
        end
    end
    pc_icon:SetImage(image_name)
end

function Sub_map_SET_MAPPOS(sub_map, pc_icon, inst_info, map_prop, info)
    local world_pos = inst_info:GetPos()
    local map_pic = GET_CHILD_RECURSIVELY(sub_map, "map_pic")
    local pos
    if info then
        pos = map_prop:WorldPosToMinimapPos(info.x, info.z, map_pic:GetWidth(), map_pic:GetHeight())
    else
        pos = map_prop:WorldPosToMinimapPos(world_pos, map_pic:GetWidth(), map_pic:GetHeight())
    end
    local icon_size = sub_map:GetUserIValue("ICON_SIZE")
    local x = (pos.x - icon_size / 2)
    local y = (pos.y - icon_size / 2)
    pc_icon:SetPos(x, y)
end

function Sub_map_update_party_or_guild(frame, msg, arg, num, info)
    local sub_map = ui.GetFrame(addon_name_lower .. "sub_map")
    if not sub_map then
        return
    end
    AUTO_CAST(sub_map)
    local party_type = 0
    if msg == "GUILD_INFO_UPDATE" then
        party_type = 1
    end
    local list = session.party.GetPartyMemberList(party_type)
    local count = list:Count()
    if count == 1 then
        return
    end
    local my_info = session.party.GetMyPartyObj(party_type)
    if not my_info then
        return
    end
    local map_prop = session.GetCurrentMapProp()
    for i = 0, count - 1 do
        local pc_info = list:Element(i)
        if my_info ~= pc_info and my_info:GetMapID() == pc_info:GetMapID() and my_info:GetChannel() ==
            pc_info:GetChannel() then
            Sub_map_CREATE_PICTURE(sub_map, pc_info, party_type, map_prop, info)
        end
    end
end

function Sub_map_CREATE_PICTURE(sub_map, pc_info, party_type, mapprop, info)
    local aid = pc_info:GetAID()
    local gbox = GET_CHILD(sub_map, "gbox")
    local pc_icon = GET_CHILD(gbox, aid)
    if not pc_icon then
        local icon_size = sub_map:GetUserIValue("ICON_SIZE")
        pc_icon = gbox:CreateOrGetControl("picture", aid, 0, 0, icon_size, icon_size)
        AUTO_CAST(pc_icon)
    end
    pc_icon:SetEnableStretch(1)
    pc_icon:SetTooltipType("partymap")
    local name = ""
    if type(_G["NATIVE_LANG_ON_INIT"]) == "function" then
        local ntr = _G["ADDONS"]["norisan"]["NATIVE_LANG"]
        name = ntr.names[pc_info:GetName()] or pc_info:GetName() -- {#FF0000}★
        name = string.gsub(name, "{#FF0000}★", "")
        name = string.gsub(name, "{/}", "")
    end
    local inst_info = pc_info:GetInst()
    if pc_info:GetName() ~= name then
        local tool_msg = "{ol}" .. name .. "(" .. ClMsg("Level") .. pc_info:GetLevel() .. "){nl}" .. "HP : (" ..
                             inst_info.hp .. "/" .. inst_info.maxhp .. "){nl}" .. "SP : (" .. inst_info.sp .. "/" ..
                             inst_info.maxsp .. ")"
        pc_icon:SetTextTooltip(tool_msg)
        -- pc_icon:SetTooltipArg(pc_info:GetName(), party_type)
    else
        pc_icon:SetTooltipArg(pc_info:GetName(), party_type)
    end
    pc_icon:ShowWindow(1)
    Sub_map_SET_MINIMAP_ICON(pc_icon, inst_info.hp, aid)
    Sub_map_SET_MAPPOS(sub_map, pc_icon, inst_info, mapprop, info)
end
-- sub_map ここまで

-- Battle_ritual ここから
function Battle_ritual_save_settings()
    g.save_json(g.battle_ritual_path, g.battle_ritual_settings)
end

function Battle_ritual_load_settings()
    g.battle_ritual_path = string.format("../addons/%s/%s/battle_ritual.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.battle_ritual_path)
    if not settings then
        settings = {
            skills = {},
            etc = {
                x = 0,
                y = 0,
                move = 0,
                use = 0
            }
        }
    end
    g.battle_ritual_settings = settings
    Battle_ritual_save_settings()
end

function battle_ritual_on_init()
    if not g.battle_ritual_settings then
        Battle_ritual_load_settings()
    end
    if g.settings.battle_ritual.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "Battle_ritual")
        return
    end
    Battle_ritual_frame_init()
    if g.get_map_type() == "Instance" or g.map_id == 11244 or g.map_id == 8022 then -- 11244 聖域3F 11227 分裂 8022 ヴェルニケ
        g.addon:RegisterMsg('REQ_PLAYER_CONTENTS_RECORD', 'Battle_ritual_REQ_PLAYER_CONTENTS_RECORD')
        Battle_ritual_auto_buff_skill_start()
    end
end

function Battle_ritual_auto_buff_skill_start()
    -- pcallでラップしてエラー落ちを防ぎつつログを出す
    local status, err = pcall(function()
        if g.battle_ritual_settings.etc.use == 0 then
            return
        end

        local _nexus_addons = ui.GetFrame("_nexus_addons")
        local list = session.party.GetPartyMemberList(PARTY_NORMAL)
        if list:Count() > 1 then
            _nexus_addons:StopUpdateScript("Battle_ritual_auto_buff_skill")
            return
        end
        local skills_table = g.battle_ritual_settings.skills
        if not skills_table then
            return
        end
        local sorted_list = {}
        for s_id, data in pairs(skills_table) do
            table.insert(sorted_list, {
                skill_id = tonumber(s_id),
                buff_id = data.buff_id,
                priority = data.priority
            })
        end
        table.sort(sorted_list, function(a, b)
            if a.priority ~= b.priority then
                return a.priority < b.priority
            else
                return tonumber(a.skill_id) < tonumber(b.skill_id)
            end
        end)
        local skill_map = {}
        for i = 0, 40 - 1 do
            local quick_slot_info = quickslot.GetInfoByIndex(i)
            if quick_slot_info and quick_slot_info.category == 'Skill' then
                skill_map[quick_slot_info.type] = i
            end
        end
        g.battle_ritual_use_queue = {}
        local my_handle = session.GetMyHandle()
        local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
        for _, data in ipairs(sorted_list) do
            local skill_id = data.skill_id
            local slot_index = skill_map[skill_id]
            if slot_index then
                local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. (slot_index + 1), "ui::CSlot")
                if slot then
                    local icon = slot:GetIcon()
                    if icon then
                        local cur_time = ICON_UPDATE_SKILL_COOLDOWN(icon)
                        if cur_time == 0 then
                            local buff_id = data.buff_id
                            local need_buff = true
                            if buff_id > 0 then
                                if info.GetBuff(my_handle, buff_id) then
                                    need_buff = false
                                end
                            end
                            if need_buff then
                                table.insert(g.battle_ritual_use_queue, {
                                    buff_id = buff_id,
                                    skill_id = skill_id,
                                    icon = icon
                                })
                            end
                        end
                    end
                end
            end
        end
        if #g.battle_ritual_use_queue > 0 then
            _nexus_addons:RunUpdateScript("Battle_ritual_auto_buff_skill", 0.1)
        end
    end)
end

function Battle_ritual_auto_buff_skill(_nexus_addons)
    local status, result = pcall(function()
        if not g.battle_ritual_use_queue or #g.battle_ritual_use_queue == 0 then
            return 0
        end
        local next_skill_info = g.battle_ritual_use_queue[1]
        if not next_skill_info or not next_skill_info.icon then
            table.remove(g.battle_ritual_use_queue, 1)
            return 1
        end
        local my_handle = session.GetMyHandle()
        local buff_info = nil
        if next_skill_info.buff_id and next_skill_info.buff_id > 0 then
            buff_info = info.GetBuff(my_handle, next_skill_info.buff_id)
        end
        local current_cooldown = ICON_UPDATE_SKILL_COOLDOWN(next_skill_info.icon)
        if current_cooldown == 0 and (next_skill_info.buff_id == 0 or not buff_info) then
            ICON_USE(next_skill_info.icon)
            if not session.GetSkill(next_skill_info.skill_id) then
                table.remove(g.battle_ritual_use_queue, 1)
            end
            local changed_image = QUICKSLOT_CHANGE_ICON_LIST[tostring(next_skill_info.skill_id)]
            if changed_image then
                table.remove(g.battle_ritual_use_queue, 1)
            end
            return 1
        end
        if #g.battle_ritual_use_queue > 0 then
            table.remove(g.battle_ritual_use_queue, 1)
            return 1
        else
            return 0
        end
    end)
    if not status then
        return 0 -- エラー時は停止
    end
    return result
end

--[[function Battle_ritual_auto_buff_skill_start()
    if g.battle_ritual_settings.etc.use == 0 then
        return
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local list = session.party.GetPartyMemberList(PARTY_NORMAL)
    if list:Count() > 1 then
        _nexus_addons:StopUpdateScript("Battle_ritual_auto_buff_skill")
        return
    end
    local skills_table = g.battle_ritual_settings.skills
    if not skills_table then
        return
    end
    local sorted_list = {}
    for s_id, data in pairs(skills_table) do
        table.insert(sorted_list, {
            skill_id = tonumber(s_id),
            buff_id = data.buff_id,
            priority = data.priority
        })
    end
    table.sort(sorted_list, function(a, b)
        if a.priority ~= b.priority then
            return a.priority < b.priority
        else
            return tonumber(a.skill_id) < tonumber(b.skill_id)
        end
    end)
    local skill_map = {}
    for i = 0, 40 - 1 do
        local quick_slot_info = quickslot.GetInfoByIndex(i)
        if quick_slot_info and quick_slot_info.category == 'Skill' then
            skill_map[quick_slot_info.type] = i
        end
    end
    g.battle_ritual_use_queue = {}
    local my_handle = session.GetMyHandle()
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    for _, data in ipairs(sorted_list) do
        local skill_id = data.skill_id
        local slot_index = skill_map[skill_id]
        if slot_index then
            local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. (slot_index + 1), "ui::CSlot")
            if slot then
                local icon = slot:GetIcon()
                if icon then
                    local cur_time = ICON_UPDATE_SKILL_COOLDOWN(icon)
                    if cur_time == 0 then
                        local buff_id = data.buff_id
                        local need_buff = true
                        if buff_id > 0 then
                            if info.GetBuff(my_handle, buff_id) then
                                need_buff = false
                            end
                        end
                        if need_buff then
                            table.insert(g.battle_ritual_use_queue, {
                                buff_id = buff_id,
                                skill_id = skill_id,
                                icon = icon
                            })
                        end
                    end
                end
            end
        end
    end
    if #g.battle_ritual_use_queue > 0 then
        _nexus_addons:RunUpdateScript("Battle_ritual_auto_buff_skill", 0.1)
    end
end

function Battle_ritual_auto_buff_skill(_nexus_addons)
    if not g.battle_ritual_use_queue or #g.battle_ritual_use_queue == 0 then
        return 0
    end
    local next_skill_info = g.battle_ritual_use_queue[1]
    if not next_skill_info or not next_skill_info.icon then
        table.remove(g.battle_ritual_use_queue, 1)
        return 1
    end
    local my_handle = session.GetMyHandle()
    local buff_info = nil
    if next_skill_info.buff_id and next_skill_info.buff_id > 0 then
        buff_info = info.GetBuff(my_handle, next_skill_info.buff_id)
    end
    local current_cooldown = ICON_UPDATE_SKILL_COOLDOWN(next_skill_info.icon)
    if current_cooldown == 0 and (next_skill_info.buff_id == 0 or not buff_info) then
        ICON_USE(next_skill_info.icon)
        local changed_image = QUICKSLOT_CHANGE_ICON_LIST[tostring(next_skill_info.skill_id)]
        if changed_image then
            table.remove(g.battle_ritual_use_queue, 1)
        end
        return 1
    end
    if #g.battle_ritual_use_queue > 0 then
        table.remove(g.battle_ritual_use_queue, 1)
        return 1
    else
        return 0
    end
end]]

function Battle_ritual_frame_init()
    local Battle_ritual = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "Battle_ritual", 0, 0, 0, 0)
    AUTO_CAST(Battle_ritual)
    Battle_ritual:SetSkinName("None")
    Battle_ritual:SetTitleBarSkin("None")
    Battle_ritual:Resize(40, 30)
    Battle_ritual:SetGravity(ui.RIGHT, ui.TOP)
    Battle_ritual:EnableMove(g.battle_ritual_settings.etc.move == 1 and 0 or 1)
    Battle_ritual:EnableHittestFrame(1)
    local rect = Battle_ritual:GetMargin()
    Battle_ritual:SetMargin(rect.left - rect.left, rect.top - rect.top + 2,
        rect.right == 0 and rect.right + 305 or rect.right, rect.bottom)
    if g.battle_ritual_settings.etc.x ~= 0 and g.battle_ritual_settings.etc.y ~= 0 then
        Battle_ritual:SetPos(g.battle_ritual_settings.etc.x, g.battle_ritual_settings.etc.y)
    end
    Battle_ritual:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_location_save")
    local pic = Battle_ritual:CreateOrGetControl("picture", "pic", 0, 0, 30, 30)
    AUTO_CAST(pic)
    pic:SetImage("emoticon_0015")
    pic:SetColorTone("FFFFFFFF")
    pic:SetEnableStretch(1)
    pic:EnableHitTest(1)
    pic:SetGravity(ui.LEFT, ui.TOP)
    pic:SetTextTooltip(g.lang == "Japanese" and "{ol}Battle Ritual{nl}右クリック ON/OFF" or
                           "{ol}Battle Ritual{nl}Right click ON/OFF")
    if g.battle_ritual_settings.etc.use == 0 then
        pic:SetColorTone("FF555555")
    else
        pic:SetColorTone("FFFFFFFF")
    end
    pic:SetEventScript(ui.RBUTTONUP, "Battle_ritual_onoff_switch")
    Battle_ritual:ShowWindow(1)
end

function Battle_ritual_onoff_switch(Battle_ritual)
    g.battle_ritual_settings.etc.use = 1 - g.battle_ritual_settings.etc.use
    Battle_ritual_save_settings()
    Battle_ritual_frame_init()
end

function Battle_ritual_frame_location_save(Battle_ritual)
    g.battle_ritual_settings.etc.x = Battle_ritual:GetX()
    g.battle_ritual_settings.etc.y = Battle_ritual:GetY()
    Battle_ritual_save_settings()
end

function Battle_ritual_settings_frame()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "Battle_ritual_setting", 0, 0, 0, 0)
    setting:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    setting:SetSkinName("test_frame_low")
    setting:EnableHittestFrame(1)
    setting:EnableHitTest(1)
    setting:SetLayerLevel(999)
    setting:RemoveAllChild()
    local title_text = setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Battle ritual Config")
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_close")
    local gbox = setting:CreateOrGetControl("groupbox", "gbox", 10, 40, setting:GetWidth() - 20,
        setting:GetHeight() - 50) -- 945
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    gbox:EnableScrollBar(1)
    Battle_ritual_settings_frame_child(setting, gbox)
end

function Battle_ritual_settings_frame_child(setting, gbox) -- gbox:EnableScrollBar(0)
    local move_check = gbox:CreateOrGetControl('checkbox', "move_check", 10, 10, 30, 30)
    AUTO_CAST(move_check)
    move_check:SetCheck(g.battle_ritual_settings.etc.move)
    move_check:SetText(g.lang == "Japanese" and "{ol}チェックするとフレーム固定" or
                           "{ol}If checked, the frame is fixed")
    move_check:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_move")
    local default_btn = gbox:CreateOrGetControl("button", "default_btn", move_check:GetWidth() + 30, 10, 120, 30)
    AUTO_CAST(default_btn)
    default_btn:SetText(g.lang == "Japanese" and "{ol}フレーム初期位置" or "{ol}Init frame pos")
    default_btn:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_default")
    local skill_lbl = gbox:CreateOrGetControl('richtext', 'header_skill', 10, 45, 100, 20)
    AUTO_CAST(skill_lbl)
    skill_lbl:SetText(g.lang == "Japanese" and "{ol}スキル" or "{ol}Skill")
    local buff_lbl = gbox:CreateOrGetControl('richtext', 'header_buff', 230, 45, 100, 20)
    AUTO_CAST(buff_lbl)
    buff_lbl:SetText(g.lang == "Japanese" and "{ol}バフ" or "{ol}Buff")
    local priority_lbl = gbox:CreateOrGetControl('richtext', 'header_priority', 450, 45, 100, 20)
    AUTO_CAST(priority_lbl)
    priority_lbl:SetText(g.lang == "Japanese" and "{ol}優先度" or "{ol}Priority")
    local y_pos = 70
    local row_height = 40
    local sorted_skills = {}
    if g.battle_ritual_settings.skills then
        for s_id, data in pairs(g.battle_ritual_settings.skills) do
            table.insert(sorted_skills, {
                skill_id = tonumber(s_id),
                buff_id = data.buff_id or 0,
                priority = data.priority or 0
            })
        end
    end
    table.sort(sorted_skills, function(a, b)
        if a.priority ~= b.priority then
            return a.priority < b.priority
        else
            return a.skill_id < b.skill_id
        end
    end)
    for i, entry in ipairs(sorted_skills) do
        Battle_ritual_create_row(gbox, i, entry.skill_id, entry.buff_id, entry.priority, y_pos)
        y_pos = y_pos + row_height
    end
    Battle_ritual_create_row(gbox, #sorted_skills + 1, 0, 0, 0, y_pos)
end

function Battle_ritual_frame_default(parent)
    ui.DestroyFrame(addon_name_lower .. "Battle_ritual")
    g.battle_ritual_settings.etc.x = 0
    g.battle_ritual_settings.etc.y = 0
    Battle_ritual_save_settings()
    ReserveScript("Battle_ritual_frame_init()", 0.1)
end

function Battle_ritual_frame_move(Battle_ritual, gbox)
    g.battle_ritual_settings.etc.move = 1 - g.battle_ritual_settings.etc.move
    Battle_ritual_save_settings()
    Battle_ritual_frame_init()
end

function Battle_ritual_create_row(gbox, index, skill_id, buff_id, priority, y)
    local skill_add = gbox:CreateOrGetControl("button", "skill_add_" .. index, 10, y, 50, 30)
    AUTO_CAST(skill_add)
    skill_add:SetSkinName("test_cardtext_btn")
    skill_add:SetText("{ol}Add")
    skill_add:SetTextTooltip(g.lang == "Japanese" and "{ol}スキルリスト表示" or "{ol}Display the skill list")
    skill_add:SetEventScript(ui.LBUTTONUP, "Battle_ritual_skill_list_open")
    skill_add:SetEventScriptArgNumber(ui.LBUTTONUP, index)
    local skill_pic = gbox:CreateOrGetControl('picture', "skill_pic_" .. index, 65, y, 30, 30)
    AUTO_CAST(skill_pic)
    local skill_img = ""
    if skill_id > 0 then
        local cls = GetClassByType("Skill", skill_id)
        if cls then
            skill_img = "icon_" .. cls.Icon
        end
    end
    skill_pic:SetImage(skill_img)
    skill_pic:SetEnableStretch(1)
    skill_pic:EnableHitTest(1)
    if skill_id > 0 then
        SET_SKILL_TOOLTIP_BY_TYPE(skill_pic, skill_id)
    end
    local skill_edit = gbox:CreateOrGetControl('edit', 'skill_edit_' .. index, 100, y, 80, 30)
    AUTO_CAST(skill_edit)
    skill_edit:SetNumberMode(1)
    skill_edit:SetFontName("white_16_ol")
    skill_edit:SetText(skill_id == 0 and "" or skill_id)
    skill_edit:SetTextAlign("center", "center")
    skill_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}スキルID入力{nl}錬成スキルは141001～" or
                                  "{ol}Enter the Skill ID.{nl}Alchemic skills start from 141001")
    if skill_edit:GetText() ~= "" then
        skill_edit:SetUserValue("ORIG_SKILL_ID", skill_id)
    end
    skill_edit:SetTypingScp("Battle_ritual_add_skill")
    local skill_remove = gbox:CreateOrGetControl("button", "skill_remove_" .. index, 185, y, 30, 30)
    AUTO_CAST(skill_remove)
    skill_remove:SetSkinName("test_cardtext_btn")
    skill_remove:SetText("{ol}×")
    skill_remove:SetTextTooltip(g.lang == "Japanese" and "{ol}登録解除" or "{ol}unregister")
    skill_remove:SetEventScript(ui.LBUTTONUP, "Battle_ritual_remove")
    skill_remove:SetEventScriptArgString(ui.LBUTTONUP, tostring(skill_id))
    if skill_id > 0 then
        local buff_add = gbox:CreateOrGetControl("button", "buff_add_" .. index, 230, y, 50, 30)
        AUTO_CAST(buff_add)
        buff_add:SetSkinName("test_cardtext_btn")
        buff_add:SetText("{ol}Add")
        buff_add:SetTextTooltip(g.lang == "Japanese" and "{ol}バフリスト表示" or "{ol}Display the buff list")
        buff_add:SetEventScript(ui.LBUTTONUP, "Battle_ritual_buff_list_open")
        buff_add:SetEventScriptArgNumber(ui.LBUTTONUP, skill_id)
        gbox:SetUserValue("INDEX", index)
        local buff_pic = gbox:CreateOrGetControl('picture', "buff_pic_" .. index, 285, y, 30, 30)
        AUTO_CAST(buff_pic)
        local buff_img = ""
        if buff_id > 0 then
            local cls = GetClassByType("Buff", buff_id)
            if cls then
                buff_img = "icon_" .. cls.Icon
            end
        end
        buff_pic:SetImage(buff_img)
        buff_pic:SetEnableStretch(1)
        buff_pic:EnableHitTest(1)
        local buff_edit = gbox:CreateOrGetControl('edit', 'buff_edit_' .. index, 320, y, 80, 30)
        AUTO_CAST(buff_edit)
        buff_edit:SetNumberMode(1)
        buff_edit:SetFontName("white_16_ol")
        buff_edit:SetText(buff_id == 0 and "" or buff_id)
        buff_edit:SetTextAlign("center", "center")
        buff_edit:SetTextTooltip(g.lang == "Japanese" and
                                     "{ol}バフID入力{nl}対応バフが無い場合は 空白{nl}(例)テンペストショットは 空白{nl}ダブルアタックは 322など{nl}※入力無しは毎回掛け直し" or
                                     "{ol}Enter the Buff ID{nl}Leave blank if there is no corresponding buff{nl}(e.g.)Tempest Shot is blank{nl}Double Attack is 322, etc.{nl}※If no input is provided,will be recast every time")
        buff_edit:SetUserValue("SKILL_ID", skill_id)

        buff_edit:SetTypingScp("Battle_ritual_add_buff")
        local buff_remove = gbox:CreateOrGetControl("button", "buff_remove" .. index, 405, y, 30, 30)
        AUTO_CAST(buff_remove)
        buff_remove:SetSkinName("test_cardtext_btn")
        buff_remove:SetText("{ol}×")
        buff_remove:SetTextTooltip(g.lang == "Japanese" and "{ol}登録解除" or "{ol}unregister")
        buff_remove:SetEventScript(ui.LBUTTONUP, "Battle_ritual_remove")
        buff_remove:SetEventScriptArgString(ui.LBUTTONUP, tostring(skill_id))
        local priority_edit = gbox:CreateOrGetControl('edit', 'priority_edit_' .. index, 450, y, 50, 30)
        AUTO_CAST(priority_edit)
        priority_edit:SetNumberMode(1)
        priority_edit:SetFontName("white_16_ol")
        priority_edit:SetText(priority)
        priority_edit:SetTextAlign("center", "center")
        priority_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}優先度入力" or "{ol}Enter Priority")
        priority_edit:SetUserValue("SKILL_ID", skill_id)
        priority_edit:SetTypingScp("Battle_ritual_priority")
    end
    local setting = gbox:GetParent()
    setting:Resize(550, 945)
    gbox:Resize(setting:GetWidth() - 20, 895) -- 945
    setting:ShowWindow(1)
end

function Battle_ritual_priority_change(ctrl)
    local new_priority = tonumber(ctrl:GetText())
    local skill_id_str = ctrl:GetUserValue("SKILL_ID")
    local skills = g.battle_ritual_settings.skills
    if skills and skills[skill_id_str] then
        for s_id, data in pairs(skills) do
            if s_id ~= skill_id_str and data.priority >= new_priority then
                data.priority = data.priority + 1
            end
        end
        skills[skill_id_str].priority = new_priority
    end
    Battle_ritual_save_settings()
    Battle_ritual_settings_frame()
    return 0
end

function Battle_ritual_priority(parent, ctrl)
    local priority = tonumber(ctrl:GetText())
    if priority > 0 then
        ctrl:RunUpdateScript("Battle_ritual_priority_change", 0.5)
    end
end

function Battle_ritual_remove(parent, ctrl, skill_id_str)
    local ctrl_name = ctrl:GetName()
    if string.find(ctrl_name, "skill") then
        g.battle_ritual_settings.skills[skill_id_str] = nil
    else
        g.battle_ritual_settings.skills[skill_id_str].buff_id = 0
    end
    Battle_ritual_save_settings()
    Battle_ritual_settings_frame()
end

function Battle_ritual_skill_list_open(frame, add, ctrl_text, index)
    local skill_list = ui.GetFrame(addon_name_lower .. "Battle_ritual_skill_list")
    if not skill_list then
        skill_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "Battle_ritual_skill_list", 0, 0, 10, 10)
        AUTO_CAST(skill_list)
        skill_list:SetSkinName("test_frame_low")
        skill_list:Resize(500, 1005)
        skill_list:SetPos(720, 30)
        skill_list:SetLayerLevel(999)
        local title_text = skill_list:CreateOrGetControl('richtext', 'title_text', 15, 15, 10, 30)
        AUTO_CAST(title_text)
        title_text:SetText("{#000000}{s20}Skill List")
        local search_edit =
            skill_list:CreateOrGetControl("edit", "search_edit", title_text:GetWidth() + 30, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Battle_ritual_skill_list_search")
        search_edit:SetEventScriptArgNumber(ui.ENTERKEY, index)
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Battle_ritual_skill_list_search")
        local close_button = skill_list:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
        AUTO_CAST(close_button)
        close_button:SetImage("testclose_button")
        close_button:SetGravity(ui.RIGHT, ui.TOP)
        close_button:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_close")
    end
    local skill_gb = skill_list:CreateOrGetControl("groupbox", "skill_gb", 10, 50, 480, skill_list:GetHeight() - 60)
    AUTO_CAST(skill_gb)
    skill_gb:SetSkinName("bg")
    skill_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Skill")
    local y = 0
    for i = 0, count - 1 do
        local skill_cls = GetClassByIndexFromList(cls_list, i)
        if skill_cls then
            local skill_id = skill_cls.ClassID
            local skill_cls_name = skill_cls.ClassName
            local skill_engname = skill_cls.EngName
            local skill_caption = skill_cls.Caption
            local skill_name = dictionary.ReplaceDicIDInCompStr(skill_cls.Name)
            if ctrl_text == "" or (ctrl_text ~= "" and string.find(skill_name, ctrl_text)) then
                local skill_slot = skill_gb:CreateOrGetControl('slot', 'skill_slot' .. i, 10, y + 5, 30, 30)
                AUTO_CAST(skill_slot)
                local image_name = "icon_" .. skill_cls.Icon
                if skill_id > 10000 then
                    if not string.find(skill_cls_name, "^Mon_") and not string.find(skill_engname, "plzInputEngName") and
                        not string.find(skill_name, "_") and not string.find(skill_name, "TEST") then
                        if ctrl_text == "" or (ctrl_text ~= "" and string.find(skill_name, ctrl_text)) then
                            SET_SLOT_IMG(skill_slot, image_name)
                            local icon = CreateIcon(skill_slot)
                            AUTO_CAST(icon)
                            SET_SKILL_TOOLTIP_BY_TYPE(icon, skill_id)
                            local skill_set = skill_gb:CreateOrGetControl('button', 'skill_set' .. skill_id, 45, y + 5,
                                40, 30)
                            AUTO_CAST(skill_set)
                            skill_set:SetText("{ol}Add")
                            skill_set:SetSkinName("test_cardtext_btn")
                            skill_set:SetTextTooltip(g.lang == "Japanese" and "{ol}スキル追加" or "{ol}Add Skill")
                            skill_set:SetEventScript(ui.LBUTTONUP, "Battle_ritual_add_skill")
                            skill_set:SetEventScriptArgString(ui.LBUTTONUP, skill_id)
                            skill_set:SetEventScriptArgNumber(ui.LBUTTONUP, index)
                            local skill_text = skill_gb:CreateOrGetControl('richtext', 'skill_text' .. skill_id, 90,
                                y + 10, 200, 30)
                            AUTO_CAST(skill_text)
                            skill_text:SetText("{ol}" .. skill_id .. " : " .. skill_name)
                            skill_text:AdjustFontSizeByWidth(380)
                            y = y + 35
                        end
                    end
                end
            end
        end

    end
    skill_list:ShowWindow(1)
end

function Battle_ritual_skill_list_search(frame, ctrl, str, index)
    local search_edit = GET_CHILD_RECURSIVELY(frame, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Battle_ritual_skill_list_open(frame, ctrl, ctrl_text, index)
    else
        Battle_ritual_skill_list_open(frame, ctrl, "", index)
    end
end

function Battle_ritual_add_skill(parent, ctrl, skill_id_str, index)
    local ctrl_name = ctrl:GetName()
    if string.find(ctrl_name, "skill_edit_") then
        ctrl:RunUpdateScript("Battle_ritual_setting_change_skill_edit", 0.5)
    else
        local setting = ui.GetFrame(addon_name_lower .. "Battle_ritual_setting")
        local skill_edit = GET_CHILD_RECURSIVELY(setting, "skill_edit_" .. index)
        skill_edit:SetText(skill_id_str)
        ctrl:SetUserValue("SKILL_ID", skill_id_str)
        Battle_ritual_setting_change_skill_edit(ctrl)
    end
end

function Battle_ritual_setting_change_skill_edit(ctrl)
    local user_val = ctrl:GetUserValue("SKILL_ID")
    local new_id_str = (user_val == "None" or user_val == "") and ctrl:GetText() or user_val
    local orig_id_str = ctrl:GetUserValue("ORIG_SKILL_ID")
    local skills = g.battle_ritual_settings.skills
    local new_skill_cls = GetClassByType("Skill", tonumber(new_id_str))
    if not new_skill_cls then
        if skills[orig_id_str] then
            skills[orig_id_str] = nil
            Battle_ritual_save_settings()
        end
        Battle_ritual_settings_frame()
        return 0
    end
    if not skills[new_id_str] then
        local new_data = {
            priority = 0,
            buff_id = 0
        }
        local old_data = skills[orig_id_str]
        if old_data then
            new_data.priority = old_data.priority
            skills[orig_id_str] = nil
        else
            local max_priority = 0
            for _, data in pairs(skills) do
                if data.priority and data.priority > max_priority then
                    max_priority = data.priority
                end
            end
            new_data.priority = max_priority + 1
        end
        skills[new_id_str] = new_data
        Battle_ritual_save_settings()
        Battle_ritual_settings_frame()
    end
    return 0
end

function Battle_ritual_buff_list_open(frame, ctrl, ctrl_text, skill_id)
    local buff_list = ui.GetFrame(addon_name_lower .. "Battle_ritual_buff_list")
    if not buff_list then
        buff_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "Battle_ritual_buff_list", 0, 0, 10, 10)
        AUTO_CAST(buff_list)
        buff_list:SetSkinName("test_frame_low")
        buff_list:Resize(500, 1005)
        buff_list:SetPos(720, 30)
        buff_list:SetLayerLevel(999)
        local title_text = buff_list:CreateOrGetControl('richtext', 'title_text', 15, 15, 10, 30)
        AUTO_CAST(title_text)
        title_text:SetText("{#000000}{s20}Buff List")
        local search_edit = buff_list:CreateOrGetControl("edit", "search_edit", title_text:GetWidth() + 30, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Battle_ritual_buff_list_search")
        search_edit:SetEventScriptArgNumber(ui.ENTERKEY, skill_id)
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Battle_ritual_buff_list_search")
        search_btn:SetEventScriptArgNumber(ui.LBUTTONUP, skill_id)
        local close_button = buff_list:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
        AUTO_CAST(close_button)
        close_button:SetImage("testclose_button")
        close_button:SetGravity(ui.RIGHT, ui.TOP)
        close_button:SetEventScript(ui.LBUTTONUP, "Battle_ritual_frame_close")
    end
    local buff_list_gb = buff_list:CreateOrGetControl("groupbox", "buff_list_gb", 10, 50, 480,
        buff_list:GetHeight() - 60)
    AUTO_CAST(buff_list_gb)
    buff_list_gb:SetSkinName("bg")
    buff_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Buff")
    local y = 0
    for i = 0, count - 1 do
        local buff_cls = GetClassByIndexFromList(cls_list, i)
        if buff_cls then
            local buff_id = buff_cls.ClassID
            local buff_name = dictionary.ReplaceDicIDInCompStr(buff_cls.Name)
            if ctrl_text == "" or (ctrl_text ~= "" and string.find(buff_name, ctrl_text)) then
                local buff_slot = buff_list_gb:CreateOrGetControl('slot', 'buffslot' .. i, 10, y + 5, 30, 30)
                AUTO_CAST(buff_slot)
                local image_name = GET_BUFF_ICON_NAME(buff_cls)
                if image_name == "icon_None" then
                    image_name = "icon_item_nothing"
                end
                if buff_name ~= "None" then
                    SET_SLOT_IMG(buff_slot, image_name)
                    local icon = CreateIcon(buff_slot)
                    AUTO_CAST(icon)
                    icon:SetTooltipType('buff')
                    icon:SetTooltipArg(buff_name, buff_id, 0)
                    local buff_set = buff_list_gb:CreateOrGetControl('button', 'buff_set' .. buff_id, 45, y + 5, 40, 30)
                    AUTO_CAST(buff_set)
                    buff_set:SetText("{ol}Add")
                    buff_set:SetSkinName("test_cardtext_btn")
                    buff_set:SetTextTooltip(g.lang == "Japanese" and "{ol}バフ追加" or "{ol}Add Buff")
                    buff_set:SetEventScript(ui.LBUTTONUP, "Battle_ritual_add_buff")
                    buff_set:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
                    buff_set:SetEventScriptArgNumber(ui.LBUTTONUP, skill_id)
                    local buff_text = buff_list_gb:CreateOrGetControl('richtext', 'buff_text' .. buff_id, 90, y + 10,
                        200, 30)
                    AUTO_CAST(buff_text)
                    buff_text:SetText("{ol}" .. buff_id .. " : " .. buff_name)
                    buff_text:AdjustFontSizeByWidth(380)
                    y = y + 35
                end
            end
        end
    end
    buff_list:ShowWindow(1)
end

function Battle_ritual_buff_list_search(frame, ctrl, str, skill_id)
    local search_edit = GET_CHILD_RECURSIVELY(frame, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Battle_ritual_buff_list_open(frame, ctrl, ctrl_text, skill_id)
    else
        Battle_ritual_buff_list_open(frame, ctrl, "", skill_id)
    end
end

function Battle_ritual_add_buff(parent, ctrl, buff_id_str, skill_id)
    local ctrl_name = ctrl:GetName()
    if string.find(ctrl_name, "buff_edit") then
        ctrl:SetUserValue("BUFF_ID", tonumber(ctrl:GetText()))
        ctrl:RunUpdateScript("Battle_ritual_setting_change_buff_edit", 0.5)
    else
        local buff_cls = GetClassByType("Buff", tonumber(buff_id_str))
        local s_id_str = tostring(skill_id)
        if g.battle_ritual_settings.skills[s_id_str] then
            if buff_cls then
                g.battle_ritual_settings.skills[s_id_str].buff_id = tonumber(buff_id_str)
            else
                g.battle_ritual_settings.skills[s_id_str].buff_id = 0
            end
            Battle_ritual_save_settings()
            Battle_ritual_settings_frame()
        end
    end
end

function Battle_ritual_setting_change_buff_edit(ctrl)
    local buff_id = ctrl:GetUserIValue("BUFF_ID")
    local skill_id_str = ctrl:GetUserValue("SKILL_ID")
    if g.battle_ritual_settings.skills[skill_id_str] then
        local buff_cls = GetClassByType("Buff", buff_id)
        if not buff_cls then
            g.battle_ritual_settings.skills[skill_id_str].buff_id = 0
        else
            g.battle_ritual_settings.skills[skill_id_str].buff_id = buff_id
        end
    end
    Battle_ritual_save_settings()
    Battle_ritual_settings_frame()
end

function Battle_ritual_frame_close(frame)
    ui.DestroyFrame(frame:GetName())
    if frame:GetName() == addon_name_lower .. "Battle_ritual_setting" then
        ui.DestroyFrame(addon_name_lower .. "Battle_ritual_skill_list")
        ui.DestroyFrame(addon_name_lower .. "Battle_ritual_buff_list")
    end
end

function Battle_ritual_REQ_PLAYER_CONTENTS_RECORD(frame, type)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("Battle_ritual_overlord_off", 0.1)
end

function Battle_ritual_overlord_off(_nexus_addons)
    local buff = info.GetBuff(session.GetMyHandle(), 40049)
    if not buff then
        return 0
    end
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    for i = 1, 40 do
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. i)
        AUTO_CAST(slot)
        local icon = slot:GetIcon()
        if icon then
            AUTO_CAST(icon)
            local icon_info = icon:GetInfo()
            if icon_info then
                local category = icon_info:GetCategory()
                if category == "Skill" then
                    local buff_id = icon_info.type
                    if buff_id == 100085 then
                        local current_cooldown = ICON_UPDATE_SKILL_COOLDOWN(icon)
                        if current_cooldown == 0 then
                            control.Skill(buff_id)
                        end
                        return 1
                    end
                end
            end
        end
    end
end
-- Battle_ritual ここまで

-- other_character_skill_list ここから
function Other_character_skill_list_save_settings()
    g.save_lua(g.ocsl_path, g.ocsl_settings)
end

function Other_character_skill_list_load_settings()
    g.ocsl_path = string.format("../addons/%s/%s/other_character_skill_list.lua", addon_name_lower, g.active_id)
    local json_path = string.format("../addons/%s/%s/other_character_skill_list.json", addon_name_lower, g.active_id)
    local settings = g.load_lua(g.ocsl_path)
    local need_save = false
    local ver = 1.1
    if not settings then
        settings = g.load_json(json_path)
        if settings then
            need_save = true
        end
    end
    if not settings then
        settings = {
            chars = {},
            ver = ver
        }
        need_save = true
    end
    if not settings.ver or settings.ver < ver then
        if settings.chars then
            for char_name, char_data in pairs(settings.chars) do
                if char_data.equips and char_data.equips.EARRING then
                    local earring = char_data.equips.EARRING
                    if earring.lv and type(earring.lv) == "string" then
                        earring.lv = nil
                    end
                end
            end
        end
        settings.ver = ver
        need_save = true
    end
    if not settings.hide then
        settings.hide = 0
        need_save = true
    end
    g.ocsl_settings = settings
    if need_save then
        Other_character_skill_list_save_settings()
    end
end

local function GetValidCIDs()
    local valid_cids = {}
    local aid = session.loginInfo.GetAID()
    local sys_opt_path = string.format("../release/addon_setting/system_option/%s/settings.json", aid)
    local sys_opt_file = io.open(sys_opt_path, "r")
    if sys_opt_file then
        local content = sys_opt_file:read("*a")
        sys_opt_file:close()
        if content and content ~= "" then
            local status, data = pcall(json.decode, content)
            if status and data and data.pc_id then
                for k, _ in pairs(data.pc_id) do
                    valid_cids[tostring(k)] = true
                end
            end
        end
    end
    return valid_cids
end

function Other_character_skill_list_char_load_settings()
    local valid_cids = GetValidCIDs()
    if next(valid_cids) then
        local chars_to_delete = {}
        for char_name, char_data in pairs(g.ocsl_settings.chars) do
            local cid_str = tostring(char_data.cid)
            if not valid_cids[cid_str] then
                table.insert(chars_to_delete, char_name)
            end
        end
        for _, char_name in ipairs(chars_to_delete) do
            g.ocsl_settings.chars[char_name] = nil
        end
    end
    local my_handle = session.GetMyHandle()
    if my_handle then
        local my_name = info.GetName(my_handle)
        local my_cid = info.GetCID(my_handle)
        local char_data = g.ocsl_settings.chars[my_name] or {}
        char_data.name = my_name
        char_data.cid = my_cid
        char_data.layer = char_data.layer or g.ocsl_layer or 1
        char_data.order = char_data.order or 0
        char_data.hide = char_data.hide or 0
        char_data.equips = char_data.equips or {}
        char_data.gear_score = char_data.gear_score or 0
        g.ocsl_settings.chars[my_name] = char_data
    end
    Other_character_skill_list_save_settings()
end

--[[function Other_character_skill_list_char_load_settings()
    local acc_info = session.barrack.GetMyAccount()
    local layer_pc_count = acc_info:GetPCCount()
    for order = 0, layer_pc_count - 1 do
        local pc_info = acc_info:GetPCByIndex(order)
        if pc_info then
            local pc_apc = pc_info:GetApc()
            local pc_name = pc_apc:GetName()
            local pc_cid = pc_info:GetCID()
            local existing_data = g.ocsl_settings.chars[pc_name] or {}
            g.ocsl_settings.chars[pc_name] = {
                layer = g.ocsl_layer or existing_data.layer or 9,
                order = order,
                cid = existing_data.cid or pc_cid,
                name = pc_name,
                gear_score = existing_data.gear_score or 0,
                hide = existing_data.hide or 0,
                equips = existing_data.equips or {}
            }
        end
    end
    local barrack_all = acc_info:GetBarrackPCCount()
    if barrack_all > 0 then
        local barrack_chars = {}
        for i = 0, barrack_all - 1 do
            local pc_info = acc_info:GetBarrackPCByIndex(i)
            if pc_info then
                barrack_chars[pc_info:GetName()] = true
            end
        end
        local chars_to_delete = {}
        for char_name, _ in pairs(g.ocsl_settings.chars) do
            if not barrack_chars[char_name] then
                table.insert(chars_to_delete, char_name)
            end
        end
        if #chars_to_delete > 0 then
            for _, char_name in ipairs(chars_to_delete) do
                g.ocsl_settings.chars[char_name] = nil
            end
        end
    end
    Other_character_skill_list_save_settings()
end]]

function other_character_skill_list_on_init()
    local old_func = g.settings.other_character_skill_list.old_init_func
    if _G[old_func] then
        return
    end
    if _G["BARRACK_CHARLIST_ON_INIT"] and _G["current_layer"] then
        g.ocsl_layer = _G["current_layer"]
    end
    if g.settings.other_character_skill_list.use == 0 then
        if _G["other_character_skill_list_frame_open"] == _G["Other_character_skill_list_frame_open"] then
            _G["other_character_skill_list_frame_open"] = nil
        end
    else
        if type(_G["Other_character_skill_list_frame_open"]) == "function" then
            if type(_G["other_character_skill_list_frame_open"]) ~= "function" then
                _G["other_character_skill_list_frame_open"] = _G["Other_character_skill_list_frame_open"]
            end
        end
    end
    if not g.ocsl_settings then
        Other_character_skill_list_load_settings()
    end
    if g.get_map_type() == "City" then
        Other_character_skill_list_char_load_settings()
        Other_character_skill_list_sort()
    end
    g.setup_hook_and_event(g.addon, "INVENTORY_OPEN", "Other_character_skill_list_save_enchant", true)
    g.setup_hook_and_event(g.addon, "INVENTORY_CLOSE", "Other_character_skill_list_save_enchant", true)
    g.addon:RegisterMsg("ESCAPE_PRESSED", "Other_character_skill_list_ESCAPE_PRESSED")
end

function Other_character_skill_list_save_enchant()
    if g.get_map_type() ~= "City" then
        return
    end
    local current_time = os.time()
    if g.ocsl_last_save_time and current_time - g.ocsl_last_save_time < 0.5 then
        return
    end
    g.ocsl_last_save_time = current_time
    local inventory = ui.GetFrame("inventory")
    local inventory_btns = {"moncard_btn", "helper_btn", "cabinet_btn", "goddess_mgr_btn"}
    if inventory then
        for _, btn_name in ipairs(inventory_btns) do
            local btn = GET_CHILD_RECURSIVELY(inventory, btn_name)
            if btn and btn:IsVisible() == 0 then
                btn:ShowWindow(1)
            end
        end
    end
    local pc_name = session.GetMySession():GetPCApc():GetName()
    local equip_item_list = session.GetEquipItemList()
    local count = equip_item_list:Count()
    local cid = session.GetMySession():GetCID()
    local data = g.ocsl_settings.chars[pc_name].equips
    local score = 0
    for i = 0, count - 1 do
        local equip_item = equip_item_list:GetEquipItemByIndex(i)
        local spot_name = item.GetEquipSpotName(equip_item.equipSpot)
        local spot_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(spot_name))
        local obj = GetIES(spot_item:GetObject())
        if obj.ClassName ~= "NoRing" then
            score = GET_GEAR_SCORE(obj) + score
        end
        local lv = TryGetProp(obj, "Reinforce_2", 0)
        if spot_name == "SHIRT" or spot_name == "PANTS" or spot_name == "GLOVES" or spot_name == "BOOTS" then
            local slot = GET_CHILD_RECURSIVELY(inventory, spot_name)
            local icon = slot:GetIcon()
            if icon then
                local name, skill_lv = shared_skill_enchant.get_enchanted_skill(obj, 1)
                data[spot_name] = {
                    clsid = obj.ClassID,
                    lv = lv,
                    skill_name = name,
                    skill_lv = skill_lv
                }
            else
                data[spot_name] = {}
            end
        elseif spot_name == "RH" or spot_name == "LH" or spot_name == "RH_SUB" or spot_name == "LH_SUB" or spot_name ==
            "RING1" or spot_name == "RING2" or spot_name == "NECK" then
            local slot = GET_CHILD_RECURSIVELY(inventory, spot_name)
            local icon = slot:GetIcon()
            if icon then
                data[spot_name] = {
                    clsid = obj.ClassID,
                    lv = lv
                }
            else
                data[spot_name] = {}
            end
        elseif spot_name == "SEAL" or spot_name == "ARK" or spot_name == "RELIC" then
            local slot = GET_CHILD_RECURSIVELY(inventory, spot_name)
            local icon = slot:GetIcon()
            if spot_name == "SEAL" then
                lv = GET_CURRENT_SEAL_LEVEL(obj)
            elseif spot_name == "ARK" then
                lv = TryGetProp(obj, 'ArkLevel', 1)
            elseif spot_name == "RELIC" then
                lv = TryGetProp(obj, 'Relic_LV', 1)
            end
            if icon then
                data[spot_name] = {
                    clsid = obj.ClassID,
                    lv = lv
                }
            else
                data[spot_name] = {}
            end
        elseif spot_name == "EARRING" then
            local slot = GET_CHILD_RECURSIVELY(inventory, spot_name)
            local icon = slot:GetIcon()
            local option_texts = {}
            if icon then
                local max_option_count = shared_item_earring.get_max_special_option_count(TryGetProp(obj, 'UseLv', 1))
                for i = 1, max_option_count do
                    local option_name = 'EarringSpecialOption_' .. i
                    local job = TryGetProp(obj, option_name, 'None')
                    if job ~= 'None' then
                        local job_cls = GetClass('Job', job)
                        if job_cls ~= nil then
                            local item_name = dictionary.ReplaceDicIDInCompStr(job_cls.Name)
                            local rank = TryGetProp(obj, 'EarringSpecialOptionRankValue_' .. i, 0)
                            local skill_lv = TryGetProp(obj, 'EarringSpecialOptionLevelValue_' .. i, 0)
                            local temp_text = ScpArgMsg('EarringSpecialOption{ctrl}{rank}{lv}', 'ctrl', item_name,
                                'rank', rank, 'lv', skill_lv)
                            table.insert(option_texts, temp_text)
                        end
                    end
                end
            end
            local final_text = table.concat(option_texts, ":::")
            if icon then
                data[spot_name] = {
                    clsid = obj.ClassID,
                    lv = final_text
                }
            else
                data[spot_name] = {}
            end
        elseif spot_name == "CORE" then -- ！
            local slot = GET_CHILD_RECURSIVELY(inventory, spot_name)
            local icon = slot:GetIcon()
            if icon then
                data[spot_name] = {
                    clsid = obj.ClassID,
                    lv = lv
                }
            else
                data[spot_name] = {}
            end
        end
    end
    local info = equipcard.GetCardInfo(13)
    if info then
        data["LEG"] = {
            clsid = info:GetCardID(),
            lv = info.cardLv
        }
    else
        data["LEG"] = {}
    end
    local info = equipcard.GetCardInfo(14)
    if info then
        data["GOD"] = {
            clsid = info:GetCardID(),
            lv = info.cardLv
        }
    else
        data["GOD"] = {}
    end
    g.ocsl_settings.chars[pc_name].gear_score = score
    Other_character_skill_list_save_settings()
end

function Other_character_skill_list_sort()
    local function sort_layer_order(a, b)
        if a.layer ~= b.layer then
            return a.layer < b.layer
        else
            return a.order < b.order
        end
    end
    local char_list = {}
    for _, char_data in pairs(g.ocsl_settings.chars) do
        table.insert(char_list, char_data)
    end
    table.sort(char_list, sort_layer_order)
    g.ocsl_sorted_chars = char_list
end

function Other_character_skill_list_split_earring_options(earring_data_string)
    if not earring_data_string or earring_data_string == "" then
        return {}
    end
    local options_list = {}
    for option_part in earring_data_string:gmatch("([^:]+)") do
        table.insert(options_list, option_part)
    end
    return options_list
end

function Other_character_skill_list_frame_open()
    Other_character_skill_list_save_enchant()
    if g.settings.other_character_skill_list.use == 0 then
        return
    end
    local ocsl = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "ocsl", 0, 0, 70, 30)
    AUTO_CAST(ocsl)
    ocsl:SetSkinName("test_frame_midle_light")
    ocsl:SetLayerLevel(99)
    local title_box = Other_character_skill_create_title_bar(ocsl)
    local main_gbox = ocsl:CreateOrGetControl("groupbox", "gbox", 5, 35, 1070, 280)
    AUTO_CAST(main_gbox)
    main_gbox:RemoveAllChild()
    main_gbox:SetSkinName("bg2")
    main_gbox:EnableScrollBar(0)
    local all_skills = GetClassList("Skill")
    local y_pos = 10
    local char_count = 0
    local last_etc_x = 0
    for i, char_info in ipairs(g.ocsl_sorted_chars) do
        local char_settings = g.ocsl_settings.chars[char_info.name]
        if char_settings.hide ~= 1 or g.ocsl_settings.hide == 0 then
            local job_list, level, last_job_id = GetJobListFromAdventureBookCharData(char_info.name)
            if type(_G["INDUN_LIST_VIEWER_ON_INIT"]) == "function" then
                local ilv_settings = _G["ADDONS"]["norisan"]["indun_list_viewer"].settings
                if ilv_settings[char_info.name] then
                    if ilv_settings[char_info.name].president_jobid ~= "" then
                        last_job_id = ilv_settings[char_info.name].president_jobid
                    end
                end
            elseif type(_G["indun_list_viewer_on_init"]) == "function" then
                local ilv_settings = _G["ADDONS"]["norisan"]["_NEXUS_ADDONS"].ilv_settings
                if ilv_settings.chars[char_info.name] then
                    if ilv_settings.chars[char_info.name].president_jobid ~= "" then
                        last_job_id = ilv_settings.chars[char_info.name].president_jobid
                    end
                end
            end
            local last_job_class = GetClassByType("Job", last_job_id)
            local last_job_icon = TryGetProp(last_job_class, "Icon")
            local job_slot = main_gbox:CreateOrGetControl("slot", "jobslot" .. i, 0, y_pos - 3, 25, 25)
            AUTO_CAST(job_slot)
            job_slot:SetSkinName("None")
            job_slot:EnableHitTest(1)
            job_slot:EnablePop(0)
            local job_icon = CreateIcon(job_slot)
            job_icon:SetImage(last_job_icon)
            local name_lbl = main_gbox:CreateOrGetControl("richtext", "name_text" .. i, 25, y_pos, 195, 20)
            AUTO_CAST(name_lbl)
            name_lbl:SetText("{ol}" .. char_info.name)
            name_lbl:AdjustFontSizeByWidth(195)
            name_lbl:SetEventScript(ui.RBUTTONUP, "Other_character_skill_list_char_report")
            name_lbl:SetEventScriptArgString(ui.RBUTTONUP, char_info.name)
            local gs_str = char_settings.gear_score ~= 0 and tostring(char_settings.gear_score) or "NoData"
            if type(_G["INSTANTCC_ON_INIT"]) == "function" and g.settings.instant_cc.use == 1 then
                name_lbl:SetEventScript(ui.LBUTTONDOWN, "Other_character_skill_list_save_enchant")
                name_lbl:SetEventScript(ui.LBUTTONUP, "Other_character_skill_list_INSTANTCC_DO_CC")
                name_lbl:SetEventScriptArgString(ui.LBUTTONUP, char_info.cid)
                name_lbl:SetEventScriptArgNumber(ui.LBUTTONUP, char_info.layer)
                name_lbl:SetTextTooltip(g.lang == "Japanese" and "{ol}GearScore: " .. gs_str .. "{nl} {nl}" ..
                                            "右クリック: 各キャラ装備詳細{nl}左クリック：キャラクターチェンジ" or
                                            "{ol}GearScore: " .. gs_str .. "{nl} {nl}" ..
                                            "Right click: Details of each character's equipment{nl}Left click: Character change")
            else
                name_lbl:SetTextTooltip(g.lang == "Japanese" and "{ol}GearScore: " .. gs_str .. "{nl} {nl}" ..
                                            "右クリック: 各キャラ装備詳細" or "{ol}GearScore: " .. gs_str ..
                                            "{nl} {nl}" .. "Right-click: Details of each character's equipment")
            end
            local equips = {"SHIRT", "PANTS", "GLOVES", "BOOTS", "LEG", "GOD", "SEAL", "ARK", "RELIC", "EARRING",
                            "CORE", "RH", "LH", "RH_SUB", "LH_SUB", "RING1", "RING2", "NECK"}
            Other_character_skill_list_create_weapon_slots(main_gbox, char_settings.equips, equips, i, y_pos)
            Other_character_skill_list_create_armor_slots(main_gbox, char_settings.equips, equips, all_skills, i, y_pos)
            last_etc_x = Other_character_skill_list_create_etc_slots(main_gbox, char_settings.equips, equips, i, y_pos)
            local hide_check_char = main_gbox:CreateOrGetControl('checkbox', "hide_check" .. i, last_etc_x, y_pos, 25,
                25)
            AUTO_CAST(hide_check_char)
            hide_check_char:SetCheck(char_settings.hide)
            hide_check_char:SetEventScript(ui.LBUTTONDOWN, 'Other_character_skill_list_display_check')
            hide_check_char:SetEventScriptArgString(ui.LBUTTONDOWN, char_info.name)
            hide_check_char:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると非表示" or
                                               "{ol}Check to hide")
            y_pos = y_pos + 25
            char_count = char_count + 1
        end
    end
    local frame_height = char_count * 25
    ocsl:Resize(last_etc_x + 40, frame_height + 60)
    title_box:Resize(last_etc_x + 30, 40)
    main_gbox:Resize(last_etc_x + 30, frame_height + 20)
    local current_frame_w = ocsl:GetWidth()
    local map_frame = ui.GetFrame("map")
    local map_width = map_frame:GetWidth()
    ocsl:SetPos((map_width - current_frame_w) / 2, 0)
    ocsl:ShowWindow(1)
end

function Other_character_skill_create_title_bar(ocsl)
    local title_box = ocsl:CreateOrGetControl("groupbox", "title", 0, 0, 1070, 40)
    AUTO_CAST(title_box)
    title_box:SetSkinName("None")
    title_box:EnableScrollBar(0)
    local close_btn = title_box:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close_btn)
    close_btn:SetImage("testclose_button")
    close_btn:SetGravity(ui.LEFT, ui.TOP)
    close_btn:SetEventScript(ui.LBUTTONUP, "Other_character_skill_list_frame_close")
    local help_btn = title_box:CreateOrGetControl('button', "help", 40, 0, 35, 35)
    AUTO_CAST(help_btn)
    help_btn:SetText("{ol}{img question_mark 20 20}")
    help_btn:SetSkinName("test_pvp_btn")
    local ccbtn = title_box:CreateOrGetControl('button', 'ccbtn', 75, 0, 35, 35)
    AUTO_CAST(ccbtn)
    ccbtn:SetSkinName("None")
    ccbtn:SetText("{ol}{img barrack_button_normal 35 35}")
    ccbtn:SetEventScript(ui.LBUTTONUP, "APPS_TRY_MOVE_BARRACK")
    ccbtn:SetTextTooltip(g.lang == "Japanese" and "{ol}バラックに戻ります" or "{ol}Return to Barracks")
    local hide_check = title_box:CreateOrGetControl('checkbox', 'hide_check', 120, 0, 35, 35)
    AUTO_CAST(hide_check)
    hide_check:SetEventScript(ui.LBUTTONUP, 'Other_character_skill_list_display_check')
    hide_check:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックしたキャラを非表示" or
                                  "{ol}Hide Checked Characters")
    hide_check:SetCheck(g.ocsl_settings.hide)
    help_btn:SetTextTooltip(g.lang == "Japanese" and
                                "{ol}順番に並ばない場合は一度バラックに戻ってバラック1､2､3毎にログインしてください。{nl}" ..
                                "{ol}名前部分を押すと、ログインキャラと同一バラックの各キャラの装備詳細が見れます。" or
                                "{ol}If you do not line up in order,{nl}" ..
                                "please return to the barracks once and log in for each barracks 1,2,3.{nl}" ..
                                "{ol}Press the name section to see the equipment details of each character{nl}in the same barrack as the login character.")
    local weapon_lbl = title_box:CreateOrGetControl("richtext", "weapon", 160, 10, 100, 20)
    weapon_lbl:SetText(g.lang == "Japanese" and "{ol}" .. "武器" or "{ol}" .. "weapons")
    weapon_lbl:AdjustFontSizeByWidth(100)
    local acc_lbl = title_box:CreateOrGetControl("richtext", "Accessory", 290, 10, 100, 20)
    acc_lbl:SetText(g.lang == "Japanese" and "{ol}" .. "アクセ" or "{ol}" .. "Accessory")
    local equip_x = 390
    local equip_labels = {ClMsg("Shirt"), ClMsg("Pants"), ClMsg("GLOVES"), ClMsg("BOOTS"),
                          (g.lang == "Japanese" and "その他" or "etc.")}
    for i = 0, 4 do
        local equip_lbl = title_box:CreateOrGetControl("richtext", "equip_text" .. i, equip_x, 10, 100, 20)
        equip_lbl:SetText("{ol}" .. equip_labels[i + 1])
        equip_lbl:AdjustFontSizeByWidth(100)
        equip_x = equip_x + 225
    end
    return title_box
end

function Other_character_skill_list_create_weapon_slots(parent_gbox, char_equips, equips, i, y_pos)
    for j = 12, #equips do
        local equip_type = equips[j]
        local equip_data_entry = char_equips[equip_type]
        local weapon_slot_x = 155 + 30 * (j - 12)
        if j >= 16 then
            weapon_slot_x = weapon_slot_x + 10
        end
        local weapon_slot = parent_gbox:CreateOrGetControl("slot", "slot" .. equip_type .. i, weapon_slot_x, y_pos, 25,
            24)
        AUTO_CAST(weapon_slot)
        weapon_slot:SetSkinName('invenslot2')
        if equip_data_entry then
            local clsid = equip_data_entry.clsid
            if clsid and clsid ~= 0 then
                local lv = equip_data_entry.lv
                local item_cls = GetClassByType("Item", clsid)
                if item_cls then
                    SET_SLOT_ICON(weapon_slot, item_cls.Icon)
                    SET_SLOT_BG_BY_ITEMGRADE(weapon_slot, item_cls)
                    weapon_slot:SetText('{s12}{ol}{#FFFF00}+' .. lv, 'count', ui.RIGHT, ui.BOTTOM, 0, 0)
                    local icon = weapon_slot:GetIcon()
                    if icon then
                        icon:SetTextTooltip("{ol}" .. item_cls.Name)
                    end
                end
            end
        end
    end
end

function Other_character_skill_list_create_armor_slots(parent_gbox, char_equips, equips, all_skills, i, y_pos)
    local equip_grp_x = 385
    for j = 1, 4 do
        local equip_type = equips[j]
        local equip_data_entry = char_equips[equip_type]
        local skill_slot = parent_gbox:CreateOrGetControl("slot", "slot" .. equip_type .. i,
            equip_grp_x + (225 * (j - 1)) + 30, y_pos, 25, 24)
        AUTO_CAST(skill_slot)
        skill_slot:SetSkinName('invenslot2')
        local item_slot = parent_gbox:CreateOrGetControl("slot", "equip" .. equip_type .. i,
            equip_grp_x + (225 * (j - 1)), y_pos, 25, 24)
        AUTO_CAST(item_slot)
        item_slot:SetSkinName('invenslot2')
        if equip_data_entry then
            local clsid = equip_data_entry.clsid
            local item_cls = GetClassByType("Item", clsid)
            if item_cls then
                SET_SLOT_ICON(item_slot, item_cls.Icon)
                SET_SLOT_BG_BY_ITEMGRADE(item_slot, item_cls)
                item_slot:SetText('{s12}{ol}{#FFFF00}+' .. equip_data_entry.lv, 'count', ui.RIGHT, ui.BOTTOM, 0, 0)
                local icon = item_slot:GetIcon()
                if icon then
                    icon:SetTextTooltip("{ol}" .. item_cls.Name)
                end
            end
            local skill = GetClassByNameFromList(all_skills, equip_data_entry.skill_name)
            if skill then
                SET_SLOT_ICON(skill_slot, 'icon_' .. skill.Icon)
                skill_slot:SetText('{s14}{ol}{#FFFF00}' .. equip_data_entry.skill_lv, 'count', ui.RIGHT, ui.BOTTOM, -2,
                    -2)
                local icon = skill_slot:GetIcon()
                if icon then
                    icon:SetTooltipType('skill')
                    icon:SetTooltipArg("Level", skill.ClassID, equip_data_entry.skill_lv)
                end
                local skill_name_lbl = parent_gbox:CreateOrGetControl("richtext", "skill_name" .. equip_type .. i,
                    equip_grp_x + 60 + (225 * (j - 1)), y_pos, 140, 20)
                skill_name_lbl:SetText("{ol}{s16}" .. skill.Name)
                skill_name_lbl:AdjustFontSizeByWidth(160)
            end
        end
    end
end

function Other_character_skill_list_create_etc_slots(parent_gbox, char_equips, equips, i, y_pos)
    local etc_x_offset = 0
    local equip_grp_x = 385
    local last_x = equip_grp_x + 225 * 4
    for j = 5, 11 do
        local equip_type = equips[j]
        local equip_data_entry = char_equips[equip_type]
        local current_x = equip_grp_x + 225 * 4 + etc_x_offset
        local etc_slot = parent_gbox:CreateOrGetControl("slot", "etc_slot" .. equip_type .. i, current_x, y_pos, 25, 24)
        AUTO_CAST(etc_slot)
        etc_slot:SetSkinName('invenslot2')
        if equip_data_entry and equip_data_entry.clsid then
            local text_prefix = (j >= 5 and j <= 6) and "{s12}{ol}{#FFFF00}{img mon_legendstar 10 10}{nl}" or
                                    "{s12}{ol}{#FFFF00}+"
            local item_cls = GetClassByType("Item", equip_data_entry.clsid)
            if item_cls then
                SET_SLOT_ICON(etc_slot, item_cls.Icon)
                local icon = etc_slot:GetIcon()
                if icon then
                    local tooltip = item_cls.Name
                    if j == 10 then -- Earring
                        local earring_str = Other_character_skill_list_split_earring_options(equip_data_entry.lv)
                        for _, option_str in ipairs(earring_str) do
                            tooltip = "{ol}" .. tooltip .. "{nl}" .. option_str
                        end
                    elseif j ~= 11 then -- Ark
                        etc_slot:SetText(text_prefix .. equip_data_entry.lv, 'count', ui.RIGHT, ui.BOTTOM, 0, 0)
                    end
                    icon:SetTextTooltip(tooltip)
                end
            end
        end
        etc_x_offset = etc_x_offset + 30
        last_x = current_x
    end
    return last_x + 30
end

function Other_character_skill_list_char_report(ocsl, ctrl, char_name_str, num)
    local report = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "ocsl_report", 5, 40, 0, 0)
    AUTO_CAST(report)
    report:RemoveAllChild()
    report:SetLayerLevel(104)
    report:SetSkinName("None")
    report:Resize(410, 480)
    local cid = g.ocsl_settings.chars[char_name_str].cid
    local current_cid = report:GetUserValue("CID")
    if current_cid ~= "None" and current_cid ~= cid then
        DESTROY_CHILD_BYNAME(report, "char_" .. current_cid)
    else
        local char_frame = GET_CHILD_RECURSIVELY(report, "char_" .. current_cid)
        if char_frame then
            char_frame:ShowWindow(1)
        end
    end
    local bpc_info = barrack.GetBarrackPCInfoByCID(cid)
    if not bpc_info then
        local language = option.GetCurrentCountry()
        ui.SysMsg(language == "Japanese" and
                      "{ol}詳細表示は、ログイン中のキャラと同一バラックのキャラのみ対応しています" or
                      "{ol}Detailed view is supported only for characters{nl}in the same barracks as the currently logged-in character")
        Other_character_skill_list_frame_open()
        return
    end
    local char_ctrl = report:CreateOrGetControlSet('barrack_charlist', 'char_' .. cid, 10, 10)
    AUTO_CAST(char_ctrl)
    report:SetUserValue("CID", cid)
    local main_box = GET_CHILD(char_ctrl, 'mainBox')
    AUTO_CAST(main_box)
    local btn = main_box:GetChild("btn")
    btn:SetSkinName('character_off')
    btn:SetSValue(char_name_str)
    btn:SetOverSound('button_over')
    btn:SetClickSound('button_click_2')
    local indun_btn = main_box:GetChild("indunBtn")
    AUTO_CAST(indun_btn)
    indun_btn:SetImage("testclose_button")
    indun_btn:SetEventScript(ui.LBUTTONUP, "Other_character_skill_list_char_report_close")
    btn:ShowWindow(1)
    local apc = bpc_info:GetApc()
    local gender = apc:GetGender()
    local job_id = apc:GetJob()
    local level = apc:GetLv()
    local pic = GET_CHILD(main_box, "char_icon")
    AUTO_CAST(pic)
    local head_icon = ui.CaptureModelHeadImageByApperance(apc)
    pic:SetImage(head_icon)
    local name_label = GET_CHILD(main_box, "name")
    AUTO_CAST(name_label)
    name_label:SetText("{@st42b}{b}" .. char_name_str)
    local barrack_pc = session.barrack.GetMyAccount():GetByStrCID(cid)
    if barrack_pc ~= nil and barrack_pc:GetRepID() ~= 0 then
        job_id = barrack_pc:GetRepID()
    end
    local job_cls = GetClassByType("Job", job_id)
    local job_label = GET_CHILD(main_box, "job")
    AUTO_CAST(job_label)
    job_label:SetText("{@st42b}" .. GET_JOB_NAME(job_cls, gender))
    local level_label = GET_CHILD(main_box, "level")
    AUTO_CAST(level_label)
    level_label:SetText("{@st42b}Lv." .. level)
    local detail_box = GET_CHILD(char_ctrl, 'detailBox')
    AUTO_CAST(detail_box)
    local rh_sub_slot = detail_box:CreateOrGetControl("slot", "RH_SUB", 138, 214, 55, 55)
    local lh_sub_slot = detail_box:CreateOrGetControl("slot", "LH_SUB", 198, 214, 55, 55)
    local map_label = GET_CHILD(detail_box, 'mapName')
    AUTO_CAST(map_label)
    local map_cls = GetClassByType("Map", apc.mapID)
    if map_cls ~= nil then
        local map_name = map_cls.Name
        map_label:SetText("{@st66b}" .. map_name)
    end
    local spot_count = item.GetEquipSpotCount() - 1
    local skin_list = {}
    for i = 0, spot_count do
        local equip_obj = bpc_info:GetEquipObj(i)
        local spot_name = item.GetEquipSpotName(i)
        if equip_obj then
            local ies_obj = GetIES(equip_obj)
            local equip_type = TryGet_Str(ies_obj, "EqpType")
            if equip_type == "HELMET" then
                if item.IsNoneItem(ies_obj.ClassID) == 0 then
                    spot_name = "HAIR"
                end
            end
            if spot_name == "TRINKET" and item.IsNoneItem(ies_obj.ClassID) == 0 then
                spot_name = "LH"
            end
        end
        local slot_ctrl = GET_CHILD(detail_box, spot_name)
        AUTO_CAST(slot_ctrl)
        if slot_ctrl then
            if slot_ctrl:GetName() == "SHIRT" then
                slot_ctrl:SetMargin(-120, 150, 0, 0)
            elseif slot_ctrl:GetName() == "PANTS" then
                slot_ctrl:SetMargin(-60, 150, 0, 0)
            elseif slot_ctrl:GetName() == "GLOVES" then
                slot_ctrl:SetMargin(0, 150, 0, 0)
            elseif slot_ctrl:GetName() == "BOOTS" then
                slot_ctrl:SetMargin(60, 150, 0, 0)
            elseif slot_ctrl:GetName() == "RH" then
                slot_ctrl:SetMargin(-120, 214, 0, 0)
            elseif slot_ctrl:GetName() == "LH" then
                slot_ctrl:SetMargin(-60, 214, 0, 0)
            elseif slot_ctrl:GetName() == "ARK" then
                slot_ctrl:SetMargin(120, 150, 0, 0)
            elseif slot_ctrl:GetName() == "RELIC" then
                slot_ctrl:SetMargin(120, 214, 0, 0)
            end
            if skin_list[spot_name] == nil then
                skin_list[spot_name] = slot_ctrl:GetSkinName()
            end
            slot_ctrl:EnableDrag(0)
            if not equip_obj then
                CLEAR_SLOT_ITEM_INFO(slot_ctrl)
            else
                local ies_item = GetIES(equip_obj)
                local refresh_scp = ies_item.RefreshScp
                if refresh_scp ~= "None" then
                    local scp_func = _G[refresh_scp]
                    scp_func(ies_item)
                end
                if 0 == item.IsNoneItem(ies_item.ClassID) then
                    CLEAR_SLOT_ITEM_INFO(slot_ctrl)
                    SET_SLOT_ITEM_OBJ(slot_ctrl, ies_item, gender, 1)
                else
                    local current_skin = skin_list[spot_name]
                    if current_skin ~= nil then
                        slot_ctrl:SetSkinName(current_skin)
                    end
                    SET_SLOT_TRANSCEND_LEVEL(slot_ctrl, 0)
                    SET_SLOT_REINFORCE_LEVEL(slot_ctrl, 0)
                    CLEAR_SLOT_ITEM_INFO(slot_ctrl)
                end
            end
        end
    end
    char_ctrl:Resize(400, 430)
    local map_frame = ui.GetFrame("map")
    local map_width = map_frame:GetWidth()
    report:SetPos((map_width) / 2 - 410 * 1.5, 40)
    report:ShowWindow(1)
end

function Other_character_skill_list_ESCAPE_PRESSED()
    local ocsl = ui.GetFrame(addon_name_lower .. "ocsl")
    Other_character_skill_list_frame_close(ocsl)
end

function Other_character_skill_list_frame_close(parent)
    local ocsl = parent:GetTopParentFrame()
    ui.DestroyFrame(ocsl:GetName())
    Other_character_skill_list_char_report_close()
end

function Other_character_skill_list_char_report_close(parent, ctrl, str, num)
    local report = parent:GetTopParentFrame()
    ui.DestroyFrame(report:GetName())
end

function Other_character_skill_list_display_check(parent, ctrl, char_name, num)
    local ischeck = ctrl:IsChecked()
    if char_name == "" then
        g.ocsl_settings.hide = ischeck
    else
        g.ocsl_settings.chars[char_name].hide = ischeck
    end
    Other_character_skill_list_save_settings()
    Other_character_skill_list_frame_open()
end

function Other_character_skill_list_INSTANTCC_DO_CC(frame, ctrl, cid, layer)
    if _G["INSTANTCC_DO_CC"] then
        _G["INSTANTCC_DO_CC"](cid, layer)
    end
end
-- other_character_skill_list ここまで

-- Instant CC ここから
g.instant_cc = {
    retry = nil,
    do_cc = nil,
    layer = 1
}
function Instant_cc_save_settings()
    g.save_json(g.instant_cc_path, g.instant_cc_settings)
end

function Instant_cc_load_settings()
    g.instant_cc_path = string.format("../addons/%s/%s/instant_cc.json", addon_name_lower, g.active_id)
    local changed = false
    local settings = g.load_json(g.instant_cc_path)
    if not settings then
        settings = {
            characters = {},
            per_barracks = false
        }
        changed = true
    end
    g.instant_cc_settings = settings
    if changed then
        Instant_cc_save_settings()
    end
end

function instant_cc_on_init()
    if not g.instant_cc_settings then
        Instant_cc_load_settings()
    end
    g.instant_cc.do_cc = nil
    g.instant_cc.retry = nil
    _G["norisan"] = _G["norisan"] or {}
    _G["norisan"]["HOOKS"] = _G["norisan"]["HOOKS"] or {}
    if not _G["norisan"]["HOOKS"]["BARRACK_START_FRAME_OPEN"] then
        _G["norisan"]["HOOKS"]["BARRACK_START_FRAME_OPEN"] = addon_name
        Instant_cc_hook_BARRACK_START_FRAME_OPEN()
    end
    if _G["BARRACK_CHARLIST_ON_INIT"] and _G["current_layer"] then
        g.instant_cc.layer = _G["current_layer"]
    end
    _G["INSTANTCC_ON_INIT"] = instant_cc_on_init
    if g.settings.instant_cc.use == 0 then
        _G["INSTANTCC_DO_CC"] = nil
        _G["INSTANTCC_APPS_TRY_MOVE_BARRACK"] = nil
        return
    else
        _G["INSTANTCC_DO_CC"] = Instant_cc_do_cc
        _G["INSTANTCC_APPS_TRY_MOVE_BARRACK"] = Instant_cc_APPS_TRY_MOVE_BARRACK_
    end
    local acc_info = session.barrack.GetMyAccount()
    local barrack_count = acc_info:GetBarrackPCCount() -- ゲーム起動直後はtonumber(0)
    Instant_cc_save_char_data(acc_info, barrack_count)
end

function Instant_cc_APPS_TRY_LEAVE_(type)
    if g.instant_cc.do_cc or g.get_map_type() ~= "City" then
        APPS_TRY_LEAVE("Barrack")
        return
    end
    Instant_cc_APPS_TRY_MOVE_BARRACK_(nil, nil, nil, 0)
end

function Instant_cc_APPS_TRY_MOVE_BARRACK_(frame, msg, str, barrack_layer)
    if barrack_layer == 0 then
        barrack_layer = g.instant_cc.layer
    end
    local context = ui.CreateContextMenu("instant_cc_select_character", "{ol}Barrack Charactor List", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "Return To Barrack", "Instant_cc_do_cc()")
    if not g.instant_cc_settings.per_barracks then
        for i = 1, #g.instant_cc_sorted_list do
            local info = g.instant_cc_sorted_list[i]
            local pc_name = info.name
            local job_cls = GetClassByType("Job", info.jobid)
            local job_name = GET_JOB_NAME(job_cls, info.gender)
            job_name = string.gsub(dic.getTranslatedStr(job_name), "{s18}", "")
            local str = "Lv" .. info.level .. " " .. pc_name .. " (" .. job_name .. ")          "
            ui.AddContextMenuItem(context, str, string.format("Instant_cc_do_cc('%s',%d)", info.cid, info.layer))
        end
    else
        ui.AddContextMenuItem(context, "Barrack 1",
            string.format("Instant_cc_APPS_TRY_MOVE_BARRACK_(nil, nil, nil, %d)", 1))
        ui.AddContextMenuItem(context, "Barrack 2",
            string.format("Instant_cc_APPS_TRY_MOVE_BARRACK_(nil, nil, nil, %d)", 2))
        ui.AddContextMenuItem(context, "Barrack 3",
            string.format("Instant_cc_APPS_TRY_MOVE_BARRACK_(nil, nil, nil, %d)", 3))
        for i = 1, #g.instant_cc_sorted_list do
            local info = g.instant_cc_sorted_list[i]
            local layer = info.layer
            if barrack_layer == layer then
                local pc_name = info.name
                local job_cls = GetClassByType("Job", info.jobid)
                local job_name = GET_JOB_NAME(job_cls, info.gender)
                job_name = string.gsub(dic.getTranslatedStr(job_name), "{s18}", "")
                local str = "Lv" .. info.level .. " " .. pc_name .. " (" .. job_name .. ")          "
                ui.AddContextMenuItem(context, str, string.format("Instant_cc_do_cc('%s',%d)", info.cid, info.layer))
            end
        end
    end
    ui.OpenContextMenu(context)
end

function Instant_cc_do_cc(cid, layer)
    if cid then
        g.instant_cc.do_cc = {
            cid = cid,
            layer = layer
        }
    end
    if Indun_list_viewer_CHECK_ALERT("Barrack") then
        return
    end
    APPS_TRY_LEAVE("Barrack")
end

function Instant_cc_settings_frame_init()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local settings = ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "instant_cc_settings")
    AUTO_CAST(settings)
    settings:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    settings:EnableHitTest(1)
    settings:SetLayerLevel(999)
    settings:SetSkinName("test_frame_low")
    local width = 0
    local title = settings:CreateOrGetControl("richtext", "title", 20, 10, 10, 30)
    AUTO_CAST(title)
    title:SetText("{#000000}{s20}instant CC Settings")
    width = width + 20 + title:GetWidth() + 40
    local close = settings:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Instant_cc_settings_frame_close")
    local gb = settings:CreateOrGetControl("groupbox", "gb", 10, 40, 100, 100)
    AUTO_CAST(gb)
    gb:SetSkinName("bg")
    gb:RemoveAllChild()
    local per_barracks = gb:CreateOrGetControl("checkbox", "per_barracks", 10, 5, 100, 30)
    AUTO_CAST(per_barracks)
    per_barracks:SetText(g.lang == "Japanese" and "{ol}チェックするとバラックごとに表示" or
                             "{ol}Check to display per barracks")
    per_barracks:SetCheck(g.instant_cc_settings.per_barracks and 1 or 0)
    per_barracks:SetEventScript(ui.LBUTTONUP, "Instant_cc_setting")
    width = per_barracks:GetWidth() + 40
    settings:Resize(width, 90)
    gb:Resize(settings:GetWidth() - 20, 40)
    settings:ShowWindow(1)
end

function Instant_cc_settings_frame_close(frame)
    local frame_name = addon_name_lower .. "instant_cc_settings"
    ui.DestroyFrame(frame_name)
end

function Instant_cc_setting(frame, ctrl)
    local is_check = ctrl:IsChecked()
    if is_check == 1 then
        g.instant_cc_settings.per_barracks = true
    else
        g.instant_cc_settings.per_barracks = false
    end
    Instant_cc_save_settings()
end

function Instant_cc_save_char_data(acc_info, barrack_count)
    local characters = g.instant_cc_settings.characters
    local pc_count = acc_info:GetPCCount() -- 毎回同じレイヤーのキャラは順番を取得
    for i = 0, pc_count - 1 do
        local pc_info = acc_info:GetPCByIndex(i)
        if pc_info then
            local pc_cid = pc_info:GetCID()
            local pc_apc = pc_info:GetApc()
            if pc_apc then
                local pc_name = pc_apc:GetName()
                characters[pc_name] = {
                    name = pc_name,
                    layer = g.instant_cc.layer,
                    order = i,
                    jobid = (acc_info:GetByStrCID(pc_cid) and acc_info:GetByStrCID(pc_cid):GetRepID()) or
                        pc_apc:GetJob(),
                    gender = pc_apc:GetGender(),
                    level = pc_apc:GetLv(),
                    cid = pc_cid
                }
            end
        end
    end
    if barrack_count > 0 then -- ゲーム起動直後はカウント0なので、2回目以降動かす
        local barrack_chars = {}
        for i = 0, barrack_count - 1 do
            local pc_info = acc_info:GetBarrackPCByIndex(i)
            if pc_info then
                barrack_chars[pc_info:GetName()] = true
            end
        end
        local chars_to_delete = {}
        for char_name, _ in pairs(characters) do
            if not barrack_chars[char_name] then
                table.insert(chars_to_delete, char_name)
            end
        end
        if #chars_to_delete > 0 then
            for _, char_name in ipairs(chars_to_delete) do
                characters[char_name] = nil
            end
        end
    end
    Instant_cc_save_settings()
    Instant_cc_sort_char_data()
end

function Instant_cc_sort_char_data()
    g.instant_cc_sorted_list = {}
    for _, char_data in pairs(g.instant_cc_settings.characters) do
        table.insert(g.instant_cc_sorted_list, char_data)
    end
    local function dabble_sort(a, b)
        if a.layer == b.layer then
            return a.order < b.order
        else
            return a.layer < b.layer
        end
    end
    table.sort(g.instant_cc_sorted_list, dabble_sort)
end

function Instant_cc_hook_BARRACK_START_FRAME_OPEN()
    g.FUNCS = g.FUNCS or {}
    local origin_func_name = "BARRACK_START_FRAME_OPEN"
    if _G[origin_func_name] then
        if not g.FUNCS[origin_func_name] then
            g.FUNCS[origin_func_name] = _G[origin_func_name]
        end
        _G[origin_func_name] = Instant_cc_BARRACK_START_FRAME_OPEN
    end
end

function Instant_cc_BARRACK_START_FRAME_OPEN(...)
    local frame = select(1, ...)
    if not frame then
        return
    end
    local original_func = g.FUNCS["BARRACK_START_FRAME_OPEN"]
    local result
    if original_func then
        result = original_func(...)
    end
    local barrack_gamestart = ui.GetFrame("barrack_gamestart")
    local hidelogin = GET_CHILD_RECURSIVELY(barrack_gamestart, "hidelogin")
    hidelogin:SetCheck(1)
    if g.instant_cc.do_cc and not g.instant_cc.retry then
        g.instant_cc.retry = 0
        barrack_gamestart:RunUpdateScript("Instant_cc_start", 0.2)
    end
    return result
end

function Instant_cc_start()
    barrack.SelectBarrackLayer(g.instant_cc.do_cc.layer)
    barrack.SelectCharacterByCID(g.instant_cc.do_cc.cid)
    local barrack_gamestart = ui.GetFrame("barrack_gamestart")
    barrack_gamestart:StopUpdateScript("Instant_cc_to_game")
    barrack_gamestart:RunUpdateScript("Instant_cc_to_game", 0.2)
end

function Instant_cc_retry()
    g.instant_cc.retry = g.instant_cc.retry + 1
    if g.instant_cc.retry > #g.instant_cc_sorted_list then
        app.BarrackToLogin()
        ui.SysMsg(g.lang == "Japanese" and
                      "キャラクターの自動取得に失敗しました{nl}手動で選択してください" or
                      "Failed to automatically retrieve the character{nl}Please select manually")
        return
    end
    Instant_cc_start()
end

function Instant_cc_to_game(barrack_gamestart)
    local barrack_pc_info = barrack.GetBarrackPCInfoByCID(g.instant_cc.do_cc.cid)
    if not barrack_pc_info then
        Instant_cc_retry()
        return
    end
    local barrack_start_char = barrack.GetGameStartAccount()
    if not barrack_start_char or barrack_start_char:GetCID() ~= g.instant_cc.do_cc.cid then
        Instant_cc_retry()
        return
    end
    BARRACK_TO_GAME()
    return 0
end
-- Instant CC ここまで

-- ndun_list_viewer ここから
g.ilv_RAID_KEYS = {"Z", "V", "L", "R", "N", "G", "M", "S", "U", "RO", "F", "P", "D"}
g.ilv_RAID_INFO = {
    Z = {
        name = "Zmei",
        hard = 731,
        solo = 730,
        auto = 729,
        icon = "icon_item_misc_boss_Zmei",
        sweep_buff = 80047
    },
    V = {
        name = "Veliora",
        hard = 727,
        solo = 726,
        auto = 725,
        icon = "icon_item_misc_boss_Veliora",
        sweep_buff = 80045
    },
    L = {
        name = "Limara",
        hard = 724,
        solo = 723,
        auto = 722,
        icon = "icon_item_misc_boss_Laimara",
        sweep_buff = 80043
    },
    R = {
        name = "Redania",
        hard = 718,
        solo = 717,
        auto = 716,
        icon = "icon_item_misc_boss_Redania",
        sweep_buff = 80039
    },
    N = {
        name = "Neringa",
        hard = 709,
        solo = 708,
        auto = 707,
        icon = "icon_item_misc_boss_DarkNeringa",
        sweep_buff = 80035
    },
    G = {
        name = "Golem",
        hard = 712,
        solo = 711,
        auto = 710,
        icon = "icon_item_misc_boss_CrystalGolem",
        sweep_buff = 80037
    },
    M = {
        name = "Merregina",
        hard = 697,
        solo = 696,
        auto = 695,
        icon = "icon_item_misc_merregina_blackpearl",
        sweep_buff = 80032
    },
    S = {
        name = "Slogutis",
        hard = 690,
        solo = 689,
        auto = 688,
        icon = "icon_item_misc_boss_Slogutis",
        sweep_buff = 80031
    },
    U = {
        name = "Upinis",
        hard = 687,
        solo = 686,
        auto = 685,
        icon = "icon_item_misc_boss_Upinis",
        sweep_buff = 80030
    },
    RO = {
        name = "Roze",
        hard = 681,
        solo = 680,
        auto = 679,
        icon = "icon_item_misc_boss_Roze",
        sweep_buff = 80015
    },
    F = {
        name = "Falouros",
        hard = 678,
        solo = 677,
        auto = 676,
        icon = "icon_item_misc_high_falouros",
        sweep_buff = 80017
    },
    P = {
        name = "Spreader",
        hard = 675,
        solo = 674,
        auto = 673,
        icon = "icon_item_misc_high_transmutationSpreader",
        sweep_buff = 80016
    },
    D = {
        name = "Delmore",
        hard = 665,
        solo = 667,
        auto = 666,
        icon = "icon_item_misc_RevivalPaulius",
        sweep_buff = nil
    }
}
function Indun_list_viewer_save_settings()
    g.save_lua(g.ilv_path, g.ilv_settings)
end

function Indun_list_viewer_load_settings()
    g.ilv_path = string.format("../addons/%s/%s/indun_list_viewer.lua", addon_name_lower, g.active_id)
    local json_path = string.format("../addons/%s/%s/indun_list_viewer.json", addon_name_lower, g.active_id)
    g.ilv_old_path = string.format("../addons/%s/%s/settings_2510.json", "indun_list_viewer", g.active_id)
    local settings = g.load_lua(g.ilv_path)
    local need_save = false
    local ver = 1.1
    if not settings then
        settings = g.load_json(json_path)
        if settings then
            need_save = true
        end
    end
    if not settings then
        local old_settings = g.load_json(g.ilv_old_path)
        if old_settings then
            settings = {
                options = old_settings.default_options or {},
                display = old_settings.display_options or {},
                chars = {},
                ver = ver
            }
            for key, data in pairs(old_settings) do
                if type(data) == "table" and key ~= "default_options" and key ~= "display_options" then
                    settings.chars[key] = data
                end
            end
        else
            settings = {
                options = {
                    reset_time = 0,
                    display_mode = "full",
                    hidden = 0
                },
                display = {
                    Memo = 1
                },
                chars = {},
                ver = ver
            }
        end
        need_save = true
    end
    if not settings.ver or settings.ver < ver then
        if not settings.display then
            settings.display = {}
        end
        if settings.display.Memo == nil then
            settings.display.Memo = 1
        end
        for _, info in pairs(g.ilv_RAID_INFO) do
            if info.name then
                local h_key = info.name .. "_H"
                local s_key = info.name .. "_S"
                if info.hard and settings.display[h_key] == nil then
                    settings.display[h_key] = 1
                end
                if settings.display[s_key] == nil then
                    settings.display[s_key] = 1
                end
            end
        end
        settings.ver = ver
        need_save = true
    end
    g.ilv_settings = settings
    if need_save then
        Indun_list_viewer_save_settings()
    end
end

function Indun_list_viewer_char_load_settings()
    local acc_info = session.barrack.GetMyAccount()
    if acc_info then
        local layer_pc_count = acc_info:GetPCCount()
        local barrack_all = acc_info:GetBarrackPCCount()
        for order = 0, layer_pc_count - 1 do
            local pc_info = acc_info:GetPCByIndex(order)
            if pc_info then
                local pc_apc = pc_info:GetApc()
                local pc_name = pc_apc:GetName()
                local pc_cid = pc_info:GetCID()
                local existing_data = g.ilv_settings.chars[pc_name] or {}
                g.ilv_settings.chars[pc_name] = {
                    layer = g.ilv_layer or existing_data.layer or 9,
                    order = order,
                    hide = existing_data.hide or false,
                    memo = existing_data.memo or "",
                    president_jobid = existing_data.president_jobid or "",
                    jobid = existing_data.jobid or "",
                    raid_count = existing_data.raid_count or {},
                    auto_clear_count = existing_data.auto_clear_count or {},
                    cid = pc_cid,
                    pc_name = pc_name,
                    level = pc_apc:GetLv() or existing_data.level or 0
                }
            end
        end
        if barrack_all > 0 then
            local barrack_chars = {}
            for i = 0, barrack_all - 1 do
                local pc_info = acc_info:GetBarrackPCByIndex(i)
                if pc_info then
                    barrack_chars[pc_info:GetName()] = true
                end
            end
            local chars_to_delete = {}
            for char_name, _ in pairs(g.ilv_settings.chars) do
                if not barrack_chars[char_name] then
                    table.insert(chars_to_delete, char_name)
                end
            end
            for _, char_name in ipairs(chars_to_delete) do
                g.ilv_settings.chars[char_name] = nil
            end
        end
        Indun_list_viewer_save_settings()
        return
    end
    if g.get_map_type() == "City" then
        local pc_name = session.GetMySession():GetPCApc():GetName()
        local pc_cid = session.GetMySession():GetCID()
        local existing_data = g.ilv_settings.chars[pc_name] or {}
        g.ilv_settings.chars[pc_name] = {
            layer = g.ilv_layer or existing_data.layer or 1,
            order = existing_data.order or 99,
            hide = existing_data.hide or false,
            memo = existing_data.memo or "",
            president_jobid = existing_data.president_jobid or "",
            jobid = existing_data.jobid or "",
            raid_count = existing_data.raid_count or {},
            auto_clear_count = existing_data.auto_clear_count or {},
            cid = pc_cid,
            pc_name = pc_name,
            level = existing_data.level or 0
        }
        Indun_list_viewer_save_settings()
    end
end

function indun_list_viewer_on_init()
    if _G["BARRACK_CHARLIST_ON_INIT"] and _G["current_layer"] then
        g.ilv_layer = _G["current_layer"]
    end
    if not g.ilv_settings then
        Indun_list_viewer_load_settings()
    end
    local old_func = g.settings.indun_list_viewer.old_init_func
    if _G[old_func] then
        return
    end
    g.addon:RegisterMsg("EXPIREDITEM_ALERT_OPEN", "Indun_list_viewer_EXPIREDITEM_ALERT_ON_MSG")
    if g.get_map_type() == "City" then
        Indun_list_viewer_char_load_settings()
        Indun_list_viewer_sort_characters()
        Indun_list_viewer_raid_reset_reserve()
        Indun_list_viewer_save_current_char_counts()
    end
    if g.settings.indun_list_viewer.use == 0 then
        if _G["indun_list_viewer_title_frame_open"] == _G["Indun_list_viewer_title_frame_open"] then
            _G["indun_list_viewer_title_frame_open"] = nil
        end
    else
        if type(_G["Indun_list_viewer_title_frame_open"]) == "function" then
            if type(_G["indun_list_viewer_title_frame_open"]) ~= "function" then
                _G["indun_list_viewer_title_frame_open"] = _G["Indun_list_viewer_title_frame_open"]
            end
        end
    end
    g.addon:RegisterMsg("ESCAPE_PRESSED", "Indun_list_viewer_ESCAPE_PRESSED")
    g.setup_hook_and_event(g.addon, "STATUS_SELET_REPRESENTATION_CLASS",
        "Indun_list_viewer_STATUS_SELET_REPRESENTATION_CLASS", true)
    g.setup_hook(Indun_list_viewer_EXPIREDITEM_ALERT_OK_BTN, "EXPIREDITEM_ALERT_OK_BTN")
end

function Indun_list_viewer_CHECK_ALERT(type)
    if g.settings.indun_list_viewer.use == 0 then
        return false
    end
    type = type or "Barrack" -- typeが無い場合はBarrack扱い
    if type == "Barrack" or type == "Logout" or type == "Exit" then
        local expireditem_alert = ui.GetFrame("expireditem_alert")
        local near_future_sec = tonumber(expireditem_alert:GetUserConfig("NearFutureSec"))
        local need_item = false
        local need_token = false
        if near_future_sec then
            local list = GET_SCHEDULED_TO_EXPIRED_ITEM_LIST(near_future_sec)
            need_item = (list ~= nil and #list > 0)
            need_token = IS_NEED_TO_ALERT_TOKEN_EXPIRATION(near_future_sec)
        end
        local sweep_buffs = {80045, 80043, 80039, 80035, 80037, 80032, 80031, 80030, 80015, 80017, 80016}
        local sweep_tbl = {}
        local my_handle = session.GetMyHandle()
        local limit_time_ms = 12 * 60 * 60 * 1000
        for _, buff_id in ipairs(sweep_buffs) do
            local buff_info = info.GetBuff(my_handle, buff_id)
            if buff_info and buff_info.time <= limit_time_ms then
                table.insert(sweep_tbl, {
                    buff_over = buff_info.over,
                    buff_time = buff_info.time,
                    buff_id = buff_id
                })
            end
        end
        if need_item or need_token or #sweep_tbl > 0 then
            Indun_list_viewer_EXPIREDITEM_ALERT_OPEN(nil, type, sweep_tbl)
            return true -- 警告あり
        end
    end
    return false -- 警告なし
end

function Indun_list_viewer_EXPIREDITEM_ALERT_OPEN(frame, arg_str, tbl, cid, layer)
    local expireditem_alert = ui.GetFrame("expireditem_alert")
    local near_future_sec = tonumber(expireditem_alert:GetUserConfig("NearFutureSec"))
    local itemlist = GET_CHILD(expireditem_alert, "itemlist", "ui::CGroupBox")
    itemlist:RemoveAllChild()
    local start_index = 0
    local ypos = 0
    if tbl then
        for key, data in ipairs(tbl) do
            if type(data) == "table" then
                local ctrlset = itemlist:CreateOrGetControlSet("expireditem_ctrlset",
                    "expireditem_ctrlset" .. start_index + 1, 0, ypos)
                AUTO_CAST(ctrlset)
                local name = GET_CHILD_RECURSIVELY(ctrlset, "name", "ui::CRichText")
                local expiration_time = GET_CHILD_RECURSIVELY(ctrlset, "expirationTime", "ui::CRichText")
                local remaining_time = GET_CHILD_RECURSIVELY(ctrlset, "remainingTime", "ui::CRichText")
                local item_pic = GET_CHILD_RECURSIVELY(ctrlset, "item_pic", "ui::CPicture")
                local buff_cls = GetClassByType("Buff", data.buff_id)
                if buff_cls then
                    name:SetTextByKey("itemname", buff_cls.Name)
                    local icon_name = "icon_" .. buff_cls.Icon
                    item_pic:SetImage(icon_name)
                end
                local expiration_systime = geTime.GetServerSystemTime()
                expiration_systime = imcTime.AddSec(expiration_systime, data.buff_time / 1000)
                expiration_time:SetTextByKey("year", expiration_systime.wYear)
                expiration_time:SetTextByKey("month", GET_TWO_DIGIT_STR(expiration_systime.wMonth))
                expiration_time:SetTextByKey("day", GET_TWO_DIGIT_STR(expiration_systime.wDay))
                local buff_time = data.buff_time / 1000
                local days = math.floor(buff_time / 86400)
                local hours = math.floor((buff_time % 86400) / 3600)
                local mins = math.floor(((buff_time % 86400) % 3600) / 60)
                local sec = ((buff_time % 86400) % 3600) % 60
                local dif_sec_msg = ""
                if days > 0 then
                    dif_sec_msg = ScpArgMsg("{Day}Day{Hour}Hour{Min}Min", "Day", days, "Hour", hours, "Min", mins)
                elseif hours > 0 then
                    dif_sec_msg = ScpArgMsg("{Hour}Hour{Min}Min{Sec}Sec", "Hour", hours, "Min", mins, "Sec", sec)
                elseif mins > 0 then
                    dif_sec_msg = ScpArgMsg("{Min}Min{Sec}Sec", "Min", mins, "Sec", sec)
                else
                    dif_sec_msg = ScpArgMsg("{Sec}Sec", "Sec", sec)
                end
                remaining_time:SetText(dif_sec_msg)
                local time_parent = remaining_time:GetParent()
                local amend_h = remaining_time:GetY() + remaining_time:GetHeight()
                if amend_h < time_parent:GetHeight() then
                    amend_h = ctrlset:GetHeight()
                else
                    local addedHeight = amend_h - time_parent:GetHeight()
                    ctrlset:Resize(ctrlset:GetWidth(), ctrlset:GetHeight() + addedHeight)
                end
                ypos = ypos + ctrlset:GetHeight()
                start_index = start_index + 1
            end
        end
    end
    if IS_NEED_TO_ALERT_TOKEN_EXPIRATION(near_future_sec, itemlist) then
        ypos = ASK_EXPIREDITEM_ALERT_TOKEN(expireditem_alert, itemlist, start_index, ypos)
        start_index = start_index + 1
    end
    local list = GET_SCHEDULED_TO_EXPIRED_ITEM_LIST(near_future_sec)
    if list and #list >= 1 then
        ypos = ASK_EXPIREDITEM_ALERT_LIFETIME(expireditem_alert, itemlist, near_future_sec, start_index, ypos)
        start_index = start_index + #list
    end
    expireditem_alert:Resize(expireditem_alert:GetWidth(), expireditem_alert:GetOriginalHeight() + itemlist:GetHeight())
    if arg_str then
        expireditem_alert:SetUserValue("TimerType", arg_str)
    end
    if cid then
        expireditem_alert:SetUserValue("CC_CID", cid)
        expireditem_alert:SetUserValue("CC_LAYER", layer or 0)
    else
        expireditem_alert:SetUserValue("CC_CID", "None")
    end
    expireditem_alert:ShowWindow(1)
end

local function get_safe_entrance_count(indun_type)
    local indun_cls = GetClassByType("Indun", indun_type)
    if indun_cls and indun_cls.PlayPerResetType then
        return GET_CURRENT_ENTERANCE_COUNT(indun_cls.PlayPerResetType)
    end
    return nil
end

function Indun_list_viewer_save_current_char_counts()
    if g.get_map_type() ~= "City" then
        return
    end
    local raid_data = {}
    for key, raid in pairs(g.ilv_RAID_INFO) do
        local count = raid.hard and get_safe_entrance_count(raid.hard)
        raid_data[key .. "_H"] = count or "?"
        count = get_safe_entrance_count(raid.auto)
        raid_data[key .. "_A"] = count or "?"
    end
    g.ilv_settings.chars[g.login_name].raid_count = raid_data
    g.ilv_settings.chars[g.login_name].level = info.GetLevel(session.GetMyHandle()) or 0
    local auto_clear_data = g.ilv_settings.chars[g.login_name].auto_clear_count
    local my_handle = session.GetMyHandle()
    for _, key in ipairs(g.ilv_RAID_KEYS) do
        local raid = g.ilv_RAID_INFO[key]
        auto_clear_data[key .. "_S"] = 0
        if raid.sweep_buff then
            local buff_info = info.GetBuff(my_handle, raid.sweep_buff)
            if buff_info then
                auto_clear_data[key .. "_S"] = buff_info.over
            end
        end
    end
    g.ilv_settings.chars[g.login_name].auto_clear_count = auto_clear_data
    Indun_list_viewer_save_settings()
end

function Indun_list_viewer_EXPIREDITEM_ALERT_ON_MSG(frame, msg, str, num)
    local expireditem_alert = ui.GetFrame("expireditem_alert")
    if expireditem_alert then
        expireditem_alert:SetLayerLevel(100)
    end
end

function Indun_list_viewer_raid_reset_reserve()
    local server_time_str = date_time.get_lua_now_datetime_str()
    if server_time_str then
        local y, m, d, H, M, S = server_time_str:match("(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)")
        if y then
            local server_now_timestamp = os.time({
                year = tonumber(y),
                month = tonumber(m),
                day = tonumber(d),
                hour = tonumber(H),
                min = tonumber(M),
                sec = tonumber(S)
            })
            if server_now_timestamp > g.ilv_settings.options.reset_time then
                Indun_list_viewer_raid_reset()
            end
        end
    end
end

function Indun_list_viewer_raid_reset()
    local acc_info = session.barrack.GetMyAccount()
    local barrack_pc_count = acc_info:GetBarrackPCCount() -- ゲーム起動直後はtonumber(0)そのため初期化は2回目以降
    if barrack_pc_count > 0 then
        for i = 0, barrack_pc_count - 1 do
            local barrack_pc_info = acc_info:GetBarrackPCByIndex(i)
            if barrack_pc_info then
                local barrack_pc_name = barrack_pc_info:GetName()
                local char_data = g.ilv_settings.chars[barrack_pc_name]
                if char_data then
                    char_data.raid_count = {}
                    for _, key in ipairs(g.ilv_RAID_KEYS) do
                        char_data.raid_count[key .. "_H"] = "?"
                        char_data.raid_count[key .. "_A"] = "?"
                    end
                end
            end
        end
        g.ilv_settings.options.reset_time = Indun_list_viewer_get_reset_time()
        Indun_list_viewer_save_settings()
        if g.settings.indun_list_viewer.use ~= 0 then
            if g.lang == "Japanese" then
                ui.SysMsg("[ILV]レイドの回数を初期化しました")
            else
                ui.SysMsg("[ILV]Raid counts were initialized")
            end
        end
    end
end

function Indun_list_viewer_get_reset_time()
    local server_time_str = date_time.get_lua_now_datetime_str()
    if not server_time_str then
        return 0
    end
    local year, month, day, hour, min, sec = server_time_str:match("(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)")
    if not year then
        return 0
    end
    local now_table = {
        year = tonumber(year),
        month = tonumber(month),
        day = tonumber(day),
        hour = tonumber(hour),
        min = tonumber(min),
        sec = tonumber(sec)
    }
    local now_timestamp = os.time(now_table)
    local current_day_of_week = tonumber(os.date("%w", now_timestamp)) + 1
    local days_to_next_monday
    if current_day_of_week == 2 and now_table.hour < 6 then
        days_to_next_monday = 0
    else
        days_to_next_monday = (9 - current_day_of_week) % 7
        if days_to_next_monday == 0 then
            days_to_next_monday = 7
        end
    end
    local next_monday_timestamp_base = now_timestamp + days_to_next_monday * 86400
    local next_monday_date = os.date("*t", next_monday_timestamp_base)
    local next_monday_6am_timestamp = os.time({
        year = next_monday_date.year,
        month = next_monday_date.month,
        day = next_monday_date.day,
        hour = 6,
        min = 0,
        sec = 0
    })
    return next_monday_6am_timestamp
end

function Indun_list_viewer_sort_characters()
    g.ilv_sorted_settings = {}
    for key, data in pairs(g.ilv_settings.chars) do
        if type(data) == "table" then
            table.insert(g.ilv_sorted_settings, data)
        end
    end
    local function sort_layer_order(a, b)
        if a.layer ~= b.layer then
            return a.layer < b.layer
        else
            return a.order < b.order
        end
    end
    table.sort(g.ilv_sorted_settings, sort_layer_order)
end

function Indun_list_viewer_STATUS_SELET_REPRESENTATION_CLASS(my_frame, my_msg)
    if not g.ilv_settings then
        return
    end
    local _, select_key = g.get_event_args(my_msg)
    local pc_job_info = session.GetMainSession():GetPCJobInfo()
    local job_count = pc_job_info:GetJobCount()
    local job_id_parts = {}
    for i = 0, job_count - 1 do
        local job_info = pc_job_info:GetJobInfoByIndex(i)
        table.insert(job_id_parts, job_info.jobID)
    end
    g.ilv_settings.chars[g.login_name].jobid = "/" .. table.concat(job_id_parts, "/")
    g.ilv_settings.chars[g.login_name].president_jobid = tostring(select_key)
    Indun_list_viewer_save_settings()
    Indun_list_viewer_title_frame_open()
end

function Indun_list_viewer_INDUNINFO_SET_BUTTONS(indun_type, ctrl)
    local indun_cls = GetClassByType("Indun", indun_type)
    local dungeon_type = TryGetProp(indun_cls, "DungeonType", "None")
    local btn_info_cls = GetClassByStrProp("IndunInfoButton", "DungeonType", dungeon_type)
    if dungeon_type == "Raid" then
        btn_info_cls = INDUNINFO_SET_BUTTONS_FIND_CLASS(indun_cls)
    end
    local red_button_scp = TryGetProp(btn_info_cls, "RedButtonScp")
    ctrl:SetUserValue("MOVE_INDUN_CLASSID", indun_cls.ClassID)
    ctrl:SetEventScript(ui.LBUTTONUP, red_button_scp)
end

function Indun_list_viewer_enter_hard(parent, ctrl, str, indun_type)
    if str == "false" then
        Indun_list_viewer_INDUNINFO_SET_BUTTONS(indun_type, ctrl)
        ReserveScript(string.format("Indun_list_viewer_enter_hard(nil, nil, 'true', %d)", indun_type), 0.5)
    else
        SHOW_INDUNENTER_DIALOG(indun_type)
        local indun_list_viewer = parent:GetTopParentFrame()
        ui.DestroyFrame(indun_list_viewer:GetName())
    end
end

function Indun_list_viewer_enter_solo_or_auto(parent, ctrl, move_type_str, indun_type)
    local move_type = tonumber(move_type_str)
    ReqRaidAutoUIOpen(indun_type)
    if move_type == 2 then
        local indunenter = ui.GetFrame("indunenter")
        local indun_cls = GetClassByType("Indun", indunenter:GetUserValue("INDUN_TYPE"))
        local min_rank = TryGetProp(indun_cls, "PCRank")
        if min_rank and min_rank > session.GetPcTotalJobGrade() then
            ui.SysMsg(ScpArgMsg("IndunEnterNeedPCRank", "NEED_RANK", min_rank))
            return
        end
    end
    ReserveScript(string.format("ReqMoveToIndun(%d, 0)", move_type), 0.3)
    local indun_list_viewer = parent:GetTopParentFrame()
    ui.DestroyFrame(indun_list_viewer:GetName())
end

function Indun_list_viewer_config(parent)
    local indun_list_viewer = parent:GetTopParentFrame()
    if not indun_list_viewer then
        indun_list_viewer = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "indun_list_viewer", 0, 0, 10, 10)
        AUTO_CAST(indun_list_viewer)
    end
    indun_list_viewer:RemoveAllChild()
    local title_gb = indun_list_viewer:CreateOrGetControl("groupbox", "title_gb", 0, 0, 10, 10)
    AUTO_CAST(title_gb)
    local config_gb = indun_list_viewer:CreateOrGetControl("groupbox", "config_gb", 10, 35, 10, 10)
    AUTO_CAST(config_gb)
    config_gb:SetSkinName("bg")
    local text = config_gb:CreateOrGetControl("richtext", "text", 10, 10)
    AUTO_CAST(text)
    text:SetText(g.lang == "Japanese" and "チェックすると表示" or "{ol}Check to show")
    local x = text:GetX() + text:GetWidth() + 5
    local text_x = 0
    for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
        local raid_info = g.ilv_RAID_INFO[raid_key]
        if raid_info.hard then
            if text_x == 0 then
                text_x = x
            end
            local pic = title_gb:CreateOrGetControl("picture", "title_pic_" .. raid_key .. "_H", x + 5, 5, 30, 30)
            AUTO_CAST(pic)
            pic:SetImage(raid_info.icon)
            pic:SetEnableStretch(1)
            pic:EnableHitTest(1)
            local check = config_gb:CreateOrGetControl("checkbox", "check_" .. raid_key .. "_H", x, 5, 30, 30)
            AUTO_CAST(check)
            check:SetCheck(g.ilv_settings.display[raid_info.name .. "_H"])
            check:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_display_check")
            check:SetEventScriptArgString(ui.LBUTTONDOWN, raid_info.name .. "_H")
            x = x + 30
        end
    end
    local hard_text = title_gb:CreateOrGetControl("richtext", "hard_text", text_x - 40, 10)
    AUTO_CAST(hard_text)
    hard_text:SetText("{ol}Hard")
    x = x + 100
    text_x = 0
    for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
        local raid_info = g.ilv_RAID_INFO[raid_key]
        if text_x == 0 then
            text_x = x
        end
        local pic = title_gb:CreateOrGetControl("picture", "title_pic_" .. raid_key .. "_S", x + 5, 5, 30, 30)
        AUTO_CAST(pic)
        pic:SetImage(raid_info.icon)
        pic:SetEnableStretch(1)
        pic:EnableHitTest(1)
        local check = config_gb:CreateOrGetControl("checkbox", "check_" .. raid_key .. "_S", x, 5, 30, 30)
        AUTO_CAST(check)
        check:SetCheck(g.ilv_settings.display[raid_info.name .. "_S"])
        check:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_display_check")
        check:SetEventScriptArgString(ui.LBUTTONDOWN, raid_info.name .. "_S")
        x = x + 30
    end
    local auto_text = title_gb:CreateOrGetControl("richtext", "auto_text", text_x - 80, 10)
    AUTO_CAST(auto_text)
    auto_text:SetText("{ol}Solo/Auto")
    x = x + 30
    local memo_text = title_gb:CreateOrGetControl("richtext", "memo_text", x, 10)
    AUTO_CAST(memo_text)
    memo_text:SetText("{ol}Memo")
    local memo_check = config_gb:CreateOrGetControl("checkbox", "check_memo", x, 5, 30, 30)
    AUTO_CAST(memo_check)
    memo_check:SetCheck(g.ilv_settings.display["Memo"])
    memo_check:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_display_check")
    memo_check:SetEventScriptArgString(ui.LBUTTONDOWN, "Memo")
    local close_button = title_gb:CreateOrGetControl("button", "close_button", 0, 0, 20, 20)
    AUTO_CAST(close_button)
    close_button:SetImage("testclose_button")
    close_button:SetGravity(ui.LEFT, ui.TOP)
    close_button:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_close")
    close_button:SetEventScriptArgNumber(ui.LBUTTONUP, 1)
    title_gb:Resize(x + 50, 55)
    indun_list_viewer:Resize(title_gb:GetWidth() + 20, 85)
    config_gb:Resize(indun_list_viewer:GetWidth() - 20, indun_list_viewer:GetHeight() - 45)
end

function Indun_list_viewer_display_check(parent, ctrl, key, num)
    g.ilv_settings.display[key] = ctrl:IsChecked() == 1 and 1 or 0
    Indun_list_viewer_save_settings()
end

function Indun_list_viewer_title_frame_open()
    Indun_list_viewer_save_current_char_counts()
    if g.settings.indun_list_viewer.use == 0 then
        return
    end
    local indun_list_viewer = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "indun_list_viewer", 0, 0, 10, 10)
    AUTO_CAST(indun_list_viewer)
    indun_list_viewer:RemoveAllChild()
    indun_list_viewer:SetLayerLevel(99)
    indun_list_viewer:SetSkinName("test_frame_low")
    local title_gb = indun_list_viewer:CreateOrGetControl("groupbox", "title_gb", 0, 0, 10, 10)
    AUTO_CAST(title_gb)
    local texts = (g.lang == "Japanese") and {
        hard_raid = "ハード",
        auto_raid = "左クリック:ソロ入場{nl}右クリック:自動入場{nl} {nl}入場回数/掃討回数",
        mode_text = "チェックを入れるとスクロールモードに切替",
        display_text = "チェックしたキャラはレイド回数非表示",
        memo = "メモ",
        display = "表示",
        hidden = "チェックを入れると非表示キャラを表示しません"
    } or {
        hard_raid = "Hard Count",
        auto_raid = "Left-click: Solo Entry{nl}Right-click: Automatic Entry{nl} {nl}Entry Count/Auto clear count",
        mode_text = "Switch to scroll mode when checked",
        display_text = "Checked characters hide raid count",
        memo = "Memo",
        display = "Disp",
        hidden = "If checked, do not show hidden characters"
    }
    local x = 185
    for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
        local raid_info = g.ilv_RAID_INFO[raid_key]
        if raid_info and raid_info.name then -- ここで安全確認
            if raid_info.hard and g.ilv_settings.display[raid_info.name .. "_H"] == 1 then
                local pic = title_gb:CreateOrGetControl("picture", "title_pic_" .. raid_key .. "_H", x, 5, 30, 30)
                AUTO_CAST(pic)
                pic:SetImage(raid_info.icon)
                pic:SetEnableStretch(1)
                pic:EnableHitTest(1)
                pic:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_enter_hard")
                pic:SetEventScriptArgNumber(ui.LBUTTONDOWN, raid_info.hard)
                pic:SetEventScriptArgString(ui.LBUTTONDOWN, "false")
                pic:SetTextTooltip("{ol}" .. texts.hard_raid)
                x = x + 30
            end
        end
    end
    x = x + 30
    for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
        local raid_info = g.ilv_RAID_INFO[raid_key]
        if raid_info and raid_info.name then -- ここで安全確認
            if g.ilv_settings.display[raid_info.name .. "_S"] == 1 then
                local pic = title_gb:CreateOrGetControl("picture", "title_pic_" .. raid_key .. "_S", x, 5, 30, 30)
                AUTO_CAST(pic)
                pic:SetImage(raid_info.icon)
                pic:SetEnableStretch(1)
                pic:EnableHitTest(1)
                pic:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_enter_solo_or_auto")
                pic:SetEventScriptArgString(ui.LBUTTONUP, "1")
                pic:SetEventScriptArgNumber(ui.LBUTTONUP, raid_info.solo)
                pic:SetEventScript(ui.RBUTTONUP, "Indun_list_viewer_enter_solo_or_auto")
                pic:SetEventScriptArgString(ui.RBUTTONUP, "2")
                pic:SetEventScriptArgNumber(ui.RBUTTONUP, raid_info.auto)
                pic:SetTextTooltip("{ol}" .. texts.auto_raid)
                x = x + 65
            end
        end
    end
    local close_button = title_gb:CreateOrGetControl("button", "close_button", 0, 0, 20, 20)
    AUTO_CAST(close_button)
    close_button:SetImage("testclose_button")
    close_button:SetGravity(ui.LEFT, ui.TOP)
    close_button:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_close")
    local cc_button = title_gb:CreateOrGetControl("button", "cc_button", 40, 5, 30, 30)
    AUTO_CAST(cc_button)
    cc_button:SetSkinName("None")
    cc_button:SetText("{img barrack_button_normal 30 30}")
    cc_button:SetEventScript(ui.LBUTTONUP, "_nexus_addons_APPS_TRY_MOVE_BARRACK")
    local config_btn = title_gb:CreateOrGetControl("button", "config_btn", 75, 5, 30, 30)
    AUTO_CAST(config_btn)
    config_btn:SetSkinName("None")
    config_btn:SetText("{img config_button_normal 30 30}")
    config_btn:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_config")
    local mode_check = title_gb:CreateOrGetControl("checkbox", "mode_check", 115, 5, 30, 30)
    AUTO_CAST(mode_check)
    mode_check:SetCheck(g.ilv_settings.options.display_mode == "slide" and 1 or 0)
    mode_check:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_modechange")
    mode_check:SetTextTooltip("{ol}" .. texts.mode_text)
    local hidden_check = title_gb:CreateOrGetControl("checkbox", "hidden_check", 150, 5, 30, 30)
    AUTO_CAST(hidden_check)
    hidden_check:SetCheck(g.ilv_settings.options.hidden)
    hidden_check:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_modechange")
    hidden_check:SetTextTooltip("{ol}" .. texts.hidden)
    if g.ilv_settings.display["Memo"] == 1 then
        local memo_text = title_gb:CreateOrGetControl("richtext", "memo_text", x, 10)
        AUTO_CAST(memo_text)
        memo_text:SetText("{ol}" .. texts.memo)
        x = x + 160
    end
    local display_text = title_gb:CreateOrGetControl("richtext", "display_text", x, 10)
    AUTO_CAST(display_text)
    display_text:SetText("{ol}" .. texts.display)
    display_text:SetTextTooltip("{ol}" .. texts.display_text)
    indun_list_viewer:ShowWindow(1)
    Indun_list_viewer_frame_open(indun_list_viewer)
end

function Indun_list_viewer_ESCAPE_PRESSED()
    local indun_list_viewer = ui.GetFrame(addon_name_lower .. "indun_list_viewer")
    Indun_list_viewer_close(indun_list_viewer)
end

function Indun_list_viewer_close(parent, ctrl, str, num)
    local indun_list_viewer = parent:GetTopParentFrame()
    ui.DestroyFrame(indun_list_viewer:GetName())
    if num == 1 then
        ReserveScript("Indun_list_viewer_title_frame_open()", 0.1)
    end
end

function Indun_list_viewer_modechange(parent, ctrl)
    local ctrl_name = ctrl:GetName()
    local is_checked = ctrl:IsChecked()
    if ctrl_name == "hidden_check" then
        g.ilv_settings.options.hidden = is_checked
    else -- mode_check
        g.ilv_settings.options.display_mode = is_checked == 1 and "slide" or "full"
    end
    Indun_list_viewer_save_settings()
    Indun_list_viewer_title_frame_open()
end

function Indun_list_viewer_frame_open(indun_list_viewer)
    local title_gb = GET_CHILD(indun_list_viewer, "title_gb")
    AUTO_CAST(title_gb)
    local gb = indun_list_viewer:CreateOrGetControl("groupbox", "gb", 10, 35, 10, 10)
    AUTO_CAST(gb)
    gb:SetSkinName("bg")
    local sorted_char_list = {}
    for _, data in ipairs(g.ilv_sorted_settings) do
        if type(data) == "table" then
            if g.ilv_settings.options.hidden == 0 or not data.hide then
                table.insert(sorted_char_list, data)
            end
        end
    end
    local y = 10
    local max_x = 0
    if not g.ilv_RAID_KEYS or not g.ilv_RAID_INFO then
        return
    end
    for _, data in ipairs(sorted_char_list) do
        local x = 35
        local pc_name = data.pc_name
        if g.login_name == pc_name then
            local row_bg = gb:CreateOrGetControl("groupbox", "row_bg_current", 0, y - 2, 3000, 25)
            AUTO_CAST(row_bg)
            row_bg:SetSkinName("bg")
            row_bg:SetColorTone("AA444444")
        end
        local name = gb:CreateOrGetControl("richtext", pc_name, x, y)
        AUTO_CAST(name)
        local level_str = data.level and data.level > 0 and " (" .. data.level .. ")" or ""
        name:SetText(("{ol}{s14}" .. (g.login_name == pc_name and "{#FF4500}" or "") .. pc_name .. level_str))
        Indun_list_viewer_job_slot(indun_list_viewer, data, y)
        x = x + 60
        if not data.hide then
            local current_x = 180
            local raid_count_data = data.raid_count or {}
            local auto_clear_data = data.auto_clear_count or {}
            for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
                local raid_info = g.ilv_RAID_INFO[raid_key]
                if raid_info and raid_info.name and raid_info.hard then
                    if g.ilv_settings.display[raid_info.name .. "_H"] == 1 then
                        local count = raid_count_data[raid_key .. "_H"] or "?"
                        local text_ctrl = gb:CreateOrGetControl("richtext", raid_key .. "_H_" .. pc_name, current_x, y)
                        AUTO_CAST(text_ctrl)
                        text_ctrl:SetText("{ol}{s14}( " .. count .. " )")
                        local limit = (raid_key == "P" or raid_key == "F") and 2 or 1
                        local num_count = tonumber(count) or 0
                        text_ctrl:SetColorTone(num_count >= limit and "FF990000" or "FFFFFFFF")
                        current_x = current_x + 30
                    end
                end
            end
            current_x = current_x + 30
            for _, raid_key in ipairs(g.ilv_RAID_KEYS) do
                local raid_info = g.ilv_RAID_INFO[raid_key]
                if raid_info and raid_info.name then
                    if g.ilv_settings.display[raid_info.name .. "_S"] == 1 then
                        local limit = (raid_key == "P" or raid_key == "F") and 4 or 2
                        local count_a = raid_count_data[raid_key .. "_A"] or "?"
                        local text_a = gb:CreateOrGetControl("richtext", raid_key .. "_A_" .. pc_name, current_x, y)
                        AUTO_CAST(text_a)
                        text_a:SetText("{ol}{s14}( " .. count_a .. " )")
                        local num_a = tonumber(count_a)
                        if num_a and num_a > 0 then
                            text_a:SetColorTone(num_a == limit and "FF990000" or "FFFFFFFF")
                        end
                        if raid_key ~= "D" then
                            current_x = current_x + 25
                            local count_s = auto_clear_data[raid_key .. "_S"] or 0
                            local text_s = gb:CreateOrGetControl("richtext", raid_key .. "_S_" .. pc_name, current_x, y)
                            AUTO_CAST(text_s)
                            text_s:SetText("{ol}{s14}/( " .. count_s .. " )")
                            local num_s = tonumber(count_s)
                            if num_s and num_s > 0 then
                                -- text_s:SetColorTone(num_s == limit and "FFFFA500" or "FFFFFFFF")
                                text_s:SetColorTone("FFFFA500")
                            end
                        end
                        current_x = current_x + 40
                    end
                end
            end
            if g.ilv_settings.display["Memo"] == 1 then
                local memo = gb:CreateOrGetControl("edit", "memo" .. pc_name, current_x, y - 2, 180, 20)
                AUTO_CAST(memo)
                memo:SetFontName("white_14_ol")
                memo:SetTextAlign("left", "center")
                memo:SetSkinName("inventory_serch")
                memo:SetEventScript(ui.ENTERKEY, "Indun_list_viewer_memo_save")
                memo:SetEventScriptArgString(ui.ENTERKEY, pc_name)
                memo:SetText(data.memo or "")
                current_x = current_x + 180
            end
            x = current_x
        end
        if x > max_x then
            max_x = x
        end
        y = y + 25
    end
    local display_x = max_x + 20
    y = 10
    for _, data in ipairs(sorted_char_list) do
        local pc_name = data.pc_name
        local line = gb:CreateOrGetControl("labelline", "line" .. pc_name, 25, y + 20, max_x - 20, 1)
        AUTO_CAST(line)
        line:SetSkinName("labelline_def_3")
        local display_check = gb:CreateOrGetControl("checkbox", "display" .. pc_name, display_x, y - 5, 25, 25)
        AUTO_CAST(display_check)
        display_check:SetEventScript(ui.LBUTTONUP, "Indun_list_viewer_display_save")
        display_check:SetEventScriptArgString(ui.LBUTTONUP, pc_name)
        display_check:SetCheck(data.hide and 1 or 0)
        y = y + 25
    end
    local frame_width = display_x + 60
    local frame_height = y + 50
    if g.ilv_settings.options.display_mode == "slide" and frame_height > 545 then
        frame_height = 545
        gb:EnableScrollBar(1)
    end
    indun_list_viewer:Resize(frame_width, frame_height)
    gb:Resize(indun_list_viewer:GetWidth() - 20, indun_list_viewer:GetHeight() - 45)
    title_gb:Resize(indun_list_viewer:GetWidth() - 20, 55)
    local display_text = GET_CHILD_RECURSIVELY(indun_list_viewer, "display_text")
    if display_text then
        AUTO_CAST(display_text)
        display_text:SetPos(display_x, 10)
    end
    local map_frame = ui.GetFrame("map")
    indun_list_viewer:SetPos((map_frame:GetWidth() - indun_list_viewer:GetWidth()) / 2, 35)
end

function Indun_list_viewer_job_slot(indun_list_viewer, data, y)
    local pc_name = data.pc_name
    local job_id_str = data.jobid or ""
    local president_id_str = data.president_jobid or ""
    local _, _, last_job_id = GetJobListFromAdventureBookCharData(pc_name)
    local prepresentative_job_id = (president_id_str ~= "") and president_id_str or last_job_id
    local job_class = GetClassByType("Job", tonumber(prepresentative_job_id) or 0)
    local job_icon_name = "icon_item_nothing" -- デフォルト（?マークや空）
    if job_class then
        job_icon_name = TryGetProp(job_class, "Icon", "icon_item_nothing")
    end
    local gb = GET_CHILD_RECURSIVELY(indun_list_viewer, "gb")
    local job_slot = gb:CreateOrGetControl("slot", "jobslot" .. pc_name, 5, y - 4, 25, 25)
    AUTO_CAST(job_slot)
    job_slot:SetSkinName("None")
    job_slot:EnableHitTest(1)
    job_slot:EnablePop(0)
    local job_icon = CreateIcon(job_slot)
    job_icon:SetImage(job_icon_name)
    local tooltip_parts = {}
    if job_id_str ~= "" then
        local highlight_color = "{#FF0000}"
        for id_str in job_id_str:gmatch("/([^/]+)") do
            local job_id_num = tonumber(id_str)
            if job_id_num then
                local cls = GetClassByType("Job", job_id_num)
                if cls and cls.Name then
                    local name = (string.gsub(dic.getTranslatedStr(cls.Name), "{s18}", ""))
                    if id_str == president_id_str then
                        table.insert(tooltip_parts, highlight_color .. name .. "{/}")
                    else
                        table.insert(tooltip_parts, name)
                    end
                end
            end
        end
    else
        if job_class and job_class.Name then
            local name = TryGetProp(job_class, "Name")
            table.insert(tooltip_parts, (string.gsub(dic.getTranslatedStr(name), "{s18}", "")))
        end
    end
    local tooltip_text = "{ol}" .. table.concat(tooltip_parts, "{nl}")
    if g.login_name == pc_name then
        local r_click_text = (g.lang == "Japanese") and "右クリック: 表示アイコン選択" or
                                 "Right-click: Select Display Icon"
        tooltip_text = tooltip_text .. "{nl} {nl}" .. r_click_text
        job_slot:SetEventScript(ui.RBUTTONDOWN, "STATUS_OPEN_CLASS_DROPLIST")
        local name_text = GET_CHILD_RECURSIVELY(gb, pc_name)
        name_text:SetEventScript(ui.RBUTTONDOWN, "STATUS_OPEN_CLASS_DROPLIST")
    end
    if type(_G["INSTANTCC_ON_INIT"]) == "function" and g.settings.instant_cc.use == 1 then -- InstantCCアドオン連携
        local cc_text = (g.lang == "Japanese") and "左クリック: キャラクターチェンジ" or
                            "Left-click: Character Change"
        tooltip_text = tooltip_text .. "{nl} {nl}{#FF4500}" .. cc_text
        job_slot:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_INSTANTCC_DO_CC")
        job_slot:SetEventScriptArgString(ui.LBUTTONDOWN, data.cid)
        job_slot:SetEventScriptArgNumber(ui.LBUTTONDOWN, data.layer)
        local name_text = GET_CHILD_RECURSIVELY(gb, pc_name)
        name_text:SetEventScript(ui.LBUTTONDOWN, "Indun_list_viewer_INSTANTCC_DO_CC")
        name_text:SetEventScriptArgString(ui.LBUTTONDOWN, data.cid)
        name_text:SetEventScriptArgNumber(ui.LBUTTONDOWN, data.layer)
        name_text:SetTextTooltip(tooltip_text)
    end
    job_icon:SetTextTooltip(tooltip_text)
end

function Indun_list_viewer_INSTANTCC_DO_CC(parent, ctrl, cid, layer)
    if ui.CheckHoldedUI() then
        return
    end
    if g.get_map_type() == "City" then
        Indun_list_viewer_save_current_char_counts()
    end
    local expireditem_alert = ui.GetFrame("expireditem_alert")
    local near_future_sec = tonumber(expireditem_alert:GetUserConfig("NearFutureSec"))
    local need_alert = false
    if near_future_sec then
        local list = GET_SCHEDULED_TO_EXPIRED_ITEM_LIST(near_future_sec)
        if list and #list > 0 then
            need_alert = true
        end
        if IS_NEED_TO_ALERT_TOKEN_EXPIRATION(near_future_sec) then
            need_alert = true
        end
    end
    local sweep_buffs = {80045, 80043, 80039, 80035, 80037, 80032, 80031, 80030, 80015, 80017, 80016}
    local sweep_tbl = {}
    local my_handle = session.GetMyHandle()
    local limit_time_ms = 12 * 60 * 60 * 1000
    for _, buff_id in ipairs(sweep_buffs) do
        local buff_info = info.GetBuff(my_handle, buff_id)
        if buff_info and buff_info.time <= limit_time_ms then
            table.insert(sweep_tbl, {
                buff_over = buff_info.over,
                buff_time = buff_info.time,
                buff_id = buff_id
            })
            need_alert = true
        end
    end
    if need_alert then
        Indun_list_viewer_EXPIREDITEM_ALERT_OPEN(nil, "Barrack", sweep_tbl, cid, layer)
        return
    end
    if _G["INSTANTCC_DO_CC"] then
        _G["INSTANTCC_DO_CC"](cid, layer)
    end
end

function Indun_list_viewer_EXPIREDITEM_ALERT_OK_BTN(frame)
    local timerType = frame:GetUserValue("TimerType")
    local cid = frame:GetUserValue("CC_CID")
    local layer = frame:GetUserIValue("CC_LAYER")
    if cid and cid ~= "None" then
        if not g.instant_cc then
            g.instant_cc = {}
        end -- 安全策
        g.instant_cc.do_cc = {
            cid = cid,
            layer = layer
        }
        RUN_GAMEEXIT_TIMER("Barrack")
        frame:ShowWindow(0)
        return
    end
    RUN_GAMEEXIT_TIMER(timerType)
    frame:ShowWindow(0)
end

function Indun_list_viewer_memo_save(frame, ctrl, pc_name, num)
    if g.ilv_settings.chars[pc_name] then
        g.ilv_settings.chars[pc_name].memo = ctrl:GetText()
        Indun_list_viewer_save_settings()
    end
    ui.SysMsg(g.lang == "Japanese" and "メモを登録しました。" or "MEMO registered.")
end

function Indun_list_viewer_display_save(frame, ctrl, pc_name, num)
    local is_checked = ctrl:IsChecked()
    if g.ilv_settings.chars[pc_name] then
        g.ilv_settings.chars[pc_name].hide = (is_checked == 1)
        Indun_list_viewer_save_settings()
    end
    Indun_list_viewer_title_frame_open()
end
-- indun_list_viewer ここまで

-- characters_item_serch ここから
g.characters_item_serch = g.characters_item_serch or {}
function Characters_item_serch_save_settings()
    g.save_json(g.characters_item_serch_path, g.characters_item_serch_settings)
end

function Characters_item_serch_load_settings()
    g.characters_item_serch_path = string.format("../addons/%s/%s/characters_item_serch.json", addon_name_lower,
        g.active_id)
    g.characters_item_serch_dat_tbl = {string.format("../addons/%s/%s/characters_item_serch_warehouse.dat",
        addon_name_lower, g.active_id),
                                       string.format("../addons/%s/%s/characters_item_serch_inventory.dat",
        addon_name_lower, g.active_id),
                                       string.format("../addons/%s/%s/characters_item_serch_equips.dat",
        addon_name_lower, g.active_id),
                                       string.format("../addons/%s/%s/characters_item_serch_accountwarehouse.dat",
        addon_name_lower, g.active_id)}
    g.characters_item_serch_old_dat_tbl = {string.format("../addons/%s/%s/warehouse.dat", "characters_item_serch",
        g.active_id), string.format("../addons/%s/%s/inventory.dat", "characters_item_serch", g.active_id),
                                           string.format("../addons/%s/%s/equips.dat", "characters_item_serch",
        g.active_id)}

    local settings = g.load_json(g.characters_item_serch_path)
    if not settings then
        settings = {
            chars = {}
        }
    end
    g.characters_item_serch_settings = settings
    Characters_item_serch_save_settings()
    for i = 1, #g.characters_item_serch_dat_tbl - 1 do
        local new_path = g.characters_item_serch_dat_tbl[i]
        local old_path = g.characters_item_serch_old_dat_tbl[i]
        local new_file = io.open(new_path, "r")
        if not new_file then
            local content_to_write = ""
            if old_path then
                local old_file = io.open(old_path, "r")
                if old_file then
                    content_to_write = old_file:read("*all")
                    old_file:close()
                end
            end
            local file_to_write = io.open(new_path, "w")
            if file_to_write then
                file_to_write:write(content_to_write)
                file_to_write:close()
            end
        else
            new_file:close()
        end
    end
end

function characters_item_serch_on_init()
    if _G["BARRACK_CHARLIST_ON_INIT"] and _G["current_layer"] then
        g.characters_item_serch.layer = _G["current_layer"] or 1
    end
    if not g.characters_item_serch_settings then
        Characters_item_serch_load_settings()
    end
    local old_func = g.settings.characters_item_serch.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, "APPS_TRY_LEAVE", "Characters_item_serch_APPS_TRY_LEAVE", true)
    g.setup_hook_and_event(g.addon, "INVENTORY_CLOSE", "Characters_item_serch_INVENTORY_CLOSE", true)
    g.setup_hook_and_event(g.addon, "ACCOUNTWAREHOUSE_CLOSE", "Characters_item_serch_ACCOUNTWAREHOUSE_CLOSE", true)
    g.setup_hook_and_event(g.addon, "'WAREHOUSE_CLOSE", "Characters_item_serch_WAREHOUSE_CLOSE", true)
    local sysmenu = ui.GetFrame("sysmenu")
    local inven = GET_CHILD(sysmenu, "inven")
    AUTO_CAST(inven)
    inven:SetEventScript(ui.RBUTTONUP, "Characters_item_serch_toggle_frame")
    local function get_localized_tooltip(lang)
        if lang == "Japanese" then
            return "{@st59}インベントリ (F2){nl}右クリック: Characters Item Serch"
        elseif lang == "kr" then
            return "{@st59}인벤토리 (F2){nl}Right click: Characters Item Serch"
        else
            return "{@st59}Inventory (F2){nl}Right click: Characters Item Serch"
        end
    end
    local tooltip = get_localized_tooltip(g.lang)
    inven:SetTextTooltip(tooltip)
    Characters_item_serch_char_data()
end

function Characters_item_serch_toggle_frame()
    if g.settings.characters_item_serch.use == 0 then
        return
    end
    local characters_item_serch = ui.GetFrame(addon_name_lower .. "characters_item_serch")
    if not characters_item_serch then
        Characters_item_serch_frame_init(nil, nil, g.login_name, 0)
    elseif characters_item_serch and characters_item_serch:IsVisible() == 0 then
        Characters_item_serch_frame_init(nil, nil, g.login_name, 0)
    elseif characters_item_serch:IsVisible() == 1 then
        Characters_item_serch_close(characters_item_serch)
    end
end

function Characters_item_serch_char_data()
    local chars = g.characters_item_serch_settings["chars"]
    local acc_info = session.barrack.GetMyAccount()
    local pc_count = acc_info:GetPCCount()
    for i = 0, pc_count - 1 do
        local pc_info = acc_info:GetPCByIndex(i)
        if pc_info then
            local pc_cid = pc_info:GetCID()
            local pc_apc = pc_info:GetApc()
            if pc_apc then
                local pc_name = pc_apc:GetName()
                chars[pc_name] = {
                    name = pc_name,
                    layer = g.characters_item_serch.layer,
                    order = i,
                    cid = pc_cid
                }
            end
        end
    end
    local barrack_all = acc_info:GetBarrackPCCount()
    if barrack_all > 0 then
        local barrack_chars = {}
        for i = 0, barrack_all - 1 do
            local pc_info = acc_info:GetBarrackPCByIndex(i)
            if pc_info then
                barrack_chars[pc_info:GetName()] = true
            end
        end
        local chars_to_delete = {}
        for char_name, _ in pairs(chars) do
            if not barrack_chars[char_name] then
                table.insert(chars_to_delete, char_name)
            end
        end
        if #chars_to_delete > 0 then
            for _, char_name in ipairs(chars_to_delete) do
                chars[char_name] = nil
            end
        end
    end
    Characters_item_serch_save_settings()
end

function Characters_item_serch_APPS_TRY_LEAVE(my_frame, my_msg)
    local type = g.get_event_args(my_msg)
    if type == "Exit" or type == "Logout" or type == "Barrack" then
        Characters_item_serch_inventory_save_list()
    end
end

function Characters_item_serch_INVENTORY_CLOSE()
    Characters_item_serch_inventory_save_list()
end

function Characters_item_serch_ACCOUNTWAREHOUSE_CLOSE()
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local sorted_guid_list = item_list:GetSortedGuidList()
    local count = sorted_guid_list:Count()
    local items_to_save = {}
    for i = 0, count - 1 do
        local guid = sorted_guid_list:Get(i)
        local aw_item = item_list:GetItemByGuid(guid)
        if aw_item then
            local clsid = aw_item.type
            local iesid = aw_item:GetIESID()
            local obj = GetObjectByGuid(iesid)
            if obj then
                local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(obj.Name))
                local item_count = aw_item.count
                local item_cls = GetClassByType('Item', clsid)
                local category = "false"
                if item_cls and item_cls.MarketCategory ~= "None" then
                    category = item_cls.MarketCategory:match("^(.-)_")
                end
                table.insert(items_to_save,
                    {g.lang == "Japanese" and "チーム倉庫" or "Account Warehouse", iesid, clsid, item_count,
                     item_name, "accountwarehouse", category})
            end
        end
    end
    local dat_file_path = g.characters_item_serch_dat_tbl[4]
    Characters_item_serch_save_item_list_to_dat(dat_file_path, items_to_save, true)
end

function Characters_item_serch_save_item_list_to_dat(dat_path, items_to_save, is_overwrite)
    local lines = {}
    if not is_overwrite then
        local file_read = io.open(dat_path, "r")
        if file_read then
            for line in file_read:lines() do
                if line:match("^(.-):::") ~= g.login_name then
                    table.insert(lines, line)
                end
            end
            file_read:close()
        end
    end
    for _, item in ipairs(items_to_save) do
        table.insert(lines, table.concat(item, ":::"))
    end
    local file = io.open(dat_path, "w")
    if file then
        file:write(table.concat(lines, "\n"))
        file:close()
    end
end

function Characters_item_serch_inventory_save_list()
    local inv_item_list = session.GetInvItemList()
    local inv_guid_list = inv_item_list:GetGuidList()
    local cnt = inv_guid_list:Count()
    -- inventory save
    local items = {}
    for i = 0, cnt - 1 do
        local guid = inv_guid_list:Get(i)
        local inv_Item = inv_item_list:GetItemByGuid(guid)
        local inv_obj = GetIES(inv_Item:GetObject())
        local inv_clsid = inv_obj.ClassID
        local inv_count = inv_Item.count
        local item_cls = GetClassByType('Item', inv_clsid)
        local category = "false"
        if item_cls ~= nil and item_cls.MarketCategory ~= "None" then
            category = item_cls.MarketCategory:match("^(.-)_")
        end
        local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(inv_obj.Name))
        table.insert(items, {g.login_name, guid, inv_clsid, inv_count, item_name, "inventory", category})
    end
    local inventory_dat = g.characters_item_serch_dat_tbl[2]
    Characters_item_serch_save_item_list_to_dat(inventory_dat, items)
    -- equips save
    local items = {}
    local equiplist = session.GetEquipItemList()
    for i = 0, equiplist:Count() - 1 do
        local equip_item = equiplist:GetEquipItemByIndex(i)
        local obj = GetIES(equip_item:GetObject())
        if obj ~= nil then
            local iesid = equip_item:GetIESID()
            if iesid ~= "0" then
                local clsid = obj.ClassID
                local item_cls = GetClassByType('Item', clsid)
                local category = "false"
                if item_cls ~= nil and item_cls.MarketCategory ~= "None" then
                    category = item_cls.MarketCategory:match("^(.-)_")
                end
                local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(obj.Name))
                table.insert(items, {g.login_name, iesid, clsid, 1, item_name, "equips", category})
            end
        end
    end
    local mc_frame = ui.GetFrame("monstercardslot")
    for i = 1, 14 do
        local card_info = equipcard.GetCardInfo(i)
        if card_info then
            local clsid = card_info:GetCardID()
            local item_cls = GetClassByType("Item", clsid)
            local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(item_cls.Name))
            local category = "false"
            if item_cls ~= nil and item_cls.MarketCategory ~= "None" then
                category = item_cls.MarketCategory:match("^(.-)_")
            end
            table.insert(items, {g.login_name, "None" .. i, clsid, 1, item_name, "equips", category})
        end
    end
    local equips_dat = g.characters_item_serch_dat_tbl[3]
    Characters_item_serch_save_item_list_to_dat(equips_dat, items)
end

function Characters_item_serch_WAREHOUSE_CLOSE()
    local warehouse = ui.GetFrame('warehouse')
    local gbox = warehouse:GetChild("gbox")
    local slotset = gbox:GetChild("slotset")
    AUTO_CAST(slotset)
    local items = {}
    for i = 0, slotset:GetSlotCount() - 1 do
        local slot = slotset:GetSlotByIndex(i)
        local icon = slot:GetIcon()
        if icon then
            local icon_info = icon:GetInfo()
            local iesid = icon_info:GetIESID()
            local obj = GetObjectByGuid(iesid)
            local clsid = obj.ClassID
            local item_cls = GetClassByType('Item', clsid)
            local category = "false"
            if item_cls and item_cls.MarketCategory ~= "None" then
                category = item_cls.MarketCategory:match("^(.-)_")
            end
            local item_name = string.lower(dictionary.ReplaceDicIDInCompStr(obj.Name))
            table.insert(items, {g.login_name, iesid, clsid, icon_info.count, item_name, "warehouse", category})
        end
    end
    local warehouse_dat = g.characters_item_serch_dat_tbl[1]
    Characters_item_serch_save_item_list_to_dat(warehouse_dat, items)
end

function Characters_item_serch_load_data(select_name, search_mode, search_text)
    local dat_tbl = {}
    for i = 1, #g.characters_item_serch_dat_tbl - 1 do
        table.insert(dat_tbl, g.characters_item_serch_dat_tbl[i])
    end
    local items = {}
    local target_name = (select_name == "") and g.login_name or select_name
    if search_mode == "ITEM_SEARCH" then
        table.insert(dat_tbl, g.characters_item_serch_dat_tbl[4])
    end
    local valid_chars = g.characters_item_serch_settings["chars"]
    for _, dat_file_path in ipairs(dat_tbl) do
        local file = io.open(dat_file_path, "r")
        if file then
            local content = file:read("*all")
            file:close()
            for line in content:gmatch("([^\n]+)") do
                local is_match = false
                if search_mode == "ITEM_SEARCH" then
                    if string.find(string.lower(line), string.lower(search_text)) then
                        is_match = true
                    end
                else
                    if line:find(target_name, 1, true) == 1 then
                        is_match = true
                    end
                end
                if is_match then
                    local parts = {}
                    for part in (line .. ":::"):gmatch("(.-):::") do
                        table.insert(parts, part)
                    end
                    if #parts > 0 and parts[#parts] == "" then
                        table.remove(parts)
                    end
                    local char_name = parts[1]
                    local is_valid_char = false
                    if valid_chars[char_name] or char_name == "チーム倉庫" or char_name == "Account Warehouse" then
                        is_valid_char = true
                    end
                    if is_valid_char then
                        if search_mode == "ITEM_SEARCH" then
                            parts[3] = tonumber(parts[3]) or 0
                        else
                            table.remove(parts, 1)
                            if #parts > 0 then
                                parts[2] = tonumber(parts[2]) or 0
                            end
                        end
                        if #parts > 0 then
                            table.insert(items, parts)
                        end
                    end
                end
            end
        end
    end
    if search_mode == "ITEM_SEARCH" then
        table.sort(items, function(a, b)
            local a_is_warehouse = (a[1] == "チーム倉庫" or a[1] == "Account Warehouse")
            local b_is_warehouse = (b[1] == "チーム倉庫" or b[1] == "Account Warehouse")
            if a_is_warehouse and not b_is_warehouse then
                return false
            elseif not a_is_warehouse and b_is_warehouse then
                return true
            else
                return a[3] < b[3]
            end
        end)
    else
        table.sort(items, function(a, b)
            return a[2] < b[2]
        end)
    end
    return items
end

function Characters_item_serch_item_search(my_frame, ctrl, str, num)
    local characters_item_serch = ctrl:GetTopParentFrame()
    local search_edit = GET_CHILD(characters_item_serch, "search_edit")
    AUTO_CAST(search_edit)
    local search_text = search_edit:GetText()
    if search_text == "" then
        Characters_item_serch_frame_init(nil, nil, g.login_name, 0)
        return
    end
    local gb = GET_CHILD(characters_item_serch, "gb")
    gb:RemoveAllChild()
    local tree = gb:CreateOrGetControl("tree", 'name_tree', 0, 0, 0, 0)
    AUTO_CAST(tree)
    tree:Clear()
    tree:EnableDrawFrame(false)
    tree:SetFitToChild(true, 10)
    tree:SetFontName("white_16_ol")
    local items = Characters_item_serch_load_data("", "ITEM_SEARCH", search_text)
    local names = {}
    for i = 1, #items do
        local item = items[i]
        local name = item[1]
        if not names[name] then
            names[name] = true
            local slot_set = Characters_item_serch_make_inven_slotset(tree, name)
            tree:Add(name)
            tree:Add(slot_set, name)
        end
    end
    for i = 1, #items do
        local item = items[i]
        local name = item[1]
        local clsid = item[3]
        local item_count = item[4]
        local slot_set = GET_CHILD(tree, name)
        Characters_item_serch_insert_item_to_tree(slot_set, clsid, item_count)
    end
    tree:Resize(characters_item_serch:GetWidth() - 40, characters_item_serch:GetHeight() - 135)
    tree:OpenNodeAll()
end

function Characters_item_serch_get_sorted_sub_categories(items)
    local subcategories = {}
    local subcategory_list = {}
    local subcategory_order = {
        ["false"] = 1,
        ["equips"] = 2,
        ["warehouse"] = 3,
        ["Weapon"] = 4,
        ["Armor"] = 5,
        ["HairAcc"] = 6,
        ["Accessory"] = 7,
        ["nil"] = 8,
        ["Premium"] = 9,
        ["Look"] = 10,
        ["ChangeEquip"] = 11,
        ["Misc"] = 12,
        ["Consume"] = 13,
        ["Recipe"] = 14,
        ["Card"] = 15,
        ["Gem"] = 16,
        ["Ancient"] = 17,
        ["OPTMisc"] = 18,
        ["PHousing"] = 19
    }
    local function get_order(name)
        return subcategory_order[name] or 100
    end
    for i = 1, #items do
        local item = items[i]
        local category = item[5]
        local sub_category = item[6]
        local target_category = (category == "inventory") and sub_category or category
        if not subcategories[target_category] then
            subcategories[target_category] = true
            table.insert(subcategory_list, target_category)
        end
    end
    table.sort(subcategory_list, function(a, b)
        return get_order(a) < get_order(b)
    end)
    return subcategory_list
end

function Characters_item_serch_frame_init(frame, ctrl, select_name, num)
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    if not list_frame then
        list_frame = _nexus_addons_frame_init()
        list_frame:ShowWindow(0)
    end
    local characters_item_serch = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "characters_item_serch", 0, 0,
        70, 30)
    AUTO_CAST(characters_item_serch)
    characters_item_serch:SetSkinName("test_frame_low")
    characters_item_serch:Resize(670, 1080)
    characters_item_serch:SetPos(list_frame:GetX() + list_frame:GetWidth(), 0)
    characters_item_serch:EnableMove(0)
    characters_item_serch:SetLayerLevel(999)
    characters_item_serch:SetTitleBarSkin("None")
    characters_item_serch:RemoveAllChild()
    characters_item_serch:ShowWindow(1)
    local title_gb = characters_item_serch:CreateOrGetControl("groupbox", "title_gb", 0, 0,
        characters_item_serch:GetWidth(), 55)
    title_gb:SetSkinName("test_frame_top")
    AUTO_CAST(title_gb)
    local title_text = title_gb:CreateOrGetControl("richtext", "title_text", 0, 0, ui.CENTER_HORZ, ui.TOP, 0, 15, 0, 0)
    AUTO_CAST(title_text)
    title_text:SetText('{ol}{s26}Characters Item Serch')
    local close = characters_item_serch:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Characters_item_serch_close")
    local login_name = characters_item_serch:CreateOrGetControl("richtext", "login_name", 20, 60, 0, 0)
    AUTO_CAST(login_name)
    login_name:SetText(select_name == "" and '{ol}{s18}' .. g.login_name or '{ol}{s18}' .. select_name)
    local char_switch = characters_item_serch:CreateOrGetControl("button", "char_switch", 20, 85, 150, 30)
    AUTO_CAST(char_switch)
    char_switch:SetText(g.lang == "Japanese" and "{ol}キャラクター切替" or "{ol}character switch")
    char_switch:SetSkinName("test_pvp_btn")
    char_switch:SetEventScript(ui.LBUTTONUP, "Characters_item_serch_context")
    local search_edit = characters_item_serch:CreateOrGetControl("edit", "search_edit", 200, 80, 250, 40)
    AUTO_CAST(search_edit)
    search_edit:SetFontName("white_18_ol")
    search_edit:SetTextAlign("left", "center")
    search_edit:SetSkinName("inventory_serch")
    search_edit:SetEventScript(ui.ENTERKEY, "Characters_item_serch_item_search")
    local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 60, 38)
    AUTO_CAST(search_btn)
    search_btn:SetImage("inven_s")
    search_btn:SetGravity(ui.RIGHT, ui.TOP)
    search_btn:SetEventScript(ui.LBUTTONUP, "Characters_item_serch_item_search")
    local gb = characters_item_serch:CreateOrGetControl("groupbox", "gb", 20, 120,
        characters_item_serch:GetWidth() - 40, characters_item_serch:GetHeight() - 135)
    gb:SetSkinName("test_frame_midle")
    AUTO_CAST(gb)
    gb:RemoveAllChild()
    local tree = gb:CreateOrGetControl("tree", 'tree', 0, 0, 0, 0)
    AUTO_CAST(tree)
    tree:Clear()
    tree:EnableDrawFrame(false)
    tree:SetFitToChild(true, 10)
    tree:SetFontName("white_16_ol")
    -- tree:SetTabWidth(80)
    Characters_item_serch_build_tree(characters_item_serch, tree, select_name)
end

function Characters_item_serch_close(characters_item_serch)
    ui.DestroyFrame(characters_item_serch:GetName())
end

function Characters_item_serch_context()
    local chars = g.characters_item_serch_settings["chars"]
    local sorted_chars = {}
    for name, data in pairs(chars) do
        table.insert(sorted_chars, {
            name = name,
            data = data
        })
    end
    table.sort(sorted_chars, function(a, b)
        return a.data.layer < b.data.layer or (a.data.layer == b.data.layer and a.data.order < b.data.order)
    end)
    local context = ui.CreateContextMenu("Characters_item_serch_context", "{ol}Characters", 0, 0, 120, 0)
    ui.AddContextMenuItem(context, "-----")
    for _, char_data in ipairs(sorted_chars) do
        local char_name = char_data.name
        local escaped_name = string.gsub(char_name, "'", "\\'")
        local str_scp = string.format("Characters_item_serch_frame_init(nil,nil,'%s', 0)", escaped_name)
        ui.AddContextMenuItem(context, char_name, str_scp)
    end
    ui.OpenContextMenu(context)
end

function Characters_item_serch_build_tree(characters_item_serch, tree, select_name)
    local items = Characters_item_serch_load_data(select_name)
    local sub_category_list = Characters_item_serch_get_sorted_sub_categories(items)
    local category_display_names = {
        warehouse = g.lang == "Japanese" and "倉庫" or "Warehouse",
        equips = g.lang == "Japanese" and "装備中" or "Equips",
        Ancient = g.lang == "Japanese" and "アシスター" or "Ancient",
        ["nil"] = g.lang == "Japanese" and "レリック" or "Relic",
        PHousing = g.lang == "Japanese" and "家具" or "Housing"
    }
    local silver = 0
    for i = 1, #items do
        if items[i][3] == 900011 then
            silver = items[i][4]
            break
        end
    end
    local categorized_items = {}
    for _, item in ipairs(items) do
        local category = item[5]
        local sub_category = item[6]
        local target_category = (category == "inventory") and sub_category or category
        if not categorized_items[target_category] then
            categorized_items[target_category] = {}
        end
        table.insert(categorized_items[target_category], item)
    end
    local iesids = {}
    for i = 1, #sub_category_list do
        local category = sub_category_list[i]
        local disp_category
        if category == "false" then
            disp_category = "     " .. "{img icon_item_silver 20 20}" .. " " .. GET_COMMAED_STRING(tonumber(silver))
            tree:Add(disp_category)
        else
            disp_category = category_display_names[category] or ClMsg(category)
            local new_slots = Characters_item_serch_make_inven_slotset(tree, category)
            tree:Add(disp_category)
            tree:Add(new_slots, category)
            local items_in_category = categorized_items[category] or {}
            for _, item in ipairs(items_in_category) do
                local iesid, clsid, item_count = item[1], item[2], item[3]
                if not iesids[iesid] then
                    iesids[iesid] = true
                    Characters_item_serch_insert_item_to_tree(new_slots, clsid, item_count)
                end
            end
        end
    end
    tree:Resize(characters_item_serch:GetWidth() - 40, characters_item_serch:GetHeight() - 135)
    tree:OpenNodeAll()
end

function Characters_item_serch_make_inven_slotset(tree, name)
    local slotset = tree:CreateOrGetControl('slotset', name, 20, 0, 0, 0)
    AUTO_CAST(slotset)
    slotset:EnablePop(0)
    slotset:EnableDrag(0)
    slotset:EnableDrop(0)
    slotset:SetMaxSelectionCount(999)
    slotset:SetSlotSize(40, 40)
    slotset:SetColRow(15, 1)
    slotset:SetSpc(0, 0)
    slotset:SetSkinName('invenslot')
    slotset:EnableSelection(0)
    slotset:CreateSlots()
    return slotset
end

function Characters_item_serch_insert_item_to_tree(new_slots, clsid, item_count)
    local slot_count = new_slots:GetSlotCount()
    local count = new_slots:GetUserIValue("SLOT_ITEM_COUNT") or 0
    while slot_count <= count do
        new_slots:ExpandRow()
        slot_count = new_slots:GetSlotCount()
    end
    local slot = new_slots:GetSlotByIndex(count)
    count = count + 1
    new_slots:SetUserValue("SLOT_ITEM_COUNT", count)
    slot:ShowWindow(1)
    local item_cls = GetClassByType('Item', clsid)
    if item_cls then
        slot:SetSkinName('invenslot2')
        SET_SLOT_ITEM_CLS(slot, item_cls)
        SET_SLOT_BG_BY_ITEMGRADE(slot, item_cls)
        if tonumber(item_count) > 1 then
            SET_SLOT_COUNT_TEXT(slot, item_count, "{ol}{s14}")
        end
    end
end
-- characters_item_serch ここまで

-- goddess_icor_manager ここから
g.gim_slot_list = {{
    slot_name = "RH",
    clmsg = "RH"
}, {
    slot_name = "LH",
    clmsg = "LH"
}, {
    slot_name = "SHIRT",
    clmsg = "Shirt"
}, {
    slot_name = "PANTS",
    clmsg = "Pants"
}, {
    slot_name = "GLOVES",
    clmsg = "Gloves"
}, {
    slot_name = "BOOTS",
    clmsg = "Boots"
}, {
    slot_name = "RH_SUB",
    clmsg = "RH_SUB"
}, {
    slot_name = "LH_SUB",
    clmsg = "LH_SUB"
}}
function Goddess_icor_manager_save_settings()
    g.save_lua(g.gim_path, g.gim_settings)
end

function Goddess_icor_manager_load_settings()
    g.gim_path = string.format("../addons/%s/%s/goddess_icor_manager.lua", addon_name_lower, g.active_id)
    local old_json_path = string.format("../addons/%s/settings.json", "goddess_icor_manager")
    local settings = g.load_lua(g.gim_path)
    local need_save = false
    if not settings then
        local valid_cids = {}
        local sys_opt_path = string.format("../release/addon_setting/system_option/%s/settings.json", g.active_id)
        local sys_opt_file = io.open(sys_opt_path, "r")
        if sys_opt_file then
            local content = sys_opt_file:read("*a")
            sys_opt_file:close()
            if content and content ~= "" then
                local status, data = pcall(json.decode, content)
                if status and data and data.pc_id then
                    for cid, _ in pairs(data.pc_id) do
                        valid_cids[cid] = true
                    end
                end
            end
        end
        valid_cids[g.cid] = true
        local old_settings = g.load_json(old_json_path)
        if old_settings then
            settings = {
                delay = old_settings.delay or 0.6
            }
            for cid, data in pairs(old_settings) do
                if valid_cids[cid] then
                    settings[cid] = data
                end
            end
            need_save = true
        end
    end
    if not settings then
        settings = {
            delay = 0.6
        }
        need_save = true
    end
    g.gim_settings = settings
    if need_save then
        Goddess_icor_manager_save_settings()
    end
end

function Goddess_icor_manager_char_load_settings()
    if not g.gim_settings[g.cid] then
        g.gim_settings[g.cid] = {
            drop_items = {},
            icor_ids = {}
        }
        for i = 1, 9 do
            table.insert(g.gim_settings[g.cid].drop_items, {
                set_name = "Set " .. i,
                set = {}
            })
        end
        Goddess_icor_manager_save_settings()
    end
end

function goddess_icor_manager_on_init()
    if not g.gim_settings then
        Goddess_icor_manager_load_settings()
    end
    if g.get_map_type() == "City" then
        Goddess_icor_manager_char_load_settings()
        Goddess_icor_manager_frame_init()
    end
    g.addon:RegisterMsg("ESCAPE_PRESSED", "Goddess_icor_manager_list_close")
    g.setup_hook(Goddess_icor_manager__GODDESS_MGR_RANDOMOPTION_ENGRAVE_ICOR_EXEC,
        "_GODDESS_MGR_RANDOMOPTION_ENGRAVE_ICOR_EXEC")
    g.setup_hook_and_event(g.addon, "GODDESS_EQUIP_MANAGER_OPEN", "Goddess_icor_manager_GODDESS_EQUIP_MANAGER_OPEN",
        true)
end

function Goddess_icor_manager_frame_init()
    local inventory = ui.GetFrame("inventory")
    local inventoryGbox = inventory:GetChild("inventoryGbox")
    inventoryGbox:RemoveChild("icor_btn")
    if g.settings.goddess_icor_manager.use == 0 then
        return
    end
    local icor_pic = inventory:CreateOrGetControl("picture", "icor_pic", 440, 345, 30, 30)
    AUTO_CAST(icor_pic) -- 11201008
    local icor_cls = GetClassByType("Item", 11201008)
    icor_pic:SetImage(icor_cls.Icon)
    icor_pic:SetEnableStretch(1)
    icor_pic:SetSkinName("test_red_button")
    icor_pic:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_list_init")
    icor_pic:SetTextTooltip("{ol}Goddes Icor Manager")
end

function Goddess_icor_manager_list_init(frame, ctrl, str, page)
    local gim = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "gim", 0, 0, 0, 0)
    gim:Resize(1920, 1060) -- 1000
    gim:SetOffset(0, 5) -- 0,20
    gim:ShowWindow(1)
    gim:SetLayerLevel(121)
    gim:ShowTitleBar(0)
    gim:SetSkinName("test_frame_midle_light")
    gim:RemoveAllChild()
    if not page or page == 0 then
        page = 1
    end
    Goddess_icor_manager_equip_gbox_init(gim)
    Goddess_icor_manager_list_gb_init(gim, page)
end

function Goddess_icor_manager_list_gb_init(gim, page)
    gim:SetUserValue("PAGE", page)
    local acc = GetMyAccountObj()
    local etc = GetMyEtcObject()
    local remain_time = GET_REMAIN_SECOND_ENGRAVE_SLOT_EXTENSION_TIME(acc)
    local max_engrave_count = GET_MAX_ENGARVE_SLOT_COUNT(acc)
    local is_expired = (tonumber(remain_time) == 0)
    local page_max = is_expired and (max_engrave_count + 5) or max_engrave_count
    local start_x = 10
    local left_btn = gim:CreateOrGetControl("button", "left_btn", 690, 1025, 30, 33)
    AUTO_CAST(left_btn)
    left_btn:SetText("{img white_left_arrow 18 18}")
    left_btn:SetSkinName("brown_3patch_btn")
    left_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_list_init")
    left_btn:SetEventScriptArgNumber(ui.LBUTTONUP, 1)
    local right_btn = gim:CreateOrGetControl("button", "right_btn", 740, 1025, 30, 33)
    AUTO_CAST(right_btn)
    right_btn:SetText("{img white_right_arrow 18 18}")
    right_btn:SetSkinName("brown_3patch_btn")
    right_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_list_init")
    right_btn:SetEventScriptArgNumber(ui.LBUTTONUP, 2)
    local s_index, e_index
    if page == 2 then
        s_index, e_index = 6, page_max
    elseif page == 1 then
        s_index, e_index = 1, 5
    end
    local equip_bg = GET_CHILD_RECURSIVELY(gim, "equip_bg")
    for i = s_index, e_index do
        local bg = gim:CreateOrGetControl("groupbox", "bg" .. i, start_x, 5, 285, 1020)
        AUTO_CAST(bg)
        bg:RemoveAllChild()
        bg:SetSkinName("bg")
        bg:ShowWindow(1)
        local pagename_text = bg:CreateOrGetControl("richtext", "pagename_text" .. i, 10, 5)
        AUTO_CAST(pagename_text)
        local pagename = Goddess_icor_manager_get_pagename(i)
        start_x = start_x + 283
        local is_disabled_page = is_expired and (tonumber(max_engrave_count) < i)
        if is_disabled_page then
            local text = g.lang == "Japanese" and " 使用不可" or " disabled"
            pagename_text:SetText("{ol}{#FF0000}" .. pagename .. text)
        else
            pagename_text:SetText("{ol}{#FFFF00}" .. pagename)
        end
        local manage_y_offset = 0
        for j = 1, #g.gim_slot_list do
            local manage_bg = bg:CreateOrGetControl("groupbox", "manage_bg" .. j, 5, 30 + manage_y_offset, 272, 122)
            local manage_text = manage_bg:CreateOrGetControl("richtext", "manage_text" .. j, 5, 0)
            manage_bg:SetSkinName("test_frame_midle_light") -- "FFDAA520"
            if is_disabled_page then
                manage_bg:SetColorTone("FF808080")
            end
            manage_y_offset = manage_y_offset + 123
            local temp_name = ""
            local icor_ids = g.gim_settings[g.cid].icor_ids
            if icor_ids and type(icor_ids[tostring(i)]) == "table" then
                local spot_data = icor_ids[tostring(i)][g.gim_slot_list[j].slot_name]
                if spot_data and spot_data > 0 then
                    local temp_cls = GetClassByType("Item", spot_data)
                    if temp_cls then
                        local cls_name = temp_cls.ClassName
                        if string.find(cls_name, "EP17", 1, true) then
                            if string.find(cls_name, "high", 1, true) then
                                temp_name = g.lang == "Japanese" and " [540]上級" or " [540]Advanced"
                            else
                                temp_name = " [540]"
                            end
                            manage_bg:SetColorTone("FFFFD700")
                        elseif string.find(cls_name, "EP16", 1, true) then
                            if string.find(cls_name, "high", 1, true) then
                                temp_name = g.lang == "Japanese" and " [520]上級" or " [520]Advanced"
                            else
                                temp_name = " [520]"
                            end
                            manage_bg:SetColorTone("FFDAA520")
                        elseif string.find(cls_name, "EP15", 1, true) and
                            (string.find(cls_name, "Weapon2", 1, true) or string.find(cls_name, "Armor2", 1, true)) then
                            temp_name = g.lang == "Japanese" and " [500]継承" or " [500]Succession"
                            manage_bg:SetColorTone("FFFFD700")
                        end
                    end
                end
            end
            manage_text:SetText("{ol}" .. ClMsg(g.gim_slot_list[j].clmsg) .. temp_name)
            local option_prop, group_prop, value_prop, is_goddess_option =
                Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc, i, g.gim_slot_list[j].slot_name)
            if option_prop then
                local parts1 = {}
                local parts2 = {}
                local parts3 = {}
                for part in option_prop:gmatch("([^/]+)") do
                    table.insert(parts1, part)
                end
                for part in group_prop:gmatch("([^/]+)") do
                    table.insert(parts2, part)
                end
                for part in value_prop:gmatch("([^/]+)") do
                    table.insert(parts3, part)
                end
                Goddess_icor_manager_set_text(manage_bg, parts1, parts2, parts3)
                if equip_bg then
                    local current_equip_group = GET_CHILD_RECURSIVELY(equip_bg, "equip" .. j)
                    if current_equip_group then
                        local equip_text = ""
                        local eq_count = current_equip_group:GetChildCount()
                        for k = 0, eq_count - 1 do -- GetChildByIndexは0始まり
                            local child = current_equip_group:GetChildByIndex(k)
                            if string.find(child:GetName(), "text") then
                                equip_text = equip_text .. child:GetText()
                            end
                        end
                        equip_text = equip_text:gsub("{.-}", ""):gsub("%s+", "")
                        local icor_text = ""
                        local mg_count = manage_bg:GetChildCount()
                        for k = 0, mg_count - 1 do
                            local child = manage_bg:GetChildByIndex(k)
                            if string.find(child:GetName(), "option") then
                                icor_text = icor_text .. child:GetText()
                            end
                        end
                        icor_text = icor_text:gsub("{.-}", ""):gsub("%s+", "")
                        if equip_text ~= "" and icor_text ~= "" and not is_disabled_page then
                            if equip_text == icor_text then
                                local star = manage_bg:CreateOrGetControl("richtext", "star" .. j, 25, 25)
                                AUTO_CAST(star)
                                star:SetText("{img monster_card_starmark 20 20}")
                                star:SetOffset(245, 0)
                            else
                                local equip_button = manage_bg:CreateOrGetControl("button", "equip_button", 240, 0, 30,
                                    25)
                                AUTO_CAST(equip_button)
                                equip_button:SetText("{ol}{s14}E")
                                equip_button:SetSkinName("test_red_button")
                                equip_button:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_equip_button")
                                equip_button:SetEventScriptArgNumber(ui.LBUTTONUP, i) -- page index
                                equip_button:SetEventScriptArgString(ui.LBUTTONUP, j) -- slot index
                                equip_button:SetUserValue("PAGE", page)
                                equip_button:SetTextTooltip(g.lang == "Japanese" and "{ol}イコル付替え" or
                                                                "{ol}Icor Swap")
                            end
                        end
                    end
                end
            end
        end
    end
end

function Goddess_icor_manager_equip_gbox_init(gim)
    local equip_gb = gim:CreateOrGetControl("groupbox", "equip_bg", 1430, 5, 485, 1050)
    AUTO_CAST(equip_gb)
    equip_gb:SetSkinName("test_frame_midle_light")
    equip_gb:RemoveAllChild()
    local close = equip_gb:CreateOrGetControl("button", "close", 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_list_close")
    local swapbtn = equip_gb:CreateOrGetControl("button", "swapbtn", 0, 0, 35, 35)
    swapbtn:SetText("{img sysmenu_skill 35 35}")
    AUTO_CAST(swapbtn)
    swapbtn:SetSkinName("test_pvp_btn")
    swapbtn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_swap_weapon")
    swapbtn:SetTextTooltip(g.lang == "Japanese" and "{ol}武器の裏表切替" or
                               "{ol}Swap the reverse side of weapons")
    local icor_save = equip_gb:CreateOrGetControl("button", "icor_save", 45, 0, 80, 35)
    local text = g.lang == "Japanese" and "{@st66b}刻印保存" or "{@st66b}Icor save"
    icor_save:SetText(text)
    AUTO_CAST(icor_save)
    icor_save:SetSkinName("test_pvp_btn")
    icor_save:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_icor_save_open")
    local delay_edit = equip_gb:CreateOrGetControl("edit", "delay_edit", 130, 2, 50, 30)
    AUTO_CAST(delay_edit)
    delay_edit:SetFontName("white_16_ol")
    delay_edit:SetTextAlign("center", "center")
    delay_edit:SetText(g.gim_settings.delay or 0.5)
    local msg = g.lang == "Japanese" and "{ol}ディレイ設定 デフォルトは0.6秒" or
                    "{ol}Delay setting Default is 0.6 sec."
    delay_edit:SetTextTooltip(msg)
    delay_edit:SetEventScript(ui.ENTERKEY, "Goddess_icor_manager_setting_delay")
    local set_droplist = equip_gb:CreateOrGetControl("droplist", "set_droplist", 180, 35, 250, 35)
    AUTO_CAST(set_droplist)
    set_droplist:SetSkinName("droplist_normal")
    set_droplist:EnableHitTest(1)
    set_droplist:SetTextAlign("center", "center")
    set_droplist:SetSelectedScp("Goddess_icor_manager_droplist_select")
    set_droplist:AddItem(0, " ")
    set_droplist:SelectItem(0)
    set_droplist:Invalidate()
    for key, data in ipairs(g.gim_settings[g.cid].drop_items) do
        set_droplist:AddItem(key, "{ol}" .. data.set_name)
    end
    local x = 5
    local y = 50
    local yy = 50
    for i = 1, #g.gim_slot_list do
        local equip
        if i <= 2 or i >= 7 then
            equip = equip_gb:CreateOrGetControl("groupbox", "equip" .. i, x, y + 10, 238, 130)
            y = y + 131
        elseif i <= 6 or i >= 3 then
            equip = equip_gb:CreateOrGetControl("groupbox", "equip" .. i, x + 240, yy + 10, 238, 130)
            yy = yy + 131
        end
        AUTO_CAST(equip)
        equip:SetSkinName("test_frame_midle_light")
    end
    for i = 1, #g.gim_slot_list do
        local slot_info = g.gim_slot_list[i]
        local equip = GET_CHILD(equip_gb, "equip" .. i)
        local slot = equip:CreateOrGetControl("richtext", "slot" .. i, 5, 5)
        AUTO_CAST(slot)
        slot:SetText("{ol}{s15}" .. ClMsg(slot_info.clmsg))
        local inv_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_info.slot_name))
        local item_obj = GetIES(inv_item:GetObject())
        local item_dic = GET_ITEM_RANDOMOPTION_DIC(item_obj)
        local size = item_dic["Size"]
        local y = 25
        if size ~= 0 then
            for j = 1, size do
                local key = "RandomOption_" .. j
                local value_key = "RandomOptionValue_" .. j
                local group_key = "RandomOptionGroup_" .. j
                local text = equip:CreateOrGetControl("richtext", "text" .. j, 5, y)
                AUTO_CAST(text)
                local option = item_dic[key]
                local value = item_dic[value_key]
                local group = item_dic[group_key]
                local color = Goddess_icor_manager_color(group)
                text:SetText("{ol}{s15}" .. color .. ClMsg(option) .. "{#FFFFFF} : " .. value)
                text:AdjustFontSizeByWidth(235)
                y = y + 20
            end
            equip:SetColorTone("FFFFD700")
        end
    end
    local status_gb = equip_gb:CreateOrGetControl("groupbox", "status_gb", 5, 585, 480, 465)
    AUTO_CAST(status_gb)
    status_gb:SetSkinName("bg")
    local status_table = {"Cloth_Atk", "Leather_Atk", "Iron_Atk", "Ghost_Atk", "MiddleSize_Def", "Cloth_Def",
                          "Leather_Def", "Iron_Def", "Forester_Atk", "Widling_Atk", "Klaida_Atk", "Paramune_Atk",
                          "Velnias_Atk", "perfection", "revenge"}
    local status = ui.GetFrame("status")
    if status:IsVisible() == 0 then
        ui.OpenFrame("status")
    end
    for i = 1, #status_table do
        local status_str = status_table[i]
        local child_frame = GET_CHILD_RECURSIVELY(status, status_str)
        local level = info.GetLevel(session.GetMyHandle())
        local setting_num = level * 30
        local setting_num2 = level * 15
        local child_title = GET_CHILD(child_frame, "title", "ui::CRichText"):GetText()
        local titletext = status_gb:CreateOrGetControl("richtext", "titletext" .. i, 10, i * 30 - 20)
        titletext:SetText("{ol}" .. child_title)
        titletext:AdjustFontSizeByWidth(230)
        local child_stat = GET_CHILD(child_frame, "stat", "ui::CRichText"):GetText()
        local stattext = status_gb:CreateOrGetControl("richtext", "stattext" .. i, 240, i * 30 - 20)
        if i <= 4 or (i >= 9 and i <= 13) then
            stattext:SetText("{ol}" .. child_stat .. " {#FFFFFF}(" .. setting_num .. ")")
        elseif i >= 5 and i <= 8 then
            stattext:SetText("{ol}" .. child_stat .. " {#FFFFFF}(" .. setting_num2 .. ")")
        elseif i >= 14 then
            stattext:SetText("{ol}" .. child_stat)
        end
    end
    local inventory = ui.GetFrame("inventory")
    DO_WEAPON_SLOT_CHANGE(inventory, 1)
end

function Goddess_icor_manager_list_close(frame)
    local status = ui.GetFrame("status")
    status:ShowWindow(0)
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    goddess_equip_manager:SetLayerLevel(92) -- 92
    goddess_equip_manager:ShowWindow(0)
    local inventory = ui.GetFrame("inventory")
    inventory:SetLayerLevel(95) -- 95
    local inputstring = ui.GetFrame("inputstring")
    AUTO_CAST(inputstring)
    inputstring:SetLayerLevel(98) -- 98
    ui.DestroyFrame(addon_name_lower .. "gim")
end

function Goddess_icor_manager_setting_delay(parent, ctrl)
    local delay = tonumber(ctrl:GetText())
    if delay then
        g.gim_settings.delay = delay
        Goddess_icor_manager_save_settings()
        local text = g.lang == "Japanese" and "{ol}ディレイを" .. delay .. "秒に設定しました" or
                         "{ol}Delay is set to " .. delay .. " sec."
        ui.SysMsg(text)
    end
end

function Goddess_icor_manager_droplist_select(parent, ctrl)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    local ctrl_key = tonumber(ctrl:GetSelItemKey())
    local temp_data = g.gim_settings[g.cid].drop_items[ctrl_key]
    if ctrl_key == 0 then
        parent:RemoveAllChild()
        Goddess_icor_manager_equip_gbox_init(gim)
        return
    end
    local save_btn = parent:CreateOrGetControl("button", "save_btn", ctrl:GetX() + 10, 5, 80, 30)
    AUTO_CAST(save_btn)
    save_btn:SetText(g.lang == "Japanese" and "{ol}保存" or "{ol}Save")
    save_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_set_save")
    save_btn:SetEventScriptArgNumber(ui.LBUTTONUP, ctrl_key)
    save_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}装備中のイコルセットを保存します" or
                                "{ol}Save icorset being equipped")
    if next(temp_data.set) then
        local delete_btn = parent:CreateOrGetControl("button", "delete_btn", ctrl:GetX() + 90, 5, 80, 30)
        AUTO_CAST(delete_btn)
        delete_btn:SetText(g.lang == "Japanese" and "{ol}削除" or "{ol}Delete")
        delete_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_set_delete")
        delete_btn:SetEventScriptArgNumber(ui.LBUTTONUP, ctrl_key)
        local change_btn = parent:CreateOrGetControl("button", "change_btn", ctrl:GetX() + 170, 5, 80, 30)
        AUTO_CAST(change_btn)
        change_btn:SetText(g.lang == "Japanese" and "{ol}付替" or "{ol}change")
        change_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_set_change")
        change_btn:SetEventScriptArgNumber(ui.LBUTTONUP, ctrl_key)
        local status_gb = GET_CHILD(parent, "status_gb")
        status_gb:RemoveAllChild()
    end
    local etc_obj = GetMyEtcObject()
    g.gim_same = 0
    g.gim_rh = nil
    g.gim_lh = nil
    g.gim_rh_sub = nil
    g.gim_lh_sub = nil
    local cur_strs = {}
    for i = 1, #g.gim_slot_list do
        local equip = GET_CHILD(parent, "equip" .. i)
        AUTO_CAST(equip)
        local slot_info = g.gim_slot_list[i]
        local slot_name = slot_info.slot_name
        local inv_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_name))
        if inv_item and inv_item:GetObject() then
            local item_obj = GetIES(inv_item:GetObject())
            local item_dic = GET_ITEM_RANDOMOPTION_DIC(item_obj)
            if item_dic then
                local size = item_dic["Size"] or 0
                if size ~= 0 then
                    local opts, grps, vals = {}, {}, {}
                    for j = 1, size do
                        local key_opt = "RandomOption_" .. j
                        local key_val = "RandomOptionValue_" .. j
                        local key_grp = "RandomOptionGroup_" .. j
                        local opt = item_dic[key_opt]
                        local val = item_dic[key_val]
                        local grp = item_dic[key_grp]
                        table.insert(opts, opt ~= nil and tostring(opt) or "")
                        table.insert(grps, grp ~= nil and tostring(grp) or "")
                        table.insert(vals, val ~= nil and tostring(val) or "")
                    end
                    if #opts > 0 then
                        local cur_opts = table.concat(opts, "/")
                        local cur_grps = table.concat(grps, "/")
                        local cur_vals = table.concat(vals, "/")
                        cur_strs[slot_name] = string.format("%s:%s:%s", cur_opts, cur_grps, cur_vals)
                    end
                end
            end
        end
        local tgt_str = temp_data.set[slot_name] or ""
        local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")
        local eng_opts, eng_grps, eng_vals
        if load_index and load_equip_name then
            eng_opts, eng_grps, eng_vals = Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc_obj, tonumber(load_index),
                load_equip_name)
        end
        local eng_strs = string.format("%s:%s:%s", tostring(eng_opts or ""), tostring(eng_grps or ""),
            tostring(eng_vals or ""))
        if cur_strs[slot_name] == eng_strs then
            g.gim_same = g.gim_same + 1
        else
            if slot_name == "RH" then
                g.gim_rh = true
            elseif slot_name == "LH" then
                g.gim_lh = true
            elseif slot_name == "RH_SUB" then
                g.gim_rh_sub = true
            elseif slot_name == "LH_SUB" then
                g.gim_lh_sub = true
            end
        end
        if eng_opts ~= nil then
            local parts1, parts2, parts3 = {}, {}, {}
            for part in eng_opts:gmatch("([^/]+)") do
                table.insert(parts1, part)
            end
            if eng_grps then
                for part in eng_grps:gmatch("([^/]+)") do
                    table.insert(parts2, part)
                end
            end
            if eng_vals then
                for part in eng_vals:gmatch("([^/]+)") do
                    table.insert(parts3, part)
                end
            end
            for k_child = equip:GetChildCount() - 1, 0, -1 do
                local child_to_remove = equip:GetChildByIndex(k_child)
                if child_to_remove and string.sub(child_to_remove:GetName(), 1, 4) == "text" then
                    equip:RemoveChild(child_to_remove:GetName())
                end
            end
            local y = 25
            for k = 1, #parts1 do
                local opt_name = parts1[k]
                local grp_name = parts2[k]
                local val = parts3[k]
                local text = equip:CreateOrGetControl("richtext", "text" .. k, 5, y)
                AUTO_CAST(text)
                local color = Goddess_icor_manager_color(grp_name)
                text:SetText("{ol}{s15}" .. color .. ClMsg(opt_name) .. "{ol}{#FFFFFF} : " .. val)
                text:AdjustFontSizeByWidth(235)
                y = y + 20
            end
        end
    end
end

function Goddess_icor_manager_swap_weapon()
    local inventory = ui.GetFrame("inventory")
    inventory:ShowWindow(1)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    local RH = GET_CHILD_RECURSIVELY(inventory, "RH")
    local LH = GET_CHILD_RECURSIVELY(inventory, "LH")
    local RH_SUB = GET_CHILD_RECURSIVELY(inventory, "RH_SUB")
    local LH_SUB = GET_CHILD_RECURSIVELY(inventory, "LH_SUB")
    local function goddess_icor_manager_swap_guid(slot_name, bool)
        local icon = slot_name:GetIcon()
        if bool then
            if icon then
                return true
            else
                return nil
            end
        end
        local icon_info = icon:GetInfo()
        local icon_guid = icon_info:GetIESID()
        return icon_guid
    end
    g.gim_lh_sub_guid = goddess_icor_manager_swap_guid(LH_SUB)
    g.gim_rh_sub_guid = goddess_icor_manager_swap_guid(RH_SUB)
    g.gim_rh_guid = goddess_icor_manager_swap_guid(RH)
    g.gim_lh_guid = goddess_icor_manager_swap_guid(LH)
    if goddess_icor_manager_swap_guid(LH_SUB, true) and goddess_icor_manager_swap_guid(RH_SUB, true) then
        local lh_sub_index = 31
        Goddess_icor_manager_unequip(inventory, lh_sub_index)
    end
end

function Goddess_icor_manager_unequip(inventory, lh_sub_index)
    imcSound.PlaySoundEvent("inven_unequip")
    item.UnEquip(lh_sub_index)
    DO_WEAPON_SLOT_CHANGE(inventory, 1)
    ReserveScript("Goddess_icor_manager_equip()", g.gim_settings.delay or 0.5)
    return
end

function Goddess_icor_manager_equip()
    local function goddess_icor_manager_swap_equip(spot_name, guid)
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local inventory = ui.GetFrame("inventory")
            if string.find(spot_name, "_SUB") then
                DO_WEAPON_SLOT_CHANGE(inventory, 2)
            else
                DO_WEAPON_SLOT_CHANGE(inventory, 1)
            end
            ITEM_EQUIP(inv_item.invIndex, spot_name)
            ReserveScript("Goddess_icor_manager_equip()", g.gim_settings.delay or 0.5)
            return
        end
    end
    if g.gim_rh_sub_guid then
        goddess_icor_manager_swap_equip("RH", g.gim_rh_sub_guid)
        g.gim_rh_sub_guid = nil
    elseif g.gim_lh_sub_guid then
        goddess_icor_manager_swap_equip("LH", g.gim_lh_sub_guid)
        g.gim_lh_sub_guid = nil
    elseif g.gim_rh_guid then
        goddess_icor_manager_swap_equip("RH_SUB", g.gim_rh_guid)
        g.gim_rh_guid = nil
    elseif g.gim_lh_guid then
        goddess_icor_manager_swap_equip("LH_SUB", g.gim_lh_guid)
        g.gim_lh_guid = nil
    else
        local inventory = ui.GetFrame("inventory")
        inventory:Invalidate()
        if g.gim_swap then
            Goddess_icor_manager_set_change(nil, nil, nil, g.gim_ctrl_key, 4)
        else
            Goddess_icor_manager_set_end()
        end
    end
end

function Goddess_icor_manager_swap_weapon_run(ctrl)
    local inventory = ui.GetFrame("inventory")
    if inventory:IsVisible() == 0 then
        ctrl:StopUpdateScript("Goddess_icor_manager_swap_weapon_run")
        inventory:SetLayerLevel(95)
        return 0
    end
    inventory:SetLayerLevel(122)
    DO_WEAPON_SLOT_CHANGE(inventory, 1)
    local step = ctrl:GetUserIValue("STEP")
    local spot_nums = {8, 9, 30}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    if step <= 3 then
        local guid = g.gim_guids[equips[step]]
        local equip_item = session.GetEquipItemByGuid(guid)
        if not equip_item then
            ctrl:SetUserValue("STEP", step + 1)
        else
            item.UnEquip(spot_nums[step])
        end
        return 1
    end
    if step >= 4 and step <= 7 then
        local guid = nil
        if step == 4 then
            guid = g.gim_guids["RH_SUB"]
        elseif step == 5 then
            guid = g.gim_guids["LH_SUB"]
        elseif step == 6 then
            guid = g.gim_guids["RH"]
        elseif step == 7 then
            guid = g.gim_guids["LH"]
        end
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            local spot_name = equips[step - 3]
            ITEM_EQUIP(inv_item.invIndex, spot_name)
            return 1
        else
            ctrl:SetUserValue("STEP", step + 1)
            return 1
        end
    end
    inventory:SetLayerLevel(95)
    ctrl:StopUpdateScript("Goddess_icor_manager_swap_weapon_run")
    return 0
end

function Goddess_icor_manager_icor_save_open(parent, ctrl)
    parent:ShowWindow(0)
    local inputstring = ui.GetFrame("inputstring")
    AUTO_CAST(inputstring)
    inputstring:SetLayerLevel(123) -- 98
    local inventory = ui.GetFrame("inventory")
    inventory:SetLayerLevel(122) -- 95
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    goddess_equip_manager:ShowWindow(1)
    ui.CloseFrame("rareoption")
    ui.CloseFrame("item_cabinet")
    for i = 1, #revertrandomitemlist do
        local revert_name = revertrandomitemlist[i]
        local revert_frame = ui.GetFrame(revert_name)
        if revert_frame ~= nil and revert_frame:IsVisible() == 1 then
            ui.CloseFrame(revert_name)
        end
    end
    local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, "main_tab")
    main_tab:SelectTab(1)
    CLEAR_GODDESS_EQUIP_MANAGER(goddess_equip_manager)
    TOGGLE_GODDESS_EQUIP_MANAGER_TAB(goddess_equip_manager, 1)
    ui.OpenFrame("inventory")
    goddess_equip_manager:Resize(485, 460)
    goddess_equip_manager:SetPos(1430, 5)
    goddess_equip_manager:SetLayerLevel(122) -- 92
    local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, "main_tab")
    main_tab:ShowWindow(0)
    local bg = GET_CHILD(goddess_equip_manager, "bg")
    bg:ShowWindow(1)
    local manager_top = GET_CHILD(goddess_equip_manager, "manager_top")
    manager_top:ShowWindow(0)
    local close = GET_CHILD(goddess_equip_manager, "close")
    close:ShowWindow(0)
    local help = GET_CHILD(goddess_equip_manager, "help")
    help:ShowWindow(0)
    local bg = GET_CHILD(goddess_equip_manager, "bg")
    bg:SetMargin(0, 0, 0, 0)
    local bg_inner = GET_CHILD(bg, "bg_inner")
    bg_inner:SetSkinName("None")
    bg:Resize(485, 460)
    local randomoption_bg = GET_CHILD(bg, "randomoption_bg")
    randomoption_bg:SetSkinName("None")
    randomoption_bg:SetMargin(0, 0, 0, 0)
    local randomoption_tab = GET_CHILD(randomoption_bg, "randomoption_tab")
    randomoption_tab:ShowWindow(0)
    local rand_icor_text = GET_CHILD_RECURSIVELY(randomoption_bg, "rand_icor_text") --
    rand_icor_text:ShowWindow(0)
    local rand_icor_slot = GET_CHILD_RECURSIVELY(randomoption_bg, "rand_icor_slot")
    rand_icor_slot:SetMargin(10, 30, 0, 0)
    local goddess_icor_spot_text = GET_CHILD_RECURSIVELY(randomoption_bg, "goddess_icor_spot_text")
    goddess_icor_spot_text:SetMargin(10, 25, 0, 0)
    local goddess_icor_spot_list = GET_CHILD_RECURSIVELY(randomoption_bg, "goddess_icor_spot_list")
    goddess_icor_spot_list:SetMargin(10, 50, 0, 0)
    local before_preset_option_text = GET_CHILD_RECURSIVELY(randomoption_bg, "before_preset_option_text")
    before_preset_option_text:SetMargin(155, 180, 0, 0)
    local before_preset_option_bg = GET_CHILD_RECURSIVELY(randomoption_bg, "before_preset_option_bg")
    before_preset_option_bg:SetGravity(ui.RIGHT, ui.TOP)
    before_preset_option_bg:Resize(310, 140)
    local current_icor_option_text = GET_CHILD_RECURSIVELY(randomoption_bg, "current_icor_option_text")
    current_icor_option_text:SetMargin(0, 0, 205, 0)
    local current_icor_option_bg = GET_CHILD_RECURSIVELY(randomoption_bg, "current_icor_option_bg")
    AUTO_CAST(current_icor_option_bg)
    current_icor_option_bg:SetGravity(ui.RIGHT, ui.TOP)
    current_icor_option_bg:Resize(310, 140)
    local exec_btn = goddess_equip_manager:CreateOrGetControl("button", "exec_btn", 15, 345, 150, 60)
    local text = g.lang == "Japanese" and "{@st41b}{s18}刻印保存" or "{@st41b}{s18}Icor save"
    exec_btn:SetText(text)
    AUTO_CAST(exec_btn)
    exec_btn:SetSkinName("relic_btn_purple")
    exec_btn:SetEventScript(ui.LBUTTONUP, "GODDESS_MGR_RANDOMOPTION_ENGRAVE_ICOR_EXEC")
    local close_btn = goddess_equip_manager:CreateOrGetControl("button", "close_btn", 0, 0, 30, 30)
    AUTO_CAST(close_btn)
    close_btn:SetImage("testclose_button")
    close_btn:SetGravity(ui.RIGHT, ui.TOP)
    close_btn:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_list_close")
    current_icor_option_bg:SetMargin(0, 30, 145, 0)
    before_preset_option_bg:SetMargin(0, 210, 145, 0)
end

function Goddess_icor_manager_save_setname(inputstring, ctrl, str, ctrl_key)
    inputstring:ShowWindow(0)
    local edit = GET_CHILD(inputstring, 'input')
    local get_text = edit:GetText()
    if get_text == "" then
        local text = g.lang == "Japanese" and "{ol}文字を入力してください" or "{ol}Please enter text"
        ui.SysMsg(text)
        Goddess_icor_INPUT_STRING_BOX(ctrl_key)
        return
    end
    local text = g.lang == "Japanese" and "{ol}セットを登録しました" or "{ol}Set registered"
    ui.SysMsg(text)
    text = g.lang == "Japanese" and "(保存済)" or "(saved)"
    g.gim_settings[g.cid].drop_items[ctrl_key].set_name = get_text .. text
    Goddess_icor_manager_save_settings()
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    Goddess_icor_manager_equip_gbox_init(gim)
end

function Goddess_icor_INPUT_STRING_BOX(ctrl_key)
    local inputstring = ui.GetFrame("inputstring")
    inputstring:Resize(500, 220)
    inputstring:SetLayerLevel(999)
    local edit = GET_CHILD(inputstring, "input", "ui::CEditControl")
    edit:SetNumberMode(0)
    edit:SetMaxLen(999)
    edit:SetText("")
    inputstring:ShowWindow(1)
    inputstring:SetEnable(1)
    local title = inputstring:GetChild("title")
    AUTO_CAST(title)
    local text = g.lang == "Japanese" and "{ol}{#FFFFFF}セット名を入力" or "{ol}{#FFFFFF}Enter set name"
    title:SetText(text)
    local confirm = inputstring:GetChild("confirm")
    confirm:SetEventScript(ui.LBUTTONUP, "Goddess_icor_manager_save_setname")
    confirm:SetEventScriptArgNumber(ui.LBUTTONUP, ctrl_key)
    edit:SetEventScript(ui.ENTERKEY, "Goddess_icor_manager_save_setname")
    edit:SetEventScriptArgNumber(ui.ENTERKEY, ctrl_key)
    edit:AcquireFocus()
end

function Goddess_icor_manager_set_save(frame, ctrl, str, ctrl_key)
    local acc = GetMyAccountObj()
    local etc_obj = GetMyEtcObject()
    local remain_time = GET_REMAIN_SECOND_ENGRAVE_SLOT_EXTENSION_TIME(acc)
    local page_max = 0
    if tonumber(remain_time) == 0 then
        page_max = GET_MAX_ENGARVE_SLOT_COUNT(acc)
    else
        page_max = GET_MAX_ENGARVE_SLOT_COUNT(acc) + 5
    end
    local cur_strs = {}
    for i = 1, #g.gim_slot_list do
        local slot_info = g.gim_slot_list[i]
        local slot_name = slot_info.slot_name
        local inv_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_name))
        if inv_item and inv_item:GetObject() then
            local item_obj = GetIES(inv_item:GetObject())
            local item_dic = GET_ITEM_RANDOMOPTION_DIC(item_obj)
            if item_dic then
                local size = item_dic["Size"] or 0
                if size ~= 0 then
                    local opts, grps, vals = {}, {}, {}
                    for j = 1, size do
                        local key_opt = "RandomOption_" .. j
                        local key_val = "RandomOptionValue_" .. j
                        local key_grp = "RandomOptionGroup_" .. j
                        local opt = item_dic[key_opt]
                        local val = item_dic[key_val]
                        local grp = item_dic[key_grp]
                        table.insert(opts, opt ~= nil and tostring(opt) or "")
                        table.insert(grps, grp ~= nil and tostring(grp) or "")
                        table.insert(vals, val ~= nil and tostring(val) or "")
                    end
                    if #opts > 0 then
                        local cur_opts = table.concat(opts, "/")
                        local cur_grps = table.concat(grps, "/")
                        local cur_vals = table.concat(vals, "/")
                        cur_strs[slot_name] = string.format("%s:%s:%s", cur_opts, cur_grps, cur_vals)
                    end
                end
            end
        end
    end
    local eng_count = 0
    local temp_data = g.gim_settings[g.cid].drop_items[ctrl_key]
    for base_equip_name, strs in pairs(cur_strs) do
        for i = 1, page_max do
            temp_data.set[base_equip_name] = ""
            local eng_opts, eng_grps, eng_vals, is_goddess =
                Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc_obj, i, base_equip_name)
            if eng_opts then
                local eng_strs = string.format("%s:%s:%s", tostring(eng_opts or ""), tostring(eng_grps or ""),
                    tostring(eng_vals or ""))
                if strs == eng_strs then
                    temp_data.set[base_equip_name] = i .. ":::" .. base_equip_name
                    eng_count = eng_count + 1
                    if not string.find(base_equip_name, "_SUB") then
                        if cur_strs[base_equip_name] == cur_strs[base_equip_name .. "_SUB"] then
                            temp_data.set[base_equip_name .. "_SUB"] = i .. ":::" .. base_equip_name
                            eng_count = eng_count + 1
                        end
                    else
                        if cur_strs[base_equip_name] == cur_strs[string.gsub(base_equip_name, "_SUB", "")] then
                            temp_data.set[string.gsub(base_equip_name, "_SUB", "")] = i .. ":::" .. base_equip_name
                            eng_count = eng_count + 1
                        end
                    end
                    break
                end
            end
            if temp_data.set[base_equip_name] == "" then
                local change_equip_name = nil
                if base_equip_name == "RH" then
                    change_equip_name = "RH_SUB"
                elseif base_equip_name == "RH_SUB" then
                    change_equip_name = "RH"
                elseif base_equip_name == "LH" then
                    change_equip_name = "LH_SUB"
                elseif base_equip_name == "LH_SUB" then
                    change_equip_name = "LH"
                end
                local eng_opts, eng_grps, eng_vals, is_goddess =
                    Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc_obj, i, change_equip_name)
                if eng_opts then
                    local eng_strs = string.format("%s:%s:%s", tostring(eng_opts or ""), tostring(eng_grps or ""),
                        tostring(eng_vals or ""))
                    if strs == eng_strs then
                        temp_data.set[base_equip_name] = i .. ":::" .. change_equip_name
                        eng_count = eng_count + 1
                        break
                    end
                end
            end
        end
    end
    if eng_count >= 8 then
        Goddess_icor_INPUT_STRING_BOX(ctrl_key)
    else
        local text = g.lang == "Japanese" and "{ol}付替え不可のため保存できません" or
                         "{ol}Cannot be saved as it is not replaceable"
        ui.SysMsg(text)
    end
end

function Goddess_icor_manager_set_delete(frame, ctrl, str, ctrl_key)
    local msg = g.lang == "Japanese" and "{ol}{#FFFFFF}セットを削除しますか？" or
                    "{ol}{#FFFFFF}Do you want to remove the set?"
    ui.MsgBox(msg, string.format("Goddess_icor_manager_set_delete_(%d)", ctrl_key), "None")
end

function Goddess_icor_manager_set_delete_(ctrl_key)
    g.gim_settings[g.cid].drop_items[ctrl_key] = nil
    g.gim_settings[g.cid].drop_items[ctrl_key] = {
        set_name = "Set " .. ctrl_key,
        set = {}
    }
    Goddess_icor_manager_save_settings()
    local text = g.lang == "Japanese" and "{ol}セットを削除しました" or "{ol}Set removed"
    ui.SysMsg(text)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    Goddess_icor_manager_equip_gbox_init(gim)
end

function Goddess_icor_manager_set_change(frame, ctrl, str, ctrl_key, step)
    g.gim_ctrl_key = ctrl_key
    if step == nil or step == 1 then
        for i = 1, #g.gim_slot_list do
            local slot_info = g.gim_slot_list[i]
            local slot_name = slot_info.slot_name
            local inv_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_name))
            local guid = inv_item:GetIESID()
            if guid == "0" then
                local text =
                    g.lang == "Japanese" and "{ol}装備を8ヶ所に着けてから起動してください" or
                        "{ol}Wear the equipment in 8 places before activating it"
                ui.SysMsg(text)
                return
            end
        end
        if g.gim_same == 8 then
            local text = g.lang == "Japanese" and "{ol}現在装備中と同一のセットです" or
                             "{ol}This is the same set you currently have equipped"
            ui.SysMsg(text)
            return
        end
    end
    local acc = GetMyAccountObj()
    local remain_time = GET_REMAIN_SECOND_ENGRAVE_SLOT_EXTENSION_TIME(acc)
    local page_max = 0
    if tonumber(remain_time) == 0 then
        page_max = GET_MAX_ENGARVE_SLOT_COUNT(acc)
    else
        page_max = GET_MAX_ENGARVE_SLOT_COUNT(acc) + 5
    end
    for j = 1, #g.gim_slot_list do
        local cur_slot_name = g.gim_slot_list[j].slot_name
        local tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set[cur_slot_name]
        local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")
        if tonumber(load_index) > page_max then
            local text = g.lang == "Japanese" and
                             "{ol}保存しているイコルが使用不可のため、終了します" or
                             "{ol}Process terminated Stored Icor is unavailable"
            ui.SysMsg(text)
            return
        end
    end
    local notice = g.lang == "Japanese" and
                       "{ol}[GIM]セット適用中{nl}バグ防止のため操作をしないでください" or
                       "{ol}[GIM]set is being applied{nl}Do not operate to prevent bugs"
    imcAddOn.BroadMsg("NOTICE_Dm_stage_start", notice)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    gim:RunUpdateScript("Goddess_icor_manager_set_error_end", (g.gim_settings.delay or 0.5) * 6 * 2)
    local etc_obj = GetMyEtcObject()
    local temp_data = g.gim_settings[g.cid].drop_items[ctrl_key]
    local cur_strs = {}
    local spot_names = ""
    step = step or 1
    for i = 1, #g.gim_slot_list do
        local slot_info = g.gim_slot_list[i]
        local slot_name = slot_info.slot_name
        local inv_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_name))
        if inv_item and inv_item:GetObject() then
            local item_obj = GetIES(inv_item:GetObject())
            local item_dic = GET_ITEM_RANDOMOPTION_DIC(item_obj)
            if item_dic then
                local size = item_dic["Size"] or 0
                if size ~= 0 then
                    local opts, grps, vals = {}, {}, {}
                    for j = 1, size do
                        local key_opt = "RandomOption_" .. j
                        local key_val = "RandomOptionValue_" .. j
                        local key_grp = "RandomOptionGroup_" .. j
                        local opt = item_dic[key_opt]
                        local val = item_dic[key_val]
                        local grp = item_dic[key_grp]
                        table.insert(opts, opt ~= nil and tostring(opt) or "")
                        table.insert(grps, grp ~= nil and tostring(grp) or "")
                        table.insert(vals, val ~= nil and tostring(val) or "")
                    end
                    if #opts > 0 then
                        local cur_opts = table.concat(opts, "/")
                        local cur_grps = table.concat(grps, "/")
                        local cur_vals = table.concat(vals, "/")
                        cur_strs[slot_name] = string.format("%s:%s:%s", cur_opts, cur_grps, cur_vals)
                    end
                end
            end
        end
    end
    if step == 1 then
        for base_equip_name, strs in pairs(cur_strs) do
            if not string.find(base_equip_name, "RH") and not string.find(base_equip_name, "LH") then
                local tgt_str = temp_data.set[base_equip_name]
                local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")
                local eng_opts, eng_grps, eng_vals, is_goddess =
                    Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc_obj, tonumber(load_index), load_equip_name)
                local eng_strs = string.format("%s:%s:%s", tostring(eng_opts or ""), tostring(eng_grps or ""),
                    tostring(eng_vals or ""))
                if cur_strs[base_equip_name] ~= eng_strs then
                    spot_names = spot_names .. ":::" .. base_equip_name
                end
            end
        end
        if spot_names ~= "" then
            Goddess_icor_manager_set_change_action(ctrl_key, spot_names, step)
        else
            if g.gim_rh or g.gim_lh or g.gim_rh_sub or g.gim_lh_sub then
                Goddess_icor_manager_set_change(nil, nil, nil, ctrl_key, 2)
            else
                Goddess_icor_manager_set_end()
            end
        end
    elseif step == 2 then -- 表武器判定
        g.gim_swap = nil
        for base_equip_name, strs in pairs(cur_strs) do
            if string.find(base_equip_name, "RH") or string.find(base_equip_name, "LH") then
                local tgt_str = temp_data.set[base_equip_name]
                local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")
                if base_equip_name == "RH" and g.gim_rh then
                    if base_equip_name == load_equip_name then
                        spot_names = spot_names .. ":::" .. base_equip_name
                        g.gim_rh = false
                    end
                elseif base_equip_name == "LH" and g.gim_lh then
                    if base_equip_name == load_equip_name then
                        spot_names = spot_names .. ":::" .. base_equip_name
                        g.gim_lh = false
                    end
                elseif base_equip_name == "RH_SUB" and g.gim_rh_sub then
                    if base_equip_name == load_equip_name then
                        spot_names = spot_names .. ":::" .. base_equip_name
                        g.gim_rh_sub = false
                    end
                elseif base_equip_name == "LH_SUB" and g.gim_lh_sub then
                    if base_equip_name == load_equip_name then
                        spot_names = spot_names .. ":::" .. base_equip_name
                        g.gim_lh_sub = false
                    end
                end
            end
        end
        if spot_names ~= "" then
            Goddess_icor_manager_set_change_action(ctrl_key, spot_names, step)
        else
            if g.gim_rh or g.gim_lh or g.gim_rh_sub or g.gim_lh_sub then
                Goddess_icor_manager_set_change(nil, nil, nil, ctrl_key, 3)
            else
                Goddess_icor_manager_set_end()
            end
        end
    elseif step == 3 then -- swap
        if g.gim_rh or g.gim_lh or g.gim_rh_sub or g.gim_lh_sub then
            g.gim_swap = true
            Goddess_icor_manager_swap_weapon()
        else
            Goddess_icor_manager_set_end()
        end
    elseif step == 4 then -- 裏武器
        for base_equip_name, strs in pairs(cur_strs) do
            if string.find(base_equip_name, "RH") or string.find(base_equip_name, "LH") then
                local tgt_str = temp_data.set[base_equip_name]
                local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")

                if base_equip_name == "RH" and g.gim_rh then
                    spot_names = spot_names .. ":::" .. load_equip_name
                    g.gim_rh = false
                elseif base_equip_name == "LH" and g.gim_lh then
                    spot_names = spot_names .. ":::" .. load_equip_name
                    g.gim_lh = false
                elseif base_equip_name == "RH_SUB" and g.gim_rh_sub then
                    spot_names = spot_names .. ":::" .. load_equip_name
                    g.gim_rh_sub = false
                elseif base_equip_name == "LH_SUB" and g.gim_lh_sub then
                    spot_names = spot_names .. ":::" .. load_equip_name
                    g.gim_lh_sub = false
                end
            end
        end
        if spot_names ~= "" then
            Goddess_icor_manager_set_change_action(ctrl_key, spot_names, step)
        end
    elseif step == 5 then -- 元戻す
        g.gim_swap = false
        Goddess_icor_manager_swap_weapon()
    end
end

function Goddess_icor_manager_set_change_action(ctrl_key, spot_names, step)
    local _, count = string.gsub(spot_names, ":::", "")
    if count <= 0 then
        step = step + 1
        Goddess_icor_manager_set_change(nil, nil, nil, ctrl_key, step)
        return
    end
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    goddess_equip_manager:ShowWindow(1)
    local spot_name = string.match(spot_names, "^:::([A-Z0-9_]+)")
    if spot_name then
        spot_names = string.gsub(spot_names, "^:::" .. spot_name, "", 1)
    end
    local tgt_str
    if step == 4 then
        if spot_name == "RH" then
            tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set["RH_SUB"]
        elseif spot_name == "LH" then
            tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set["LH_SUB"]
        elseif spot_name == "RH_SUB" then
            tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set["RH"]
        elseif spot_name == "LH_SUB" then
            tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set["LH"]
        end
    else
        tgt_str = g.gim_settings[g.cid].drop_items[ctrl_key].set[spot_name]
    end
    local load_index, load_equip_name = string.match(tgt_str, "^(.-):::(.+)$")
    load_index = tonumber(load_index)
    session.ResetItemList()
    local arg_list = NewStringList()
    local tgt_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(spot_name))
    if tgt_item then
        if tgt_item.isLockState == true then
            ui.SysMsg(ClMsg("MaterialItemIsLock"))
            return
        end
        local guid = tgt_item:GetIESID()
        if guid ~= "None" and guid ~= "0" then
            session.AddItemID(guid, 1)
            arg_list:Add(spot_name)
        end
    end
    if load_index then
        arg_list:Add(load_index)
        local result_list = session.GetItemIDList()
        item.DialogTransaction("ICOR_PRESET_ENGRAVE_APPLY", result_list, "", arg_list)
        if count > 0 then
            ReserveScript(
                string.format("Goddess_icor_manager_set_change_action(%d,'%s',%d)", ctrl_key, spot_names, step),
                g.gim_settings.delay or 0.5)
            return
        end
    end
end

function Goddess_icor_manager_set_end()
    local notice = ui.GetFrame("notice")
    AUTO_CAST(notice)
    notice:ShowWindow(0)
    ui.SysMsg("{#FFFF00}[GIM]End of Operation")
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    gim:StopUpdateScript("Goddess_icor_manager_set_error_end")
    local page = gim:GetUserIValue("PAGE")
    ReserveScript(string.format("Goddess_icor_manager_list_init(nil,nil,nil,%d)", page), g.gim_settings.delay or 0.5)
    return
end

function Goddess_icor_manager_set_error_end(frame)
    local notice = ui.GetFrame("notice")
    AUTO_CAST(notice)
    notice:ShowWindow(0)
    local msg = g.lang == "Japanese" and "{ol}{s30}{#FFFF00}[GIM]エラーのため動作を終了します" or
                    "{ol}{s30}{#FFFF00}[GIM]Operation terminated due to error"
    ui.SysMsg(msg)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    local page = gim:GetUserIValue("PAGE")
    ReserveScript(string.format("Goddess_icor_manager_list_init(nil,nil,nil,%d)", page), g.gim_settings.delay or 0.5)
    return
end

function Goddess_icor_manager_equip_button(parent, ctrl, slot_index_str, page_index)
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    if not goddess_equip_manager then
        return
    end
    goddess_equip_manager:ShowWindow(1)
    GODDESS_MGR_RANDOMOPTION_APPLY_OPEN(goddess_equip_manager)
    session.ResetItemList()
    local target_slot_index = tonumber(slot_index_str)
    local arg_list = NewStringList()
    local apply_cnt = 0
    for i = 1, #g.gim_slot_list do
        local slot_info = g.gim_slot_list[i]
        local ctrl_set = GET_CHILD_RECURSIVELY(goddess_equip_manager, "rand_slot_" .. slot_info.slot_name)
        local checkbox = GET_CHILD(ctrl_set, "checkbox")
        if i == target_slot_index then
            checkbox:SetCheck(1)
        else
            checkbox:SetCheck(0)
        end
        if checkbox:IsChecked() == 1 then
            local tgt_item = session.GetEquipItemBySpot(item.GetEquipSpotNum(slot_info.slot_name))
            if tgt_item then
                if tgt_item.isLockState then
                    ui.SysMsg(ClMsg("MaterialItemIsLock"))
                    return
                end
                local slot = GET_CHILD(ctrl_set, "slot")
                AUTO_CAST(slot)
                local guid = slot:GetUserValue("ITEM_GUID")
                if guid ~= "None" then
                    session.AddItemID(guid, 1)
                    arg_list:Add(slot_info.slot_name)
                    apply_cnt = apply_cnt + 1
                end
            end
        end
    end
    if apply_cnt == 0 then
        ui.SysMsg(ClMsg("NoSelectedItem"))
        return
    end
    arg_list:Add(page_index)
    local result_list = session.GetItemIDList()
    item.DialogTransaction("ICOR_PRESET_ENGRAVE_APPLY", result_list, "", arg_list)
    local page = ctrl:GetUserIValue("PAGE")
    ReserveScript(string.format("Goddess_icor_manager_list_init(nil,nil,nil, %d)", page), g.gim_settings.delay or 0.5)
end

function Goddess_icor_manager_GODDESS_EQUIP_MANAGER_OPEN(my_frame, my_msg)
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    goddess_equip_manager:Resize(1270, 900)
    goddess_equip_manager:SetGravity(ui.LEFT, ui.CENTER_VERT)
    goddess_equip_manager:SetMargin(89, 0, 0, 0);
    goddess_equip_manager:SetLayerLevel(92)
    local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, "main_tab")
    main_tab:ShowWindow(1)
    local manager_top = GET_CHILD(goddess_equip_manager, "manager_top")
    manager_top:ShowWindow(1)
    local close = GET_CHILD(goddess_equip_manager, "close")
    close:ShowWindow(1)
    local help = GET_CHILD(goddess_equip_manager, "help")
    help:ShowWindow(1)
    local bg = GET_CHILD(goddess_equip_manager, "bg")
    bg:SetMargin(0, 10, 0, 0);
    local bg_inner = GET_CHILD(bg, "bg_inner")
    bg_inner:SetSkinName("relic_frame_bg")
    bg:Resize(1218, 890)
    local randomoption_bg = GET_CHILD(bg, "randomoption_bg")
    randomoption_bg:SetGravity(ui.LEFT, ui.TOP)
    randomoption_bg:SetMargin(112, 66, 0, 0);
    local randomoption_tab = GET_CHILD(randomoption_bg, "randomoption_tab")
    randomoption_tab:ShowWindow(1)
    local rand_icor_slot = GET_CHILD_RECURSIVELY(randomoption_bg, "rand_icor_slot")
    rand_icor_slot:SetMargin(50, 70, 0, 0);
    local goddess_icor_spot_text = GET_CHILD_RECURSIVELY(randomoption_bg, "goddess_icor_spot_text")
    goddess_icor_spot_text:SetMargin(50, 25, 0, 0);
    local goddess_icor_spot_list = GET_CHILD_RECURSIVELY(randomoption_bg, "goddess_icor_spot_list")
    goddess_icor_spot_list:SetMargin(50, 50, 0, 0);
    local before_preset_option_text = GET_CHILD_RECURSIVELY(randomoption_bg, "before_preset_option_text")
    before_preset_option_text:SetMargin(240, 280, 0, 0);
    local before_preset_option_bg = GET_CHILD_RECURSIVELY(randomoption_bg, "before_preset_option_bg")
    before_preset_option_bg:SetMargin(0, 310, 50, 0)
    before_preset_option_bg:Resize(319, 140)
    local current_icor_option_text = GET_CHILD_RECURSIVELY(randomoption_bg, "current_icor_option_text")
    current_icor_option_text:SetMargin(0, 40, 120, 0);
    local current_icor_option_bg = GET_CHILD_RECURSIVELY(randomoption_bg, "current_icor_option_bg")
    current_icor_option_bg:SetMargin(0, 70, 50, 0)
    current_icor_option_bg:Resize(319, 140)
    goddess_equip_manager:RemoveChild("exec_btn")
    goddess_equip_manager:RemoveChild("close_btn")
end

function Goddess_icor_manager__GODDESS_MGR_RANDOMOPTION_ENGRAVE_ICOR_EXEC()
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    if not goddess_equip_manager then
        return
    end
    session.ResetItemList()
    local rand_icor_slot = GET_CHILD_RECURSIVELY(goddess_equip_manager, "rand_icor_slot")
    local tgt_guid = rand_icor_slot:GetUserValue("ITEM_GUID")
    local tgt_item = session.GetInvItemByGuid(tgt_guid)
    if not tgt_item then
        ui.SysMsg(ClMsg("NoSelectedItem"))
        return
    end
    if tgt_item.isLockState == true then
        ui.SysMsg(ClMsg("MaterialItemIsLock"))
        return
    end
    local obj = GetIES(tgt_item:GetObject())
    session.AddItemID(tgt_guid, 1)
    local randomoption_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, "randomoption_bg")
    local index = randomoption_bg:GetUserValue("PRESET_INDEX")
    local spot = rand_icor_slot:GetUserValue("EQUIP_SPOT")
    local arg_list = NewStringList()
    arg_list:Add(index)
    local cls_id = obj.ClassID
    if shared_item_goddess_icor.get_goddess_icor_grade(obj) > 0 then
        arg_list:Add(spot)
    end
    local settings_cid = g.gim_settings[g.cid]
    if not settings_cid.icor_ids then
        settings_cid.icor_ids = {}
    end
    if not settings_cid.icor_ids[index] or type(settings_cid.icor_ids[index]) ~= "table" then
        settings_cid.icor_ids[index] = {}
    end
    settings_cid.icor_ids[index][spot] = cls_id
    local result_list = session.GetItemIDList()
    item.DialogTransaction("ICOR_PRESET_ENGRAVE_ICOR", result_list, "", arg_list)
    Goddess_icor_manager_save_settings()
    local rand_icor_mat_bg = GET_CHILD_RECURSIVELY(goddess_equip_manager, "rand_icor_mat_bg")
    GODDESS_MGR_ENGRAVE_ICOR_CLEAR_BTN(rand_icor_mat_bg)
    local gim = ui.GetFrame(addon_name_lower .. "gim")
    if gim and gim:IsVisible() == 1 then
        local page = gim:GetUserIValue("PAGE")
        if page == 0 then
            page = 1
        end
        Goddess_icor_manager_list_init(nil, nil, nil, page)
    end
end

function Goddess_icor_manager_get_pagename(index)
    local pc_etc = GetMyEtcObject()
    local acc = GetMyAccountObj()
    if pc_etc == nil or acc == nil then
        return nil
    end
    local page_name = TryGetProp(pc_etc, "RandomOptionPresetName_" .. index, "None")
    if page_name == "None" then
        return ScpArgMsg("EngravePageNumber{index}", "index", index)
    else
        return page_name
    end
end

function Goddess_icor_manager_GET_ENGRAVED_OPTION_LIST(etc, index, spot)
    if etc == nil then
        return nil
    end
    local suffix = string.format("_%d_%s", tonumber(index), spot)
    local option_prop = TryGetProp(etc, "RandomOptionPreset" .. suffix, "None")
    local group_prop = TryGetProp(etc, "RandomOptionGroupPreset" .. suffix, "None")
    local value_prop = TryGetProp(etc, "RandomOptionValuePreset" .. suffix, "None")
    if option_prop == "None" then
        return nil
    end
    local is_goddess_option = TryGetProp(etc, "IsGoddessIcorOption" .. suffix, 0)
    return option_prop, group_prop, value_prop, is_goddess_option
end

function Goddess_icor_manager_set_text(manage_bg, parts1, parts2, parts3, manage_text)
    for k = 1, #parts1 do
        local option = manage_bg:CreateOrGetControl("richtext", "option" .. k, 5, k * 20)
        local color = Goddess_icor_manager_color(tostring(parts2[k]))
        option:SetText("{ol}{s15}" .. color .. ClMsg(parts1[k]) .. "{ol}{#FFFFFF} : " .. parts3[k])
        option:AdjustFontSizeByWidth(265)
    end
end

function Goddess_icor_manager_color(str)
    if str == "UTIL_ARMOR" then
        return "{#9966CC}"
    elseif str == "STAT" then
        return "{#00FF00}"
    elseif str == "ATK" then
        return "{#FF4040}"
    elseif str == "DEF" then
        return "{#66B3FF}"
    elseif str == "SPECIAL" then
        return "{#FFD700}"
    else
        return "{#FFFFFF}"
    end
end
-- goddess_icor_manager ここまで

-- vakarine_equip ここから
function Vakarine_equip_save_settings()
    g.save_json(g.vakarine_equip_path, g.vakarine_equip_settings)
end

function Vakarine_equip_load_settings()
    g.vakarine_equip_path = string.format("../addons/%s/%s/vakarine_equip.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.vakarine_equip_path)
    if not settings then
        settings = {
            buffid = {},
            delay = 0.1,
            jsr = 0,
            x = 0,
            y = 0,
            move = 1,
            chars = {},
            auto_remove = 0
        }
    end
    g.vakarine_equip_settings = settings
    Vakarine_equip_save_settings()
end

function vakarine_equip_on_init()
    ui.SetHoldUI(false)
    if not g.vakarine_equip_settings then
        Vakarine_equip_load_settings()
    end
    if not g.vakarine_equip_settings.chars[g.cid] then
        Vakarine_equip_chrs_settings()
    end
    if g.settings.vakarine_equip.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "vakarine_equip")
        return
    end
    g.addon:RegisterMsg('STAT_UPDATE', 'Vakarine_equip_stat_update')
    g.addon:RegisterMsg('TAKE_DAMAGE', 'Vakarine_equip_stat_update')
    g.addon:RegisterMsg('TAKE_HEAL', 'Vakarine_equip_stat_update')
    g.addon:RegisterMsg('BUFF_ADD', 'Vakarine_equip_BUFF_ON_MSG')
    g.addon:RegisterMsg('BUFF_UPDATE', 'Vakarine_equip_BUFF_ON_MSG')
    Vakarine_equip_frame_init()
    if g.get_map_type() ~= "City" then
        Vakarine_equip_start_operation()
    end
end

function Vakarine_equip_chrs_settings()
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB", "RING1", "RING2", "SHIRT", "PANTS", "GLOVES", "BOOTS", "SHOULDER",
                    "BELT", "NECK"}
    g.vakarine_equip_settings.chars[g.cid] = {
        use = 0
    }
    for _, equip in ipairs(equips) do
        g.vakarine_equip_settings.chars[g.cid][equip] = 0
    end
    Vakarine_equip_save_settings()
end

function Vakarine_equip_frame_init()
    local vakarine_equip = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "vakarine_equip", 0, 0, 0, 0)
    AUTO_CAST(vakarine_equip)
    vakarine_equip:SetSkinName("None")
    vakarine_equip:SetTitleBarSkin("None")
    vakarine_equip:Resize(40, 30)
    vakarine_equip:SetGravity(ui.RIGHT, ui.TOP)
    vakarine_equip:EnableMove(g.vakarine_equip_settings.move == 1 and 0 or 1)
    vakarine_equip:EnableHittestFrame(1)
    local rect = vakarine_equip:GetMargin()
    vakarine_equip:SetMargin(rect.left - rect.left, rect.top - rect.top + 300,
        rect.right == 0 and rect.right + 10 or rect.right, rect.bottom)
    if g.vakarine_equip_settings.x ~= 0 and g.vakarine_equip_settings.y ~= 0 then
        vakarine_equip:SetPos(g.vakarine_equip_settings.x, g.vakarine_equip_settings.y)
    end
    vakarine_equip:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_location_save")
    local vaka_pic = vakarine_equip:CreateOrGetControl("picture", "vaka_pic", 0, 0, 30, 30)
    AUTO_CAST(vaka_pic)
    vaka_pic:SetImage("bakarine_emotion68") -- vaka_pic:SetImage("bakarine_emotion61") vaka_pic:SetImage("emoticon_0024")
    vaka_pic:SetColorTone("FFFFFFFF")
    vaka_pic:SetEnableStretch(1)
    vaka_pic:EnableHitTest(1)
    vaka_pic:SetGravity(ui.LEFT, ui.TOP)
    vaka_pic:SetTextTooltip(g.lang == "Japanese" and
                                "{ol}Vakarine Equip{nl} {nl}左クリック{nl}街: 設定{nl}街以外: 手動起動{nl} {nl}右クリック{nl}自動起動ON/OFF" or
                                "{ol}Vakarine Equip{nl} {nl}Left click{nl}City: Setup{nl}Outside City: Manual activation{nl} {nl}Right click: Auto-activation ON/OFF")
    if g.vakarine_equip_settings.chars[g.cid].use == 0 then
        vaka_pic:SetColorTone("FF555555")
    else
        vaka_pic:SetColorTone("FFFFFFFF")
    end
    vaka_pic:SetEventScript(ui.RBUTTONUP, "Vakarine_equip_onoff_switch")
    vaka_pic:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_config_or_startup")
    vakarine_equip:ShowWindow(1)
    if g.vakarine_equip_animas_iesid and g.get_map_type() == "City" then
        vakarine_equip:RunUpdateScript("Vakarine_equip_animas_equip", 1.0)
    end
end

function Vakarine_equip_location_save(frame, ctrl)
    if frame:GetName() == addon_name_lower .. "vakarine_equip" then
        g.vakarine_equip_settings.x = frame:GetX()
        g.vakarine_equip_settings.y = frame:GetY()
    elseif ctrl:GetName() == "default_btn" then
        g.vakarine_equip_settings.x = 0
        g.vakarine_equip_settings.y = 0
        ui.DestroyFrame(addon_name_lower .. "vakarine_equip")
        ReserveScript("Vakarine_equip_frame_init()", 0.1)
    end
    Vakarine_equip_save_settings()
end

function Vakarine_equip_onoff_switch(vakarine_equip, vaka_pic)
    if g.vakarine_equip_settings.chars[g.cid].use == 0 then
        g.vakarine_equip_settings.chars[g.cid].use = 1
        vaka_pic:SetColorTone("FFFFFFFF")
    else
        vaka_pic:SetColorTone("FF555555")
        g.vakarine_equip_settings.chars[g.cid].use = 0
    end
    Vakarine_equip_save_settings()
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        Vakarine_equip_buff_list(nil, nil, "")
        return
    end
end

function Vakarine_equip_animas_equip(vakarine_equip)
    local equip_item_list = session.GetEquipItemList()
    local equip_item = equip_item_list:GetEquipItemByIndex(19)
    if equip_item then
        local iesid = equip_item:GetIESID()
        local try = vakarine_equip:GetUserIValue("TRY")
        if iesid ~= g.vakarine_equip_animas_iesid and try < 3 then
            local equip_item = session.GetInvItemByGuid(g.vakarine_equip_animas_iesid)
            item.Equip(equip_item.invIndex)
            vakarine_equip:GetUserIValue("TRY", try + 1)
            return 1
        end
    end
    vakarine_equip:GetUserIValue("TRY", 0)
    g.vakarine_equip_animas_iesid = nil
    return 0
end

function Vakarine_equip_config_or_startup(frame, ctrl)
    if g.get_map_type() == "City" then
        Vakarine_equip_config_frame_open()
    else
        Vakarine_equip_start_operation(true)
    end
end

function Vakarine_equip_start_operation(is_manual)
    if not is_manual then
        local char_data = g.vakarine_equip_settings.chars[g.cid]
        if not char_data or char_data.use == 0 then
            return
        end
    end
    local is_vakarine = Vakarine_equip_is_vakarine()
    if not is_vakarine and not is_manual then
        return
    end
    local is_valid_map =
        (g.get_map_type() == "Instance" and g.map_id ~= 11227) -- 11244 聖域3F 11227 分裂 8022 ヴェルニケ
        or g.map_id == 8022 or g.map_id == 11244
    if is_valid_map or is_manual or g.vakarine_equip_settings.jsr == 1 then
        g.vakarine_equip_field_boss = nil
        local inventory = ui.GetFrame("inventory")
        inventory:ShowWindow(1)
        DO_WEAPON_SLOT_CHANGE(inventory, 1)
        ui.SetHoldUI(true)
        local vakarine_equip = ui.GetFrame(addon_name_lower .. "vakarine_equip")
        vakarine_equip:RunUpdateScript("Vakarine_equip_holdui_release", 10.0)
        local equip_map = {
            RH = 8,
            LH = 9,
            RH_SUB = 30,
            LH_SUB = 31,
            RING1 = 17,
            RING2 = 18,
            SHIRT = 3,
            PANTS = 14,
            GLOVES = 4,
            BOOTS = 5,
            SHOULDER = 34,
            BELT = 33,
            NECK = 19
        }
        g.vakarine_equip_queue = {}
        local char_settings = g.vakarine_equip_settings.chars[g.cid]
        local equip_item_list = session.GetEquipItemList()
        for spot_name, index in pairs(equip_map) do
            local current_item = equip_item_list:GetEquipItemByIndex(index)
            if char_settings[spot_name] == 1 and current_item then
                table.insert(g.vakarine_equip_queue, {
                    spot = spot_name,
                    index = index,
                    iesid = current_item:GetIESID()
                })
            end
        end
        local animas_item = session.GetInvItemByName("NECK04_103")
        g.vakarine_equip_animas_iesid = animas_item and animas_item:GetIESID() or nil
        if #g.vakarine_equip_queue == 0 then
            ui.SetHoldUI(false)
            return
        end
        for i, data in ipairs(g.vakarine_equip_queue) do
            if data.spot == "RH_SUB" then
                item.UnEquip(data.index)
                break
            end
        end
        g.vakarine_equip_process_step = "unequip"
        vakarine_equip:RunUpdateScript("Vakarine_equip_main_loop", g.vakarine_equip_settings.delay)
    end
end

function Vakarine_equip_main_loop(vakarine_equip)
    local equip_item_list = session.GetEquipItemList()
    if g.vakarine_equip_process_step == "unequip" then
        local all_unequipped = true
        for _, data in ipairs(g.vakarine_equip_queue) do
            local current_item = equip_item_list:GetEquipItemByIndex(data.index)
            if current_item and current_item:GetIESID() ~= "0" then
                item.UnEquip(data.index)
                return 1
            end
        end
        if all_unequipped then
            g.vakarine_equip_process_step = "equip"
        end
        return 1
    elseif g.vakarine_equip_process_step == "equip" then
        local weapon_order = {"RH", "LH", "RH_SUB", "LH_SUB"}
        for _, spot_name in ipairs(weapon_order) do
            for _, data in ipairs(g.vakarine_equip_queue) do
                if data.spot == spot_name then
                    local current_item = equip_item_list:GetEquipItemByIndex(data.index)
                    if not current_item or current_item:GetIESID() ~= data.iesid then
                        local inv_item = session.GetInvItemByGuid(data.iesid)
                        if inv_item then
                            ITEM_EQUIP(inv_item.invIndex, data.spot)
                            return 1
                        end
                    end
                    break
                end
            end
        end
        for _, data in ipairs(g.vakarine_equip_queue) do
            local spot_name = data.spot
            if spot_name ~= "RH" and spot_name ~= "LH" and spot_name ~= "RH_SUB" and spot_name ~= "LH_SUB" and spot_name ~=
                "NECK" then
                local current_item = equip_item_list:GetEquipItemByIndex(data.index)
                if not current_item or current_item:GetIESID() ~= data.iesid then
                    local inv_item = session.GetInvItemByGuid(data.iesid)
                    if inv_item then
                        ITEM_EQUIP(inv_item.invIndex, data.spot)
                        return 1
                    end
                end
            end
        end
        for _, data in ipairs(g.vakarine_equip_queue) do
            if data.spot == "NECK" then
                local iesid_to_equip = g.vakarine_equip_animas_iesid or data.iesid
                local current_item = equip_item_list:GetEquipItemByIndex(data.index)
                local current_iesid = current_item and current_item:GetIESID() or "0"
                if current_iesid ~= iesid_to_equip then
                    local inv_item = session.GetInvItemByGuid(iesid_to_equip)
                    if inv_item then
                        ITEM_EQUIP(inv_item.invIndex, data.spot)
                        return 1
                    end
                end
                break
            end
        end
        local inventory = ui.GetFrame("inventory")
        inventory:ShowWindow(0)
        imcAddOn.BroadMsg("NOTICE_Dm_stage_start", "[VE]End of Operation", 3)
        ui.SetHoldUI(false)
        return 0
    end
    return 1
end

function Vakarine_equip_is_vakarine()
    local equip_item_list = session.GetEquipItemList()
    local equip_guid_list = equip_item_list:GetGuidList()
    local count = equip_guid_list:Count()
    local vakarine_count = 0
    for i = 0, count - 1 do
        local guid = equip_guid_list:Get(i)
        if guid ~= '0' then
            local equip_item = equip_item_list:GetItemByGuid(guid)
            local item = GetIES(equip_item:GetObject())
            for j = 1, MAX_OPTION_EXTRACT_COUNT do
                local prop_name = "RandomOption_" .. j
                local cls_msg = ScpArgMsg(item[prop_name])
                if string.find(cls_msg, "vakarine_bless") then
                    vakarine_count = vakarine_count + 1
                    break
                end
            end
        end
    end
    if vakarine_count >= 5 then
        return true
    elseif vakarine_count == 4 then
        return false
    else
        return false
    end
end

function Vakarine_equip_holdui_release(frame)
    ui.SetHoldUI(false)
    return 0
end

function Vakarine_equip_config_frame_open()
    local config = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "vakarine_equip_config_frame", 0, 0, 0, 0)
    AUTO_CAST(config)
    config:RemoveAllChild()
    config:SetLayerLevel(999)
    config:SetSkinName("test_frame_low")
    local title_text = config:CreateOrGetControl("richtext", "title_text", 10, 10)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Vakarine Equip")
    local config_gb = config:CreateOrGetControl("groupbox", "config_gb", 10, 40, 0, 0)
    AUTO_CAST(config_gb)
    config_gb:SetSkinName("bg")
    local close = config:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_frame_close")
    local jsr_check = config_gb:CreateOrGetControl('checkbox', "jsr_check", 10, 5, 30, 30)
    AUTO_CAST(jsr_check)
    jsr_check:SetCheck(g.vakarine_equip_settings.jsr)
    local text = g.lang == "Japanese" and "チェックするとJSRで作動" or "Activated in JSR when checked"
    jsr_check:SetText("{ol}" .. text)
    jsr_check:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_check_switch")
    local x = 0
    local width = jsr_check:GetWidth()
    if x < width then
        x = width
    end
    local y = 40
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB", "RING1", "RING2", "SHIRT", "PANTS", "GLOVES", "BOOTS", "SHOULDER",
                    "BELT", "NECK"}
    for i, equip_name in ipairs(equips) do
        local check_box = config_gb:CreateOrGetControl('checkbox', "check_box" .. i, 20, y, 30, 30)
        AUTO_CAST(check_box)
        check_box:SetCheck(g.vakarine_equip_settings.chars[g.cid][equip_name])
        check_box:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックした装備を脱着します" or
                                     "{ol}Remove and detach checked equipment")
        check_box:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_check_switch")
        check_box:SetEventScriptArgString(ui.LBUTTONUP, equip_name)
        if equip_name == "RING1" then
            equip_name = "Ring1"
        elseif equip_name == "RING2" then
            equip_name = "Ring2"
        elseif equip_name == "SHIRT" then
            equip_name = "Shirt"
        elseif equip_name == "PANTS" then
            equip_name = "Pants"
        end
        check_box:SetText("{ol}" .. ClMsg(equip_name))
        y = y + 30
    end
    y = y + 10
    local move_check = config_gb:CreateOrGetControl('checkbox', "move_check", 10, y, 30, 30)
    AUTO_CAST(move_check)
    move_check:SetCheck(g.vakarine_equip_settings.move)
    move_check:SetText(g.lang == "Japanese" and "{ol}チェックするとフレーム固定" or
                           "{ol}If checked, the frame is fixed")
    move_check:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_check_switch")
    y = y + 40
    local default_btn = config_gb:CreateOrGetControl("button", "default_btn", 20, y, 120, 30)
    AUTO_CAST(default_btn)
    default_btn:SetText(g.lang == "Japanese" and "{ol}フレーム初期位置" or "{ol}Init frame pos")
    default_btn:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_location_save")
    y = y + 30
    config:Resize(x + 70, y + 60)
    config_gb:Resize(x + 50, y + 10)
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    if list_frame then
        config:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    else
        local map_frame = ui.GetFrame("map")
        local width = map_frame:GetWidth()
        config:SetPos(width / 2 - config:GetWidth() / 2 or 1165, 105)
    end
    config:ShowWindow(1)
end

function Vakarine_equip_check_switch(config, ctrl, equip_name, num)
    local ischeck = ctrl:IsChecked()
    if ctrl:GetName() == "jsr_check" then
        g.vakarine_equip_settings.jsr = ischeck
    elseif ctrl:GetName() == "move_check" then
        g.vakarine_equip_settings.move = ischeck
        Vakarine_equip_frame_init()
    elseif string.find(ctrl:GetName(), "check_box") then
        g.vakarine_equip_settings.chars[g.cid][equip_name] = ischeck
        if equip_name == "RH_SUB" then
            g.vakarine_equip_settings.chars[g.cid]["LH_SUB"] = ischeck
        elseif equip_name == "LH_SUB" then
            g.vakarine_equip_settings.chars[g.cid]["RH_SUB"] = ischeck
        end
        Vakarine_equip_config_frame_open()
    end
    Vakarine_equip_save_settings()
end

function Vakarine_equip_stat_update()
    if g.settings.vakarine_equip.use == 0 then
        return
    end
    g.vakarine_equip_is_vakarine = Vakarine_equip_is_vakarine()
    local charbaseinfo1_my = ui.GetFrame("charbaseinfo1_my")
    if not charbaseinfo1_my then
        return
    end
    local hp = GET_CHILD(charbaseinfo1_my, "pcHpGauge")
    AUTO_CAST(hp)
    local handle = session.GetMyHandle()
    local stat = info.GetStat(handle)
    local hp_now = (stat.HP * 100) / stat.maxHP
    local status = ''
    local color = ""
    if (hp_now == 100) then
        color = '#00EC00'
        status = 'Perfect'
    elseif g.vakarine_equip_is_vakarine and (hp_now <= 45) then
        color = '#EA0000'
        status = 'Revenge'
    elseif not g.vakarine_equip_is_vakarine and (hp_now <= 35) then
        color = '#EA0000'
        status = 'Revenge'
    elseif hp_now == 0 then
        color = '#FFFFFF'
    else
        color = '#FFFFFF'
    end
    local effecttext =
        charbaseinfo1_my:CreateOrGetControl("richtext", "effecttext", 0, 0, hp:GetWidth(), hp:GetHeight())
    effecttext:SetText(string.format('{ol}{%s}{%s}%s', "s15", color, status))
    effecttext:SetGravity(ui.RIGHT, ui.TOP)
    effecttext:SetOffset(hp:GetX(), hp:GetY() - 25 - (15 - 15))
    local hptext = charbaseinfo1_my:CreateOrGetControl("richtext", "hptext", 0, 0, hp:GetWidth(), hp:GetHeight())
    hptext:SetText(string.format('{%s}{ol}{%s}%d%%', "s15", color, hp_now))
    hptext:SetGravity(ui.RIGHT, ui.TOP)
    hptext:SetOffset(hp:GetX(), hp:GetY() - 10 - (15 - 15))
end

function Vakarine_equip_BUFF_ON_MSG(frame, msg, str, buff_id)
    if g.settings.vakarine_equip.use == 0 then
        return
    end
    if g.vakarine_equip_settings and g.vakarine_equip_settings["buffid"] then
        for id_str, val in pairs(g.vakarine_equip_settings["buffid"]) do
            if tonumber(id_str) == buff_id then
                if g.vakarine_equip_settings.auto_remove == 1 then
                    if val and g.vakarine_equip_is_vakarine then
                        packet.ReqRemoveBuff(buff_id) -- 良くないね
                        return
                    end
                end
            end
        end
    end
end

function Vakarine_equip_buff_list(buff_list, ctrl, ctrl_text)
    local buff_list = ui.GetFrame(addon_name_lower .. "Vakarine_equip_buff_list")
    if not buff_list then
        buff_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "vakarine_equip_buff_list", 0, 0, 0, 0)
        AUTO_CAST(buff_list)
        buff_list:SetSkinName("test_frame_low")
        buff_list:Resize(500, 1060)
        buff_list:SetPos(150, 10)
        buff_list:SetLayerLevel(121)
        local search_edit = buff_list:CreateOrGetControl("edit", "search_edit", 40, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Vakarine_equip_buff_list_search")
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_buff_list_search")
        local func_toggle = buff_list:CreateOrGetControl('checkbox', 'func_toggle', 415, 15, 25, 25)
        AUTO_CAST(func_toggle)
        func_toggle:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると自動バフ削除有効化" or
                                       "{ol}Check to enable auto buff removal")
        func_toggle:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_buff_aoto_remove")
        func_toggle:SetCheck(g.vakarine_equip_settings.auto_remove or 0)
        local close = buff_list:CreateOrGetControl('button', 'close', 0, 0, 20, 20)
        AUTO_CAST(close)
        close:SetImage("testclose_button")
        close:SetGravity(ui.RIGHT, ui.TOP)
        close:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_frame_close")
    end
    local buff_list_gb = buff_list:CreateOrGetControl("groupbox", "buff_list_gb", 10, 50, 480,
        buff_list:GetHeight() - 60)
    AUTO_CAST(buff_list_gb)
    buff_list_gb:SetSkinName("bg")
    buff_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Buff")
    local all_buffs = {}
    for i = 0, count - 1 do
        local buff_cls = GetClassByIndexFromList(cls_list, i)
        if buff_cls then
            if buff_cls.Group1 ~= 'Debuff' and buff_cls.Group1 ~= 'Deuff' then
                local buff_name = dictionary.ReplaceDicIDInCompStr(buff_cls.Name)
                if not ctrl_text or ctrl_text == "" or string.find(buff_name, ctrl_text) then
                    local image_name = GET_BUFF_ICON_NAME(buff_cls)
                    if image_name ~= "icon_None" and buff_name ~= "None" then
                        local is_checked = g.vakarine_equip_settings["buffid"][tostring(buff_cls.ClassID)] == true
                        table.insert(all_buffs, {
                            cls = buff_cls,
                            name = buff_name,
                            image = image_name,
                            is_checked = is_checked
                        })
                    end
                end
            end
        end
    end
    table.sort(all_buffs, function(a, b)
        if a.is_checked and not b.is_checked then
            return true
        elseif not a.is_checked and b.is_checked then
            return false
        else
            return a.cls.ClassID < b.cls.ClassID
        end
    end)
    local y = 0
    for _, buff_data in ipairs(all_buffs) do
        local buff_cls = buff_data.cls
        local buff_id = buff_cls.ClassID
        local buff_slot = buff_list_gb:CreateOrGetControl('slot', 'buffslot' .. buff_id, 10, y + 5, 30, 30)
        AUTO_CAST(buff_slot)
        SET_SLOT_IMG(buff_slot, buff_data.image)
        local icon = CreateIcon(buff_slot)
        AUTO_CAST(icon)
        icon:SetTooltipType('buff')
        icon:SetTooltipArg(buff_data.name, buff_id, 0)
        local buff_check = buff_list_gb:CreateOrGetControl('checkbox', 'buff_check' .. buff_id, 50, y + 10, 200, 30)
        AUTO_CAST(buff_check)
        buff_check:SetText("{ol}" .. buff_id .. " : " .. buff_data.name)
        buff_check:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると自動でバフ削除" or
                                      "{ol}Check to automatically remove buff")
        buff_check:SetCheck(buff_data.is_checked and 1 or 0)
        buff_check:SetEventScript(ui.LBUTTONUP, "Vakarine_equip_buff_toggle")
        buff_check:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        y = y + 35
    end
    buff_list:ShowWindow(1)
end

function Vakarine_equip_buff_list_search(buff_list, ctrl, ctrl_text, num)
    local search_edit = GET_CHILD_RECURSIVELY(buff_list, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Vakarine_equip_buff_list(buff_list, ctrl, ctrl_text)
    else
        Vakarine_equip_buff_list(buff_list, ctrl, "")
    end
end

function Vakarine_equip_buff_aoto_remove()
    if g.vakarine_equip_settings.auto_remove == 0 then
        g.vakarine_equip_settings.auto_remove = 1
    else
        g.vakarine_equip_settings.auto_remove = 0
    end
    Vakarine_equip_save_settings()
end

function Vakarine_equip_buff_toggle(frame, ctrl, str_buff_id, num)
    local is_check = ctrl:IsChecked()
    if is_check == 1 then
        g.vakarine_equip_settings["buffid"][str_buff_id] = true
    else
        g.vakarine_equip_settings["buffid"][str_buff_id] = false
    end
    Vakarine_equip_save_settings()
end

function Vakarine_equip_frame_close(frame, ctrl, str, num)
    ui.DestroyFrame(frame:GetName())
end
-- vakarine_equip ここまで

-- sub_slotset ここから
function Sub_slotset_save_settings()
    g.save_json(g.sub_slotset_path, g.sub_slotset_settings)
end

function Sub_slotset_load_settings()
    g.sub_slotset_path = string.format("../addons/%s/%s/sub_slotset.json", addon_name_lower, g.active_id)
    g.sub_slotset_old_path = string.format("../addons/%s/%s/settings.json", "sub_slotset", g.active_id)
    local settings = g.load_json(g.sub_slotset_path)
    if not settings then
        settings = {
            config = {
                index = 0
            },
            share = {},
            personal = {}
        }
        local old_settings = g.load_json(g.sub_slotset_old_path)
        if old_settings then
            for ss_name, data in pairs(old_settings) do
                if string.find(ss_name, "sub_slotset_") then
                    if data.etc then
                        data.etc.x = data.etc.X
                        data.etc.y = data.etc.Y
                        data.etc.col = data.etc.column
                        data.etc.X = nil
                        data.etc.Y = nil
                        data.etc.column = nil
                    end
                    settings.share["sub_slotset_" .. settings.config.index] = data
                    settings.config.index = settings.config.index + 1
                end
            end
        end
    end
    g.sub_slotset_settings = settings
    Sub_slotset_save_settings()
end

function Sub_slotset_char_load_settings()
    g.sub_slotset_old_personal_path = string.format("../addons/%s/%s.json", "sub_slotset", g.cid)
    if not g.sub_slotset_settings.personal[g.cid] then
        g.sub_slotset_settings.personal[g.cid] = {}
        local old_personal_settings = g.load_json(g.sub_slotset_old_personal_path)
        if old_personal_settings then
            for ss_name, data in pairs(old_personal_settings) do
                if string.find(ss_name, "sub_slotset_") then
                    if data.etc then
                        data.etc.x = data.etc.X
                        data.etc.y = data.etc.Y
                        data.etc.col = data.etc.column
                        data.etc.X = nil
                        data.etc.Y = nil
                        data.etc.column = nil
                    end
                    local new_index = g.sub_slotset_settings.config.index
                    g.sub_slotset_settings.personal[g.cid]["sub_slotset_" .. new_index] = data
                    g.sub_slotset_settings.config.index = new_index + 1
                end
            end
        end
        Sub_slotset_save_settings()
    end
end

function sub_slotset_on_init()
    if not g.sub_slotset_settings then
        Sub_slotset_load_settings()
    end
    local old_func = g.settings.sub_slotset.old_init_func
    if _G[old_func] then
        return
    end
    if not g.sub_slotset_settings.personal[g.cid] then
        Sub_slotset_char_load_settings()
    end
    g.setup_hook_and_event(g.addon, "SET_QUEST_CTRL_TEXT", "Sub_slotset_SET_QUEST_CTRL_TEXT", true)
    g.setup_hook_and_event(g.addon, "EMO_OPEN", "Sub_slotset_EMO_OPEN", true)
    if g.settings.sub_slotset.use == 0 then
        if g.sub_slotset_settings.share then
            for ss_name, data in pairs(g.sub_slotset_settings.share) do
                ui.DestroyFrame(addon_name_lower .. ss_name)
            end
        end
        if g.sub_slotset_settings.personal[g.cid] then
            for ss_name, data in pairs(g.sub_slotset_settings.personal[g.cid]) do
                ui.DestroyFrame(addon_name_lower .. ss_name)
            end
        end
        return
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("Sub_slotset_frame_init", 0.1)
end

function Sub_slotset_EMO_OPEN(my_frame, my_msg)
    if g.settings.sub_slotset.use == 0 then
        return
    end
    local button = g.get_event_args(my_msg)
    local chat_emoticon = ui.GetFrame("chat_emoticon")
    local group_name = chat_emoticon:GetUserValue("EMOTICON_GROUP")
    if group_name == "None" then
        group_name = "Normal"
    end
    local emoticons = GET_CHILD_RECURSIVELY(chat_emoticon, "emoticons")
    local slot_count = emoticons:GetSlotCount()
    local count = 0
    for i = 1, slot_count do
        local slot = GET_CHILD_RECURSIVELY(emoticons, "slot" .. i)
        local icon = slot:GetIcon()
        if icon then
            count = count + 1
        end
    end
    local gbox = GET_CHILD_RECURSIVELY(chat_emoticon, "gbox")
    gbox:RemoveAllChild()
    local emoticons = gbox:CreateOrGetControl('slotset', 'emoticons', 0, 0, 420, 0)
    AUTO_CAST(emoticons)
    emoticons:SetSlotSize(42, 42)
    emoticons:EnablePop(1)
    emoticons:EnableDrag(1)
    emoticons:EnableDrop(0)
    emoticons:EnableHitTest(1)
    emoticons:SetColRow(10, math.ceil(count / 10))
    emoticons:SetSpc(0, 0)
    emoticons:SetSkinName('invenslot')
    emoticons:CreateSlots()
    for i = 0, count - 1 do
        local slot = emoticons:GetSlotByIndex(i)
        AUTO_CAST(slot)
        local icon = CreateIcon(slot)
        slot:SetEventScript(ui.LBUTTONDOWN, "CHAT_EMOTICON_SELECT")
    end
    CHAT_EMOTICON_MAKELIST(chat_emoticon)
end

function Sub_slotset_SET_QUEST_CTRL_TEXT(my_frame, my_msg)
    if g.settings.sub_slotset.use == 0 then
        return
    end
    local quest_ctrl, quest_ies = g.get_event_args(my_msg)
    AUTO_CAST(quest_ctrl)
    --[[local nametxt = GET_CHILD(quest_ctrl, "name", "ui::CRichText")
    AUTO_CAST(nametxt)]]
    local leveltxt = GET_CHILD(quest_ctrl, "level", "ui::CRichText")
    AUTO_CAST(leveltxt)
    --[[local font = ""
    local color = ""
    if quest_ies.QuestMode == "MAIN" then
        font = quest_ctrl:GetUserConfig("MAIN_FONT")
        color = quest_ctrl:GetUserConfig("MAIN_COLOR")
    elseif quest_ies.QuestMode == "SUB" then
        font = quest_ctrl:GetUserConfig("SUB_FONT")
        color = quest_ctrl:GetUserConfig("SUB_COLOR")
    elseif quest_ies.QuestMode == "REPEAT" then
        font = quest_ctrl:GetUserConfig("REPEAT_FONT")
        color = quest_ctrl:GetUserConfig("REPEAT_COLOR")
    elseif quest_ies.QuestMode == "PARTY" then
        font = quest_ctrl:GetUserConfig("PARTY_FONT")
        color = quest_ctrl:GetUserConfig("PARTY_COLOR")
    elseif quest_ies.QuestMode == "KEYITEM" then
        font = quest_ctrl:GetUserConfig("KEYITEM_FONT")
        color = quest_ctrl:GetUserConfig("KEYITEM_COLOR")
    end
    nametxt:SetText(font .. color .. quest_ies.Name)
    leveltxt:SetText(color .. "Lv " .. quest_ies.Level)]]
    local rect = leveltxt:GetMargin()
    leveltxt:SetMargin(rect.left - 10, rect.top, rect.right, rect.bottom)
    local questmark = GET_CHILD(quest_ctrl, "questmark")
    AUTO_CAST(questmark)
    local image_name = questmark:GetImageName()
    local result = SCR_QUEST_CHECK_C(GetMyPCObject(), quest_ies.ClassName)
    if (result == 'POSSIBLE' and quest_ies.POSSI_WARP == 'YES') or
        (result == 'PROGRESS' and quest_ies.PROG_WARP == 'YES') or
        (result == 'SUCCESS' and quest_ies.SUCC_WARP == 'YES') then
        local slot = quest_ctrl:CreateOrGetControl("slot", "slot", 78, 5, 20, 20)
        AUTO_CAST(slot)
        slot:EnablePop(1)
        slot:EnableDrop(0)
        local icon = CreateIcon(slot)
        icon:SetImage("questinfo_return")
        icon:SetUserValue("QUEST_ID", quest_ies.ClassID)
        local msg = g.lang == "Japanese" and "{ol}Sub Slotset{nl}左クリック: スロットに登録" or
                        "{ol}Sub Slotset{nl}LeftClick:for Registration"
        icon:SetTextTooltip(msg)
    end
end

function Sub_slotset_frame_init()
    if g.sub_slotset_settings.share then
        for ss_name, data in pairs(g.sub_slotset_settings.share) do
            Sub_slotset_process(ss_name, data, true)
        end
    end
    if g.sub_slotset_settings.personal[g.cid] then
        for ss_name, data in pairs(g.sub_slotset_settings.personal[g.cid]) do
            Sub_slotset_process(ss_name, data, false)
        end
    end
    return 1
end

function Sub_slotset_process(ss_name, data, is_share)
    local frame_name = addon_name_lower .. ss_name
    local sub_slotset = ui.GetFrame(frame_name)
    if not sub_slotset then
        sub_slotset = ui.CreateNewFrame("notice_on_pc", frame_name, 0, 0, 0, 0)
        AUTO_CAST(sub_slotset)
        sub_slotset:SetSkinName("chat_window_2")
        sub_slotset:SetAlpha(20)
        sub_slotset:SetLayerLevel(data.etc.layer)
        sub_slotset:EnableHittestFrame(1)
        sub_slotset:SetEventScript(ui.LBUTTONUP, "Sub_slotset_end_drag")
        sub_slotset:SetEventScript(ui.RBUTTONUP, "Sub_slotset_rbtn")
        Sub_slotset_slotset_make(sub_slotset, data.etc, true)
        if is_share then
            local titlelabel = sub_slotset:CreateOrGetControl('richtext', 'titlelabel', 0, 0, 0, 0)
            titlelabel:SetTextAlign('center', 'center')
            titlelabel:SetGravity(ui.LEFT, ui.TOP)
            titlelabel:SetText("{ol}{s10}shared")
        else
            sub_slotset:RemoveChild("titlelabel")
        end
        if data.etc then
            if data.etc.x and data.etc.y then
                sub_slotset:SetPos(data.etc.x, data.etc.y)
            end
            sub_slotset:EnableMove(data.etc.lock and 0 or 1)
        end
    end
    if sub_slotset:IsVisible() == 0 then
        sub_slotset:ShowWindow(1)
    end
    Sub_slotset_update_contents(sub_slotset, data)
end

function Sub_slotset_change_layer(skillability)

end

function Sub_slotset_update_contents(sub_slotset, data)
    local slot_set = GET_CHILD(sub_slotset, "slotset")
    if not slot_set then
        return
    end
    slot_set:SetUserValue("LAYER", data.etc.layer)
    local skillability = ui.GetFrame("skillability")
    if skillability:IsVisible() == 1 then
        local lift_icon = ui.GetLiftIcon()
        if lift_icon then
            sub_slotset:SetLayerLevel(999)
        else
            sub_slotset:SetLayerLevel(data.etc.layer)
        end
    else
        sub_slotset:SetLayerLevel(data.etc.layer)
    end
    slot_set:EnablePop(data.etc.lock and 0 or 1)
    slot_set:EnableDrag(data.etc.lock and 0 or 1)
    slot_set:EnableDrop(data.etc.lock and 0 or 1)
    slot_set:EnableHitTest(1)
    local slot_count = slot_set:GetSlotCount()
    for i = 1, slot_count do
        local slot = GET_CHILD(slot_set, "slot" .. i)
        AUTO_CAST(slot)
        local str_i = tostring(i)
        local saved_item = data[str_i]
        slot:EnablePop(data.etc.lock and 0 or 1)
        slot:EnableDrag(data.etc.lock and 0 or 1)
        slot:EnableDrop(data.etc.lock and 0 or 1)
        slot:SetEventScript(ui.DROP, 'Sub_slotset_drop')
        slot:SetEventScriptArgNumber(ui.DROP, i)
        slot:SetEventScript(ui.POP, 'Sub_slotset_pop')
        slot:SetEventScriptArgString(ui.POP, str_i)
        slot:SetEventScript(ui.RBUTTONUP, 'Sub_slotset_slot_rbutton')
        if saved_item and saved_item.iesid then
            local iesid = saved_item.iesid
            local category = saved_item.category
            local cls_id = saved_item.clsid
            slot:EnableDrop(data.etc.lock and 0 or 1)
            slot:SetEventScriptArgNumber(ui.RBUTTONUP, cls_id)
            slot:SetEventScriptArgString(ui.RBUTTONUP, category)
            slot:SetEventScriptArgString(ui.DROP, category)
            local icon = slot:GetIcon()
            if not icon then
                icon = CreateIcon(slot)
            end
            if category == "Item" then
                local item_cls = GetClassByType("Item", cls_id)
                SET_SLOT_ITEM_CLS(slot, item_cls)
                local inv_item = session.GetInvItemByGuid(iesid) or session.GetInvItemByType(cls_id)
                if inv_item then
                    local item_obj = GetIES(inv_item:GetObject())
                    icon:SetColorTone('FFFFFFFF')
                    SET_SLOT_ITEM_IMAGE(slot, inv_item)
                    ICON_SET_ITEM_COOLDOWN_OBJ(icon, item_obj)
                    Sub_slotset_SET_SLOT_ITEM_TEXT(slot, inv_item, item_cls)
                else
                    icon:SetColorTone('FFFF0000')
                    slot:SetText("{s15}{ol}{b}" .. 0, 'count', ui.RIGHT, ui.BOTTOM, -2, 1);
                end
            elseif category == "Pose" then
                local pose = GetClassByType('Pose', cls_id)
                if pose then
                    icon:Set(pose.Icon, category, cls_id, 0, iesid)
                    icon:SetColorTone('FFFFFFFF')
                    icon:SetTextTooltip(pose.Name)
                end
                slot:ClearText()
            elseif category == "Skill" then
                icon:SetOnCoolTimeUpdateScp('ICON_UPDATE_SKILL_COOLDOWN')
                icon:SetEnableUpdateScp('ICON_UPDATE_SKILL_ENABLE')
                icon:SetColorTone('FFFFFFFF')
                icon:SetTooltipType('skill')
                icon:Set('icon_' .. GetClassString('Skill', cls_id, 'Icon'), category, cls_id, 0, iesid)
                icon:SetTooltipNumArg(cls_id)
                icon:SetTooltipIESID(iesid)
                slot:ClearText()
                QUICKSLOT_MAKE_GAUGE(slot)
                QUICKSLOT_SET_GAUGE_VISIBLE(slot, 0)
                SET_QUICKSLOT_OVERHEAT(slot)
            elseif category == 'Ability' then
                local pc = GetMyPCObject()
                local abil_class = GetClassByType("Ability", cls_id)
                local abil_ies = GetAbilityIESObject(pc, abil_class.ClassName)
                if abil_class then
                    icon:SetTooltipType("ability")
                    icon:SetTooltipNumArg(cls_id)
                    icon:Set(abil_class.Icon, category, cls_id, 0, iesid)
                    local abil_ies = GetAbilityIESObject(pc, abil_class.ClassName)
                    if abil_ies then
                        icon:SetColorTone('FFFFFFFF')
                        SET_ABILITY_TOGGLE_COLOR(icon, cls_id)
                    else
                        icon:SetColorTone('FFFF0000')
                    end
                end
                slot:ClearText()
            elseif category == 'Quest' then
                local pc = GetMyPCObject()
                local quest_ies = GetClassByType("QuestProgressCheck", cls_id)
                if quest_ies then
                    local result = SCR_QUEST_CHECK_Q(pc, quest_ies.ClassName)
                    local target_map_name = GET_QUEST_LOCATION(quest_ies)
                    local zone_name = GetClassString('Map', target_map_name, 'Name')
                    icon:SetImage("questinfo_return")
                    local check_result = SCR_QUEST_CHECK_C(pc, quest_ies.ClassName)
                    if (check_result == 'POSSIBLE' and quest_ies.POSSI_WARP == 'YES') or
                        (check_result == 'PROGRESS' and quest_ies.PROG_WARP == 'YES') or
                        (check_result == 'SUCCESS' and quest_ies.SUCC_WARP == 'YES') then
                        icon:SetColorTone('FFFFFFFF')
                    else
                        icon:SetColorTone('FFFF0000')
                    end
                    icon:SetTextTooltip("{ol}" .. quest_ies.Name)
                    SET_SLOT_COUNT_TEXT(slot, zone_name, '{s10}{ol}{b}', ui.LEFT, ui.BOTTOM, 0, 0)
                end
            elseif category == 'Emoticon' then
                local list, cnt = GetClassList("chat_emoticons")
                local acc_obj = GetMyAccountObj()
                local etc_obj = GetMyEtcObject()
                local target_group = cls_id
                for j = 0, cnt - 1 do
                    local cls = GetClassByIndexFromList(list, j)
                    if cls.IconGroup == target_group then
                        if iesid == cls.ClassName then
                            local image_name = cls.ClassName
                            local name_parts = StringSplit(cls.ClassName, "motion_")
                            if #name_parts > 1 then
                                image_name = name_parts[2]
                            end
                            slot:SetUserValue("EMO_ID", target_group)
                            local is_owned = false
                            if cls.CheckServer == 'YES' then
                                local target_obj = acc_obj
                                if TryGetProp(cls, 'HaveUnit', 'None') == 'PC' then
                                    target_obj = etc_obj
                                end
                                if TryGetProp(target_obj, 'HaveEmoticon_' .. cls.ClassID, 0) > 0 then
                                    is_owned = true
                                end
                            else
                                is_owned = true
                            end
                            if not icon then
                                icon = CreateIcon(slot)
                            end
                            icon:SetImage(image_name)
                            slot:ClearText()
                            if is_owned then
                                icon:SetColorTone('FFFFFFFF')
                            else
                                icon:SetColorTone('FF696969')
                            end
                            break
                        end
                    end
                end
            elseif category == 'None' then
                CLEAR_SLOT_ITEM_INFO(slot)
                slot:ClearText()
            end
        else
            slot:ClearIcon()
            slot:ClearText()
        end
    end
end

function Sub_slotset_SET_SLOT_ITEM_TEXT(slot, inv_item, item_obj)
    if item_obj.MaxStack > 1 then
        Sub_slotset_SET_SLOT_COUNT_TEXT(slot, inv_item.count)
        return
    end
    local lv = TryGetProp(item_obj, "Level");
    if lv and lv > 1 then
        slot:SetFrontImage('enchantlevel_indi_icon')
        slot:SetText('{s20}{ol}{#FFFFFF}{b}' .. lv, 'count', ui.LEFT, ui.TOP, 8, 2)
        return
    end
end

function Sub_slotset_SET_SLOT_COUNT_TEXT(slot, count, font)
    if not font then
        font = '{s15}{ol}{b}'
    end
    slot:SetText(font .. count, 'count', ui.RIGHT, ui.BOTTOM, -2, 1)
end

function Sub_slotset_pop(parent, slot, str_i, num)
    local sub_slotset = slot:GetTopParentFrame()
    local sub_slotset_name = string.gsub(sub_slotset:GetName(), addon_name_lower, "")
    local target_settings, is_share = Sub_slotset_get_settings(sub_slotset_name)
    if keyboard.IsKeyPressed("LSHIFT") == 1 then
        CLEAR_SLOT_ITEM_INFO(slot)
        target_settings[str_i] = nil
        Sub_slotset_save_settings()
        return
    end
    g.sub_slotset_drag = nil
    if target_settings and target_settings[str_i] then
        g.sub_slotset_drag = {
            index = str_i,
            data = target_settings[str_i],
            frame_name = sub_slotset_name
        }
    end
end

function Sub_slotset_drop(parent, slot, category, i)
    local sub_slotset = slot:GetTopParentFrame()
    local sub_slotset_name = string.gsub(sub_slotset:GetName(), addon_name_lower, "")
    local target_settings, is_share = Sub_slotset_get_settings(sub_slotset_name)
    if not target_settings then
        return
    end
    local str_i = tostring(i)
    if g.sub_slotset_drag and g.sub_slotset_drag.frame_name == sub_slotset_name then
        local from_index = g.sub_slotset_drag.index
        if from_index == str_i then
            g.sub_slotset_drag = nil
            return
        end
        local swap_target = target_settings[str_i]
        target_settings[str_i] = g.sub_slotset_drag.data
        target_settings[from_index] = swap_target
        g.sub_slotset_drag = nil
        Sub_slotset_save_settings()
        Sub_slotset_update_contents(sub_slotset, target_settings)
        return
    end
    local lift_icon = ui.GetLiftIcon()
    local poseid = lift_icon:GetUserValue('POSEID')
    local info = lift_icon:GetInfo()
    if not info then
        return
    end
    local image = info:GetImageName()
    local cls_id = info.type
    local iesid = info:GetIESID()
    local category_val = info:GetCategory()
    local chat_emoticon = ui.GetFrame("chat_emoticon")
    local group_name = chat_emoticon:GetUserValue("EMOTICON_GROUP")
    if group_name == "Motion" then
        image = "motion_" .. image
    end
    if group_name == "None" then
        group_name = "Normal"
    end
    if string.find(image, "emot") then
        target_settings[str_i] = {
            category = "Emoticon",
            clsid = group_name,
            iesid = image
        }
        local chat = ui.GetFrame('chat')
        local mainchat = chat:GetChild('mainchat')
        SET_CHAT_TEXT_TO_CHATFRAME("")
        mainchat:RunEnterKeyScript()
        ui.ProcessReturnKey()
        chat:ShowWindow(0)
    elseif image == "questinfo_return" then
        local quest_id = lift_icon:GetUserIValue("QUEST_ID")
        target_settings[str_i] = {
            category = "Quest",
            clsid = quest_id,
            iesid = ""
        }
    elseif poseid ~= "None" then
        target_settings[str_i] = {
            category = 'Pose',
            clsid = poseid,
            iesid = ""
        }
    else
        target_settings[str_i] = {
            category = category_val,
            clsid = cls_id,
            iesid = iesid
        }
    end
    Sub_slotset_save_settings()
    Sub_slotset_update_contents(sub_slotset, target_settings)
end

function Sub_slotset_slot_rbutton(frame, slot, category, cls_id)
    if category == 'Item' then
        SLOT_ITEMUSE_BY_TYPE(frame, slot, category, cls_id)
    elseif category == 'Pose' then
        control.Pose(GetClassByType('Pose', cls_id).ClassName)
    elseif category == 'Skill' or category == 'Ability' then
        local icon = slot:GetIcon()
        if icon then
            ICON_USE(icon)
        end
    elseif category == 'Quest' then
        local quest_ies = GetClassByType("QuestProgressCheck", cls_id)
        local pc = GetMyPCObject()
        local result = SCR_QUEST_CHECK_Q(pc, quest_ies.ClassName)
        if (result == 'POSSIBLE' and quest_ies.POSSI_WARP == 'YES') or
            (result == 'PROGRESS' and quest_ies.PROG_WARP == 'YES') or
            (result == 'SUCCESS' and quest_ies.SUCC_WARP == 'YES') then
            local cheat = string.format("/retquest %d", cls_id)
            movie.QuestWarp(session.GetMyHandle(), cheat, 1)
            packet.ClientDirect("QuestWarp")
        else
            local icon = slot:GetIcon()
            if icon then
                icon:SetColorTone('FFFF0000')
            end
        end
    elseif category == 'Emoticon' then
        local icongroup = slot:GetUserValue("EMO_ID")
        local chat_emoticon = ui.GetFrame("chat_emoticon")
        local chat = ui.GetFrame('chat')
        local mainchat = chat:GetChild('mainchat')
        AUTO_CAST(mainchat)
        local icon = slot:GetIcon()
        if icon then
            local image_name = icon:GetInfo():GetImageName()
            local tag = ""
            if image_name ~= "" then
                if icongroup == 'Motion' then
                    local image_name = icon:GetInfo():GetImageName()
                    if not string.find(image_name, "motion_") then
                        image_name = "motion_" .. image_name
                        tag = string.format("{spine %s %d %d}{/}", image_name, 120, 120)
                    end
                else
                    tag = string.format("{img %s %d %d}{/}", image_name, 30, 30)
                end
                SET_CHAT_TEXT_TO_CHATFRAME(tag)
                mainchat:RunEnterKeyScript()
                ui.ProcessReturnKey()
                chat:ShowWindow(0)
            end
        end
    end
end

function Sub_slotset_get_settings(sub_slotset_name)
    local settings = g.sub_slotset_settings.share[sub_slotset_name]
    if settings then
        return settings, true
    end
    if g.sub_slotset_settings.personal[g.cid] then
        settings = g.sub_slotset_settings.personal[g.cid][sub_slotset_name]
        if settings then
            return settings, false
        end
    end
    return nil
end

function Sub_slotset_setting(sub_slotset_name)
    local x = 0
    local y = 0
    local is_new = true
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    if list_frame then
        x = list_frame:GetX() + list_frame:GetWidth()
        y = list_frame:GetY()
    else
        local client_Width = ui.GetClientInitialWidth() -- 1920
        local client_Height = ui.GetClientInitialHeight() -- 1080
        x = client_Width / 2
        y = client_Height / 2
        is_new = false
    end
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "sub_slotset_setting", 0, 0, 0, 0)
    AUTO_CAST(setting)
    setting:SetPos(x, y)
    setting:EnableHittestFrame(1)
    setting:SetLayerLevel(999)
    setting:RemoveAllChild()
    setting:SetSkinName("test_frame_low")
    local title_text = setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    if is_new then
        title_text:SetText("{ol}Sub Slotset Config")
    else
        title_text:SetText("{ol}{s14}Sub Slotset Resettings")
    end
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Sub_slotset_setting_close")
    local gbox = setting:CreateOrGetControl("groupbox", "gbox", 10, 40, 0, 0)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    g.sub_slotset_col = g.sub_slotset_col or 3
    g.sub_slotset_row = g.sub_slotset_row or 3
    g.sub_slotset_size = g.sub_slotset_size or 48
    g.sub_slotset_layer = g.sub_slotset_layer or 90
    g.sub_slotset_personal = g.sub_slotset_personal or 0
    local col = gbox:CreateOrGetControl("richtext", "col", 10, 10, 80, 25)
    AUTO_CAST(col)
    col:SetText("{ol}{s16}Column")
    local col_edit = gbox:CreateOrGetControl('edit', 'col_edit', 10, 35, 80, 25)
    AUTO_CAST(col_edit)
    col_edit:SetFontName('white_16_ol')
    col_edit:SetSkinName('test_weight_skin')
    col_edit:SetTextAlign('center', 'center')
    col_edit:SetText(g.sub_slotset_col)
    col_edit:SetNumberMode(1)
    col_edit:SetMaxLen(2)
    col_edit:SetTypingScp("Sub_slotset_setting_edit")
    col_edit:SetEventScript(ui.ENTERKEY, "Sub_slotset_setting_edit")
    local row = gbox:CreateOrGetControl("richtext", "row", 100, 10, 80, 25)
    AUTO_CAST(row)
    row:SetText("{ol}{s16}Row")
    local row_edit = gbox:CreateOrGetControl('edit', 'row_edit', 100, 35, 80, 25)
    AUTO_CAST(row_edit)
    row_edit:SetFontName('white_16_ol')
    row_edit:SetSkinName('test_weight_skin')
    row_edit:SetTextAlign('center', 'center')
    row_edit:SetNumberMode(1)
    row_edit:SetMaxLen(2)
    row_edit:SetText(g.sub_slotset_row)
    row_edit:SetTypingScp("Sub_slotset_setting_edit")
    row_edit:SetEventScript(ui.ENTERKEY, "Sub_slotset_setting_edit")
    local size = gbox:CreateOrGetControl("richtext", "size", 10, 70, 80, 25)
    AUTO_CAST(size)
    size:SetText("{ol}{s16}Slot Size")
    local size_edit = gbox:CreateOrGetControl('edit', 'size_edit', 10, 95, 80, 25)
    AUTO_CAST(size_edit)
    size_edit:SetFontName('white_16_ol')
    size_edit:SetSkinName('test_weight_skin')
    size_edit:SetTextAlign('center', 'center')
    size_edit:SetNumberMode(1)
    size_edit:SetText(g.sub_slotset_size)
    size_edit:SetMaxLen(2)
    size_edit:SetTypingScp("Sub_slotset_setting_edit")
    size_edit:SetEventScript(ui.ENTERKEY, "Sub_slotset_setting_edit")
    local layer = gbox:CreateOrGetControl("richtext", "layer", 100, 70, 80, 25)
    AUTO_CAST(layer)
    layer:SetText("{ol}{s16}Layer")
    local layer_edit = gbox:CreateOrGetControl('edit', 'layer_edit', 100, 95, 80, 25)
    AUTO_CAST(layer_edit)
    layer_edit:SetFontName('white_16_ol')
    layer_edit:SetSkinName('test_weight_skin')
    layer_edit:SetTextAlign('center', 'center')
    layer_edit:SetNumberMode(1)
    layer_edit:SetText(g.sub_slotset_layer)
    layer_edit:SetMaxLen(3)
    layer_edit:SetTypingScp("Sub_slotset_setting_edit")
    layer_edit:SetEventScript(ui.ENTERKEY, "Sub_slotset_setting_edit")
    local parsonal = gbox:CreateOrGetControl("checkbox", "parsonal", 10, 130, 30, 30)
    AUTO_CAST(parsonal)
    if is_new then
        parsonal:SetTextTooltip(g.lang == "Japanese" and
                                    "{ol}チェックを入れるとキャラ用に作成{nl}後から変更可能" or
                                    "{ol}If checked, created for the character{nl}Can be changed later")
        parsonal:SetText(g.lang == "Japanese" and "{ol}キャラクター専用" or "{ol}Character Only")
        parsonal:SetCheck(g.sub_slotset_personal)
        local make = gbox:CreateOrGetControl('button', 'make', 100, 165, 80, 30)
        AUTO_CAST(make)
        make:SetSkinName("test_red_button")
        make:SetText("{ol}{s16}Make")
        make:SetEventScript(ui.LBUTTONUP, "Sub_slotset_make")
    else
        parsonal:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックを入れるとキャラ用に切替" or
                                    "{ol}If checked, switches to character-specific setting")
        parsonal:SetText(g.lang == "Japanese" and "{ol}共有/キャラ切替" or "{ol}Shared/Character{nl}Switch")
        local target_settings = g.sub_slotset_settings.share[sub_slotset_name]
        parsonal:SetCheck(target_settings and 0 or 1)
        parsonal:SetEventScript(ui.LBUTTONUP, "Sub_slotset_setting_checkbox")
        local change = gbox:CreateOrGetControl('button', 'change', 100, 165, 80, 30)
        AUTO_CAST(change)
        change:SetSkinName("test_red_button")
        change:SetText("{ol}{s16}Change")
        change:SetEventScript(ui.LBUTTONUP, "Sub_slotset_change")
        change:SetEventScriptArgString(ui.LBUTTONUP, sub_slotset_name)
    end
    parsonal:SetEventScript(ui.LBUTTONUP, "Sub_slotset_setting_checkbox")
    setting:Resize(210, 255)
    gbox:Resize(setting:GetWidth() - 20, setting:GetHeight() - 50)
    setting:ShowWindow(1)
end

function Sub_slotset_setting_close(setting)
    ui.DestroyFrame(setting:GetName())
end

function Sub_slotset_end_drag(sub_slotset, ctrl)
    local sub_slotset_name = string.gsub(sub_slotset:GetName(), addon_name_lower, "")
    local target_settings = Sub_slotset_get_settings(sub_slotset_name)
    if target_settings and target_settings.etc then
        target_settings.etc.x = sub_slotset:GetX()
        target_settings.etc.y = sub_slotset:GetY()
        Sub_slotset_save_settings()
    end
end

function Sub_slotset_setting_checkbox(parent, ctrl)
    g.sub_slotset_personal = ctrl:IsChecked()
end

function Sub_slotset_setting_edit(parent, ctrl)
    local ctrl_name = ctrl:GetName()
    local val = tonumber(ctrl:GetText())
    if not val then
        return
    end
    if (ctrl_name == "col_edit" or ctrl_name == "row_edit") and val > 10 then
        ui.SysMsg(g.lang == "Japanese" and "10以下で設定してください" or "Enter 10 or less")
        val = 10
        ctrl:SetText(val)
    end
    if ctrl_name == "col_edit" then
        g.sub_slotset_col = val
    elseif ctrl_name == "row_edit" then
        g.sub_slotset_row = val
    elseif ctrl_name == "size_edit" then
        local row_edit = GET_CHILD_RECURSIVELY(parent, "row_edit")
        local current_row = tonumber(row_edit:GetText())
        if not current_row or current_row == 0 then
            current_row = g.sub_slotset_row or 1
        end
        local map = ui.GetFrame("map")
        local h = map:GetHeight()
        local limit_size = math.floor(tonumber(h) / current_row)
        if val > limit_size then
            local msg = g.lang == "Japanese" and
                            string.format("入力は %d 以下に制限されています", limit_size) or
                            string.format("Input is limited to %d or less", limit_size)
            ui.SysMsg(msg)
            val = 48
            ctrl:SetText(val)
        end
        g.sub_slotset_size = val
    elseif ctrl_name == "layer_edit" then
        g.sub_slotset_layer = val
    end
end

function Sub_slotset_change(parent, ctrl, sub_slotset_name)
    local target_settings, is_in_share = Sub_slotset_get_settings(sub_slotset_name)
    if not target_settings then
        return
    end
    local setting_frame = ctrl:GetTopParentFrame()
    ui.DestroyFrame(setting_frame:GetName())
    local function CloneTable(orig)
        local orig_type = type(orig)
        local copy
        if orig_type == 'table' then
            copy = {}
            for orig_key, orig_value in next, orig, nil do
                copy[CloneTable(orig_key)] = CloneTable(orig_value)
            end
            setmetatable(copy, CloneTable(getmetatable(orig)))
        else
            copy = orig
        end
        return copy
    end
    if is_in_share and g.sub_slotset_personal == 1 then -- Share -> Personal
        if not g.sub_slotset_settings.personal[g.cid] then
            g.sub_slotset_settings.personal[g.cid] = {}
        end
        g.sub_slotset_settings.personal[g.cid][sub_slotset_name] = CloneTable(target_settings)
        g.sub_slotset_settings.share[sub_slotset_name] = nil
        target_settings = g.sub_slotset_settings.personal[g.cid][sub_slotset_name]
    elseif not is_in_share and g.sub_slotset_personal == 0 then -- Personal -> Share
        g.sub_slotset_settings.share[sub_slotset_name] = CloneTable(target_settings)
        if g.sub_slotset_settings.personal[g.cid] then
            g.sub_slotset_settings.personal[g.cid][sub_slotset_name] = nil
        end
        target_settings = g.sub_slotset_settings.share[sub_slotset_name]
    end
    Sub_slotset_save_settings()
    local index = tonumber((string.gsub(sub_slotset_name, "sub_slotset_", "")))
    Sub_slotset_make(parent, ctrl, sub_slotset_name, index, target_settings)
end

function Sub_slotset_make(parent, ctrl, sub_slotset_name, index, target_settings)
    local setting = ctrl:GetTopParentFrame()
    local is_share = (g.sub_slotset_personal == 0)
    if target_settings then
        local sub_slotset = ui.GetFrame("_nexus_addons" .. sub_slotset_name)
        AUTO_CAST(sub_slotset)
        sub_slotset:RemoveAllChild()
        target_settings.etc = {
            x = target_settings.etc.x,
            y = target_settings.etc.y,
            row = g.sub_slotset_row,
            col = g.sub_slotset_col,
            size = g.sub_slotset_size,
            layer = g.sub_slotset_layer,
            lock = target_settings.etc.lock
        }
        sub_slotset:SetLayerLevel(g.sub_slotset_layer)
        sub_slotset:SetEventScript(ui.LBUTTONUP, "Sub_slotset_end_drag")
        -- sub_slotset:SetEventScript(ui.RBUTTONUP, "Sub_slotset_rbtn")
        Sub_slotset_save_settings()
        local is_share = (g.sub_slotset_settings.share[sub_slotset_name] ~= nil)
        Sub_slotset_slotset_make(sub_slotset, target_settings.etc, is_share)
        return
    end
    local setting = ctrl:GetTopParentFrame()
    ui.DestroyFrame(setting:GetName())
    local list_frame_name = addon_name_lower .. "list_frame"
    ui.DestroyFrame(addon_name_lower .. "list_frame")
    local tbl
    local is_share_new = false
    if g.sub_slotset_personal == 1 then
        if not g.sub_slotset_settings.personal[g.cid] then
            g.sub_slotset_settings.personal[g.cid] = {}
        end
        tbl = g.sub_slotset_settings.personal[g.cid]
    else
        tbl = g.sub_slotset_settings.share
        is_share_new = true
    end
    local new_index = g.sub_slotset_settings.config.index
    local new_name = "sub_slotset_" .. new_index
    local sub_slotset = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "sub_slotset_" .. new_index, 0, 0, 0, 0)
    AUTO_CAST(sub_slotset)
    tbl["sub_slotset_" .. new_index] = {}
    tbl["sub_slotset_" .. new_index].etc = {
        x = setting:GetX() + 100,
        y = setting:GetY() + 400,
        row = g.sub_slotset_row,
        col = g.sub_slotset_col,
        size = g.sub_slotset_size,
        layer = g.sub_slotset_layer,
        lock = false
    }
    g.sub_slotset_settings.config.index = new_index + 1
    Sub_slotset_save_settings()
    sub_slotset:SetSkinName("chat_window_2")
    sub_slotset:SetAlpha(20)
    sub_slotset:SetLayerLevel(g.sub_slotset_layer)
    sub_slotset:EnableHittestFrame(1)
    sub_slotset:EnableMove(1)
    sub_slotset:SetPos(setting:GetX() + 100, setting:GetY() + 400)
    sub_slotset:ShowWindow(1)
    sub_slotset:SetEventScript(ui.LBUTTONUP, "Sub_slotset_end_drag")
    -- sub_slotset:SetEventScript(ui.RBUTTONUP, "Sub_slotset_rbtn")
    Sub_slotset_slotset_make(sub_slotset, tbl[new_name].etc, is_share_new)
end

function Sub_slotset_slotset_make(sub_slotset, etc_settings, is_share)
    local slotset = sub_slotset:CreateOrGetControl('slotset', 'slotset', 2, 9, 0, 0)
    AUTO_CAST(slotset)
    slotset:EnablePop(1)
    slotset:EnableDrag(1)
    slotset:EnableDrop(1)
    slotset:EnableHitTest(1)
    local col = (etc_settings and etc_settings.col) or g.sub_slotset_col or 3
    local row = (etc_settings and etc_settings.row) or g.sub_slotset_row or 3
    local size = (etc_settings and etc_settings.size) or g.sub_slotset_size or 48
    local is_locked = (etc_settings and etc_settings.lock) or false
    slotset:SetColRow(col, row)
    slotset:SetSlotSize(size, size)
    slotset:SetSpc(2, 2)
    slotset:SetSkinName('invenslot2')
    slotset:CreateSlots()
    if g.sub_slotset_personal == 0 then
        local titlelabel = sub_slotset:CreateOrGetControl('richtext', 'titlelabel', 0, 0, 0, 0)
        titlelabel:SetTextAlign('center', 'center')
        titlelabel:SetGravity(ui.LEFT, ui.TOP)
        titlelabel:SetText("{ol}{s10}shared")
    else
        sub_slotset:RemoveChild("titlelabel")
    end
    local gb = sub_slotset:CreateOrGetControl("groupbox", "gb", 0, 0, 20, 30)
    AUTO_CAST(gb)
    gb:SetGravity(ui.RIGHT, ui.TOP)
    local text = g.lang == "Japanese" and
                     "{ol}右クリック: 各種設定{nl} {nl}スロット LSHIFT+左クリック: アイコン削除" or
                     "{ol}Right Click: Various Settings{nl} {nl}Slot LSHIFT + Left Click: Remove Icon"
    gb:SetTextTooltip(text)
    gb:SetEventScript(ui.RBUTTONUP, "Sub_slotset_rbtn")
    local itemlock = gb:CreateOrGetControlSet('inv_itemlock', "itemlock", 0, 0)
    itemlock:SetGrayStyle(is_locked and 0 or 1)
    sub_slotset:Resize(size * col + 10 + col * 2, size * row + 10 + row * 2)
    return slotset
end

function Sub_slotset_rbtn(sub_slotset, ctrl)
    local sub_slotset_name = string.gsub(sub_slotset:GetName(), "_nexus_addons", "")
    local context = ui.CreateContextMenu("slotset_context",
        g.lang == "Japanese" and "{ol}各種設定" or "{ol}Various Settings", 0, 0, 100, 100)
    ui.AddContextMenuItem(context, " ", "None")
    local scp = string.format("Sub_slotset_remove_msg('%s')", sub_slotset_name)
    local msg = g.lang == "Japanese" and "{ol}スロットセット削除" or "{ol}Remove Slot Set"
    ui.AddContextMenuItem(context, msg, scp)
    scp = string.format("Sub_slotset_lock_toggle('%s')", sub_slotset_name)
    msg = g.lang == "Japanese" and "{ol}スロットセットロック切替" or "{ol}Toggle Slot Set Lock"
    ui.AddContextMenuItem(context, msg, scp)
    scp = string.format("Sub_slotset_resetting('%s')", sub_slotset_name)
    msg = g.lang == "Japanese" and "{ol}スロットセット設定変更" or "{ol}Change Slot Set Settings"
    ui.AddContextMenuItem(context, msg, scp)
    ui.AddContextMenuItem(context, "  ", "None")
    ui.OpenContextMenu(context)
end

function Sub_slotset_remove_msg(sub_slotset_name)
    local scp = string.format("Sub_slotset_remove('%s')", sub_slotset_name)
    local msg = g.lang == "Japanese" and "削除しますか？" or "Confirm Deletion?"
    ui.MsgBox(msg, scp, "None")
end

function Sub_slotset_remove(sub_slotset_name)
    local _, is_in_share = Sub_slotset_get_settings(sub_slotset_name)
    if is_in_share == true then
        g.sub_slotset_settings.share[sub_slotset_name] = nil
    elseif is_in_share == false then
        g.sub_slotset_settings.personal[g.cid][sub_slotset_name] = nil
    end
    Sub_slotset_save_settings()
    ui.DestroyFrame(addon_name_lower .. sub_slotset_name)
end

function Sub_slotset_lock_toggle(sub_slotset_name)
    local sub_srotset = ui.GetFrame(addon_name_lower .. sub_slotset_name)
    local target_settings = Sub_slotset_get_settings(sub_slotset_name)
    if not target_settings then
        return
    end
    target_settings.etc.lock = not target_settings.etc.lock
    local is_locked = target_settings.etc.lock
    local itemlock = GET_CHILD_RECURSIVELY(sub_srotset, "itemlock")
    AUTO_CAST(itemlock)
    itemlock:SetGrayStyle(is_locked and 0 or 1)
    sub_srotset:EnableMove(is_locked and 0 or 1)
    Sub_slotset_save_settings()
end

function Sub_slotset_resetting(sub_slotset_name)
    local target_settings, is_share = Sub_slotset_get_settings(sub_slotset_name)
    g.sub_slotset_col = target_settings.etc.col
    g.sub_slotset_row = target_settings.etc.row
    g.sub_slotset_size = target_settings.etc.size
    g.sub_slotset_layer = target_settings.etc.layer
    g.sub_slotset_personal = is_share and 0 or 1
    Sub_slotset_setting(sub_slotset_name)
end
-- sub_slotset ここまで

-- muteki ここから
g.muteki_trans_tbl = {
    etc = {
        buff_time = '{#000000}Hide until Buff duration (sec){/}',
        position_mode = '{#000000}Toggle Mode{/}',
        mode_desc = "{ol}ON: Follow Mode{nl}OFF: Fixed Mode",
        frame_lock = '{#000000}Frame Lock{/}',
        layer_lv = '{#000000}Layer Level{/}',
        layer_notice = 'MUTEKI Changed frame layer to %d',
        icon_mode = '{#000000}Display in icon mode{/}',
        color_tone = '{#FFFFFF}{ol}Current Color{/}',
        hide_sec = 'MUTEKI Hide gauge with remaining time more than %d seconds',
        not_notify = "{#000000}Hidden for this character{/}",
        pt_chat = "{#000000}Notify buffs via PT chat{/}",
        function_notice = "{#FFFFFF}{ol}Register by leftclick on the buff slot{nl}in the upper left corner of the screen{/}",
        icon_rotate = "{#000000}Rotate icon{/}",
        with_effect = "{#000000}With effect{/}",
        nico_chat = "{#000000}Nico Chat Display{/}",
        delete_notice = "{#FFFFFF}{ol}Right-click the icon to unregister{/}",
        color_notice = "{#FFFFFF}{ol}The first two characters are for shade/density (AA = Light - FF = Dark)" ..
            "{nl}The following six characters are the hexadecimal color code.{/}",
        count_display = "{#000000}Display Buff Stacks{/}",
        end_sound = "{#000000}Buff End Sound{/}",
        add_check = 'Add %s to MUTEKI?',
        add_buff = 'MUTEKI Added %s in settings',
        delete_buff = 'MUTEKI Removed %s in settings',
        add_new = '{#FFFFFF}{ol}Add Buff',
        add_buffid = "{#FFFFFF}{ol}Add by Buff ID{/}",
        lock_notice = "{#FFFFFF}{ol}Follow Mode is always locked",
        debuff_time = "{#000000}Manual DeBuff Duration",
        debuff_notice = "{#FFFFFF}{ol}Adjustment is required{nl}based on each character's skill level",
        debuff_manage_set = "{#FFFFFF}{ol}Set duration to %s seconds",
        auto_time = "{#FFFFFF}{ol}Turning ON automatically retrieves the debuff duration{nl}Note: This may not work correctly with some debuffs{nl}In that case, please turn it OFF and enter the value manually",
        buff_time_cid = "{#000000}Manual Buff Duration",
        buff_notice_cid = "{#FFFFFF}{ol}Manually input the duration for some buffs, such as magic circles{nl}whose time cannot be automatically retrieved{nl}Note: Values may vary depending on skill level and other factors",
        skill_text = "{#000000}Skill ID",
        skill_notice = "{#FFFFFF}{ol}If the duration is entered{nl}linking a buff to a skill enables time measurement",
        skill_set = "{#FFFFFF}{ol}Linked to %s skill",
        add_new_skill = '{#FFFFFF}{ol}Add Skill'
    },
    Japanese = {
        buff_time = '{#000000}指定されたバフの残り時間まで非表示(秒){/}',
        position_mode = '{#000000}モード切替{/}',
        mode_desc = "{ol}ON: 追従モード{nl}OFF: 固定モード",
        frame_lock = '{#000000}フレームロック{/}',
        layer_lv = '{#000000}レイヤーレベル{/}',
        layer_notice = 'MUTEKI フレームレイヤーを %d に変更しました',
        icon_mode = '{#000000}アイコンモードで表示{/}',
        color_tone = '{#FFFFFF}{ol}現在の色{/}',
        hide_sec = 'MUTEKI %d 秒以上のバフは非表示になります',
        not_notify = "{#000000}このキャラクターでは非表示{/}",
        pt_chat = "{#000000}バフをPTチャットでお知らせ{/}",
        function_notice = "{#FFFFFF}{ol}画面左上バフスロットを{nl}左クリックでも登録出来ます{/}",
        icon_rotate = "{#000000}アイコン回転{/}",
        with_effect = "{#000000}エフェクト付与{/}",
        nico_chat = "{#000000}ニコチャット表示{/}",
        delete_notice = "{#FFFFFF}{ol}アイコン右クリックで登録解除します{/}",
        color_notice = "{#FFFFFF}{ol}先頭2文字は濃淡 (AA=薄い～FF=濃い)" ..
            "{nl}続く6文字は16進数のカラーコード{/}",
        count_display = "{#000000}バフ重複を表示{/}",
        end_sound = "{#000000}バフ終了時に音でお知らせ{/}",
        add_check = 'MUTEKIに%sを追加しますか？',
        add_buff = 'MUTEKIに%sを追加しました.',
        delete_buff = "MUTEKIから %s を削除しました.",
        add_new = '{#FFFFFF}{ol}バフ追加',
        add_buffid = "{#FFFFFF}{ol}バフIDで直接追加{/}",
        lock_notice = "{#FFFFFF}{ol}追従モードでは常にロックされます",
        debuff_time = "{#000000}デバフ継続時間を入力",
        debuff_notice = "{#FFFFFF}{ol}キャラクター毎のスキルレベルなどで調整必要です",
        debuff_manage_set = "{#FFFFFF}{ol}継続時間を %s 秒で設定しました",
        auto_time = "{#FFFFFF}{ol}ONにするとデバフ継続時間を自動取得します{nl}一部のデバフでは機能しない場合があります{nl}その際はOFFにして手動で入力してください",
        buff_time_cid = "{#000000}バフ継続時間を手動入力",
        buff_notice_cid = "{#FFFFFF}{ol}魔法陣など一部の時間取得出来ないバフの継続時間を手動入力します{nl}値はスキルレベルなどで異なる場合があります",
        skill_text = "{#000000}スキルID",
        skill_notice = "{#FFFFFF}{ol}継続時間を入力した場合{nl}バフとスキルを紐づけることで時間計測が可能になります",
        skill_set = "{#FFFFFF}{ol}%s スキルと紐づけました",
        add_new_skill = '{#FFFFFF}{ol}スキル追加'
    },
    kr = {
        buff_time = "{#000000}지정된 버프 잔여 시간까지 숨기기 (초){/}",
        position_mode = "{#000000}모드 전환{/}",
        mode_desc = "{ol}ON: 추종 모드{nl}OFF: 고정 모드",
        frame_lock = "{#000000}프레임 잠금{/}",
        layer_lv = "{#000000}레이어 레벨{/}",
        layer_notice = 'MUTEKI 프레임 레이어를 %d 로 변경했습니다',
        icon_mode = "{#000000}아이콘 모드로 표시{/}",
        color_tone = "{#FFFFFF}{ol}현재 색상{/}",
        hide_sec = "MUTEKI - %d초 이상 남은 버프는 표시하지 않습니다.",
        not_notify = "{#000000}이 캐릭터에서는 숨김{/}",
        pt_chat = "{#000000}PT 채팅으로 버프를 알려드립니다{/}",
        function_notice = "{#FFFFFF}{ol}화면 왼쪽 상단의 버프 슬롯을{nl}왼쪽 클릭으로도 등록할 수 있습니다{/}",
        icon_rotate = "{#000000}아이콘 회전{/}",
        with_effect = "{#000000}효과 적용{/}",
        nico_chat = "{#000000}니코 채팅 표시{/}",
        delete_notice = "{#FFFFFF}{ol}아이콘을 마우스 오른쪽 버튼으로 클릭하여 등록 해제{/}",
        color_notice = "{#FFFFFF}{ol}앞의 두 문자는 농도를 나타냅니다 (AA = 옅음 - FF = 진함)" ..
            "{nl}이어지는 6개의 문자는 16진수 컬러 코드입니다{/}",
        count_display = "{#000000}버프 중첩 표시{/}",
        end_sound = "{#000000}버프 종료 시 소리로 알림{/}",
        add_check = 'MUTEKI - 에 %s를 추가하시겠습니까?',
        add_buff = "MUTEKI - %s 버프를 추가했습니다",
        delete_buff = "MUTEKI - %s 버프를 삭제했습니다",
        add_new = '{#FFFFFF}{ol}버프 추가',
        add_buffid = "{#FFFFFF}{ol}버프ID로 직접 추가{/}",
        lock_notice = "{#FFFFFF}{ol}추종 모드에서는 항상 잠금됩니다",
        debuff_time = "{#000000}디버프 지속 시간 입력",
        debuff_notice = "{#FFFFFF}{ol}캐릭터별 스킬 레벨에 따라 조정이 필요합니다",
        debuff_manage_set = "{#FFFFFF}{ol}지속 시간을 %s 초로 설정했습니다",
        auto_time = "{#FFFFFF}{ol}ON으로 설정 시 디버프 지속 시간을 자동으로 가져옵니다{nl}주의: 일부 디버프에서는 제대로 작동하지 않을 수 있습니다{nl}그럴 경우, 해당 기능을 OFF로 끄고 수동으로 입력해 주십시오",
        buff_time_cid = "{#000000}버프 지속 시간 수동 입력",
        buff_notice_cid = "{#FFFFFF}{ol}마법진 등 일부 시간 획득이 불가능한 버프의 지속 시간을 수동으로 입력합니다{nl}참고: 값은 스킬 레벨 등에 따라 달라질 수 있습니다",
        skill_text = "{#000000}스킬 ID",
        skill_notice = "{#FFFFFF}{ol}지속 시간을 입력한 경우{nl}버프와 스킬을 연동하면 시간 측정이 가능해집니다",
        skill_set = "{#FFFFFF}{ol}%s 스킬과 연동했습니다",
        add_new_skill = '{#FFFFFF}{ol}스킬 추가'
    }
}
local function muteki_trans(text)
    local trans_text = g.muteki_trans_tbl["etc"][text]
    if g.lang == "Japanese" or g.lang == "kr" then
        trans_text = g.muteki_trans_tbl[g.lang][text]
    end
    return trans_text
end

function Muteki_save_settings()
    g.save_json(g.muteki_path, g.muteki_settings)
end

function Muteki_load_settings()
    g.muteki_path = string.format("../addons/%s/%s/muteki.json", addon_name_lower, g.active_id)
    g.muteki_old_path = string.format("../addons/%s/settings_2510.json", "muteki2ex")
    local settings = g.load_json(g.muteki_path)
    if not settings then
        local old_settings = g.load_json(g.muteki_old_path)
        if old_settings then
            local valid_cids = {}
            local sys_opt_path = string.format("../release/addon_setting/system_option/%s/settings.json", g.active_id)
            local sys_opt_file = io.open(sys_opt_path, "r")
            if sys_opt_file then
                local content = sys_opt_file:read("*a")
                sys_opt_file:close()
                if content and content ~= "" then
                    local status, data = pcall(json.decode, content)
                    if status and data and data.pc_id then
                        for k, _ in pairs(data.pc_id) do
                            valid_cids[tostring(k)] = true
                        end
                    end
                end
            end
            settings = {
                etc = {},
                buff_list = {}
            }
            settings.etc.rotate = old_settings.rotate or 0
            settings.etc.hide_time = old_settings.hide_time or 300
            settings.etc.mode = old_settings.mode or "fixed"
            settings.etc.layer_lv = old_settings.layer_lv or 80
            if old_settings.pos then
                settings.etc.x = old_settings.pos.x
                settings.etc.y = old_settings.pos.y
                settings.etc.lock = old_settings.pos.lock and 0 or 1
            else
                settings.etc.x = 480
                settings.etc.y = 640
                settings.etc.lock = 1
            end
            if old_settings.buff_list then
                local function filter_manage_table(source)
                    local target = {}
                    if source then
                        for cid, list in pairs(source) do
                            if valid_cids[tostring(cid)] and type(list) == "table" and next(list) then
                                local new_list = {}
                                for k, v in pairs(list) do
                                    if type(v) == "boolean" then
                                        new_list[k] = v and 1 or 0
                                    else
                                        new_list[k] = v
                                    end
                                end
                                target[cid] = new_list
                            end
                        end
                    end
                    return target
                end
                for buff_id, data in pairs(old_settings.buff_list) do
                    local new_data = {}
                    new_data.color = data.color
                    new_data.nico_chat = data.nico_chat
                    new_data.effect_check = data.effect_check
                    new_data.end_sound = data.end_sound
                    new_data.pt_chat = data.pt_chat and 1 or 0
                    new_data.circle_icon = data.circle_icon and 1 or 0
                    new_data.count_display = data.count_display and 1 or 0
                    local new_not_notify = {}
                    if data.not_notify then
                        for cid, val in pairs(data.not_notify) do
                            if valid_cids[tostring(cid)] then
                                new_not_notify[cid] = (val == true or val == 1) and 1 or 0
                            end
                        end
                    end
                    new_data.not_notify = new_not_notify
                    new_data.debuffs = filter_manage_table(data.debuff_manage)
                    new_data.buffs = filter_manage_table(data.buff_manage)
                    settings.buff_list[buff_id] = new_data
                end
            end
        else
            settings = {
                etc = {
                    mode = "fixed",
                    layer_lv = 80,
                    hide_time = 300,
                    rotate = 0,
                    lock = 1,
                    y = 640,
                    x = 480
                },
                buff_list = {}
            }
        end
    end
    g.muteki_settings = settings
    Muteki_save_settings()
end

function muteki_on_init()
    if not g.muteki_settings then
        Muteki_load_settings()
    end
    local old_func = g.settings.muteki.old_init_func
    if _G[old_func] then
        return
    end
    g.addon:RegisterMsg("BUFF_ADD", "Muteki_BUFF_ON_MSG")
    g.addon:RegisterMsg("BUFF_UPDATE", "Muteki_BUFF_ON_MSG")
    g.addon:RegisterMsg("BUFF_REMOVE", "Muteki_BUFF_ON_MSG")
    g.setup_hook_and_event(g.addon, "ICON_USE", "Muteki_ICON_USE", true)
    if g.settings.muteki.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "muteki")
        return
    end
    g.muteki_default_color = "FFCCCC22"
    g.muteki_buffs = {
        circle = {},
        gauge = {}
    }
    g.muteki_time_buffs = {}
    g.muteki_buff_count = {}
    g.muteki_highlander = false
    if g.map_name == "c_highlander" then
        g.muteki_highlander = true
    end
    Muteki_buff_frame_init()
    Muteki_skill_list()
    if g.muteki_overload and g.muteki_overload.cid == g.cid then
        if g.muteki_overload.is_cool == 1 then
            local now = imcTime.GetAppTime()
            local elapsed = now - g.muteki_overload.start_time
            local remain = 50 - elapsed
            if remain > 0 then
                local buff_id = g.muteki_overload.buff_id
                local buff_id_str = tostring(buff_id)
                local buff_data = g.muteki_settings.buff_list[buff_id_str]
                if buff_data then
                    g.muteki_buffs[buff_id_str] = {
                        show = true,
                        effect = false,
                        start_time = now,
                        set_time = remain,
                        notify = 1
                    }
                    g.muteki_buff_count[buff_id_str] = 1
                    local list_type = (buff_data.circle_icon == 1) and "circle" or "gauge"
                    Muteki_insert_if_not_exists(g.muteki_buffs[list_type], buff_id)
                    local muteki = ui.GetFrame(addon_name_lower .. "muteki")
                    local buff_cls = GetClassByType('Buff', buff_id)
                    Muteki_buff_frame(muteki, "BUFF_ADD", buff_id, buff_cls, buff_data, (buff_data.circle_icon == 1))
                    Muteki_child_set_pos(muteki)
                end
            else
                g.muteki_overload = nil
            end
        end
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("Muteki_buffslot_script", 2.0)
end

function Muteki_BUFF_ON_MSG(frame, msg, is_dummy, buff_id)
    if g.settings.muteki.use == 0 then
        return
    end
    local buff_id_str = tostring(buff_id)
    local buff_data = g.muteki_settings.buff_list[buff_id_str]
    local muteki = ui.GetFrame(addon_name_lower .. "muteki")
    muteki:SetAlpha(10)
    local notify_val = 0
    if buff_data and buff_data.not_notify then
        notify_val = buff_data.not_notify[g.cid] or 0
    end
    if (buff_data and notify_val == 0) or is_dummy == "dummy" then
        local now = imcTime.GetAppTime()
        if g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].start_time then
            if now - g.muteki_buffs[buff_id_str].start_time < 0.5 then
                return
            end
        end
        local is_circle = false
        if buff_data.circle_icon == 1 then
            is_circle = true
        end
        local buff_cls = GetClassByType('Buff', buff_id)
        local buff_name = buff_cls.Name
        local overload_tbl = {4483, 4757}
        if buff_id == overload_tbl[1] or buff_id == overload_tbl[2] then
            local my_handle = session.GetMyHandle()
            local info_buff = info.GetBuff(my_handle, buff_id)
            if info_buff then
                g.muteki_overload = {
                    start_time = now, -- imcTime
                    buff_id = buff_id,
                    is_cool = 0,
                    cid = g.cid
                }
                g.muteki_buffs[buff_id_str] = nil
            else
                if g.muteki_overload and g.muteki_overload.is_cool == 0 and msg == "BUFF_REMOVE" then
                    g.muteki_time_buffs[buff_id_str] = {
                        show = false,
                        effect = false,
                        start_time = now,
                        set_time = 20,
                        notify = 1
                    }
                    g.muteki_overload.is_cool = 1
                    Muteki_BUFF_ON_MSG(frame, 'BUFF_ADD', is_dummy, buff_id)
                    return
                else
                    if not (g.muteki_overload and g.muteki_overload.is_cool == 1) then
                        g.muteki_overload = nil
                    end
                end
            end
        end
        if msg == 'BUFF_ADD' then
            g.muteki_remove_notice = g.muteki_remove_notice or {}
            g.muteki_remove_notice[buff_id_str] = 0
            g.muteki_buff_count = g.muteki_buff_count or {}
            g.muteki_buff_count[buff_id_str] = (g.muteki_buff_count[buff_id_str] or 0) + 1
            if g.muteki_time_buffs and g.muteki_time_buffs[buff_id_str] then
                g.muteki_buffs[buff_id_str] = g.muteki_time_buffs[buff_id_str]
                g.muteki_time_buffs[buff_id_str] = nil
            elseif not g.muteki_buffs[buff_id_str] then
                g.muteki_buffs[buff_id_str] = {
                    show = false,
                    effect = false,
                    start_time = now,
                    set_time = nil,
                    notify = 0
                }
            end
            g.muteki_buffs.circle = g.muteki_buffs.circle or {}
            g.muteki_buffs.gauge = g.muteki_buffs.gauge or {}
            if is_circle then
                Muteki_insert_if_not_exists(g.muteki_buffs.circle, buff_id)
            else
                Muteki_insert_if_not_exists(g.muteki_buffs.gauge, buff_id)
            end
            if g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].notify == 0 then
                if buff_data.pt_chat == 1 then
                    if not string.find(buff_cls.Name, "NoData") then
                        ui.Chat(string.format("/p %s start", buff_cls.Name))
                    end
                end
                if buff_data.nico_chat == 1 then
                    NICO_CHAT(string.format("{@st55_a}%s start", buff_name))
                end
                if buff_data.effect_check == 1 then
                    local my_handle = session.GetMyHandle()
                    local actor = world.GetActor(my_handle)
                    effect.PlayActorEffect(actor, "F_sys_TPBOX_great_300", "None", 1.0, 6.0)
                end
                g.muteki_buffs[buff_id_str].notify = 1
            end
            if g.muteki_buff_count[buff_id_str] > 0 then
                Muteki_child_set_pos(muteki)
            end
            Muteki_buff_frame(muteki, msg, buff_id, buff_cls, buff_data, is_circle)
        elseif msg == 'BUFF_REMOVE' then
            if g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].set_time then
                local now = imcTime.GetAppTime()
                if g.muteki_buffs[buff_id_str].set_time - (now - g.muteki_buffs[buff_id_str].start_time) > 0 then
                    return
                end
            end
            if is_dummy ~= "dummy" then
                Muteki_handle_buff_end(muteki, buff_id)
            end
            Muteki_child_set_pos(muteki)
        elseif msg == 'BUFF_UPDATE' then
            if not g.muteki_buffs[buff_id_str] then
                g.muteki_buffs[buff_id_str] = {
                    show = false,
                    effect = false,
                    start_time = imcTime.GetAppTime(),
                    set_time = nil,
                    notify = 0
                }
            end
            Muteki_buff_frame(muteki, msg, buff_id, buff_cls, buff_data, is_circle)
        end
    end
end

function Muteki_handle_buff_end(notice_frame, buff_id)
    local buff_id_str = tostring(buff_id)
    local buff_data = g.muteki_settings.buff_list[buff_id_str]
    local buff_cls = GetClassByType('Buff', buff_id)
    local notice = false
    if g.muteki_remove_notice and g.muteki_remove_notice[buff_id_str] == 0 then
        notice = true
        g.muteki_remove_notice[buff_id_str] = 1
    end
    if notice then
        if buff_data.pt_chat == 1 then
            if not string.find(buff_cls.Name, "NoData") then
                ui.Chat(string.format("/p %s end", buff_cls.Name))
            end
        end
        if buff_data.nico_chat == 1 then
            NICO_CHAT(string.format("{@st55_a}%s end", buff_cls.Name))
        end
        if buff_data.end_sound == 1 then
            imcSound.PlaySoundEvent("sys_transcend_cast")
        end
    end
    if g.muteki_buffs[buff_id_str] then
        g.muteki_buffs[buff_id_str] = nil
    end
    if g.muteki_buff_count[buff_id_str] then
        g.muteki_buff_count[buff_id_str] = nil
    end
    local ui_types = {"circle", "gauge"}
    for _, ui_type in ipairs(ui_types) do
        local child_name = ui_type .. "_" .. buff_id
        local child = GET_CHILD(notice_frame, child_name)
        if child then
            local target_list = g.muteki_buffs[ui_type]
            if target_list then
                for i = #target_list, 1, -1 do
                    if target_list[i] == buff_id then
                        table.remove(target_list, i)
                        break
                    end
                end
            end
            DESTROY_CHILD_BYNAME(notice_frame, child_name)
        end
    end
end

function Muteki_ICON_USE(my_frame, my_msg)
    if g.settings.muteki.use == 0 then
        return
    end
    local icon, reAction = g.get_event_args(my_msg)
    if icon then
        AUTO_CAST(icon)
        local cur_time = ICON_UPDATE_SKILL_COOLDOWN(icon)
        if cur_time > 0 then
            return
        end
        local icon_info = icon:GetInfo()
        if icon_info:GetCategory() == 'Skill' then
            local skill_id = icon_info.type
            local skill_id_str = tostring(skill_id)
            if g.muteki_buffs[g.muteki_skills[skill_id_str].buff_id] then
                return
            end
            local skill_list = g.muteki_skills[skill_id_str]
            if skill_list then
                g.muteki_time_buffs[skill_list.buff_id] = {
                    show = false,
                    effect = false,
                    start_time = imcTime.GetAppTime(),
                    set_time = skill_list.time,
                    notify = 0
                }
                Muteki_BUFF_ON_MSG("", 'BUFF_ADD', "", tonumber(skill_list.buff_id))
            end
        end
    end
end

function Muteki_SET_BUFF_SLOT(my_frame, my_msg)
    local slot, capt, class, buff_type = g.get_event_args(my_msg)
    AUTO_CAST(slot)
    slot:SetEventScript(ui.LBUTTONDOWN, 'Muteki_add_buff_msg')
    slot:SetEventScriptArgString(ui.LBUTTONDOWN, class.Name)
    slot:SetEventScriptArgNumber(ui.LBUTTONDOWN, buff_type)
end

function Muteki_buffslot_script(_nexus_addons)
    if s_buff_ui and s_buff_ui.slotlist then
        for i = 0, s_buff_ui["buff_group_cnt"] do
            local slotlist = s_buff_ui["slotlist"][i]
            local slotcount = s_buff_ui["slotcount"][i]
            local captionlist = s_buff_ui["captionlist"][i]
            if slotcount ~= nil and slotcount >= 0 then
                for i = 0, slotcount - 1 do
                    local slot = slotlist[i]
                    AUTO_CAST(slot)
                    local icon = slot:GetIcon()
                    local icon_info = icon:GetInfo()
                    local buff_id = icon_info.type
                    if buff_id ~= 0 then
                        local buff_cls = GetClassByType("Buff", buff_id)
                        slot:SetEventScript(ui.LBUTTONDOWN, 'Muteki_add_buff_msg')
                        slot:SetEventScriptArgString(ui.LBUTTONDOWN, buff_cls.Name)
                        slot:SetEventScriptArgNumber(ui.LBUTTONDOWN, buff_id)
                    end
                end
            end
        end
        g.setup_hook_and_event(g.addon, 'SET_BUFF_SLOT', "Muteki_SET_BUFF_SLOT", true)
    end
    return 0
end

function Muteki_buff_frame_init()
    local muteki = ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "muteki", 0, 0, 0, 0)
    AUTO_CAST(muteki)
    muteki:SetSkinName("None")
    if g.muteki_settings.etc.mode == "fixed" then
        muteki:SetOffset(g.muteki_settings.etc.x, g.muteki_settings.etc.y)
        muteki:StopUpdateScript("_FRAME_AUTOPOS")
    else
        local handle = session.GetMyHandle()
        FRAME_AUTO_POS_TO_OBJ(muteki, handle, muteki:GetWidth() - 145, 50, 3, 1)
        g.muteki_settings.etc.lock = 0
        Muteki_save_settings()
        local settings = ui.GetFrame(addon_name_lower .. "muteki_settings")
        if settings then
            AUTO_CAST(settings)
            local move_toggle = GET_CHILD_RECURSIVELY(settings, "move_toggle")
            AUTO_CAST(move_toggle)
            local icon_name = "test_com_ability_on"
            move_toggle:SetImage(icon_name)
        end
    end
    muteki:SetLayerLevel(g.muteki_settings.etc.layer_lv)
    muteki:EnableHittestFrame(g.muteki_settings.etc.lock)
    muteki:EnableMove(g.muteki_settings.etc.lock)
    if g.muteki_settings.etc.lock == 1 then
        local title = muteki:CreateOrGetControl("richtext", "title", 0, 0, 40, 10)
        AUTO_CAST(title)
        title:SetGravity(ui.LEFT, ui.TOP)
        title:SetText("{ol}{s10}Muteki")
        muteki:SetSkinName("chat_window")
        muteki:Resize(100, 20)
        muteki:SetAlpha(10)
    else
        muteki:RemoveChild("title")
        muteki:Resize(250, 210)
    end
    muteki:ShowWindow(1)
    muteki:SetEventScript(ui.LBUTTONUP, "Muteki_notic_frame_end_drag")
end

function Muteki_notic_frame_end_drag(muteki)
    g.muteki_settings.etc.x = muteki:GetX()
    g.muteki_settings.etc.y = muteki:GetY()
    Muteki_save_settings()
end

function Muteki_buff_frame(notice_frame, msg, buff_id, buff_cls, buff_data, is_circle)
    local buff_id_str = tostring(buff_id)
    local my_handle = session.GetMyHandle()
    local info_buff = info.GetBuff(my_handle, buff_id) or
                          (g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].set_time)
    if not info_buff then
        return
    end
    local image_name = GET_BUFF_ICON_NAME(buff_cls)
    if image_name == "icon_None" then
        image_name = "icon_item_nothing"
    end
    if msg == "BUFF_ADD" then
        local is_cool = false
        if g.muteki_overload and g.muteki_overload.is_cool == 1 and g.muteki_overload.buff_id == buff_id then
            is_cool = true
        end
        local child
        local start_time_sec = 0
        if is_circle then
            child = notice_frame:CreateOrGetControl("picture", "circle_" .. buff_id, 50, 5, 50, 50)
            AUTO_CAST(child)
            child:SetImage(image_name)
            if g.muteki_settings.etc.rotate == 1 then
                child:SetAngleLoop(3)
            end
            if is_cool then
                child:SetColorTone("FF696969")
            end
            child:SetEnableStretch(1)
            child:EnableHitTest(0)
        else -- gauge
            child = notice_frame:CreateOrGetControl("picture", "gauge_" .. buff_id, 0, 60, 250, 20)
            AUTO_CAST(child)
            child:SetEnableStretch(1)
            child:EnableHitTest(0)
            local gauge_back = child:CreateOrGetControl("picture", "gauge_back", 0, 10, 250, 10)
            AUTO_CAST(gauge_back)
            gauge_back:SetImage("fullblack")
            gauge_back:SetEnableStretch(1)
            gauge_back:EnableHitTest(0)
            local gauge_front = child:CreateOrGetControl("picture", "gauge_front", 0, 10, 250, 10)
            AUTO_CAST(gauge_front)
            gauge_front:SetImage("fullwhite")
            gauge_front:SetEnableStretch(1)
            gauge_front:EnableHitTest(0)
            if is_cool then
                gauge_front:SetColorTone("FFFFFFFF")
            else
                gauge_front:SetColorTone(buff_data.color)
            end
            local buff_name_ctrl = child:CreateOrGetControl("richtext", "buff_name", 0, 0, 10, 20)
            buff_name_ctrl:SetText(string.format("{ol}{s12}{img %s 15 15}%s", image_name, buff_cls.Name))
            buff_name_ctrl:AdjustFontSizeByWidth(170)
        end
        child:SetUserValue("BUFF_ID", buff_id)
        child:SetEnableStretch(1)
        child:EnableHitTest(0)
        if type(info_buff) == "number" then
            start_time_sec = info_buff
        elseif g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].set_time then
            local now = imcTime.GetAppTime()
            start_time_sec = g.muteki_buffs[buff_id_str].set_time - (g.muteki_buffs[buff_id_str].start_time - now)
        else
            start_time_sec = info_buff.time / 1000
        end
        child:SetUserValue("START_TIME", start_time_sec)
        local buff_time_ctrl = child:CreateOrGetControl("richtext", "buff_time", 0, 0, 50, 30)
        AUTO_CAST(buff_time_ctrl)
        if buff_data.count_display == 1 and type(info_buff) ~= "number" then
            local buff_over_ctrl = child:CreateOrGetControl("richtext", "buff_over", 0, 0, 0, 0)
            AUTO_CAST(buff_over_ctrl)
            if is_circle then
                buff_over_ctrl:Resize(20, 20)
                buff_over_ctrl:SetGravity(ui.RIGHT, ui.BOTTOM)
                if start_time_sec > 0 then
                    buff_over_ctrl:SetText(string.format("{ol}{s22}%d", info_buff.over))
                    buff_time_ctrl:SetGravity(ui.LEFT, ui.TOP)
                else
                    buff_over_ctrl:SetText(string.format("{ol}{s35}%d", info_buff.over))
                    local rect = buff_over_ctrl:GetMargin();
                    buff_over_ctrl:SetMargin(rect.left, rect.top, rect.right + 12, rect.bottom + 5)
                end
            else -- gauge
                buff_over_ctrl:Resize(30, 20)
                buff_over_ctrl:SetOffset(220, 0)
                buff_over_ctrl:SetGravity(ui.RIGHT, ui.CENTER_VERT)
                buff_over_ctrl:SetText(string.format("{ol}{s20}%d", info_buff.over))
            end
            buff_over_ctrl:SetColorTone("FFFFFF00")
        elseif not is_circle then
            buff_time_ctrl:SetOffset(180, 0)
            buff_time_ctrl:Resize(30, 20)
            buff_time_ctrl:SetGravity(ui.RIGHT, ui.TOP)
            local r = buff_time_ctrl:GetMargin()
            buff_time_ctrl:SetMargin(r.left, r.top, r.right + 40, r.bottom)
        elseif is_circle then
            buff_time_ctrl:SetGravity(ui.RIGHT, ui.TOP)
            local r = buff_time_ctrl:GetMargin()
            buff_time_ctrl:SetMargin(r.left, r.top + 10, r.right, r.bottom)
        end
        Muteki_notice_update(child)
        if not child:HaveUpdateScript("Muteki_notice_update") then
            child:RunUpdateScript("Muteki_notice_update", 0.1)
        end
    elseif msg == "BUFF_UPDATE" then
        local ui_type = is_circle and "circle" or "gauge"
        local child = GET_CHILD(notice_frame, ui_type .. "_" .. buff_id)
        if child then
            local buff_over_ctrl = GET_CHILD(child, "buff_over")
            if buff_over_ctrl and type(info_buff) ~= "number" then
                local stat
                if is_circle then
                    stat = (info_buff.time <= 0) and string.format("{ol}{s35}%d", info_buff.over) or
                               string.format("{ol}{s22}%d", info_buff.over)
                else -- gauge
                    stat = string.format("{ol}{s20}%d", info_buff.over)
                end
                buff_over_ctrl:SetText(stat)
                buff_over_ctrl:SetColorTone("FFFFFF00")
                if buff_cls.OverBuff <= info_buff.over then
                    if not g.muteki_buffs[buff_id_str].effect then
                        local my_handle = session.GetMyHandle()
                        local actor = world.GetActor(my_handle)
                        effect.PlayActorEffect(actor, 'F_pattern025_loop', 'None', 1.0, 1.5)
                        imcSound.PlaySoundEvent("sys_cube_open_jackpot")
                        g.muteki_buffs[buff_id_str].effect = true
                    end
                    buff_over_ctrl:SetColorTone("FFFF0000")
                end
            end
            child:StopUpdateScript("Muteki_notice_update")
            Muteki_notice_update(child)
            if not child:HaveUpdateScript("Muteki_notice_update") then
                child:RunUpdateScript("Muteki_notice_update", 0.1)
            end
        end
    end
end

function Muteki_notice_update(child)
    local child_name = child:GetName()
    local muteki = child:GetParent()
    local buff_id = child:GetUserIValue("BUFF_ID")
    local buff_id_str = tostring(buff_id)
    local my_handle = session.GetMyHandle()
    local cur_time = Muteki_get_remaining_time(buff_id)
    local ui_type = string.find(child:GetName(), "circle_") and "circle" or "gauge"
    if cur_time <= 0 then
        Muteki_BUFF_ON_MSG(nil, "BUFF_REMOVE", "", buff_id)
        return 0
    end
    if (cur_time <= g.muteki_settings.etc.hide_time) or (cur_time == math.huge) then
        child:ShowWindow(1)
        g.muteki_buffs[buff_id_str].show = true
    else
        child:ShowWindow(0)
        g.muteki_buffs[buff_id_str].show = false
    end
    Muteki_child_set_pos(muteki)
    if g.muteki_buffs[buff_id_str].show == false then
        return 1
    end
    if ui_type == "circle" then
        if cur_time == math.huge then
            local buff_over_ctrl = GET_CHILD(child, "buff_over")
            buff_over_ctrl:ShowWindow(1)
        elseif cur_time > 0 then
            local stat = string.format("{ol}{s22}%.1f", cur_time)
            if cur_time >= 60 then
                local min = math.floor(cur_time / 60)
                stat = string.format("{ol}{s22}%d{s10}%s", min, "min")
            elseif cur_time <= 10 and cur_time > 5 then
                stat = string.format("{ol}{s22}{#FF4500}%.1f", cur_time)
            elseif cur_time <= 5 then
                stat = string.format("{ol}{s22}{#FF0000}%.1f", cur_time)
            end
            local buff_time_ctrl = GET_CHILD(child, "buff_time")
            if buff_time_ctrl then
                buff_time_ctrl:SetText(stat)
            end
        end
    elseif ui_type == "gauge" then
        local buff_time_ctrl = GET_CHILD(child, "buff_time")
        if cur_time > 0 and cur_time ~= math.huge then
            buff_time_ctrl:ShowWindow(1)
            buff_time_ctrl:SetText(string.format("{ol}{s18}%.1f", cur_time))
            buff_time_ctrl:SetColorTone(g.muteki_settings.buff_list[buff_id_str].color)
        else
            buff_time_ctrl:ShowWindow(0)
        end
        local start_time = tonumber(child:GetUserValue("START_TIME"))
        local ratio = 0
        if cur_time == math.huge then
            ratio = 1.0
        elseif start_time > 0 then
            ratio = cur_time / start_time
        end
        local gauge_front = GET_CHILD(child, "gauge_front")
        AUTO_CAST(gauge_front)
        if gauge_front then
            gauge_front:Resize(250 * ratio, 10)
        end
        local gauge_front = GET_CHILD(child, "gauge_front")
        AUTO_CAST(gauge_front)
    end
    return 1
end

function Muteki_child_set_pos(muteki)
    local circle_count = Muteki_reorder_ui_elements(muteki, "circle")
    local gauge_count = Muteki_reorder_ui_elements(muteki, "gauge")
    local x = circle_count * 50 + 50
    if x < 250 then
        x = 250
    end
    local y = gauge_count * 25 + 60
    if y < 60 then
        y = 60
    end
    muteki:Resize(x, y)
end

function Muteki_reorder_ui_elements(muteki, ui_type)
    local sorted_list = {}
    local source_list = g.muteki_buffs[ui_type]
    if source_list and type(source_list) == "table" then
        for _, buff_id in ipairs(source_list) do
            local cur_time = Muteki_get_remaining_time(buff_id)
            if cur_time > 0 then
                table.insert(sorted_list, {
                    buff_id = buff_id,
                    time = cur_time
                })
            end
        end
    end
    table.sort(sorted_list, function(a, b)
        return a.time < b.time
    end)
    local visible_count = 0
    for _, entry in ipairs(sorted_list) do
        local child = GET_CHILD(muteki, ui_type .. "_" .. entry.buff_id)
        if child and child:IsVisible() == 1 then
            if ui_type == "circle" then
                child:SetOffset((visible_count + 1) * 50, 5)
            else -- gauge
                child:SetOffset(0, visible_count * 25 + 60)
            end
            visible_count = visible_count + 1
            if not child:HaveUpdateScript("Muteki_notice_update") then
                child:RunUpdateScript("Muteki_notice_update", 0.1)
            end
        end
    end
    return visible_count
end

function Muteki_get_remaining_time(buff_id)
    local buff_id_str = tostring(buff_id)
    local my_handle = session.GetMyHandle()
    if g.muteki_buffs[buff_id_str] and g.muteki_buffs[buff_id_str].set_time then
        local elapsed_time = imcTime.GetAppTime() - g.muteki_buffs[buff_id_str].start_time
        return g.muteki_buffs[buff_id_str].set_time - elapsed_time
    end
    local info_buff = info.GetBuff(my_handle, buff_id)
    if info_buff then
        if info_buff.time > 0 then
            return info_buff.time / 1000
        elseif info_buff.time == 0 and info_buff.over > 0 then
            return math.huge
        end
    end
    return 0
end

function Muteki_insert_if_not_exists(list, value)
    for _, existing_value in ipairs(list) do
        if existing_value == value then
            return
        end
    end
    table.insert(list, value)
end

function Muteki_refresh_active_buffs()
    local my_handle = session.GetMyHandle()
    if g.muteki_settings.buff_list then
        for b_id_str, buff_data in pairs(g.muteki_settings.buff_list) do
            local b_id = tonumber(b_id_str)
            local info_buff = info.GetBuff(my_handle, b_id)
            if info_buff then
                local not_notify_val = buff_data.not_notify and buff_data.not_notify[g.cid]
                if not_notify_val == 1 then
                    Muteki_BUFF_ON_MSG("", "BUFF_REMOVE", "dummy", b_id)
                else
                    Muteki_BUFF_ON_MSG("", "BUFF_REMOVE", "", b_id)
                    Muteki_BUFF_ON_MSG("", "BUFF_ADD", "", b_id)
                    Muteki_BUFF_ON_MSG("", "BUFF_UPDATE", "", b_id)
                end
            end
        end
    end
end

function Muteki_skill_list()
    g.muteki_skills = {}
    local buff_list = g.muteki_settings.buff_list
    for buff_id, buff_data in pairs(buff_list) do
        Muteki_process_management_data(buff_data.debuffs, "debuff_time", buff_id)
        Muteki_process_management_data(buff_data.buffs, "buff_time", buff_id)
    end
end

function Muteki_process_management_data(tbl, time_key, buff_id)
    if not tbl then
        return
    end
    for cid, info in pairs(tbl) do
        if type(info) == "table" and info.skill_id and info[time_key] then
            if cid == g.cid and info[time_key] > 0 then
                local skill_id = info.skill_id
                g.muteki_skills[tostring(skill_id)] = {
                    time = info[time_key],
                    buff_id = buff_id
                }
            end
        end
    end
end

function Muteki_setting_frame_init()
    local settings = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "muteki_settings", 0, 50, 0, 0)
    AUTO_CAST(settings)
    settings:SetSkinName("test_frame_low")
    settings:Resize(600, 1005)
    settings:SetGravity(ui.LEFT, ui.TOP)
    settings:SetOffset(0, 30)
    settings:SetLayerLevel(999)
    local title_gb = settings:CreateOrGetControl("groupbox", "title_gb", 0, 0, 600, 110)
    AUTO_CAST(title_gb)
    title_gb:SetSkinName("test_frame_top")
    local title_text = title_gb:CreateOrGetControl("richtext", "title_text", 0, 0, ui.CENTER_HORZ, ui.TOP, 0, 15, 0, 0)
    AUTO_CAST(title_text);
    title_text:SetText('{ol}{s28}MUTEKI Settings')
    local x = 0
    local buff_time = title_gb:CreateOrGetControl('richtext', 'buff_time', 15, 60, 100, 30)
    AUTO_CAST(buff_time)
    buff_time:SetText(muteki_trans('buff_time'))
    x = buff_time:GetWidth() + 15
    local buff_time_edit = title_gb:CreateOrGetControl('edit', 'buff_time_edit', x, 60, 60, 20)
    AUTO_CAST(buff_time_edit)
    buff_time_edit:SetNumberMode(1)
    buff_time_edit:SetFontName("white_16_ol")
    buff_time_edit:SetText(g.muteki_settings.etc.hide_time)
    buff_time_edit:SetTextAlign("center", "top")
    buff_time_edit:SetTypingScp("Muteki_change_settings")
    buff_time_edit:SetEventScript(ui.ENTERKEY, 'Muteki_change_settings')
    x = x + buff_time_edit:GetWidth() + 20
    local layer = title_gb:CreateOrGetControl('richtext', 'layer', x, 60, 10, 30)
    AUTO_CAST(layer)
    layer:SetText(muteki_trans('layer_lv'))
    x = x + layer:GetWidth()
    local layer_edit = title_gb:CreateOrGetControl('edit', 'layer_edit', x, 60, 50, 20)
    AUTO_CAST(layer_edit)
    layer_edit:SetNumberMode(1)
    layer_edit:SetFontName("white_16_ol")
    layer_edit:SetText(g.muteki_settings.etc.layer_lv or 80)
    layer_edit:SetTextAlign("center", "top")
    layer_edit:SetTypingScp("Muteki_change_settings")
    layer_edit:SetEventScript(ui.ENTERKEY, 'Muteki_change_settings')
    x = 0
    local mode = title_gb:CreateOrGetControl('richtext', 'mode', 15, 85, 10, 30)
    AUTO_CAST(mode)
    mode:SetText(muteki_trans('position_mode'))
    x = mode:GetWidth() + 15
    local mode_toggle = title_gb:CreateOrGetControl('picture', "mode_toggle", x, 80, 60, 25);
    AUTO_CAST(mode_toggle)
    local icon_name = "test_com_ability_on"
    if g.muteki_settings.etc.mode == "fixed" then
        icon_name = "test_com_ability_off"
    end
    mode_toggle:SetImage(icon_name)
    mode_toggle:SetEnableStretch(1)
    mode_toggle:EnableHitTest(1)
    mode_toggle:SetTextTooltip(muteki_trans("mode_desc"))
    mode_toggle:SetEventScript(ui.LBUTTONUP, "Muteki_change_settings")
    x = x + mode_toggle:GetWidth() + 10
    local move = title_gb:CreateOrGetControl('richtext', 'move', x, 85, 10, 30)
    AUTO_CAST(move)
    move:SetText(muteki_trans('frame_lock'))
    x = x + move:GetWidth()
    local move_toggle = title_gb:CreateOrGetControl('picture', "move_toggle", x, 80, 60, 25);
    AUTO_CAST(move_toggle)
    local icon_name = "test_com_ability_on"
    if g.muteki_settings.etc.lock == 1 then
        icon_name = "test_com_ability_off"
    end
    move_toggle:SetImage(icon_name)
    move_toggle:SetEnableStretch(1)
    move_toggle:EnableHitTest(1)
    move_toggle:SetTextTooltip(muteki_trans("lock_notice"))
    move_toggle:SetEventScript(ui.LBUTTONUP, "Muteki_change_settings")
    x = x + move_toggle:GetWidth() + 10
    local rotate = title_gb:CreateOrGetControl('richtext', 'rotate', x, 85, 10, 30)
    AUTO_CAST(rotate)
    rotate:SetText(muteki_trans("icon_rotate"))
    x = x + rotate:GetWidth()
    local rotate_toggle = title_gb:CreateOrGetControl('picture', "rotate_toggle", x, 80, 60, 25);
    AUTO_CAST(rotate_toggle)
    local icon_name = "test_com_ability_on"
    if g.muteki_settings.etc.rotate ~= 1 then
        icon_name = "test_com_ability_off"
    end
    rotate_toggle:SetImage(icon_name)
    rotate_toggle:SetEnableStretch(1)
    rotate_toggle:EnableHitTest(1)
    rotate_toggle:SetEventScript(ui.LBUTTONUP, "Muteki_change_settings")
    local add = title_gb:CreateOrGetControl("button", "add", 530, 80, 50, 30)
    AUTO_CAST(add)
    add:SetSkinName("test_cardtext_btn")
    add:SetText("{ol}" .. "Add")
    add:SetTextTooltip(muteki_trans("add_new"))
    add:SetEventScript(ui.LBUTTONUP, "Muteki_buff_list_open")
    local close = title_gb:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Muteki_setting_frame_close")
    local gb = settings:CreateOrGetControl("groupbox", "gb", 10, 110, 580, settings:GetHeight() - 120)
    AUTO_CAST(gb)
    gb:SetSkinName("bg")
    gb:RemoveAllChild()
    Muteki_setting_gbox_init(settings, gb)
    settings:ShowWindow(1)
end

function Muteki_setting_gbox_init(settings, gb)
    local sorted_buff_list = {}
    if g.muteki_settings.buff_list and type(g.muteki_settings.buff_list) == "table" then
        for buff_id_str, buff_data in pairs(g.muteki_settings.buff_list) do
            table.insert(sorted_buff_list, {
                buff_id = tonumber(buff_id_str),
                data = buff_data
            })
        end
    end
    table.sort(sorted_buff_list, function(a, b)
        return a.buff_id < b.buff_id
    end)
    local index = 1
    for i, entry in ipairs(sorted_buff_list) do
        index = index + 1
        local buff_id = entry.buff_id
        local buff_data = entry.data
        local buff_cls = GetClassByType('Buff', buff_id)
        local list = gb:CreateOrGetControl('groupbox', 'list' .. buff_id, 5, 5 + 175 * (i - 1), 555, 175)
        list:SetSkinName("market_listbase")
        local buff_pic = list:CreateOrGetControl('picture', 'buff_pic', 95, 10, 30, 30)
        AUTO_CAST(buff_pic)
        buff_pic:SetEnableStretch(1)
        if buff_cls and buff_cls.Icon then
            local icon_name = 'icon_' .. buff_cls.Icon
            if buff_cls.Icon == "None" then
                icon_name = "icon_item_nothing"
            end
            buff_pic:SetImage(icon_name)
            buff_pic:SetTextTooltip(muteki_trans('delete_notice'))
            buff_pic:SetEventScript(ui.RBUTTONUP, 'Muteki_delete_buff')
            buff_pic:SetEventScriptArgString(ui.RBUTTONUP, buff_cls.Name)
            buff_pic:SetEventScriptArgNumber(ui.RBUTTONUP, buff_id)
            local buff_name = list:CreateOrGetControl('richtext', 'buff_name', 130, 15, 60, 30)
            AUTO_CAST(buff_name)
            buff_name:SetText('{#000000}' .. buff_cls.Name)
            buff_name:SetTooltipType('buff')
            buff_name:SetTooltipArg(buff_name, buff_id, 0)
            local buff_edit = list:CreateOrGetControl('edit', 'buff_edit', 10, 10, 80, 30)
            AUTO_CAST(buff_edit)
            buff_edit:SetNumberMode(1)
            buff_edit:SetFontName("white_16_ol")
            buff_edit:SetText(buff_cls.ClassID)
            buff_edit:SetTextAlign("center", "center")
            buff_edit:SetTextTooltip(muteki_trans('function_notice'))
            buff_edit:SetTypingScp("Muteki_add_buff")
            buff_edit:SetEventScript(ui.ENTERKEY, 'Muteki_add_buff')
            buff_edit:SetEventScriptArgString(ui.ENTERKEY, buff_id)
        end
        local circle = list:CreateOrGetControl('checkbox', 'circle', 10, 45, 200, 25)
        AUTO_CAST(circle)
        local circle_icon = buff_data.circle_icon
        circle:SetCheck(circle_icon)
        circle:SetText(muteki_trans('icon_mode'))
        circle:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        circle:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        local not_notify = list:CreateOrGetControl('checkbox', 'not_notify', 10, 70, 200, 25)
        AUTO_CAST(not_notify)
        not_notify:SetCheck(buff_data.not_notify[g.cid])
        not_notify:SetText(muteki_trans('not_notify'))
        not_notify:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        not_notify:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        local pt_chat = list:CreateOrGetControl('checkbox', 'pt_chat', 10, 95, 200, 25)
        AUTO_CAST(pt_chat)
        pt_chat:SetCheck(buff_data.pt_chat)
        pt_chat:SetText(muteki_trans('pt_chat'))
        pt_chat:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        pt_chat:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        local nico_chat = list:CreateOrGetControl('checkbox', 'nico_chat', 10, 120, 200, 25)
        AUTO_CAST(nico_chat)
        nico_chat:SetCheck(buff_data.nico_chat)
        nico_chat:SetText(muteki_trans('nico_chat'))
        nico_chat:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        nico_chat:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        local effect = list:CreateOrGetControl('checkbox', 'effect', 270, 70, 200, 25)
        AUTO_CAST(effect)
        effect:SetCheck(buff_data.effect_check)
        effect:SetText(muteki_trans('with_effect'))
        effect:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        effect:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        local color_pic = list:CreateOrGetControl('picture', 'color_pic', 510, 10, 30, 25)
        AUTO_CAST(color_pic)
        color_pic:SetEnableStretch(1)
        color_pic:SetImage("chat_color")
        color_pic:SetColorTone(buff_data.color or g.muteki_default_color)
        color_pic:SetTextTooltip(muteki_trans('color_tone'))
        local color_tbl = {'FFFFFF00', -- [1] 黄色
        'FFFFD700', -- [2] ゴールド
        'FFFF4500', -- [3] オレンジ
        'FF00FF00', -- [4] ライムグリーン
        'FF008000', -- [5] 緑
        'FF00BFFF', -- [6] スカイブルー
        'FF0000FF', -- [7] 青
        'FF800080', -- [8] 紫
        "FFFF1493", -- [9] ピンク
        "FFFF0000" -- [10] 赤
        }
        local color_box = list:CreateOrGetControl('groupbox', "color_box", 315, 45, 220, 25);
        AUTO_CAST(color_box)
        for i = 1, #color_tbl do
            local color_value = color_tbl[i]
            local color = color_box:CreateOrGetControl("picture", "color_" .. i, 20 * i, 0, 20, 25);
            AUTO_CAST(color)
            color:SetImage("chat_color")
            color:SetColorTone(color_value)
            color:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
            color:SetEventScriptArgString(ui.LBUTTONUP, color_value)
            color:SetEventScriptArgNumber(ui.LBUTTONUP, buff_id)
        end
        local color_edit = list:CreateOrGetControl('edit', 'color_edit', 405, 10, 100, 30)
        AUTO_CAST(color_edit)
        color_edit:SetFontName("white_16_ol")
        color_edit:SetText("{ol}" .. buff_data.color or g.muteki_default_color)
        color_edit:SetTextAlign("center", "center")
        color_edit:SetTextTooltip(muteki_trans('color_notice'))
        color_edit:SetNumberMode(0)
        color_edit:SetEventScript(ui.ENTERKEY, 'Muteki_setting_change')
        color_edit:SetEventScriptArgString(ui.ENTERKEY, buff_data.color or g.muteki_default_color)
        color_edit:SetEventScriptArgNumber(ui.ENTERKEY, buff_id)
        if buff_cls.OverBuff > 1 then
            local count_display = list:CreateOrGetControl('checkbox', 'count_display', 270, 95, 200, 25)
            AUTO_CAST(count_display)
            count_display:SetCheck(buff_data.count_display)
            count_display:SetText(muteki_trans('count_display'))
            count_display:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
            count_display:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        end
        local x = 0
        local xx = 0
        local time_edit = list:CreateOrGetControl('edit', 'time_edit', 10, 145, 80, 25)
        AUTO_CAST(time_edit)
        time_edit:SetFontName("white_16_ol")
        time_edit:SetTextAlign("center", "center")
        time_edit:SetNumberMode(1)
        local debuff_time = ""
        local buff_time = ""
        local current_buff_list = g.muteki_settings.buff_list[tostring(buff_id)]
        if buff_cls.Group1 == "Debuff" or buff_cls.Group1 == "Deuff" then
            if current_buff_list and current_buff_list.debuffs and current_buff_list.debuffs[g.cid] then
                local d_manage = current_buff_list.debuffs[g.cid]
                if d_manage.debuff_time and d_manage.debuff_time > 0 then
                    debuff_time = d_manage.debuff_time
                end
            end
            time_edit:SetText("{ol}" .. (debuff_time or ""))
            time_edit:SetTextTooltip(muteki_trans('debuff_notice'))
            time_edit:SetUserValue("SWITCH", "debuff")
            time_edit:SetUserValue("BUFF_ID", buff_id)
            time_edit:SetTypingScp("Muteki_setting_change")
            time_edit:SetEventScript(ui.ENTERKEY, 'Muteki_setting_change')
            time_edit:SetEventScriptArgString(ui.ENTERKEY, buff_id)
            x = x + time_edit:GetWidth() + 15
            local time = list:CreateOrGetControl('richtext', 'time', x, 147, 100, 25)
            AUTO_CAST(time)
            time:SetText(muteki_trans('debuff_time'))
            x = x + time:GetWidth() + 10
        else
            if current_buff_list and current_buff_list.buffs and current_buff_list.buffs[g.cid] then
                local b_manage = current_buff_list.buffs[g.cid]
                if b_manage.buff_time and b_manage.buff_time > 0 then
                    buff_time = b_manage.buff_time
                end
            end
            time_edit:SetText("{ol}" .. (buff_time or ""))
            time_edit:SetTextTooltip(muteki_trans('buff_notice_cid'))
            time_edit:SetUserValue("SWITCH", "buff")
            time_edit:SetUserValue("BUFF_ID", buff_id)
            time_edit:SetTypingScp("Muteki_setting_change")
            time_edit:SetEventScript(ui.ENTERKEY, 'Muteki_setting_change')
            time_edit:SetEventScriptArgString(ui.ENTERKEY, buff_id)
            xx = xx + time_edit:GetWidth() + 15
            local time = list:CreateOrGetControl('richtext', 'time', xx, 147, 100, 25)
            AUTO_CAST(time)
            time:SetText(muteki_trans('buff_time_cid'))
            xx = xx + time:GetWidth() + 10
        end
        x = x >= xx and x or xx
        if buff_time ~= "" or debuff_time ~= "" then
            local skill_edit = list:CreateOrGetControl('edit', 'skill_edit', x, 145, 80, 25)
            AUTO_CAST(skill_edit)
            skill_edit:SetFontName("white_16_ol")
            local skill_id = ""
            if current_buff_list then
                if current_buff_list.buffs and current_buff_list.buffs[g.cid] then
                    local bm = current_buff_list.buffs[g.cid]
                    if bm.skill_id and bm.skill_id > 0 then
                        skill_id = bm.skill_id
                    end
                end
                if current_buff_list.debuffs and current_buff_list.debuffs[g.cid] then
                    local dm = current_buff_list.debuffs[g.cid]
                    if dm.skill_id and dm.skill_id > 0 then
                        skill_id = dm.skill_id
                    end
                end
            end
            skill_edit:SetTextTooltip(muteki_trans('skill_notice'))
            skill_edit:SetTextAlign("center", "center")
            skill_edit:SetNumberMode(1)
            skill_edit:SetText("{ol}" .. skill_id)
            skill_edit:SetUserValue("SWITCH", time_edit:GetUserValue("SWITCH"))
            skill_edit:SetUserValue("BUFF_ID", buff_id)
            skill_edit:SetEventScript(ui.ENTERKEY, 'Muteki_setting_change')
            skill_edit:SetEventScriptArgString(ui.ENTERKEY, buff_id)
            skill_edit:SetTypingScp("Muteki_setting_change")
            x = x + skill_edit:GetWidth() + 5
            local skill_text = list:CreateOrGetControl('richtext', 'skill_text', x, 147, 100, 25)
            AUTO_CAST(skill_text)
            skill_text:SetText(muteki_trans('skill_text'))
            x = x + skill_text:GetWidth() + 5
            local add = list:CreateOrGetControl("button", "add", x, 140, 40, 30)
            AUTO_CAST(add)
            add:SetSkinName("test_cardtext_btn")
            add:SetText("{ol}{s13}" .. "Add")
            add:SetTextTooltip(muteki_trans("add_new_skill"))
            add:SetEventScript(ui.LBUTTONUP, "Muteki_skill_list_open")
            add:SetEventScriptArgNumber(ui.LBUTTONUP, tonumber(buff_id))
        end
        local end_sound = list:CreateOrGetControl('checkbox', 'end_sound', 270, 120, 200, 25)
        AUTO_CAST(end_sound)
        end_sound:SetCheck(buff_data.end_sound)
        end_sound:SetText(muteki_trans('end_sound'))
        end_sound:SetEventScript(ui.LBUTTONUP, 'Muteki_setting_change')
        end_sound:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
    end
    local list = gb:CreateOrGetControl('groupbox', 'list' .. index, 5, 5 + 175 * (index - 1), 555, 175)
    list:SetSkinName("market_listbase")
    local buff_edit = list:CreateOrGetControl('edit', 'buff_edit', 10, 10, 80, 30)
    AUTO_CAST(buff_edit)
    buff_edit:SetNumberMode(1)
    buff_edit:SetFontName("white_16_ol")
    buff_edit:SetTextAlign("center", "center")
    buff_edit:SetTextTooltip(muteki_trans('function_notice'))
    buff_edit:SetEventScript(ui.ENTERKEY, 'Muteki_add_buff')
    buff_edit:SetTextTooltip(muteki_trans('function_notice'))
    buff_edit:SetTypingScp("Muteki_add_buff")
    for i, entry in ipairs(sorted_buff_list) do
        local buff_id = entry.buff_id
        if g.muteki_cur_pos and tostring(buff_id) == g.muteki_cur_pos then
            gb:SetScrollPos(155 * (i - 3))
            local list = GET_CHILD(gb, "list" .. buff_id)
            list:SetSkinName("test_skin_01") -- monster_card_list
            g.muteki_cur_pos = nil
        end
    end
end

function Muteki_change_settings_edit(ctrl)
    local config_map = {
        buff_time_edit = {
            key = "hide_time",
            default = 300,
            msg_key = "hide_sec"
        },
        layer_edit = {
            key = "layer_lv",
            default = 80,
            msg_key = "layer_notice"
        }
    }
    local config = config_map[ctrl:GetName()]
    if not config then
        return
    end
    local val = tonumber(ctrl:GetText())
    if val then
        g.muteki_settings.etc[config.key] = val
        ui.SysMsg(string.format(muteki_trans(config.msg_key), val))
        Muteki_save_settings()
        Muteki_setting_frame_init()
        Muteki_buff_frame_init()
        Muteki_refresh_active_buffs()
    else
        g.muteki_settings.etc[config.key] = config.default
    end
    return 0
end

function Muteki_change_settings(frame, ctrl, str, num)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "buff_time_edit" or ctrl_name == "layer_edit" then
        ctrl:RunUpdateScript("Muteki_change_settings_edit", 1.0)
        return
    elseif ctrl_name == "mode_toggle" then
        if g.muteki_settings.etc.mode == "fixed" then
            g.muteki_settings.etc.mode = "trace"
        else
            g.muteki_settings.etc.mode = "fixed"
        end
    elseif ctrl_name == "move_toggle" then
        if g.muteki_settings.etc.lock == 1 then
            g.muteki_settings.etc.lock = 0
        else
            g.muteki_settings.etc.lock = 1
        end
    elseif ctrl_name == "rotate_toggle" then
        if g.muteki_settings.etc.rotate == 1 then
            g.muteki_settings.etc.rotate = 0
        else
            g.muteki_settings.etc.rotate = 1
        end
    end
    Muteki_save_settings()
    Muteki_setting_frame_init()
    Muteki_buff_frame_init()
    Muteki_refresh_active_buffs()
end

function Muteki_setting_change_edit(ctrl)
    local switch = ctrl:GetUserValue("SWITCH")
    local buff_id_str = ctrl:GetUserValue("BUFF_ID")
    local ctrl_name = ctrl:GetName()
    local input_val = tonumber(ctrl:GetText())
    local type_key = (switch == "debuff") and "debuffs" or "buffs"
    local setting_entry = g.muteki_settings.buff_list[buff_id_str]
    if not setting_entry[type_key][g.cid] then
        setting_entry[type_key][g.cid] = {}
    end
    local target_data = setting_entry[type_key][g.cid]
    if ctrl_name == "skill_edit" then
        if input_val then
            local skill_cls = GetClassByType("Skill", input_val)
            if skill_cls then
                target_data.skill_id = input_val
                ui.SysMsg(string.format(muteki_trans("skill_set"), skill_cls and skill_cls.Name or input_val))
            else
                ctrl:SetText("")
                target_data.skill_id = 0
            end
        else
            ctrl:SetText("")
            target_data.skill_id = 0
        end
    else
        local time_key = (switch == "debuff") and "debuff_time" or "buff_time"
        target_data[time_key] = input_val or 0
        if not input_val then
            ctrl:SetText("")
        end
        ui.SysMsg(string.format(muteki_trans("debuff_manage_set"), target_data[time_key]))
    end
    Muteki_skill_list()
    Muteki_setting_frame_init()
    Muteki_save_settings()
    Muteki_refresh_active_buffs()
    return 0
end

function Muteki_setting_change(frame, ctrl, arg_str, arg_num)
    local ctrl_name = ctrl:GetName()
    local buff_id = arg_num
    local buff_id_str = tostring(buff_id)
    local not_notify = {}
    if ctrl_name == "circle" then
        g.muteki_settings.buff_list[arg_str].circle_icon = ctrl:IsChecked()
    elseif ctrl_name == "not_notify" then
        g.muteki_settings.buff_list[arg_str].not_notify[g.cid] = ctrl:IsChecked()
    elseif ctrl_name == "pt_chat" then
        g.muteki_settings.buff_list[arg_str].pt_chat = ctrl:IsChecked()
    elseif ctrl_name == "nico_chat" then
        g.muteki_settings.buff_list[arg_str].nico_chat = ctrl:IsChecked()
    elseif ctrl_name == "effect" then
        g.muteki_settings.buff_list[arg_str].effect_check = ctrl:IsChecked()
    elseif ctrl_name == "count_display" then
        g.muteki_settings.buff_list[arg_str].count_display = ctrl:IsChecked()
    elseif ctrl_name == "end_sound" then
        g.muteki_settings.buff_list[arg_str].end_sound = ctrl:IsChecked()
    elseif ctrl_name == "color_edit" then
        local color_text = ctrl:GetText()
        if string.len(color_text) ~= 8 then
            ctrl:SetText(g.muteki_settings.buff_list[buff_id_str].color)
            ui.SysMsg(muteki_trans("color_notice"))
            return
        end
        g.muteki_settings.buff_list[buff_id_str].color = color_text
    elseif string.find(ctrl_name, "color_") then
        g.muteki_settings.buff_list[buff_id_str].color = arg_str
    elseif ctrl_name == "time_edit" or ctrl_name == "skill_edit" then
        ctrl:RunUpdateScript("Muteki_setting_change_edit", 1.0)
        return
    end
    Muteki_setting_frame_init()
    Muteki_save_settings()
    Muteki_refresh_active_buffs()
end

function Muteki_add_buff_msg(frame, ctrl, cls_name, buff_id)
    local yes_scp = string.format("Muteki_add_buff('','%s','%s','')", ctrl:GetName(), buff_id)
    local msg = string.format(muteki_trans('add_check'), cls_name)
    ui.MsgBox(msg, yes_scp, "None")
end

function Muteki_add_buff_edit(ctrl)
    local ctrl_name = ctrl:GetName()
    local buff_id_str = ctrl:GetText()
    local buff_id = tonumber(buff_id_str)
    if buff_id and (ctrl_name == "buff_edit" or ctrl_name == "id_edit") then
        local buff_cls = GetClassByType("Buff", buff_id)
        if buff_cls then
            g.muteki_settings.buff_list[tostring(buff_id)] = {
                circle_icon = 0,
                effect_check = 0,
                not_notify = {},
                count_display = 0,
                pt_chat = 0,
                nico_chat = 0,
                end_sound = "None",
                color = "FFCCCC22",
                buffs = {},
                debuffs = {}
            }
            ui.SysMsg(string.format(muteki_trans("add_buff"), buff_cls.Name))
            Muteki_save_settings()
            g.muteki_cur_pos = ctrl:GetY()
            Muteki_setting_frame_init()
        end
    end
    if ctrl_name == "id_edit" then
        ctrl:SetText("")
    end
    Muteki_refresh_active_buffs()
    return 0
end

function Muteki_add_buff(frame, ctrl, buff_id_str, num)
    local ctrl_name = ""
    if type(ctrl) == "string" then
        ctrl_name = ctrl
    else
        ctrl_name = ctrl:GetName()
    end
    local buff_id_process = nil
    if string.find(ctrl_name, "buff_set") then
        buff_id_process = buff_id_str
    elseif ctrl_name == "buff_edit" then
        ctrl:RunUpdateScript("Muteki_add_buff_edit", 1.0)
        return
    elseif ctrl_name == "id_edit" then
        ctrl:RunUpdateScript("Muteki_add_buff_edit", 1.0)
        return
    elseif string.find(ctrl_name, "slot") then
        buff_id_process = buff_id_str
    end
    if buff_id_process and buff_id_process ~= "" then
        local buff_id_num = tonumber(buff_id_process)
        local buff_cls = GetClassByType("Buff", buff_id_num)
        if buff_cls then
            g.muteki_settings.buff_list[buff_id_process] = {
                ["circle_icon"] = 0,
                ["effect_check"] = 0,
                ["not_notify"] = {},
                ["count_display"] = 0,
                ["pt_chat"] = 0,
                ["nico_chat"] = 0,
                ["end_sound"] = "None",
                ["color"] = "FFCCCC22",
                ["buffs"] = {},
                ["debuffs"] = {}
            }
            ui.SysMsg(string.format(muteki_trans("add_buff"), buff_cls.Name))
        else
            return
        end
    end
    Muteki_save_settings()
    if not string.find(ctrl_name, "slot") then
        g.muteki_cur_pos = buff_id_process
        Muteki_setting_frame_init()
    end
    Muteki_refresh_active_buffs()
end

function Muteki_delete_buff(frame, ctrl, buff_name, buff_id)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "buff_pic" then
        g.muteki_settings.buff_list[tostring(buff_id)] = nil
        ui.SysMsg(string.format(muteki_trans("delete_buff"), buff_name))
    end
    Muteki_save_settings()
    Muteki_setting_frame_init()
    Muteki_BUFF_ON_MSG("", "BUFF_REMOVE", "dummy", buff_id)
end

function Muteki_buff_list_open(frame, ctrl, ctrl_text, num)
    local buff_list_frame_name = addon_name_lower .. "muteki_buff_list"
    local buff_list = ui.GetFrame(addon_name_lower .. "muteki_buff_list")
    if not buff_list then
        buff_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "muteki_buff_list", 0, 0, 10, 10)
        AUTO_CAST(buff_list)
        buff_list:SetSkinName("test_frame_low")
        buff_list:Resize(500, 1005)
        buff_list:SetPos(610, 30)
        buff_list:SetLayerLevel(999)
        local id_edit = buff_list:CreateOrGetControl('edit', 'id_edit', 20, 15, 80, 30)
        AUTO_CAST(id_edit)
        id_edit:SetNumberMode(1)
        id_edit:SetFontName("white_16_ol")
        id_edit:SetTextAlign("center", "center")
        id_edit:SetText("")
        id_edit:SetEventScript(ui.ENTERKEY, 'Muteki_add_buff')
        id_edit:SetTextTooltip(muteki_trans("add_buffid"))
        local search_edit = buff_list:CreateOrGetControl("edit", "search_edit", id_edit:GetWidth() + 40, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Muteki_buff_list_search")
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Muteki_buff_list_search")
        local close_button = buff_list:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
        AUTO_CAST(close_button)
        close_button:SetImage("testclose_button")
        close_button:SetGravity(ui.RIGHT, ui.TOP)
        close_button:SetEventScript(ui.LBUTTONUP, "Muteki_buff_list_close")
    end
    local buff_list_gb = buff_list:CreateOrGetControl("groupbox", "buff_list_gb", 10, 50, 480,
        buff_list:GetHeight() - 60)
    AUTO_CAST(buff_list_gb)
    buff_list_gb:SetSkinName("bg")
    buff_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Buff")
    local y = 0
    for i = 0, count - 1 do
        local buff_cls = GetClassByIndexFromList(cls_list, i)
        if buff_cls then
            local buff_id = buff_cls.ClassID
            local buff_name = dictionary.ReplaceDicIDInCompStr(buff_cls.Name)
            if ctrl_text == "" or (ctrl_text ~= "" and string.find(buff_name, ctrl_text)) then
                local buff_slot = buff_list_gb:CreateOrGetControl('slot', 'buffslot' .. i, 10, y + 5, 30, 30)
                AUTO_CAST(buff_slot)
                local image_name = GET_BUFF_ICON_NAME(buff_cls)
                if image_name == "icon_None" then
                    image_name = "icon_item_nothing"
                end
                if buff_name ~= "None" then
                    SET_SLOT_IMG(buff_slot, image_name)
                    local icon = CreateIcon(buff_slot)
                    AUTO_CAST(icon)
                    icon:SetTooltipType('buff')
                    icon:SetTooltipArg(buff_name, buff_id, 0)
                    local buff_set = buff_list_gb:CreateOrGetControl('button', 'buff_set' .. buff_id, 45, y + 5, 40, 30)
                    AUTO_CAST(buff_set)
                    buff_set:SetText("{ol}Add")
                    buff_set:SetSkinName("test_cardtext_btn")
                    buff_set:SetTextTooltip(muteki_trans("add_new"))
                    buff_set:SetEventScript(ui.LBUTTONUP, "Muteki_add_buff")
                    buff_set:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
                    local buff_text = buff_list_gb:CreateOrGetControl('richtext', 'buff_text' .. buff_id, 90, y + 10,
                        200, 30)
                    AUTO_CAST(buff_text)
                    buff_text:SetText("{ol}" .. buff_id .. " : " .. buff_name)
                    buff_text:AdjustFontSizeByWidth(380)
                    y = y + 35
                end
            end
        end
    end
    buff_list:ShowWindow(1)
end

function Muteki_buff_list_search(frame, ctrl, str, num)
    local search_edit = GET_CHILD_RECURSIVELY(frame, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Muteki_buff_list_open(frame, ctrl, ctrl_text)
    else
        Muteki_buff_list_open(frame, ctrl, "")
    end
end

function Muteki_buff_list_close(frame, ctrl, str, num)
    ui.DestroyFrame(frame:GetName())
end

function Muteki_skill_list_open(frame, add, ctrl_text, buff_id)
    local skill_list = ui.GetFrame(addon_name_lower .. "muteki_skill_list")
    if not skill_list then
        skill_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "muteki_skill_list", 0, 0, 10, 10)
        AUTO_CAST(skill_list)
        skill_list:SetSkinName("test_frame_low")
        skill_list:Resize(500, 1005)
        skill_list:SetPos(610, 30)
        skill_list:SetLayerLevel(999)
        local title_text = skill_list:CreateOrGetControl('richtext', 'itle_text', 15, 15, 10, 30)
        AUTO_CAST(title_text)
        title_text:SetText("{#000000}{s20}Skill List")
        local search_edit =
            skill_list:CreateOrGetControl("edit", "search_edit", title_text:GetWidth() + 30, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Muteki_skill_list_search")
        search_edit:SetEventScriptArgNumber(ui.ENTERKEY, buff_id)
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Muteki_skill_list_search")
        local close_button = skill_list:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
        AUTO_CAST(close_button)
        close_button:SetImage("testclose_button")
        close_button:SetGravity(ui.RIGHT, ui.TOP)
        close_button:SetEventScript(ui.LBUTTONUP, "Muteki_skill_list_close")
    end
    local skill_list_gb = skill_list:CreateOrGetControl("groupbox", "skill_list_gb", 10, 50, 480,
        skill_list:GetHeight() - 60)
    AUTO_CAST(skill_list_gb)
    skill_list_gb:SetSkinName("bg")
    skill_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Skill")
    local y = 0
    for i = 0, count - 1 do
        local skill_cls = GetClassByIndexFromList(cls_list, i)
        if skill_cls then
            local skill_id = skill_cls.ClassID
            local skill_cls_name = skill_cls.ClassName
            local skill_engname = skill_cls.EngName
            local skill_caption = skill_cls.Caption
            local skill_name = dictionary.ReplaceDicIDInCompStr(skill_cls.Name)
            if ctrl_text == "" or (ctrl_text ~= "" and string.find(skill_name, ctrl_text)) then
                local skill_slot = skill_list_gb:CreateOrGetControl('slot', 'skill_slot' .. i, 10, y + 5, 30, 30)
                AUTO_CAST(skill_slot)
                local image_name = "icon_" .. skill_cls.Icon
                if skill_id > 10000 then
                    if not string.find(skill_cls_name, "^Mon_") and not string.find(skill_engname, "plzInputEngName") and
                        not string.find(skill_name, "_") and not string.find(skill_name, "TEST") then
                        if ctrl_text == "" or (ctrl_text ~= "" and string.find(skill_name, ctrl_text)) then
                            SET_SLOT_IMG(skill_slot, image_name)
                            local icon = CreateIcon(skill_slot)
                            AUTO_CAST(icon)
                            SET_SKILL_TOOLTIP_BY_TYPE(icon, skill_id)
                            local skill_set = skill_list_gb:CreateOrGetControl('button', 'skill_set' .. skill_id, 45,
                                y + 5, 40, 30)
                            AUTO_CAST(skill_set)
                            skill_set:SetText("{ol}Add")
                            skill_set:SetSkinName("test_cardtext_btn")
                            skill_set:SetTextTooltip(muteki_trans("add_new_skill"))
                            skill_set:SetEventScript(ui.LBUTTONUP, "Muteki_add_skill")
                            skill_set:SetEventScriptArgNumber(ui.LBUTTONUP, skill_id)
                            skill_set:SetEventScriptArgString(ui.LBUTTONUP, tostring(buff_id))
                            local skill_text = skill_list_gb:CreateOrGetControl('richtext', 'skill_text' .. skill_id,
                                90, y + 10, 200, 30)
                            AUTO_CAST(skill_text)
                            skill_text:SetText("{ol}" .. skill_id .. " : " .. skill_name)
                            skill_text:AdjustFontSizeByWidth(380)
                            y = y + 35
                        end
                    end
                end
            end
        end

    end
    skill_list:ShowWindow(1)
end

function Muteki_skill_list_search(frame, ctrl, str, buff_id)
    local search_edit = GET_CHILD_RECURSIVELY(frame, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Muteki_skill_list_open(frame, ctrl, ctrl_text, buff_id)
    else
        Muteki_skill_list_open(frame, ctrl, "", buff_id)
    end
end

function Muteki_skill_list_close(frame, ctrl, str, num)
    ui.DestroyFrame(frame:GetName())
end

function Muteki_add_skill(frame, ctrl, buff_id_str, skill_id)
    local ctrl_name = ctrl:GetName()
    local settings = ui.GetFrame(addon_name_lower .. "muteki_settings")
    local list = GET_CHILD_RECURSIVELY(settings, 'list' .. buff_id_str)
    local skill_edit = GET_CHILD(list, "skill_edit")
    skill_edit:SetText(skill_id)
    local switch = skill_edit:GetUserValue("SWITCH")
    Muteki_setting_change_edit(skill_edit)
end

function Muteki_setting_frame_close(parent, ctrl)
    local settings = parent:GetTopParentFrame()
    ui.DestroyFrame(settings:GetName())
    local buff_list_frame_name = addon_name_lower .. "muteki_buff_list"
    local buff_list_frame = ui.GetFrame(buff_list_frame_name)
    if buff_list_frame then
        Muteki_buff_list_close(buff_list_frame, "", "", "")
    end
    local skill_list_frame_name = addon_name_lower .. "muteki_skill_list"
    local skill_list_frame = ui.GetFrame(skill_list_frame_name)
    if skill_list_frame then
        Muteki_skill_list_close(skill_list_frame, "", "", "")
    end
end
-- muteki ここまで

-- no_check ここから
function no_check_on_init()
    No_check_inventory_frame_init()
    g.setup_hook_and_event(g.addon, "BEFORE_APPLIED_YESSCP_OPEN_BASIC_MSG",
        "No_check_BEFORE_APPLIED_YESSCP_OPEN_BASIC_MSG", false)
    g.setup_hook_and_event(g.addon, "CARD_SLOT_EQUIP", "No_check_CARD_SLOT_EQUIP", false)
    g.setup_hook_and_event(g.addon, "EQUIP_CARDSLOT_INFO_OPEN", "No_check_EQUIP_CARDSLOT_INFO_OPEN", false)
    g.setup_hook_and_event(g.addon, "EQUIP_GODDESSCARDSLOT_INFO_OPEN", "No_check_EQUIP_GODDESSCARDSLOT_INFO_OPEN", false)
    g.setup_hook_and_event(g.addon, "GODDESS_MGR_SOCKET_REQ_GEM_REMOVE", "No_check_GODDESS_MGR_SOCKET_REQ_GEM_REMOVE",
        false)
    g.setup_hook_and_event(g.addon, "UNLOCK_TRANSMUTATIONSPREADER_BELONGING_SCROLL_EXEC_ASK_AGAIN",
        "No_check_UNLOCK_TRANSMUTATIONSPREADER_BELONGING_SCROLL_EXEC_ASK_AGAIN", false)
    g.setup_hook_and_event(g.addon, "UNLOCK_ACC_BELONGING_SCROLL_EXEC_ASK_AGAIN",
        "No_check_UNLOCK_ACC_BELONGING_SCROLL_EXEC_ASK_AGAIN", false)
    g.setup_hook_and_event(g.addon, "SELECT_ZONE_MOVE_CHANNEL", "No_check_SELECT_ZONE_MOVE_CHANNEL", false)
    g.setup_hook_and_event(g.addon, "BEFORE_APPLIED_NON_EQUIP_ITEM_OPEN", "No_check_BEFORE_APPLIED_NON_EQUIP_ITEM_OPEN",
        false)
    g.setup_hook_and_event(g.addon, "INVENTORY_CLOSE", "No_check_frame_close", true)
    g.setup_hook_and_event(g.addon, "MORU_LBTN_CLICK", "No_check_MORU_LBTN_CLICK", true)
    if g.get_map_type() == "City" then
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        _nexus_addons:RunUpdateScript("No_check_timer_update", 0.3)
    end
end

function No_check_inventory_frame_init()
    local inventory = ui.GetFrame("inventory")
    local inventory_btns = {"moncard_btn", "helper_btn", "cabinet_btn", "goddess_mgr_btn"}
    if inventory then
        for _, btn_name in ipairs(inventory_btns) do
            local btn = GET_CHILD_RECURSIVELY(inventory, btn_name)
            if btn and btn:IsVisible() == 0 then
                btn:ShowWindow(1)
            end
        end
    end
    local searchSkin = GET_CHILD_RECURSIVELY(inventory, "searchSkin")
    if g.settings.no_check.use == 1 then -- !
        local searchGbox = GET_CHILD_RECURSIVELY(inventory, "searchGbox")
        local btn = searchGbox:CreateOrGetControl("button", "btn", 160, -3, 35, 38)
        AUTO_CAST(btn)
        searchSkin:Resize(284, 30)
        searchSkin:SetMargin(38, 0, 0, 5)
        btn:SetSkinName("test_pvp_btn")
        local tool_tip = g.lang == "Japanese" and
                             "{ol}[No Check]{nl}左クリック: アイテム連続フレーム表示{nl}右クリック: ゴミ箱フレーム表示" or
                             "{ol}[No Check]{nl}Left Click: Item continuous frame display{nl}Right Click: Trash frame display"
        btn:SetTextTooltip(tool_tip)
        btn:SetText("{img equipment_info_btn_mark2 32 32}")
        btn:SetEventScript(ui.LBUTTONUP, "No_check_continuous_use_frame")
        btn:SetEventScript(ui.RBUTTONUP, "No_check_delete_item_frame")
    else
        searchSkin:Resize(317, 30)
        searchSkin:SetMargin(5, 0, 0, 5)
        local searchGbox = GET_CHILD_RECURSIVELY(inventory, "searchGbox")
        DESTROY_CHILD_BYNAME(searchGbox, "btn")
    end
end
-- アイテム連続使用
function No_check_continuous_use_frame(frame, ctrl, str, num)
    local inventory = ui.GetFrame("inventory")
    local no_check_use = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "no_check_use", 0, 0, 0, 0)
    AUTO_CAST(no_check_use)
    no_check_use:SetGravity(ui.RIGHT, ui.TOP)
    no_check_use:SetSkinName("test_win_lastpopup")
    local rect = no_check_use:GetMargin()
    no_check_use:SetMargin(rect.left - rect.left, rect.top - rect.top + 300,
        rect.right == 0 and rect.right + 310 + 200 or rect.right, rect.bottom)
    no_check_use:Resize(300, 300)
    no_check_use:RemoveAllChild()
    no_check_use:ShowWindow(1)
    local item_slot = no_check_use:CreateOrGetControl('slot', 'item_slot', 115, 100, 70, 70)
    AUTO_CAST(item_slot)
    item_slot:SetSkinName("slot")
    INVENTORY_SET_CUSTOM_RBTNDOWN("No_check_inv_rbtn")
    item_slot:SetEventScript(ui.RBUTTONUP, "No_check_use_icon_clear")
    local notice = no_check_use:CreateOrGetControl('richtext', 'notice', 30, 180, 0, 0)
    AUTO_CAST(notice)
    notice:SetText(g.lang == "Japanese" and "{ol}{s20}アイテムを連続使用します" or
                       "{ol}{s18}Use the item continuously")
    local continuous_use = no_check_use:CreateOrGetControl('button', 'continuous_use', 40, 220, 100, 50)
    AUTO_CAST(continuous_use)
    continuous_use:SetSkinName("test_red_button")
    continuous_use:SetText(g.lang == "Japanese" and "{ol}{s16}連続使用" or "{ol}{s16}Continu")
    continuous_use:SetEventScript(ui.LBUTTONUP, "No_check_continuous_use")
    local cancel = no_check_use:CreateOrGetControl('button', 'cancel', 155, 220, 100, 50)
    AUTO_CAST(cancel)
    cancel:SetSkinName("test_gray_button")
    cancel:SetText(g.lang == "Japanese" and "{ol}{s16}キャンセル" or "{ol}{s16}Cancel")
    cancel:SetEventScript(ui.LBUTTONUP, "No_check_frame_close")
end

function No_check_use_icon_clear(no_check_use, item_slot)
    CLEAR_SLOT_ITEM_INFO(item_slot)
end

function No_check_continuous_use(no_check_use, ctrl, str, num)
    local item_slot = GET_CHILD(no_check_use, "item_slot")
    AUTO_CAST(item_slot)
    local clsid = item_slot:GetUserIValue("CLASS_ID")
    if clsid == 0 then
        return
    end
    local inv_item = session.GetInvItemByType(clsid)
    if inv_item then
        no_check_use:SetUserValue("PREV_COUNT", -1)
        no_check_use:RunUpdateScript("No_check_icontinuous_use_result", 0.5)
    end
end

function No_check_icontinuous_use_result(no_check_use)
    local item_slot = GET_CHILD(no_check_use, "item_slot")
    AUTO_CAST(item_slot)
    local clsid = item_slot:GetUserIValue("CLASS_ID")
    local inv_item = session.GetInvItemByType(clsid)
    if inv_item then
        local current_count = inv_item.count
        local prev_count = no_check_use:GetUserIValue("PREV_COUNT")
        if prev_count ~= -1 and current_count == prev_count then
            No_check_use_icon_clear(no_check_use, item_slot)
            return 0 -- スクリプト停止
        end
        no_check_use:SetUserValue("PREV_COUNT", current_count)
        INV_ICON_USE(inv_item)
        local item_cls = GetClassByType("Item", clsid)
        SET_SLOT_ITEM_CLS(item_slot, item_cls)
        SET_SLOT_ITEM_TEXT(item_slot, inv_item, item_cls)
        return 1
    else
        No_check_use_icon_clear(no_check_use, item_slot)
    end
end
-- ゴミ箱フレーム
function No_check_delete_item_frame()
    local no_check_delete = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "no_check_delete", 0, 0, 10, 10)
    AUTO_CAST(no_check_delete)
    no_check_delete:SetSkinName("test_frame_low")
    no_check_delete:SetGravity(ui.RIGHT, ui.TOP)
    local rect = no_check_delete:GetMargin()
    no_check_delete:SetMargin(rect.left - rect.left, rect.top - rect.top + 100,
        rect.right == 0 and rect.right + 310 + 200 or rect.right, rect.bottom)
    no_check_delete:SetLayerLevel(100)
    no_check_delete:Resize(300, 698)
    no_check_delete:RemoveAllChild()
    local title = no_check_delete:CreateOrGetControl('richtext', 'title', 10, 15, 0, 0)
    AUTO_CAST(title)
    title:SetText(g.lang == "Japanese" and "{ol}{s18}ゴミ箱スロット" or "{ol}{s18}Discard item Slots")
    local close = no_check_delete:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "No_check_frame_close")
    close:SetEventScriptArgString(ui.LBUTTONUP, "true")
    local delete_gb = no_check_delete:CreateOrGetControl("groupbox", "delete_gb", 10, 40, 380, 380)
    AUTO_CAST(delete_gb)
    delete_gb:SetSkinName("test_frame_midle_light")
    delete_gb:Resize(280, 600)
    no_check_delete:ShowWindow(1)
    local delete_slotset = delete_gb:CreateOrGetControl('slotset', 'delete_slotset', 0, 0, 0, 0)
    AUTO_CAST(delete_slotset)
    delete_slotset:SetSlotSize(40, 40)
    delete_slotset:EnablePop(0)
    delete_slotset:EnableDrag(1)
    delete_slotset:EnableDrop(1)
    delete_slotset:SetColRow(7, 15)
    delete_slotset:SetSpc(0, 0)
    delete_slotset:SetSkinName('slot')
    delete_slotset:CreateSlots()
    local slot_count = delete_slotset:GetSlotCount()
    local go_func = no_check_delete:CreateOrGetControl("button", "go_func", 0, 0, 100, 43)
    AUTO_CAST(go_func)
    go_func:SetText(g.lang == "Japanese" and "{ol}{s16}スタート" or "{ol}{s16}START")
    go_func:SetMargin(190, 645, 100, 0)
    go_func:SetSkinName("test_red_button")
    go_func:SetEventScript(ui.LBUTTONUP, "No_check_delete_item_msgbox")
    local stop_func = no_check_delete:CreateOrGetControl("button", "stop_func", 0, 0, 100, 43)
    AUTO_CAST(stop_func)
    stop_func:SetText(g.lang == "Japanese" and "{ol}{s16}ストップ" or "{ol}{s16}STOP")
    stop_func:SetMargin(10, 645, 100, 0)
    stop_func:SetSkinName("test_gray_button")
    stop_func:SetEventScript(ui.LBUTTONUP, "No_check_frame_close")
    INVENTORY_SET_CUSTOM_RBTNDOWN("No_check_inv_rbtn")
    g.no_check_iesids = {}
end

function No_check_delete_item_clear(parent, slot, iesid, num)
    CLEAR_SLOT_ITEM_INFO(slot)
    slot:SetSkinName('slot')
    slot:SetUserValue("DELETE_IDSID", "None")
    slot:SetUserValue("DELETE_NAME", "None")
    slot:SetUserValue("DELETE_COUNT", 0)
    g.no_check_iesids[iesid] = nil
    local inventory = ui.GetFrame("inventory")
    local inv_slot = INV_GET_SLOT_BY_ITEMGUID(iesid)
    if inv_slot then
        AUTO_CAST(inv_slot)
        inv_slot:Select(0)
        inv_slot:RunUpdateScript("No_check_inv_invalidate", 0.1)
        inv_slot:Invalidate()
    end
end

function No_check_delete_check(iesid, cls_id)
    if GetCraftState() == 1 then
        return false
    end
    if true == BEING_TRADING_STATE() then
        return false
    end
    local inventory = ui.GetFrame("inventory")
    local inv_item = session.GetInvItemByGuid(iesid)
    if not inv_item then
        return false
    end
    if true == inv_item.isLockState or true == IS_TEMP_LOCK(inventory, inv_item) then
        ui.SysMsg(ClMsg("MaterialItemIsLock"))
        return false
    end
    local item_cls = GetClassByType("Item", cls_id)
    if not item_cls then
        return false
    end
    local item_prop = geItemTable.IsDestroyable(cls_id)
    if item_cls.Destroyable == 'NO' or item_prop == false then
        local item_obj = GetIES(inv_item:GetObject())
        if item_obj.ItemLifeTimeOver == 0 then
            ui.AlarmMsg("ItemIsNotDestroy")
            return false
        end
    end
    return true
end

function No_check_delete_item_msgbox()
    local yes_scp = string.format("No_check_delete_item_reserve()")
    local msg = g.lang == "Japanese" and
                    "{ol}{#FF0000}本当にゴミ捨てを開始しますか？{nl}(リカバリーサービス対象外かも)" or
                    "{ol}{#FF0000}Are you sure you want to start trashing?{nl}(might not be covered by the{nl} recovery service)"
    ui.MsgBox(msg, yes_scp, "None")
end

function No_check_delete_item_reserve()
    local no_check_delete = ui.GetFrame(addon_name_lower .. "no_check_delete")
    No_check_delete_item(no_check_delete)
    no_check_delete:RunUpdateScript("No_check_delete_item", 0.5)
end

function No_check_delete_item(no_check_delete)
    if no_check_delete and no_check_delete:IsVisible() == 0 then
        return 0
    end
    local delete_slotset = GET_CHILD_RECURSIVELY(no_check_delete, "delete_slotset")
    AUTO_CAST(delete_slotset)
    local slot_count = delete_slotset:GetSlotCount()
    for i = 1, slot_count do
        local slot = GET_CHILD(delete_slotset, "slot" .. i)
        AUTO_CAST(slot)
        local icon = slot:GetIcon()
        if icon then
            local iesid = slot:GetUserValue("DELETE_IDSID")
            local name = slot:GetUserValue("DELETE_NAME")
            local count = slot:GetUserIValue("DELETE_COUNT")
            local trans_name = dic.getTranslatedStr(name)
            No_check_delete_item_execute(slot, iesid, trans_name, count)
            return 1
        end
    end
    No_check_frame_close(no_check_delete, delete_slotset)
    return 0
end

function No_check_delete_item_execute(slot, iesid, trans_name, count)
    IMC_LOG("INFO_NORMAL", "EXEC_DELETE_ITEMDROP")
    local pc = GetMyPCObject()
    local msg = g.lang == "Japanese" and "{ol}{#FFFF00}[" .. trans_name .. "]{/}{ol}{#FFFFFF}を" .. "{ol}{#FFFF00}[" ..
                    count .. "個]{/}" .. "{ol}{#FFFFFF}捨てました" or "{ol}{#FFFFFF}Discarded {/}" ..
                    "{ol}{#FFFF00}[" .. count .. "]{ol}{#FFFFFF} piece " .. "{ol}{#FFFF00}[" .. trans_name .. "]{/}"
    imcAddOn.BroadMsg("NOTICE_Dm_!", msg, 0.4)
    item.DropDelete(iesid, count)
    No_check_delete_item_clear(nil, slot, iesid, nil)
end
-- 連続使用とゴミ捨ての共通。インベントリマウス制御
function No_check_inv_rbtn(item_obj, slot)
    local icon = slot:GetIcon()
    local icon_info = icon:GetInfo()
    local no_check_use = ui.GetFrame(addon_name_lower .. "no_check_use")
    if no_check_use and no_check_use:IsVisible() == 1 then
        local clsid = icon_info.type
        local inv_item = session.GetInvItemByType(clsid)
        local item_slot = GET_CHILD(no_check_use, "item_slot")
        local item_cls = GetClassByType("Item", clsid)
        item_slot:SetUserValue("CLASS_ID", clsid)
        SET_SLOT_ITEM_CLS(item_slot, item_cls)
        SET_SLOT_ITEM_TEXT(item_slot, inv_item, item_cls)
        return
    end
    local no_check_delete = ui.GetFrame(addon_name_lower .. "no_check_delete")
    if no_check_delete and no_check_delete:IsVisible() == 1 then
        AUTO_CAST(no_check_delete)
        local iesid = icon_info:GetIESID()
        local inv_item = session.GetInvItemByGuid(iesid)
        local item_obj = GetIES(inv_item:GetObject())
        if g.no_check_iesids[iesid] then
            local msg = g.lang == "Japanese" and "{ol}既に登録されています" or "{ol}Already registered"
            ui.SysMsg(msg)
            return
        end
        if not No_check_delete_check(iesid, item_obj.ClassID) then
            return
        end
        local delete_slotset = GET_CHILD_RECURSIVELY(no_check_delete, "delete_slotset")
        AUTO_CAST(delete_slotset)
        local slot_count = delete_slotset:GetSlotCount()
        for i = 1, slot_count do
            local slot = GET_CHILD(delete_slotset, "slot" .. i)
            AUTO_CAST(slot)
            local icon = slot:GetIcon()
            if not icon then
                icon = CreateIcon(slot)
                slot:SetUserValue("DELETE_IDSID", iesid)
                slot:SetUserValue("DELETE_NAME", item_obj.Name)
                slot:SetUserValue("DELETE_COUNT", inv_item.count)
                g.no_check_iesids[iesid] = true
                SET_SLOT_ITEM_CLS(slot, item_obj)
                SET_SLOT_ITEM_TEXT(slot, inv_item, item_obj)
                SET_SLOT_STYLESET(slot, item_obj)
                SET_SLOT_IESID(slot, iesid)
                SET_SLOT_ICOR_CATEGORY(slot, item_obj)
                icon:SetTooltipArg("None", 0, iesid)
                SET_ITEM_TOOLTIP_TYPE(icon, item_obj.ClassID, item_obj, "None")
                SET_SLOT_ICOR_CATEGORY(slot, item_obj)
                slot:SetEventScript(ui.RBUTTONUP, "No_check_delete_item_clear")
                slot:SetEventScriptArgString(ui.RBUTTONUP, iesid)
                local inventory = ui.GetFrame("inventory")
                local inv_slot = INV_GET_SLOT_BY_ITEMGUID(iesid)
                if inv_slot then
                    AUTO_CAST(inv_slot)
                    inv_slot:SetSelectedImage('socket_slot_check')
                    inv_slot:Select(1)
                    inv_slot:RunUpdateScript("No_check_inv_invalidate", 0.1)
                    inv_slot:Invalidate()
                end
                return
            end
        end
    end
end

function No_check_frame_close(frame, ctrl)
    if frame:GetName() ~= "_nexus_addons" then
        ui.DestroyFrame(frame:GetName())
    end
    INVENTORY_SET_CUSTOM_RBTNDOWN('None')
    INVENTORY_CLEAR_SELECT(nil)
    if ctrl:GetName() == "delete_slotset" then
        ui.SysMsg("{ol}[No Check]End of Operation")
    end
end

function No_check_inv_invalidate(inv_slot)
    inv_slot:Invalidate()
end
-- 欠片アイテム他使用時のメッセージボックス非表示
function No_check_BEFORE_APPLIED_YESSCP_OPEN_BASIC_MSG(my_frame, my_msg)
    local inv_item = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        if not inv_item then
            return
        end
        local item_obj = GetIES(inv_item:GetObject())
        if not item_obj then
            return
        end
        local inventory = ui.GetFrame("inventory")
        inventory:SetUserValue("REQ_USE_ITEM_GUID", inv_item:GetIESID())
        REQUEST_SUMMON_BOSS_TX()
    else
        g.FUNCS["BEFORE_APPLIED_YESSCP_OPEN_BASIC_MSG"](inv_item)
    end
end
-- レジェンドカード装着時のメッセージボックス非表示
function No_check_CARD_SLOT_EQUIP(my_frame, my_msg)
    local slot, item, group_name_str = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        local item_obj = GetIES(item:GetObject())
        if item_obj.GroupName == "Card" then
            local slot_index = CARD_SLOT_GET_SLOT_INDEX(group_name_str, slot:GetSlotIndex())
            local card_info = equipcard.GetCardInfo(slot_index + 1)
            if card_info then
                ui.SysMsg(ClMsg("AlreadyEquippedThatCardSlot"))
                return
            end
            if item.isLockState == true then
                ui.SysMsg(ClMsg("MaterialItemIsLock"))
                return
            end
            local item_guid = item:GetIESID()
            local inventory = ui.GetFrame("inventory")
            inventory:SetUserValue("EQUIP_CARD_GUID", item_guid)
            inventory:SetUserValue("EQUIP_CARD_SLOTINDEX", slot_index)
            local pc_etc = GetMyEtcObject()
            if pc_etc.IS_LEGEND_CARD_OPEN ~= 1 and group_name_str == 'LEG' then
                ui.SysMsg(ClMsg("LegendCard_Slot_NotOpen"))
                return
            end
            REQUEST_EQUIP_CARD_TX()
        end
    else
        g.FUNCS["CARD_SLOT_EQUIP"](slot, item, group_name_str)
    end
end
-- レジェンドカード脱着時
function No_check_EQUIP_CARDSLOT_INFO_OPEN(my_frame, my_msg)
    local slot_index = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        slot_index = slot_index .. " 1"
        pc.ReqExecuteTx_NumArgs("SCR_TX_UNEQUIP_CARD_SLOT", slot_index)
    else
        g.FUNCS["EQUIP_CARDSLOT_INFO_OPEN"](slot_index)
    end
end
-- ゴッデスカード脱着時
function No_check_EQUIP_GODDESSCARDSLOT_INFO_OPEN(my_frame, my_msg)
    local slot_index = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        slot_index = slot_index .. " 1"
        pc.ReqExecuteTx_NumArgs("SCR_TX_UNEQUIP_CARD_SLOT", slot_index)
    else
        g.FUNCS["EQUIP_GODDESSCARDSLOT_INFO_OPEN"](slot_index)
    end
end
-- エーテルジェム着脱時のメッセージ非表示
function No_check_GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(my_frame, my_msg)
    local parent, btn = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        local frame = parent:GetTopParentFrame()
        local slot = GET_CHILD_RECURSIVELY(frame, 'socket_slot')
        local guid = slot:GetUserValue('ITEM_GUID')
        if guid ~= 'None' then
            local index = parent:GetUserValue('SLOT_INDEX')
            local inv_item = session.GetInvItemByGuid(guid)
            if not inv_item then
                return
            end
            local item_obj = GetIES(inv_item:GetObject())
            local item_name = dic.getTranslatedStr(TryGetProp(item_obj, 'Name', 'None'))
            local gem_id = inv_item:GetEquipGemID(index)
            local gem_cls = GetClassByType('Item', gem_id)
            local gem_numarg1 = TryGetProp(gem_cls, 'NumberArg1', 0)
            local price = gem_numarg1 * 100
            local clmsg = 'None'
            local msg_cls_name = ''
            if TryGetProp(gem_cls, 'GemType', 'None') == 'Gem_High_Color' then
                _GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(index)
            else
                local pc = GetMyPCObject()
                local is_gem_remove_care = IS_GEM_EXTRACT_FREE_CHECK(pc)
                local free_gem = nil
                for optionIdx = 1, 4 do
                    free_gem = GET_GEM_PROPERTY_TEXT(item_obj, optionIdx, index)
                    if free_gem then
                        _GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(index)
                        return
                    end
                end
                if is_gem_remove_care then
                    msg_cls_name = "ReallyRemoveGem_Care"
                else
                    msg_cls_name = "ReallyRemoveGem"
                end
                local clmsg = "'" .. item_name .. ScpArgMsg("Auto_'_SeonTaeg") .. ScpArgMsg(msg_cls_name)
                local yes_scp = string.format('_GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(%s)', index)
                local msgbox = ui.MsgBox(clmsg, yes_scp, '')
                SET_MODAL_MSGBOX(msgbox)
            end
        end
    else
        g.FUNCS["GODDESS_MGR_SOCKET_REQ_GEM_REMOVE"](parent, btn)
    end
end
-- ゴッデス装備帰属解除時の簡易化
function No_check_UNLOCK_TRANSMUTATIONSPREADER_BELONGING_SCROLL_EXEC_ASK_AGAIN(my_frame, my_msg)
    local frame, btn = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        local scroll_type = frame:GetUserValue("ScrollType")
        local clickable = frame:GetUserValue("EnableTranscendButton")
        if tonumber(clickable) ~= 1 then
            return
        end
        local slot = GET_CHILD(frame, "slot")
        local inv_item = GET_SLOT_ITEM(slot)
        if not inv_item then
            ui.MsgBox(ScpArgMsg("DropItemPlz"))
            imcSound.PlaySoundEvent(frame:GetUserConfig("TRANS_BTN_OVER_SOUND"))
            return
        end
        local item_obj = GetIES(inv_item:GetObject())
        local scroll_guid = frame:GetUserValue("ScrollGuid")
        local scroll_inv_item = session.GetInvItemByGuid(scroll_guid)
        if not scroll_inv_item then
            return
        end
        UNLOCK_TRANSMUTATIONSPREADER_BELONGING_SCROLL_EXEC()
    else
        g.FUNCS["UNLOCK_TRANSMUTATIONSPREADER_BELONGING_SCROLL_EXEC_ASK_AGAIN"](frame, btn)
    end
end
-- ゴッデスアクセ帰属解除時の簡易化
function No_check_UNLOCK_ACC_BELONGING_SCROLL_EXEC_ASK_AGAIN(my_frame, my_msg)
    local frame, btn = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        local scroll_type = frame:GetUserValue("ScrollType")
        local clickable = frame:GetUserValue("EnableTranscendButton")
        if tonumber(clickable) ~= 1 then
            return
        end
        local slot = GET_CHILD(frame, "slot")
        local inv_item = GET_SLOT_ITEM(slot)
        if not inv_item then
            ui.MsgBox(ScpArgMsg("DropItemPlz"))
            imcSound.PlaySoundEvent(frame:GetUserConfig("TRANS_BTN_OVER_SOUND"))
            return
        end
        local item_obj = GetIES(inv_item:GetObject())
        local scroll_guid = frame:GetUserValue("ScrollGuid")
        local scroll_inv_item = session.GetInvItemByGuid(scroll_guid)
        if not scroll_inv_item then
            return
        end
        UNLOCK_ACC_BELONGING_SCROLL_EXEC()
    else
        g.FUNCS["UNLOCK_ACC_BELONGING_SCROLL_EXEC_ASK_AGAIN"](frame, btn)
    end
end
-- チャンネル移動時の確認を削除
function No_check_SELECT_ZONE_MOVE_CHANNEL(my_frame, my_msg)
    local index, channel_id = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        local zone_insts = session.serverState.GetMap()
        if not zone_insts or zone_insts.pcCount == -1 then
            ui.SysMsg(ClMsg("ChannelIsClosed"))
            return
        end
        local pc = GetMyPCObject()
        if IS_BOUNTY_BATTLE_BUFF_APPLIED(pc) == 1 then
            ui.SysMsg(ClMsg("DoingBountyBattle"))
            return
        end
        if IS_JUMP_MAP_BUFF_APPLIED(pc) == 1 then
            return
        end
        RUN_GAMEEXIT_TIMER("Channel", channel_id)
    else
        g.FUNCS["SELECT_ZONE_MOVE_CHANNEL"](index, channel_id)
    end
end
-- カードブック使用時の確認削除
function No_check_BEFORE_APPLIED_NON_EQUIP_ITEM_OPEN(my_frame, my_msg)
    local inv_item = g.get_event_args(my_msg)
    if g.settings.no_check.use == 1 then
        if not inv_item then
            return
        end
        local inventory = ui.GetFrame("inventory")
        local item_obj = GetIES(inv_item:GetObject())
        if not item_obj then
            return
        end
        inventory:SetUserValue("REQ_USE_ITEM_GUID", inv_item:GetIESID())
        if item_obj.Script == 'SCR_SUMMON_MONSTER_FROM_CARDBOOK' then
            REQUEST_SUMMON_BOSS_TX()
        elseif item_obj.Script == 'SCR_QUEST_CLEAR_LEGEND_CARD_LIFT' then
            local textmsg = string.format("[ %s ]{nl}%s", item_obj.Name, ScpArgMsg("Use_Item_LegendCard_Slot_Open2"))
            ui.MsgBox_NonNested(textmsg, item_obj.Name, "REQUEST_SUMMON_BOSS_TX", "None")
            return
        end
    else
        g.FUNCS["BEFORE_APPLIED_NON_EQUIP_ITEM_OPEN"](inv_item)
    end
end

function No_check_timer_update(_nexus_addons, no_check_timer)
    if g.settings.no_check.use == 0 then
        return 0
    end
    No_check_WARNINGMSGBOX_FRAME_OPEN()
    No_check_WARNINGMSGBOX_EX_FRAME_OPEN()
    return 1
end
-- warning_boxs制御
function No_check_WARNINGMSGBOX_FRAME_OPEN()
    local warningmsgbox = ui.GetFrame("warningmsgbox")
    if warningmsgbox:IsVisible() == 0 then
        return
    end
    local warningtext = GET_CHILD_RECURSIVELY(warningmsgbox, "warningtext")
    local msg = ClMsg("destory_now")
    msg = dictionary.ReplaceDicIDInCompStr(msg)
    if string.find(warningtext:GetText(), msg) then
        local input = GET_CHILD_RECURSIVELY(warningmsgbox, "input")
        input:SetText(msg)
    end
end

function No_check_WARNINGMSGBOX_EX_FRAME_OPEN()
    local warningmsgbox_ex = ui.GetFrame('warningmsgbox_ex')
    if warningmsgbox_ex:IsVisible() == 0 then
        return
    end
    local compareText = GET_CHILD_RECURSIVELY(warningmsgbox_ex, "comparetext")
    local start, finish = string.find(compareText:GetText(), "nl%}%[")
    if start and finish then
        local next_sub_string = compareText:GetText():sub(finish + 1)
        local next_start, next_finish = string.find(next_sub_string, "%]")
        if next_start and next_finish then
            local desiredText = next_sub_string:sub(1, next_start - 1)
            local input = GET_CHILD_RECURSIVELY(warningmsgbox_ex, "input")
            input:SetText(desiredText)
        end
    end
end
-- 連続金床強化
function No_check_MORU_LBTN_CLICK(my_frame, my_msg)
    if g.settings.no_check.use == 0 then
        return
    end
    No_check_REINFORCE_131014_MSGBOX()
end

function No_check_REINFORCE_131014_MSGBOX()
    local reinforce_131014 = ui.GetFrame("reinforce_131014")
    local from_item, from_moru = GET_REINFORCE_TARGET_AND_MORU(reinforce_131014)
    local from_item_obj = GetIES(from_item:GetObject())
    local moru_obj = GetIES(from_moru:GetObject())
    local exec = GET_CHILD_RECURSIVELY(reinforce_131014, "exec")
    local skipOver5 = GET_CHILD_RECURSIVELY(reinforce_131014, "skipOver5")
    skipOver5:SetCheck(1)
    exec:ShowWindow(0)
    No_check_REINFORCE_131014_EXEC(reinforce_131014, from_item, from_moru)
end

function No_check_REINFORCE_131014_EXEC(reinforce_131014)
    if reinforce_131014:IsVisible() == 0 then
        reinforce_131014:StopUpdateScript("No_check_REINFORCE_131014_EXEC")
        return 0
    end
    local from_item, from_moru = GET_REINFORCE_TARGET_AND_MORU(reinforce_131014)
    if from_item and from_moru ~= nil and reinforce_131014:IsVisible() == 1 then
        session.ResetItemList()
        session.AddItemID(from_item:GetIESID())
        session.AddItemID(from_moru:GetIESID())
        local resultlist = session.GetItemIDList()
        item.DialogTransaction("ITEM_REINFORCE_131014", resultlist)
        reinforce_131014:RunUpdateScript("No_check_REINFORCE_131014_EXEC", 0.3)
    end
    REINFORCE_131014_UPDATE_MORU_COUNT(reinforce_131014)
    return 1
end
-- no_check ここまで

-- monster_kill_count ここから 
function Monster_kill_count_save_settings()
    g.save_json(g.mkc_path, g.mkc_settings)
end

function Monster_kill_count_load_settings()
    g.mkc_path = string.format("../addons/%s/%s/monster_kill_count.json", addon_name_lower, g.active_id)
    g.mkc_old_path = string.format("../addons/%s/%s/settings.json", "klcount", g.active_id)
    local settings = g.load_json(g.mkc_path)
    if settings then
        g.mkc_settings = settings
        return
    end
    local allowed_map_ids_by_level = {}
    local map_list, cnt = GetClassList("Map")
    for i = 0, cnt - 1 do
        local map_cls = GetClassByIndexFromList(map_list, i)
        if map_cls then
            local map_level = map_cls.QuestLevel
            local my_level = info.GetLevel(session.GetMyHandle())
            if math.abs(my_level - map_level) <= 50 or map_cls.ClassID == 11244 then
                allowed_map_ids_by_level[tostring(map_cls.ClassID)] = true
            end
        end
    end
    local old_settings = g.load_json(g.mkc_old_path)
    local final_map_ids = {}
    if old_settings then
        settings = {
            frame_x = old_settings.frame_x or 1340,
            frame_y = old_settings.frame_y or 20,
            map_ids = {}
        }
        local old_dir = string.format("../addons/%s/%s/", "klcount", g.active_id)
        local new_folder_path = string.format("../addons/%s/%s/%s", addon_name_lower, g.active_id, "monster_kill_count")
        os.execute('mkdir "' .. new_folder_path .. '"')
        for map_id, _ in pairs(allowed_map_ids_by_level) do
            local old_file_path = old_dir .. map_id .. ".json"
            local new_file_path = new_folder_path .. "/" .. map_id .. ".json"
            local old_file = io.open(old_file_path, "r")
            if old_file then
                local content = old_file:read("*a")
                old_file:close()
                if content and content ~= "" and pcall(json.decode, content) then
                    local new_file = io.open(new_file_path, "w")
                    if new_file then
                        new_file:write(content)
                        new_file:close()
                        table.insert(final_map_ids, tonumber(map_id))
                    end
                end
            end
        end
    else
        settings = {
            frame_x = 1340,
            frame_y = 20,
            map_ids = {}
        }
    end
    local folder_path = string.format("../addons/%s/%s/%s", addon_name_lower, g.active_id, "monster_kill_count")
    local win_folder_path = string.gsub(folder_path, "/", "\\")
    local list_file_path = folder_path .. "/filelist_temp.txt"
    os.execute('dir "' .. win_folder_path .. '\\*.json" /b > "' .. list_file_path .. '"')
    local list_file = io.open(list_file_path, "r")
    if list_file then
        for line in list_file:lines() do
            local map_id = string.match(line, "(%d+)%.json")
            local file_path = folder_path .. "/" .. map_id .. ".json"
            local file = io.open(file_path, "r")
            if file then
                local content = file:read("*a")
                file:close()
                if content and content ~= "" and pcall(json.decode, content) then
                    local is_new = true
                    for _, existing_id in pairs(final_map_ids) do
                        if tostring(existing_id) == map_id then
                            is_new = false
                            break
                        end
                    end
                    if is_new then
                        if is_new and allowed_map_ids_by_level[map_id] then
                            table.insert(final_map_ids, map_id)
                            ts("Found orphan file, adding to list: " .. map_id)
                        end
                    end
                else
                    ts("Broken JSON removed: " .. tostring(map_id))
                    os.remove(file_path)
                end
            end
        end
        list_file:close()
    end
    os.remove(list_file_path)
    settings.map_ids = final_map_ids
    g.mkc_settings = settings
    Monster_kill_count_save_settings()
end

function monster_kill_count_on_init()
    if not g.mkc_settings then
        Monster_kill_count_load_settings()
    end
    local old_func = g.settings.monster_kill_count.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, "APPLY_SCREEN", "Monster_kill_count_APPLY_SCREEN", true)
    if g.get_map_type() == "Field" or g.get_map_type() == "Dungeon" then
        local map_cls = GetClass("Map", g.map_name)
        local map_level = map_cls.QuestLevel
        local my_level = info.GetLevel(session.GetMyHandle())
        if my_level - map_level <= 50 or g.map_id == 11244 then
            local colony_list, cnt = GetClassList("guild_colony")
            for i = 0, cnt - 1 do
                local check_word = "GuildColony_"
                if string.find(g.map_name, check_word) then
                    return
                end
            end
            local list = session.party.GetPartyMemberList(PARTY_NORMAL)
            local count = list:Count()
            for i = 0, count - 1 do
                local party_member_info = list:Element(i)
                local name = party_member_info:GetName()
                local channel = party_member_info:GetChannel() + 1
                if channel > 10 then
                    return
                end
            end
            g.addon:RegisterMsg("EXP_UPDATE", "Monster_kill_count_EXP_UPDATE")
            g.addon:RegisterMsg("ITEM_PICK", "Monster_kill_count_ITEM_PICK")
            g.addon:RegisterMsg("UI_CHALLENGE_MODE_TOTAL_KILL_COUNT",
                "Monster_kill_count_ON_CHALLENGE_MODE_TOTAL_KILL_COUNT")
            g.mkc_autosave_counter = 0
            if not g.mkc_map_id then
                g.mkc_map_id = g.map_id
                g.mkc_count = 0
                g.mkc_start_time = imcTime.GetAppTimeMS() - 3000
                g.mkc_last_tick_ms = g.mkc_start_time
            elseif g.mkc_map_id ~= g.map_id then
                local map_file_path = Monster_kill_count_get_map_filepath(g.mkc_map_id)
                local map_data = g.load_json(map_file_path)
                if map_data then
                    g.save_json(map_file_path, map_data)
                end
                g.mkc_count = 0
                g.mkc_start_time = imcTime.GetAppTimeMS() - 3000
                g.mkc_last_tick_ms = g.mkc_start_time
                g.mkc_map_id = g.map_id
            end
            local map_file_path = Monster_kill_count_get_map_filepath(g.map_id)
            local map_data = g.load_json(map_file_path)
            if not map_data then
                map_data = {
                    map_name = g.map_name,
                    stay_time = 3000,
                    kill_count = 0,
                    get_items = {}
                }
            end
            g.mkc_map_data = map_data
            g.save_json(map_file_path, map_data)
            Monster_kill_count_frame_init()
        end
    else
        if g.mkc_map_id then
            local map_file_path = Monster_kill_count_get_map_filepath(g.mkc_map_id)
            local map_data = g.load_json(map_file_path)
            if map_data then
                g.save_json(map_file_path, map_data)
            end
            g.mkc_map_id = nil
            g.mkc_count = nil
            g.mkc_start_time = nil
            ui.DestroyFrame(addon_name_lower .. "monster_kill_count")
            local _nexus_addons = ui.GetFrame("_nexus_addons")
            _nexus_addons:RemoveChild("monster_kill_count_timer")
        end
    end
end

function Monster_kill_count_ON_CHALLENGE_MODE_TOTAL_KILL_COUNT(frame, msg)
    ui.DestroyFrame(addon_name_lower .. "monster_kill_count")
end

function Monster_kill_count_get_map_filepath(map_id)
    return string.format("../addons/%s/%s/%s/%s.json", addon_name_lower, g.active_id, "monster_kill_count", map_id)
end

function Monster_kill_count_APPLY_SCREEN(my_frame, my_msg)
    Monster_kill_count_frame_init()
end

function Monster_kill_count_EXP_UPDATE(frame, msg)
    local monster_kill_count = ui.GetFrame(addon_name_lower .. "monster_kill_count")
    local count_text = GET_CHILD(monster_kill_count, "count_text")
    AUTO_CAST(count_text)
    g.mkc_count = g.mkc_count + 1
    count_text:SetText(string.format("{ol}{s16}Count : %d{/}", g.mkc_count))
    g.mkc_map_data.kill_count = g.mkc_map_data.kill_count + 1
end

function Monster_kill_count_ITEM_PICK(frame, msg, class_id, item_count)
    local cls_id = tonumber(class_id)
    if cls_id then
        cls_id = math.floor(cls_id)
        local cls_id_str = tostring(cls_id)
        g.mkc_map_data.get_items = g.mkc_map_data.get_items or {}
        if not g.mkc_map_data.get_items[cls_id_str] then
            g.mkc_map_data.get_items[cls_id_str] = item_count
        else
            g.mkc_map_data.get_items[cls_id_str] = g.mkc_map_data.get_items[cls_id_str] + item_count
        end
    end
end

function Monster_kill_count_frame_init()
    local monster_kill_count =
        ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "monster_kill_count", 0, 0, 0, 0)
    AUTO_CAST(monster_kill_count)
    monster_kill_count:SetSkinName("shadow_box")
    monster_kill_count:SetTitleBarSkin("None")
    monster_kill_count:EnableHitTest(1)
    monster_kill_count:EnableMove(1)
    monster_kill_count:SetAlpha(80)
    monster_kill_count:SetLayerLevel(31)
    monster_kill_count:SetEventScript(ui.LBUTTONUP, "Monster_kill_count_pos")
    local map_frame = ui.GetFrame("map")
    local width = map_frame:GetWidth()
    local x = g.mkc_settings.frame_x
    if g.mkc_settings.frame_x > 1920 and width <= 1920 then
        local offset = g.mkc_settings.frame_x - 1920
        x = 1920 - offset
    end
    monster_kill_count:SetPos(x, g.mkc_settings.frame_y)
    local count_text = monster_kill_count:CreateOrGetControl("richtext", "count_text", 10, 10, 170, 30)
    AUTO_CAST(count_text)
    count_text:SetText(string.format("{ol}{s16}Count : %d{/}", g.mkc_count or 0))
    local map_name = GetClassByType("Map", g.map_id).Name
    local map_text = monster_kill_count:CreateOrGetControl("richtext", "map_text", 10, 35, 170, 30)
    AUTO_CAST(map_text)
    map_text:SetText(string.format("{ol}{s16}%s{/}", map_name))
    local w = 170
    if map_text:GetWidth() + 15 > 170 then
        w = map_text:GetWidth() + 15
    end
    local timer_text = monster_kill_count:CreateOrGetControl("richtext", "timer_text", 90, 60, 200, 30)
    AUTO_CAST(timer_text)
    timer_text:SetGravity(ui.RIGHT, ui.BOTTOM)
    local rect = timer_text:GetMargin()
    timer_text:SetMargin(rect.left, rect.top, rect.right + 15, rect.bottom + 15)
    monster_kill_count:Resize(w, 95)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local monster_kill_count_timer = _nexus_addons:CreateOrGetControl("timer", "monster_kill_count_timer", 0, 0)
    AUTO_CAST(monster_kill_count_timer)
    monster_kill_count_timer:SetUpdateScript("Monster_kill_count_time_update")
    monster_kill_count_timer:Start(1.0)
end

function Monster_kill_count_time_update(_nexus_addons)
    local monster_kill_count = ui.GetFrame(addon_name_lower .. "monster_kill_count")
    if g.settings.monster_kill_count.use == 1 then
        monster_kill_count:ShowWindow(1)
    else
        ui.DestroyFrame(addon_name_lower .. "monster_kill_count")
    end
    local now_ms = imcTime.GetAppTimeMS()
    g.mkc_diff_ms = now_ms - g.mkc_start_time
    local total_sec = math.floor(g.mkc_diff_ms / 1000)
    local h = math.floor(total_sec / 3600)
    local m = math.floor((total_sec % 3600) / 60)
    local s = (total_sec % 60)
    local timer_text = GET_CHILD(monster_kill_count, "timer_text")
    AUTO_CAST(timer_text)
    timer_text:SetText(string.format("{ol}{s16}%02d:%02d:%02d{/}", h, m, s))
    g.mkc_autosave_counter = g.mkc_autosave_counter + 1
    local delta_ms = now_ms - g.mkc_last_tick_ms
    if delta_ms < 0 then
        delta_ms = 0
    end
    g.mkc_last_tick_ms = now_ms
    g.mkc_map_data.stay_time = g.mkc_map_data.stay_time + delta_ms
    if g.mkc_autosave_counter >= 60 then
        local map_file_path = string.format("../addons/%s/%s/%s/%s.json", addon_name_lower, g.active_id,
            "monster_kill_count", g.map_id)
        g.save_json(map_file_path, g.mkc_map_data)
        g.mkc_autosave_counter = 0
    end
end

function Monster_kill_count_pos(monster_kill_count)
    g.mkc_settings.frame_x = monster_kill_count:GetX()
    g.mkc_settings.frame_y = monster_kill_count:GetY()
    Monster_kill_count_save_settings()
end

function Monster_kill_count_information_context()
    local context = ui.CreateContextMenu("monster_kill_count_context", "{ol}Map Info", 0, 0, 200, 0)
    local sorted_map_ids = {}
    for _, map_id in ipairs(g.mkc_settings.map_ids) do
        table.insert(sorted_map_ids, tonumber(map_id))
    end
    table.sort(sorted_map_ids, function(a, b)
        return a < b
    end)
    for i = 1, #sorted_map_ids do
        local map_id = sorted_map_ids[i]
        local map_id_str = tostring(map_id)
        local map_file_path = Monster_kill_count_get_map_filepath(map_id_str)
        local map_data = g.load_json(map_file_path)
        if not map_data or not next(map_data.get_items) then
            local map_cls = GetClassByType("Map", map_id)
            map_data = {
                map_name = map_cls and map_cls.ClassName,
                stay_time = 0,
                kill_count = 0,
                get_items = {}
            }
            g.save_json(map_file_path, map_data)
        else
            local display_text = map_id .. " " .. GetClassByType("Map", map_id).Name
            ui.AddContextMenuItem(context, display_text, string.format("Monster_kill_count_map_information(%d)", map_id))
        end
    end
    ui.OpenContextMenu(context)
end

function Monster_kill_count_map_information_close(map_info)
    if map_info then
        ui.DestroyFrame(map_info:GetName())
    end
end

function Monster_kill_count_map_information(map_id)
    local map_file_path = Monster_kill_count_get_map_filepath(map_id)
    local map_data = g.load_json(map_file_path)
    local frame_name = addon_name_lower .. "mkc_map_info"
    local map_info = ui.CreateNewFrame("notice_on_pc", frame_name, 0, 0, 0, 0)
    AUTO_CAST(map_info)
    map_info:SetPos(1000, 30)
    map_info:SetSkinName("test_frame_low")
    local close_btn = map_info:CreateOrGetControl("button", "close_button", 0, 0, 30, 30)
    AUTO_CAST(close_btn)
    close_btn:SetImage("testclose_button")
    close_btn:SetGravity(ui.RIGHT, ui.TOP)
    close_btn:SetEventScript(ui.LBUTTONUP, "Monster_kill_count_map_information_close")
    local map_name_label = map_info:CreateOrGetControl("richtext", "map_name_text", 20, 10, 50, 20)
    AUTO_CAST(map_name_label)
    map_name_label:SetText("{ol}" .. GetClassByType("Map", map_id).Name)
    local info_box = map_info:CreateOrGetControl("groupbox", "info_gbox", 10, 40, 0, 0)
    AUTO_CAST(info_box)
    info_box:RemoveAllChild()
    info_box:SetSkinName("bg")
    local total_sec = (map_data.stay_time or 0) / 1000
    local h = math.floor(total_sec / 3600)
    local m = math.floor((total_sec % 3600) / 60)
    local s = math.floor(total_sec % 60)
    local kill_count_val = map_data.kill_count or 0
    local stay_label = info_box:CreateOrGetControl("richtext", "stay_time", 10, 10, 50, 20)
    AUTO_CAST(stay_label)
    stay_label:SetText(string.format("{ol}%s : %02d:%02d:%02d", g.lang == "Japanese" and "滞在時間" or "Stay Time",
        h, m, s))
    local kill_label = info_box:CreateOrGetControl("richtext", "kill_count", 10, 35, 50, 20)
    AUTO_CAST(kill_label)
    kill_label:SetText(
        string.format("{ol}%s : %d", g.lang == "Japanese" and "討伐数" or "Kill Count", kill_count_val))
    local kill_per_hour_label = info_box:CreateOrGetControl("richtext", "kill_count_hour", kill_label:GetWidth() + 20,
        35, 50, 20)
    AUTO_CAST(kill_per_hour_label)
    if total_sec > 0 then
        local kills_ph_val = math.floor(kill_count_val / total_sec * 3600)
        kill_per_hour_label:SetText(string.format("{ol}(%s %d %s)", total_sec >= 3600 and "実績" or "予測",
            kills_ph_val, "体/時"))
    else
        kill_per_hour_label:SetText("{ol}(N/A)")
    end
    local item_keys = {}
    local total_item_num = 0
    if map_data.get_items then
        for item_id_str, count_val in pairs(map_data.get_items) do
            table.insert(item_keys, tonumber(item_id_str))
            total_item_num = total_item_num + count_val
        end
    end
    table.sort(item_keys)
    local total_items_label = info_box:CreateOrGetControl("richtext", "total_items_text", 10, 60, 50, 20)
    AUTO_CAST(total_items_label)
    total_items_label:SetText(string.format("{ol}%s : %d",
        g.lang == "Japanese" and "総獲得アイテム数" or "Total Items", total_item_num))
    local current_y = 0
    local max_x = 0
    for _, item_id_num in ipairs(item_keys) do
        local item_id_str_key = tostring(item_id_num)
        local item_cls = GetClassByType("Item", item_id_num)
        if item_cls and map_data.get_items[item_id_str_key] then
            local item_get_count = map_data.get_items[item_id_str_key]
            local item_disp_str1 = string.format("{ol}{img %s 24 24}  %s : %d %s", item_cls.Icon, item_cls.Name,
                item_get_count, g.lang == "Japanese" and "個" or "pcs")
            local item_label1 = info_box:CreateOrGetControl("richtext", "display_text" .. item_id_str_key, 10,
                95 + current_y, 50, 20)
            AUTO_CAST(item_label1)
            item_label1:SetText(item_disp_str1)
            max_x = math.max(max_x, item_label1:GetWidth() + 10)
            local kc_percent = kill_count_val > 0 and item_get_count / kill_count_val * 100 or 0
            local ti_percent = total_item_num > 0 and item_get_count / total_item_num * 100 or 0
            local sec_per_item = item_get_count > 0 and total_sec / item_get_count or 0
            local item_disp_str2 = string.format("        %.1f%% (%s)   %.1f%% (%s)   %.1f %s", kc_percent, "対討伐",
                ti_percent, "対総数", sec_per_item, "秒/個")
            local item_label2 = info_box:CreateOrGetControl("richtext", "display_text2" .. item_id_str_key, 10,
                120 + current_y, 50, 20)
            AUTO_CAST(item_label2)
            item_label2:SetText("{ol}" .. item_disp_str2)
            max_x = math.max(max_x, item_label2:GetWidth() + 10)
            current_y = current_y + 55
        end
    end
    local reset_btn = map_info:CreateOrGetControl("button", "reset_button", map_name_label:GetWidth() + 30, 5, 80, 30)
    AUTO_CAST(reset_btn)
    reset_btn:SetSkinName("test_red_button")
    reset_btn:SetText("{ol}Map Reset")
    reset_btn:SetEventScript(ui.LBUTTONUP, "Monster_kill_count_map_reset_reserve")
    reset_btn:SetEventScriptArgNumber(ui.LBUTTONUP, map_id)
    map_info:Resize(math.max(max_x + 40, 250), math.min(160 + current_y, 1000))
    info_box:Resize(map_info:GetWidth() - 20, map_info:GetHeight() - 55)
    map_info:SetLayerLevel(999)
    map_info:ShowWindow(1)
end

function Monster_kill_count_map_reset_reserve(frame, ctrl, str, map_id)
    ui.MsgBox("Map Reset?", string.format("Monster_kill_count_map_reset(%d)", map_id), "None")
end

function Monster_kill_count_map_reset(map_id)
    local map_file_path = Monster_kill_count_get_map_filepath(map_id)
    os.remove(map_file_path)
    local map_info = ui.GetFrame(addon_name_lower .. "mkc_map_info")
    Monster_kill_count_map_information_close(map_info)
end
-- monster_kill_count ここまで

-- quickslot_operate ここから
g.quickslot_operate_raid_list = {
    Paramune = {623, 667, 666, 665, 674, 673, 675, 680, 679, 681, 707, 708, 710, 711, 709, 712, 722, 723, 724, 725, 726,
                727},
    Klaida = {686, 685, 687, 716, 717, 718},
    Velnias = {689, 688, 690, 669, 635, 628, 696, 695, 697},
    Forester = {672, 671, 670},
    Widling = {677, 676, 678, 729, 730}
}
g.quickslot_operate_zone_list = {11208, 11230, 11250, 11252, 11256, 11257, 11261, 11263, 11266, 11267, 11270, 11276,
                                 11277, 11278, 11285, 11286}
-- 11267=ドラグーン 11257=バウバス 11290=アシャーク
g.quickslot_guild_eventmap = {11267, 11257, 11290, 11285, 11286}
g.quickslot_operate_atk_list = {
    Velnias = {640504, 640368},
    Klaida = {640503, 640370},
    Paramune = {640502, 640369},
    Widling = {640501, 640372},
    Forester = {640500, 640371}
}
g.quickslot_operate_def_list = {
    Velnias = 640373,
    Klaida = 640375,
    Paramune = 640374,
    Widling = 640377,
    Forester = 640376
}
function Quickslot_operate_save_settings()
    g.save_json(g.quickslot_operate_path, g.quickslot_operate_settings)
end

function Quickslot_operate_load_settings()
    g.quickslot_operate_path = string.format("../addons/%s/%s/quickslot_operate.json", addon_name_lower, g.active_id)
    g.quickslot_operate_old_path = string.format("../addons/%s/%s/settings_250609.json", "quickslot_operate",
        g.active_id)
    local ver = 1.1
    local settings = g.load_json(g.quickslot_operate_path)

    if not settings then
        local old_settings = g.load_json(g.quickslot_operate_old_path)
        if old_settings then
            settings = old_settings
        else
            settings = {
                slotset = {},
                straight = false,
                rshift = false
            }
        end
        settings.ver = ver
    end
    if not settings.ver or settings.ver < ver then
        settings.ver = ver
    end
    g.quickslot_operate_settings = settings
    Quickslot_operate_save_settings()
end

function quickslot_operate_on_init()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    if not g.quickslot_operate_settings then
        _nexus_addons:RunUpdateScript("Quickslot_operate_lazy_start", 0.1)
        return
    end
    if g.settings.quickslot_operate.use == 0 then
        local quickslot_operate_map_timer = GET_CHILD(_nexus_addons, "quickslot_operate_map_timer")
        if _nexus_addons then
            _nexus_addons:RemoveChild("quickslot_operate_map_timer")
            _nexus_addons:RemoveChild("quickslot_operate_timer")
        end
        local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
        if quickslotnexpbar then
            quickslotnexpbar:RemoveChild("setting")
            if g.quickslot_operate_settings and g.quickslot_operate_settings.straight then
                g.quickslot_operate_settings.straight = false
                Quickslot_operate_redraw_slots()
            end
            quickslotnexpbar:SetUserValue("USE", 0)
            quickslotnexpbar:RunUpdateScript("Quickslot_operate_set_script", 2.0)
        end
        return
    end
    Quickslot_operate_init_logic()
end

function Quickslot_operate_lazy_start(frame)
    if not g.quickslot_operate_settings then
        Quickslot_operate_load_settings()
    end
    local old_func = g.settings.quickslot_operate.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.quickslot_operate.use == 1 then
        Quickslot_operate_init_logic()
    end
    return 0
end

function Quickslot_operate_init_logic()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:SetVisible(1)
    g.setup_hook_and_event(g.addon, "SHOW_INDUNENTER_DIALOG", "Quickslot_operate_SHOW_INDUNENTER_DIALOG", true)
    Quickslot_operate_frame_init()
    local quickslot_operate_map_timer = _nexus_addons:CreateOrGetControl("timer", "quickslot_operate_map_timer", 0, 0)
    AUTO_CAST(quickslot_operate_map_timer)
    quickslot_operate_map_timer:SetUpdateScript("Quickslot_operate_map_change")
    quickslot_operate_map_timer:Stop()
    quickslot_operate_map_timer:Start(3.0)
    if g.quickslot_operate_settings.rshift then
        local quickslot_operate_timer = _nexus_addons:CreateOrGetControl("timer", "quickslot_operate_timer", 0, 0)
        AUTO_CAST(quickslot_operate_timer)
        quickslot_operate_timer:SetUpdateScript("Quickslot_operate_set_rshift_script")
        quickslot_operate_timer:Start(0.15)
    end
end

function Quickslot_operate_frame_init()
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    local setting = quickslotnexpbar:CreateOrGetControl("button", "setting", 0, 0, 30, 20)
    AUTO_CAST(setting)
    setting:SetMargin(-260, 0, 0, 55)
    setting:SetText("{ol}{s11}QSO")
    setting:SetGravity(ui.CENTER_HORZ, ui.BOTTOM)
    setting:SetTextTooltip(g.lang == "Japanese" and
                               "{ol}左クリック: スロットセット読込{nl}右クリック: 各種設定" or
                               "{ol}Left-click: Load Slot Set{nl}Right-click: Settings")
    setting:SetEventScript(ui.RBUTTONUP, "Quickslot_operate_context")
    setting:SetEventScript(ui.LBUTTONUP, "Quickslot_operate_load_slotset_context")
    Quickslot_operate_redraw_slots()
    quickslotnexpbar:SetUserValue("USE", 1)
    quickslotnexpbar:RunUpdateScript("Quickslot_operate_set_script", 2.0)
end

function Quickslot_operate_context()
    local context = ui.CreateContextMenu("CONTEXT", "{ol}slotset context", 0, -300, 0, 0)
    ui.AddContextMenuItem(context, "-----", "None")
    ui.AddContextMenuItem(context,
        g.lang == "Japanese" and "{ol}スロットレイアウト保存" or "{ol}Save Slot layout",
        "Quickslot_operate_save_slotset()")
    ui.AddContextMenuItem(context,
        g.lang == "Japanese" and "{ol}スロットレイアウト削除" or "{ol}Delete Slot layout",
        "Quickslot_operate_delete_slotset()")
    ui.AddContextMenuItem(context, "------", "None")
    if g.quickslot_operate_settings.rshift then
        ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}RSHIFT {#FF0000}ON {#FFFF00}OFFにする" or
            "{ol}RSHIFT {#FF0000}ON {#FFFF00}Turn OFF", "Quickslot_operate_switch_rshift()")
    else
        ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}RSHIFT {#FF0000}OFF {#FFFF00}ONにする" or
            "{ol}RSHIFT {#FF0000}OFF {#FFFF00}Turn ON", "Quickslot_operate_switch_rshift()")
    end
    ui.AddContextMenuItem(context, "-------", "None")
    ui.AddContextMenuItem(context,
        g.lang == "Japanese" and "{ol}ストレートモード切替" or "{ol}Switch straight mode",
        "Quickslot_operate_straight()")
    ui.OpenContextMenu(context)
end

function Quickslot_operate_redraw_slots()
    local qso_settings = g.quickslot_operate_settings
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    local margin, margin_2, margin_3
    if qso_settings.straight then
        margin, margin_2, margin_3 = -200, -200, -200
    else
        margin, margin_2, margin_3 = -225, -250, -225
    end
    for i = 11, MAX_QUICKSLOT_CNT do
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. i)
        AUTO_CAST(slot)
        if i <= 20 then
            slot:SetMargin(margin, 230, 0, 0)
            margin = margin + 50
        elseif i <= 30 then
            slot:SetMargin(margin_2, 180, 0, 0)
            margin_2 = margin_2 + 50
        elseif i <= 40 then
            slot:SetMargin(margin_3, 130, 0, 0)
            margin_3 = margin_3 + 50
        end
    end
    quickslotnexpbar:Invalidate()
    DebounceScript("QUICKSLOTNEXTBAR_UPDATE_ALL_SLOT", 0.1)
end

function Quickslot_operate_straight()
    g.quickslot_operate_settings.straight = not g.quickslot_operate_settings.straight
    Quickslot_operate_save_settings()
    Quickslot_operate_redraw_slots()
end

function Quickslot_operate_save_slotset()
    if not g.quickslot_operate_settings.slotset[g.login_name] then
        g.quickslot_operate_settings.slotset[g.login_name] = {}
    end
    Quickslot_operate_INPUT_STRING_BOX()
end

function Quickslot_operate_INPUT_STRING_BOX()
    local inputstring = ui.GetFrame("inputstring")
    inputstring:Resize(500, 220)
    inputstring:SetLayerLevel(999)
    local edit = GET_CHILD(inputstring, 'input')
    AUTO_CAST(edit)
    edit:SetNumberMode(0)
    edit:SetMaxLen(99)
    edit:SetText("")
    inputstring:ShowWindow(1)
    inputstring:SetEnable(1)
    local title = inputstring:GetChild("title")
    AUTO_CAST(title)
    local text = g.lang == "Japanese" and "{ol}{#FFFFFF}セット名を入力" or "{ol}{#FFFFFF}Enter set name"
    title:SetText(text)
    local confirm = inputstring:GetChild("confirm")
    confirm:SetEventScript(ui.LBUTTONUP, "Quickslot_operate_save_setname")
    edit:SetEventScript(ui.ENTERKEY, "Quickslot_operate_save_setname")
    edit:AcquireFocus()
end

function Quickslot_operate_save_setname(inputstring, ctrl, str, num)
    inputstring:ShowWindow(0)
    local edit = GET_CHILD(inputstring, 'input')
    local get_text = edit:GetText()
    if get_text == "" then
        local text = g.lang == "Japanese" and "{ol}文字を入力してください" or "{ol}Please enter text"
        ui.SysMsg(text)
        Quickslot_operate_INPUT_STRING_BOX()
        return
    end
    g.quickslot_operate_settings.slotset[g.login_name][get_text] = {}
    local temp_data = g.quickslot_operate_settings.slotset[g.login_name][get_text]
    local main_session = session.GetMainSession()
    local pc_job_data = main_session:GetPCJobInfo()
    local job_count = pc_job_data:GetJobCount()
    for i = 0, job_count - 1 do
        local current_job_info = pc_job_data:GetJobInfoByIndex(i)
        if current_job_info then
            local job_key = "jobid_" .. i
            temp_data[job_key] = tonumber(current_job_info.jobID)
        end
    end
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    for i = 1, 40 do
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. i)
        if slot then
            local icon = slot:GetIcon()
            if icon then
                local icon_info = icon:GetInfo()
                local category = icon_info:GetCategory()
                local item_type = icon_info.type
                local iesid = icon_info:GetIESID()
                temp_data[tostring(i)] = {
                    ["category"] = category,
                    ["type"] = item_type,
                    ["iesid"] = iesid
                }
            end
        end
    end
    ui.SysMsg(g.lang == "Japanese" and "{ol}スロットレイアウト保存" or "{ol}Save Slot layout")
    Quickslot_operate_save_settings()
end

function Quickslot_operate_load_slotset_context()
    local context = ui.CreateContextMenu("CONTEXT_LOAD", "{ol}Load Slotset", 0, -350, 0, 0)
    Quickslot_operate_build_slotset_menu(context, "LOAD")
    ui.OpenContextMenu(context)
end

function Quickslot_operate_delete_slotset()
    local context = ui.CreateContextMenu("CONTEXT", "{ol}Delete slotset", 0, -100, 0, 0)
    Quickslot_operate_build_slotset_menu(context, "DELETE")
    ui.OpenContextMenu(context)
end

function Quickslot_operate_delete_slotset_(name, title)
    g.quickslot_operate_settings.slotset[name][title] = nil
    Quickslot_operate_save_settings()
    local msg = name .. ":" .. title .. (g.lang == "Japanese" and " 削除しました" or " Deleted")
    ui.SysMsg(msg)
end

function Quickslot_operate_load_all_slot(name, title)
    local quickslotnexpbar = ui.GetFrame('quickslotnexpbar')
    for i = 1, MAX_QUICKSLOT_CNT do
        local str_index = tostring(i)
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. str_index)
        AUTO_CAST(slot)
        local slot_info = g.quickslot_operate_settings.slotset[name][title][str_index]
        if slot_info then
            local category = slot_info.category
            local clsid = slot_info.type
            local iesid = slot_info.iesid
            SET_QUICK_SLOT(quickslotnexpbar, slot, category, clsid, iesid, 0, true, true)
        else
            slot:ClearText()
            CLEAR_QUICKSLOT_SLOT(slot, 0, true)
        end
        slot:Invalidate()
    end
    quickslot.RequestSave()
    QUICKSLOTNEXPBAR_UPDATE_HOTKEYNAME(quickslotnexpbar)
    DebounceScript("QUICKSLOTNEXTBAR_UPDATE_ALL_SLOT", 0.1)
end

function Quickslot_operate_build_slotset_menu(context, mode)
    local slotset_data = g.quickslot_operate_settings.slotset
    if not slotset_data then
        return
    end
    ui.AddContextMenuItem(context, "-----", "None")
    for name, data in pairs(slotset_data) do
        for title, layout_data in pairs(data) do
            local display_name_parts = {}
            for i = 0, 3 do
                local job_key = "jobid_" .. i
                local saved_job_id = layout_data[job_key]
                if saved_job_id then
                    local job_cls = GetClassByType("Job", tonumber(saved_job_id))
                    if job_cls then
                        local job_name = dic.getTranslatedStr(TryGetProp(job_cls, "Name", "None"))
                        table.insert(display_name_parts, job_name)
                    end
                end
            end
            local display_str = table.concat(display_name_parts, ", ")
            local display_text, scp
            if mode == "DELETE" then
                display_text = string.format("%s : (%s)", tostring(title), tostring(display_str))
                scp = string.format("Quickslot_operate_delete_slotset_('%s','%s')", name, title)
            elseif mode == "LOAD" then
                display_text = string.format("%s : (%s)", tostring(title), tostring(display_str))
                scp = string.format("Quickslot_operate_load_all_slot('%s','%s')", name, title)
            end
            if display_text and scp then
                ui.AddContextMenuItem(context, display_text, scp)
            end
        end
    end
end

function Quickslot_operate_set_script(quickslotnexpbar)
    g.qso_potion_map = {}
    for race, pots in pairs(g.quickslot_operate_atk_list) do
        for _, pot_id in ipairs(pots) do
            g.qso_potion_map[pot_id] = true
        end
    end
    for race, pot_id in pairs(g.quickslot_operate_def_list) do
        g.qso_potion_map[pot_id] = true
    end
    local is_use = quickslotnexpbar:GetUserIValue("USE")
    for i = 1, MAX_QUICKSLOT_CNT do
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. i)
        AUTO_CAST(slot)
        local slot_info = quickslot.GetInfoByIndex(i - 1)
        if slot_info and slot_info.type ~= 0 then
            if slot_info and g.qso_potion_map[slot_info.type] then
                if is_use == 0 then
                    slot:SetEventScript(ui.MOUSEON, "None")
                else
                    slot:SetEventScript(ui.MOUSEON, "Quickslot_operate_choice_potion")
                end
            end
        end
    end
end

function Quickslot_operate_choice_potion(frame, slot, str, num)
    slot:RunUpdateScript("Quickslot_operate_frame_close", 5.0)
    local joystickquickslot = ui.GetFrame('joystickquickslot')
    joystickquickslot:RunUpdateScript("Quickslot_operate_frame_close", 5.0)
    local quickslot_operate = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "quickslot_operate", 0, 0, 0, 0)
    quickslot_operate:RemoveAllChild()
    quickslot_operate:Resize(150, 30)
    local map_frame = ui.GetFrame("map")
    local width = map_frame:GetWidth()
    quickslot_operate:SetPos(width / 2 - 75, 780)
    quickslot_operate:SetTitleBarSkin("None")
    quickslot_operate:SetSkinName("chat_window")
    quickslot_operate:SetLayerLevel(150)
    local slotset = quickslot_operate:CreateOrGetControl('slotset', 'slotset', 0, 0, 0, 0)
    AUTO_CAST(slotset)
    slotset:SetSlotSize(30, 30)
    slotset:EnablePop(0)
    slotset:EnableDrag(0)
    slotset:EnableDrop(0)
    slotset:SetColRow(5, 1)
    slotset:SetSpc(0, 0)
    slotset:SetSkinName('slot')
    slotset:CreateSlots()
    local slot_count = slotset:GetSlotCount()
    local atk_list = {640372, 640370, 640369, 640368, 640371}
    for i = 0, slot_count - 1 do
        local slot = slotset:GetSlotByIndex(i)
        slot:SetEventScript(ui.LBUTTONDOWN, "Quickslot_operate_set_potion")
        slot:SetEventScriptArgNumber(ui.LBUTTONDOWN, atk_list[i + 1])
        local class = GetClassByType('Item', atk_list[i + 1])
        SET_SLOT_ITEM_CLS(slot, class)
    end
    quickslot_operate:ShowWindow(1)
end

function Quickslot_operate_set_potion(parent, slot, str, pot_id)
    for race, data in pairs(g.quickslot_operate_atk_list) do
        for _, id in ipairs(data) do
            if id == pot_id then
                local down_potion_id = g.quickslot_operate_def_list[race]
                Quickslot_operate_check_all_slots(race, down_potion_id)
            end
        end
    end
end

function Quickslot_operate_check_all_slots(race, down_potion_id, atk_id, def_id)
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    local joystickquickslot = ui.GetFrame('joystickquickslot')
    if IsJoyStickMode() == 1 then
        quickslotnexpbar:ShowWindow(1)
        joystickquickslot:ShowWindow(0)
    end
    local atk_list = g.quickslot_operate_atk_list
    for i = 1, MAX_QUICKSLOT_CNT do
        local slot = GET_CHILD_RECURSIVELY(quickslotnexpbar, "slot" .. i)
        AUTO_CAST(slot)
        local slot_info = quickslot.GetInfoByIndex(i - 1)
        if slot_info and g.qso_potion_map[slot_info.type] then
            local is_atk_potion = false
            for _, pot_ids in pairs(atk_list) do
                for _, pot_id in ipairs(pot_ids) do
                    if pot_id == slot_info.type then
                        is_atk_potion = true
                        break
                    end
                end
                if is_atk_potion then
                    break
                end
            end
            local target_race = race or detected_race
            if is_atk_potion then
                local new_atk_id = atk_id
                if not new_atk_id or new_atk_id == 0 then
                    if target_race then
                        local list = atk_list[target_race]
                        local inv_item = session.GetInvItemByType(list[1]) or session.GetInvItemByType(list[2])
                        if inv_item then
                            new_atk_id = inv_item.type
                        else
                            new_atk_id = list[1]
                        end
                    end
                end
                if new_atk_id and new_atk_id ~= 0 then
                    SET_QUICK_SLOT(quickslotnexpbar, slot, slot_info.category, new_atk_id, nil, 0, true, true)
                end
            else
                local new_def_id = def_id
                if not new_def_id or new_def_id == 0 then
                    if target_race then
                        new_def_id = g.quickslot_operate_def_list[target_race]
                    elseif down_potion_id then
                        new_def_id = down_potion_id
                    end
                end
                if new_def_id and new_def_id ~= 0 then
                    SET_QUICK_SLOT(quickslotnexpbar, slot, slot_info.category, new_def_id, nil, 0, true, true)
                end
            end
        end
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local quickslot_operate_map_timer = _nexus_addons:CreateOrGetControl("timer", "quickslot_operate_map_timer", 0, 0)
    AUTO_CAST(quickslot_operate_map_timer)
    quickslot_operate_map_timer:Stop()
    quickslot.RequestSave()
    QUICKSLOTNEXPBAR_UPDATE_HOTKEYNAME(quickslotnexpbar)
    if IsJoyStickMode() == 1 then
        quickslotnexpbar:ShowWindow(0)
        joystickquickslot:ShowWindow(1)
    end
    DebounceScript("JOYSTICK_QUICKSLOT_UPDATE_ALL_SLOT", 0.1)
end

function Quickslot_operate_frame_close()
    local quickslot_operate = ui.GetFrame(addon_name_lower .. "quickslot_operate")
    if quickslot_operate then
        ui.DestroyFrame(quickslot_operate:GetName())
    end
end

function Quickslot_operate_map_change(_nexus_addons, Quickslot_operate_map_timer)
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    for _, zone_id in ipairs(g.quickslot_operate_zone_list) do
        if zone_id == g.map_id then
            local potion_type = Quickslot_operate_get_potion_type(g.quickslot_operate_indun_type)
            if potion_type then
                quickslotnexpbar:SetUserValue("POT_TYPE", potion_type)
                quickslotnexpbar:RunUpdateScript("Quickslot_operate_get_potion", 2.0)
                return
            end
        end
    end -- 11285, 11286
    for _, eventmap_id in ipairs(g.quickslot_guild_eventmap) do
        if eventmap_id == g.map_id then
            if eventmap_id == 11285 or eventmap_id == 11286 then
                quickslotnexpbar:SetUserValue("POT_TYPE", "Paramune")
            else
                quickslotnexpbar:SetUserValue("POT_TYPE", "Velnias")
            end
            quickslotnexpbar:RunUpdateScript("Quickslot_operate_get_potion", 2.0)
            return
        end
    end
end

function Quickslot_operate_SHOW_INDUNENTER_DIALOG()
    if g.settings.quickslot_operate.use == 0 then
        return
    end
    local indunenter = ui.GetFrame('indunenter')
    local indun_type = tonumber(indunenter:GetUserValue("INDUN_TYPE"))
    g.quickslot_operate_indun_type = indun_type
    local potion_type = Quickslot_operate_get_potion_type(indun_type)
    if potion_type then
        local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
        quickslotnexpbar:SetUserValue("POT_TYPE", potion_type)
        Quickslot_operate_get_potion(quickslotnexpbar)
    end
end

function Quickslot_operate_get_potion_type(indun_type)
    for potion_type, indun_list in pairs(g.quickslot_operate_raid_list) do
        for _, indun_id in ipairs(indun_list) do
            if indun_id == indun_type then
                return potion_type
            end
        end
    end
    return nil
end

function Quickslot_operate_get_potion(quickslotnexpbar)
    local potion_type = quickslotnexpbar:GetUserValue("POT_TYPE")
    local atk_list = g.quickslot_operate_atk_list
    local def_list = g.quickslot_operate_def_list
    local atk_id = atk_list[potion_type][1]
    local inv_item = session.GetInvItemByType(atk_id)
    if not inv_item then
        atk_id = atk_list[potion_type][2]
        inv_item = session.GetInvItemByType(atk_id)
        if not inv_item then
            atk_id = 0
        end
    end
    local def_id = def_list[potion_type]
    inv_item = session.GetInvItemByType(def_id)
    if not inv_item then
        def_id = 0
    end
    if (atk_id and atk_id ~= 0) or (def_id and def_id ~= 0) or atk_id == 0 or def_id == 0 then
        Quickslot_operate_check_all_slots(potion_type, nil, atk_id, def_id)
    end
end

function Quickslot_operate_switch_rshift(is_first)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:SetVisible(1)
    if g.quickslot_operate_settings.rshift == true then
        g.quickslot_operate_settings.rshift = false
        local quickslot_operate_timer = GET_CHILD(_nexus_addons, "quickslot_operate_timer")
        if quickslot_operate_timer then
            _nexus_addons:RemoveChild("quickslot_operate_timer")
        end
    else
        g.quickslot_operate_settings.rshift = true
        local quickslot_operate_timer = _nexus_addons:CreateOrGetControl("timer", "quickslot_operate_timer", 0, 0)
        AUTO_CAST(quickslot_operate_timer)
        quickslot_operate_timer:SetUpdateScript("Quickslot_operate_set_rshift_script")
        quickslot_operate_timer:Start(0.15)
    end
    Quickslot_operate_save_settings()
end

function Quickslot_operate_set_rshift_script()
    if keyboard.IsKeyPressed("RSHIFT") == 0 then
        return
    end
    local quickslotnexpbar = ui.GetFrame("quickslotnexpbar")
    local joystickquickslot = ui.GetFrame('joystickquickslot')
    if IsJoyStickMode() == 1 then
        quickslotnexpbar:ShowWindow(1)
        joystickquickslot:ShowWindow(0)
    end
    local current_potion_type = nil
    for i = 1, MAX_QUICKSLOT_CNT do
        local slot_info = quickslot.GetInfoByIndex(i - 1)
        if slot_info and slot_info.type ~= 0 then
            for race, pot_ids in pairs(g.quickslot_operate_atk_list) do
                for _, pot_id in ipairs(pot_ids) do
                    if pot_id == slot_info.type then
                        current_potion_type = race
                        break
                    end
                end
                if current_potion_type then
                    break
                end
            end
            if current_potion_type then
                break
            end
            for race, pot_id in pairs(g.quickslot_operate_def_list) do
                if pot_id == slot_info.type then
                    current_potion_type = race
                    break
                end
            end
        end
        if current_potion_type then
            break
        end
    end
    if not current_potion_type then
        return
    end
    local potion_type_order = {"Velnias", "Klaida", "Paramune", "Widling", "Forester"}
    local current_index = 0
    for i, p_type in ipairs(potion_type_order) do
        if p_type == current_potion_type then
            current_index = i
            break
        end
    end
    local next_index = (current_index % #potion_type_order) + 1
    local target_race = potion_type_order[next_index]
    local atk_ids = g.quickslot_operate_atk_list[target_race]
    local inv_atk = session.GetInvItemByType(atk_ids[1]) or session.GetInvItemByType(atk_ids[2])
    local found_atk_id = inv_atk and inv_atk.type or 0 -- 持ってなければ 0
    local def_id_candidate = g.quickslot_operate_def_list[target_race]
    local inv_def = session.GetInvItemByType(def_id_candidate)
    local found_def_id = inv_def and def_id_candidate or 0 -- 持ってなければ 0
    Quickslot_operate_check_all_slots(target_race, nil, found_atk_id, found_def_id)
    quickslot.RequestSave()
    if target_race then
        Quickslot_operate_check_all_slots(target_race, nil, found_atk_id, found_def_id)
        quickslot.RequestSave()
    end

    if IsJoyStickMode() == 1 then
        quickslotnexpbar:ShowWindow(0)
        joystickquickslot:ShowWindow(1)
    end
end
-- quickslot_operate ここまで


-- Ancient Auto Set ここから
function Ancient_auto_set_save_settings()
    g.save_json(g.ancient_auto_set_path, g.ancient_auto_set_settings)
end

function Ancient_auto_set_load_settings()
    g.ancient_auto_set_path = string.format("../addons/%s/%s/ancient_auto_set.json", addon_name_lower, g.active_id)
    g.ancient_auto_set_old_path = string.format("../addons/%s/%s/settings.json", "ancient_autoset", g.active_id)
    local settings = g.load_json(g.ancient_auto_set_path)
    local changed = false
    local ver = 1.1
    if not settings or not settings.ver or settings.ver < ver then
        settings = {
            priset = {},
            ver = ver
        }
        local old_settings = g.load_json(g.ancient_auto_set_old_path)
        if old_settings then
            for key, data in pairs(old_settings) do
                if type(data) == "table" and tonumber(key) and string.len(key) > 10 then
                    local new_char_data = {
                        guids = {},
                        name = ""
                    }
                    for i = 0, 3 do
                        local guid = data[tostring(i)]
                        if guid then
                            table.insert(new_char_data.guids, {guid, "Unknown"})
                        end
                    end
                    settings[key] = new_char_data
                end
            end
            if old_settings.presets then
                local old_names = old_settings.presets_name or {}
                for p_id, p_data in pairs(old_settings.presets) do
                    local p_name = old_names[p_id] or ("Preset " .. p_id)
                    settings.priset[p_id] = {
                        name = p_name
                    }
                    for i = 0, 3 do
                        local guid = p_data[tostring(i)]
                        if guid then
                            settings.priset[p_id][tostring(i)] = guid
                        end
                    end
                end
            end
            changed = true
        end
    end
    if not settings[g.cid] then
        settings[g.cid] = {
            guids = {},
            name = g.login_name or ""
        }
        changed = true
    end
    g.ancient_auto_set_settings = settings
    if changed then
        Ancient_auto_set_save_settings()
    end
end

function ancient_auto_set_on_init()
    if not g.ancient_auto_set_settings then
        Ancient_auto_set_load_settings()
    end
    local old_func = g.settings.ancient_auto_set.old_init_func
    if _G[old_func] then
        return
    end
    if not g.ancient_auto_set_settings[g.cid] then
        g.ancient_auto_set_settings[g.cid] = {
            guids = {},
            name = g.login_name or ""
        }
        Ancient_auto_set_save_settings()
    end
    if g.ancient_auto_set_settings[g.cid].name == "" then
        g.ancient_auto_set_settings[g.cid].name = g.login_name or ""
        Ancient_auto_set_save_settings()
    end
    if g.get_map_type() == "City" then
        Ancient_auto_set_change_set_reserve()
    end
    Ancient_auto_set_frame_init()
    g.setup_hook_and_event(g.addon, "ANCIENT_CARD_LIST_OPEN", "Ancient_auto_set_ANCIENT_CARD_LIST_OPEN", true)
    g.setup_hook_and_event(g.addon, "ANCIENT_CARD_LIST_CLOSE", "Ancient_auto_set_ANCIENT_CARD_LIST_CLOSE", true)
end

function Ancient_auto_set_ANCIENT_CARD_LIST_OPEN()
    if g.settings.ancient_auto_set.use == 0 then
        return
    end
    local ancient_card_list = ui.GetFrame("ancient_card_list")
    local frame_name = addon_name_lower .. "_ancient_auto_set_priset_frame"
    local priset_frame = ui.CreateNewFrame("notice_on_pc", frame_name, 0, 0, 0, 0)
    AUTO_CAST(priset_frame)
    priset_frame:RemoveAllChild()
    priset_frame:SetLayerLevel(92)
    priset_frame:SetSkinName('None')
    priset_frame:SetTitleBarSkin("None")
    priset_frame:SetPos(ancient_card_list:GetX() + 710, ancient_card_list:GetY() + 322)
    priset_frame:Resize(707, 400)
    priset_frame:ShowWindow(1)
    priset_frame:SetAnimation("frameOpenAnim", "chat_balloon_start")
    priset_frame:SetAnimation("frameCloseAnim", "chat_balloon_end")
    local bg = priset_frame:CreateOrGetControl("groupbox", "bg", 705, 360, ui.LEFT, ui.TOP, 0, 40, 0, 0)
    AUTO_CAST(bg)
    bg:SetSkinName("test_frame_low")
    bg:EnableHittestGroupBox(false)
    local title_bg = priset_frame:CreateOrGetControl("groupbox", "title_bg", 705, 61, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(title_bg)
    title_bg:SetSkinName("test_frame_top")
    title_bg:EnableHittestGroupBox(false)
    local title = priset_frame:CreateOrGetControl("richtext", "title", 100, 30, ui.CENTER_HORZ, ui.TOP, 0, 18, 0, 0)
    title:SetText("{@st43}{s22}Assister Preset Setting{/}")
    title:EnableHitTest(false)
    local close = priset_frame:CreateOrGetControl("button", "close", 44, 44, ui.RIGHT, ui.TOP, 0, 20, 17, 0)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    -- close:SetTextTooltip("{ol}Close the Assister Preset window")
    close:SetEventScript(ui.LBUTTONUP, "Ancient_auto_set_ANCIENT_CARD_LIST_CLOSE")
    local topbg = priset_frame:CreateOrGetControl("groupbox", "topbg", 665, 315, ui.LEFT, ui.TOP, 20, 100, 0, 0)
    AUTO_CAST(topbg)
    topbg:EnableHittestGroupBox(false)
    local ancient_card_slot_gbox = topbg:CreateOrGetControl("groupbox", "ancient_card_slot_gbox", 665, 275, ui.LEFT,
        ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(ancient_card_slot_gbox)
    ancient_card_slot_gbox:EnableHittestGroupBox(false)
    ancient_card_slot_gbox:SetSkinName("test_frame_midle")
    local tab = priset_frame:CreateOrGetControl("tab", "tab", 664, 40, ui.LEFT, ui.TOP, 22, 65, 0, 0)
    AUTO_CAST(tab)
    tab:SetEventScript(ui.LBUTTONUP, "Ancient_auto_set_tab_change")
    tab:SetSkinName("tab2")
    for i = 1, 10 do
        tab:AddItem("{@st66b}{s16}Set " .. i, true, "", "", "", "", "", false)
    end
    tab:SetItemsFixWidth(66)
    tab:SetItemsAdjustFontSizeByWidth(66)
    local swap = priset_frame:CreateOrGetControl("button", "swap", 100, 45, ui.RIGHT, ui.TOP, 0, 325, 30, 0)
    swap:SetSkinName("test_pvp_btn")
    swap:SetText("{@st42}{s18}Change")
    swap:SetEventScript(ui.LBUTTONUP, "Ancient_auto_set_card_change")
    local name_edit = priset_frame:CreateOrGetControl("edit", "name_edit", 420, 330, 150, 36)
    AUTO_CAST(name_edit)
    name_edit:SetFontName("white_16_ol")
    name_edit:SetTextAlign("left", "center")
    name_edit:SetSkinName("inventory_serch")
    name_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}セット名入力" or "{ol}Set Name Input")
    name_edit:SetEventScript(ui.ENTERKEY, "Ancient_auto_set_tab_name_save")
    priset_frame:ShowWindow(1)
    Ancient_auto_set_tab_change(priset_frame)
end

function Ancient_auto_set_ANCIENT_CARD_LIST_CLOSE()
    local frame_name = addon_name_lower .. "_ancient_auto_set_priset_frame"
    local priset_frame = ui.GetFrame(frame_name)
    if priset_frame then
        priset_frame:ShowWindow(0)
    end
end

function Ancient_auto_set_tab_change(priset_frame)
    local tab = GET_CHILD(priset_frame, "tab")
    AUTO_CAST(tab)
    local tab_index = tab:GetSelectItemIndex()
    local set_name = priset_frame:CreateOrGetControl("richtext", "set_name", 50, 340, 320, 30)
    AUTO_CAST(set_name)
    set_name:SetFontName("white_18_ol")
    if g.ancient_auto_set_settings.priset and g.ancient_auto_set_settings.priset[tostring(tab_index)] then
        local current_set_name = g.ancient_auto_set_settings.priset[tostring(tab_index)].name
        if current_set_name and current_set_name ~= "" then
            set_name:SetText("{ol}Set Name: " .. current_set_name)
        else
            set_name:SetText("{ol}Set Name:")
        end
    else
        set_name:SetText("{ol}Set Name:")
    end
    Ancient_auto_set_load_slots(priset_frame, tab_index)
end

function Ancient_auto_set_load_slots(priset_frame, tab_index)
    local gbox = GET_CHILD_RECURSIVELY(priset_frame, 'ancient_card_slot_gbox')
    gbox:RemoveAllChild()
    local width = 4
    for index = 0, 3 do
        local ctrlSet = gbox:CreateControlSet("ancient_card_item_slot", "SLOT_" .. index, width, 4)
        width = width + ctrlSet:GetWidth() + 2
        local ancient_card_gbox = GET_CHILD(ctrlSet, "ancient_card_gbox")
        ancient_card_gbox:SetVisible(0)
        ctrlSet:SetUserValue("INDEX", index)
        ctrlSet:EnableHitTest(1)
        local slot = GET_CHILD_RECURSIVELY(ctrlSet, "ancient_card_slot")
        AUTO_CAST(slot)
        local icon = CreateIcon(slot)
        slot:EnableHitTest(1)
        ctrlSet:SetEventScript(ui.DROP, 'Ancient_auto_set_frame_drop')
        ctrlSet:SetEventScript(ui.RBUTTONDOWN, 'Ancient_auto_set_delete_data')
        if index == 0 then
            local gold_border = GET_CHILD_RECURSIVELY(ctrlSet, "gold_border")
            AUTO_CAST(gold_border)
            gold_border:SetImage('monster_card_g_frame_02')
        end
        if g.ancient_auto_set_settings and g.ancient_auto_set_settings.priset and
            g.ancient_auto_set_settings.priset[tostring(tab_index)] then
            local preset_data = g.ancient_auto_set_settings.priset[tostring(tab_index)]
            if preset_data[tostring(index)] then
                local guid = preset_data[tostring(index)]
                if guid then
                    local card = session.ancient.GetAncientCardByGuid(guid)
                    if card then
                        SET_ANCIENT_CARD_SLOT(ctrlSet, card)
                    end
                end
            end
        end
        local default_image = GET_CHILD_RECURSIVELY(ctrlSet, "default_image")
        AUTO_CAST(default_image)
        default_image:SetImage("socket_slot_bg")
    end
end

function Ancient_auto_set_card_change(priset_frame, ctrl)
    if IS_ANCIENT_ENABLE_MAP() == "YES" then
        imcAddOn.BroadMsg("NOTICE_Dm_!", ClMsg("ImpossibleInCurrentMap"), 3)
        return
    end
    local tab = GET_CHILD(priset_frame, "tab")
    AUTO_CAST(tab)
    local tab_index = tab:GetSelectItemIndex()
    if not g.ancient_auto_set_settings.priset[tostring(tab_index)] then
        return
    end
    priset_frame:SetUserValue("TAB_INDEX", tab_index)
    priset_frame:SetUserValue("SLOT_INDEX", 0)
    priset_frame:RunUpdateScript("Ancient_auto_set_put_card_slot", 0.3)
end

function Ancient_auto_set_put_card_slot(priset_frame)
    local tab_index = priset_frame:GetUserIValue("TAB_INDEX")
    local slot_index = priset_frame:GetUserIValue("SLOT_INDEX")
    local target_guid = g.ancient_auto_set_settings.priset[tostring(tab_index)][tostring(slot_index)]
    if slot_index <= 3 then
        if target_guid then
            local card = session.ancient.GetAncientCardBySlot(g.slot_index)
            if card then
                local guid = card:GetGuid()
                if target_guid ~= guid then
                    ReqSwapAncientCard(target_guid, slot_index)
                    imcSound.PlaySoundEvent("sys_card_battle_rival_slot_show")
                end
            else
                ReqSwapAncientCard(target_guid, slot_index)
                imcSound.PlaySoundEvent("sys_card_battle_rival_slot_show")
            end
        end
        priset_frame:SetUserValue("SLOT_INDEX", slot_index + 1)
        return 1
    end
    priset_frame:SetUserValue("TAB_INDEX", "None")
    priset_frame:SetUserValue("SLOT_INDEX", "None")
    return 0
end

function Ancient_auto_set_tab_name_save(priset_frame, ctrl)
    local set_name = ctrl:GetText()
    local tab = GET_CHILD(priset_frame, "tab")
    AUTO_CAST(tab)
    local tab_index = tab:GetSelectItemIndex()
    if not g.ancient_auto_set_settings.priset then
        g.ancient_auto_set_settings.priset = {}
    end
    g.ancient_auto_set_settings.priset[tostring(tab_index)].name = set_name
    Ancient_auto_set_save_settings()
    priset_frame:RunUpdateScript("Ancient_auto_set_ANCIENT_CARD_LIST_OPEN", 0.1)
end

function Ancient_auto_set_frame_drop(parent, ctrl, str, num)
    local to_index = ctrl:GetUserIValue("INDEX")
    local ancient_card_list = ui.GetFrame("ancient_card_list")
    local priset_frame = parent:GetTopParentFrame()
    local tab = GET_CHILD(priset_frame, "tab")
    AUTO_CAST(tab)
    local tab_index = tab:GetSelectItemIndex()
    if not g.ancient_auto_set_settings.priset then
        g.ancient_auto_set_settings.priset = {}
    end
    if not g.ancient_auto_set_settings.priset[tostring(tab_index)] then
        g.ancient_auto_set_settings.priset[tostring(tab_index)] = {}
    end
    local lifted_guid = ancient_card_list:GetUserValue("LIFTED_GUID")
    g.ancient_auto_set_settings.priset[tostring(tab_index)][tostring(to_index)] = lifted_guid
    Ancient_auto_set_save_settings()
    Ancient_auto_set_tab_change(priset_frame)
    ancient_card_list:SetUserValue("LIFTED_GUID", "None")
end

function Ancient_auto_set_delete_data(parent, ctrl, str, num)
    local to_index = ctrl:GetUserIValue("INDEX")
    local priset_frame = parent:GetTopParentFrame()
    local tab = GET_CHILD(frame, "tab")
    AUTO_CAST(tab)
    local tab_index = tab:GetSelectItemIndex()
    if not (g.ancient_auto_set_settings.priset and g.ancient_auto_set_settings.priset[tostring(tab_index)]) then
        return
    end
    g.ancient_auto_set_settings.priset[tostring(tab_index)][tostring(to_index)] = "None"
    Ancient_auto_set_save_settings()
    Ancient_auto_set_tab_change(priset_frame)
end

function Ancient_auto_set_frame_init()
    local ancient_card_list = ui.GetFrame("ancient_card_list")
    local topbg = GET_CHILD_RECURSIVELY(ancient_card_list, "topbg")
    if g.settings.ancient_auto_set.use == 0 then
        local btn_aas = GET_CHILD(topbg, "btn_aas")
        if btn_aas then
            DESTROY_CHILD_BYNAME(topbg, "btn_aas")
        end
        return
    end
    local btn_aas = topbg:CreateOrGetControl("button", "btn_aas", 465, 285, 30, 30)
    AUTO_CAST(btn_aas)
    btn_aas:SetSkinName("None")
    btn_aas:SetImage("config_button_normal")
    btn_aas:Resize(30, 30)
    btn_aas:SetEventScript(ui.LBUTTONUP, "Ancient_auto_set_reg")
    btn_aas:SetEventScript(ui.RBUTTONUP, "Ancient_auto_set_release")
    btn_aas:SetTextTooltip(g.lang == "Japanese" and
                               "{ol}[AAS]{nl}左クリック: 登録{nl}右クリック: 登録解除" or
                               "{ol}[AAS]{nl}Left-click: Setting Register{nl}Right-click: Setting Release")
end

function Ancient_auto_set_release(frame, ctrl)
    local ancient_card_list = ui.GetFrame("ancient_card_list")
    local tab = ancient_card_list:GetChild("tab")
    AUTO_CAST(tab)
    tab:SelectTab(0)
    if not g.ancient_auto_set_settings[g.cid] then
        g.ancient_auto_set_settings[g.cid] = {}
        Ancient_auto_set_save_settings()
    end
    g.ancient_auto_set_settings[g.cid].guids = {}
    local msg = g.lang == "Japanese" and "[AAS]登録解除しました" or "[AAS]Setting released"
    ui.SysMsg(msg)
    Ancient_auto_set_save_settings()
end

function Ancient_auto_set_reg(frame, ctrl)
    local ancient_card_list = ui.GetFrame("ancient_card_list")
    local tab = ancient_card_list:GetChild("tab")
    AUTO_CAST(tab)
    tab:SelectTab(0)
    g.ancient_auto_set_settings[g.cid] = {
        name = g.login_name,
        guids = {}
    }
    for index = 0, 3 do
        local card = session.ancient.GetAncientCardBySlot(index)
        if card then
            local guid = card:GetGuid()
            table.insert(g.ancient_auto_set_settings[g.cid].guids, {guid, card:GetClassName()})
        end
    end
    local msg = g.lang == "Japanese" and "[AAS]登録しました" or "[AAS]Setting Registered"
    ui.SysMsg(msg)
    Ancient_auto_set_save_settings()
end

function Ancient_auto_set_change_set_reserve()
    if g.settings.ancient_auto_set.use == 0 then
        return
    end
    if not (g.ancient_auto_set_settings[g.cid] and g.ancient_auto_set_settings[g.cid].guids and
        next(g.ancient_auto_set_settings[g.cid].guids)) then
        local text = g.lang == "Japanese" and "{ol}[AAS]{#FFFFFF} " .. g.login_name .. " {/}アシスター未登録" or
                         "{ol}[APS]{#FFFFFF} " .. g.login_name .. " {/}is not registered assister"
        ui.SysMsg(text)
        return
    end
    local changed = false
    local guids = g.ancient_auto_set_settings[g.cid].guids
    for i, row_data in ipairs(guids) do
        if row_data[2] == "Unknown" then
            local target_guid = row_data[1]
            local new_name = nil
            local card = session.ancient.GetAncientCardBySlot(i - 1)
            if card and card:GetGuid() == target_guid then
                new_name = card:GetClassName()
            end
            if new_name then
                row_data[2] = new_name
                changed = true
            end
        end
    end
    if changed then
        Ancient_auto_set_save_settings()
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local ancient_auto_set_timer = _nexus_addons:CreateOrGetControl("timer", "ancient_auto_set_timer", 0, 0)
    AUTO_CAST(ancient_auto_set_timer)
    ancient_auto_set_timer:Stop()
    local needs_change = false
    for i, row_data in ipairs(g.ancient_auto_set_settings[g.cid].guids) do
        local save_guid = row_data[1]
        local card = session.ancient.GetAncientCardBySlot(i - 1)
        local current_guid = card and card:GetGuid() or nil
        if save_guid ~= current_guid then
            needs_change = true
            break
        end
    end
    if needs_change then
        _nexus_addons:SetUserValue("ANCIENT_INDEX", 0)
        ancient_auto_set_timer:SetUpdateScript("Ancient_auto_set_change_set")
        ancient_auto_set_timer:Start(0.3)
    end
end

function Ancient_auto_set_change_set(_nexus_addons, ancient_auto_set_timer)
    local index = _nexus_addons:GetUserIValue("ANCIENT_INDEX")
    if index <= 3 then
        local card_guid = g.ancient_auto_set_settings[g.cid].guids[index + 1][1]
        if card_guid then
            local card = session.ancient.GetAncientCardBySlot(index)
            local current_guid = card and card:GetGuid() or nil
            if card_guid ~= current_guid then
                ReqSwapAncientCard(card_guid, index)
            end
        end
        _nexus_addons:SetUserValue("ANCIENT_INDEX", index + 1)
        return 1
    end
    return 0
end
-- Ancient Auto Set ここまで

-- save_quest ここから
function Save_quest_save_settings()
    g.save_json(g.save_quest_path, g.save_quest_settings)
end

function Save_quest_load_settings()
    g.save_quest_path = string.format("../addons/%s/%s/save_quest.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.save_quest_path)
    local changed = false
    local ver = 1.1
    if not settings then
        settings = {
            ver = ver,
            save_quests = {},
            short_cuts = {},
            frame = {
                move = 0,
                x = 0,
                y = 0,
                skin = "None"
            }
        }
        changed = true
    elseif not settings.ver or settings.ver < ver then
        settings.ver = ver
        settings.frame.skin = "bg2"
        changed = true
    end
    g.save_quest_settings = settings
    if changed then
        Save_quest_save_settings()
    end
end

function save_quest_on_init()
    if not g.save_quest_settings then
        Save_quest_load_settings()
    end
    local old_func = g.settings.save_quest.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.save_quest.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "save_quest")
        return
    end
    g.setup_hook_and_event(g.addon, "SET_QUEST_CTRL_MARK", "Save_quest_SET_QUEST_CTRL_MARK", true)
    g.setup_hook_and_event(g.addon, "SCR_QUEST_SHARE_PARTY_MEMBER", "Save_quest_SCR_QUEST_SHARE_PARTY_MEMBER", true)
    g.setup_hook_and_event(g.addon, "EXEC_ABANDON_QUEST", "Save_quest_EXEC_ABANDON_QUEST", true)
    g.addon:RegisterMsg("TARGET_SET", "Save_quest_ON_TARGET_SET")
    Save_quest_npc_hide()
    Save_quest_short_cut()
end

function Save_quest_npc_hide()
    local objs, count = SelectObject(GetMyPCObject(), 1000, "ALL")
    local cnt = 0
    for i = 1, count do
        local handle = GetHandle(objs[i])
        if handle then
            if info.IsPC(handle) ~= 1 then
                cnt = cnt + 1
                local gen_type = world.GetActor(handle):GetNPCStateType()
                local pc = GetMyPCObject()
                local gen_list = SCR_GET_XML_IES('GenType_' .. GetZoneName(pc), 'GenType', gen_type)
                for j = 1, #gen_list do
                    local gen_obj = gen_list[j]
                    if g.save_quest_settings.save_quests[gen_obj.Dialog] == 1 then
                        world.Leave(handle, 0.0)
                        break
                    end
                end
            end
        end
    end
end

function Save_quest_settings()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "save_quest_setting", 0, 0, 0, 0)
    AUTO_CAST(setting)
    setting:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    setting:SetSkinName("test_frame_low")
    setting:EnableHittestFrame(1)
    setting:EnableHitTest(1)
    setting:SetLayerLevel(999)
    setting:RemoveAllChild()
    local title_text = setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Save Quest Config")
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Save_quest_frame_close")
    local gbox = setting:CreateOrGetControl("groupbox", "gbox", 10, 40, 0, 0)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local move_check = gbox:CreateOrGetControl('checkbox', "move_check", 10, 5, 30, 30)
    AUTO_CAST(move_check)
    move_check:SetCheck(g.save_quest_settings.frame.move)
    move_check:SetEventScript(ui.LBUTTONUP, "Save_quest_check_switch")
    move_check:SetText(g.lang == "Japanese" and "{ol}チェックするとフレーム固定" or
                           "{ol}If checked, the frame is fixed")
    local skin_change = gbox:CreateOrGetControl("button", "skin_change", 40, 40, 80, 30)
    AUTO_CAST(skin_change)
    local skin_text = g.lang == "Japanese" and "{ol}フレームスキン選択" or "{ol}Select Frame Skin"
    skin_change:SetEventScript(ui.LBUTTONUP, "Save_quest_skin_select")
    skin_change:SetText("{ol}SKIN SELECT")
    skin_change:SetTextTooltip(skin_text)
    setting:Resize(300, 130)
    gbox:Resize(setting:GetWidth() - 20, setting:GetHeight() - 50)
    setting:ShowWindow(1)
end

function Save_quest_skin_select()
    local context = ui.CreateContextMenu("save_quest_skin_select", "{ol}Skin Select", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, " ")
    local skin_tbl = {"None", "bg", "bg2"}
    for _, skin_name in ipairs(skin_tbl) do
        local str_scp
        str_scp = string.format("Save_quest_skin_select_('%s')", skin_name)
        local text
        if skin_name == "None" then
            text = g.lang == "Japanese" and "{ol}無し" or "None"
        elseif skin_name == "bg" then
            text = g.lang == "Japanese" and "{ol}黒" or "Solid black"
        elseif skin_name == "bg2" then
            text = g.lang == "Japanese" and "{ol}透明度高め" or "High transparency"
        end
        ui.AddContextMenuItem(context, text, str_scp)
    end
    ui.OpenContextMenu(context)
end

function Save_quest_skin_select_(skin_name)
    g.save_quest_settings.frame.skin = skin_name
    Save_quest_save_settings()
    Save_quest_short_cut()
end

function Save_quest_frame_close(frame)
    ui.DestroyFrame(addon_name_lower .. "save_quest_setting")
end

function Save_quest_check_switch(frame, move_check)
    g.save_quest_settings.frame.move = move_check:IsChecked()
    Save_quest_save_settings()
    Save_quest_short_cut()
end

function Save_quest_EXEC_ABANDON_QUEST(my_frame, my_msg)
    if g.settings.save_quest.use == 0 then
        return
    end
    local quest_id = g.get_event_args(my_msg)
    Save_quest_save(quest_id, "release")
    Save_quest_short_cut_release(nil, nil, tostring(quest_id), nil)
end

function Save_quest_SET_QUEST_CTRL_MARK(my_frame, my_msg)
    local ctrl, quest_cls, state = g.get_event_args(my_msg)
    if g.settings.save_quest.use == 0 then
        DESTROY_CHILD_BYNAME(ctrl, "save_text")
        DESTROY_CHILD_BYNAME(ctrl, "state_pic")
        return
    end
    local quest = ui.GetFrame("quest")
    local questBox = GET_CHILD(quest, "questBox")
    if questBox:GetSelectItemIndex() ~= 1 then
        return
    end
    AUTO_CAST(ctrl)
    --[[local level = GET_CHILD(ctrl, "level")
    if level then
        AUTO_CAST(level)
        level:SetPos(0, 25)
    end]]
    local quest_id = quest_cls.ClassID
    local save_text = GET_CHILD(ctrl, "save_text")
    if save_text then
        DESTROY_CHILD_BYNAME(ctrl, "save_text")
    end
    local result = SCR_QUEST_CHECK_C(GetMyPCObject(), quest_cls.ClassName)
    local npc_state = quest_cls[CONVERT_STATE(result) .. 'NPC']
    if not npc_state then
        return
    end
    if not g.save_quest_settings.save_quests[npc_state] then
        g.save_quest_settings.save_quests[npc_state] = 0
    end
    if g.save_quest_settings.save_quests[npc_state] == 1 then
        local save_text = ctrl:CreateOrGetControl('richtext', "save_text", 0, 0, 20, 10)
        AUTO_CAST(save_text)
        save_text:SetText("{ol}saved")
        save_text:SetPos(330, 5)
    end
    if quest:IsVisible() == 1 then
        if Save_quest_is_warp(quest_cls) == 1 then
            local quest = ui.GetFrame("quest")
            local quest_ctrl_set = GET_CHILD_RECURSIVELY(quest, ctrl:GetName())
            AUTO_CAST(quest_ctrl_set)
            quest_ctrl_set:SetEventScript(ui.RBUTTONDOWN, 'Save_quest_menu')
            quest_ctrl_set:SetEventScriptArgString(ui.RBUTTONDOWN, quest_cls.Name)
            quest_ctrl_set:SetEventScriptArgNumber(ui.RBUTTONDOWN, quest_id)
            local state_pic = ctrl:CreateOrGetControl('picture', "state_pic", 0, 0, 20, 20)
            AUTO_CAST(state_pic)
            state_pic:SetEnableStretch(1)
            state_pic:SetImage("questinfo_return")
            state_pic:SetAngleLoop(-3)
            state_pic:EnableHitTest(1)
            state_pic:SetEventScript(ui.LBUTTONUP, "QUESTION_QUEST_WARP")
            state_pic:SetEventScriptArgNumber(ui.LBUTTONUP, quest_id)
            state_pic:SetEventScript(ui.RBUTTONUP, 'Save_quest_menu')
            state_pic:SetEventScriptArgString(ui.RBUTTONUP, quest_cls.Name)
            state_pic:SetEventScriptArgNumber(ui.RBUTTONUP, quest_id)
            state_pic:SetTextTooltip(g.lang == "Japanese" and
                                         "{ol}[Save Quest]{nl}左クリック:ワープ{nl}右クリック:設定" or
                                         "{ol}[Save Quest]{nl}Left Click: Warp{nl}Right Click: Settings")
            state_pic:SetPos(380, 5)
        end
    end
end

function Save_quest_menu(frame, ctrl, quest_name, quest_id)
    local menu_title = string.format("{ol}[%d] %s", quest_id, quest_name)
    local context = ui.CreateContextMenu("CONTEXT_save_quest", menu_title, 0, 0, string.len(menu_title) * 6, 100)
    ui.AddContextMenuItem(context, "Save", string.format("Save_quest_save(%d,'%s')", quest_id, "save"))
    ui.AddContextMenuItem(context, "Release", string.format("Save_quest_save(%d)", quest_id))
    ui.AddContextMenuItem(context, "ShortCut", string.format("Save_quest_short_cut(%d)", quest_id))
    ui.AddContextMenuItem(context, "ShortCut Release", string.format("Save_quest_short_cut_release(%d)", quest_id))
    ui.AddContextMenuItem(context, "Cancel", "None")
    ui.OpenContextMenu(context)
end

function Save_quest_save(quest_id, stat)
    local quest_cls = GetClassByType("QuestProgressCheck", quest_id)
    local result = SCR_QUEST_CHECK_C(GetMyPCObject(), quest_cls.ClassName)
    local npc_state = quest_cls[CONVERT_STATE(result) .. 'NPC']
    if stat == "save" then
        g.save_quest_settings.save_quests[npc_state] = 1
    else
        g.save_quest_settings.save_quests[npc_state] = nil
    end
    Save_quest_save_settings()
    local quest = ui.GetFrame("quest")
    if quest:IsVisible() == 1 then
        local quest_ctrl_set = GET_CHILD_RECURSIVELY(quest, "_Q_" .. quest_id)
        AUTO_CAST(quest_ctrl_set)
        local quest_cls = GetClassByType("QuestProgressCheck", quest_id)
        SET_QUEST_CTRL_MARK(quest_ctrl_set, quest_cls)
    end
end

function Save_quest_short_cut(quest_id)
    local save_quest = ui.GetFrame(addon_name_lower .. "save_quest")
    if not save_quest then
        save_quest = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "save_quest", 0, 0, 0, 0)
        AUTO_CAST(save_quest)
    end
    save_quest:SetSkinName(g.save_quest_settings.frame.skin)
    save_quest:EnableHittestFrame(1)
    save_quest:EnableMove(g.save_quest_settings.frame.move == 0 and 1 or 0)
    local x = g.save_quest_settings.frame.x
    local y = g.save_quest_settings.frame.y
    if x == 0 and y == 0 then
        x, y = 555, 200
    end
    save_quest:SetPos(x, y)
    save_quest:SetLayerLevel(79)
    save_quest:SetEventScript(ui.LBUTTONUP, "Save_quest_frame_end_drag")
    if quest_id then
        local quest_cls = GetClassByType("QuestProgressCheck", quest_id)
        g.save_quest_settings.short_cuts[tostring(quest_id)] = 1
        Save_quest_save_settings()
    end
    save_quest:ShowWindow(0)
    Save_quest_short_cut_set(save_quest)
end

function Save_quest_frame_end_drag(frame)
    g.save_quest_settings.frame.x = frame:GetX()
    g.save_quest_settings.frame.y = frame:GetY()
    Save_quest_save_settings()
end

function Save_quest_short_cut_set(save_quest)
    save_quest:RemoveAllChild()
    if not next(g.save_quest_settings.short_cuts) then
        save_quest:Resize(0, 0)
        return
    end
    local max_text_width = 0
    local y = 0
    local valid_quest_ids = {}
    for quest_id_str, _ in pairs(g.save_quest_settings.short_cuts) do
        local quest_id = tonumber(quest_id_str)
        local quest_cls = GetClassByType("QuestProgressCheck", quest_id)
        if quest_cls then
            if Save_quest_is_warp(quest_cls) == 1 then
                local state_pic =
                    save_quest:CreateOrGetControl('picture', "state_pic" .. quest_id_str, 5, y + 5, 20, 20)
                AUTO_CAST(state_pic)
                state_pic:SetEnableStretch(1)
                state_pic:SetImage("questinfo_return")
                state_pic:SetAngleLoop(-3)
                state_pic:EnableHitTest(1)
                state_pic:SetEventScript(ui.LBUTTONUP, "QUESTION_QUEST_WARP")
                state_pic:SetEventScriptArgNumber(ui.LBUTTONUP, quest_id)
                state_pic:SetTooltipType('texthelp')
                state_pic:SetTooltipArg("{ol}" .. quest_cls.Name)
                state_pic:SetEventScript(ui.RBUTTONUP, "SAVEQUEST_OPEN_SHORTCUT_MENU")
                local map_info =
                    save_quest:CreateOrGetControl('richtext', "map_info" .. quest_id_str, 27, y + 10, 0, 30)
                AUTO_CAST(map_info)
                local result = SCR_QUEST_CHECK_Q(SCR_QUESTINFO_GET_PC(), quest_cls.ClassName)
                local map_name = quest_cls[CONVERT_STATE(result) .. 'Map']
                local zone_name = GetClassString('Map', map_name, 'Name')
                map_info:SetText(string.format("{s12}{ol}%s", zone_name))
                --[[map_info:SetEventScript(ui.RBUTTONUP, "Save_quest_short_cut_release")
                map_info:SetEventScriptArgString(ui.RBUTTONUP, quest_id_str)]]
                map_info:EnableHitTest(1)
                local text_w = map_info:GetWidth()
                if max_text_width < text_w then
                    max_text_width = text_w
                end
                local share_party = save_quest:CreateOrGetControl("picture", "share_party" .. quest_id_str, 0, y + 5,
                    20, 20)
                AUTO_CAST(share_party)
                share_party:SetEnableStretch(1)
                share_party:SetImage("btn_partyshare")
                share_party:EnableHitTest(1)
                share_party:SetTextTooltip(g.lang == "Japanese" and "{ol}クエストPTシェア切替" or
                                               "Quest PT Share Toggle")
                share_party:SetEventScript(ui.LBUTTONUP, "SCR_QUEST_SHARE_PARTY_MEMBER")
                share_party:SetEventScriptArgNumber(ui.LBUTTONUP, quest_id)
                if IS_SHARED_QUEST(quest_id) then
                    share_party:SetColorTone("FFFFFFFF")
                else
                    share_party:SetColorTone("FF696969")
                end
                table.insert(valid_quest_ids, quest_id_str)
                y = y + 30
            end
        end
    end
    local icon_align_x = 27 + max_text_width + 10
    for _, quest_id_str in ipairs(valid_quest_ids) do
        local share_party = save_quest:GetChild("share_party" .. quest_id_str)
        if share_party then
            share_party:SetOffset(icon_align_x, share_party:GetY())
        end
    end
    save_quest:Resize(icon_align_x + 30, y)
    save_quest:ShowWindow(1)
end

function Save_quest_ON_TARGET_SET(frame, msg, str, num)
    local handle = session.GetTargetHandle()
    local gen_type = world.GetActor(handle):GetNPCStateType()
    local pc = GetMyPCObject()
    local gen_list = SCR_GET_XML_IES('GenType_' .. GetZoneName(pc), 'GenType', gen_type)
    for i = 1, #gen_list do
        local gen_obj = gen_list[i]
        if g.save_quest_settings.save_quests[gen_obj.Dialog] == 1 then
            world.Leave(handle, 0.0)
            break
        end
    end
end

function Save_quest_SCR_QUEST_SHARE_PARTY_MEMBER()
    if g.settings.save_quest.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "save_quest")
        return
    end
    local save_quest = ui.GetFrame(addon_name_lower .. "save_quest")
    if save_quest then
        Save_quest_short_cut_set(save_quest)
    end
end

function Save_quest_short_cut_release(quest_id)
    g.save_quest_settings.short_cuts[tostring(quest_id)] = nil
    Save_quest_save_settings()
    if not next(g.save_quest_settings.short_cuts) then
        local save_quest = ui.GetFrame(addon_name_lower .. "save_quest")
        save_quest:Resize(0, 0)
        return
    else
        Save_quest_short_cut(nil)
    end
end
-- ワープ可能か判定
function Save_quest_is_warp(quest_cls)
    local result = SCR_QUEST_CHECK_C(GetMyPCObject(), quest_cls.ClassName)
    if not GET_QUEST_NPC_STATE(quest_cls, result) then
        return 0
    end
    if (result == 'POSSIBLE' and quest_cls.POSSI_WARP == 'YES') or
        (result == 'PROGRESS' and quest_cls.PROG_WARP == 'YES') or
        (result == 'SUCCESS' and quest_cls.SUCC_WARP == 'YES') then
        return 1
    end
    return 0
end
-- save_quest ここまで

-- my_buffs_control ここから
function My_buffs_control_save_settings()
    local json_data = {
        lock = g.my_buffs_control_settings.lock,
        default_x = g.my_buffs_control_settings.default_x,
        default_y = g.my_buffs_control_settings.default_y,
        custom_x = g.my_buffs_control_settings.custom_x,
        custom_y = g.my_buffs_control_settings.custom_y,
        ver = g.my_buffs_control_settings.ver
    }
    g.save_json(g.my_buffs_control_path, json_data)
    local file = io.open(g.my_buffs_control_dat_path, "w")
    if file then
        local lines = {}
        for id, val in pairs(g.my_buffs_control_settings.buffs) do
            if val ~= nil then
                table.insert(lines, tostring(id) .. ":::" .. tostring(val))
            end
        end
        if #lines > 0 then
            file:write(table.concat(lines, "\n"))
        end
        file:close()
    end
end

function My_buffs_control_load_settings()
    g.my_buffs_control_path = string.format("../addons/%s/%s/my_buffs_control.json", addon_name_lower, g.active_id)
    g.my_buffs_control_dat_path = string.format("../addons/%s/%s/my_buffs_control.dat", addon_name_lower, g.active_id)
    g.my_buffs_control_old_path = string.format("../addons/%s/settings_2503.json", "my_buffs")
    local settings = g.load_json(g.my_buffs_control_path)
    local ver = 1.2
    local need_init = false
    if not settings or not settings.ver or settings.ver < ver then
        settings = {
            lock = true,
            default_x = 20,
            default_y = 130,
            custom_x = 20,
            custom_y = 130,
            ver = ver,
            buffs = {}
        }
        need_init = true
    end
    if not settings.buffs then
        settings.buffs = {}
    end
    if need_init then
        local old_settings = g.load_json(g.my_buffs_control_old_path)
        if old_settings and old_settings.buffs then
            for id, is_visible in pairs(old_settings.buffs) do
                settings.buffs[tostring(id)] = (is_visible == true) and 1 or 0
            end
        end
        local cls_list, count = GetClassList("Buff")
        for i = 0, count - 1 do
            local buff_cls = GetClassByIndexFromList(cls_list, i)
            if buff_cls then
                if buff_cls.Group1 ~= 'Debuff' and buff_cls.Group1 ~= 'Deuff' then
                    local buff_id = tostring(buff_cls.ClassID)
                    -- 既に設定がある(移行された)場合は上書きしない
                    if settings.buffs[buff_id] == nil then
                        settings.buffs[buff_id] = 1
                    end
                end
            end
        end
    else
        local file = io.open(g.my_buffs_control_dat_path, "r")
        if file then
            for line in file:lines() do
                local id, val = string.match(line, "^(.-):::(.*)$")
                if id and val then
                    settings.buffs[id] = tonumber(val)
                end
            end
            file:close()
        end
    end
    g.my_buffs_control_settings = settings
    if need_init then
        My_buffs_control_save_settings()
    end
end

function my_buffs_control_on_init()
    if not g.my_buffs_control_settings then
        My_buffs_control_load_settings()
    end
    local old_func = g.settings.my_buffs_control.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.my_buffs_control.use == 1 then
        My_buffs_control_frame()
    else
        My_buffs_control_reset_ui()
    end
    if g.my_buffs_control_is_change then
        My_buffs_control_save_settings()
        g.my_buffs_control_is_change = false
    end
    if g.get_map_type() == 'City' then
        return
    end
    g.setup_hook_and_event(g.addon, "BUFF_ON_MSG", "My_buffs_control_BUFF_ON_MSG", true)
    g.addon:RegisterMsg("BUFF_ADD", "My_buffs_control_BUFF_ADD")
    My_buffs_control_common_buff_msg()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:RunUpdateScript("My_buffs_control_delayed_init", 1.0)
end

function My_buffs_control_delayed_init(_nexus_addons)
    My_buffs_control_common_buff_msg()
    return 0
end

function My_buffs_control_common_buff_msg()
    local buff_frame = ui.GetFrame("buff")
    local my_handle = session.GetMyHandle()
    local buff_count = info.GetBuffCount(my_handle)
    if g.settings.my_buffs_control.use == 0 then
        if type(_G["COMMON_BUFF_MSG_OLD"]) == "function" then
            COMMON_BUFF_MSG_OLD(buff_frame, "CLEAR", 0, 0, s_buff_ui, 0)
        else
            COMMON_BUFF_MSG(buff_frame, "CLEAR", 0, 0, s_buff_ui, 0)
        end
        for i = 0, buff_count - 1 do
            local buff = info.GetBuffIndexed(my_handle, i)
            if buff then
                g.FUNCS["BUFF_ON_MSG"](buff_frame, "BUFF_ADD", tostring(buff.index), buff.buffID)
            end
        end
    else
        local displayed_buffs = {}
        for group_index = 0, s_buff_ui["buff_group_cnt"] do
            if s_buff_ui["slotlist"][group_index] and s_buff_ui["slotcount"][group_index] then
                for i = 0, s_buff_ui["slotcount"][group_index] - 1 do
                    local slot = s_buff_ui["slotlist"][group_index][i]
                    if slot:IsVisible() == 1 then
                        local icon = slot:GetIcon()
                        if icon then
                            local info = icon:GetInfo()
                            displayed_buffs[info.type] = {
                                index = tostring(icon:GetUserIValue("BuffIndex"))
                            }
                        end
                    end
                end
            end
        end
        local player_buffs = {}
        for i = 0, buff_count - 1 do
            local buff = info.GetBuffIndexed(my_handle, i)
            if buff and BUFF_CHECK_SEPARATELIST(buff.buffID) ~= true then
                local is_debuff = false
                local cls = GetClassByType('Buff', buff.buffID)
                if cls and (cls.Group1 == 'Debuff' or cls.Group1 == 'Deuff') then
                    is_debuff = true
                end
                player_buffs[buff.buffID] = {
                    index = buff.index,
                    is_debuff = is_debuff
                }
            end
        end
        for buff_id, data in pairs(displayed_buffs) do
            local str_buff_id = tostring(buff_id)
            local current_buff = player_buffs[buff_id]
            if current_buff then
                if not current_buff.is_debuff and g.my_buffs_control_settings.buffs[str_buff_id] ~= 1 then
                    if type(_G["COMMON_BUFF_MSG_OLD"]) == "function" then
                        COMMON_BUFF_MSG_OLD(buff_frame, "REMOVE", buff_id, my_handle, s_buff_ui, data.index)
                    else
                        COMMON_BUFF_MSG(buff_frame, "REMOVE", buff_id, my_handle, s_buff_ui, data.index)
                    end
                end
            end
        end
        for buff_id, data in pairs(player_buffs) do
            local str_buff_id = tostring(buff_id)
            if not displayed_buffs[buff_id] then
                if data.is_debuff or g.my_buffs_control_settings.buffs[str_buff_id] == 1 then
                    if type(_G["COMMON_BUFF_MSG_OLD"]) == "function" then
                        COMMON_BUFF_MSG_OLD(buff_frame, "ADD", buff_id, my_handle, s_buff_ui, data.index)
                    else
                        COMMON_BUFF_MSG(buff_frame, "ADD", buff_id, my_handle, s_buff_ui, data.index)
                    end
                end
            end
        end
    end
end

function My_buffs_control_BUFF_ON_MSG(my_frame, my_msg)
    local frame, msg, str, num = g.get_event_args(my_msg)
    if g.settings.my_buffs_control.use == 0 then
        return
    end
    if g.get_map_type() == 'City' then
        return
    end
    local buff = ui.GetFrame("buff")
    local handle = session.GetMyHandle()
    local str_buff_id = tostring(num)
    local is_debuff = false
    local cls = GetClassByType('Buff', num)
    if cls and (cls.Group1 == 'Debuff' or cls.Group1 == 'Deuff') then
        is_debuff = true
    end
    if not is_debuff and g.my_buffs_control_settings.buffs[str_buff_id] ~= 1 then
        if BUFF_CHECK_SEPARATELIST(num) == true then
            return
        end
        if type(_G["COMMON_BUFF_MSG_OLD"]) == "function" then
            COMMON_BUFF_MSG_OLD(frame, "REMOVE", num, handle, s_buff_ui, str)
        else
            COMMON_BUFF_MSG(frame, "REMOVE", num, handle, s_buff_ui, str)
        end
        MY_BUFF_TIME_UPDATE(buff)
        BUFF_RESIZE(buff, s_buff_ui)
        return
    end
end

function My_buffs_control_reset_ui()
    local buff = ui.GetFrame("buff")
    if buff then
        AUTO_CAST(buff)
        buff:SetPos(g.my_buffs_control_settings.default_x, g.my_buffs_control_settings.default_y)
        buff:RemoveChild("lock_slot")
        g.my_buffs_control_settings.lock = true
        buff:EnableHittestFrame(0)
        buff:EnableMove(0)
        buff:SetEventScript(ui.LBUTTONUP, "None")
    end
end

function My_buffs_control_frame()
    if g.settings.my_buffs_control.use == 0 then
        My_buffs_control_reset_ui()
        return
    end
    local buff = ui.GetFrame("buff")
    AUTO_CAST(buff)
    buff:SetEventScript(ui.LBUTTONUP, "My_buffs_control_end_drag")
    if g.get_map_type() ~= 'City' then
        buff:SetPos(g.my_buffs_control_settings.custom_x, g.my_buffs_control_settings.custom_y)
    else
        buff:SetPos(g.my_buffs_control_settings.default_x, g.my_buffs_control_settings.default_y)
    end
    buff:SetLayerLevel(61)
    buff:RemoveChild("lock_slot")
    local lock_slot = buff:CreateOrGetControl('slot', "lock_slot", 0, 0, 20, 30)
    AUTO_CAST(lock_slot)
    lock_slot:SetTextTooltip(g.lang == "Japanese" and
                                 "{ol}[MBC]{nl}左クリック:フレームを動かせる様に{nl} {nl}{#FF0000}街では全て表示します" or
                                 "{ol}[MBC]{nl}Left Click: Make frame movable{nl} {nl}{#FF0000}Show all in town")
    lock_slot:SetEventScript(ui.LBUTTONUP, "My_buffs_control_frame_lock")
    local lock = lock_slot:CreateOrGetControlSet('inv_itemlock', "lock", 0, 0)
    AUTO_CAST(lock)
    lock:SetGravity(ui.LEFT, ui.TOP)
    if g.my_buffs_control_settings.lock then
        lock:SetGrayStyle(0)
    else
        lock:SetGrayStyle(1)
    end
end

function My_buffs_control_end_drag(buff, ctrl, str, num)
    g.my_buffs_control_settings.custom_x = buff:GetX()
    g.my_buffs_control_settings.custom_y = buff:GetY()
    My_buffs_control_save_settings()
end

function My_buffs_control_frame_lock(buff, lock_slot)
    local lock = GET_CHILD(lock_slot, "lock")
    if g.my_buffs_control_settings.lock then
        g.my_buffs_control_settings.lock = false
        lock:SetGrayStyle(1)
        buff:EnableHittestFrame(1)
        buff:EnableMove(1)
    else
        g.my_buffs_control_settings.lock = true
        lock:SetGrayStyle(0)
        buff:EnableHittestFrame(0)
        buff:EnableMove(0)
    end
    My_buffs_control_save_settings()
end

function My_buffs_control_setting_menu()
    local list_frame_name = addon_name_lower .. "list_frame"
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local my_buffs_control_setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "my_buffs_control_setting",
        0, 0, 0, 0)
    my_buffs_control_setting:Resize(250, 180)
    my_buffs_control_setting:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    my_buffs_control_setting:SetSkinName("test_frame_low")
    my_buffs_control_setting:EnableHittestFrame(1)
    my_buffs_control_setting:EnableHitTest(1)
    my_buffs_control_setting:ShowWindow(1)
    my_buffs_control_setting:SetLayerLevel(999)
    local title_text = my_buffs_control_setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}My Buffs Control Config")
    local close = my_buffs_control_setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "My_buffs_control_frame_close")
    local gbox = my_buffs_control_setting:CreateOrGetControl("groupbox", "gbox", 10, 40,
        my_buffs_control_setting:GetWidth() - 20, my_buffs_control_setting:GetHeight() - 50)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local list_open_btn = gbox:CreateOrGetControl('button', 'list_open_btn', 10, 10, 130, 30)
    AUTO_CAST(list_open_btn)
    list_open_btn:SetText("{ol}Buff list")
    list_open_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}バフリスト表示" or "{ol}Buff list Open")
    list_open_btn:SetEventScript(ui.LBUTTONUP, "My_buffs_control_buff_list_open")
    local org_pos = gbox:CreateOrGetControl('button', 'org_pos', 10, 50, 130, 30)
    AUTO_CAST(org_pos)
    org_pos:SetText("Default Pos")
    org_pos:SetTextTooltip(g.lang == "Japanese" and "{ol}バフ欄の位置を元に戻します" or
                               "{ol}Restore the buff frame position to default")
    org_pos:SetEventScript(ui.LBUTTONUP, "My_buffs_control_original_position")
    local text = gbox:CreateOrGetControl('richtext', 'text', 10, 100, 150, 30)
    AUTO_CAST(text)
    text:SetText(g.lang == "Japanese" and "{ol}{#FF0000}※街では全て表示します" or
                     "{ol}{#FF0000}※Show all in town")
end

function My_buffs_control_original_position()
    local buff = ui.GetFrame("buff")
    buff:SetPos(g.my_buffs_control_settings.default_x, g.my_buffs_control_settings.default_y)
    g.my_buffs_control_settings.custom_x = g.my_buffs_control_settings.default_x
    g.my_buffs_control_settings.custom_y = g.my_buffs_control_settings.default_y
    My_buffs_control_save_settings()
end

function My_buffs_control_frame_close(frame, ctrl, str, num)
    ui.DestroyFrame(frame:GetName())
end

function My_buffs_control_buff_list_search(my_buffs_control, ctrl, ctrl_text, num)
    local search_edit = GET_CHILD_RECURSIVELY(my_buffs_control, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        My_buffs_control_buff_list_open(my_buffs_control, ctrl, ctrl_text)
    else
        My_buffs_control_buff_list_open(my_buffs_control, ctrl, "")
    end
end

function My_buffs_control_buff_list_open(frame, ctrl, ctrl_text, num)
    local my_buffs_control = ui.GetFrame(addon_name_lower .. "my_buffs_control")
    if not my_buffs_control then
        my_buffs_control = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "my_buffs_control", 0, 0, 0, 0)
        AUTO_CAST(my_buffs_control)
        my_buffs_control:SetSkinName("test_frame_low")
        my_buffs_control:Resize(500, 1060)
        my_buffs_control:SetPos(150, 10)
        my_buffs_control:SetLayerLevel(121)
        local search_edit = my_buffs_control:CreateOrGetControl("edit", "search_edit", 40, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "My_buffs_control_buff_list_search")
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "My_buffs_control_buff_list_search")
        local close = my_buffs_control:CreateOrGetControl('button', 'close', 0, 0, 20, 20)
        AUTO_CAST(close)
        close:SetImage("testclose_button")
        close:SetGravity(ui.RIGHT, ui.TOP)
        close:SetEventScript(ui.LBUTTONUP, "My_buffs_control_frame_close")
    end
    local buff_list_gb = my_buffs_control:CreateOrGetControl("groupbox", "buff_list_gb", 10, 50, 480,
        my_buffs_control:GetHeight() - 60)
    AUTO_CAST(buff_list_gb)
    buff_list_gb:SetSkinName("bg")
    buff_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Buff")
    local all_buffs = {}
    for i = 0, count - 1 do
        local buff_cls = GetClassByIndexFromList(cls_list, i)
        if buff_cls then
            if buff_cls.Group1 ~= 'Debuff' and buff_cls.Group1 ~= 'Deuff' then
                local buff_name = dictionary.ReplaceDicIDInCompStr(buff_cls.Name)
                if not ctrl_text or ctrl_text == "" or string.find(buff_name, ctrl_text) then
                    local image_name = GET_BUFF_ICON_NAME(buff_cls)
                    if image_name ~= "icon_None" and buff_name ~= "None" then
                        local is_checked = g.my_buffs_control_settings.buffs[tostring(buff_cls.ClassID)] == 1
                        table.insert(all_buffs, {
                            cls = buff_cls,
                            name = buff_name,
                            image = image_name,
                            is_checked = is_checked
                        })
                    end
                end
            else
                if g.my_buffs_control_settings.buffs[tostring(buff_cls.ClassID)] then
                    g.my_buffs_control_settings.buffs[tostring(buff_cls.ClassID)] = nil
                end
            end
        end
    end
    My_buffs_control_save_settings()
    table.sort(all_buffs, function(a, b)
        if a.is_checked and not b.is_checked then
            return true
        elseif not a.is_checked and b.is_checked then
            return false
        else
            return a.cls.ClassID < b.cls.ClassID
        end
    end)
    local y = 0
    for _, buff_data in ipairs(all_buffs) do
        local buff_cls = buff_data.cls
        local buff_id = buff_cls.ClassID
        local buff_slot = buff_list_gb:CreateOrGetControl('slot', 'buffslot' .. buff_id, 10, y + 5, 30, 30)
        AUTO_CAST(buff_slot)
        SET_SLOT_IMG(buff_slot, buff_data.image)
        local icon = CreateIcon(buff_slot)
        AUTO_CAST(icon)
        icon:SetTooltipType('buff')
        icon:SetTooltipArg(buff_data.name, buff_id, 0)
        local buff_check = buff_list_gb:CreateOrGetControl('checkbox', 'buff_check' .. buff_id, 50, y + 10, 200, 30)
        AUTO_CAST(buff_check)
        buff_check:SetText("{ol}" .. buff_id .. " : " .. buff_data.name)
        buff_check:SetTextTooltip(g.lang == "Japanese" and "チェックを外すとバフを非表示にします" or
                                      "Unchecking hides the buff")
        buff_check:SetCheck(buff_data.is_checked and 1 or 0)
        buff_check:SetEventScript(ui.LBUTTONUP, "My_buffs_control_buff_toggle")
        buff_check:SetEventScriptArgString(ui.LBUTTONUP, buff_id)
        y = y + 35
    end
    my_buffs_control:ShowWindow(1)
end

function My_buffs_control_buff_toggle(frame, ctrl, str_buff_id, num)
    local is_check = ctrl:IsChecked()
    if is_check == 1 then
        g.my_buffs_control_settings.buffs[str_buff_id] = 1
    else
        g.my_buffs_control_settings.buffs[str_buff_id] = nil
    end
    My_buffs_control_save_settings()
end

function My_buffs_control_BUFF_ADD(frame, ctrl, str, buff_id)
    local str_buff_id = tostring(buff_id)
    local buff_cls = GetClassByType("Buff", buff_id)
    if buff_cls.Group1 ~= 'Debuff' and buff_cls.Group1 ~= 'Deuff' then
        if not g.my_buffs_control_settings.buffs[str_buff_id] then
            g.my_buffs_control_settings.buffs[str_buff_id] = 1
            g.my_buffs_control_is_change = true
        end
    end
end
-- my_buffs_control ここまで

-- status_point_check ここから
function status_point_check_on_init()
    if g.settings.status_point_check.use == 0 then
        local status = ui.GetFrame("status")
        DESTROY_CHILD_BYNAME(status, "spc_btn")
        return
    end
    g.setup_hook_and_event(g.addon, "STATUS_TAB_CHANGE", "Status_point_check_STATUS_TAB_CHANGE", true)
end

function Status_point_check_frame()
    Status_point_check_toggle_frame()
end

function Status_point_check_STATUS_TAB_CHANGE(my_frame, my_msg)
    if g.settings.status_point_check.use == 0 then
        local status = ui.GetFrame("status")
        DESTROY_CHILD_BYNAME(status, "spc_btn")
        return
    end
    local status = g.get_event_args(my_msg)
    local statusTab = status:GetChild('statusTab')
    AUTO_CAST(statusTab)
    local index = statusTab:GetSelectItemIndex()
    if index == 0 then
        local spc_btn = status:CreateOrGetControl("button", "spc_btn", 350, 140, 120, 40) -- 350, 140, 120, 40
        AUTO_CAST(spc_btn)
        spc_btn:SetSkinName("test_pvp_btn")
        spc_btn:SetFontName("white_16_ol")
        spc_btn:SetText(g.lang == "Japanese" and "{@st66b}クエスト確認" or "{@st66b}Check Quest")
        spc_btn:SetTextTooltip(g.lang == "Japanese" and
                                   "{ol}ステータスポイントがもらえるクエストを{nl}クリアしているかどうか確認できます" or
                                   "{ol}Check whether you are clearing quests{nl}that receive status points")
        spc_btn:SetClickSound("button_click_big")
        spc_btn:SetOverSound("button_over")
        spc_btn:SetAnimation("MouseOnAnim", "btn_mouseover")
        spc_btn:SetAnimation("MouseOffAnim", "btn_mouseoff")
        spc_btn:SetEventScript(ui.LBUTTONDOWN, "Status_point_check_toggle_frame")
    else
        DESTROY_CHILD_BYNAME(status, "spc_btn")
    end
end

function Status_point_check_toggle_frame(frame, ctrl)
    local status_point_check = ui.GetFrame(addon_name_lower .. "status_point_check")
    if status_point_check and status_point_check:IsVisible() == 1 then
        ui.DestroyFrame(addon_name_lower .. "status_point_check")
        return
    end
    if not status_point_check then
        status_point_check = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "status_point_check", 0, 0, 0, 0)
        AUTO_CAST(status_point_check)
    end
    status_point_check:SetSkinName("collection_complete")
    status_point_check:SetPos(510, 100)
    status_point_check:Resize(950, 850)
    status_point_check:SetLayerLevel(99)
    status_point_check:SetTitleBarSkin("None")
    status_point_check:SetSkinName('None')
    local big_bg = status_point_check:CreateOrGetControl("groupbox", "big_bg", 950, 850, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(big_bg)
    big_bg:SetSkinName("test_frame_low")
    local title_bg = big_bg:CreateOrGetControl("groupbox", "title_bg", 950, 64, ui.LEFT, ui.TOP, 0, 0, 0, 0)
    AUTO_CAST(title_bg)
    title_bg:SetSkinName("test_frame_top")
    local title = big_bg:CreateOrGetControl("richtext", "title", 100, 30, ui.CENTER_HORZ, ui.TOP, 0, 18, 0, 0)
    title:SetText("{@st43}{s22}Status Point Check{/}")
    title:EnableHitTest(false)
    local close = title_bg:CreateOrGetControl("button", "close", 44, 44, ui.RIGHT, ui.TOP, 0, 20, 27, 0)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetClickSound("button_click_big")
    close:SetOverSound("button_over")
    close:SetAnimation("MouseOnAnim", "btn_mouseover")
    close:SetAnimation("MouseOffAnim", "btn_mouseoff")
    close:SetEventScript(ui.LBUTTONDOWN, "Status_point_check_toggle_frame")
    local tab = big_bg:CreateOrGetControl("tab", "tab", 930, 40, ui.LEFT, ui.TOP, 22, 65, 0, 0)
    AUTO_CAST(tab)
    tab:SetEventScript(ui.LBUTTONUP, "Status_point_check_tab_change")
    tab:SetSkinName("tab2")
    tab:AddItem("{@st66b}Status", true, "", "", "", "", "", false)
    tab:AddItem("{@st66b}Zemina", true, "", "", "", "", "", false)
    tab:AddItem("{@st66b}Master Quest", true, "", "", "", "", "", false)
    tab:SetItemsFixWidth(150)
    tab:SetItemsAdjustFontSizeByWidth(150)
    local bg = big_bg:CreateOrGetControl("groupbox", "bg", 910, 725, ui.LEFT, ui.TOP, 20, 105, 0, 0)
    AUTO_CAST(bg)
    bg:SetSkinName("test_frame_midle")
    Status_point_check_tab_change(big_bg, tab)
    status_point_check:ShowWindow(1)
end

function Status_point_check_tab_change(big_bg, tab, str, num)
    local bg = GET_CHILD(big_bg, "bg")
    AUTO_CAST(bg)
    bg:RemoveAllChild()
    local index = tab:GetSelectItemIndex()
    if index == 0 then
        Status_point_check_quest_list(big_bg, bg)
    elseif index == 1 then
        Status_point_check_zemina_list(big_bg, bg)
    elseif index == 2 then
        Status_point_check_master_quest_list(big_bg, bg)
    end
end

function Status_point_check_master_quest_list(big_bg, bg)
    local title = bg:CreateOrGetControl("richtext", "title", 15, 5, 0, 0)
    AUTO_CAST(title)
    title:SetFontName("white_18_ol")
    title:SetText("Quest List For Master Quest")
    local start_map = bg:CreateOrGetControl("richtext", "start_map", 545, 5, 0, 0)
    AUTO_CAST(start_map)
    start_map:SetFontName("white_18_ol")
    start_map:SetText("Quest Start Map")
    local y = 35
    local quests, quests_cnt = GetClassList("QuestProgressCheck_Auto")
    for i = 0, quests_cnt - 1 do
        local quest_cls = GetClassByIndexFromList(quests, i)
        if quest_cls.Success_ItemName1 == "Point_Stone_100_Q" then -- ts("{img quest_detail_pic2 24 24}")
            local script_btn = bg:CreateOrGetControl("button", "script_btn" .. i, 15, y, 20, 20)
            AUTO_CAST(script_btn)
            script_btn:SetSkinName("None")
            script_btn:SetText("{img quest_detail_pic2 20 20}")
            script_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}クエスト詳細表示" or
                                          "{ol}Show quest information")
            script_btn:SetEventScript(ui.LBUTTONDOWN, "QUEST_CLICK_INFO")
            script_btn:SetEventScriptArgNumber(ui.LBUTTONDOWN, quest_cls.ClassID)
            local quest_name = bg:CreateOrGetControl("richtext", "quest_name" .. i, 40, y, 0, 20)
            AUTO_CAST(quest_name)
            local quest_result = bg:CreateOrGetControl("richtext", "quest_result" .. i, 400, y, 0, 20)
            AUTO_CAST(quest_result)
            local map_name = bg:CreateOrGetControl("richtext", "map_name" .. i, 550, y, 0, 20)
            AUTO_CAST(map_name)
            local color = ""
            local result = ""
            if Status_point_check_quest_clear_check(quest_cls) then
                color = "{#FF3333}{ol}{b}{s16}"
                result = "OK"
            else
                color = "{#666666}{ol}{b}{s16}"
                result = "NO"
                local quest = GetClassByType('QuestProgressCheck', quest_cls.ClassID)
                local map_prop = geMapTable.GetMapProp(quest.StartMap)
                if map_prop then
                    local map_name_ = dictionary.ReplaceDicIDInCompStr(map_prop:GetName())
                    map_name:SetText(color .. map_name_ .. "[Level:" .. quest.Level .. "]")
                else
                    map_name:SetText(color .. "??[Level:" .. quest.Level .. "]")
                end
            end
            quest_name:SetText(color .. quest_cls.Name)
            quest_result:SetText(color .. result)
            y = y + 24
        end
    end
end

function Status_point_check_quest_list(big_bg, bg)
    local y = Status_point_check_quest_check(big_bg, bg)
    Status_point_check_status_quest_check(big_bg, bg, y)
end

function Status_point_check_zemina_list(big_bg, bg)
    local title = bg:CreateOrGetControl("richtext", "title", 15, 5, 0, 0)
    AUTO_CAST(title)
    title:SetFontName("white_18_ol")
    title:SetText("Zemina List")
    local y = 35
    local ui_index = 0
    local maps, maps_cnt = GetClassList("Map")
    for i = 0, maps_cnt - 1 do
        local map_cls = GetClassByIndexFromList(maps, i)
        local count = GetClassCount('GenType_' .. map_cls.ClassName)
        if count > 0 then
            for j = 0, count - 1 do
                local npc_cls = GetClassByIndex('GenType_' .. map_cls.ClassName, j)
                if npc_cls.ClassType == "statue_zemina" then
                    local map_name = bg:CreateOrGetControl("richtext", "map_name" .. ui_index, 20, y, 0, 20)
                    AUTO_CAST(map_name)
                    local zemina_result = bg:CreateOrGetControl("richtext", "zemina_result" .. ui_index, 400, y, 0, 20)
                    AUTO_CAST(zemina_result)
                    local color = ""
                    local result = ""
                    local state = GetNPCState(map_cls.ClassName, npc_cls.GenType)
                    if state == 20 or state == 1 then
                        color = "{#FF3333}{ol}{b}{s16}"
                        result = "OK"
                    else
                        color = "{#666666}{ol}{b}{s16}"
                        result = "NO"
                    end
                    map_name:SetText(color .. map_cls.Name)
                    zemina_result:SetText(color .. result)
                    y = y + 25
                    ui_index = ui_index + 1
                    break
                end
            end
        end
    end
end

function Status_point_check_status_quest_check(big_bg, bg, y)
    local title_2 = bg:CreateOrGetControl("richtext", "title_2", 15, y + 10, 0, 0)
    AUTO_CAST(title_2)
    title_2:SetFontName("white_18_ol")
    title_2:SetText("Quest List For Status")
    local start_map_2 = bg:CreateOrGetControl("richtext", "start_map_2", 545, y + 10, 0, 0)
    AUTO_CAST(start_map_2)
    start_map_2:SetFontName("white_18_ol")
    start_map_2:SetText("Quest Start Map")
    local rewards, rewards_cnt = GetClassList("reward_property")
    local y = y + 40
    for i = 0, rewards_cnt - 1 do
        local reward_cls = GetClassByIndexFromList(rewards, i)
        if reward_cls.Property ~= "None" and reward_cls.Property ~= "AchievePoint" then
            local quest_cls = GetClass("QuestProgressCheck_Auto", reward_cls.ClassName)
            local script_btn = bg:CreateOrGetControl("button", "script_btn" .. i, 15, y, 20, 20)
            AUTO_CAST(script_btn)
            script_btn:SetSkinName("None")
            script_btn:SetText("{img quest_detail_pic2 20 20}")
            script_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}クエスト詳細表示" or
                                          "{ol}Show quest information")
            script_btn:SetEventScript(ui.LBUTTONDOWN, "QUEST_CLICK_INFO")
            script_btn:SetEventScriptArgNumber(ui.LBUTTONDOWN, quest_cls.ClassID)
            local quest_name_2 = bg:CreateOrGetControl("richtext", "quest_name_2" .. i, 40, y, 0, 0)
            AUTO_CAST(quest_name_2)
            local quest_result_2 = bg:CreateOrGetControl("richtext", "quest_result_2" .. i, 400, y, 0, 0)
            AUTO_CAST(quest_result_2)
            local point_2 = bg:CreateOrGetControl("richtext", "point_2" .. i, 440, y, 0, 0)
            AUTO_CAST(point_2)
            local map_2 = bg:CreateOrGetControl("richtext", "map_2" .. i, 550, y, 0, 0)
            AUTO_CAST(map_2)
            local color = ""
            local result = "" -- ClMsg(reward_cls.Property)
            if Status_point_check_quest_clear_check(quest_cls) then
                color = "{#FF3333}{ol}{b}{s16}"
                result = "OK"
            else
                color = "{#666666}{ol}{b}{s16}"
                result = "NO"
                local quest = GetClass("QuestProgressCheck", quest_cls.ClassName)
                local map_prop = geMapTable.GetMapProp(quest.StartMap)
                if map_prop then
                    local map_name = dictionary.ReplaceDicIDInCompStr(map_prop:GetName())
                    map_2:SetText(color .. map_name .. "[Level:" .. quest.Level .. "]")
                else
                    map_2:SetText(color .. "??[Level:" .. quest.Level .. "]")
                end
            end
            quest_name_2:SetText(color .. quest_cls.Name)
            quest_result_2:SetText(color .. result)
            if reward_cls.Property == "MaxWeight" then
                local suffix = g.lang == "Japanese" and "所持量" .. " + " .. reward_cls.Value or "Weight" .. " + " ..
                                   reward_cls.Value
                point_2:SetText(color .. suffix)
            else
                point_2:SetText(color .. ClMsg(reward_cls.Property) .. " + " .. reward_cls.Value)
            end
            y = y + 25
        end
    end
end

function Status_point_check_quest_check(big_bg, bg)
    local title = bg:CreateOrGetControl("richtext", "title", 15, 5, 0, 0)
    AUTO_CAST(title)
    local start_map = bg:CreateOrGetControl("richtext", "start_map", 545, 5, 0, 0)
    AUTO_CAST(start_map)
    start_map:SetFontName("white_18_ol")
    start_map:SetText("Quest Start Map")
    local quests, quest_cnt = GetClassList("QuestProgressCheck_Auto")
    local sum_point = 0
    local get_point = 0
    local y = 35
    for i = 0, quest_cnt - 1 do
        local quest_cls = GetClassByIndexFromList(quests, i)
        if quest_cls.Success_StatByBonus and quest_cls.Success_StatByBonus > 0 then
            sum_point = sum_point + quest_cls.Success_StatByBonus
            local script_btn = bg:CreateOrGetControl("button", "script_btn" .. i, 15, y, 20, 20)
            AUTO_CAST(script_btn)
            script_btn:SetSkinName("None")
            script_btn:SetText("{img quest_detail_pic2 20 20}")
            script_btn:SetTextTooltip(g.lang == "Japanese" and "{ol}クエスト詳細表示" or
                                          "{ol}Show quest information")
            script_btn:SetEventScript(ui.LBUTTONDOWN, "QUEST_CLICK_INFO")
            script_btn:SetEventScriptArgNumber(ui.LBUTTONDOWN, quest_cls.ClassID)
            local quest_name = bg:CreateOrGetControl("richtext", "quest_name" .. i, 40, y, 0, 0)
            AUTO_CAST(quest_name)
            local quest_result = bg:CreateOrGetControl("richtext", "quest_result" .. i, 400, y, 0, 0)
            AUTO_CAST(quest_result)
            local point = bg:CreateOrGetControl("richtext", "point" .. i, 440, y, 0, 0)
            AUTO_CAST(point)
            local map = bg:CreateOrGetControl("richtext", "map" .. i, 550, y, 0, 0)
            AUTO_CAST(map)
            local color = ""
            local result = ""
            if Status_point_check_quest_clear_check(quest_cls) then
                color = "{#FF3333}{ol}{b}{s16}"
                result = "OK"
                get_point = get_point + quest_cls.Success_StatByBonus
            else
                color = "{#666666}{ol}{b}{s16}"
                result = "NO"
                local quest = GetClassByType('QuestProgressCheck', quest_cls.ClassID)
                local map_prop = geMapTable.GetMapProp(quest.StartMap)
                if map_prop then
                    local map_name = dictionary.ReplaceDicIDInCompStr(map_prop:GetName())
                    map:SetText(color .. map_name .. "[Level:" .. quest.Level .. "]")
                else
                    map:SetText(color .. "??[Level:" .. quest.Level .. "]")
                end
            end
            quest_name:SetText(color .. quest_cls.Name)
            quest_result:SetText(color .. result)
            point:SetText(color .. quest_cls.Success_StatByBonus .. " Point")
            y = y + 25
        end
    end
    title:SetFontName("white_18_ol")
    title:SetText("Quest List For Status Point (" .. get_point .. "/" .. sum_point .. ")")
    return y
end

function Status_point_check_quest_clear_check(quest_cls)
    local result = SCR_QUEST_CHECK(GetMyPCObject(), quest_cls.ClassName)
    if result == 'SUCCESS' or result == 'COMPLETE' then
        return true
    end
    return false
end
-- status_point_check ここまで

-- silent_velnice_ranking ここから
function silent_velnice_ranking_on_init()
    if g.settings.silent_velnice_ranking.use == 0 then
        return
    end
    if g.map_id == 8022 then
        g.addon:RegisterMsg("DO_SOLODUNGEON_SCOREBOARD_OPEN", "Silent_velnice_ranking_SOLODUNGEON_SCOREBOARD_OPEN")
    end
end

function Silent_velnice_ranking_SOLODUNGEON_SCOREBOARD_OPEN(frame, msg)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:SetVisible(1)
    local silent_velnice_ranking_timer = _nexus_addons:CreateOrGetControl("timer", "silent_velnice_ranking_timer", 0, 0)
    AUTO_CAST(silent_velnice_ranking_timer)
    silent_velnice_ranking_timer:SetUpdateScript("Silent_velnice_ranking_keypress")
    silent_velnice_ranking_timer:Start(0.2)
end

function Silent_velnice_ranking_keypress(_nexus_addons, silent_velnice_ranking_timer)
    local solodungeonscoreboard = ui.GetFrame("solodungeonscoreboard")
    if 1 == keyboard.IsKeyPressed("TAB") then
        SOLODUNGEON_SCOREBOARD_OPEN(nil, nil, nil, nil)
        silent_velnice_ranking_timer:Stop()
        return
    end
    if solodungeonscoreboard:IsVisible() == 1 then
        solodungeonscoreboard:ShowWindow(0)
    end
end
-- silent_velnice_ranking ここまで

-- skill_gem_tooltip ここから
function skill_gem_tooltip_on_init()
    local old_func = g.settings.skill_gem_tooltip.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, "UPDATE_ITEM_TOOLTIP", "Skill_gem_tooltip_UPDATE_ITEM_TOOLTIP", true)
end

function Skill_gem_tooltip_UPDATE_ITEM_TOOLTIP(my_frame, my_msg)
    if g.settings.skill_gem_tooltip.use == 0 then
        return
    end
    local tooltip_frame, str_arg, class_id, item_guid, user_data, arg_6, arg_7 = g.get_event_args(my_msg)
    local rect = tooltip_frame:GetMargin()
    local skill_name
    if str_arg == "inven" then
        local item_obj, is_read_obj = GET_TOOLTIP_ITEM_OBJECT(str_arg, item_guid, class_id)
        class_id = item_obj.ClassID
    end
    local item_cls = GetClassByType('Item', class_id)
    if not item_cls or TryGetProp(item_cls, 'StringArg', 'None') ~= 'SkillGem' then
        return
    end
    local skill_name = TryGetProp(item_cls, 'SkillName', 'None')
    if skill_name == 'None' then
        return
    end
    local skill_cls = GetClass('Skill', skill_name)
    if not skill_cls then
        return
    end
    local sub_frame_name = addon_name_lower .. "skill_gem_sub_tooltip"
    local sub_frame = ui.GetFrame(sub_frame_name)
    if not sub_frame then
        sub_frame = ui.CreateNewFrame("notice_on_pc", sub_frame_name, 0, 0, 0, 0)
        AUTO_CAST(sub_frame)
    end
    local template_frame = ui.GetTooltipFrame("skill")
    sub_frame:CloneFrom(template_frame)
    sub_frame:Resize(template_frame:GetWidth(), template_frame:GetHeight())
    sub_frame:RemoveAllChild()
    local function clone_child(src, dest)
        for i = 0, src:GetChildCount() - 1 do
            local child_src = src:GetChildByIndex(i)
            local child_dest = dest:CreateOrGetControl(child_src:GetClassName(), child_src:GetName(), child_src:GetX(),
                child_src:GetY(), child_src:GetWidth(), child_src:GetHeight())
            AUTO_CAST(child_dest)
            child_dest:CloneFrom(child_src)
            if child_src:GetChildCount() > 0 then
                clone_child(child_src, child_dest)
            end
        end
    end
    clone_child(template_frame, sub_frame)
    UPDATE_SKILL_TOOLTIP(sub_frame, str_arg, skill_cls.ClassID, 1, nil, nil)
    local skill_desc = sub_frame:GetChild("skill_desc")
    if skill_desc then
        AUTO_CAST(skill_desc)
        local skill_full_name = TryGetProp(item_cls, 'SkillName', 'None')
        local parts = StringSplit(skill_full_name, '_')
        local job_eng_name = parts[1]
        local suffix_key = parts[3]
        local job_suffix_map = {
            ["Archer"] = "[A]",
            ["Scout"] = "[T]",
            ["Cleric"] = "[C]",
            ["Swordman"] = "[S]",
            ["Wizard"] = "[W]"
        }
        local suffix = job_suffix_map[suffix_key] or ""
        local job_name_fix_map = {
            ["Outlaw"] = "OutLaw",
            ["FrostMage"] = "Cryomancer",
            ["Lancer"] = "Rancer",
            ["FireMage"] = "Pyromancer",
            ["Warrior"] = "Swordman",
            ["Templar"] = "Templer"
        }
        job_eng_name = job_name_fix_map[job_eng_name] or job_eng_name
        local list, cnt = GetClassList("Job")
        for i = 0, cnt - 1 do
            local job_cls = GetClassByIndexFromList(list, i)
            if job_cls then
                local eng_name = job_name_fix_map[job_cls.EngName] or job_cls.EngName
                if eng_name == job_eng_name then
                    local display_name = GET_JOB_NAME(job_cls, GETMYPCGENDER())
                    display_name = string.gsub(dic.getTranslatedStr(display_name), "%[.-%]", "") .. suffix
                    local mark_text = skill_desc:CreateOrGetControl("richtext", "mark_skillgem", 0, 0, 200, 20)
                    mark_text:SetText(string.format("{ol}{#999999}Skill Gem Tooltip{/}{nl}{s18}%s", display_name))
                    mark_text:SetOffset(20, 10)
                    mark_text:SetGravity(ui.LEFT, ui.TOP)
                    local rect = tooltip_frame:GetMargin()
                    if str_arg == "inven" then
                        sub_frame:SetGravity(ui.RIGHT, ui.TOP)
                        sub_frame:SetOffset(rect.right - 250 + tooltip_frame:GetWidth(), 190)
                    elseif str_arg == "char_belonging" then
                        sub_frame:SetGravity(ui.RIGHT, ui.TOP)
                        sub_frame:SetOffset(rect.right - 270 + tooltip_frame:GetWidth(), 255)
                    else
                        sub_frame:SetGravity(ui.LEFT, ui.TOP)
                        sub_frame:SetOffset(rect.left + tooltip_frame:GetWidth(), 255)
                    end
                    sub_frame:SetLayerLevel(tooltip_frame:GetLayerLevel() + 10)
                    sub_frame:RunUpdateScript("Skill_gem_tooltip_close", 0.1)
                    sub_frame:SetUserValue("FLAME_NAME", tooltip_frame:GetName())
                    sub_frame:ShowWindow(1)
                    return
                end
            end
        end
    end
end

function Skill_gem_tooltip_close(sub_frame)
    local obj = ui.GetFocusObject()
    if not obj then
        ui.DestroyFrame(addon_name_lower .. "skill_gem_sub_tooltip")
        return 0
    elseif obj:GetClassName() ~= "slot" then
        ui.DestroyFrame(addon_name_lower .. "skill_gem_sub_tooltip")
        return 0
    end
    return 1
end
-- skill_gem_tooltip ここまで

-- separate_buff_custom ここから
function Separate_buff_custom_save_settings()
    g.save_json(g.separate_buff_custom_path, g.separate_buff_custom_settings)
end

function Separate_buff_custom_load_settings()
    g.separate_buff_custom_path = string.format("../addons/%s/%s/separate_buff_custom.json", addon_name_lower,
        g.active_id)
    local settings = g.load_json(g.separate_buff_custom_path)
    if not settings then
        settings = {
            x = 0,
            y = 0,
            move = 1,
            sep_buffs = {},
            location_share = 0,
            tracking = 0
        }
    end
    g.separate_buff_custom_settings = settings
    Separate_buff_custom_save_settings()
end

function separate_buff_custom_on_init()
    if not g.separate_buff_custom_settings then
        Separate_buff_custom_load_settings()
    end
    g.setup_hook_and_event(g.addon, "BUFF_SEPARATEDLIST_CTRLSET_CREATE",
        "Separate_buff_custom_BUFF_SEPARATEDLIST_CTRLSET_CREATE", true)
    g.setup_hook_and_event(g.addon, "BUFF_SEPARATEDLIST_CTRLSET_REMOVE",
        "Separate_buff_custom_BUFF_SEPARATEDLIST_CTRLSET_REMOVE", true)
    g.setup_hook_and_event(g.addon, "BUFF_SEPARATEDLIST_ON_RELOAD", "Separate_buff_custom_BUFF_SEPARATEDLIST_ON_RELOAD",
        true)
    g.setup_hook_and_event(g.addon, "BUFF_SEPARATED_TIME_UPDATE", "Separate_buff_custom_BUFF_SEPARATED_TIME_UPDATE",
        false)
    g.separate_buff_custom_temp_buffs = {}
    Separate_buff_custom_frame_move()
end

function Separate_buff_custom_buff_separatedlist_save_pos(frame)
    local x = frame:GetX()
    local y = frame:GetY()
    local userID = session.loginInfo.GetUserID()
    local path = string.format('../release/addon_setting/buff_separatedlist/%s/settings.json', userID)
    local settings = g.load_json(path)
    if not settings then
        settings = {
            pc_id = {}
        }
    end
    if not settings.pc_id then
        settings.pc_id = {}
    end
    local cid = session.GetMySession():GetCID()
    if not settings.pc_id[g.cid] then
        settings.pc_id[cid] = {}
    end
    if not settings.pc_id[g.cid]["pos"] then
        settings.pc_id[g.cid]["pos"] = {}
    end
    local current_pos = settings.pc_id[cid].pos
    if current_pos.x ~= x or current_pos.y ~= y then
        current_pos.x = x
        current_pos.y = y
        g.save_json(path, settings)
    end
end

function Separate_buff_custom_BUFF_SEPARATED_TIME_UPDATE(my_frame, my_msg)
    local frame, timer, argstr, argnum, passedtime = g.get_event_args(my_msg)
    local myhandle = session.GetMyHandle()
    local TOKEN_BUFF_ID = TryGetProp(GetClass("Buff", "Premium_Token"), "ClassID")
    local gbox = GET_CHILD_RECURSIVELY(frame, "buffGBox")
    if gbox == nil then
        return
    end
    local updated = 0
    local cnt = gbox:GetChildCount()
    for i = 1, cnt do
        local ctrlSet = gbox:GetChildByIndex(i - 1)
        if ctrlSet ~= nil then
            local slot = GET_CHILD_RECURSIVELY(ctrlSet, "slot")
            local text = GET_CHILD_RECURSIVELY(ctrlSet, "caption")
            if slot:IsVisible() == 1 then
                local icon = slot:GetIcon()
                local iconInfo = icon:GetInfo()
                local buffIndex = icon:GetUserIValue("BuffIndex")
                local buff = info.GetBuff(myhandle, iconInfo.type, buffIndex)
                if buff ~= nil then
                    text:SetText(GET_BUFF_TIME_TXT(buff.time, 0))
                    updated = 1
                    if buff.time < 5000 and buff.time ~= 0.0 then
                        if slot:IsBlinking() == 0 then
                            slot:SetBlink(600000, 1.0, "55FFFFFF", 1)
                        end
                    elseif buff.buffID == TOKEN_BUFF_ID and GET_REMAIN_TOKEN_SEC() < 3600 then
                        if slot:IsBlinking() == 0 then
                            slot:SetBlink(0, 1.0, "55FFFFFF", 1)
                        end
                    else
                        if slot:IsBlinking() == 1 then
                            slot:ReleaseBlink()
                        end
                    end
                end
            end
        end
    end
    if updated == 1 then
        ui.UpdateVisibleToolTips("buff")
    end
end

function Separate_buff_custom_BUFF_SEPARATEDLIST_ON_RELOAD(my_frame, my_msg)
    local frame = g.get_event_args(my_msg)
    Separate_buff_custom_frame_move()
    if g.settings.separate_buff_custom.use == 0 then
        INIT_BUFF_SEPARATEDLIST_UI(frame)
        frame:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_separatedlist_save_pos")
    end
end

function Separate_buff_custom_restore_vanilla_position(frame)
    frame:EnableMove(1)
    frame:EnableHittestFrame(1)
    local path_format = string.format("../release/addon_setting/buff_separatedlist/%s/settings.json", g.active_id)
    local settings = g.load_json(path_format)
    if settings and settings.pc_id and settings.pc_id[g.cid] and settings.pc_id[g.cid].pos then
        local pos = settings.pc_id[g.cid].pos
        frame:MoveFrame(pos.x, pos.y)
    end
end

function Separate_buff_custom_frame_move()
    local frame = ui.GetFrame("buff_separatedlist")
    frame:StopUpdateScript("_FRAME_AUTOPOS")
    frame:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_end_drag")
    if g.settings.separate_buff_custom.use == 0 then
        Separate_buff_custom_restore_vanilla_position(frame)
        return
    end
    if (g.separate_buff_custom_settings.location_share == 0 and g.separate_buff_custom_settings.tracking == 0) then
        Separate_buff_custom_restore_vanilla_position(frame)
        return
    end
    if g.separate_buff_custom_settings.tracking == 1 then
        frame:EnableMove(0)
        frame:EnableHittestFrame(0)
        local my_handle = session.GetMyHandle()
        FRAME_AUTO_POS_TO_OBJ(frame, my_handle, 30, -40, 3, 1)
        return
    end
    if g.separate_buff_custom_settings.location_share == 1 then
        frame:EnableMove(g.separate_buff_custom_settings.move)
        frame:EnableHittestFrame(g.separate_buff_custom_settings.move)
        frame:MoveFrame(g.separate_buff_custom_settings.x, g.separate_buff_custom_settings.y)
        return
    end
end

function Separate_buff_custom_end_drag(frame)
    if g.separate_buff_custom_settings.location_share == 1 then
        g.separate_buff_custom_settings.x = frame:GetX()
        g.separate_buff_custom_settings.y = frame:GetY()
        Separate_buff_custom_save_settings()
    end
end

function Separate_buff_custom_BUFF_SEPARATEDLIST_CTRLSET_CREATE(my_frame, my_msg)
    if g.settings.separate_buff_custom.use == 0 then
        return
    end
    local frame, my_handle, buff_index, buff_id = g.get_event_args(my_msg)
    if ui.buff.IsBuffSeparate(buff_id) == 1 then
        return
    end
    local setting = g.separate_buff_custom_settings.sep_buffs[tostring(buff_id)]
    if setting and setting.display == 1 then
        local buff = info.GetBuff(my_handle, buff_id)
        local buff_cls = GetClassByType("Buff", buff_id)
        CTRLSET_CREATE(frame, my_handle, buff, buff_cls, buff_index, buff_id)
        local gbox = GET_CHILD_RECURSIVELY(frame, "buffGBox")
        if gbox then
            local ctrl_set = GET_CHILD(gbox, "BUFFSLOT_buff" .. buff_id)
            if ctrl_set then
                local slot = GET_CHILD_RECURSIVELY(ctrl_set, "slot")
                if buff_cls.OverBuff <= buff.over then
                    if setting.with_effect == 1 and not g.separate_buff_custom_temp_buffs[tostring(buff_id)] then
                        local my_handle = session.GetMyHandle()
                        local actor = world.GetActor(my_handle)
                        effect.PlayActorEffect(actor, 'F_pattern025_loop', 'None', 1.0, 1.5)
                        imcSound.PlaySoundEvent("sys_cube_open_jackpot")
                        g.separate_buff_custom_temp_buffs[tostring(buff_id)] = true
                    end
                    slot:SetText('{s30}{ol}{#FF0000}' .. buff.over, 'count', ui.RIGHT, ui.BOTTOM, 0, 0)
                elseif buff.over > 1 then
                    slot:SetText('{s30}{ol}{b}' .. buff.over, 'count', ui.RIGHT, ui.BOTTOM, 0, 0)
                end
                slot:AdjustFontSizeByWidth(30)
            end
        end
    end
end

function Separate_buff_custom_BUFF_SEPARATEDLIST_CTRLSET_REMOVE(my_frame, my_msg)
    if g.settings.separate_buff_custom.use == 0 then
        return
    end
    local frame, my_handle, buff_index, buff_id = g.get_event_args(my_msg)
    local buff_cls = GetClassByType("Buff", buff_id)
    if buff_cls then
        local setting = g.separate_buff_custom_settings.sep_buffs[tostring(buff_id)]
        if setting and setting.display == 1 then
            g.separate_buff_custom_temp_buffs[tostring(buff_id)] = false
            CTRLSET_REMOVE(frame, "buff", buff_id)
        end
    end
end

function Separate_buff_custom_settings(buff_list, ctrl, ctrl_text)
    local buff_list = ui.GetFrame(addon_name_lower .. "separate_buff_custom_buff_list")
    local search_edit
    if not buff_list then
        buff_list = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "separate_buff_custom_buff_list", 0, 0, 0, 0)
        AUTO_CAST(buff_list)
        buff_list:SetSkinName("test_frame_low")
        buff_list:SetPos(150, 10)
        buff_list:SetLayerLevel(999)
        search_edit = buff_list:CreateOrGetControl("edit", "search_edit", 40, 10, 305, 38)
        AUTO_CAST(search_edit)
        search_edit:SetFontName("white_18_ol")
        search_edit:SetTextAlign("left", "center")
        search_edit:SetSkinName("inventory_serch")
        search_edit:SetEventScript(ui.ENTERKEY, "Separate_buff_custom_buff_list_search")
        local search_btn = search_edit:CreateOrGetControl("button", "search_btn", 0, 0, 40, 38)
        AUTO_CAST(search_btn)
        search_btn:SetImage("inven_s")
        search_btn:SetGravity(ui.RIGHT, ui.TOP)
        search_btn:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_list_search")
        local location = buff_list:CreateOrGetControl('checkbox', 'location', 355, 10, 30, 30)
        AUTO_CAST(location)
        location:SetTextTooltip(g.lang == "Japanese" and
                                    "{ol}チェックすると{nl}セパレートバフフレームの位置を各キャラ共有" or
                                    "{ol}If checked{nl}location of the separated buff frame{nl}is shared by all characters")
        location:SetCheck(g.separate_buff_custom_settings.location_share or 0)
        location:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_toggle")
        local move = buff_list:CreateOrGetControl('checkbox', 'move', 390, 10, 30, 30)
        AUTO_CAST(move)
        move:SetTextTooltip(g.lang == "Japanese" and
                                "{ol}チェックすると{nl}セパレートバフフレームの位置を固定" or
                                "{ol}If checked{nl}{nl}fixes the position of the separate buff frame")
        move:SetCheck(g.separate_buff_custom_settings.move == 1 and 0 or 1)
        move:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_toggle")
        local tracking = buff_list:CreateOrGetControl('checkbox', 'tracking', 425, 10, 30, 30)
        AUTO_CAST(tracking)
        tracking:SetTextTooltip(g.lang == "Japanese" and
                                    "{ol}チェックすると{nl}セパレートバフフレーム追従モード" or
                                    "{ol}If checked{nl}{nl}Separate Buff Frame Tracking Mode")
        tracking:SetCheck(g.separate_buff_custom_settings.tracking or 0)
        tracking:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_toggle")
        local close = buff_list:CreateOrGetControl('button', 'close', 0, 0, 20, 20)
        AUTO_CAST(close)
        close:SetImage("testclose_button")
        close:SetGravity(ui.RIGHT, ui.TOP)
        close:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_frame_close")
    else
        search_edit = GET_CHILD_RECURSIVELY(buff_list, "search_edit")
    end
    if ctrl_text then
        search_edit:SetText(ctrl_text)
    end
    local buff_list_gb = buff_list:CreateOrGetControl("groupbox", "buff_list_gb", 10, 50, 480,
        buff_list:GetHeight() - 60)
    AUTO_CAST(buff_list_gb)
    buff_list_gb:SetSkinName("bg")
    buff_list_gb:RemoveAllChild()
    local cls_list, count = GetClassList("Buff")
    local search_lower = (ctrl_text and ctrl_text ~= "") and string.lower(ctrl_text) or nil
    local all_buffs = {}
    for i = 0, count - 1 do
        local buff_cls = GetClassByIndexFromList(cls_list, i)
        if buff_cls then
            local buff_name = dictionary.ReplaceDicIDInCompStr(buff_cls.Name)
            if not search_lower or string.find(string.lower(buff_name), search_lower) then
                local image_name = GET_BUFF_ICON_NAME(buff_cls)
                if image_name ~= "icon_None" and buff_name ~= "None" then
                    local buff_id_str = tostring(buff_cls.ClassID)
                    local setting = g.separate_buff_custom_settings.sep_buffs[buff_id_str]
                    local display = 0
                    local with_effect = 0
                    if setting then
                        display = setting.display or 0
                        with_effect = setting.with_effect or 0
                    end
                    table.insert(all_buffs, {
                        cls = buff_cls,
                        name = buff_name,
                        image = image_name,
                        display = display,
                        with_effect = with_effect
                    })
                end
            end
        end
    end
    table.sort(all_buffs, function(a, b)
        if a.display == 1 and b.display ~= 1 then
            return true
        elseif a.display ~= 1 and b.display == 1 then
            return false
        else
            return a.cls.ClassID < b.cls.ClassID
        end
    end)
    g.separate_buff_custom_x = g.separate_buff_custom_x or 0
    local y = 0
    for _, buff_data in ipairs(all_buffs) do
        local buff_cls = buff_data.cls
        local buff_id = buff_cls.ClassID
        local buff_slot = buff_list_gb:CreateOrGetControl('slot', 'buffslot' .. buff_id, 10, y + 5, 30, 30)
        AUTO_CAST(buff_slot)
        SET_SLOT_IMG(buff_slot, buff_data.image)
        local icon = CreateIcon(buff_slot)
        AUTO_CAST(icon)
        icon:SetTooltipType('buff')
        icon:SetTooltipArg(buff_data.name, buff_id, 0)
        local with_effect = buff_list_gb:CreateOrGetControl('checkbox', 'with_effect' .. buff_id, 50, y + 10, 30, 30)
        AUTO_CAST(with_effect)
        with_effect:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックするとエフェクト表示" or
                                       "{ol}If checked, show effect")
        with_effect:SetCheck(buff_data.with_effect or 0)
        with_effect:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_toggle")
        with_effect:SetEventScriptArgNumber(ui.LBUTTONUP, buff_id)
        with_effect:SetEventScriptArgString(ui.LBUTTONUP, search_edit:GetText())
        local buff_check = buff_list_gb:CreateOrGetControl('checkbox', 'buff_check' .. buff_id, 80, y + 10, 200, 30)
        AUTO_CAST(buff_check)
        buff_check:SetText("{ol}" .. buff_id .. " : " .. buff_data.name)
        if g.separate_buff_custom_x < buff_check:GetWidth() then
            g.separate_buff_custom_x = buff_check:GetWidth()
        end
        buff_check:SetTextTooltip(g.lang == "Japanese" and
                                      "{ol}チェックするとセパレートバフフレームに表示" or
                                      "{ol}If checked, display on the separated buff frame")
        buff_check:SetCheck(buff_data.display or 0)
        buff_check:SetEventScript(ui.LBUTTONUP, "Separate_buff_custom_buff_toggle")
        buff_check:SetEventScriptArgNumber(ui.LBUTTONUP, buff_id)
        buff_check:SetEventScriptArgString(ui.LBUTTONUP, search_edit:GetText())
        y = y + 35
    end
    buff_list:Resize(g.separate_buff_custom_x + 20, 1060)
    buff_list_gb:Resize(g.separate_buff_custom_x, buff_list:GetHeight() - 60)
    buff_list_gb:SetScrollPos(0)
    buff_list:ShowWindow(1)
end

function Separate_buff_custom_buff_toggle(buff_list, ctrl, ctrl_text, buff_id)
    local str_id = tostring(buff_id)
    local changed = false
    if not g.separate_buff_custom_settings.sep_buffs[str_id] then
        g.separate_buff_custom_settings.sep_buffs[str_id] = {}
    end
    local setting = g.separate_buff_custom_settings.sep_buffs[str_id]
    if string.find(ctrl:GetName(), "buff_check") then
        if ctrl:IsChecked() == 1 then
            setting.display = 1
        else
            g.separate_buff_custom_settings.sep_buffs[str_id] = nil
            changed = true
        end
    elseif string.find(ctrl:GetName(), "with_effect") then
        setting.with_effect = ctrl:IsChecked()
    else
        if ctrl:GetName() == "location" then
            g.separate_buff_custom_settings.location_share = ctrl:IsChecked()
            local buff_separatedlist = ui.GetFrame("buff_separatedlist")
            g.separate_buff_custom_settings.x = buff_separatedlist:GetX()
            g.separate_buff_custom_settings.y = buff_separatedlist:GetY()
        elseif ctrl:GetName() == "move" then
            g.separate_buff_custom_settings.move = ctrl:IsChecked() == 1 and 0 or 1
        elseif ctrl:GetName() == "tracking" then
            g.separate_buff_custom_settings.tracking = ctrl:IsChecked()
        end
        Separate_buff_custom_frame_move()
    end
    Separate_buff_custom_save_settings()
    if changed then
        Separate_buff_custom_settings(buff_list, ctrl, ctrl_text)
    end
end

function Separate_buff_custom_buff_list_search(buff_list, ctrl, ctrl_text, num)
    local buff_list = ui.GetFrame(addon_name_lower .. "separate_buff_custom_buff_list")
    local search_edit = GET_CHILD_RECURSIVELY(buff_list, "search_edit")
    local ctrl_text = search_edit:GetText()
    if ctrl_text ~= "" then
        Separate_buff_custom_settings(buff_list, ctrl, ctrl_text)
    else
        Separate_buff_custom_settings(buff_list, ctrl, "")
    end
end

function Separate_buff_custom_frame_close(buff_list)
    ui.DestroyFrame(buff_list:GetName())
end
-- separate_buff_custom ここまで

-- revival_timer ここから
function Revival_timer_save_settings()
    g.save_json(g.revival_timer_path, g.revival_timer_settings)
end

function Revival_timer_load_settings()
    g.revival_timer_path = string.format("../addons/%s/%s/revival_timer.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.revival_timer_path)
    if not settings then
        settings = {
            x = 400,
            y = 300,
            set_second = 60,
            set_text = "",
            ptchat = false,
            nicochat = false,
            shortcut = false,
            shortcut_l = false
        }
    end
    g.revival_timer_settings = settings
    Revival_timer_save_settings()
end

function revival_timer_on_init()
    if not g.revival_timer_settings then
        Revival_timer_load_settings()
    end
    local old_func = g.settings.revival_timer.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.revival_timer.use == 1 then
        Revival_timer_frame_init()
    else
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        _nexus_addons:RemoveChild("Revival_timer_keypress")
        local revival_timer = ui.GetFrame(addon_name_lower .. "revival_timer")
        if revival_timer then
            revival_timer:ShowWindow(0)
        end
    end
    g.setup_hook_and_event(g.addon, "EXEC_CHATMACRO", "Revival_timer_EXEC_CHATMACRO", false)
end

function Revival_timer_frame_init()
    local revival_timer = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "revival_timer", 0, 0, 0, 0)
    AUTO_CAST(revival_timer)
    revival_timer:RemoveAllChild()
    revival_timer:SetPos(g.revival_timer_settings.x, g.revival_timer_settings.y)
    revival_timer:SetSkinName("bg2")
    revival_timer:SetLayerLevel(61)
    revival_timer:Resize(160, 130)
    revival_timer:EnableHittestFrame(1)
    revival_timer:EnableMove(1)
    revival_timer:SetEventScript(ui.LBUTTONUP, "Revival_timer_end_drag")
    local close = revival_timer:CreateOrGetControl("button", "close", 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Revival_timer_frame_close")
    local info_text = revival_timer:CreateOrGetControl('richtext', 'info_text', 10, 10, 50, 20)
    AUTO_CAST(info_text)
    local timer_text = revival_timer:CreateOrGetControl('richtext', 'timer_text', 15, 30, 50, 20)
    AUTO_CAST(timer_text)
    local loop_text = revival_timer:CreateOrGetControl('richtext', 'loop_text', 10, 90, 50, 20)
    AUTO_CAST(loop_text)
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:SetVisible(1)
    local revival_timer_keypress = _nexus_addons:CreateOrGetControl("timer", "revival_timer_keypress", 0, 0)
    AUTO_CAST(revival_timer_keypress)
    revival_timer_keypress:SetUpdateScript("Revival_timer_keypress")
    revival_timer_keypress:Start(0.1)
    g.revival_timer_last_keypress = 0
end

function Revival_timer_end_drag(frame)
    g.revival_timer_settings.x = frame:GetX()
    g.revival_timer_settings.y = frame:GetY()
    Revival_timer_save_settings()
end

function Revival_timer_frame_close(frame)
    if frame:GetName() == addon_name_lower .. "revival_timer_setting" then
        ui.DestroyFrame(frame:GetName())
    else
        frame:ShowWindow(0)
        frame:SetPos(g.revival_timer_settings.x, g.revival_timer_settings.y)
        -- frame:SetVisible(1)
    end
end

function Revival_timer_setting()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "revival_timer_setting", 0, 0, 0, 0)
    AUTO_CAST(setting)
    setting:Resize(240, 420)
    setting:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    setting:SetSkinName("test_frame_low")
    setting:EnableHittestFrame(1)
    setting:EnableHitTest(1)
    setting:SetLayerLevel(999)
    setting:RemoveAllChild()
    local title_text = setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Lets Go Home Config")
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Revival_timer_frame_close")
    local gbox = setting:CreateOrGetControl("groupbox", "gbox", 10, 40, setting:GetWidth() - 20,
        setting:GetHeight() - 50)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local info_text = gbox:CreateOrGetControl('richtext', 'info_text', 10, 10, 50, 20)
    AUTO_CAST(info_text)
    info_text:SetText(g.lang == "Japanese" and "{ol}お知らせメッセージ" or "{ol}Notice Text")
    local info_edit = gbox:CreateOrGetControl('edit', 'info_edit', 10, 30, 140, 30)
    AUTO_CAST(info_edit)
    info_edit:SetFontName("white_16_ol")
    info_edit:SetTextAlign("center", "center")
    info_edit:SetText("{ol}" .. g.revival_timer_settings.set_text)
    info_edit:SetEventScript(ui.ENTERKEY, "Revival_timer_edit_save")
    local set_second = gbox:CreateOrGetControl('richtext', 'set_second', 10, 65, 50, 20)
    AUTO_CAST(set_second)
    set_second:SetText(g.lang == "Japanese" and "{ol}秒数設定" or "{ol}Set Seconds")
    local set_second_edit = gbox:CreateOrGetControl('edit', 'set_second_edit', 10, 85, 80, 30)
    AUTO_CAST(set_second_edit)
    set_second_edit:SetFontName("white_16_ol")
    set_second_edit:SetTextAlign("center", "center")
    set_second_edit:SetNumberMode(1)
    set_second_edit:SetText("{ol}" .. g.revival_timer_settings.set_second)
    set_second_edit:SetEventScript(ui.ENTERKEY, "Revival_timer_edit_save")
    local with_ptchat = gbox:CreateOrGetControl('checkbox', "with_ptchat", 10, 120, 30, 30)
    AUTO_CAST(with_ptchat)
    with_ptchat:SetCheck(g.revival_timer_settings.ptchat and 1 or 0)
    with_ptchat:SetEventScript(ui.LBUTTONDOWN, 'Revival_timer_checkbox_save')
    with_ptchat:SetText(g.lang == "Japanese" and "{ol}PTチャット表示" or "{ol}Show PT Chat")
    local nicochat = gbox:CreateOrGetControl('checkbox', "nicochat", 10, 150, 30, 30)
    AUTO_CAST(nicochat)
    nicochat:SetCheck(g.revival_timer_settings.nicochat and 1 or 0)
    nicochat:SetEventScript(ui.LBUTTONDOWN, 'Revival_timer_checkbox_save')
    nicochat:SetText(g.lang == "Japanese" and "{ol}ニコチャット表示" or "{ol}Show Nico Chat")
    local short_cut = gbox:CreateOrGetControl('checkbox', "short_cut", 10, 180, 30, 30)
    AUTO_CAST(short_cut)
    short_cut:SetCheck(g.revival_timer_settings.shortcut and 1 or 0)
    short_cut:SetEventScript(ui.LBUTTONDOWN, 'Revival_timer_checkbox_save')
    short_cut:SetText(g.lang == "Japanese" and "{ol}ショートカット使用" .. "{nl}{#FFD700}(Right ALT)" or
                          "{ol}Use shortcut" .. "{nl}{#FFD700}(Right ALT)")
    local short_cut_l = gbox:CreateOrGetControl('checkbox', "short_cut_l", 10, 220, 30, 30)
    AUTO_CAST(short_cut_l)
    short_cut_l:SetCheck(g.revival_timer_settings.shortcut_l and 1 or 0)
    short_cut_l:SetEventScript(ui.LBUTTONDOWN, 'Revival_timer_checkbox_save')
    short_cut_l:SetText(g.lang == "Japanese" and "{ol}ショートカット使用" .. "{nl}{#FFD700}(Left ALT)" or
                            "{ol}Use shortcut" .. "{nl}{#FFD700}(Left ALT)")
    local show_timer = gbox:CreateOrGetControl("button", "show_timer", 50, 270, 100, 40)
    AUTO_CAST(show_timer)
    show_timer:SetText(g.lang == "Japanese" and "{ol}テスト表示" or "{ol}Test Show")
    show_timer:SetEventScript(ui.LBUTTONUP, "Revival_timer_test_show")
    show_timer:SetEventScriptArgString(ui.LBUTTONUP, "test")
    local notice = gbox:CreateOrGetControl('richtext', 'notice', 10, 320, 100, 20)
    AUTO_CAST(notice)
    notice:SetText(g.lang == "Japanese" and
                       "{ol}スタートと非表示は{nl}チャットコマンド{#FFD700}'/rtimer'" or
                       "{ol}Start and hide with the{nl}chat command{#FFD700}'/rtimer'")
    setting:ShowWindow(1)
end

function Revival_timer_edit_save(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name == "info_edit" then
        g.revival_timer_settings.set_text = ctrl:GetText()
    elseif ctrl_name == "set_second_edit" then
        g.revival_timer_settings.set_second = tonumber(ctrl:GetText())
    end
    Revival_timer_save_settings()
    Revival_timer_setting()
end

function Revival_timer_checkbox_save(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    local is_check = ctrl:IsChecked()
    if ctrl_name == "with_ptchat" then
        g.revival_timer_settings.ptchat = is_check == 1 and true or false
    elseif ctrl_name == "nicochat" then
        g.revival_timer_settings.nicochat = is_check == 1 and true or false
    elseif ctrl_name == "short_cut" then
        g.revival_timer_settings.shortcut = is_check == 1 and true or false
    elseif ctrl_name == "short_cut_l" then
        g.revival_timer_settings.shortcut_l = is_check == 1 and true or false
    end
    Revival_timer_save_settings()
end

function Revival_timer_test_show(frame)
    local revival_timer_setting = ui.GetFrame(addon_name_lower .. "revival_timer_setting")
    local revival_timer = ui.GetFrame(addon_name_lower .. "revival_timer")
    revival_timer:SetPos(revival_timer_setting:GetX() + revival_timer_setting:GetWidth(), revival_timer_setting:GetY())
    g.revival_timer_start_time = imcTime.GetAppTimeMS()
    g.revival_timer_announced = 0
    local revival_timer_timer = revival_timer:CreateOrGetControl("timer", "revival_timer_timer", 0, 0)
    AUTO_CAST(revival_timer_timer)
    revival_timer_timer:SetUpdateScript("Revival_timer_update")
    revival_timer_timer:Start(0.1)
    revival_timer:ShowWindow(1)
    revival_timer:RunUpdateScript("Revival_timer_frame_close", 10.0)
end

function Revival_timer_EXEC_CHATMACRO(my_frame, my_msg)
    local index = g.get_event_args(my_msg)
    if g.settings.revival_timer.use == 0 then
        g.FUNCS["EXEC_CHATMACRO"](index)
        return
    end
    local macro = GET_CHAT_MACRO(index)
    if not macro then
        return
    end
    local pose_cls = GetClassByType('Pose', macro.poseID)
    if pose_cls then
        control.Pose(pose_cls.ClassName)
    end
    if macro.macro == "" then
        return
    end
    local msg = macro.macro
    if string.find(msg, "/rtimer", 1, true) then
        local revival_timer = ui.GetFrame(addon_name_lower .. "revival_timer")
        if revival_timer:IsVisible() == 1 then
            revival_timer:ShowWindow(0)
            return
        else
            g.revival_timer_start_time = imcTime.GetAppTimeMS()
            g.revival_timer_announced = 0
            local revival_timer_timer = revival_timer:CreateOrGetControl("timer", "revival_timer_timer", 0, 0)
            AUTO_CAST(revival_timer_timer)
            revival_timer_timer:SetUpdateScript("Revival_timer_update")
            revival_timer_timer:Start(0.1)
            revival_timer:ShowWindow(1)
        end
    end
    ui.Chat(REPLACE_EMOTICON(macro.macro))
end

function Revival_timer_keypress(_nexus_addons)
    if not g.revival_timer_settings.shortcut and not g.revival_timer_settings.shortcut_l then
        return
    end
    local cool_down = 200 -- 200ミリ秒
    local now = imcTime.GetAppTimeMS()
    if now - g.revival_timer_last_keypress < cool_down then
        return
    end
    g.revival_timer_last_keypress = now
    if (1 == keyboard.IsKeyPressed("RALT") and g.revival_timer_settings.shortcut) or
        (1 == keyboard.IsKeyPressed("LALT") and g.revival_timer_settings.shortcut_l) then
        g.revival_timer_last_keypress = now
        local revival_timer = ui.GetFrame(addon_name_lower .. "revival_timer")
        if revival_timer:IsVisible() == 0 then
            g.revival_timer_start_time = imcTime.GetAppTimeMS()
            g.revival_timer_announced = 0
            local revival_timer_timer = revival_timer:CreateOrGetControl("timer", "revival_timer_timer", 0, 0)
            AUTO_CAST(revival_timer_timer)
            revival_timer_timer:SetUpdateScript("Revival_timer_update")
            revival_timer_timer:Start(0.1)
            revival_timer:ShowWindow(1)
        else
            revival_timer:ShowWindow(0)
        end
    end
end

function Revival_timer_update(revival_timer, revival_timer_timer)
    local elapsed_ms = imcTime.GetAppTimeMS() - g.revival_timer_start_time
    local remaining_s = g.revival_timer_settings.set_second - math.floor(elapsed_ms / 1000)
    if remaining_s < 0 then
        Revival_timer_loop_timer()
        return
    end
    local info_text = GET_CHILD(revival_timer, "info_text")
    info_text:SetText("{ol}{#FF0000}{s20}" .. g.revival_timer_settings.set_text)
    local loop_text = GET_CHILD(revival_timer, "loop_text")
    local m = math.floor((g.revival_timer_settings.set_second / 60) % 60)
    local s = math.floor(g.revival_timer_settings.set_second % 60)
    loop_text:SetText("{ol}Set Time : " .. string.format("%02d:%02d{/}", m, s))
    local timer_text = GET_CHILD(revival_timer, "timer_text")
    local m = math.floor((remaining_s / 60) % 60)
    local s = math.floor(remaining_s % 60)
    timer_text:SetText(string.format("{ol}{s46}%02d:%02d{/}", m, s))
    local diff_time = g.revival_timer_start_time - imcTime.GetAppTimeMS()
    if remaining_s <= 10 and g.revival_timer_announced == 0 then
        g.revival_timer_announced = 1
        local suffix = g.lang == "Japanese" and " 10秒前" or " 10 sec rem."
        local msg = "/p " .. g.revival_timer_settings.set_text .. suffix
        if g.revival_timer_settings.ptchat then
            _UI_CHAT(msg)
        end
        if g.revival_timer_settings.nicochat then
            Revival_timer_NICO_CHAT("{@st55_a}" .. g.revival_timer_settings.set_text .. suffix)
        end
    elseif remaining_s <= 5 and g.revival_timer_announced == 1 then
        g.revival_timer_announced = 2
        local suffix = g.lang == "Japanese" and " 5秒前" or " 5 sec rem."
        local msg = "/p " .. g.revival_timer_settings.set_text .. suffix
        if g.revival_timer_settings.ptchat then
            _UI_CHAT(msg)
        end
        if g.revival_timer_settings.nicochat then
            Revival_timer_NICO_CHAT("{@st55_a}" .. g.revival_timer_settings.set_text .. suffix)
        end
    end
end

function Revival_timer_loop_timer()
    g.revival_timer_start_time = imcTime.GetAppTimeMS()
    g.revival_timer_announced = 0
end

function Revival_timer_NICO_CHAT(msg)
    local x = ui.GetClientInitialWidth()
    local y = ui.GetClientInitialHeight() * 0.6
    local nico_chat = ui.GetFrame("nico_chat")
    change_client_size(nico_chat)
    local name = UI_EFFECT_GET_NAME(nico_chat, "NICO_")
    local nico_text = nico_chat:CreateControl("richtext", name, x, y, 200, 20)
    AUTO_CAST(nico_text)
    nico_chat:SetLayerLevel(90)
    nico_chat:ShowWindow(1)
    nico_text:EnableResizeByText(1)
    nico_text:SetText(msg)
    nico_text:RunUpdateScript("NICO_MOVING")
    nico_text:SetUserValue("NICO_SPD", -150)
    nico_text:SetUserValue("NICO_START_X", x)
    nico_text:ShowWindow(1)
    nico_chat:RunUpdateScript("INVALIDATE_NICO")
end
-- revival_timer ここまで

-- relic_change ここから
function Relic_change_save_settings()
    g.save_json(g.relic_change_path, g.relic_change_settings)
end

function Relic_change_load_settings()
    g.relic_change_path = string.format("../addons/%s/%s/relic_change.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.relic_change_path)
    if not settings then
        settings = {
            x = 0,
            y = 0,
            move = 0
        }
    end
    g.relic_change_settings = settings
    Relic_change_save_settings()
end

function relic_change_on_init()
    if not g.relic_change_settings then
        Relic_change_load_settings()
    end
    local old_func = g.settings.relic_change.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.relic_change.use == 0 then
        local relic_change = ui.GetFrame(addon_name_lower .. "relic_change")
        if relic_change then
            ui.DestroyFrame(addon_name_lower .. "relic_change")
        end
        return
    end
    if g.get_map_type() == "City" then
        Relic_change_frame_init()
    end
end

function Relic_change_frame_init()
    local relic_change = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "relic_change", 0, 0, 0, 0)
    AUTO_CAST(relic_change)
    relic_change:SetSkinName('None')
    relic_change:SetTitleBarSkin("None")
    relic_change:Resize(40, 35)
    relic_change:SetGravity(ui.RIGHT, ui.TOP)
    relic_change:EnableHitTest(1)
    relic_change:EnableHittestFrame(1)
    relic_change:EnableMove(g.relic_change_settings.move)
    local rect = relic_change:GetMargin()
    relic_change:SetMargin(rect.left - rect.left, rect.top - rect.top + 300, rect.right + 50, rect.bottom)
    if g.relic_change_settings.x ~= 0 and g.relic_change_settings.y ~= 0 then
        relic_change:SetPos(g.relic_change_settings.x, g.relic_change_settings.y)
    end
    relic_change:SetEventScript(ui.LBUTTONUP, "Relic_change_frame_move")
    local slot = relic_change:CreateOrGetControl("slot", "slot", 0, 0, 35, 35)
    AUTO_CAST(slot)
    slot:SetGravity(ui.LEFT, ui.TOP)
    slot:EnablePop(0)
    slot:EnableDrop(0)
    slot:EnableDrag(0)
    slot:SetSkinName('None')
    slot:SetEventScript(ui.LBUTTONUP, "Relic_change_relicmanager_open")
    slot:SetEventScript(ui.RBUTTONUP, "Relic_change_frame_context")
    local icon = CreateIcon(slot)
    AUTO_CAST(icon)
    local item_cls = GetClassByType('Item', 845000)
    icon:SetImage(item_cls.Icon)
    icon:SetTextTooltip(g.lang == "Japanese" and
                            "{ol}左クリック:シアンジェム入替え{nl}右クリック:フレーム設定" or
                            "{ol}Left Click: Cyan Gem swap{nl}Right Click: Frame settings")
    relic_change:ShowWindow(1)
end

function Relic_change_frame_context(relic_change, slot)
    local context = ui.CreateContextMenu("CONTEXT", "{ol}Relic Change Setting", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "-----", "None")
    ui.AddContextMenuItem(context, g.lang == "Japanese" and "{ol}フレーム固定" or "{ol}Fix frame",
        "Relic_change_gem_move_setting()")
    ui.AddContextMenuItem(context,
        g.lang == "Japanese" and "{ol}フレーム位置を戻す" or "{ol}Restore frame position",
        "Relic_change_gem_move_restore()")
    ui.OpenContextMenu(context)
end

function Relic_change_gem_move_setting()
    if g.relic_change_settings.move == 0 then
        g.relic_change_settings.move = 1
    else
        g.relic_change_settings.move = 0
    end
    Relic_change_save_settings()
    ui.DestroyFrame(addon_name_lower .. "relic_change")
    ReserveScript("Relic_change_frame_init()", 0.1)
end

function Relic_change_gem_move_restore(relic_change)
    g.relic_change_settings.x = 0
    g.relic_change_settings.y = 0
    Relic_change_save_settings()
    ui.DestroyFrame(addon_name_lower .. "relic_change")
    ReserveScript("Relic_change_frame_init()", 0.1)
end

function Relic_change_frame_move(relic_change)
    g.relic_change_settings.x = relic_change:GetX()
    g.relic_change_settings.y = relic_change:GetY()
    Relic_change_save_settings()
end

function Relic_change_relicmanager_open(relic_change, slot)
    local inventory = ui.GetFrame("inventory")
    if inventory:IsVisible() == 0 then
        UI_TOGGLE_INVENTORY()
        local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
        inventype_Tab:SelectTab(6)
    end
    local relicmanager = ui.GetFrame("relicmanager")
    relicmanager:ShowWindow(1)
    local tab = GET_CHILD_RECURSIVELY(relicmanager, 'type_Tab')
    tab:SelectTab(2)
    RELICMANAGER_SOCKET_UPDATE(relicmanager)
    Relic_change_context()
end

function Relic_change_context()
    local relic_gems = {}
    local inv_item_list = session.GetInvItemList()
    local guid_list = inv_item_list:GetGuidList()
    local cnt = guid_list:Count()
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        local item_obj = GetIES(inv_item:GetObject())
        local item_name = item_obj.Name
        if string.find(item_obj.ClassName, "Gem_Relic_Cyan") then
            local lv = TryGetProp(item_obj, 'GemLevel', 0)
            local existing_gem = relic_gems[item_obj.ClassID]
            if not existing_gem or lv > existing_gem.level then
                relic_gems[item_obj.ClassID] = {
                    level = lv,
                    guid = guid,
                    name = item_obj.Name
                }
            end
        end
    end
    local context = ui.CreateContextMenu("CONTEXT", "{ol}Relic Cyan Change", 0, 0, 0, 0)
    ui.AddContextMenuItem(context, "-----", "None")
    for gem_id, gem_data in pairs(relic_gems) do
        ui.AddContextMenuItem(context, dictionary.ReplaceDicIDInCompStr(gem_data.name) .. "Lv." .. gem_data.level,
            string.format("Relic_change_gem_remove(%s)", gem_data.guid))
    end
    ui.OpenContextMenu(context)
end

function Relic_change_gem_remove(guid)
    local arg_list = string.format('%d', 0)
    local relicmanager = ui.GetFrame('relicmanager')
    local relic_id = relicmanager:GetUserValue('RELIC_GUID')
    pc.ReqExecuteTx_Item('RELIC_SOCKET_GEM_REMOVE', relic_id, arg_list)
    relicmanager:SetUserValue("GEM_IESID", guid)
    relicmanager:RunUpdateScript("Relic_change_gem_add", 1.0)
end

function Relic_change_gem_add(relicmanager)
    local guid = relicmanager:GetUserValue("GEM_IESID")
    local relic_item = session.GetEquipItemBySpot(item.GetEquipSpotNum('RELIC'))
    local inv_item = session.GetInvItemByGuid(guid)
    if inv_item.isLockState == true then
        ui.SysMsg(ClMsg('MaterialItemIsLock'))
        return
    end
    session.ResetItemList()
    session.AddItemID(relic_item:GetIESID(), 1)
    session.AddItemID(inv_item:GetIESID(), 1)
    _RELICMANAGER_SOCKET_GEM_ADD()
    relicmanager:StopUpdateScript("Relic_change_gem_add")
    relicmanager:RunUpdateScript("Relic_change_end", 1.0)
end

function Relic_change_end(relicmanager)
    relicmanager:StopUpdateScript("Relic_change_end")
    RELICMANAGER_CLOSE(relicmanager)
    local inventory = ui.GetFrame("inventory")
    if inventory:IsVisible() == 1 then
        UI_TOGGLE_INVENTORY()
        local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
        inventype_Tab:SelectTab(0)
    end
    ui.SysMsg("[RC]End of Operation")
end
-- relic_change ここまで

-- monster_card_changer ここから
function Monster_card_changer_save_settings()
    g.save_json(g.monster_card_changer_path, g.monster_card_changer_settings)
end

function Monster_card_changer_load_settings()
    g.monster_card_changer_path = string.format("../addons/%s/%s/monster_card_changer.json", addon_name_lower,
        g.active_id)
    local settings = g.load_json(g.monster_card_changer_path)
    if not settings then
        settings = {
            presets = {}
        }
    end
    local changed = false
    for i = 1, 10 do
        if not settings.presets[i] then
            local title = ScpArgMsg('CardPresetNumber{index}', 'index', i)
            settings.presets[i] = {
                name = title,
                slots = {}
            }
            changed = true
        end
        if not settings.presets[i].slots or #settings.presets[i].slots < 12 then
            local slots = settings.presets[i].slots or {}
            for j = 1, 12 do
                if not slots[j] then
                    slots[j] = {
                        card_id = 0,
                        card_exp = 0,
                        card_lv = 0
                    }
                end
            end
            settings.presets[i].slots = slots
            changed = true
        end
    end
    g.monster_card_changer_settings = settings
    if changed then
        Monster_card_changer_save_settings()
    end
end

function monster_card_changer_on_init()
    if not g.monster_card_changer_settings then
        Monster_card_changer_load_settings()
    end
    local old_func = g.settings.monster_card_changer.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.monster_card_changer.use == 0 then
        Monster_card_changer_not_use()
        return
    end
    if g.get_map_type() == "City" then
        Monster_card_changer_inventory_frame_init()
        g.setup_hook_and_event(g.addon, "CARD_PRESET_CHANGE_NAME_EXEC",
            "Monster_card_changer_CARD_PRESET_CHANGE_NAME_EXEC", false)
    end
end

function Monster_card_changer_not_use()
    local inventory = ui.GetFrame('inventory')
    local mcc = GET_CHILD(inventory, "mcc")
    if mcc then
        DESTROY_CHILD_BYNAME(inventory, "mcc")
    end
    local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    if monster_card_changer then
        ui.DestroyFrame(monster_card_changer:GetName())
    end
    local monstercardslot = ui.GetFrame("monstercardslot")
    local applyBtn = GET_CHILD(monstercardslot, "applyBtn")
    if applyBtn then
        applyBtn:SetEventScript(ui.LBUTTONUP, "MONSTERCARDPRESET_FRAME_OPEN")
    end
    local monstercardpreset = ui.GetFrame('monstercardpreset')
    local preset_list = GET_CHILD_RECURSIVELY(monstercardpreset, "preset_list")
    preset_list:ShowWindow(1)
    local saveBtn = GET_CHILD_RECURSIVELY(monstercardpreset, "saveBtn")
    saveBtn:ShowWindow(1)
    local applyBtn = GET_CHILD_RECURSIVELY(monstercardpreset, "applyBtn")
    applyBtn:ShowWindow(1)
    local drop_list = GET_CHILD(monstercardpreset, 'drop_list')
    if drop_list then
        monstercardpreset:RemoveChild("drop_list")
    end
    local save_btn = GET_CHILD(monstercardpreset, 'save_btn')
    if save_btn then
        monstercardpreset:RemoveChild("save_btn")
    end
    local unequip = GET_CHILD(monstercardpreset, 'unequip')
    if unequip then
        monstercardpreset:RemoveChild("unequip")
    end
    local equip = GET_CHILD(monstercardpreset, 'equip')
    if equip then
        monstercardpreset:RemoveChild("equip")
    end
    local monstercardslot = ui.GetFrame('monstercardslot')
    local card_colors = {"red", "blue", "purple", "green"}
    for _, color in ipairs(card_colors) do
        local check_box = GET_CHILD(monstercardslot, color)
        if check_box then
            monstercardslot:RemoveChild(color)
        end
    end
end

function Monster_card_changer_CARD_PRESET_CHANGE_NAME_EXEC(my_frame, my_msg)
    local input_frame, ctrl = g.get_event_args(my_msg)
    if g.settings.monster_card_changer.use == 0 then
        g.FUNCS["CARD_PRESET_CHANGE_NAME_EXEC"](input_frame, ctrl)
        return
    end
    local new_name = GET_INPUT_STRING_TXT(input_frame)
    local name_str = TRIM_STRING_WITH_SPACING(new_name)
    if name_str == '' then
        ui.SysMsg(ClMsg('InvalidStringOrUnderMinLen'))
        return
    end
    local monstercardpreset = ui.GetFrame('monstercardpreset')
    local drop_list = GET_CHILD(monstercardpreset, 'drop_list')
    AUTO_CAST(drop_list)
    local page = tonumber(drop_list:GetSelItemKey())
    g.monster_card_changer_settings.presets[page + 1].name = name_str
    Monster_card_changer_save_settings()
    _DISABLE_CARD_PRESET_CHANGE_NAME_BTN()
    input_frame:ShowWindow(0)
    local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    AUTO_CAST(monster_card_changer)
    monster_card_changer:SetUserValue("PAGE", page)
    Monster_card_changer_preset_open(monster_card_changer)
end

function Monster_card_changer_inventory_frame_init()
    local inventory = ui.GetFrame('inventory')
    local mcc = inventory:CreateOrGetControl("button", "mcc", 3, 345, 30, 30)
    AUTO_CAST(mcc)
    mcc:SetSkinName("test_red_button")
    mcc:SetTextAlign("right", "center")
    mcc:SetText("{img monsterbtn_image 28 23}{/}")
    mcc:SetTextTooltip(g.lang == "Japanese" and "{ol}カード自動搬出入、自動着脱{/}" or
                           "{ol}Automatic card loading/unloading, automatic insertion/removal{nl}")
    mcc:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_monstercardpreset_open")
    local monstercardslot = ui.GetFrame("monstercardslot")
    local applyBtn = GET_CHILD(monstercardslot, "applyBtn")
    AUTO_CAST(applyBtn)
    applyBtn:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_monstercardpreset_open")
end

function Monster_card_changer_monstercardpreset_open(is_cc_helper)
    local monstercardpreset = ui.GetFrame('monstercardpreset')
    if monstercardpreset:IsVisible() == 1 and is_cc_helper ~= 1 then
        MONSTERCARDSLOT_CLOSE()
        return
    end
    MONSTERCARDSLOT_FRAME_OPEN()
    local preset_list = GET_CHILD_RECURSIVELY(monstercardpreset, "preset_list")
    AUTO_CAST(preset_list)
    preset_list:SelectItemByKey(4)
    local monster_card_changer = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "monster_card_changer", 0, 0, 0,
        0)
    AUTO_CAST(monster_card_changer)
    monster_card_changer:SetSkinName("None")
    monster_card_changer:SetVisible(1)
    Monster_card_changer_preset_open(monster_card_changer)
end

function Monster_card_changer_preset_open(monster_card_changer)
    local monstercardpreset = ui.GetFrame('monstercardpreset')
    CARD_PRESET_CLEAR_SLOT(monstercardpreset)
    local preset_list = GET_CHILD_RECURSIVELY(monstercardpreset, "preset_list")
    AUTO_CAST(preset_list)
    preset_list:SelectItemByKey(4)
    SetCardPreset(4, {}, {})
    monstercardpreset:RemoveChild("drop_list")
    local drop_list = monstercardpreset:CreateOrGetControl('droplist', 'drop_list', 45, 66, 178, 20)
    AUTO_CAST(drop_list)
    drop_list:SetSkinName('droplist_normal')
    drop_list:EnableHitTest(1)
    drop_list:SetTextAlign("center", "center")
    for i, preset_data in ipairs(g.monster_card_changer_settings.presets) do
        local preset_name = "{ol}" .. preset_data.name
        local scp = string.format("Monster_card_changer_select_preset(%d)", i - 1)
        drop_list:AddItem(i - 1, preset_name, 0, scp)
    end
    local item_num = monster_card_changer:GetUserIValue("PAGE")
    drop_list:SelectItem(item_num)
    preset_list:ShowWindow(0)
    local saveBtn = GET_CHILD_RECURSIVELY(monstercardpreset, "saveBtn")
    saveBtn:ShowWindow(0)
    local save_btn = monstercardpreset:CreateOrGetControl("button", "save_btn", 340, 57, 70, 38)
    AUTO_CAST(save_btn)
    save_btn:SetText("{@st66b}SAVE")
    save_btn:SetSkinName("test_pvp_btn")
    save_btn:SetTextTooltip(g.lang == "Japanese" and
                                "{ol}現在装備中のカード情報を、現在のプリセットに呼び出します" or
                                "{ol}Load currently equipped card information{nl}into the current preset")
    save_btn:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_msgbox")
    local unequip = monstercardpreset:CreateOrGetControl("button", "unequip", 480, 57, 70, 38)
    AUTO_CAST(unequip)
    unequip:SetText("{@st66b}REMOVE")
    unequip:SetSkinName("test_pvp_btn")
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if accountwarehouse:IsVisible() == 1 then
        unequip:SetTextTooltip(g.lang == "Japanese" and
                                   "{ol}現在装備中のカードを取り外し、倉庫へ搬入します" or
                                   "{ol}Unequip currently equipped cards{nl}and transfer them to the warehouse")
    else
        unequip:SetTextTooltip(g.lang == "Japanese" and "{ol}現在装備中のカードを取り外します" or
                                   "{ol}Unequip currently equipped cards")
    end
    unequip:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_remove")
    local applyBtn = GET_CHILD_RECURSIVELY(monstercardpreset, "applyBtn")
    applyBtn:ShowWindow(0)
    local equip = monstercardpreset:CreateOrGetControl("button", "equip", 410, 57, 70, 38)
    AUTO_CAST(equip)
    equip:SetText("{@st66b}EQUIP")
    equip:SetSkinName("test_pvp_btn")
    equip:SetTextTooltip(
        g.lang == "Japanese" and "{ol}現在のプリセットへ、装備カードを変更します" or
            "{ol}Change equipped cards to the current preset")
    equip:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_equip_get_presetinfo")
    local monstercardslot = ui.GetFrame('monstercardslot')
    local mcc_settings = g.monster_card_changer_settings
    if not mcc_settings[g.login_name] then
        mcc_settings[g.login_name] = {}
    end
    local card_colors = {{
        name = "red",
        x = 50,
        y = 70
    }, {
        name = "blue",
        x = 365,
        y = 70
    }, {
        name = "purple",
        x = 50,
        y = 210
    }, {
        name = "green",
        x = 365,
        y = 210
    }}
    for _, color_info in ipairs(card_colors) do
        local color_name = color_info.name
        if not mcc_settings[g.login_name][color_name] then
            mcc_settings[g.login_name][color_name] = 0
        end
        local checkbox = monstercardslot:CreateOrGetControl('checkbox', color_name, color_info.x, color_info.y, 25, 25)
        AUTO_CAST(checkbox)
        checkbox:SetEventScript(ui.LBUTTONUP, "Monster_card_changer_color_save")
        checkbox:SetEventScriptArgString(ui.LBUTTONUP, color_name)
        checkbox:SetCheck(mcc_settings[g.login_name][color_name])
        checkbox:SetTextTooltip(g.lang == "Japanese" and
                                    "{ol}チェックを入れると該当の色のカードを外しません" or
                                    "{ol}checked, cards of the specified color will not be unequipped")
    end
    Monster_card_changer_save_settings()
    monster_card_changer:RunUpdateScript("Monster_card_changer_preset_card_set", 1.0)
    return 0
end

function Monster_card_changer_preset_card_set(monster_card_changer)
    local card_list = {}
    local exp_list = {}
    local monstercardpreset = ui.GetFrame("monstercardpreset")
    monstercardpreset:ShowWindow(1)
    local drop_list = GET_CHILD(monstercardpreset, "drop_list")
    local page = tonumber(drop_list:GetSelItemKey())
    local preset_data = g.monster_card_changer_settings.presets[page + 1].slots
    if not preset_data then
        return 0
    end
    for i, slot_data in ipairs(preset_data) do
        local card_id = slot_data.card_id
        if card_id and card_id ~= 0 then
            local card_exp = slot_data.card_exp or 0
            local card_lv = slot_data.card_lv or 0
            table.insert(card_list, card_id)
            table.insert(exp_list, card_exp)
        end
    end
    SetCardPreset(0, card_list, exp_list)
    MONSTERCARDPRESET_FRAME_OPEN()
    g.monster_card_changer_ready = 1
    return 0
end

function Monster_card_changer_select_preset(page)
    local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    AUTO_CAST(monster_card_changer)
    monster_card_changer:SetUserValue("PAGE", page)
    monster_card_changer:RunUpdateScript("Monster_card_changer_preset_card_set", 1.0)
end

function Monster_card_changer_msgbox()
    local msg = g.lang == "Japanese" and
                    "現在装備中のカード情報を、プリセットに登録しますか？" or
                    "Do you want to save the currently equipped cards to the preset?"
    local yes_scp = string.format("Monster_card_changer_save_preset()")
    ui.MsgBox(msg, yes_scp, "None")
end

function Monster_card_changer_save_preset()
    local monstercardslot = ui.GetFrame("monstercardslot")
    local monstercardpreset = ui.GetFrame("monstercardpreset")
    local drop_list = GET_CHILD(monstercardpreset, "drop_list")
    local page = tonumber(drop_list:GetSelItemKey())
    if not g.monster_card_changer_settings.presets[page + 1] then
        return
    end
    local slots_settings = g.monster_card_changer_settings.presets[page + 1].slots
    for i = 1, 12 do
        local card_id, card_lv, card_exp = GETMYCARD_INFO(i - 1)
        if slots_settings[i] then
            slots_settings[i].card_id = card_id
            slots_settings[i].card_exp = card_exp
            slots_settings[i].card_lv = card_lv
        end
        _CARD_PRESET_SLOT_EQUIP(i, card_id, card_lv, card_exp)
    end
    Monster_card_changer_save_settings()
end

function Monster_card_changer_color_save(monstercardslot, checkbox, check_name)
    local is_check = checkbox:IsChecked()
    g.monster_card_changer_settings[g.login_name][check_name] = is_check
    Monster_card_changer_save_settings()
end

function Monster_card_changer_remove(monstercardpreset)
    g.monster_card_changer_cardlist = {}
    local mcc_settings = g.monster_card_changer_settings[g.login_name]
    local slot_to_color = {"red", "red", "red", "blue", "blue", "blue", "purple", "purple", "purple", "green", "green",
                           "green"}
    for i = 1, 12 do
        local group_name = CARD_SLOT_GET_GROUP_NAME(i - 1)
        local card_cls_id, card_lv, card_exp = GETMYCARD_INFO(i - 1)
        local color = slot_to_color[i]
        if color and mcc_settings[color] ~= 1 and card_cls_id ~= 0 then
            table.insert(g.monster_card_changer_cardlist, {card_cls_id, card_lv, group_name, nil})
        end
    end
    local preset_list = GET_CHILD_RECURSIVELY(monstercardpreset, "preset_list")
    AUTO_CAST(preset_list)
    local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    AUTO_CAST(monster_card_changer)
    local page = tonumber(preset_list:GetSelItemKey())
    monster_card_changer:SetUserValue("PAGE", page)
    preset_list:SelectItemByKey(4)
    local page = 4
    pc.ReqExecuteTx_NumArgs("SCR_TX_APPLY_CARD_PRESET", page)
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if accountwarehouse:IsVisible() == 1 then
        local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
        AUTO_CAST(monster_card_changer)
        monster_card_changer:RunUpdateScript("Monster_card_changer_get_guid", 1.0)
    end
end

function Monster_card_changer_get_guid(monster_card_changer)
    local msg = g.lang == "Japanese" and
                    "{ol}{#CCCC22}[MCC]動作中。バグ防止の為他の動作は行わないでください" or
                    "{ol}{#CCCC22}[MCC]Operating. Please do not perform other operations to prevent bugs"
    imcAddOn.BroadMsg("NOTICE_Dm_Bell", msg, 2.5)
    local inventory = ui.GetFrame("inventory")
    local inventype_Tab = GET_CHILD_RECURSIVELY(inventory, "inventype_Tab")
    inventype_Tab:SelectTab(4)
    local inv_item_list = session.GetInvItemList()
    local guid_list = inv_item_list:GetGuidList()
    local cnt = guid_list:Count()
    g.monster_card_changer_group_counts = {
        ATK = 0,
        DEF = 0,
        UTIL = 0,
        STAT = 0
    }
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        local item_obj = GetIES(inv_item:GetObject())
        local item_lv = TryGetProp(item_obj, "Level", 0)
        for i, data in ipairs(g.monster_card_changer_cardlist) do
            if not data[4] then
                local cls_id = data[1]
                local card_lv = data[2]
                local group_name = data[3]
                if item_obj.ClassID == cls_id and card_lv == item_lv then
                    if g.monster_card_changer_group_counts[group_name] < 3 then
                        g.monster_card_changer_group_counts[group_name] =
                            g.monster_card_changer_group_counts[group_name] + 1
                        data[4] = guid
                        break
                    end
                end
            end
        end
    end
    local take = monster_card_changer:GetUserValue("TAKE")
    if take ~= "take" then
        monster_card_changer:RunUpdateScript("Monster_card_changer_put_inv_to_warehouse", 0.1)
        return 0
    else
        return g.monster_card_changer_cardlist
    end
end

function Monster_card_changer_put_inv_to_warehouse(monster_card_changer)
    if #g.monster_card_changer_cardlist == 0 then
        Monster_card_changer_end_of_operation(monster_card_changer)
        return 0
    end
    local data = g.monster_card_changer_cardlist[1]
    local guid = data[4]
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    local inventory = ui.GetFrame("inventory")
    if accountwarehouse:IsVisible() ~= 1 and inventory:IsVisible() ~= 1 then
        return 0
    end
    local inv_item = session.GetInvItemList():GetItemByGuid(guid)
    if inv_item then
        item.PutItemToWarehouse(IT_ACCOUNT_WAREHOUSE, guid, 1, accountwarehouse:GetUserIValue("HANDLE"), nil)
    else
        table.remove(g.monster_card_changer_cardlist, 1)
    end
    return 1
end

function Monster_card_changer_equip_get_presetinfo()
    g.monster_card_changer_cardlist = {}
    local mcc_settings = g.monster_card_changer_settings[g.login_name]
    local slot_to_color = {"red", "red", "red", "blue", "blue", "blue", "purple", "purple", "purple", "green", "green",
                           "green"}
    for i = 0, 11 do
        local group_name = CARD_SLOT_GET_GROUP_NAME(i)
        local card_id, card_lv, card_exp = _GETMYCARD_INFO(i)
        local color = slot_to_color[i + 1]
        if mcc_settings[color] == 0 and card_id ~= 0 then
            table.insert(g.monster_card_changer_cardlist, {card_id, card_lv, group_name, nil})
        end
    end
    local accountwarehouse = ui.GetFrame("accountwarehouse")
    if accountwarehouse:IsVisible() == 1 then
        Monster_card_changer_warehouse(accountwarehouse)
    else
        local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
        Monster_card_changer_apply_card_preset(monster_card_changer)
    end
end

function Monster_card_changer_warehouse(accountwarehouse)
    local monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    AUTO_CAST(monster_card_changer)
    monster_card_changer:SetUserValue("TAKE", "take")
    g.monster_card_changer_cardlist = Monster_card_changer_get_guid(monster_card_changer)
    local item_list = session.GetEtcItemList(IT_ACCOUNT_WAREHOUSE)
    local guid_list = item_list:GetGuidList()
    local cnt = guid_list:Count()
    local take_list = {}
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local acw_item = item_list:GetItemByGuid(guid)
        local type = acw_item.type
        local item_obj = GetIES(acw_item:GetObject())
        local item_lv = TryGetProp(item_obj, "Level", 0)
        local group_counts = {
            ATK = 0,
            DEF = 0,
            UTIL = 0,
            STAT = 0
        }
        for i, data in ipairs(g.monster_card_changer_cardlist) do
            if not data[4] then
                local cls_id = data[1]
                local card_lv = data[2]
                local group_name = data[3]
                if type == cls_id and card_lv == item_lv then
                    if g.monster_card_changer_group_counts[group_name] < 3 then
                        g.monster_card_changer_group_counts[group_name] =
                            g.monster_card_changer_group_counts[group_name] + 1
                        data[4] = guid
                        take_list[guid] = 1
                        break
                    end
                end
            end
        end
    end
    session.ResetItemList()
    for guid, count in pairs(take_list) do
        session.AddItemID(tonumber(guid), count)
    end
    item.TakeItemFromWarehouse_List(IT_ACCOUNT_WAREHOUSE, session.GetItemIDList(),
        accountwarehouse:GetUserIValue("HANDLE"))
    monster_card_changer:RunUpdateScript("Monster_card_changer_apply_card_preset", 1.0)
end

function Monster_card_changer_apply_card_preset(monster_card_changer)
    pc.ReqExecuteTx_NumArgs("SCR_TX_APPLY_CARD_PRESET", 0)
    Monster_card_changer_end_of_operation(monster_card_changer)
end

function Monster_card_changer_end_of_operation(monster_card_changer)
    g.monster_card_changer_ready = 3
    if not monster_card_changer then
        monster_card_changer = ui.GetFrame(addon_name_lower .. "monster_card_changer")
    end
    if not monster_card_changer then
        return
    end
    local take = monster_card_changer:GetUserValue("TAKE")
    monster_card_changer:SetUserValue("TAKE", "None")
    g.monster_card_changer_cardlist = nil
    ui.SysMsg("[MCC]End of Operation")
    monster_card_changer:RunUpdateScript("Monster_card_changer_preset_card_set", 1.0)
    monster_card_changer:RunUpdateScript("MONSTERCARDPRESET_FRAME_CLOSE", 3.0)
    monster_card_changer:RunUpdateScript("MONSTERCARDSLOT_CLOSE", 3.0)
end
-- monster_card_changer ここまで

-- market_voucher ここから
g.market_voucher_trans = {
    Japanese = {
        ["Sale Date/Time:"] = "販売日時 : ",
        ["Purchase Date/Time:"] = "購入日時 : ",
        ["name:"] = "名前 : ",
        ["item:"] = "アイテム: ",
        ["quantity:"] = "数量 : ",
        ["unit price:"] = "単価 : ",
        ["total amount:"] = "合計金額 : ",
        ["Total Sales:"] = "売上合計 : ",
        ["Period:"] = "集計期間 : ",
        ["Sales Slip"] = "売上伝票",
        ["Clear Log"] = "ログ削除",
        ["ClearedMsg"] = "販売履歴を削除しました。logtextには残っています。",
        ["CloseFrameTooltip"] = "左クリックでフレームを閉じます。",
        ["ClearLogTooltip"] = "販売履歴を削除します",
        ["sell"] = "販売",
        ["buy"] = "購入"
    },
    Default = {
        ["Sale Date/Time:"] = "Sale Date : ",
        ["Purchase Date/Time:"] = "Purch. Date : ",
        ["name:"] = "Name : ",
        ["item:"] = "Item : ",
        ["quantity:"] = "Qty : ",
        ["unit price:"] = "Unit Price : ",
        ["total amount:"] = "Total : ",
        ["Total Sales:"] = "Total Sales : ",
        ["Period:"] = "Period : ",
        ["Sales Slip"] = "Sales Slip",
        ["Clear Log"] = "Clear Log",
        ["ClearedMsg"] = "The sales history has been deleted. It remains in the log text.",
        ["CloseFrameTooltip"] = "Left-click to close the frame.",
        ["ClearLogTooltip"] = "Clear the sales history",
        ["sell"] = "Sell",
        ["buy"] = "Buy"
    }
}
function Market_voucher_save_settings()
    g.save_json(g.market_voucher_path, g.market_voucher_settings)
end

function Market_voucher_load_settings()
    g.market_voucher_path = string.format("../addons/%s/%s/market_voucher.json", addon_name_lower, g.active_id)
    g.market_voucher_old_path = string.format("../addons/%s/%s/settings_2507.json", "market_voucher", g.active_id)
    g.market_voucher_log_path = string.format("../addons/%s/%s/market_voucher_log.txt", addon_name_lower, g.active_id)
    g.market_voucher_old_log_path = string.format('../addons/%s/log_2507.txt', "market_voucher")
    local settings = g.load_json(g.market_voucher_path)
    if not settings then
        local old_settings = g.load_json(g.market_voucher_old_path)
        if old_settings then
            settings = old_settings
            local old_log_file = io.open(g.market_voucher_old_log_path, "r")
            if old_log_file then
                local content = old_log_file:read("*a")
                old_log_file:close()
                local new_log_file = io.open(g.market_voucher_log_path, "w")
                if new_log_file then
                    new_log_file:write(content)
                    new_log_file:close()
                end
            end
        else
            settings = {}
        end
    end
    g.market_voucher_settings = settings
    Market_voucher_save_settings()
end

function market_voucher_on_init()
    if not g.market_voucher_settings then
        Market_voucher_load_settings()
    end
    local old_func = g.settings.market_voucher.old_init_func
    if _G[old_func] then
        return
    end
    g.setup_hook_and_event(g.addon, "CABINET_GET_ALL_LIST", "Market_voucher_CABINET_GET_ALL_LIST", false)
    g.setup_hook_and_event(g.addon, "_BUY_MARKET_ITEM", "Market_voucher__BUY_MARKET_ITEM", false)
    g.setup_hook_and_event(g.addon, "_CABINET_ITEM_BUY", "Market_voucher__CABINET_ITEM_BUY", false)
    g.addon:RegisterMsg("CABINET_ITEM_LIST", "Market_voucher_init_frame")
end

function Market_voucher_lang_trans(key)
    if g.market_voucher_trans[g.lang] and g.market_voucher_trans[g.lang][key] then
        return g.market_voucher_trans[g.lang][key]
    end
    return g.market_voucher_trans.Default[key] or key
end

function Market_voucher_ui_text(key)
    return "{ol}" .. Market_voucher_lang_trans(key)
end

function Market_voucher_CABINET_GET_ALL_LIST(my_frame, my_msg)
    local fmarket_cabinet, control, strarg, now = g.get_event_args(my_msg)
    local item_count = session.market.GetCabinetItemCount()
    if item_count == 0 then
        return
    end
    local my_char_name = GETMYPCNAME()
    local results_table = {}
    for i = 0, item_count - 1 do
        local cabinet_item = session.market.GetCabinetItemByIndex(i)
        if cabinet_item then
            local where_from = cabinet_item:GetWhereFrom()
            if where_from == "market_sell" then
                local item_obj = GetIES(cabinet_item:GetObject())
                local item_name = dictionary.ReplaceDicIDInCompStr(item_obj.Name)
                local sanitized_item_name = string.gsub(item_name, "-", "?")
                local reg_time = cabinet_item:GetRegSysTime()
                local formatted_time = string.format("%04d-%02d-%02d %02d:%02d:%02d", reg_time.wYear, reg_time.wMonth,
                    reg_time.wDay, reg_time.wHour, reg_time.wMinute, reg_time.wSecond)
                local quantity = tonumber(cabinet_item.sellItemAmount)
                local total_amount = tonumber(cabinet_item:GetCount())
                local unit_price = 0
                if quantity > 0 then
                    unit_price = total_amount / quantity
                end
                local result_string = string.format("%s/%s/%s/%d/%d/%d/%s", formatted_time, my_char_name,
                    sanitized_item_name, quantity, unit_price, total_amount, "sell")
                table.insert(results_table, result_string)
            end
        end
    end
    for i, result_string in ipairs(results_table) do
        table.insert(g.market_voucher_settings, result_string)
    end
    Market_voucher_save_settings()
    if #results_table > 0 then
        local all_results = table.concat(results_table, "\n")
        local file_handle = io.open(g.market_voucher_log_path, "a")
        if file_handle then
            file_handle:write(all_results .. "\n")
            file_handle:close()
        end
    end
    local count = session.market.GetCabinetItemCount()
    AddLuaTimerFuncWithLimitCount("CABINET_GET_ITEM", 200, count * 5)
    local market_cabinet_soldlist = ui.GetFrame("market_cabinet_soldlist")
    if market_cabinet_soldlist then
        ui.CloseFrame("market_cabinet_soldlist")
    end
end

function Market_voucher__BUY_MARKET_ITEM(my_frame, my_msg)
    local row, is_recipe_search_box = g.get_event_args(my_msg)
    local frame = ui.GetFrame("market")
    local total_price = 0
    market.ClearBuyInfo()
    local market_item = nil
    local buy_count = nil
    if is_recipe_search_box and is_recipe_search_box == 1 then
        local recipeSearchGbox = GET_CHILD_RECURSIVELY(frame, "recipeSearchGbox")
        local child = recipeSearchGbox:GetChildByIndex(row - 1)
        local count = GET_CHILD_RECURSIVELY(child, "count")
        if count == nil then
            market_item = session.market.GetRecipeSearchByIndex(row - 1)
            market.AddBuyInfo(market_item:GetMarketGuid(), 1)
            total_price = SumForBigNumber(total_price, market_item:GetSellPrice())
        else
            buy_count = count:GetText()
            if tonumber(buy_count) > 0 then
                market_item = session.market.GetRecipeSearchByIndex(row - 1)
                market.AddBuyInfo(market_item:GetMarketGuid(), buy_count)
                total_price = SumForBigNumber(total_price, math.mul_int_for_lua(buy_count, market_item:GetSellPrice()))
            else
                ui.SysMsg(ScpArgMsg("YouCantBuyZeroItem"))
            end
        end
    else
        local itemListGbox = GET_CHILD_RECURSIVELY(frame, "itemListGbox")
        local child = itemListGbox:GetChildByIndex(row - 1)
        if child == nil then
            market_item = session.market.GetItemByIndex(row - 1)
            market.AddBuyInfo(market_item:GetMarketGuid(), 1)
            total_price = SumForBigNumber(total_price, market_item:GetSellPrice())
        else
            local count = GET_CHILD_RECURSIVELY(child, "count")
            buy_count = 1
            if count then
                buy_count = count:GetText()
            end
            if tonumber(buy_count) > 0 then
                market_item = session.market.GetItemByIndex(row - 1)
                market.AddBuyInfo(market_item:GetMarketGuid(), buy_count)
                total_price = SumForBigNumber(total_price, math.mul_int_for_lua(buy_count, market_item:GetSellPrice()))
            else
                ui.SysMsg(ScpArgMsg("YouCantBuyZeroItem"))
            end
        end
    end
    if total_price == 0 then
        return
    end
    if IsGreaterThanForBigNumber(total_price, GET_TOTAL_MONEY_STR()) == 1 then
        ui.SysMsg(ClMsg("NotEnoughMoney"))
        return
    end
    local limit_trade_str = GET_REMAIN_MARKET_TRADE_AMOUNT_STR()
    if limit_trade_str then
        if IsGreaterThanForBigNumber(total_price, limit_trade_str) == 1 then
            ui.SysMsg(ScpArgMsg('MarketMaxSilverLimit{LIMIT}Over', 'LIMIT', GET_COMMAED_STRING(limit_trade_str)))
            return
        end
    end
    local my_char_name = GETMYPCNAME()
    local item_obj = GetIES(market_item:GetObject())
    local item_name = dictionary.ReplaceDicIDInCompStr(item_obj.Name)
    local sanitized_item_name = string.gsub(item_name, "-", "?")
    local time = geTime.GetServerSystemTime()
    local formatted_time = string.format("%04d-%02d-%02d %02d:%02d:%02d", time.wYear, time.wMonth, time.wDay,
        time.wHour, time.wMinute, time.wSecond)
    local quantity = tonumber(buy_count)
    local total_amount = tonumber(total_price)
    local unit_price = 0
    if quantity > 0 then
        unit_price = total_amount / quantity
    end
    local result_string = string.format("%s/%s/%s/%d/%d/%d/%s", formatted_time, my_char_name, sanitized_item_name,
        quantity, unit_price, total_amount, "buy")
    table.insert(g.market_voucher_settings, result_string)
    local file_handle = io.open(g.market_voucher_log_path, "a")
    if file_handle then
        file_handle:write(result_string .. "\n")
        file_handle:close()
    end
    Market_voucher_save_settings()
    market.ReqBuyItems()
end

function Market_voucher__CABINET_ITEM_BUY(my_frame, my_msg)
    local frame, ctrl, guid = g.get_event_args(my_msg)
    local cabinet_item = session.market.GetCabinetItemByItemID(guid)
    local item_obj = GetIES(cabinet_item:GetObject())
    local item_name = dictionary.ReplaceDicIDInCompStr(item_obj.Name)
    local sanitized_item_name = string.gsub(item_name, "-", "?")
    local reg_time = cabinet_item:GetRegSysTime()
    local formatted_time = string.format("%04d-%02d-%02d %02d:%02d:%02d", reg_time.wYear, reg_time.wMonth,
        reg_time.wDay, reg_time.wHour, reg_time.wMinute, reg_time.wSecond)
    local quantity = tonumber(cabinet_item.sellItemAmount)
    local total_amount = tonumber(cabinet_item:GetCount())
    local unit_price = 0
    if quantity > 0 then
        unit_price = total_amount / quantity
    end
    local my_char_name = GETMYPCNAME()
    local result_string = string.format("%s/%s/%s/%d/%d/%d/%s", formatted_time, my_char_name, sanitized_item_name,
        quantity, unit_price, total_amount, "sell")
    table.insert(g.market_voucher_settings, result_string)
    local file_handle = io.open(g.market_voucher_log_path, "a")
    if file_handle then
        file_handle:write(result_string .. "\n")
        file_handle:close()
    end
    Market_voucher_save_settings()
    market.ReqGetCabinetItem(guid)
    local market_cabinet_popup = ui.GetFrame("market_cabinet_popup")
    if market_cabinet_popup then
        ui.CloseFrame("market_cabinet_popup")
    end
end

function Market_voucher_init_frame()
    local market_cabinet = ui.GetFrame("market_cabinet")
    if g.settings.market_voucher.use == 0 then
        local log_btn = GET_CHILD(market_cabinet, "log_btn")
        if log_btn then
            DESTROY_CHILD_BYNAME(market_cabinet, "log_btn")
        end
        return
    end
    if market_cabinet:GetChild("log_btn") then
        return
    end
    local log_btn = market_cabinet:CreateOrGetControl("button", "log_btn", 610, 120, 100, 30)
    AUTO_CAST(log_btn)
    log_btn:SetSkinName("tab2_btn")
    local text = "{@st66b18}" .. Market_voucher_lang_trans("Sales Slip")
    log_btn:SetText(text)
    log_btn:SetEventScript(ui.LBUTTONUP, "Market_voucher_print")
    log_btn:ShowWindow(1)
end

function Market_voucher_print()
    if #g.market_voucher_settings == 0 then
        return
    end
    local market_voucher = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "market_voucher", 0, 0, 0, 0)
    AUTO_CAST(market_voucher)
    market_voucher:SetSkinName("downbox")
    market_voucher:ShowTitleBar(0)
    market_voucher:SetOffset(15, 175)
    market_voucher:Resize(1280, 770)
    market_voucher:EnableHitTest(1)
    market_voucher:SetLayerLevel(100)
    local bg = market_voucher:CreateOrGetControl("groupbox", "bg", 5, 5, 1270, 720)
    AUTO_CAST(bg)
    bg:SetSkinName("chat_window")
    bg:SetTextTooltip(Market_voucher_ui_text("CloseFrameTooltip"))
    bg:SetEventScript(ui.LBUTTONUP, "Market_voucher_print_close")
    local log_delete_button = market_voucher:CreateOrGetControl("button", "logdelete", 1180, 735, 80, 30)
    AUTO_CAST(log_delete_button)
    log_delete_button:SetTextTooltip(Market_voucher_ui_text("ClearLogTooltip"))
    log_delete_button:SetText(Market_voucher_ui_text("Clear Log"))
    log_delete_button:SetEventScript(ui.LBUTTONUP, "Market_voucher_clear")
    local close_button = market_voucher:CreateOrGetControl("button", "close", 1245, 0, 30, 30)
    AUTO_CAST(close_button)
    close_button:SetImage("testclose_button")
    close_button:SetEventScript(ui.LBUTTONUP, "Market_voucher_print_close")
    local sumtotal_amount = 0
    table.sort(g.market_voucher_settings, function(a, b)
        return a > b
    end)
    local item_count = #g.market_voucher_settings
    local y_pos = 5
    for i = 1, item_count do
        local tokens = StringSplit(g.market_voucher_settings[i], '/')
        local date_str = tokens[1]
        local name_str = tokens[2]
        local item_str = string.gsub(tokens[3], "?", "-")
        local quantity_str = tokens[4]
        local unit_price_val = tonumber(tokens[5])
        local total_amount_val = tonumber(tokens[6])
        local status = tokens[7]
        local line_text = ""
        if status == "sell" then
            status = Market_voucher_ui_text(status)
            sumtotal_amount = sumtotal_amount + total_amount_val
            unit_price_val = unit_price_val / 0.9
            line_text = string.format("%s%s ･ %s ･ %s ･ %s%s ･ %s%s ･ %s%s ･ %s",
                Market_voucher_lang_trans("Sale Date/Time:"), date_str, name_str, item_str,
                Market_voucher_lang_trans("quantity:"), quantity_str, Market_voucher_lang_trans("unit price:"),
                GET_COMMAED_STRING(unit_price_val), Market_voucher_lang_trans("total amount:"),
                GET_COMMAED_STRING(total_amount_val), status)
        elseif status == "buy" then
            status = Market_voucher_ui_text(status)
            sumtotal_amount = sumtotal_amount - total_amount_val
            line_text = "{#DAA520}" .. string.format("%s%s ･ %s ･ %s ･ %s%s ･ %s%s ･ %s△%s ･ %s",
                Market_voucher_lang_trans("Purchase Date/Time:"), date_str, name_str, item_str,
                Market_voucher_lang_trans("quantity:"), quantity_str, Market_voucher_lang_trans("unit price:"),
                GET_COMMAED_STRING(unit_price_val), Market_voucher_lang_trans("total amount:"),
                GET_COMMAED_STRING(total_amount_val), status)
        end
        local text_view = bg:CreateOrGetControl("richtext", "textview" .. i, 5, y_pos)
        AUTO_CAST(text_view)
        text_view:SetText("{ol}" .. line_text)
        y_pos = y_pos + 20
    end
    local date_pattern = "^(%d%d%d%d%-%d%d%-%d%d)"
    local latest_date_str = string.match(g.market_voucher_settings[1], date_pattern)
    local earliest_date_str = string.match(g.market_voucher_settings[item_count], date_pattern)
    local sum_total_amount_text = market_voucher:CreateOrGetControl("richtext", "sumtotal_amount_text", 900, 740, 100,
        30)
    local rounded_number = math.floor(sumtotal_amount / 1000000 + 0.5)
    sum_total_amount_text:SetText("{#FF0000}" .. Market_voucher_ui_text("Total Sales:") ..
                                      GET_COMMAED_STRING(sumtotal_amount) .. "(" .. GET_COMMAED_STRING(rounded_number) ..
                                      "M)")
    sum_total_amount_text:ShowWindow(1)
    local period_text = market_voucher:CreateOrGetControl("richtext", "date_text", 620, 740, 100, 30)
    period_text:SetText(Market_voucher_ui_text("Period:") .. earliest_date_str .. "～" .. latest_date_str)
    market_voucher:ShowWindow(1)
    market_voucher:RunUpdateScript("Market_voucher_auto_close", 0.3)
end

function Market_voucher_auto_close(market_voucher)
    local market_cabinet = ui.GetFrame("market_cabinet")
    if market_cabinet:IsVisible() == 1 then
        return 1
    else
        ui.DestroyFrame(market_voucher:GetName())
        market_cabinet:RemoveChild("log_btn")
        return 0
    end
end

function Market_voucher_clear()
    g.market_voucher_settings = {}
    ui.SysMsg(Market_voucher_ui_text("ClearedMsg"))
    Market_voucher_save_settings()
end

function Market_voucher_print_close()
    local market_voucher = ui.GetFrame(addon_name_lower .. "market_voucher")
    ui.DestroyFrame(market_voucher:GetName())
end
-- market_voucher ここまで

-- lets_go_home　ここから
function Lets_go_home_save_settings()
    g.save_json(g.lets_go_home_path, g.lets_go_home_settings)
end

function Lets_go_home_load_settings()
    g.lets_go_home_path = string.format("../addons/%s/%s/lets_go_home.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.lets_go_home_path)
    if not settings then
        settings = {
            map = "",
            ch = 1,
            leticia = 0,
            x = 0,
            y = 0,
            move = 1,
            display = 1,
            short_cut = 1
        }
    end
    g.lets_go_home_settings = settings
    Lets_go_home_save_settings()
end

function lets_go_home_on_init()
    if not g.lets_go_home_settings then
        Lets_go_home_load_settings()
    end
    local old_func = g.settings.lets_go_home.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.lets_go_home.use == 0 then
        local lets_go_home = ui.GetFrame(addon_name_lower .. "lets_go_home")
        if lets_go_home then
            ui.DestroyFrame(lets_go_home:GetName())
        end
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        _nexus_addons:SetVisible(1)
        local lets_go_home_timer = GET_CHILD(_nexus_addons, "lets_go_home_timer")
        if lets_go_home_timer then
            AUTO_CAST(lets_go_home_timer)
            lets_go_home_timer:Stop()
        end
        return
    end
    Lets_go_home_frame_init()
    if g.lets_go_home_warp_state == 1 then
        Lets_go_home_change_move()
    end
end

function Lets_go_home_frame_init()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    _nexus_addons:SetVisible(1)
    local lets_go_home_timer = _nexus_addons:CreateOrGetControl("timer", "lets_go_home_timer", 0, 0)
    AUTO_CAST(lets_go_home_timer)
    lets_go_home_timer:SetUpdateScript("Lets_go_home_key_press")
    lets_go_home_timer:Start(0.2)
    if g.lets_go_home_settings.display == 0 then
        return
    end
    local lets_go_home = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "lets_go_home", 0, 0, 0, 0)
    AUTO_CAST(lets_go_home)
    lets_go_home:SetSkinName('None')
    lets_go_home:SetTitleBarSkin("None")
    lets_go_home:Resize(40, 30)
    lets_go_home:SetGravity(ui.RIGHT, ui.TOP)
    lets_go_home:EnableHitTest(1)
    lets_go_home:EnableHittestFrame(1)
    lets_go_home:EnableMove(g.lets_go_home_settings.move)
    local rect = lets_go_home:GetMargin()
    lets_go_home:SetMargin(rect.left - rect.left, rect.top - rect.top + 305, rect.right + 305, rect.bottom)
    if g.lets_go_home_settings.x ~= 0 and g.lets_go_home_settings.y ~= 0 then
        lets_go_home:SetPos(g.lets_go_home_settings.x, g.lets_go_home_settings.y)
    end
    local btn = lets_go_home:CreateOrGetControl('button', 'home', 0, 0, 30, 30)
    AUTO_CAST(btn)
    btn:SetGravity(ui.LEFT, ui.TOP)
    btn:SetSkinName("None")
    btn:SetText("{img btn_housing_editmode_small_resize 30 30}")
    btn:SetTextTooltip(g.lang == "Japanese" and
                           "{ol}右クリック:ホーム設定{nl}左クリック:ワープ{nl}ショートカット:BackSlash+RSHIFT" or
                           "{ol}Rightclick:Home Setting{nl}Leftclick:Warp{nl}Shortcut:BackSlash+RSHIFT")
    btn:SetEventScript(ui.RBUTTONUP, "Lets_go_home_settings")
    btn:SetEventScript(ui.LBUTTONDOWN, "Lets_go_home_warp_do")
    lets_go_home:ShowWindow(1)
    btn:SetEventScript(ui.LBUTTONUP, "Lets_go_home_frame_move_save")
    lets_go_home:RunUpdateScript("Lets_go_home_update_frame", 1.0)
end

function Lets_go_home_frame_move_save(lets_go_home)
    g.lets_go_home_settings.x = lets_go_home:GetX()
    g.lets_go_home_settings.y = lets_go_home:GetY()
    Lets_go_home_save_settings()
end

function Lets_go_home_settings_frame_close(list_frame)
    ui.DestroyFrame(list_frame:GetName())
end

function Lets_go_home_settings_frame()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local lets_go_home_setting = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "lets_go_home_setting", 0, 0, 0,
        0)
    lets_go_home_setting:Resize(370, 250)
    lets_go_home_setting:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    lets_go_home_setting:SetSkinName("test_frame_low")
    lets_go_home_setting:EnableHittestFrame(1)
    lets_go_home_setting:EnableHitTest(1)
    lets_go_home_setting:SetLayerLevel(999)
    lets_go_home_setting:ShowWindow(1)
    local title_text = lets_go_home_setting:CreateOrGetControl('richtext', 'title_text', 20, 15, 50, 30)
    AUTO_CAST(title_text)
    title_text:SetText("{ol}Lets Go Home Config")
    local close = lets_go_home_setting:CreateOrGetControl("button", "close", 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Lets_go_home_settings_frame_close")
    local gbox = lets_go_home_setting:CreateOrGetControl("groupbox", "gbox", 10, 40,
        lets_go_home_setting:GetWidth() - 20, lets_go_home_setting:GetHeight() - 50)
    AUTO_CAST(gbox)
    gbox:SetSkinName("test_frame_midle_light")
    local map_text = gbox:CreateOrGetControl('richtext', 'map_text', 10, 10, 150, 30)
    AUTO_CAST(map_text)
    map_text:SetText(g.lang == "Japanese" and "{ol}ホームタウン" or "{ol}Hometown")
    local map_drop_list = gbox:CreateOrGetControl('droplist', 'map_drop_list', 150, 10, 180, 20)
    AUTO_CAST(map_drop_list)
    map_drop_list:SetSkinName('droplist_normal')
    map_drop_list:EnableHitTest(1)
    map_drop_list:SetTextAlign("center", "center")
    local citys = {"c_Klaipe", "c_orsha", "c_fedimian"}
    local selected_index = 0
    map_drop_list:AddItem(0, g.lang == "Japanese" and "{ol}未設定" or "{ol}None", 0, "Lets_go_home_map_settings('')")
    for i, city_class_name in ipairs(citys) do
        local map_cls = GetClass("Map", city_class_name)
        if map_cls then
            local scp = string.format("Lets_go_home_map_settings('%s')", city_class_name)
            map_drop_list:AddItem(i, "{ol}" .. map_cls.Name, 0, scp)
            if g.lets_go_home_settings.map == city_class_name then
                selected_index = i
            end
        end
    end
    map_drop_list:SelectItem(selected_index)
    local ch_text = gbox:CreateOrGetControl('richtext', 'ch_text', 10, 40, 150, 30)
    AUTO_CAST(ch_text)
    ch_text:SetText(g.lang == "Japanese" and "{ol}チャンネル" or "{ol}Channel")
    local ch_drop_list = gbox:CreateOrGetControl('droplist', 'ch_drop_list', 150, 40, 180, 20)
    AUTO_CAST(ch_drop_list)
    ch_drop_list:SetSkinName('droplist_normal')
    ch_drop_list:EnableHitTest(1)
    ch_drop_list:SetTextAlign("center", "center")
    for i = 1, 10 do
        local scp = string.format("Lets_go_home_ch_settings(%d)", i)
        ch_drop_list:AddItem(i - 1, "{ol}" .. tostring(i) .. " ch", 0, scp)
        if g.lets_go_home_settings.ch == i then
            selected_index = i - 1
        end
    end
    ch_drop_list:SelectItem(selected_index)
    local btn_move = gbox:CreateOrGetControl('checkbox', "btn_move", 10, 70, 30, 30)
    AUTO_CAST(btn_move)
    btn_move:SetText(g.lang == "Japanese" and "{ol}ボタン位置固定" or "{ol}Fix button position")
    btn_move:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックするとボタン固定" or
                                "{ol}Checked: the button is fixed")
    btn_move:SetEventScript(ui.LBUTTONUP, "Lets_go_home_check_toggle")
    btn_move:SetCheck(g.lets_go_home_settings.move)
    local btn = gbox:CreateOrGetControl('button', 'home', 210, 70, 80, 30)
    AUTO_CAST(btn)
    btn:SetText(g.lang == "Japanese" and "{ol}ボタン初期位置" or "{ol}Btn Init Pos")
    btn:SetEventScript(ui.LBUTTONUP, "Lets_go_home_init_pos")
    local btn_display = gbox:CreateOrGetControl('checkbox', "btn_display", 10, 100, 30, 30)
    AUTO_CAST(btn_display)
    btn_display:SetText(g.lang == "Japanese" and "{ol}ボタン表示設定" or "{ol}Button display settings")
    btn_display:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックするとボタン表示" or
                                   "{ol}Checked: the button is shown")
    btn_display:SetEventScript(ui.LBUTTONUP, "Lets_go_home_check_toggle")
    btn_display:SetCheck(g.lets_go_home_settings.display)
    local short_cut = gbox:CreateOrGetControl('checkbox', "short_cut", 10, 130, 30, 30)
    AUTO_CAST(short_cut)
    short_cut:SetText(g.lang == "Japanese" and "{ol}ショートカット設定(BackSlash+RSHIFT)" or
                          "{ol}Shortcut Setting(BackSlash+RSHIFT)")
    short_cut:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックするとショートカット有効化" or
                                 "{ol}Checked: enables the shortcut")
    short_cut:SetEventScript(ui.LBUTTONUP, "Lets_go_home_check_toggle")
    short_cut:SetCheck(g.lets_go_home_settings.short_cut)
    local leticia = gbox:CreateOrGetControl('checkbox', "leticia", 10, 160, 30, 30)
    AUTO_CAST(leticia)
    leticia:SetText(g.lang == "Japanese" and "{ol}レティーシア移動設定" or "{ol}Leticia Move Settings")
    leticia:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックするとレティーシア移動有効化" or
                               "{ol}Checked: enables the Leticia Move")
    leticia:SetEventScript(ui.LBUTTONUP, "Lets_go_home_check_toggle")
    leticia:SetCheck(g.lets_go_home_settings.leticia)
end

function Lets_go_home_map_settings(city_class_name)
    g.lets_go_home_settings.map = city_class_name
    Lets_go_home_save_settings()
end

function Lets_go_home_ch_settings(channel)
    g.lets_go_home_settings.ch = channel
    Lets_go_home_save_settings()
end

function Lets_go_home_check_toggle(parent, ctrl)
    local ctrl_name = ctrl:GetName()
    local is_check = ctrl:IsChecked()
    if ctrl_name == "btn_move" then
        g.lets_go_home_settings.move = is_check
    elseif ctrl_name == "btn_display" then
        g.lets_go_home_settings.display = is_check
        if is_check == 0 then
            local lets_go_home = ui.GetFrame(addon_name_lower .. "lets_go_home")
            if lets_go_home then
                ui.DestroyFrame(lets_go_home:GetName())
            end
        else
            Lets_go_home_frame_init()
        end
    elseif ctrl_name == "short_cut" then
        g.lets_go_home_settings.short_cut = is_check
    elseif ctrl_name == "leticia" then
        g.lets_go_home_settings.leticia = is_check
    end
    Lets_go_home_save_settings()
end

function Lets_go_home_init_pos()
    g.lets_go_home_settings.x = 0
    g.lets_go_home_settings.y = 0
    Lets_go_home_save_settings()
    local lets_go_home = ui.GetFrame(addon_name_lower .. "lets_go_home")
    if lets_go_home then
        ui.DestroyFrame(lets_go_home:GetName())
    end
    ReserveScript("Lets_go_home_frame_init()", 0.1)
end

function Lets_go_home_settings()
    if g.get_map_type() == "City" then
        local msg = g.lang == "Japanese" and "現在のマップとチャンネルをホームにしますか？" or
                        "Do you want to home in on the current map and channel?"
        local yes_scp = string.format("Lets_go_home_settings_reg()")
        ui.MsgBox(msg, yes_scp, "None")
    else
        ui.SysMsg(g.lang == "Japanese" and "このマップは設定できません" or "This map cannot be set up")
    end
end

function Lets_go_home_settings_reg()
    local channel = session.loginInfo.GetChannel() + 1
    local map_cls = GetClass("Map", g.map_name)
    local map_clas_name = map_cls.ClassName
    local map_name = map_cls.Name
    g.lets_go_home_settings.ch = channel
    g.lets_go_home_settings.map = map_clas_name
    g.lets_go_home_settings.leticia = 0
    ui.SysMsg(g.lang == "Japanese" and "マップ名: " .. map_name .. " チャンネル: " .. channel ..
                  "を登録{nl}レティーシャへの移動を無効にしました" or "MapName: " .. map_name ..
                  " Channel: " .. channel .. "Registered{nl}Move to Leticia disabled")
    Lets_go_home_save_settings()
    local msg = g.lang == "Japanese" and "レティーシャへ移動は使用しますか？" or
                    "Do you use Move to Leticia?"
    local yes_scp = string.format("Lets_go_home_settings_reg_()")
    ui.MsgBox(msg, yes_scp, "None")
end

function Lets_go_home_settings_reg_()
    ui.SysMsg(g.lang == "Japanese" and "レティーシャへの移動を有効にしました" or
                  "Move to Leticia enabled")
    g.lets_go_home_settings.leticia = 1
    Lets_go_home_save_settings()
end

function Lets_go_home_update_frame(lets_go_home)
    local home = GET_CHILD(lets_go_home, "home")
    local cd_text = home:CreateOrGetControl('richtext', 'cd_text', 5, 10)
    AUTO_CAST(cd_text)
    local cd = GET_TOKEN_WARP_COOLDOWN()
    cd_text:SetText("{ol}{#FFFFFF}{s13}" .. cd)
    if cd >= 100 then
        cd_text:ShowWindow(1)
        return 1
    elseif cd < 100 and cd >= 10 then
        cd_text:SetOffset(9, 10)
        return 1
    elseif cd < 10 and cd >= 1 then
        cd_text:SetOffset(13, 10)
        return 1
    else
        cd_text:ShowWindow(0)
        return 0
    end
end

function Lets_go_home_warp_do()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    g.lets_go_home_warp_state = 1
    Lets_go_home_change_move(_nexus_addons)
end

function Lets_go_home_key_press(_nexus_addons, lets_go_home_timer)
    if g.lets_go_home_settings.short_cut == 0 then
        return
    end
    if 1 == keyboard.IsKeyPressed("BACKSLASH") and 1 == keyboard.IsKeyPressed("RSHIFT") then
        g.lets_go_home_warp_state = 1
        Lets_go_home_change_move()
    end
end

function Lets_go_home_change_move()
    if ENABLE_WARP_CHECK(GetMyPCObject()) == false then
        ui.SysMsg(ScpArgMsg("WarpBanBountyHunt"))
        g.lets_go_home_warp_state = 0
        return
    end
    local save_map = g.lets_go_home_settings.map
    if save_map == "" then
        ui.MsgBox(g.lang == "Japanese" and "マップ未設定です" or "Not Map setting")
        g.lets_go_home_warp_state = 0
        return
    end
    local quests = {
        ["c_Klaipe"] = {{
            quest_id = 91055,
            result = "POSSIBLE",
            state = "Start"
        }, {
            quest_id = 72165,
            result = "SUCCESS",
            state = "End"
        }},
        ["c_orsha"] = {{
            quest_id = 90170,
            result = "SUCCESS",
            state = "End"
        }, {
            quest_id = 90171,
            result = "SUCCESS",
            state = "End"
        }},
        ["c_fedimian"] = {{
            quest_id = 60400,
            result = "POSSIBLE",
            state = "Start"
        }}
    }
    if save_map ~= g.map_name then
        local pc = GetMyPCObject()
        local quest_id = nil
        for key, value in pairs(quests) do
            if key == save_map then
                for key2, value2 in pairs(value) do
                    local questIES = GetClassByType('QuestProgressCheck', value2.quest_id)
                    local result = SCR_QUEST_CHECK_C(pc, questIES.ClassName)
                    local questState = GET_QUEST_NPC_STATE(questIES, result)
                    if result == value2.result and questState == value2.state then
                        quest_id = value2.quest_id
                        break
                    end
                end
            end
        end
        if quest_id then
            QUESTION_QUEST_WARP(nil, nil, nil, quest_id)
        else
            Lets_go_home_not_quest_warp(save_map)
        end
        return
    end
    local save_ch = g.lets_go_home_settings.ch
    local channel = session.loginInfo.GetChannel() + 1
    if channel ~= save_ch then
        RUN_GAMEEXIT_TIMER("Channel", save_ch - 1)
        return
    end
    g.lets_go_home_warp_state = 0
    local leticia_warp = g.lets_go_home_settings.leticia
    if leticia_warp == 1 then
        Lets_go_home_leticia_move()
    end
end

function Lets_go_home_not_quest_warp(save_map)
    local cd = GET_TOKEN_WARP_COOLDOWN()
    if cd == 0 then
        g.lets_go_home_warp_state = 1
        WORLDMAP2_TOKEN_WARP_REQUEST(save_map)
        return
    end
    local warp_items = {
        ["c_Klaipe"] = 640073,
        ["c_orsha"] = 640156,
        ["c_fedimian"] = 640182
    }
    session.ResetItemList()
    local inv_item_list = session.GetInvItemList()
    local guid_list = inv_item_list:GetGuidList()
    local cnt = guid_list:Count()
    for i = 0, cnt - 1 do
        local guid = guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        local item_obj = GetIES(inv_item:GetObject())
        local target_id = warp_items[save_map]
        if item_obj.ClassID == target_id and g.map_name ~= save_map then
            if TRY_TO_USE_WARP_ITEM(inv_item, item_obj) ~= 1 then
                g.lets_go_home_warp_state = 1
                INV_ICON_USE(inv_item)
                return
            end
        end
    end
    ui.MsgBox(g.lang == "Japanese" and "ワープする方法がありません" or "There is no way to warp")
    g.lets_go_home_warp_state = 0
end

function Lets_go_home_leticia_move()
    local guid = 309
    local cls = GetClassByType("full_screen_navigation_menu", guid)
    if cls ~= nil then
        local name = TryGetProp(cls, "Name", "None")
        local move_zone_select = TryGetProp(cls, "MoveZoneSelect", "NO")
        local move_zone = TryGetProp(cls, "MoveZone", "None")
        local move_npc_dialog = TryGetProp(cls, "MoveNpcDialog", "None")
        local move_zone_select_msg = TryGetProp(cls, "MoveZoneSelectMsg", "None")
        local move_only_in_town = TryGetProp(cls, "MoveOnlyInTown", "None")
        if move_zone ~= "None" and move_npc_dialog ~= "None" then
            local pc = GetMyPCObject()
            if session.world.IsIntegrateServer() == true or IsPVPField(pc) == 1 or IsPVPServer(pc) == 1 then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            if world.GetLayer() ~= 0 then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            if g.get_map_type() == "Dungeon" then
                ui.SysMsg(ScpArgMsg("ThisLocalUseNot"))
                return
            end
            local cur_map = GetClass("Map", session.GetMapName())
            local zoneKeyword = TryGetProp(cur_map, 'Keyword', 'None')
            local keywordTable = StringSplit(zoneKeyword, '')
            if table.find(keywordTable, 'IsRaidField') > 0 or table.find(keywordTable, 'WeeklyBossMap') > 0 then
                ui.SysMsg(ScpArgMsg('ThisLocalUseNot'))
                return
            end
            FullScreenMenuMoveNpc(name, move_zone_select, move_zone, move_npc_dialog, move_zone_select_msg,
                move_only_in_town)
            ui.CloseFrame("fullscreen_navigation_menu")
        end
    end
end
-- lets_go_home　ここまで

-- debuff_notice ここから
function debuff_notice_on_init()
    g.debuff_notice = {
        slot_table = {},
        highlander = false
    }
    local map_name = session.GetMapName()
    if map_name == "c_highlander" then
        g.debuff_notice.highlander = true
    end
    if type(_G["COMMON_BUFF_MSG_OLD"]) == "function" then
        g.setup_hook_and_event(g.addon, "COMMON_BUFF_MSG_OLD", "Debuff_notice_COMMON_BUFF_MSG", true)
    else
        g.setup_hook_and_event(g.addon, "COMMON_BUFF_MSG", "Debuff_notice_COMMON_BUFF_MSG", true)
    end
    if g.get_map_type() ~= "City" or g.debuff_notice.highlander then
        Debuff_notice_frame_init()
    end
end

function Debuff_notice_COMMON_BUFF_MSG(my_frame, my_msg)
    if g.settings.debuff_notice.use == 0 then
        return
    end
    if g.get_map_type() == "City" and not g.debuff_notice.highlander then
        return
    end
    local frame, msg, buff_id, handle, buff_ui, buff_index = g.get_event_args(my_msg)
    local debuff_notice = ui.GetFrame(addon_name_lower .. "debuff_notice")
    if not debuff_notice then
        return
    end
    if msg == "CLEAR" then
        if g.debuff_notice.slot_table[handle] then
            g.debuff_notice.slot_table[handle] = nil
            Debuff_notice_frame_redraw(debuff_notice, handle)
        end
        return
    end
    if msg == "SET" then
        return
    end
    buff_id = tonumber(buff_id)
    local buff_cls = GetClassByType('Buff', buff_id)
    if not buff_cls or (buff_cls.Group1 ~= "Debuff" and buff_cls.Group1 ~= "Deuff") or buff_cls.ShowIcon == "FALSE" then
        return
    end
    local image_name = GET_BUFF_ICON_NAME(buff_cls)
    if image_name == "icon_None" then
        return
    end
    if msg ~= 'REMOVE' then
        local buff = info.GetBuff(handle, buff_id, buff_index)
        if not buff or buff:GetHandle() ~= session.GetMyHandle() then
            return
        end
    end
    local actor = world.GetActor(handle)
    if not actor then
        return
    end
    local mon_cls = GetClassByType("Monster", actor:GetType())
    if TryGetProp(mon_cls, "MonRank", "None") ~= "Boss" and not g.debuff_notice.highlander then
        return
    end
    if not g.debuff_notice.slot_table[handle] then
        g.debuff_notice.slot_table[handle] = {}
    end
    if msg == 'ADD' or msg == "UPDATE" then
        g.debuff_notice.slot_table[handle][buff_id] = {
            buff_index = buff_index,
            image_name = image_name
        }
    elseif msg == 'REMOVE' then
        g.debuff_notice.slot_table[handle][buff_id] = nil
    end
    Debuff_notice_frame_redraw(debuff_notice, handle)
end

function Debuff_notice_frame_init()
    local targetbuff = ui.GetFrame("targetbuff")
    local frame_name = addon_name_lower .. "debuff_notice"
    local debuff_notice = ui.CreateNewFrame("notice_on_pc", frame_name, 0, 0, 0, 0)
    debuff_notice:SetSkinName("None")
    debuff_notice:SetTitleBarSkin("None")
    debuff_notice:Resize(0, 0)
    debuff_notice:SetPos(targetbuff:GetX() + 100, targetbuff:GetY() + targetbuff:GetHeight() + 50)
    local debuff_slotset = debuff_notice:CreateOrGetControl("slotset", "debuff_slotset", 0, 0, 415, 50)
    AUTO_CAST(debuff_slotset)
    debuff_slotset:SetColRow(8, 1)
    debuff_slotset:SetSlotSize(50, 50)
    debuff_slotset:SetSpc(0, 0)
    debuff_slotset:EnablePop(0)
    debuff_slotset:EnableDrag(0)
    debuff_slotset:EnableDrop(0)
    debuff_slotset:CreateSlots()
    debuff_notice:ShowWindow(1)
    debuff_notice:RunUpdateScript("Debuff_notice_update_and_cleanup", 0.1)
    return debuff_notice
end

function Debuff_notice_frame_redraw(debuff_notice, handle)
    local debuff_slotset = GET_CHILD(debuff_notice, "debuff_slotset")
    AUTO_CAST(debuff_slotset)
    debuff_notice:SetUserValue("HANDLE", handle)
    local buffs_to_display = {}
    if g.debuff_notice.slot_table[handle] then
        for buff_id, buff_data in pairs(g.debuff_notice.slot_table[handle]) do
            table.insert(buffs_to_display, {
                id = buff_id,
                index = buff_data.buff_index,
                image = buff_data.image_name
            })
        end
    end
    table.sort(buffs_to_display, function(a, b)
        return tonumber(a.index) < tonumber(b.index)
    end)
    if #buffs_to_display > 0 then
        debuff_notice:Resize(#buffs_to_display * 50, 50)
    else
        debuff_notice:Resize(0, 0)
    end
    for i = 1, debuff_slotset:GetSlotCount() do
        local slot = GET_CHILD(debuff_slotset, "slot" .. i)
        AUTO_CAST(slot)
        local buff_data = buffs_to_display[i]
        if buff_data then
            local icon = slot:GetIcon()
            if not icon then
                icon = CreateIcon(slot)
            end
            AUTO_CAST(icon)
            icon:Set(buff_data.image, 'BUFF', buff_data.id, 0)
            icon:SetTooltipType('buff')
            icon:SetTooltipArg(handle, buff_data.id, buff_data.index)
            icon:SetUserValue("BuffIndex", buff_data.index)
            slot:CreateOrGetControl('richtext', "time_text", 10, 35, 20, 20)
            slot:CreateOrGetControl('richtext', "count_text", 5, 0, 40, 35)
        else
            slot:ClearIcon()
        end
    end
end

function Debuff_notice_update_and_cleanup(debuff_notice)
    local handle = debuff_notice:GetUserIValue("HANDLE")
    if not handle or handle == 0 then
        debuff_notice:Resize(0, 0)
        return 1
    end
    local actor = world.GetActor(handle)
    if not actor then
        debuff_notice:Resize(0, 0)
        return 1
    end
    local debuff_slotset = GET_CHILD(debuff_notice, "debuff_slotset")
    local need_redraw = false
    for i = 1, debuff_slotset:GetSlotCount() do
        local slot = GET_CHILD(debuff_slotset, "slot" .. i)
        local icon = slot:GetIcon()
        if icon then
            local icon_info = icon:GetInfo()
            local buff_id = icon_info.type
            local buff_index = icon:GetUserIValue("BuffIndex")
            local buff = info.GetBuff(handle, buff_id, buff_index)
            if buff then
                local time_text = GET_CHILD(slot, "time_text")
                local count_text = GET_CHILD(slot, "count_text")
                time_text:SetText(buff.time > 0 and "{ol}{s15}{#FFFF00}" .. string.format("%.1fs", buff.time / 1000) or
                                      "")
                count_text:SetText(buff.over > 0 and "{ol}{s35}{#FFFF00}" .. tostring(buff.over) or "")
            else
                if g.debuff_notice.slot_table[handle] and g.debuff_notice.slot_table[handle][buff_id] then
                    g.debuff_notice.slot_table[handle][buff_id] = nil
                    need_redraw = true
                end
            end
        end
    end
    if need_redraw then
        Debuff_notice_frame_redraw(debuff_notice, handle)
    end
    return 1
end
-- debuff_notice ここまで

-- Boss Gauge ここから
function boss_gauge_on_init()
    g.addon:RegisterMsg('TARGET_BUFF_UPDATE', 'Boss_gauge_TARGETINFOTOBOSS_ON_MSG')
    g.addon:RegisterMsg('TARGET_UPDATE', 'Boss_gauge_TARGETINFOTOBOSS_ON_MSG')
    g.addon:RegisterMsg("TARGET_SET_BOSS", "Boss_gauge_TARGETINFOTOBOSS_ON_MSG")
    g.setup_hook_and_event(g.addon, "TARGETINFOTOBOSS_UPDATE_SHIELD", "Boss_gauge_TARGETINFOTOBOSS_UPDATE_SHIELD", true)
end

function Boss_gauge_frame_position()
    local targetinfotoboss = ui.GetFrame("targetinfotoboss")
    local name = GET_CHILD_RECURSIVELY(targetinfotoboss, "name")
    AUTO_CAST(name)
    if name then
        local x = name:GetX()
        local width = name:GetWidth()
        if width > 190 then
            width = 190
        end
        local height = name:GetHeight()
        return targetinfotoboss, x, width, height
    end
end

function Boss_gauge_TARGETINFOTOBOSS_ON_MSG(frame, msg)
    if g.settings.boss_gauge.use == 0 then
        return
    end
    local stat = info.GetStat(session.GetTargetBossHandle())
    if stat then
        local cur_faint = stat.cur_faint
        local max_faint = stat.max_faint
        local targetinfotoboss, x, width, height = Boss_gauge_frame_position()
        if not targetinfotoboss then
            return
        end
        if cur_faint and max_faint and cur_faint >= 0 and max_faint > 0 then
            local faint = GET_CHILD_RECURSIVELY(targetinfotoboss, "faint")
            if faint then
                AUTO_CAST(faint)
                local diff_faint = max_faint - cur_faint
                if diff_faint < 0 then
                    diff_faint = 0
                end
                local stun = targetinfotoboss:CreateOrGetControl("richtext", "stun", x + width + 35, 66, 120, height)
                AUTO_CAST(stun)
                local stun_text = "STUN:" .. string.format("(%.2f%%)", (diff_faint / max_faint) * 100)
                stun:SetText(stun_text)
                stun:SetFontName("yellow_16_ol")
                local name = GET_CHILD_RECURSIVELY(targetinfotoboss, "name")
                AUTO_CAST(name)
                name:AdjustFontSizeByWidth(220)
            end
        end
        local shield = GET_CHILD_RECURSIVELY(targetinfotoboss, "shield", "ui::CGauge")
        if shield:IsVisible() == 0 then
            local shield_text = GET_CHILD_RECURSIVELY(targetinfotoboss, "shield_text")
            if shield_text then
                AUTO_CAST(shield_text)
                shield_text:ShowWindow(0)
            end
        end
    end
end

function Boss_gauge_TARGETINFOTOBOSS_UPDATE_SHIELD(my_frame, my_msg)
    if g.settings.boss_gauge.use == 0 then
        return
    end
    local data = g.get_event_args(my_msg)
    if not data then
        return
    end
    local data_list = StringSplit(data, '/')
    if #data_list > 0 then
        local shield = data_list[1]
        if shield then
            local shield_num = tonumber(data_list[1])
            local max_hp = tonumber(data_list[2])
            if shield_num and max_hp and max_hp > 0 then
                local targetinfotoboss, x, width, height = Boss_gauge_frame_position()
                if not targetinfotoboss then
                    return
                end
                local shield_text = targetinfotoboss:CreateOrGetControl("richtext", "shield_text", x + width + 165, 66,
                    120, height)
                AUTO_CAST(shield_text)
                local text = "SHIELD:" .. string.format("(%.2f%%)", (shield_num / max_hp) * 100)
                shield_text:SetText(text)
                shield_text:SetFontName("yellow_16_ol")
            end
        end
    end
end
-- Boss Gauge ここまで

-- Party Marker　ここから
function party_marker_on_init()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    if _nexus_addons then
        _nexus_addons:SetVisible(1)
        local party_marker_timer = _nexus_addons:CreateOrGetControl("timer", "party_marker_timer", 0, 0)
        AUTO_CAST(party_marker_timer)
        party_marker_timer:SetUpdateScript("Party_marker_set")
        party_marker_timer:Start(0.5)
    end
end

function Party_marker_cleanup()
    if g.party_marker and next(g.party_marker) then
        for handle_str, _ in pairs(g.party_marker) do
            local party_marker = ui.GetFrame("party_marker" .. handle_str)
            if party_marker then
                ui.DestroyFrame(party_marker:GetName())
            end
        end
        g.party_marker = {}
    end
end

function Party_marker_set(_nexus_addons, party_marker_timer)
    if g.settings.party_marker.use == 0 then
        Party_marker_cleanup()
        return
    end
    local party_list = session.party.GetPartyMemberList(PARTY_NORMAL)
    -- テスト用ギルドメンバー
    -- local party_list = session.party.GetPartyMemberList(PARTY_GUILD)
    if not party_list or party_list:Count() <= 1 then
        Party_marker_cleanup()
        return
    end
    local current_party = {}
    for i = 0, party_list:Count() - 1 do
        local member = party_list:Element(i)
        if member then
            local handle = member:GetHandle()
            if handle ~= 0 then
                current_party[tostring(handle)] = handle
            end
        end
    end
    local is_colony = false
    local check_word = "GuildColony_"
    if string.find(g.map_name, check_word) then
        is_colony = true
    end
    g.party_marker = {}
    local list, count = SelectObject(GetMyPCObject(), 1000, 'ALL')
    for i = 1, count do
        if list[i] then
            local handle = GetHandle(list[i])
            if info.IsPC(handle) == 1 then
                local handle_str = tostring(handle)
                if current_party[handle_str] then
                    g.party_marker[handle_str] = handle
                    local party_marker = ui.GetFrame("party_marker" .. handle_str)
                    if not party_marker then
                        party_marker = ui.CreateNewFrame("notice_on_pc", "party_marker" .. handle_str, 0, 0, 50, 50)
                        party_marker:SetSkinName("None")
                        party_marker:SetLayerLevel(80)
                        local pic = party_marker:CreateOrGetControl('picture', 'marker', 0, 0, 50, 50)
                        AUTO_CAST(pic)
                        pic:SetImage("friend_party")
                        pic:SetEnableStretch(1)
                    end
                    if is_colony then
                        FRAME_AUTO_POS_TO_OBJ(party_marker, handle, 25, -70, 3, 1, 1)
                    else
                        FRAME_AUTO_POS_TO_OBJ(party_marker, handle, -25, -70, 3, 1, 1)
                    end
                    party_marker:ShowWindow(1)
                end
            end
        end
    end
    for handle_str, _ in pairs(current_party) do
        if not g.party_marker[handle_str] then
            local party_marker = ui.GetFrame("party_marker" .. handle_str)
            if party_marker then
                ui.DestroyFrame(party_marker:GetName())
            end
        end
    end
end
-- Party Marker　ここまで

-- Aethergem Manager　ここから
function Aethergem_manager_save_settings()
    g.save_json(g.aethergem_manager_path, g.aethergem_manager_settings)
end

function Aethergem_manager_load_settings()
    g.aethergem_manager_path = string.format("../addons/%s/%s/aethergem_manager.json", addon_name_lower, g.active_id)
    g.aethergem_manager_old_path = string.format("../addons/%s/%s.json", "aethergem_mgr", g.active_id)
    local changed = false
    local settings = g.load_json(g.aethergem_manager_path)
    if not settings then
        local old_settings = g.load_json(g.aethergem_manager_old_path)
        if old_settings then
            if old_settings then
                settings = {}
                for key, value in pairs(old_settings) do
                    if key ~= "delay" then
                        if tonumber(key) and string.len(key) < 3 then
                            if not settings.set then
                                settings.set = {}
                            end
                            settings.set[key] = value
                        else
                            if type(value) == "table" and value.use_index and type(value.use_index) == "string" then
                                value.use_index = value.use_index
                            end
                            settings[key] = value
                        end
                    end
                end
                changed = true
            end
        else
            settings = {
                set = {}
            }
            changed = true
        end
    end
    for i = 1, 6 do
        local i_str = tostring(i)
        if not settings.set[i_str] then
            settings.set[i_str] = {}
            changed = true
        end
        for j = 1, 4 do
            local j_str = tostring(j)
            if not settings.set[i_str][j_str] then
                settings.set[i_str][j_str] = 0
                changed = true
            end
        end
    end
    if not g.aethergem_manager then
        g.aethergem_manager = {}
    end
    g.aethergem_manager_settings = settings
    if changed then
        Aethergem_manager_save_settings()
    end
end

function aethergem_manager_on_init()
    if not g.aethergem_manager_settings then
        Aethergem_manager_load_settings()
    end
    local old_func = g.settings.aethergem_manager.old_init_func
    if _G[old_func] then
        return
    end
    Aethergem_manager_frame_init()
end

function Aethergem_manager_frame_init()
    local inventory = ui.GetFrame('inventory')
    local item_cls = GetClassByType('Item', 850006)
    local icon_img = GET_ITEM_ICON_IMAGE(item_cls, 'Icon')
    local btn_pic = inventory:CreateOrGetControl('picture', "btn_pic", 470, 345, 30, 30)
    AUTO_CAST(btn_pic)
    btn_pic:SetImage(icon_img)
    btn_pic:SetEnableStretch(1)
    btn_pic:Resize(30, 30)
    btn_pic:SetTextTooltip(g.lang == "Japanese" and "{ol}右クリック：設定{nl}左クリック：作動" or
                               "{ol}Aethegem Manager{nl}Right click:Setup{nl}Left click:activation")
    btn_pic:SetEventScript(ui.RBUTTONUP, "Aethergem_manager_gem_setting")
    btn_pic:SetEventScript(ui.LBUTTONUP, "Aethergem_manager_operation")
    if g.settings.aethergem_manager.use == 0 then
        btn_pic:ShowWindow(0)
    else
        btn_pic:ShowWindow(1)
    end
end

function Aethergem_manager_gem_setting_close(setting_frame, close, str, num)
    ui.DestroyFrame(setting_frame:GetName())
end

function Aethergem_manager_gem_setting_rbtn(slotset, slot, i_str, j)
    local j_str = tostring(j)
    g.aethergem_manager_settings.set[i_str][j_str] = 0
    Aethergem_manager_save_settings()
    local inventory = ui.GetFrame('inventory')
    Aethergem_manager_gem_setting(inventory)
end

function Aethergem_manager_gem_setting_drop(slotset, slot, i_str, j)
    local lift_icon = ui.GetLiftIcon()
    local info = lift_icon:GetInfo()
    local clsid = info.type
    local item_cls = GetClassByType("Item", clsid)
    local name = item_cls.ClassName
    local j_str = tostring(j)
    local image = info:GetImageName()
    if string.find(image, "highcolorgem") then
        CreateIcon(slot)
        SET_SLOT_ITEM_CLS(slot, item_cls)
        local levels = {"520", "500", "480", "460"}
        local lv_text = slot:CreateOrGetControl('richtext', 'lv_text', 0, 25, 25, 25)
        AUTO_CAST(lv_text)
        for _, lv in ipairs(levels) do
            if string.find(name, lv) then
                lv_text:SetText("{ol}{s14}LV" .. lv)
                break
            end
        end
        g.aethergem_manager_settings.set[i_str][j_str] = clsid
        Aethergem_manager_save_settings()
    end
end

function Aethergem_manager_gem_setting_lbtn(gb, use_btn, i_str, num)
    if not next(g.aethergem_manager_settings.set[i_str]) then
        return
    end
    g.aethergem_manager_settings[g.cid].use_index = i_str
    Aethergem_manager_save_settings()
    local inventory = ui.GetFrame('inventory')
    Aethergem_manager_gem_setting(inventory)
end

function Aethergem_manager_gem_setting(inventory, btn_pic, str, num)
    local setting_frame = ui.CreateNewFrame("chat_memberlist", "Aethergem_manager_setting_frame", 0, 0, 0, 0)
    AUTO_CAST(setting_frame)
    -- 2560,1920
    setting_frame:SetSkinName("test_frame_low")
    local map_frame = ui.GetFrame("map")
    local map_width = map_frame:GetWidth()
    local x = map_width - inventory:GetWidth()
    setting_frame:Resize(300, 360)
    setting_frame:SetPos(x - setting_frame:GetWidth(), 500)
    setting_frame:SetLayerLevel(121)
    setting_frame:RemoveAllChild()
    local gb = setting_frame:CreateOrGetControl("groupbox", "gb", 10, 35, setting_frame:GetWidth() - 20,
        setting_frame:GetHeight() - 45)
    AUTO_CAST(gb)
    gb:SetSkinName("bg")
    local close = setting_frame:CreateOrGetControl('button', 'close', 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Aethergem_manager_gem_setting_close")
    local title = setting_frame:CreateOrGetControl('richtext', 'title', 10, 10, 200, 30)
    AUTO_CAST(title)
    title:SetText("{ol}Aether Gem Setting")
    for i = 1, 6 do
        local slotset = gb:CreateOrGetControl('slotset', 'slotset' .. i, 85, 10 + (i - 1) * 50, 0, 0)
        AUTO_CAST(slotset)
        slotset:EnablePop(1)
        slotset:EnableDrag(1)
        slotset:EnableDrop(1)
        slotset:EnableHitTest(1)
        slotset:SetColRow(4, 1)
        slotset:SetSlotSize(45, 45)
        slotset:SetSpc(2, 2)
        slotset:SetSkinName('invenslot2')
        slotset:CreateSlots()
        local i_str = tostring(i)
        local slot_count = slotset:GetSlotCount()
        for j = 1, slot_count do
            local slot = GET_CHILD(slotset, "slot" .. j)
            AUTO_CAST(slot)
            slot:EnableDrop(1)
            local j_str = tostring(j)
            local clsid = g.aethergem_manager_settings.set[i_str][j_str]
            if clsid and clsid ~= 0 then
                local item_cls = GetClassByType("Item", clsid)
                if item_cls then
                    local name = item_cls.ClassName
                    CreateIcon(slot)
                    SET_SLOT_ITEM_CLS(slot, item_cls)
                    local levels = {"540", "520", "500", "480", "460"}
                    local skins = {"invenslot_pic_goddess", "invenslot_legend", "invenslot_unique", "invenslot_rare",
                                   "invenslot_nomal"}
                    local lv_text = slot:CreateOrGetControl('richtext', 'lv_text', 0, 25, 25, 25)
                    AUTO_CAST(lv_text)
                    for i, lv in ipairs(levels) do
                        if string.find(name, lv) then
                            lv_text:SetText("{ol}{s14}LV" .. lv)
                            slot:SetSkinName(skins[i])
                            break
                        end
                    end
                end
            end
            slot:SetEventScript(ui.RBUTTONUP, 'Aethergem_manager_gem_setting_rbtn')
            slot:SetEventScriptArgString(ui.RBUTTONUP, i_str)
            slot:SetEventScriptArgNumber(ui.RBUTTONUP, j)
            slot:SetEventScript(ui.DROP, 'Aethergem_manager_gem_setting_drop')
            slot:SetEventScriptArgString(ui.DROP, i_str)
            slot:SetEventScriptArgNumber(ui.DROP, j)
        end
        local use_btn = gb:CreateOrGetControl('button', "use_btn" .. i, 5, (i - 1) * 50 + 15, 75, 30)
        AUTO_CAST(use_btn)
        if not g.aethergem_manager_settings[g.cid] then
            g.aethergem_manager_settings[g.cid] = {
                use_index = "-1"
            }
        end
        if g.aethergem_manager_settings[g.cid].use_index == i_str then
            use_btn:SetSkinName("test_red_button")
            use_btn:SetText("{ol}use")
        else
            use_btn:SetSkinName("test_gray_button")
            use_btn:SetText("{ol}not use")
        end
        use_btn:SetEventScript(ui.LBUTTONUP, 'Aethergem_manager_gem_setting_lbtn')
        use_btn:SetEventScriptArgString(ui.LBUTTONUP, i_str)
    end
    Aethergem_manager_save_settings()
    INVENTORY_SET_CUSTOM_RBTNDOWN('Aethergem_manager_INV_RBTN')
    setting_frame:ShowWindow(1)
end

function Aethergem_manager_INV_RBTN(item_obj, slot, guid)
    for i = 1, 6 do
        local setting_frame = ui.GetFrame("Aethergem_manager_setting_frame")
        local slotset = GET_CHILD_RECURSIVELY(setting_frame, 'slotset' .. i)
        AUTO_CAST(slotset)
        local i_str = tostring(i)
        local slot_count = slotset:GetSlotCount()
        for j = 1, slot_count do
            local slot = GET_CHILD(slotset, "slot" .. j)
            AUTO_CAST(slot)
            local j_str = tostring(j)
            local clsid = g.aethergem_manager_settings.set[i_str][j_str]
            if clsid == 0 then
                local gem_clsid = item_obj.ClassID
                local item_cls = GetClassByType("Item", gem_clsid)
                if item_cls then
                    local name = item_cls.ClassName
                    CreateIcon(slot)
                    SET_SLOT_ITEM_CLS(slot, item_cls)
                    local levels = {"540", "520", "500", "480", "460"}
                    local skins = {"invenslot_pic_goddess", "invenslot_legend", "invenslot_unique", "invenslot_rare",
                                   "invenslot_nomal"}
                    local lv_text = slot:CreateOrGetControl('richtext', 'lv_text', 0, 25, 25, 25)
                    AUTO_CAST(lv_text)
                    for i, lv in ipairs(levels) do
                        if string.find(name, lv) then
                            lv_text:SetText("{ol}{s14}LV" .. lv)
                            slot:SetSkinName(skins[i])
                            g.aethergem_manager_settings.set[i_str][j_str] = gem_clsid
                            Aethergem_manager_save_settings()
                            return
                        end
                    end
                end
            end
        end
    end
end

function Aethergem_manager_equip(btn_pic)
    local inventory = btn_pic:GetTopParentFrame()
    if inventory:IsVisible() == 0 then
        btn_pic:StopUpdateScript("Aethergem_manager_equip")
    end
    local step = btn_pic:GetUserIValue("STEP")
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    local spot_nums = {8, 9, 30}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    if step <= 3 then
        local guid = g.aethergem_manager.guids[equips[step]]
        local equip_item = session.GetEquipItemByGuid(guid)
        if step == 3 then
            DO_WEAPON_SLOT_CHANGE(inventory, 2)
        end
        if not equip_item then
            btn_pic:SetUserValue("STEP", step + 1)
        else
            item.UnEquip(spot_nums[step])
        end
        return 1
    end
    local msg = g.lang == "Japanese" and "エーテルジェムソケットが空いていません" or
                    "The Aether Gem socket is unavailable"
    if step >= 4 and step <= 7 then
        local guid = g.aethergem_manager.guids[equips[step - 3]]
        local gem_guid = g.aethergem_manager.gems[step - 3].iesid
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            local aether_available = item_goddess_socket.enable_aether_socket_add(item_obj)
            if aether_available == false then
                GODDESS_MGR_SOCKET_REG_ITEM(goddess_equip_manager, inv_item, item_obj)
            else
                GODDESS_EQUIP_MANAGER_CLOSE(goddess_equip_manager)
                ui.SysMsg(msg)
                return 0
            end
            local gem_item = session.GetInvItemByGuid(gem_guid)
            if gem_item then
                local gem_obj = GetIES(gem_item:GetObject())
                local ctrl_set = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'AETHER_CSET_0')
                local gem_id = ctrl_set:GetUserIValue('GEM_ID')
                if gem_id == 0 then
                    local gem_slot = GET_CHILD(ctrl_set, 'gem_slot')
                    GODDESS_MGR_SOCKET_AETHER_GEM_EQUIP(ctrl_set, gem_slot, gem_item, gem_obj)
                end
                return 1
            else
                local spot_name = equips[step - 3]
                if step == 4 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 1)
                elseif step == 6 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 2)
                end
                ITEM_EQUIP(inv_item.invIndex, spot_name)
                return 1
            end
        else
            btn_pic:SetUserValue("STEP", step + 1)
            return 1
        end
    end
    Aethergem_manager_end_operation(goddess_equip_manager, inventory)
    return 0
end

function Aethergem_manager_unequip(btn_pic)
    local inventory = btn_pic:GetTopParentFrame()
    if inventory:IsVisible() == 0 then
        btn_pic:StopUpdateScript("Aethergem_manager_unequip")
    end
    local step = btn_pic:GetUserIValue("STEP")
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    local spot_nums = {8, 9, 30}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    if step <= 3 then
        local guid = g.aethergem_manager.guids[equips[step]]
        local equip_item = session.GetEquipItemByGuid(guid)
        if step == 3 then
            DO_WEAPON_SLOT_CHANGE(inventory, 2)
        end
        if not equip_item then
            btn_pic:SetUserValue("STEP", step + 1)
        else
            item.UnEquip(spot_nums[step])
        end
        return 1
    end
    if step >= 4 and step <= 7 then
        local gem_index = 2 -- エーテルジェムは2
        local guid = g.aethergem_manager.guids[equips[step - 3]]
        local inv_item = session.GetInvItemByGuid(guid)
        if inv_item then
            local item_obj = GetIES(inv_item:GetObject())
            GODDESS_MGR_SOCKET_REG_ITEM(goddess_equip_manager, inv_item, item_obj)
            local gem_id = inv_item:GetEquipGemID(gem_index)
            if not gem_id or gem_id ~= 0 then
                _GODDESS_MGR_SOCKET_REQ_GEM_REMOVE(gem_index)
            else
                local spot_name = equips[step - 3]
                if step == 4 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 1)
                elseif step == 6 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 2)
                end
                ITEM_EQUIP(inv_item.invIndex, spot_name)
            end
            return 1
        else
            btn_pic:SetUserValue("STEP", step + 1)
        end
        return 1
    end
    Aethergem_manager_end_operation(goddess_equip_manager, inventory)
    return 0
end

function Aethergem_manager_operation_start(is_equip, btn_pic)
    local goddess_equip_manager = ui.GetFrame("goddess_equip_manager")
    if goddess_equip_manager:IsVisible() == 0 then
        help.RequestAddHelp('TUTO_GODDESSEQUIP_1')
        goddess_equip_manager:ShowWindow(1)
        local main_tab = GET_CHILD_RECURSIVELY(goddess_equip_manager, 'main_tab')
        main_tab:SelectTab(2)
        GODDESS_MGR_SOCKET_OPEN(goddess_equip_manager)
        GODDESS_EQUIP_UI_TUTORIAL_CHECK(goddess_equip_manager)
    end
    item.UnEquip(8)
    btn_pic:SetUserValue("STEP", 1)
    if is_equip then
        btn_pic:RunUpdateScript("Aethergem_manager_equip", 0.1)
    else
        btn_pic:RunUpdateScript("Aethergem_manager_unequip", 0.1)
    end
end

function Aethergem_manager_end_operation(goddess_equip_manager, inventory)
    DO_WEAPON_SLOT_CHANGE(inventory, 1)
    GODDESS_MGR_SOCKET_CLEAR(goddess_equip_manager)
    goddess_equip_manager:ShowWindow(0)
    ui.SysMsg("[AGM]End of Operation")
end

function Aethergem_manager_operation(inventory, btn_pic)
    local setting_frame = ui.GetFrame("Aethergem_manager_setting_frame")
    if setting_frame then
        Aethergem_manager_gem_setting_close(setting_frame)
    end
    if TUTORIAL_CLEAR_CHECK(GetMyPCObject()) == false then
        ui.SysMsg(ClMsg('CanUseAfterTutorialClear'))
        return
    end
    g.aethergem_manager.guids = {}
    local equips = {"RH", "LH", "RH_SUB", "LH_SUB"}
    local count = 0
    local is_equip = true
    for _, slot_name in ipairs(equips) do
        local equip_slot = GET_CHILD_RECURSIVELY(inventory, slot_name)
        local icon = equip_slot:GetIcon()
        if icon then
            local icon_info = icon:GetInfo()
            local guid = icon_info:GetIESID()
            local equip_item = session.GetEquipItemByGuid(guid)
            local available = equip_item:IsAvailableSocket(2)
            if available then
                count = count + 1
                local gem_id = equip_item:GetEquipGemID(2)
                if gem_id ~= 0 then
                    is_equip = false
                end
                g.aethergem_manager.guids[slot_name] = guid
            end
        end
    end
    if count < 4 then
        ui.SysMsg(g.lang == "Japanese" and
                      "エーテルジェムソケットが開いた武器を4ケ所装備して使用してください" or
                      "Please equip 4 weapons with open Aether Gem sockets and use the feature")
        return
    end
    if is_equip then
        g.aethergem_manager.gems = {}
        local use_index = g.aethergem_manager_settings[g.cid].use_index
        session.ResetItemList()
        local inv_list = session.GetInvItemList()
        local inv_guid_list = inv_list:GetGuidList()
        local cnt = inv_guid_list:Count()
        local gem_count = 0
        for i = 0, cnt - 1 do
            local guid = inv_guid_list:Get(i)
            local inv_item = inv_list:GetItemByGuid(guid)
            local inv_obj = GetIES(inv_item:GetObject())
            local inv_clsid = inv_obj.ClassID
            for index, clsid in pairs(g.aethergem_manager_settings.set[use_index]) do
                if clsid == inv_clsid then
                    local level = get_current_aether_gem_level(inv_obj)
                    table.insert(g.aethergem_manager.gems, {
                        level = level,
                        iesid = guid,
                        clsid = clsid
                    })
                    gem_count = gem_count + 1
                    break
                end
            end
        end
        if gem_count < 4 then
            ui.SysMsg(g.lang == "Japanese" and "インベントリにエーテルジェムが4個ありません" or
                          "There are not 4 Aether Gem in the inventory")
            return
        end
        table.sort(g.aethergem_manager.gems, function(a, b)
            return a.level > b.level
        end)
        Aethergem_manager_operation_start(is_equip, btn_pic)
    else
        Aethergem_manager_operation_start(is_equip, btn_pic)
    end
end
-- Aethergem Manager　ここまで

-- Job Change Helper ここから
function job_change_helper_on_init()
    if g.get_map_type() == "City" then
        Job_change_helper_frame_init()
    end
end

function Job_change_helper_frame_init()
    if g.settings.job_change_helper.use == 0 then
        local inventory = ui.GetFrame('inventory')
        local toggle = GET_CHILD(inventory, "Job_change_helper_toggle")
        if toggle then
            DESTROY_CHILD_BYNAME(inventory, "Job_change_helper_toggle")
        end
        local changejob = ui.GetFrame("changejob")
        local jobTreeBox = GET_CHILD_RECURSIVELY(changejob, "jobTreeBox")
        local job_change = GET_CHILD(jobTreeBox, "Job_change_helper_job_change")
        if job_change then
            DESTROY_CHILD_BYNAME(jobTreeBox, "Job_change_helper_job_change")
        end
        return
    end
    local inventory = ui.GetFrame('inventory')
    DO_WEAPON_SLOT_CHANGE(inventory, 1)
    local toggle = inventory:CreateOrGetControl("button", "job_change_helper_toggle", 388, 345, 25, 30)
    AUTO_CAST(toggle)
    if not g.job_change_helper_mode then
        toggle:SetSkinName("test_red_button")
        toggle:Resize(30, 30)
        toggle:SetPos(388, 345)
        toggle:SetText("{img equipment_info_btn_mark2 30 25}")
        toggle:SetEventScript(ui.LBUTTONUP, "Job_change_helper_unequip")
        toggle:SetTextTooltip(g.lang == "Japanese" and "{ol}装備を全部外します" or "{ol}Remove all equipment")
    else
        toggle:SetSkinName("baseyellow_btn")
        toggle:Resize(35, 35)
        toggle:SetPos(388, 342)
        toggle:SetText("{ol}{img equipment_info_btn_mark2 30 25}")
        toggle:SetEventScript(ui.LBUTTONUP, "Job_change_helper_equip")
        toggle:SetEventScript(ui.RBUTTONUP, "Job_change_helper_modechange")
        toggle:SetTextTooltip(g.lang == "Japanese" and
                                  "{ol}直前に脱いだ装備を全部着けます。{nl}右クリックでモードを強制クリア" or
                                  "{ol}Equip all gear that was just unequipped{nl}Right-click to force-clear the mode")
    end
    local changejob = ui.GetFrame("changejob")
    if changejob then
        local jobTreeBox = GET_CHILD_RECURSIVELY(changejob, "jobTreeBox")
        AUTO_CAST(jobTreeBox)
        local job_change = jobTreeBox:CreateOrGetControl("button", "Job_change_helper_job_change", 70, 110, 226, 78)
        AUTO_CAST(job_change)
        job_change:SetPos(70, 110)
        job_change:SetSkinName("None")
        job_change:SetImage("btn_lv3")
        job_change:SetText("{ol}Job Change Helper")
        job_change:EnableHitTest(1)
        job_change:SetAnimation('MouseOnAnim', 'btn_mouseover')
        job_change:SetAnimation('MouseOffAnim', 'btn_mouseoff')
        job_change:SetEventScript(ui.LBUTTONDOWN, "OUT_PARTY")
        job_change:SetEventScript(ui.LBUTTONUP, "Job_change_helper_unequip")
    end
end

function Job_change_helper_modechange()
    g.job_change_helper_mode = false
    Job_change_helper_frame_init()
end

function Job_change_helper_unequip(frame, ctrl)
    local equip_list = {}
    local need_run = false
    local equip_item_list = session.GetEquipItemList()
    local cnt = equip_item_list:Count()
    for i = 0, cnt - 1 do
        local equip_item = equip_item_list:GetEquipItemByIndex(i)
        local spot_name = item.GetEquipSpotName(equip_item.equipSpot)
        local iesid = tostring(equip_item:GetIESID())
        local cls_id = equip_item.type
        if iesid ~= "0" then
            equip_list[spot_name] = {
                iesid = iesid,
                cls_id = cls_id,
                index = i
            }
            if spot_name == "HELMET" then
                need_run = true
            elseif spot_name == "CORE" then
                need_run = true
            end
        end
    end
    session.job.ReqUnEquipItemAll()
    g.job_change_helper_sorted_equip_list = {}
    for spot_name, data in pairs(equip_list) do
        data.spot_name = spot_name
        table.insert(g.job_change_helper_sorted_equip_list, data)
    end
    table.sort(g.job_change_helper_sorted_equip_list, function(a, b)
        return a.index < b.index
    end)
    if need_run then
        ctrl:RunUpdateScript("Job_change_helper_unequip_", 0.2)
    else
        local changejob = ui.GetFrame("changejob")
        if changejob and changejob:IsVisible() == 1 then
            ctrl:RunUpdateScript("Job_change_helper_post_unequip", 0.3)
        else
            Job_change_helper_end("unequip")
        end
    end
end

function Job_change_helper_unequip_(ctrl)
    local equip_item_list = session.GetEquipItemList()
    local pc = GetMyPCObject()
    for _, equip_data in ipairs(g.job_change_helper_sorted_equip_list) do
        local spot_name = equip_data.spot_name
        local iesid = equip_data.iesid
        if spot_name == "HELMET" or spot_name == "CORE" then

            local inv_item = session.GetInvItemByGuid(iesid)
            if not inv_item then
                local current_equip = equip_item_list:GetEquipItem(pc, spot_name)
                if current_equip then
                    local index = equip_data.index
                    item.UnEquip(index)
                    return 1
                end
            end
        end
    end
    local changejob = ui.GetFrame("changejob")
    if changejob and changejob:IsVisible() == 1 then
        ctrl:RunUpdateScript("Job_change_helper_post_unequip", 0.3)
    else
        Job_change_helper_end("unequip")
    end
    return 0
end

function Job_change_helper_post_unequip(ctrl)
    local changejob = ui.GetFrame("changejob")
    if changejob and changejob:IsVisible() == 1 then
        local pet = GET_SUMMONED_PET()
        if pet then
            control.SummonPet(0, 0, 0)
            return 1
        end
        local hawk = GET_SUMMONED_PET_HAWK()
        if hawk then
            ui.SysMsg(g.lang == "Japanese" and "鷹を連れているのでバラックへ戻ります" or
                          "Will return to the barracks due to the hawk")
            GAME_TO_BARRACK()
            return 0
        end
        local multiple_class_change = ui.GetFrame("multiple_class_change")
        MULTIPLE_CLASS_CHANGE_OPEN(multiple_class_change)
        multiple_class_change:ShowWindow(1)
    end
    Job_change_helper_end("unequip")
    return 0
end

function Job_change_helper_equip(inventory, ctrl)
    inventory:RunUpdateScript("Job_change_helper_equip_", 0.3)
end

function Job_change_helper_equip_(inventory)
    if #g.job_change_helper_sorted_equip_list > 0 then
        for i, equip_data in ipairs(g.job_change_helper_sorted_equip_list) do
            local spot_name = equip_data.spot_name
            local iesid = equip_data.iesid
            local cls_id = equip_data.cls_id
            local ret = CHECK_EQUIPABLE(cls_id)
            if ret ~= "OK" then
                table.remove(g.job_change_helper_sorted_equip_list, i)
                return 1
            end
            local inv_item = session.GetInvItemByGuid(iesid)
            if inv_item then
                ITEM_EQUIP(inv_item.invIndex, spot_name)
                return 1
            else
                if i >= 9 then
                    DO_WEAPON_SLOT_CHANGE(inventory, 2)
                end
                table.remove(g.job_change_helper_sorted_equip_list, i)
                return 1
            end
        end
    end
    Job_change_helper_end("equip")
    return 0
end

function Job_change_helper_end(str)
    if str == "equip" then
        g.job_change_helper_mode = false
    else
        g.job_change_helper_mode = true
    end
    local inventory = ui.GetFrame('inventory')
    inventory:RunUpdateScript("Job_change_helper_frame_init", 0.5)
    ui.SysMsg("[JCH]End of Operation")
end
-- Job Change Helper ここまで

--  Guild Event Warp ここから
function Guild_event_warp_save_settings()
    g.save_json(g.guild_event_warp_path, g.guild_event_warp_settings)
end

function Guild_event_warp_load_settings()
    g.guild_event_warp_path = string.format("../addons/%s/%s/guild_event_warp.json", addon_name_lower, g.active_id)
    local changed = false
    local settings = g.load_json(g.guild_event_warp_path)
    if not settings then
        settings = {
            open = true
        }
        changed = true
    end
    g.guild_event_warp_settings = settings
    if changed then
        Guild_event_warp_save_settings()
    end
end

function guild_event_warp_on_init()
    if not g.guild_event_warp_settings then
        Guild_event_warp_load_settings()
    end
    local old_func = g.settings.guild_event_warp.old_init_func
    if _G[old_func] then
        return
    end
    if g.settings.guild_event_warp.use == 0 then
        ui.DestroyFrame(addon_name_lower .. "guild_event_warp")
        return
    end
    Guild_event_warp_frame_init()
    if g.guild_event_warp_channnel_change then
        Guild_event_warp_channel_change()
    end
end

function Guild_event_warp_frame_init()
    g.guild_event_warp_info = {{
        name = "dragoon",
        event_id = 500,
        monster = "guild_boss_dragoon_ex",
        tooltip = g.lang == "Japanese" and "{ol}ギルドイベント、ドラグーンのマップに移動します" or
            "{ol}Guild event move to the Dragoon map"
    }, {
        name = "veliora",
        monster = "boss_Veliora_GMission",
        event_id = 501,
        tooltip = g.lang == "Japanese" and
            "{ol}ギルドイベント、アラクネ姉妹のマップに移動します" or
            "{ol}Guild event move to the Arachne Sisters map"
    }, {
        name = "baubas",
        monster = "GuildEvent_npc_baubas2",
        event_id = 502,
        tooltip = g.lang == "Japanese" and "{ol}ギルドイベント、バウバスのマップに移動します" or
            "{ol}Guild event move to the Baubus map"
    }}
    local guild_event_warp = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "guild_event_warp", 0, 0, 0, 0)
    AUTO_CAST(guild_event_warp)
    guild_event_warp:SetSkinName("None")
    guild_event_warp:SetTitleBarSkin("None")
    guild_event_warp:SetGravity(ui.RIGHT, ui.TOP)
    local rect = guild_event_warp:GetMargin()
    guild_event_warp:SetMargin(rect.left - rect.left, rect.top - rect.top + 4, rect.right, rect.bottom)
    local icon_size = 28
    local icon_space = 33
    local x = 0
    for _, info in ipairs(g.guild_event_warp_info) do
        local slot_name = info.name .. "_slot"
        local slot = guild_event_warp:CreateOrGetControl("slot", slot_name, x, 0, icon_size, icon_size)
        AUTO_CAST(slot)
        slot:EnablePop(0)
        slot:EnableDrop(0)
        slot:EnableDrag(0)
        slot:SetEventScript(ui.LBUTTONUP, "Guild_event_warp_move_to_guild_event")
        slot:SetEventScriptArgString(ui.LBUTTONUP, tostring(info.event_id))
        local mon_cls = GetClass("Monster", info.monster)
        if mon_cls then
            local icon = CreateIcon(slot)
            AUTO_CAST(icon)
            icon:SetImage(mon_cls.Icon)
            icon:SetTextTooltip(info.tooltip)
        end
        if g.guild_event_warp_settings.open == true then
            slot:ShowWindow(1)
        else
            slot:ShowWindow(0)
        end
        x = x + icon_space
    end
    local open = guild_event_warp:CreateOrGetControl('picture', "open", x, 0, 20, 20)
    AUTO_CAST(open)
    if g.guild_event_warp_settings.open == true then
        open:SetImage("quest_arrow_r_btn")
    else
        open:SetImage("quest_arrow_l_btn")
    end
    open:SetEnableStretch(1)
    open:SetEventScript(ui.LBUTTONUP, "Guild_event_warp_toggle_frame")
    x = x + icon_space
    guild_event_warp:Resize(x - (icon_space - icon_size), icon_size)
    guild_event_warp:ShowWindow(1)
end

function Guild_event_warp_toggle_frame(frame, ctrl, str, num)
    local show_window
    local new_image_name
    local new_open_state
    if g.guild_event_warp_settings.open == true then
        show_window = 0
        new_image_name = "quest_arrow_l_btn"
        new_open_state = false
    else
        show_window = 1
        new_image_name = "quest_arrow_r_btn"
        new_open_state = true
    end
    for _, info in ipairs(g.guild_event_warp_info) do
        local slot_name = info.name .. "_slot"
        local slot = GET_CHILD(frame, slot_name)
        AUTO_CAST(slot)
        slot:ShowWindow(show_window)
    end
    ctrl:SetImage(new_image_name)
    g.guild_event_warp_settings.open = new_open_state
    Guild_event_warp_save_settings()
end

function Guild_event_warp_move_to_guild_event(_, _, event_id)
    g.guild_event_warp_channnel_change = true
    _BORUTA_ZONE_MOVE_CLICK(event_id)
end

function Guild_event_warp_channel_change()
    if g.current_channel ~= 0 then
        RUN_GAMEEXIT_TIMER("Channel", 0)
    end
    g.guild_event_warp_channnel_change = false
end
--  Guild Event Warp ここまで

-- Dungeon RP charger ここから
function dungeon_rp_charger_on_init()
    if g.map_id == 11244 then -- 11244 未知の聖域3F -- 40049 レリックバフ -- 11030036 エクトナイト(マケ売り可) misc_Ectonite    -- 11030451 エクトナイト misc_Ectonite_Care
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        if _nexus_addons then
            local dungeon_rp_charger_timer = GET_CHILD(_nexus_addons, "dungeon_rp_charger_timer")
            if not dungeon_rp_charger_timer then
                dungeon_rp_charger_timer = _nexus_addons:CreateOrGetControl("timer", "dungeon_rp_charger_timer", 0, 0)
            end
            AUTO_CAST(dungeon_rp_charger_timer)
            dungeon_rp_charger_timer:SetUpdateScript("Dungeon_rp_charger_auto_charge")
            dungeon_rp_charger_timer:Start(3.0)
        end
    end
end

--[[function Dungeon_rp_charger_BUFF_ADD(frame, msg, str, buff_id)
    if g.settings.dungeon_rp_charger.use == 0 then
        return
    end
    if buff_id == 40049 then
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        if _nexus_addons then
            _nexus_addons:SetVisible(1)
            local dungeon_rp_charger_timer = GET_CHILD(_nexus_addons, "dungeon_rp_charger_timer")
            if not dungeon_rp_charger_timer then
                dungeon_rp_charger_timer = _nexus_addons:CreateOrGetControl("timer", "dungeon_rp_charger_timer", 0, 0)
            end
            AUTO_CAST(dungeon_rp_charger_timer)
            dungeon_rp_charger_timer:SetUpdateScript("Dungeon_rp_charger_auto_charge")
            dungeon_rp_charger_timer:Start(1.0)
        end
    end
end]]

function Dungeon_rp_charger_auto_charge(_nexus_addons, dungeon_rp_charger_timer)
    if g.settings.dungeon_rp_charger.use == 0 then
        return
    end
    local pc = GetMyPCObject()
    local cur_rp, max_rp = shared_item_relic.get_rp(pc)
    if cur_rp >= 200 then
        return
    end
    session.ResetItemList()
    local mat_item = session.GetInvItemByType(11030451)
    if not mat_item then
        mat_item = session.GetInvItemByType(11030036)
        if not mat_item then
            return
        end
    end
    if mat_item.isLockState then
        return
    end
    local item_index = mat_item:GetIESID()
    local cur_count = mat_item.count
    local recharge_count = math.floor((max_rp - cur_rp) / 10)
    if cur_count and cur_count > 0 then
        if recharge_count > cur_count then
            recharge_count = cur_count
        end
        if recharge_count > 0 then
            session.AddItemID(item_index, recharge_count)
            local result_list = session.GetItemIDList()
            item.DialogTransaction('RELIC_CHARGE_RP', result_list)
        end
    end
end
-- Dungeon RP charger ここまで

-- Boss Direction ここから
function Boss_direction_save_settings()
    g.save_json(g.boss_direction_path, g.boss_direction_settings)
end

function Boss_direction_load_settings()
    g.boss_direction_path = string.format("../addons/%s/%s/boss_direction.json", addon_name_lower, g.active_id)
    local changed = false
    local settings = g.load_json(g.boss_direction_path)
    if not settings then
        settings = {
            layer = 29
        }
        changed = true
    end
    g.boss_direction_settings = settings
    if changed then
        Boss_direction_save_settings()
    end
end

function boss_direction_on_init()
    if not g.boss_direction_settings then
        Boss_direction_load_settings()
    end
    local old_func = g.settings.boss_direction.old_init_func
    if _G[old_func] then
        return
    end
    g.boss_direction_handls = {}
    if g.get_map_type() ~= "City" then
        Boss_direction_handle_check_reserve()
    end
end

function Boss_direction_settings_frame_init()
    local boss_direction_settings = ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "boss_direction_settings")
    AUTO_CAST(boss_direction_settings)
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    boss_direction_settings:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    boss_direction_settings:EnableHitTest(1)
    boss_direction_settings:SetLayerLevel(999)
    boss_direction_settings:SetSkinName("test_frame_low")
    local width = 0
    local title = boss_direction_settings:CreateOrGetControl('richtext', 'title', 20, 10, 10, 30)
    AUTO_CAST(title)
    title:SetText("{#000000}{s20}Boss Direction Settings")
    width = width + 20 + title:GetWidth() + 40
    local close = boss_direction_settings:CreateOrGetControl('button', 'close', 0, 0, 20, 20)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Boss_direction_setting_frame_close")
    local boss_direction_gb = boss_direction_settings:CreateOrGetControl("groupbox", "boss_direction_gb", 10, 40, 100,
        100)
    AUTO_CAST(boss_direction_gb)
    boss_direction_gb:SetSkinName("bg")
    boss_direction_gb:RemoveAllChild()
    local layer = boss_direction_gb:CreateOrGetControl('richtext', 'layer', 10, 10)
    AUTO_CAST(layer)
    layer:SetText(g.lang ~= "Japanese" and "{ol}フレームレイヤー設定" or "{ol}Frame Layer Settings")
    local layer_edit = boss_direction_gb:CreateOrGetControl('edit', 'layer_edit', layer:GetWidth() + 20, 5, 60, 30)
    AUTO_CAST(layer_edit)
    layer_edit:SetText("{ol}" .. g.boss_direction_settings.layer)
    layer_edit:SetFontName("white_16_ol")
    layer_edit:SetTextAlign("center", "center")
    layer_edit:SetNumberMode(1)
    layer_edit:SetEventScript(ui.ENTERKEY, "Boss_direction_setting")
    layer_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}エンターキー押下で登録" or
                                  "{ol}Register by pressing enter key")
    boss_direction_settings:Resize(width, 90)
    boss_direction_gb:Resize(boss_direction_settings:GetWidth() - 20, 40)
    boss_direction_settings:ShowWindow(1)
end

function Boss_direction_setting_frame_close(frame)
    local frame_name = addon_name_lower .. "boss_direction_settings"
    ui.DestroyFrame(frame_name)
end

function Boss_direction_setting(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    local layer = tonumber(ctrl:GetText())
    if not layer then
        return
    end
    if tonumber(layer) ~= tonumber(g.boss_direction_settings.layer) then
        ui.SysMsg(g.lang == "Japanese" and "フレームレイヤーを " .. layer .. " に設定しました" or
                      "Frame Layer set to " .. layer)
        g.boss_direction_settings.layer = layer
    end
    Boss_direction_save_settings()
end

function Boss_direction_handle_check_reserve()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    if _nexus_addons then
        _nexus_addons:SetVisible(1)
        local boss_direction_timer = GET_CHILD(_nexus_addons, "boss_direction_timer")
        if not boss_direction_timer then
            boss_direction_timer = _nexus_addons:CreateOrGetControl("timer", "boss_direction_timer", 0, 0)
        end
        AUTO_CAST(boss_direction_timer)
        boss_direction_timer:SetUpdateScript("Boss_direction_handle_check")
        boss_direction_timer:Start(0.5)
    end
end

function Boss_direction_handle_check(_nexus_addons, Boss_direction_timer)
    if g.settings.boss_direction.use == 0 then
        Boss_direction_timer:Stop()
        return
    end
    local visible_bosses = {}
    local selected_objects, selected_objects_count = SelectObject(GetMyPCObject(), 500, "ENEMY")
    for i = 1, selected_objects_count do
        local handle = GetHandle(selected_objects[i])
        local target_info = info.GetTargetInfo(handle)
        if target_info.isBoss == 1 then
            local cls_name = info.GetMonsterClassName(handle)
            local mon_cls = GetClass("Monster", cls_name)
            local icon_name = mon_cls.Icon
            if icon_name ~= "icon_item_nothing" then
                visible_bosses[handle] = true
                local frame = ui.GetFrame("boss_direction" .. "_" .. handle)
                if not frame then
                    frame = ui.CreateNewFrame("notice_on_pc", "boss_direction_" .. handle, 0, 0, 0, 0)
                    frame:SetSkinName("None")
                    frame:SetTitleBarSkin("None")
                    frame:Resize(120, 120)
                    frame:SetLayerLevel(g.boss_direction_settings.layer or 29)
                    local arrow = frame:CreateOrGetControl("picture", "arrow", 0, 0, 70, 70)
                    AUTO_CAST(arrow)
                    arrow:SetImage("class_tree_arrow")
                    arrow:SetEnableStretch(1)
                    arrow:EnableHitTest(0)
                    arrow:SetGravity(ui.CENTER_HORZ, ui.CENTER_VERT)
                    arrow:Resize(60, 60)
                    arrow:SetColorTone("FFFF0000")
                end
                AUTO_CAST(frame)
                if not g.boss_direction_handls[handle] then
                    g.boss_direction_handls[handle] = frame:GetName()
                end
                local arrow = GET_CHILD(frame, "arrow")
                arrow:SetAngle(info.GetAngle(handle) - 23)
                FRAME_AUTO_POS_TO_OBJ(frame, handle, -frame:GetWidth() / 2, -frame:GetHeight() / 2, 0, 0)
                local stat = target_info.stat
                if stat.HP == 0 then
                    frame:ShowWindow(0)
                else
                    frame:ShowWindow(1)
                end
                if string.find(g.map_name, "Raid_Redania") and not string.find(string.upper(cls_name), "ILLUSION") then
                    arrow:SetColorTone("FFFFFF00")
                end
            end
        end
    end
    for handle, frame_name in pairs(g.boss_direction_handls) do
        if not visible_bosses[handle] then
            ui.DestroyFrame(frame_name)
            g.boss_direction_handls[handle] = nil
        end
    end
end
-- Boss Direction ここまで

-- Auto Repaire ここから
g.auto_repair = {
    item_cls_id = 11201388,
    repair_item = "AustejaCertificate_14",
    shop_type = "AustejaCertificate"
}
function Auto_repair_save_settings()
    g.save_json(g.auto_repair_path, g.auto_repair_settings)
end

function Auto_repair_load_settings()
    g.auto_repair_path = string.format("../addons/%s/%s/auto_repair.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.auto_repair_path)
    local changed = false
    if not settings then
        settings = {
            buy_qty = 50,
            msg_qty = 20,
            setting_x = 800,
            setting_y = 700,
            auto_buy = false
        }
        changed = true
    end
    g.auto_repair_settings = settings
    if changed then
        Auto_repair_save_settings()
    end
end

function auto_repair_on_init()
    if not g.auto_repair_settings then
        Auto_repair_load_settings()
    end
    local old_func = g.settings.auto_repair.old_init_func
    if _G[old_func] then
        return
    end
    local durnotify = ui.GetFrame("durnotify")
    if durnotify and durnotify:IsVisible() == 1 then
        durnotify:Resize(0, 0)
    end
    g.setup_hook_and_event(g.addon, "DURNOTIFY_UPDATE", "Auto_repair_DURNOTIFY_UPDATE", false)
    if g.get_map_type() == "City" then
        local auto_repair_item = session.GetInvItemByType(g.auto_repair.item_cls_id)
        if not auto_repair_item or (auto_repair_item and auto_repair_item.count < g.auto_repair_settings.msg_qty) then
            Auto_repair_msg_box_init()
        end
    end
end

function Auto_repair_msg_box_init()
    if g.settings.auto_repair.use == 0 then
        return
    end
    if g.auto_repair_settings.auto_buy then
        local text = g.lang == "Japanese" and "{ol}[Auto Repair] 自動補充します" or
                         "{ol}[Auto Repair] Auto Replenish"
        ui.SysMsg(text)
        Auto_repair_buy_item()
        return
    end
    local yes_scp = string.format("Auto_repair_buy_item()")
    local msg = g.lang == "Japanese" and
                    "{ol}{#FFFFFF}[Auto Repair]修理キットの残りが少ないですが補充しますか？" or
                    "{ol}{#FFFFFF}[Auto Repair]{nl}Your repair kits are low{ol}Would you like to resupply them?"
    ui.MsgBox(msg, yes_scp, "None")
end

function Auto_repair_buy_item()
    local auto_repair_item = session.GetInvItemByType(g.auto_repair.item_cls_id)
    local recipe_cls = GetClass("ItemTradeShop", g.auto_repair.repair_item)
    local count = 0
    if auto_repair_item ~= nil then
        local repair_count = auto_repair_item.count
        count = g.auto_repair_settings.buy_qty - repair_count
    else
        count = g.auto_repair_settings.buy_qty
    end
    session.ResetItemList()
    session.AddItemID(tostring(0), 1)
    local item_list = session.GetItemIDList()
    local count_text = string.format("%s %s", tostring(recipe_cls.ClassID), tostring(count))
    local str_list = NewStringList()
    str_list:Add(g.auto_repair.shop_type)
    item.DialogTransaction("Certificate_SHOP", item_list, count_text, str_list)
end

function Auto_repair_setting_frame_close(frame)
    local frame_name = addon_name_lower .. "auto_repair_settings"
    ui.DestroyFrame(frame_name)
end

function Auto_repair_settings_frame_init()
    local list_frame = ui.GetFrame(addon_name_lower .. "list_frame")
    local auto_repair_settings = ui.CreateNewFrame("chat_memberlist", addon_name_lower .. "auto_repair_settings")
    AUTO_CAST(auto_repair_settings)
    auto_repair_settings:SetPos(list_frame:GetX() + list_frame:GetWidth(), list_frame:GetY())
    auto_repair_settings:EnableHitTest(1)
    auto_repair_settings:SetSkinName("test_frame_low")
    auto_repair_settings:SetLayerLevel(999)
    local title = auto_repair_settings:CreateOrGetControl('richtext', 'title', 20, 10, 10, 30)
    AUTO_CAST(title)
    title:SetText("{#000000}{s20}Auto Repair Settings")
    local close_button = auto_repair_settings:CreateOrGetControl('button', 'close_button', 0, 0, 20, 20)
    AUTO_CAST(close_button)
    close_button:SetImage("testclose_button")
    close_button:SetGravity(ui.RIGHT, ui.TOP)
    close_button:SetEventScript(ui.LBUTTONUP, "Auto_repair_setting_frame_close")
    local auto_repair_gb = auto_repair_settings:CreateOrGetControl("groupbox", "auto_repair_gb", 10, 40, 100, 100)
    AUTO_CAST(auto_repair_gb)
    auto_repair_gb:SetSkinName("bg")
    auto_repair_gb:RemoveAllChild()
    local buy_qty = auto_repair_gb:CreateOrGetControl('richtext', 'buy_qty', 10, 10)
    AUTO_CAST(buy_qty)
    buy_qty:SetText(g.lang == "Japanese" and "{ol}自動購入数入力" or "{ol}Number of automatic purchases")
    local msg_qty = auto_repair_gb:CreateOrGetControl('richtext', 'msg_qty', 10, 40)
    AUTO_CAST(msg_qty)
    msg_qty:SetText(g.lang == "Japanese" and "{ol}入力数以下で補充メッセージ" or
                        "{ol}Message with less than input quantit")
    local auto_purchase = auto_repair_gb:CreateOrGetControl('checkbox', "auto_purchase", 10, 70, 100, 25)
    AUTO_CAST(auto_purchase)
    auto_purchase:SetText(g.lang == "Japanese" and "{ol}自動補充有効化" or "{ol}Auto Replenishment Enable")
    auto_purchase:SetTextTooltip(g.lang == "Japanese" and "{ol}チェックすると自動で購入" or
                                     "{ol}Automatic purchase when checked")
    auto_purchase:SetCheck(g.auto_repair_settings.auto_buy and 1 or 0)
    auto_purchase:SetEventScript(ui.LBUTTONUP, "Auto_repair_setting")
    local width = math.max(buy_qty:GetWidth(), msg_qty:GetWidth())
    local buy_edit = auto_repair_gb:CreateOrGetControl('edit', 'buy_edit', width + 20, 15, 60, 30)
    AUTO_CAST(buy_edit)
    buy_edit:SetText("{ol}" .. g.auto_repair_settings.buy_qty)
    buy_edit:SetFontName("white_16_ol")
    buy_edit:SetTextAlign("center", "center")
    buy_edit:SetNumberMode(1)
    buy_edit:SetEventScript(ui.ENTERKEY, "Auto_repair_setting")
    buy_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}エンターキー押下で登録" or
                                "{ol}Register by pressing enter key")
    local msg_edit = auto_repair_gb:CreateOrGetControl('edit', 'msg_edit', width + 20, 45, 60, 30)
    AUTO_CAST(msg_edit)
    msg_edit:SetText("{ol}" .. g.auto_repair_settings.msg_qty)
    msg_edit:SetFontName("white_16_ol")
    msg_edit:SetTextAlign("center", "center")
    msg_edit:SetNumberMode(1)
    msg_edit:SetEventScript(ui.ENTERKEY, "Auto_repair_setting")
    msg_edit:SetTextTooltip(g.lang == "Japanese" and "{ol}エンターキー押下で登録" or
                                "{ol}Register by pressing enter key")
    auto_repair_settings:Resize(width + 100, 150)
    auto_repair_gb:Resize(width + 80, 100)
    auto_repair_settings:ShowWindow(1)
end

function Auto_repair_setting(frame, ctrl)
    local ctrl_name = ctrl:GetName()
    if ctrl_name ~= "auto_purchase" then
        local value = tonumber(ctrl:GetText())
        if not value then
            return
        end
        if tonumber(value) ~= tonumber(g.auto_repair_settings.buy_qty) and ctrl_name == "buy_edit" then
            ui.SysMsg(g.lang == "Japanese" and "購入数量を " .. value .. " 個に設定しました" or
                          "Buy quantity set to " .. value)
            g.auto_repair_settings.buy_qty = value

        elseif tonumber(value) ~= tonumber(g.auto_repair_settings.msg_qty) and ctrl_name == "msg_edit" then
            ui.SysMsg(g.lang == "Japanese" and "お知らせ数量を " .. value .. " 個に設定しました" or
                          "Msg quantity set to " .. value)
            g.auto_repair_settings.msg_qty = value
        end
    elseif ctrl_name == "auto_purchase" then
        local is_check = ctrl:IsChecked()
        g.auto_repair_settings.auto_buy = is_check == 1 and true or false
    end
    Auto_repair_save_settings()
end

function Auto_repair_DURNOTIFY_UPDATE(my_frame, my_msg)
    local frame, notOpenFrame = g.get_event_args(my_msg)
    if g.settings.auto_repair.use == 0 then
        g.FUNCS["DURNOTIFY_UPDATE"](frame, notOpenFrame)
        return
    end
    if frame and frame:IsVisible() == 0 then
        frame:ShowWindow(1)
    end
    local slot_set = GET_CHILD_RECURSIVELY(frame, 'slotlist', 'ui::CSlotSet')
    slot_set:ClearIconAll()
    for i = 0, slot_set:GetSlotCount() - 1 do
        local slot = slot_set:GetSlotByIndex(i)
        slot:ShowWindow(0)
    end
    local reverse_index = slot_set:GetSlotCount() - 1
    local equip_list = session.GetEquipItemList()
    local some_flag = 1
    for i = 0, equip_list:Count() - 1 do
        local equip_item = equip_list:GetEquipItemByIndex(i)
        local spot = item.GetEquipSpotName(equip_item.equipSpot)
        local slot_cnt = imcSlot:GetFilledSlotCount(slot_set)
        local temp_obj = equip_item:GetObject()
        if temp_obj then
            local obj = GetIES(temp_obj)
            if IS_DUR_UNDER_10PER(obj) == true then
                local color_tone = "FF999900"
                if some_flag < 2 then
                    some_flag = 2
                    local type = equip_item.type
                    Auto_repair_item_use(obj, spot)
                end
                if IS_DUR_ZERO(obj) == true then
                    color_tone = "FF990000"
                    if some_flag < 3 then
                        some_flag = 3
                    end
                end
                local slot = slot_set:GetSlotByIndex(reverse_index - slot_cnt)
                local icon = CreateIcon(slot)
                local icon_img = obj.Icon
                local briquetting_id = TryGetProp(obj, 'BriquettingIndex', 0)
                if briquetting_id > 0 then
                    local briquetting_item_cls = GetClassByType('Item', briquetting_id)
                    icon_img = briquetting_item_cls.Icon
                end
                icon:Set(icon_img, 'Item', equip_item.type, reverse_index - slot_cnt, equip_item:GetIESID())
                icon:SetColorTone(color_tone)
                slot:ShowWindow(1)
            end
        end
    end
    local now_value = frame:GetValue()
    if some_flag == 1 then
        frame:SetValue(1)
    elseif some_flag == 2 and now_value < some_flag then
        frame:SetValue(2)
        ui.SysMsg(ScpArgMsg('DurUnder30'))
    elseif some_flag == 3 and now_value < some_flag then
        frame:SetValue(3)
        ui.SysMsg(ScpArgMsg('DurUnder0'))
    end
end

function Auto_repair_item_use(obj, spot)
    session.ResetItemList()
    local repair_kit = session.GetInvItemByType(g.auto_repair.item_cls_id)
    if repair_kit ~= nil and not repair_kit.isLockState then
        local repeat_count = math.min(repair_kit.count, 4)
        for i = 0, repeat_count - 1 do
            if obj.Dur / obj.MaxDur < 0.9 then
                item.UseByGUID(repair_kit:GetIESID())
            end
        end
    end
end
-- Auto Repaire ここまで

-- Acquire relic reward ここから
function acquire_relic_reward_on_init()
    if g.settings.acquire_relic_reward.use == 0 then
        return
    end
    if g.map_name == "c_Klaipe" or g.map_name == "c_fedimian" or g.map_name == "c_orsha" then
        local _nexus_addons = ui.GetFrame("_nexus_addons")
        if _nexus_addons then
            _nexus_addons:SetVisible(1)
            _nexus_addons:RunUpdateScript("Acquire_relic_reward_process", 1.0)
        end
    end
end

function Acquire_relic_reward_process(_nexus_addons)
    local pc_obj = GetMyPCObject()
    local cls_list, cnt = GetClassList("Relic_Quest")
    for i = 0, cnt - 1 do
        local relic_cls = GetClassByIndexFromList(cls_list, i)
        local quest_type = TryGetProp(relic_cls, 'QuestType', 'None')
        if quest_type ~= 'None' then
            local result = SCR_RELIC_QUEST_CHECK(pc_obj, relic_cls.ClassName)
            if result == "Reward" then
                pc.ReqExecuteTx("SCR_TX_RELIC_QUEST_REWARD", relic_cls.ClassName)
                return 1
            end
        end
    end
    _nexus_addons:StopUpdateScript("Acquire_relic_reward_process")
    return 0
end
-- Acquire relic reward ここまで

-- Auto Pet Summon ここから
function Auto_pet_summon_save_settings()
    g.save_json(g.auto_pet_summon_path, g.auto_pet_summon_settings)
end

function Auto_pet_summon_load_settings()
    g.auto_pet_summon_path = string.format("../addons/%s/%s/auto_pet_summon.json", addon_name_lower, g.active_id)
    local settings = g.load_json(g.auto_pet_summon_path)
    local changed = false
    if not settings then
        settings = {}
        changed = true
    end
    if not settings[g.cid] then
        settings[g.cid] = {
            iesid = "",
            clsid = 0
        }
        changed = true
    end
    g.auto_pet_summon_settings = settings
    if changed then
        Auto_pet_summon_save_settings()
    end
end

function auto_pet_summon_on_init()
    local cid = session.GetMySession():GetCID()
    if g.get_map_type() == "City" and (not g.auto_pet_summon_cid or cid ~= g.auto_pet_summon_cid) then
        g.auto_pet_summon_cid = cid
        if not g.auto_pet_summon then
            Auto_pet_summon_load_settings()
        end
        local old_func = g.settings.auto_pet_summon.old_init_func
        if _G[old_func] then
            return
        end
        Auto_pet_summon_companion()
    end
end

function Auto_pet_summon_companion()
    if g.settings.auto_pet_summon.use == 1 then
        if g.auto_pet_summon_settings[g.cid].clsid ~= 0 then
            control.SummonPet(g.auto_pet_summon_settings[g.cid].clsid, g.auto_pet_summon_settings[g.cid].iesid, 0)
        else
            local text = g.lang == "Japanese" and "{ol}[APS]{#FFFFFF} " .. g.login_name .. " {/}ペット未登録" or
                             "{ol}[APS]{#FFFFFF} " .. g.login_name .. " {/}is not registered pet"
            ui.SysMsg(text)
        end
    end
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    if _nexus_addons then
        _nexus_addons:SetVisible(1)
        local auto_pet_summon_timer = _nexus_addons:CreateOrGetControl("timer", "auto_pet_summon_timer", 0, 0)
        AUTO_CAST(auto_pet_summon_timer)
        auto_pet_summon_timer:SetUpdateScript("Auto_pet_summon_save_reserve")
        auto_pet_summon_timer:Start(1.0)
    end
end

function Auto_pet_summon_save_reserve(_nexus_addons, auto_pet_summon_timer)
    local summoned_pet = session.pet.GetSummonedPet()
    local pet_is_summoned = (summoned_pet ~= nil)
    local pet_is_saved = (g.auto_pet_summon_settings[g.cid].clsid ~= 0)
    if pet_is_summoned == pet_is_saved then
        return
    end
    if pet_is_summoned then
        local iesid = tostring(summoned_pet:GetStrGuid())
        local pet_obj = summoned_pet:GetObject()
        local clsid = GetIES(pet_obj).ClassID
        g.auto_pet_summon_settings[g.cid].iesid = iesid
        g.auto_pet_summon_settings[g.cid].clsid = clsid
    else
        g.auto_pet_summon_settings[g.cid].iesid = ""
        g.auto_pet_summon_settings[g.cid].clsid = 0
    end
    Auto_pet_summon_save_settings()
end
-- Auto Pet Summon ここまで

-- Auto Map Change ここから
function auto_map_change_on_init()
    g.addon:RegisterMsg("DIALOG_CHANGE_SELECT", "Auto_map_change_DIALOG_ON_MSG")
end

function Auto_map_change_DIALOG_ON_MSG(frame, msg, str, num)
    if g.settings.auto_map_change.use == 0 then
        return
    end
    if string.find(str, "HighLvZoneEnterMsgCustom") then
        control.DialogItemSelect(1)
        control.DialogOk()
    end
end
-- Auto Map Change ここまで

-- Bulk Sales ここから
g.bulk_sales = {
    amount = 0,
    tbl = {},
    time = 0
}
function bulk_sales_on_init(frame, addon)
    g.addon:RegisterMsg('DIALOG_CLOSE', 'Bulk_sales_SHOP_ON_MSG')
end

function Bulk_sales_SHOP_ON_MSG(frame, msg, str, num)
    if g.settings.bulk_sales.use == 0 then
        return
    end
    g.bulk_sales.time = g.bulk_sales.time or 0
    local current_time = os.clock()
    if (current_time - g.bulk_sales.time) < 0.5 then
        return
    end
    if str ~= "Klapeda_Misc" and str ~= "Orsha_Misc" and str ~= "Fedimian_Misc" and
        not string.find(str, "CertificateCoin_Shop") then
        return
    else
        g.setup_hook_and_event(g.addon, "SHOP_UI_CLOSE", "Bulk_sales_frame_close", true)
        Bulk_sales_slotset()
    end
end

function Bulk_sales_slotset()
    local bulk_sales = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "bulk_sales", 0, 0, 0, 0)
    AUTO_CAST(bulk_sales)
    bulk_sales:SetSkinName("test_frame_low")
    bulk_sales:SetLayerLevel(80)
    bulk_sales:SetTitleBarSkin("None")
    bulk_sales:RemoveAllChild()
    local gbox = bulk_sales:CreateOrGetControl("groupbox", 'gbox', 10, 35, 0, 0)
    AUTO_CAST(gbox)
    gbox:SetSkinName("None")
    local slotset = gbox:CreateOrGetControl('slotset', 'slotset', 0, 0, 0, 0)
    AUTO_CAST(slotset)
    slotset:EnablePop(1)
    slotset:EnableDrag(1)
    slotset:EnableDrop(1)
    slotset:EnableHitTest(1)
    slotset:SetColRow(15, 33)
    slotset:SetSlotSize(35, 35)
    slotset:SetSpc(1, 1)
    slotset:SetSkinName('invenslot2')
    slotset:CreateSlots()
    local title = bulk_sales:CreateOrGetControl("richtext", "title", 40, 10, 120, 30)
    AUTO_CAST(title)
    title:SetText("{@st66b18}Balk Sales")
    local close = bulk_sales:CreateOrGetControl("button", "close", 0, 0, 25, 25)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.LEFT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "Bulk_sales_frame_close")
    local sell_btn = bulk_sales:CreateOrGetControl("button", "sell_btn", 0, 0, 120, 50)
    AUTO_CAST(sell_btn)
    sell_btn:SetSkinName("test_red_button")
    sell_btn:SetEventScript(ui.LBUTTONDOWN, "Bulk_sales_sell_execution_reserve")
    sell_btn:SetPos(slotset:GetWidth() - 115, 790)
    sell_btn:SetText("{@st41b}SELL{/}")
    local amount = bulk_sales:CreateOrGetControl("richtext", "amount", 0, 0, 120, 50)
    AUTO_CAST(amount)
    amount:SetPos(30, 800)
    amount:SetText("{@st41b}Sales Amount ▶{/}")
    local sales_amount = bulk_sales:CreateOrGetControl("richtext", "sales_amount", 0, 0, 120, 50)
    AUTO_CAST(sales_amount)
    sales_amount:SetPos(200, 800)
    sales_amount:SetText("{@st41b}{#FFA500}0{/}")
    bulk_sales:Resize(slotset:GetWidth() + 40, 850)
    gbox:Resize(bulk_sales:GetWidth() - 15, bulk_sales:GetHeight() - 100)
    gbox:SetScrollPos(0)
    local shop_frame = ui.GetFrame('shop')
    bulk_sales:SetPos(shop_frame:GetWidth() + 5, 5)
    bulk_sales:ShowWindow(1)
    INVENTORY_SET_CUSTOM_RBTNDOWN("Bulk_sales_inv_rbtn")
end

function Bulk_sales_frame_close()
    local bulk_sales = ui.GetFrame(addon_name_lower .. "bulk_sales")
    if bulk_sales then
        ui.DestroyFrame(addon_name_lower .. "bulk_sales")
    end
    INVENTORY_CLEAR_SELECT(nil)
    INVENTORY_SET_CUSTOM_RBTNDOWN("None")
    g.bulk_sales.time = os.clock()
    g.bulk_sales.amount = 0
    g.bulk_sales.tbl = {}
end

function Bulk_sales_inv_invalidate(frame)
    frame:Invalidate()
    return 0
end

function Bulk_sales_inv_rbtn(item_obj, slot)
    local icon = slot:GetIcon()
    local icon_info = icon:GetInfo()
    local base_guid = icon_info:GetIESID()
    local base_inv_item = session.GetInvItemByGuid(base_guid)
    local base_obj = GetIES(base_inv_item:GetObject())
    local target_clsid = base_obj.ClassID
    local item_prop = geItemTable.GetPropByName(base_obj.ClassName)
    if item_prop:IsEnableShopTrade() == false then
        ui.SysMsg(ClMsg("CannoTradeToNPC"))
        return
    end
    if base_obj.MarketCategory == "Housing_Furniture" or base_obj.MarketCategory == "PHousing_Furniture" or
        base_obj.MarketCategory == "PHousing_Wall" or base_obj.MarketCategory == "PHousing_Carpet" then
        ui.SysMsg(ClMsg("Housing_Cant_Sell_This_Item"))
        return
    end
    local bulk_sales = ui.GetFrame(addon_name_lower .. "bulk_sales")
    local slot_set = GET_CHILD_RECURSIVELY(bulk_sales, "slotset")
    local slot_count = slot_set:GetSlotCount()
    local inv_item_list = session.GetInvItemList()
    local inv_guid_list = inv_item_list:GetGuidList()
    local cnt = inv_guid_list:Count()
    local current_slot_index = 1
    local registered_any = false
    for i = 0, cnt - 1 do
        local guid = inv_guid_list:Get(i)
        local inv_item = inv_item_list:GetItemByGuid(guid)
        local obj = GetIES(inv_item:GetObject())
        if obj.ClassID == target_clsid and not g.bulk_sales.tbl[guid] then
            if not inv_item.isLockState then
                local set_success = false
                for j = current_slot_index, slot_count do
                    local new_slot = GET_CHILD_RECURSIVELY(slot_set, "slot" .. j)
                    local new_icon = new_slot:GetIcon()
                    if not new_icon then
                        g.bulk_sales.tbl[guid] = inv_item.count
                        local item_cls = GetClassByType("Item", target_clsid)
                        local sell_price = geItemTable.GetSellPrice(item_prop) * inv_item.count
                        g.bulk_sales.amount = g.bulk_sales.amount + sell_price
                        new_slot:SetEventScript(ui.RBUTTONDOWN, "Bulk_sales_slot_cancel")
                        new_slot:SetEventScriptArgString(ui.RBUTTONDOWN, guid)
                        new_slot:SetEventScriptArgNumber(ui.RBUTTONDOWN, sell_price)
                        SET_SLOT_ITEM_CLS(new_slot, item_cls)
                        SET_SLOT_ITEM_TEXT(new_slot, inv_item, item_cls)
                        new_slot:SetSkinName('slot')
                        local item_slot = INV_GET_SLOT_BY_ITEMGUID(guid)
                        if item_slot then
                            AUTO_CAST(item_slot)
                            item_slot:SetSelectedImage('socket_slot_check')
                            item_slot:Select(1)
                            item_slot:RunUpdateScript("Bulk_sales_inv_invalidate", 0.1)
                            item_slot:Invalidate()
                        end
                        current_slot_index = j + 1
                        set_success = true
                        registered_any = true
                        break
                    end
                end
                if not set_success then
                    ui.SysMsg(ClMsg("MaxCount"))
                    break
                end
            end
        end
    end
    if registered_any then
        local sales_amount = GET_CHILD_RECURSIVELY(bulk_sales, "sales_amount")
        AUTO_CAST(sales_amount)
        sales_amount:SetText("{@st41b}{#FFA500}" .. GET_COMMAED_STRING(g.bulk_sales.amount))
    end
end

function Bulk_sales_slot_cancel(frame, ctrl, guid, item_price)
    local inventory = ui.GetFrame("inventory")
    local item_slot = INV_GET_SLOT_BY_ITEMGUID(guid)
    if item_slot then
        item_slot:Select(0)
        item_slot:RunUpdateScript("Bulk_sales_inv_invalidate", 0.1)
        item_slot:Invalidate()
    end
    g.bulk_sales.tbl[tostring(guid)] = nil
    g.bulk_sales.amount = g.bulk_sales.amount - item_price
    local bulk_sales = ui.GetFrame(addon_name_lower .. "bulk_sales")
    local sales_amount = GET_CHILD_RECURSIVELY(bulk_sales, "sales_amount")
    AUTO_CAST(sales_amount)
    sales_amount:SetText("{@st41b}{#FFA500}" .. GET_COMMAED_STRING(g.bulk_sales.amount))
    ctrl:ClearText()
    ctrl:ClearIcon()
    ctrl:SetSkinName('invenslot2')
end

function Bulk_sales_sell_execution_reserve(frame, ctrl, str, num)
    local yes_scp = string.format("Bulk_sales_sell_execution()")
    local msg = g.lang == "Japanese" and "アイテムを販売しますか?" or "Do you want to sell this items?"
    ui.MsgBox(msg, yes_scp, "None")
end

function Bulk_sales_sell_execution()
    local bulk_sales = ui.GetFrame(addon_name_lower .. "bulk_sales")
    local slot_set = GET_CHILD_RECURSIVELY(bulk_sales, "slotset")
    AUTO_CAST(slot_set)
    local slot_count = slot_set:GetSlotCount()
    for guid, count in pairs(g.bulk_sales.tbl) do
        if type(count) == "number" and count > 0 then
            item.AddToSellList(guid, count)
        end
    end
    item.SellList()
    slot_set:ClearIconAll()
    Bulk_sales_frame_close()
end
-- Bulk Sales　ここまで

-- Quick Launcher ここから
function quick_launcher_on_init()
    local _nexus_addons = ui.GetFrame("_nexus_addons")
    local ql_hotkey_timer = _nexus_addons:CreateOrGetControl("timer", "quick_launcher_hotkey_timer", 0, 0)
    AUTO_CAST(ql_hotkey_timer)
    ql_hotkey_timer:SetUpdateScript("Quick_launcher_hotkey_check")
    ql_hotkey_timer:Start(0.15)
    _G["norisan"] = _G["norisan"] or {}
    _G["norisan"]["MENU"] = _G["norisan"]["MENU"] or {}
    _G["norisan"]["MENU"]["quick_launcher"] = {
        name = "Quick Launcher",
        icon = "sysmenu_sys",
        func = "Quick_launcher_toggle",
        image = ""
    }
end

g.quick_launcher_hotkey_pressed = false
function Quick_launcher_hotkey_check()
    local ctrl = keyboard.IsKeyPressed("LCTRL") == 1
    local grave = keyboard.IsKeyPressed("GRAVE") == 1
    if ctrl and grave then
        if not g.quick_launcher_hotkey_pressed then
            g.quick_launcher_hotkey_pressed = true
            Quick_launcher_toggle()
        end
    else
        g.quick_launcher_hotkey_pressed = false
    end
end

function Quick_launcher_toggle()
    local ql = ui.GetFrame(addon_name_lower .. "quick_launcher")
    if ql and ql:IsVisible() == 1 then
        Quick_launcher_close()
    else
        Quick_launcher_frame_init()
    end
end

function Quick_launcher_get_items()
    local items = {}
    table.insert(items, {
        name = "Indun Panel",
        action = "Quick_launcher_open_indun_panel"
    })
    table.insert(items, {
        name = "Indun List Viewer",
        action = "Quick_launcher_open_indun_list_viewer"
    })
    table.insert(items, {
        name = "Guild Agit",
        action = "Quick_launcher_guild_agit_move"
    })
    return items
end

function Quick_launcher_frame_init()
    local items = Quick_launcher_get_items()
    local btn_w = 200
    local btn_h = 35
    local btn_spc = 8
    local padding = 15
    local title_h = 30
    local frame_w = btn_w + (padding * 2)
    local frame_h = title_h + (#items * btn_h) + ((#items - 1) * btn_spc) + (padding * 2)

    local ql = ui.CreateNewFrame("notice_on_pc", addon_name_lower .. "quick_launcher", 0, 0, 0, 0)
    ql:RemoveAllChild()
    ql:Resize(frame_w, frame_h)
    ql:SetSkinName("None")
    ql:SetTitleBarSkin("None")
    ql:SetLayerLevel(100)
    ql:EnableHittestFrame(1)
    ql:EnableMove(1)

    local sw = ui.GetClientInitialWidth()
    local sh = ui.GetClientInitialHeight()
    ql:SetPos((sw - frame_w) / 2, (sh - frame_h) / 2)

    local title = ql:CreateOrGetControl("richtext", "ql_title", padding, 8, frame_w - padding * 2, 20)
    AUTO_CAST(title)
    title:SetText("{ol}{s14}{b}Quick Launcher")

    local close_btn = ql:CreateOrGetControl("button", "ql_close", 0, 0, 20, 20)
    AUTO_CAST(close_btn)
    close_btn:SetImage("testclose_button")
    close_btn:SetGravity(ui.RIGHT, ui.TOP)
    close_btn:SetEventScript(ui.LBUTTONUP, "Quick_launcher_close_btn")

    for i, item in ipairs(items) do
        local x = padding
        local y = title_h + padding + (i - 1) * (btn_h + btn_spc)

        local btn = ql:CreateOrGetControl("button", "ql_btn_" .. i, x, y, btn_w, btn_h)
        AUTO_CAST(btn)
        btn:SetText("{ol}" .. item.name)
        btn:SetEventScript(ui.LBUTTONUP, item.action)
        btn:SetOverSound("button_over")
        btn:SetClickSound("button_click_stats")
    end

    local esc_timer = ql:CreateOrGetControl("timer", "ql_esc_timer", 0, 0)
    AUTO_CAST(esc_timer)
    esc_timer:SetUpdateScript("Quick_launcher_esc_check")
    esc_timer:Start(0.05)

    ql:ShowWindow(1)
end

function Quick_launcher_close()
    local ql = ui.GetFrame(addon_name_lower .. "quick_launcher")
    if ql then
        ql:ShowWindow(0)
    end
end

function Quick_launcher_close_btn()
    Quick_launcher_close()
end

function Quick_launcher_esc_check(frame)
    local esc = keyboard.IsKeyPressed("ESCAPE") == 1
    if esc then
        Quick_launcher_close()
    end
end

function Quick_launcher_open_indun_panel()
    Quick_launcher_close()
    local indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    if not indun_panel then
        Indun_panel_frame_init()
        indun_panel = ui.GetFrame(addon_name_lower .. "indun_panel")
    end
    if indun_panel then
        Indun_panel_frame_open(indun_panel)
    end
end

function Quick_launcher_open_indun_list_viewer()
    Quick_launcher_close()
    if type(_G["Indun_list_viewer_title_frame_open"]) == "function" then
        Indun_list_viewer_title_frame_open()
    end
end

function Quick_launcher_guild_agit_move()
    Quick_launcher_close()
    local success, err = pcall(function()
        guild.RequestGuildAgitMove()
    end)
    if not success then
        ui.SysMsg("[Quick Launcher] Guild Agit move failed: " .. tostring(err))
    end
end

-- Quick Launcher ここまで

-- アドオンメニューボタン
local norisan_menu_addons = string.format("../%s", "addons")
local norisan_menu_addons_mkfile = string.format("../%s/mkdir.txt", "addons")
local norisan_menu_settings = string.format("../addons/%s/settings.json", "norisan_menu")
local norisan_menu_folder = string.format("../addons/%s", "norisan_menu")
local norisan_menu_mkfile = string.format("../addons/%s/mkdir.txt", "norisan_menu")
_G["norisan"] = _G["norisan"] or {}
_G["norisan"]["MENU"] = _G["norisan"]["MENU"] or {}
local json = require("json")
local function norisan_menu_create_folder_file()
    local addons_file = io.open(norisan_menu_addons_mkfile, "r")
    if not addons_file then
        os.execute('mkdir "' .. norisan_menu_addons .. '"')
        addons_file = io.open(norisan_menu_addons_mkfile, "w")
        if addons_file then
            addons_file:write("created")
            addons_file:close()
        end
    else
        addons_file:close()
    end
    local file = io.open(norisan_menu_mkfile, "r")
    if not file then
        os.execute('mkdir "' .. norisan_menu_folder .. '"')
        file = io.open(norisan_menu_mkfile, "w")
        if file then
            file:write("created")
            file:close()
        end
    else
        file:close()
    end
end
norisan_menu_create_folder_file()
local function norisan_menu_save_json(path, tbl)
    local data_to_save = {
        x = tbl.x,
        y = tbl.y,
        move = tbl.move,
        open = tbl.open,
        layer = tbl.layer
    }
    local file = io.open(path, "w")
    if file then
        local str = json.encode(data_to_save)
        file:write(str)
        file:close()
    end
end

local function norisan_menu_load_json(path)
    local file = io.open(path, "r")
    if file then
        local content = file:read("*all")
        file:close()
        if content and content ~= "" then
            local decoded, err = json.decode(content)
            if decoded then
                return decoded
            end
        end
    end
    return nil
end

function _G.norisan_menu_move_drag(frame, ctrl)
    if not frame then
        return
    end
    local current_frame_y = frame:GetY()
    local current_frame_h = frame:GetHeight()
    local base_button_h = 40
    local y_to_save = current_frame_y
    if current_frame_h > base_button_h and (_G["norisan"]["MENU"].open == 1) then
        local items_area_h_calculated = current_frame_h - base_button_h
        y_to_save = current_frame_y + items_area_h_calculated

    end
    _G["norisan"]["MENU"].x = frame:GetX()
    _G["norisan"]["MENU"].y = y_to_save
    norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])
end

function _G.norisan_menu_setting_frame_ctrl(setting, ctrl)
    local ctrl_name = ctrl:GetName()
    local frame_name = _G["norisan"]["MENU"].frame_name
    local frame = ui.GetFrame(frame_name)
    if ctrl_name == "layer_edit" then
        local layer = tonumber(ctrl:GetText())
        if layer then
            _G["norisan"]["MENU"].layer = layer
            frame:SetLayerLevel(layer)
            norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])

            local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{ol}レイヤーを変更" or
                               "{ol}Change Layer"
            ui.SysMsg(notice)
            _G.norisan_menu_create_frame()
            setting:ShowWindow(0)
            return
        end
    end
    if ctrl_name == "def_setting" then
        _G["norisan"]["MENU"].x = 1190
        _G["norisan"]["MENU"].y = 30
        _G["norisan"]["MENU"].move = true
        _G["norisan"]["MENU"].open = 0
        _G["norisan"]["MENU"].layer = 79
        norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])
        _G.norisan_menu_create_frame()
        setting:ShowWindow(0)
        return
    end
    if ctrl_name == "close" then
        setting:ShowWindow(0)
        return
    end
    local is_check = ctrl:IsChecked()
    if ctrl_name == "move_toggle" then
        if is_check == 1 then
            _G["norisan"]["MENU"].move = false
        else
            _G["norisan"]["MENU"].move = true
        end
        frame:EnableMove(_G["norisan"]["MENU"].move == true and 1 or 0)
        norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])
        return
    elseif ctrl_name == "open_toggle" then
        _G["norisan"]["MENU"].open = is_check
        norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])
        _G.norisan_menu_create_frame()
        return
    end
end

function _G.norisan_menu_setting_frame(frame, ctrl)
    local setting = ui.CreateNewFrame("chat_memberlist", "norisan_menu_setting", 0, 0, 0, 0)
    AUTO_CAST(setting)
    setting:SetTitleBarSkin("None")
    setting:SetSkinName("chat_window")
    setting:Resize(260, 135)
    setting:SetLayerLevel(999)
    setting:EnableHitTest(1)
    setting:EnableMove(1)
    setting:SetPos(frame:GetX() + 200, frame:GetY())
    setting:ShowWindow(1)
    local close = setting:CreateOrGetControl("button", "close", 0, 0, 30, 30)
    AUTO_CAST(close)
    close:SetImage("testclose_button")
    close:SetGravity(ui.RIGHT, ui.TOP)
    close:SetEventScript(ui.LBUTTONUP, "norisan_menu_setting_frame_ctrl")
    local def_setting = setting:CreateOrGetControl("button", "def_setting", 10, 5, 150, 30)
    AUTO_CAST(def_setting)
    local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{ol}デフォルトに戻す" or "{ol}Reset to default"
    def_setting:SetText(notice)
    def_setting:SetEventScript(ui.LBUTTONUP, "norisan_menu_setting_frame_ctrl")
    local move_toggle = setting:CreateOrGetControl('checkbox', "move_toggle", 10, 35, 30, 30)
    AUTO_CAST(move_toggle)
    move_toggle:SetCheck(_G["norisan"]["MENU"].move == true and 0 or 1)
    move_toggle:SetEventScript(ui.LBUTTONDOWN, 'norisan_menu_setting_frame_ctrl')
    local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{ol}チェックするとフレーム固定" or
                       "{ol}Check to fix frame"
    move_toggle:SetText(notice)
    local open_toggle = setting:CreateOrGetControl('checkbox', "open_toggle", 10, 70, 30, 30)
    AUTO_CAST(open_toggle)
    open_toggle:SetCheck(_G["norisan"]["MENU"].open)
    open_toggle:SetEventScript(ui.LBUTTONDOWN, 'norisan_menu_setting_frame_ctrl')
    local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{ol}チェックすると上開き" or
                       "{ol}Check to open upward"
    open_toggle:SetText(notice)
    local layer_text = setting:CreateOrGetControl('richtext', 'layer_text', 10, 105, 50, 20)
    AUTO_CAST(layer_text)
    local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{ol}レイヤー設定" or "{ol}Set Layer"
    layer_text:SetText(notice)
    local layer_edit = setting:CreateOrGetControl('edit', 'layer_edit', 130, 105, 70, 20)
    AUTO_CAST(layer_edit)
    layer_edit:SetFontName("white_16_ol")
    layer_edit:SetTextAlign("center", "center")
    layer_edit:SetText(_G["norisan"]["MENU"].layer or 79)
    layer_edit:SetEventScript(ui.ENTERKEY, "norisan_menu_setting_frame_ctrl")
end

function _G.norisan_menu_toggle_items_display(frame, ctrl, open_dir)
    local open_up = (open_dir == 1)
    local menu_src = _G["norisan"]["MENU"]
    local max_cols = 5
    local item_w = 35
    local item_h = 35
    local y_off_down = 35
    local items = {}
    if menu_src then
        for key, data in pairs(menu_src) do
            if type(data) == "table" then
                if key ~= "x" and key ~= "y" and key ~= "open" and key ~= "move" and data.name and data.func and
                    ((data.image and data.image ~= "") or (data.icon and data.icon ~= "")) then
                    table.insert(items, {
                        key = key,
                        data = data
                    })
                end
            end
        end
    end
    local num_items = #items
    local num_rows = math.ceil(num_items / max_cols)
    local items_h = num_rows * item_h
    local frame_h_new = 40 + items_h
    local frame_y_new = _G["norisan"]["MENU"].y or 30
    if open_up then
        frame_y_new = frame_y_new - items_h
    end
    local frame_w_new
    if num_rows == 1 then
        frame_w_new = math.max(40, num_items * item_w)
    else
        frame_w_new = math.max(40, max_cols * item_w)
    end
    frame:SetPos(frame:GetX(), frame_y_new)
    frame:Resize(frame_w_new, frame_h_new)
    for idx, entry in ipairs(items) do
        local item_sidx = idx - 1
        local data = entry.data
        local key = entry.key
        local col = item_sidx % max_cols
        local x = col * item_w
        local y = 0
        if open_up then
            local logical_row_from_bottom = math.floor(item_sidx / max_cols)
            y = (frame_h_new - 40) - ((logical_row_from_bottom + 1) * item_h)
        else
            local row_down = math.floor(item_sidx / max_cols)
            y = y_off_down + (row_down * item_h)
        end
        local ctrl_name = "menu_item_" .. key
        local item_elem
        if data.image and data.image ~= "" then
            item_elem = frame:CreateOrGetControl('button', ctrl_name, x, y, item_w, item_h)
            AUTO_CAST(item_elem)
            item_elem:SetSkinName("None")
            item_elem:SetText(data.image)
        else
            item_elem = frame:CreateOrGetControl('picture', ctrl_name, x, y, item_w, item_h)
            AUTO_CAST(item_elem)
            item_elem:SetImage(data.icon)
            item_elem:SetEnableStretch(1)
        end
        if item_elem then
            item_elem:SetTextTooltip("{ol}" .. data.name)
            item_elem:SetEventScript(ui.LBUTTONUP, data.func)
            item_elem:ShowWindow(1)
        end
    end
    local main_btn = GET_CHILD(frame, "norisan_menu_pic")
    if main_btn then
        if open_up then
            main_btn:SetPos(0, frame_h_new - 40)
        else
            main_btn:SetPos(0, 0)
        end
    end
end

function _G.norisan_menu_frame_open(frame, ctrl)
    if not frame then
        return
    end
    if frame:GetHeight() > 40 then
        local children = {}
        for i = 0, frame:GetChildCount() - 1 do
            local child_obj = frame:GetChildByIndex(i)
            if child_obj then
                table.insert(children, child_obj)
            end
        end
        for _, child_obj in ipairs(children) do
            if child_obj:GetName() ~= "norisan_menu_pic" then
                frame:RemoveChild(child_obj:GetName())
            end
        end
        frame:Resize(40, 40)
        frame:SetPos(frame:GetX(), _G["norisan"]["MENU"].y or 30)
        local main_pic = GET_CHILD(frame, "norisan_menu_pic")
        if main_pic then
            main_pic:SetPos(0, 0)
        end
        return
    end
    local open_dir_val = _G["norisan"]["MENU"].open or 0
    _G.norisan_menu_toggle_items_display(frame, ctrl, open_dir_val)
end

function g.norisan_menu_create_frame()
    _G["norisan"]["MENU"].lang = option.GetCurrentCountry()
    local loaded_cfg = norisan_menu_load_json(norisan_menu_settings)
    if loaded_cfg and loaded_cfg.layer ~= nil then
        _G["norisan"]["MENU"].layer = loaded_cfg.layer
    elseif _G["norisan"]["MENU"].layer == nil then
        _G["norisan"]["MENU"].layer = 79
    end
    if loaded_cfg and loaded_cfg.move ~= nil then
        _G["norisan"]["MENU"].move = loaded_cfg.move
    elseif _G["norisan"]["MENU"].move == nil then
        _G["norisan"]["MENU"].move = true
    end
    if loaded_cfg and loaded_cfg.open ~= nil then
        _G["norisan"]["MENU"].open = loaded_cfg.open
    elseif _G["norisan"]["MENU"].open == nil then
        _G["norisan"]["MENU"].open = 0
    end
    local default_x = 1190
    local default_y = 30
    local final_x = default_x
    local final_y = default_y
    if _G["norisan"]["MENU"].x ~= nil then
        final_x = _G["norisan"]["MENU"].x
    end
    if _G["norisan"]["MENU"].y ~= nil then
        final_y = _G["norisan"]["MENU"].y
    end
    if loaded_cfg and type(loaded_cfg.x) == "number" then
        final_x = loaded_cfg.x
    end
    if loaded_cfg and type(loaded_cfg.y) == "number" then
        final_y = loaded_cfg.y
    end
    local map_ui = ui.GetFrame("map")
    local screen_w = 1920
    if map_ui and map_ui:IsVisible() then
        screen_w = map_ui:GetWidth()
    end
    if final_x > 1920 and screen_w <= 1920 then
        final_x = default_x
        final_y = default_y
    end
    _G["norisan"]["MENU"].x = final_x
    _G["norisan"]["MENU"].y = final_y
    norisan_menu_save_json(norisan_menu_settings, _G["norisan"]["MENU"])
    local frame = ui.CreateNewFrame("chat_memberlist", "norisan_menu_frame", 0, 0, 0, 0)
    AUTO_CAST(frame)
    frame:RemoveAllChild()
    frame:SetSkinName("None")
    frame:SetTitleBarSkin("None")
    frame:Resize(40, 40)
    frame:SetLayerLevel(_G["norisan"]["MENU"].layer)
    frame:EnableMove(_G["norisan"]["MENU"].move == true and 1 or 0)
    frame:SetPos(_G["norisan"]["MENU"].x, _G["norisan"]["MENU"].y)
    frame:SetEventScript(ui.LBUTTONUP, "norisan_menu_move_drag")
    local norisan_menu_pic = frame:CreateOrGetControl('picture', "norisan_menu_pic", 0, 0, 35, 40)
    AUTO_CAST(norisan_menu_pic)
    norisan_menu_pic:SetImage("sysmenu_sys")
    norisan_menu_pic:SetEnableStretch(1)
    local notice = _G["norisan"]["MENU"].lang == "Japanese" and "{nl}{ol}右クリック: 設定" or
                       "{nl}{ol}Right click: Settings"
    norisan_menu_pic:SetTextTooltip("{ol}Addons Menu" .. notice)
    norisan_menu_pic:SetEventScript(ui.LBUTTONUP, "norisan_menu_frame_open")
    norisan_menu_pic:SetEventScript(ui.RBUTTONUP, "norisan_menu_setting_frame")
    frame:ShowWindow(1)
end
